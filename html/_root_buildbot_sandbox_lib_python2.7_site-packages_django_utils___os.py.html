source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/_os.py</b><br>


file stats: <b>50 lines, 20 executed: 40.0% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import os</font>
<font color="green">   4. import sys</font>
<font color="green">   5. import tempfile</font>
<font color="green">   6. from os.path import abspath, dirname, isabs, join, normcase, normpath, sep</font>
<font color="black">   7. </font>
<font color="green">   8. from django.core.exceptions import SuspiciousFileOperation</font>
<font color="green">   9. from django.utils import six</font>
<font color="green">  10. from django.utils.encoding import force_text</font>
<font color="black">  11. </font>
<font color="green">  12. if six.PY2:</font>
<font color="green">  13.     fs_encoding = sys.getfilesystemencoding() or sys.getdefaultencoding()</font>
<font color="black">  14. </font>
<font color="black">  15. </font>
<font color="black">  16. # Under Python 2, define our own abspath function that can handle joining</font>
<font color="black">  17. # unicode paths to a current working directory that has non-ASCII characters</font>
<font color="black">  18. # in it.  This isn't necessary on Windows since the Windows version of abspath</font>
<font color="black">  19. # handles this correctly. It also handles drive letters differently than the</font>
<font color="black">  20. # pure Python implementation, so it's best not to replace it.</font>
<font color="green">  21. if six.PY3 or os.name == 'nt':</font>
<font color="red">  22.     abspathu = abspath</font>
<font color="black">  23. else:</font>
<font color="green">  24.     def abspathu(path):</font>
<font color="black">  25.         &quot;&quot;&quot;</font>
<font color="black">  26.         Version of os.path.abspath that uses the unicode representation</font>
<font color="black">  27.         of the current working directory, thus avoiding a UnicodeDecodeError</font>
<font color="black">  28.         in join when the cwd has non-ASCII characters.</font>
<font color="black">  29.         &quot;&quot;&quot;</font>
<font color="red">  30.         if not isabs(path):</font>
<font color="red">  31.             path = join(os.getcwdu(), path)</font>
<font color="red">  32.         return normpath(path)</font>
<font color="black">  33. </font>
<font color="black">  34. </font>
<font color="green">  35. def upath(path):</font>
<font color="black">  36.     &quot;&quot;&quot;</font>
<font color="black">  37.     Always return a unicode path.</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="green">  39.     if six.PY2 and not isinstance(path, six.text_type):</font>
<font color="green">  40.         return path.decode(fs_encoding)</font>
<font color="red">  41.     return path</font>
<font color="black">  42. </font>
<font color="black">  43. </font>
<font color="green">  44. def npath(path):</font>
<font color="black">  45.     &quot;&quot;&quot;</font>
<font color="black">  46.     Always return a native path, that is unicode on Python 3 and bytestring on</font>
<font color="black">  47.     Python 2.</font>
<font color="black">  48.     &quot;&quot;&quot;</font>
<font color="green">  49.     if six.PY2 and not isinstance(path, bytes):</font>
<font color="green">  50.         return path.encode(fs_encoding)</font>
<font color="red">  51.     return path</font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="green">  54. def safe_join(base, *paths):</font>
<font color="black">  55.     &quot;&quot;&quot;</font>
<font color="black">  56.     Joins one or more path components to the base path component intelligently.</font>
<font color="black">  57.     Returns a normalized, absolute version of the final path.</font>
<font color="black">  58. </font>
<font color="black">  59.     The final path must be located inside of the base path component (otherwise</font>
<font color="black">  60.     a ValueError is raised).</font>
<font color="black">  61.     &quot;&quot;&quot;</font>
<font color="red">  62.     base = force_text(base)</font>
<font color="red">  63.     paths = [force_text(p) for p in paths]</font>
<font color="red">  64.     final_path = abspathu(join(base, *paths))</font>
<font color="red">  65.     base_path = abspathu(base)</font>
<font color="black">  66.     # Ensure final_path starts with base_path (using normcase to ensure we</font>
<font color="black">  67.     # don't false-negative on case insensitive operating systems like Windows),</font>
<font color="black">  68.     # further, one of the following conditions must be true:</font>
<font color="black">  69.     #  a) The next character is the path separator (to prevent conditions like</font>
<font color="black">  70.     #     safe_join(&quot;/dir&quot;, &quot;/../d&quot;))</font>
<font color="black">  71.     #  b) The final path must be the same as the base path.</font>
<font color="black">  72.     #  c) The base path must be the most root path (meaning either &quot;/&quot; or &quot;C:\\&quot;)</font>
<font color="red">  73.     if (not normcase(final_path).startswith(normcase(base_path + sep)) and</font>
<font color="red">  74.             normcase(final_path) != normcase(base_path) and</font>
<font color="red">  75.             dirname(normcase(base_path)) != normcase(base_path)):</font>
<font color="red">  76.         raise SuspiciousFileOperation(</font>
<font color="red">  77.             'The joined path ({}) is located outside of the base path '</font>
<font color="red">  78.             'component ({})'.format(final_path, base_path))</font>
<font color="red">  79.     return final_path</font>
<font color="black">  80. </font>
<font color="black">  81. </font>
<font color="green">  82. def symlinks_supported():</font>
<font color="black">  83.     &quot;&quot;&quot;</font>
<font color="black">  84.     A function to check if creating symlinks are supported in the</font>
<font color="black">  85.     host platform and/or if they are allowed to be created (e.g.</font>
<font color="black">  86.     on Windows it requires admin permissions).</font>
<font color="black">  87.     &quot;&quot;&quot;</font>
<font color="red">  88.     tmpdir = tempfile.mkdtemp()</font>
<font color="red">  89.     original_path = os.path.join(tmpdir, 'original')</font>
<font color="red">  90.     symlink_path = os.path.join(tmpdir, 'symlink')</font>
<font color="red">  91.     os.makedirs(original_path)</font>
<font color="red">  92.     try:</font>
<font color="red">  93.         os.symlink(original_path, symlink_path)</font>
<font color="red">  94.         supported = True</font>
<font color="red">  95.     except (OSError, NotImplementedError, AttributeError):</font>
<font color="red">  96.         supported = False</font>
<font color="black">  97.     else:</font>
<font color="red">  98.         os.remove(symlink_path)</font>
<font color="black">  99.     finally:</font>
<font color="red"> 100.         os.rmdir(original_path)</font>
<font color="red"> 101.         os.rmdir(tmpdir)</font>
<font color="red"> 102.         return supported</font>
</pre>


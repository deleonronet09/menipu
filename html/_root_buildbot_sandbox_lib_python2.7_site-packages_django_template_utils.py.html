source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/template/utils.py</b><br>


file stats: <b>86 lines, 22 executed: 25.6% covered</b>
<pre>
<font color="green">   1. import os</font>
<font color="green">   2. import warnings</font>
<font color="green">   3. from collections import Counter, OrderedDict</font>
<font color="black">   4. </font>
<font color="green">   5. from django.apps import apps</font>
<font color="green">   6. from django.conf import settings</font>
<font color="green">   7. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   8. from django.utils import lru_cache</font>
<font color="green">   9. from django.utils._os import upath</font>
<font color="green">  10. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  11. from django.utils.functional import cached_property</font>
<font color="green">  12. from django.utils.module_loading import import_string</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class InvalidTemplateEngineError(ImproperlyConfigured):</font>
<font color="green">  16.     pass</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="green">  19. class EngineHandler(object):</font>
<font color="green">  20.     def __init__(self, templates=None):</font>
<font color="black">  21.         &quot;&quot;&quot;</font>
<font color="black">  22.         templates is an optional list of template engine definitions</font>
<font color="black">  23.         (structured like settings.TEMPLATES).</font>
<font color="black">  24.         &quot;&quot;&quot;</font>
<font color="green">  25.         self._templates = templates</font>
<font color="green">  26.         self._engines = {}</font>
<font color="black">  27. </font>
<font color="green">  28.     @cached_property</font>
<font color="black">  29.     def templates(self):</font>
<font color="red">  30.         if self._templates is None:</font>
<font color="red">  31.             self._templates = settings.TEMPLATES</font>
<font color="black">  32. </font>
<font color="red">  33.         if not self._templates:</font>
<font color="red">  34.             warnings.warn(</font>
<font color="red">  35.                 &quot;You haven't defined a TEMPLATES setting. You must do so &quot;</font>
<font color="black">  36.                 &quot;before upgrading to Django 1.10. Otherwise Django will be &quot;</font>
<font color="red">  37.                 &quot;unable to load templates.&quot;, RemovedInDjango110Warning)</font>
<font color="black">  38.             self._templates = [</font>
<font color="red">  39.                 {</font>
<font color="red">  40.                     'BACKEND': 'django.template.backends.django.DjangoTemplates',</font>
<font color="red">  41.                     'DIRS': settings.TEMPLATE_DIRS,</font>
<font color="red">  42.                     'OPTIONS': {</font>
<font color="red">  43.                         'allowed_include_roots': settings.ALLOWED_INCLUDE_ROOTS,</font>
<font color="red">  44.                         'context_processors': settings.TEMPLATE_CONTEXT_PROCESSORS,</font>
<font color="red">  45.                         'debug': settings.TEMPLATE_DEBUG,</font>
<font color="red">  46.                         'loaders': settings.TEMPLATE_LOADERS,</font>
<font color="red">  47.                         'string_if_invalid': settings.TEMPLATE_STRING_IF_INVALID,</font>
<font color="black">  48.                     },</font>
<font color="black">  49.                 },</font>
<font color="black">  50.             ]</font>
<font color="black">  51. </font>
<font color="red">  52.         templates = OrderedDict()</font>
<font color="red">  53.         backend_names = []</font>
<font color="red">  54.         for tpl in self._templates:</font>
<font color="red">  55.             tpl = tpl.copy()</font>
<font color="red">  56.             try:</font>
<font color="black">  57.                 # This will raise an exception if 'BACKEND' doesn't exist or</font>
<font color="black">  58.                 # isn't a string containing at least one dot.</font>
<font color="red">  59.                 default_name = tpl['BACKEND'].rsplit('.', 2)[-2]</font>
<font color="red">  60.             except Exception:</font>
<font color="red">  61.                 invalid_backend = tpl.get('BACKEND', '&lt;not defined&gt;')</font>
<font color="red">  62.                 raise ImproperlyConfigured(</font>
<font color="red">  63.                     &quot;Invalid BACKEND for a template engine: {}. Check &quot;</font>
<font color="red">  64.                     &quot;your TEMPLATES setting.&quot;.format(invalid_backend))</font>
<font color="black">  65. </font>
<font color="red">  66.             tpl.setdefault('NAME', default_name)</font>
<font color="red">  67.             tpl.setdefault('DIRS', [])</font>
<font color="red">  68.             tpl.setdefault('APP_DIRS', False)</font>
<font color="red">  69.             tpl.setdefault('OPTIONS', {})</font>
<font color="black">  70. </font>
<font color="red">  71.             templates[tpl['NAME']] = tpl</font>
<font color="red">  72.             backend_names.append(tpl['NAME'])</font>
<font color="black">  73. </font>
<font color="red">  74.         counts = Counter(backend_names)</font>
<font color="red">  75.         duplicates = [alias for alias, count in counts.most_common() if count &gt; 1]</font>
<font color="red">  76.         if duplicates:</font>
<font color="red">  77.             raise ImproperlyConfigured(</font>
<font color="red">  78.                 &quot;Template engine aliases aren't unique, duplicates: {}. &quot;</font>
<font color="black">  79.                 &quot;Set a unique NAME for each engine in settings.TEMPLATES.&quot;</font>
<font color="red">  80.                 .format(&quot;, &quot;.join(duplicates)))</font>
<font color="black">  81. </font>
<font color="red">  82.         return templates</font>
<font color="black">  83. </font>
<font color="green">  84.     def __getitem__(self, alias):</font>
<font color="red">  85.         try:</font>
<font color="red">  86.             return self._engines[alias]</font>
<font color="red">  87.         except KeyError:</font>
<font color="red">  88.             try:</font>
<font color="red">  89.                 params = self.templates[alias]</font>
<font color="red">  90.             except KeyError:</font>
<font color="red">  91.                 raise InvalidTemplateEngineError(</font>
<font color="red">  92.                     &quot;Could not find config for '{}' &quot;</font>
<font color="red">  93.                     &quot;in settings.TEMPLATES&quot;.format(alias))</font>
<font color="black">  94. </font>
<font color="black">  95.             # If importing or initializing the backend raises an exception,</font>
<font color="black">  96.             # self._engines[alias] isn't set and this code may get executed</font>
<font color="black">  97.             # again, so we must preserve the original params. See #24265.</font>
<font color="red">  98.             params = params.copy()</font>
<font color="red">  99.             backend = params.pop('BACKEND')</font>
<font color="red"> 100.             engine_cls = import_string(backend)</font>
<font color="red"> 101.             engine = engine_cls(params)</font>
<font color="black"> 102. </font>
<font color="red"> 103.             self._engines[alias] = engine</font>
<font color="red"> 104.             return engine</font>
<font color="black"> 105. </font>
<font color="green"> 106.     def __iter__(self):</font>
<font color="red"> 107.         return iter(self.templates)</font>
<font color="black"> 108. </font>
<font color="green"> 109.     def all(self):</font>
<font color="red"> 110.         return [self[alias] for alias in self]</font>
<font color="black"> 111. </font>
<font color="black"> 112. </font>
<font color="green"> 113. @lru_cache.lru_cache()</font>
<font color="black"> 114. def get_app_template_dirs(dirname):</font>
<font color="black"> 115.     &quot;&quot;&quot;</font>
<font color="black"> 116.     Return an iterable of paths of directories to load app templates from.</font>
<font color="black"> 117. </font>
<font color="black"> 118.     dirname is the name of the subdirectory containing templates inside</font>
<font color="black"> 119.     installed applications.</font>
<font color="black"> 120.     &quot;&quot;&quot;</font>
<font color="red"> 121.     template_dirs = []</font>
<font color="red"> 122.     for app_config in apps.get_app_configs():</font>
<font color="red"> 123.         if not app_config.path:</font>
<font color="red"> 124.             continue</font>
<font color="red"> 125.         template_dir = os.path.join(app_config.path, dirname)</font>
<font color="red"> 126.         if os.path.isdir(template_dir):</font>
<font color="red"> 127.             template_dirs.append(upath(template_dir))</font>
<font color="black"> 128.     # Immutable return value because it will be cached and shared by callers.</font>
<font color="red"> 129.     return tuple(template_dirs)</font>
</pre>


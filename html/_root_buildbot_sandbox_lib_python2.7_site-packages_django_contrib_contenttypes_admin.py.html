source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/contenttypes/admin.py</b><br>


file stats: <b>88 lines, 23 executed: 26.1% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from functools import partial</font>
<font color="black">   4. </font>
<font color="green">   5. from django.contrib.admin.checks import InlineModelAdminChecks</font>
<font color="green">   6. from django.contrib.admin.options import InlineModelAdmin, flatten_fieldsets</font>
<font color="green">   7. from django.contrib.contenttypes.fields import GenericForeignKey</font>
<font color="green">   8. from django.contrib.contenttypes.forms import (</font>
<font color="black">   9.     BaseGenericInlineFormSet, generic_inlineformset_factory,</font>
<font color="black">  10. )</font>
<font color="green">  11. from django.core import checks</font>
<font color="green">  12. from django.core.exceptions import FieldDoesNotExist</font>
<font color="green">  13. from django.forms import ALL_FIELDS</font>
<font color="green">  14. from django.forms.models import modelform_defines_fields</font>
<font color="black">  15. </font>
<font color="black">  16. </font>
<font color="green">  17. class GenericInlineModelAdminChecks(InlineModelAdminChecks):</font>
<font color="green">  18.     def _check_exclude_of_parent_model(self, obj, parent_model):</font>
<font color="black">  19.         # There's no FK to exclude, so no exclusion checks are required.</font>
<font color="red">  20.         return []</font>
<font color="black">  21. </font>
<font color="green">  22.     def _check_relation(self, obj, parent_model):</font>
<font color="black">  23.         # There's no FK, but we do need to confirm that the ct_field and ct_fk_field are valid,</font>
<font color="black">  24.         # and that they are part of a GenericForeignKey.</font>
<font color="black">  25. </font>
<font color="black">  26.         gfks = [</font>
<font color="red">  27.             f for f in obj.model._meta.virtual_fields</font>
<font color="red">  28.             if isinstance(f, GenericForeignKey)</font>
<font color="black">  29.         ]</font>
<font color="red">  30.         if len(gfks) == 0:</font>
<font color="black">  31.             return [</font>
<font color="red">  32.                 checks.Error(</font>
<font color="red">  33.                     &quot;'%s.%s' has no GenericForeignKey.&quot; % (</font>
<font color="red">  34.                         obj.model._meta.app_label, obj.model._meta.object_name</font>
<font color="black">  35.                     ),</font>
<font color="red">  36.                     hint=None,</font>
<font color="red">  37.                     obj=obj.__class__,</font>
<font color="red">  38.                     id='admin.E301'</font>
<font color="black">  39.                 )</font>
<font color="black">  40.             ]</font>
<font color="black">  41.         else:</font>
<font color="black">  42.             # Check that the ct_field and ct_fk_fields exist</font>
<font color="red">  43.             try:</font>
<font color="red">  44.                 obj.model._meta.get_field(obj.ct_field)</font>
<font color="red">  45.             except FieldDoesNotExist:</font>
<font color="black">  46.                 return [</font>
<font color="red">  47.                     checks.Error(</font>
<font color="red">  48.                         &quot;'ct_field' references '%s', which is not a field on '%s.%s'.&quot; % (</font>
<font color="red">  49.                             obj.ct_field, obj.model._meta.app_label, obj.model._meta.object_name</font>
<font color="black">  50.                         ),</font>
<font color="red">  51.                         hint=None,</font>
<font color="red">  52.                         obj=obj.__class__,</font>
<font color="red">  53.                         id='admin.E302'</font>
<font color="black">  54.                     )</font>
<font color="black">  55.                 ]</font>
<font color="black">  56. </font>
<font color="red">  57.             try:</font>
<font color="red">  58.                 obj.model._meta.get_field(obj.ct_fk_field)</font>
<font color="red">  59.             except FieldDoesNotExist:</font>
<font color="black">  60.                 return [</font>
<font color="red">  61.                     checks.Error(</font>
<font color="red">  62.                         &quot;'ct_fk_field' references '%s', which is not a field on '%s.%s'.&quot; % (</font>
<font color="red">  63.                             obj.ct_fk_field, obj.model._meta.app_label, obj.model._meta.object_name</font>
<font color="black">  64.                         ),</font>
<font color="red">  65.                         hint=None,</font>
<font color="red">  66.                         obj=obj.__class__,</font>
<font color="red">  67.                         id='admin.E303'</font>
<font color="black">  68.                     )</font>
<font color="black">  69.                 ]</font>
<font color="black">  70. </font>
<font color="black">  71.             # There's one or more GenericForeignKeys; make sure that one of them</font>
<font color="black">  72.             # uses the right ct_field and ct_fk_field.</font>
<font color="red">  73.             for gfk in gfks:</font>
<font color="red">  74.                 if gfk.ct_field == obj.ct_field and gfk.fk_field == obj.ct_fk_field:</font>
<font color="red">  75.                     return []</font>
<font color="black">  76. </font>
<font color="black">  77.             return [</font>
<font color="red">  78.                 checks.Error(</font>
<font color="red">  79.                     &quot;'%s.%s' has no GenericForeignKey using content type field '%s' and object ID field '%s'.&quot; % (</font>
<font color="red">  80.                         obj.model._meta.app_label, obj.model._meta.object_name, obj.ct_field, obj.ct_fk_field</font>
<font color="black">  81.                     ),</font>
<font color="red">  82.                     hint=None,</font>
<font color="red">  83.                     obj=obj.__class__,</font>
<font color="red">  84.                     id='admin.E304'</font>
<font color="black">  85.                 )</font>
<font color="black">  86.             ]</font>
<font color="black">  87. </font>
<font color="black">  88. </font>
<font color="green">  89. class GenericInlineModelAdmin(InlineModelAdmin):</font>
<font color="green">  90.     ct_field = &quot;content_type&quot;</font>
<font color="green">  91.     ct_fk_field = &quot;object_id&quot;</font>
<font color="green">  92.     formset = BaseGenericInlineFormSet</font>
<font color="black">  93. </font>
<font color="green">  94.     checks_class = GenericInlineModelAdminChecks</font>
<font color="black">  95. </font>
<font color="green">  96.     def get_formset(self, request, obj=None, **kwargs):</font>
<font color="red">  97.         if 'fields' in kwargs:</font>
<font color="red">  98.             fields = kwargs.pop('fields')</font>
<font color="black">  99.         else:</font>
<font color="red"> 100.             fields = flatten_fieldsets(self.get_fieldsets(request, obj))</font>
<font color="red"> 101.         if self.exclude is None:</font>
<font color="red"> 102.             exclude = []</font>
<font color="black"> 103.         else:</font>
<font color="red"> 104.             exclude = list(self.exclude)</font>
<font color="red"> 105.         exclude.extend(self.get_readonly_fields(request, obj))</font>
<font color="red"> 106.         if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:</font>
<font color="black"> 107.             # Take the custom ModelForm's Meta.exclude into account only if the</font>
<font color="black"> 108.             # GenericInlineModelAdmin doesn't define its own.</font>
<font color="red"> 109.             exclude.extend(self.form._meta.exclude)</font>
<font color="red"> 110.         exclude = exclude or None</font>
<font color="red"> 111.         can_delete = self.can_delete and self.has_delete_permission(request, obj)</font>
<font color="red"> 112.         defaults = {</font>
<font color="red"> 113.             &quot;ct_field&quot;: self.ct_field,</font>
<font color="red"> 114.             &quot;fk_field&quot;: self.ct_fk_field,</font>
<font color="red"> 115.             &quot;form&quot;: self.form,</font>
<font color="red"> 116.             &quot;formfield_callback&quot;: partial(self.formfield_for_dbfield, request=request),</font>
<font color="red"> 117.             &quot;formset&quot;: self.formset,</font>
<font color="red"> 118.             &quot;extra&quot;: self.get_extra(request, obj),</font>
<font color="red"> 119.             &quot;can_delete&quot;: can_delete,</font>
<font color="red"> 120.             &quot;can_order&quot;: False,</font>
<font color="red"> 121.             &quot;fields&quot;: fields,</font>
<font color="red"> 122.             &quot;min_num&quot;: self.get_min_num(request, obj),</font>
<font color="red"> 123.             &quot;max_num&quot;: self.get_max_num(request, obj),</font>
<font color="red"> 124.             &quot;exclude&quot;: exclude</font>
<font color="black"> 125.         }</font>
<font color="red"> 126.         defaults.update(kwargs)</font>
<font color="black"> 127. </font>
<font color="red"> 128.         if defaults['fields'] is None and not modelform_defines_fields(defaults['form']):</font>
<font color="red"> 129.             defaults['fields'] = ALL_FIELDS</font>
<font color="black"> 130. </font>
<font color="red"> 131.         return generic_inlineformset_factory(self.model, **defaults)</font>
<font color="black"> 132. </font>
<font color="black"> 133. </font>
<font color="green"> 134. class GenericStackedInline(GenericInlineModelAdmin):</font>
<font color="green"> 135.     template = 'admin/edit_inline/stacked.html'</font>
<font color="black"> 136. </font>
<font color="black"> 137. </font>
<font color="green"> 138. class GenericTabularInline(GenericInlineModelAdmin):</font>
<font color="green"> 139.     template = 'admin/edit_inline/tabular.html'</font>
</pre>


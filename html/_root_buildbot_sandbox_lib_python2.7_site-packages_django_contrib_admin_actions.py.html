source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/admin/actions.py</b><br>


file stats: <b>54 lines, 11 executed: 20.4% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Built-in, globally-available admin actions.</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="black">   4. </font>
<font color="green">   5. from django.contrib import messages</font>
<font color="green">   6. from django.contrib.admin import helpers</font>
<font color="green">   7. from django.contrib.admin.utils import get_deleted_objects, model_ngettext</font>
<font color="green">   8. from django.core.exceptions import PermissionDenied</font>
<font color="green">   9. from django.db import router</font>
<font color="green">  10. from django.template.response import TemplateResponse</font>
<font color="green">  11. from django.utils.encoding import force_text</font>
<font color="green">  12. from django.utils.translation import ugettext as _, ugettext_lazy</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. def delete_selected(modeladmin, request, queryset):</font>
<font color="black">  16.     &quot;&quot;&quot;</font>
<font color="black">  17.     Default action which deletes the selected objects.</font>
<font color="black">  18. </font>
<font color="black">  19.     This action first displays a confirmation page whichs shows all the</font>
<font color="black">  20.     deleteable objects, or, if the user has no permission one of the related</font>
<font color="black">  21.     childs (foreignkeys), a &quot;permission denied&quot; message.</font>
<font color="black">  22. </font>
<font color="black">  23.     Next, it deletes all selected objects and redirects back to the change list.</font>
<font color="black">  24.     &quot;&quot;&quot;</font>
<font color="red">  25.     opts = modeladmin.model._meta</font>
<font color="red">  26.     app_label = opts.app_label</font>
<font color="black">  27. </font>
<font color="black">  28.     # Check that the user has delete permission for the actual model</font>
<font color="red">  29.     if not modeladmin.has_delete_permission(request):</font>
<font color="red">  30.         raise PermissionDenied</font>
<font color="black">  31. </font>
<font color="red">  32.     using = router.db_for_write(modeladmin.model)</font>
<font color="black">  33. </font>
<font color="black">  34.     # Populate deletable_objects, a data structure of all related objects that</font>
<font color="black">  35.     # will also be deleted.</font>
<font color="red">  36.     deletable_objects, model_count, perms_needed, protected = get_deleted_objects(</font>
<font color="red">  37.         queryset, opts, request.user, modeladmin.admin_site, using)</font>
<font color="black">  38. </font>
<font color="black">  39.     # The user has already confirmed the deletion.</font>
<font color="black">  40.     # Do the deletion and return a None to display the change list view again.</font>
<font color="red">  41.     if request.POST.get('post'):</font>
<font color="red">  42.         if perms_needed:</font>
<font color="red">  43.             raise PermissionDenied</font>
<font color="red">  44.         n = queryset.count()</font>
<font color="red">  45.         if n:</font>
<font color="red">  46.             for obj in queryset:</font>
<font color="red">  47.                 obj_display = force_text(obj)</font>
<font color="red">  48.                 modeladmin.log_deletion(request, obj, obj_display)</font>
<font color="red">  49.             queryset.delete()</font>
<font color="red">  50.             modeladmin.message_user(request, _(&quot;Successfully deleted %(count)d %(items)s.&quot;) % {</font>
<font color="red">  51.                 &quot;count&quot;: n, &quot;items&quot;: model_ngettext(modeladmin.opts, n)</font>
<font color="red">  52.             }, messages.SUCCESS)</font>
<font color="black">  53.         # Return None to display the change list page again.</font>
<font color="red">  54.         return None</font>
<font color="black">  55. </font>
<font color="red">  56.     if len(queryset) == 1:</font>
<font color="red">  57.         objects_name = force_text(opts.verbose_name)</font>
<font color="black">  58.     else:</font>
<font color="red">  59.         objects_name = force_text(opts.verbose_name_plural)</font>
<font color="black">  60. </font>
<font color="red">  61.     if perms_needed or protected:</font>
<font color="red">  62.         title = _(&quot;Cannot delete %(name)s&quot;) % {&quot;name&quot;: objects_name}</font>
<font color="black">  63.     else:</font>
<font color="red">  64.         title = _(&quot;Are you sure?&quot;)</font>
<font color="black">  65. </font>
<font color="red">  66.     context = dict(</font>
<font color="red">  67.         modeladmin.admin_site.each_context(request),</font>
<font color="red">  68.         title=title,</font>
<font color="red">  69.         objects_name=objects_name,</font>
<font color="red">  70.         deletable_objects=[deletable_objects],</font>
<font color="red">  71.         model_count=dict(model_count).items(),</font>
<font color="red">  72.         queryset=queryset,</font>
<font color="red">  73.         perms_lacking=perms_needed,</font>
<font color="red">  74.         protected=protected,</font>
<font color="red">  75.         opts=opts,</font>
<font color="red">  76.         action_checkbox_name=helpers.ACTION_CHECKBOX_NAME,</font>
<font color="black">  77.     )</font>
<font color="black">  78. </font>
<font color="red">  79.     request.current_app = modeladmin.admin_site.name</font>
<font color="black">  80. </font>
<font color="black">  81.     # Display the confirmation page</font>
<font color="red">  82.     return TemplateResponse(request, modeladmin.delete_selected_confirmation_template or [</font>
<font color="red">  83.         &quot;admin/%s/%s/delete_selected_confirmation.html&quot; % (app_label, opts.model_name),</font>
<font color="red">  84.         &quot;admin/%s/delete_selected_confirmation.html&quot; % app_label,</font>
<font color="red">  85.         &quot;admin/delete_selected_confirmation.html&quot;</font>
<font color="red">  86.     ], context)</font>
<font color="black">  87. </font>
<font color="green">  88. delete_selected.short_description = ugettext_lazy(&quot;Delete selected %(verbose_name_plural)s&quot;)</font>
</pre>


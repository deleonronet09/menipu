source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/questioner.py</b><br>


file stats: <b>123 lines, 30 executed: 24.4% covered</b>
<pre>
<font color="green">   1. from __future__ import print_function, unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import importlib</font>
<font color="green">   4. import os</font>
<font color="green">   5. import sys</font>
<font color="black">   6. </font>
<font color="green">   7. from django.apps import apps</font>
<font color="green">   8. from django.db.models.fields import NOT_PROVIDED</font>
<font color="green">   9. from django.utils import datetime_safe, six, timezone</font>
<font color="green">  10. from django.utils.six.moves import input</font>
<font color="black">  11. </font>
<font color="green">  12. from .loader import MigrationLoader</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class MigrationQuestioner(object):</font>
<font color="black">  16.     &quot;&quot;&quot;</font>
<font color="black">  17.     Gives the autodetector responses to questions it might have.</font>
<font color="black">  18.     This base class has a built-in noninteractive mode, but the</font>
<font color="black">  19.     interactive subclass is what the command-line arguments will use.</font>
<font color="green">  20.     &quot;&quot;&quot;</font>
<font color="black">  21. </font>
<font color="green">  22.     def __init__(self, defaults=None, specified_apps=None, dry_run=None):</font>
<font color="red">  23.         self.defaults = defaults or {}</font>
<font color="red">  24.         self.specified_apps = specified_apps or set()</font>
<font color="red">  25.         self.dry_run = dry_run</font>
<font color="black">  26. </font>
<font color="green">  27.     def ask_initial(self, app_label):</font>
<font color="black">  28.         &quot;Should we create an initial migration for the app?&quot;</font>
<font color="black">  29.         # If it was specified on the command line, definitely true</font>
<font color="red">  30.         if app_label in self.specified_apps:</font>
<font color="red">  31.             return True</font>
<font color="black">  32.         # Otherwise, we look to see if it has a migrations module</font>
<font color="black">  33.         # without any Python files in it, apart from __init__.py.</font>
<font color="black">  34.         # Apps from the new app template will have these; the python</font>
<font color="black">  35.         # file check will ensure we skip South ones.</font>
<font color="red">  36.         try:</font>
<font color="red">  37.             app_config = apps.get_app_config(app_label)</font>
<font color="red">  38.         except LookupError:         # It's a fake app.</font>
<font color="red">  39.             return self.defaults.get(&quot;ask_initial&quot;, False)</font>
<font color="red">  40.         migrations_import_path = MigrationLoader.migrations_module(app_config.label)</font>
<font color="red">  41.         try:</font>
<font color="red">  42.             migrations_module = importlib.import_module(migrations_import_path)</font>
<font color="red">  43.         except ImportError:</font>
<font color="red">  44.             return self.defaults.get(&quot;ask_initial&quot;, False)</font>
<font color="black">  45.         else:</font>
<font color="red">  46.             if hasattr(migrations_module, &quot;__file__&quot;):</font>
<font color="red">  47.                 filenames = os.listdir(os.path.dirname(migrations_module.__file__))</font>
<font color="red">  48.             elif hasattr(migrations_module, &quot;__path__&quot;):</font>
<font color="red">  49.                 if len(migrations_module.__path__) &gt; 1:</font>
<font color="red">  50.                     return False</font>
<font color="red">  51.                 filenames = os.listdir(list(migrations_module.__path__)[0])</font>
<font color="red">  52.             return not any(x.endswith(&quot;.py&quot;) for x in filenames if x != &quot;__init__.py&quot;)</font>
<font color="black">  53. </font>
<font color="green">  54.     def ask_not_null_addition(self, field_name, model_name):</font>
<font color="black">  55.         &quot;Adding a NOT NULL field to a model&quot;</font>
<font color="black">  56.         # None means quit</font>
<font color="red">  57.         return None</font>
<font color="black">  58. </font>
<font color="green">  59.     def ask_not_null_alteration(self, field_name, model_name):</font>
<font color="black">  60.         &quot;Changing a NULL field to NOT NULL&quot;</font>
<font color="black">  61.         # None means quit</font>
<font color="red">  62.         return None</font>
<font color="black">  63. </font>
<font color="green">  64.     def ask_rename(self, model_name, old_name, new_name, field_instance):</font>
<font color="black">  65.         &quot;Was this field really renamed?&quot;</font>
<font color="red">  66.         return self.defaults.get(&quot;ask_rename&quot;, False)</font>
<font color="black">  67. </font>
<font color="green">  68.     def ask_rename_model(self, old_model_state, new_model_state):</font>
<font color="black">  69.         &quot;Was this model really renamed?&quot;</font>
<font color="red">  70.         return self.defaults.get(&quot;ask_rename_model&quot;, False)</font>
<font color="black">  71. </font>
<font color="green">  72.     def ask_merge(self, app_label):</font>
<font color="black">  73.         &quot;Do you really want to merge these migrations?&quot;</font>
<font color="red">  74.         return self.defaults.get(&quot;ask_merge&quot;, False)</font>
<font color="black">  75. </font>
<font color="black">  76. </font>
<font color="green">  77. class InteractiveMigrationQuestioner(MigrationQuestioner):</font>
<font color="black">  78. </font>
<font color="green">  79.     def _boolean_input(self, question, default=None):</font>
<font color="red">  80.         result = input(&quot;%s &quot; % question)</font>
<font color="red">  81.         if not result and default is not None:</font>
<font color="red">  82.             return default</font>
<font color="red">  83.         while len(result) &lt; 1 or result[0].lower() not in &quot;yn&quot;:</font>
<font color="red">  84.             result = input(&quot;Please answer yes or no: &quot;)</font>
<font color="red">  85.         return result[0].lower() == &quot;y&quot;</font>
<font color="black">  86. </font>
<font color="green">  87.     def _choice_input(self, question, choices):</font>
<font color="red">  88.         print(question)</font>
<font color="red">  89.         for i, choice in enumerate(choices):</font>
<font color="red">  90.             print(&quot; %s) %s&quot; % (i + 1, choice))</font>
<font color="red">  91.         result = input(&quot;Select an option: &quot;)</font>
<font color="red">  92.         while True:</font>
<font color="red">  93.             try:</font>
<font color="red">  94.                 value = int(result)</font>
<font color="red">  95.                 if 0 &lt; value &lt;= len(choices):</font>
<font color="red">  96.                     return value</font>
<font color="red">  97.             except ValueError:</font>
<font color="red">  98.                 pass</font>
<font color="red">  99.             result = input(&quot;Please select a valid option: &quot;)</font>
<font color="black"> 100. </font>
<font color="green"> 101.     def _ask_default(self):</font>
<font color="red"> 102.         print(&quot;Please enter the default value now, as valid Python&quot;)</font>
<font color="red"> 103.         print(&quot;The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now()&quot;)</font>
<font color="red"> 104.         while True:</font>
<font color="red"> 105.             if six.PY3:</font>
<font color="black"> 106.                 # Six does not correctly abstract over the fact that</font>
<font color="black"> 107.                 # py3 input returns a unicode string, while py2 raw_input</font>
<font color="black"> 108.                 # returns a bytestring.</font>
<font color="red"> 109.                 code = input(&quot;&gt;&gt;&gt; &quot;)</font>
<font color="black"> 110.             else:</font>
<font color="red"> 111.                 code = input(&quot;&gt;&gt;&gt; &quot;).decode(sys.stdin.encoding)</font>
<font color="red"> 112.             if not code:</font>
<font color="red"> 113.                 print(&quot;Please enter some code, or 'exit' (with no quotes) to exit.&quot;)</font>
<font color="red"> 114.             elif code == &quot;exit&quot;:</font>
<font color="red"> 115.                 sys.exit(1)</font>
<font color="black"> 116.             else:</font>
<font color="red"> 117.                 try:</font>
<font color="red"> 118.                     return eval(code, {}, {&quot;datetime&quot;: datetime_safe, &quot;timezone&quot;: timezone})</font>
<font color="red"> 119.                 except (SyntaxError, NameError) as e:</font>
<font color="red"> 120.                     print(&quot;Invalid input: %s&quot; % e)</font>
<font color="black"> 121. </font>
<font color="green"> 122.     def ask_not_null_addition(self, field_name, model_name):</font>
<font color="black"> 123.         &quot;Adding a NOT NULL field to a model&quot;</font>
<font color="red"> 124.         if not self.dry_run:</font>
<font color="red"> 125.             choice = self._choice_input(</font>
<font color="red"> 126.                 &quot;You are trying to add a non-nullable field '%s' to %s without a default; &quot;</font>
<font color="black"> 127.                 &quot;we can't do that (the database needs something to populate existing rows).\n&quot;</font>
<font color="red"> 128.                 &quot;Please select a fix:&quot; % (field_name, model_name),</font>
<font color="black"> 129.                 [</font>
<font color="red"> 130.                     &quot;Provide a one-off default now (will be set on all existing rows)&quot;,</font>
<font color="red"> 131.                     &quot;Quit, and let me add a default in models.py&quot;,</font>
<font color="black"> 132.                 ]</font>
<font color="black"> 133.             )</font>
<font color="red"> 134.             if choice == 2:</font>
<font color="red"> 135.                 sys.exit(3)</font>
<font color="black"> 136.             else:</font>
<font color="red"> 137.                 return self._ask_default()</font>
<font color="red"> 138.         return None</font>
<font color="black"> 139. </font>
<font color="green"> 140.     def ask_not_null_alteration(self, field_name, model_name):</font>
<font color="black"> 141.         &quot;Changing a NULL field to NOT NULL&quot;</font>
<font color="red"> 142.         if not self.dry_run:</font>
<font color="red"> 143.             choice = self._choice_input(</font>
<font color="red"> 144.                 &quot;You are trying to change the nullable field '%s' on %s to non-nullable &quot;</font>
<font color="black"> 145.                 &quot;without a default; we can't do that (the database needs something to &quot;</font>
<font color="black"> 146.                 &quot;populate existing rows).\n&quot;</font>
<font color="red"> 147.                 &quot;Please select a fix:&quot; % (field_name, model_name),</font>
<font color="black"> 148.                 [</font>
<font color="red"> 149.                     &quot;Provide a one-off default now (will be set on all existing rows)&quot;,</font>
<font color="red"> 150.                     (&quot;Ignore for now, and let me handle existing rows with NULL myself &quot;</font>
<font color="black"> 151.                      &quot;(e.g. because you added a RunPython or RunSQL operation to handle &quot;</font>
<font color="black"> 152.                      &quot;NULL values in a previous data migration)&quot;),</font>
<font color="red"> 153.                     &quot;Quit, and let me add a default in models.py&quot;,</font>
<font color="black"> 154.                 ]</font>
<font color="black"> 155.             )</font>
<font color="red"> 156.             if choice == 2:</font>
<font color="red"> 157.                 return NOT_PROVIDED</font>
<font color="red"> 158.             elif choice == 3:</font>
<font color="red"> 159.                 sys.exit(3)</font>
<font color="black"> 160.             else:</font>
<font color="red"> 161.                 return self._ask_default()</font>
<font color="red"> 162.         return None</font>
<font color="black"> 163. </font>
<font color="green"> 164.     def ask_rename(self, model_name, old_name, new_name, field_instance):</font>
<font color="black"> 165.         &quot;Was this field really renamed?&quot;</font>
<font color="red"> 166.         msg = &quot;Did you rename %s.%s to %s.%s (a %s)? [y/N]&quot;</font>
<font color="red"> 167.         return self._boolean_input(msg % (model_name, old_name, model_name, new_name,</font>
<font color="red"> 168.                                           field_instance.__class__.__name__), False)</font>
<font color="black"> 169. </font>
<font color="green"> 170.     def ask_rename_model(self, old_model_state, new_model_state):</font>
<font color="black"> 171.         &quot;Was this model really renamed?&quot;</font>
<font color="red"> 172.         msg = &quot;Did you rename the %s.%s model to %s? [y/N]&quot;</font>
<font color="red"> 173.         return self._boolean_input(msg % (old_model_state.app_label, old_model_state.name,</font>
<font color="red"> 174.                                           new_model_state.name), False)</font>
<font color="black"> 175. </font>
<font color="green"> 176.     def ask_merge(self, app_label):</font>
<font color="red"> 177.         return self._boolean_input(</font>
<font color="black"> 178.             &quot;\nMerging will only work if the operations printed above do not conflict\n&quot; +</font>
<font color="red"> 179.             &quot;with each other (working on different fields or models)\n&quot; +</font>
<font color="red"> 180.             &quot;Do you want to merge these migration branches? [y/N]&quot;,</font>
<font color="red"> 181.             False,</font>
<font color="black"> 182.         )</font>
<font color="black"> 183. </font>
<font color="black"> 184. </font>
<font color="green"> 185. class NonInteractiveMigrationQuestioner(MigrationQuestioner):</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def ask_not_null_addition(self, field_name, model_name):</font>
<font color="black"> 188.         # We can't ask the user, so act like the user aborted.</font>
<font color="red"> 189.         sys.exit(3)</font>
<font color="black"> 190. </font>
<font color="green"> 191.     def ask_not_null_alteration(self, field_name, model_name):</font>
<font color="black"> 192.         # We can't ask the user, so set as not provided.</font>
<font color="red"> 193.         return NOT_PROVIDED</font>
</pre>


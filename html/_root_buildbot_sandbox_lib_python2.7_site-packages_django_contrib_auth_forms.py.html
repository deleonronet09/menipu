source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/forms.py</b><br>


file stats: <b>243 lines, 107 executed: 44.0% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django import forms</font>
<font color="green">   4. from django.contrib.auth import (</font>
<font color="black">   5.     authenticate, get_user_model, password_validation,</font>
<font color="black">   6. )</font>
<font color="green">   7. from django.contrib.auth.hashers import (</font>
<font color="black">   8.     UNUSABLE_PASSWORD_PREFIX, identify_hasher,</font>
<font color="black">   9. )</font>
<font color="green">  10. from django.contrib.auth.models import User</font>
<font color="green">  11. from django.contrib.auth.tokens import default_token_generator</font>
<font color="green">  12. from django.contrib.sites.shortcuts import get_current_site</font>
<font color="green">  13. from django.core.mail import EmailMultiAlternatives</font>
<font color="green">  14. from django.forms.utils import flatatt</font>
<font color="green">  15. from django.template import loader</font>
<font color="green">  16. from django.utils.encoding import force_bytes</font>
<font color="green">  17. from django.utils.html import format_html, format_html_join</font>
<font color="green">  18. from django.utils.http import urlsafe_base64_encode</font>
<font color="green">  19. from django.utils.safestring import mark_safe</font>
<font color="green">  20. from django.utils.text import capfirst</font>
<font color="green">  21. from django.utils.translation import ugettext, ugettext_lazy as _</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. class ReadOnlyPasswordHashWidget(forms.Widget):</font>
<font color="green">  25.     def render(self, name, value, attrs):</font>
<font color="red">  26.         encoded = value</font>
<font color="red">  27.         final_attrs = self.build_attrs(attrs)</font>
<font color="black">  28. </font>
<font color="red">  29.         if not encoded or encoded.startswith(UNUSABLE_PASSWORD_PREFIX):</font>
<font color="red">  30.             summary = mark_safe(&quot;&lt;strong&gt;%s&lt;/strong&gt;&quot; % ugettext(&quot;No password set.&quot;))</font>
<font color="black">  31.         else:</font>
<font color="red">  32.             try:</font>
<font color="red">  33.                 hasher = identify_hasher(encoded)</font>
<font color="red">  34.             except ValueError:</font>
<font color="red">  35.                 summary = mark_safe(&quot;&lt;strong&gt;%s&lt;/strong&gt;&quot; % ugettext(</font>
<font color="red">  36.                     &quot;Invalid password format or unknown hashing algorithm.&quot;))</font>
<font color="black">  37.             else:</font>
<font color="red">  38.                 summary = format_html_join('',</font>
<font color="red">  39.                                            &quot;&lt;strong&gt;{}&lt;/strong&gt;: {} &quot;,</font>
<font color="red">  40.                                            ((ugettext(key), value)</font>
<font color="red">  41.                                             for key, value in hasher.safe_summary(encoded).items())</font>
<font color="black">  42.                                            )</font>
<font color="black">  43. </font>
<font color="red">  44.         return format_html(&quot;&lt;div{}&gt;{}&lt;/div&gt;&quot;, flatatt(final_attrs), summary)</font>
<font color="black">  45. </font>
<font color="black">  46. </font>
<font color="green">  47. class ReadOnlyPasswordHashField(forms.Field):</font>
<font color="green">  48.     widget = ReadOnlyPasswordHashWidget</font>
<font color="black">  49. </font>
<font color="green">  50.     def __init__(self, *args, **kwargs):</font>
<font color="green">  51.         kwargs.setdefault(&quot;required&quot;, False)</font>
<font color="green">  52.         super(ReadOnlyPasswordHashField, self).__init__(*args, **kwargs)</font>
<font color="black">  53. </font>
<font color="green">  54.     def bound_data(self, data, initial):</font>
<font color="black">  55.         # Always return initial because the widget doesn't</font>
<font color="black">  56.         # render an input field.</font>
<font color="red">  57.         return initial</font>
<font color="black">  58. </font>
<font color="green">  59.     def has_changed(self, initial, data):</font>
<font color="red">  60.         return False</font>
<font color="black">  61. </font>
<font color="black">  62. </font>
<font color="green">  63. class UserCreationForm(forms.ModelForm):</font>
<font color="black">  64.     &quot;&quot;&quot;</font>
<font color="black">  65.     A form that creates a user, with no privileges, from the given username and</font>
<font color="black">  66.     password.</font>
<font color="green">  67.     &quot;&quot;&quot;</font>
<font color="green">  68.     error_messages = {</font>
<font color="green">  69.         'password_mismatch': _(&quot;The two password fields didn't match.&quot;),</font>
<font color="black">  70.     }</font>
<font color="green">  71.     password1 = forms.CharField(label=_(&quot;Password&quot;),</font>
<font color="green">  72.         widget=forms.PasswordInput)</font>
<font color="green">  73.     password2 = forms.CharField(label=_(&quot;Password confirmation&quot;),</font>
<font color="green">  74.         widget=forms.PasswordInput,</font>
<font color="green">  75.         help_text=_(&quot;Enter the same password as before, for verification.&quot;))</font>
<font color="black">  76. </font>
<font color="green">  77.     class Meta:</font>
<font color="green">  78.         model = User</font>
<font color="green">  79.         fields = (&quot;username&quot;,)</font>
<font color="black">  80. </font>
<font color="green">  81.     def clean_password2(self):</font>
<font color="red">  82.         password1 = self.cleaned_data.get(&quot;password1&quot;)</font>
<font color="red">  83.         password2 = self.cleaned_data.get(&quot;password2&quot;)</font>
<font color="red">  84.         if password1 and password2 and password1 != password2:</font>
<font color="red">  85.             raise forms.ValidationError(</font>
<font color="red">  86.                 self.error_messages['password_mismatch'],</font>
<font color="red">  87.                 code='password_mismatch',</font>
<font color="black">  88.             )</font>
<font color="red">  89.         self.instance.username = self.cleaned_data.get('username')</font>
<font color="red">  90.         password_validation.validate_password(self.cleaned_data.get('password2'), self.instance)</font>
<font color="red">  91.         return password2</font>
<font color="black">  92. </font>
<font color="green">  93.     def save(self, commit=True):</font>
<font color="red">  94.         user = super(UserCreationForm, self).save(commit=False)</font>
<font color="red">  95.         user.set_password(self.cleaned_data[&quot;password1&quot;])</font>
<font color="red">  96.         if commit:</font>
<font color="red">  97.             user.save()</font>
<font color="red">  98.         return user</font>
<font color="black">  99. </font>
<font color="black"> 100. </font>
<font color="green"> 101. class UserChangeForm(forms.ModelForm):</font>
<font color="green"> 102.     password = ReadOnlyPasswordHashField(label=_(&quot;Password&quot;),</font>
<font color="green"> 103.         help_text=_(&quot;Raw passwords are not stored, so there is no way to see &quot;</font>
<font color="black"> 104.                     &quot;this user's password, but you can change the password &quot;</font>
<font color="black"> 105.                     &quot;using &lt;a href=\&quot;../password/\&quot;&gt;this form&lt;/a&gt;.&quot;))</font>
<font color="black"> 106. </font>
<font color="green"> 107.     class Meta:</font>
<font color="green"> 108.         model = User</font>
<font color="green"> 109.         fields = '__all__'</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def __init__(self, *args, **kwargs):</font>
<font color="red"> 112.         super(UserChangeForm, self).__init__(*args, **kwargs)</font>
<font color="red"> 113.         f = self.fields.get('user_permissions')</font>
<font color="red"> 114.         if f is not None:</font>
<font color="red"> 115.             f.queryset = f.queryset.select_related('content_type')</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def clean_password(self):</font>
<font color="black"> 118.         # Regardless of what the user provides, return the initial value.</font>
<font color="black"> 119.         # This is done here, rather than on the field, because the</font>
<font color="black"> 120.         # field does not have access to the initial value</font>
<font color="red"> 121.         return self.initial[&quot;password&quot;]</font>
<font color="black"> 122. </font>
<font color="black"> 123. </font>
<font color="green"> 124. class AuthenticationForm(forms.Form):</font>
<font color="black"> 125.     &quot;&quot;&quot;</font>
<font color="black"> 126.     Base class for authenticating users. Extend this to get a form that accepts</font>
<font color="black"> 127.     username/password logins.</font>
<font color="green"> 128.     &quot;&quot;&quot;</font>
<font color="green"> 129.     username = forms.CharField(max_length=254)</font>
<font color="green"> 130.     password = forms.CharField(label=_(&quot;Password&quot;), widget=forms.PasswordInput)</font>
<font color="black"> 131. </font>
<font color="green"> 132.     error_messages = {</font>
<font color="green"> 133.         'invalid_login': _(&quot;Please enter a correct %(username)s and password. &quot;</font>
<font color="black"> 134.                            &quot;Note that both fields may be case-sensitive.&quot;),</font>
<font color="green"> 135.         'inactive': _(&quot;This account is inactive.&quot;),</font>
<font color="black"> 136.     }</font>
<font color="black"> 137. </font>
<font color="green"> 138.     def __init__(self, request=None, *args, **kwargs):</font>
<font color="black"> 139.         &quot;&quot;&quot;</font>
<font color="black"> 140.         The 'request' parameter is set for custom auth use by subclasses.</font>
<font color="black"> 141.         The form data comes in via the standard 'data' kwarg.</font>
<font color="black"> 142.         &quot;&quot;&quot;</font>
<font color="red"> 143.         self.request = request</font>
<font color="red"> 144.         self.user_cache = None</font>
<font color="red"> 145.         super(AuthenticationForm, self).__init__(*args, **kwargs)</font>
<font color="black"> 146. </font>
<font color="black"> 147.         # Set the label for the &quot;username&quot; field.</font>
<font color="red"> 148.         UserModel = get_user_model()</font>
<font color="red"> 149.         self.username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)</font>
<font color="red"> 150.         if self.fields['username'].label is None:</font>
<font color="red"> 151.             self.fields['username'].label = capfirst(self.username_field.verbose_name)</font>
<font color="black"> 152. </font>
<font color="green"> 153.     def clean(self):</font>
<font color="red"> 154.         username = self.cleaned_data.get('username')</font>
<font color="red"> 155.         password = self.cleaned_data.get('password')</font>
<font color="black"> 156. </font>
<font color="red"> 157.         if username and password:</font>
<font color="red"> 158.             self.user_cache = authenticate(username=username,</font>
<font color="red"> 159.                                            password=password)</font>
<font color="red"> 160.             if self.user_cache is None:</font>
<font color="red"> 161.                 raise forms.ValidationError(</font>
<font color="red"> 162.                     self.error_messages['invalid_login'],</font>
<font color="red"> 163.                     code='invalid_login',</font>
<font color="red"> 164.                     params={'username': self.username_field.verbose_name},</font>
<font color="black"> 165.                 )</font>
<font color="black"> 166.             else:</font>
<font color="red"> 167.                 self.confirm_login_allowed(self.user_cache)</font>
<font color="black"> 168. </font>
<font color="red"> 169.         return self.cleaned_data</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def confirm_login_allowed(self, user):</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="black"> 173.         Controls whether the given User may log in. This is a policy setting,</font>
<font color="black"> 174.         independent of end-user authentication. This default behavior is to</font>
<font color="black"> 175.         allow login by active users, and reject login by inactive users.</font>
<font color="black"> 176. </font>
<font color="black"> 177.         If the given user cannot log in, this method should raise a</font>
<font color="black"> 178.         ``forms.ValidationError``.</font>
<font color="black"> 179. </font>
<font color="black"> 180.         If the given user may log in, this method should return None.</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="red"> 182.         if not user.is_active:</font>
<font color="red"> 183.             raise forms.ValidationError(</font>
<font color="red"> 184.                 self.error_messages['inactive'],</font>
<font color="red"> 185.                 code='inactive',</font>
<font color="black"> 186.             )</font>
<font color="black"> 187. </font>
<font color="green"> 188.     def get_user_id(self):</font>
<font color="red"> 189.         if self.user_cache:</font>
<font color="red"> 190.             return self.user_cache.id</font>
<font color="red"> 191.         return None</font>
<font color="black"> 192. </font>
<font color="green"> 193.     def get_user(self):</font>
<font color="red"> 194.         return self.user_cache</font>
<font color="black"> 195. </font>
<font color="black"> 196. </font>
<font color="green"> 197. class PasswordResetForm(forms.Form):</font>
<font color="green"> 198.     email = forms.EmailField(label=_(&quot;Email&quot;), max_length=254)</font>
<font color="black"> 199. </font>
<font color="black"> 200.     def send_mail(self, subject_template_name, email_template_name,</font>
<font color="green"> 201.                   context, from_email, to_email, html_email_template_name=None):</font>
<font color="black"> 202.         &quot;&quot;&quot;</font>
<font color="black"> 203.         Sends a django.core.mail.EmailMultiAlternatives to `to_email`.</font>
<font color="black"> 204.         &quot;&quot;&quot;</font>
<font color="red"> 205.         subject = loader.render_to_string(subject_template_name, context)</font>
<font color="black"> 206.         # Email subject *must not* contain newlines</font>
<font color="red"> 207.         subject = ''.join(subject.splitlines())</font>
<font color="red"> 208.         body = loader.render_to_string(email_template_name, context)</font>
<font color="black"> 209. </font>
<font color="red"> 210.         email_message = EmailMultiAlternatives(subject, body, from_email, [to_email])</font>
<font color="red"> 211.         if html_email_template_name is not None:</font>
<font color="red"> 212.             html_email = loader.render_to_string(html_email_template_name, context)</font>
<font color="red"> 213.             email_message.attach_alternative(html_email, 'text/html')</font>
<font color="black"> 214. </font>
<font color="red"> 215.         email_message.send()</font>
<font color="black"> 216. </font>
<font color="green"> 217.     def get_users(self, email):</font>
<font color="black"> 218.         &quot;&quot;&quot;Given an email, return matching user(s) who should receive a reset.</font>
<font color="black"> 219. </font>
<font color="black"> 220.         This allows subclasses to more easily customize the default policies</font>
<font color="black"> 221.         that prevent inactive users and users with unusable passwords from</font>
<font color="black"> 222.         resetting their password.</font>
<font color="black"> 223.         &quot;&quot;&quot;</font>
<font color="red"> 224.         active_users = get_user_model()._default_manager.filter(</font>
<font color="red"> 225.             email__iexact=email, is_active=True)</font>
<font color="red"> 226.         return (u for u in active_users if u.has_usable_password())</font>
<font color="black"> 227. </font>
<font color="green"> 228.     def save(self, domain_override=None,</font>
<font color="green"> 229.              subject_template_name='registration/password_reset_subject.txt',</font>
<font color="green"> 230.              email_template_name='registration/password_reset_email.html',</font>
<font color="green"> 231.              use_https=False, token_generator=default_token_generator,</font>
<font color="green"> 232.              from_email=None, request=None, html_email_template_name=None,</font>
<font color="green"> 233.              extra_email_context=None):</font>
<font color="black"> 234.         &quot;&quot;&quot;</font>
<font color="black"> 235.         Generates a one-use only link for resetting password and sends to the</font>
<font color="black"> 236.         user.</font>
<font color="black"> 237.         &quot;&quot;&quot;</font>
<font color="red"> 238.         email = self.cleaned_data[&quot;email&quot;]</font>
<font color="red"> 239.         for user in self.get_users(email):</font>
<font color="red"> 240.             if not domain_override:</font>
<font color="red"> 241.                 current_site = get_current_site(request)</font>
<font color="red"> 242.                 site_name = current_site.name</font>
<font color="red"> 243.                 domain = current_site.domain</font>
<font color="black"> 244.             else:</font>
<font color="red"> 245.                 site_name = domain = domain_override</font>
<font color="red"> 246.             context = {</font>
<font color="red"> 247.                 'email': user.email,</font>
<font color="red"> 248.                 'domain': domain,</font>
<font color="red"> 249.                 'site_name': site_name,</font>
<font color="red"> 250.                 'uid': urlsafe_base64_encode(force_bytes(user.pk)),</font>
<font color="red"> 251.                 'user': user,</font>
<font color="red"> 252.                 'token': token_generator.make_token(user),</font>
<font color="red"> 253.                 'protocol': 'https' if use_https else 'http',</font>
<font color="black"> 254.             }</font>
<font color="red"> 255.             if extra_email_context is not None:</font>
<font color="red"> 256.                 context.update(extra_email_context)</font>
<font color="red"> 257.             self.send_mail(subject_template_name, email_template_name,</font>
<font color="red"> 258.                            context, from_email, user.email,</font>
<font color="red"> 259.                            html_email_template_name=html_email_template_name)</font>
<font color="black"> 260. </font>
<font color="black"> 261. </font>
<font color="green"> 262. class SetPasswordForm(forms.Form):</font>
<font color="black"> 263.     &quot;&quot;&quot;</font>
<font color="black"> 264.     A form that lets a user change set their password without entering the old</font>
<font color="black"> 265.     password</font>
<font color="green"> 266.     &quot;&quot;&quot;</font>
<font color="green"> 267.     error_messages = {</font>
<font color="green"> 268.         'password_mismatch': _(&quot;The two password fields didn't match.&quot;),</font>
<font color="black"> 269.     }</font>
<font color="green"> 270.     new_password1 = forms.CharField(label=_(&quot;New password&quot;),</font>
<font color="green"> 271.                                     widget=forms.PasswordInput,</font>
<font color="green"> 272.                                     help_text=password_validation.password_validators_help_text_html())</font>
<font color="green"> 273.     new_password2 = forms.CharField(label=_(&quot;New password confirmation&quot;),</font>
<font color="green"> 274.                                     widget=forms.PasswordInput)</font>
<font color="black"> 275. </font>
<font color="green"> 276.     def __init__(self, user, *args, **kwargs):</font>
<font color="red"> 277.         self.user = user</font>
<font color="red"> 278.         super(SetPasswordForm, self).__init__(*args, **kwargs)</font>
<font color="black"> 279. </font>
<font color="green"> 280.     def clean_new_password2(self):</font>
<font color="red"> 281.         password1 = self.cleaned_data.get('new_password1')</font>
<font color="red"> 282.         password2 = self.cleaned_data.get('new_password2')</font>
<font color="red"> 283.         if password1 and password2:</font>
<font color="red"> 284.             if password1 != password2:</font>
<font color="red"> 285.                 raise forms.ValidationError(</font>
<font color="red"> 286.                     self.error_messages['password_mismatch'],</font>
<font color="red"> 287.                     code='password_mismatch',</font>
<font color="black"> 288.                 )</font>
<font color="red"> 289.         password_validation.validate_password(password2, self.user)</font>
<font color="red"> 290.         return password2</font>
<font color="black"> 291. </font>
<font color="green"> 292.     def save(self, commit=True):</font>
<font color="red"> 293.         password = self.cleaned_data[&quot;new_password1&quot;]</font>
<font color="red"> 294.         self.user.set_password(password)</font>
<font color="red"> 295.         if commit:</font>
<font color="red"> 296.             self.user.save()</font>
<font color="red"> 297.         return self.user</font>
<font color="black"> 298. </font>
<font color="black"> 299. </font>
<font color="green"> 300. class PasswordChangeForm(SetPasswordForm):</font>
<font color="black"> 301.     &quot;&quot;&quot;</font>
<font color="black"> 302.     A form that lets a user change their password by entering their old</font>
<font color="black"> 303.     password.</font>
<font color="green"> 304.     &quot;&quot;&quot;</font>
<font color="green"> 305.     error_messages = dict(SetPasswordForm.error_messages, **{</font>
<font color="green"> 306.         'password_incorrect': _(&quot;Your old password was entered incorrectly. &quot;</font>
<font color="black"> 307.                                 &quot;Please enter it again.&quot;),</font>
<font color="black"> 308.     })</font>
<font color="green"> 309.     old_password = forms.CharField(label=_(&quot;Old password&quot;),</font>
<font color="green"> 310.                                    widget=forms.PasswordInput)</font>
<font color="black"> 311. </font>
<font color="green"> 312.     field_order = ['old_password', 'new_password1', 'new_password2']</font>
<font color="black"> 313. </font>
<font color="green"> 314.     def clean_old_password(self):</font>
<font color="black"> 315.         &quot;&quot;&quot;</font>
<font color="black"> 316.         Validates that the old_password field is correct.</font>
<font color="black"> 317.         &quot;&quot;&quot;</font>
<font color="red"> 318.         old_password = self.cleaned_data[&quot;old_password&quot;]</font>
<font color="red"> 319.         if not self.user.check_password(old_password):</font>
<font color="red"> 320.             raise forms.ValidationError(</font>
<font color="red"> 321.                 self.error_messages['password_incorrect'],</font>
<font color="red"> 322.                 code='password_incorrect',</font>
<font color="black"> 323.             )</font>
<font color="red"> 324.         return old_password</font>
<font color="black"> 325. </font>
<font color="black"> 326. </font>
<font color="green"> 327. class AdminPasswordChangeForm(forms.Form):</font>
<font color="black"> 328.     &quot;&quot;&quot;</font>
<font color="black"> 329.     A form used to change the password of a user in the admin interface.</font>
<font color="green"> 330.     &quot;&quot;&quot;</font>
<font color="green"> 331.     error_messages = {</font>
<font color="green"> 332.         'password_mismatch': _(&quot;The two password fields didn't match.&quot;),</font>
<font color="black"> 333.     }</font>
<font color="green"> 334.     required_css_class = 'required'</font>
<font color="green"> 335.     password1 = forms.CharField(</font>
<font color="green"> 336.         label=_(&quot;Password&quot;),</font>
<font color="green"> 337.         widget=forms.PasswordInput,</font>
<font color="green"> 338.         help_text=password_validation.password_validators_help_text_html(),</font>
<font color="black"> 339.     )</font>
<font color="green"> 340.     password2 = forms.CharField(</font>
<font color="green"> 341.         label=_(&quot;Password (again)&quot;),</font>
<font color="green"> 342.         widget=forms.PasswordInput,</font>
<font color="green"> 343.         help_text=_(&quot;Enter the same password as before, for verification.&quot;),</font>
<font color="black"> 344.     )</font>
<font color="black"> 345. </font>
<font color="green"> 346.     def __init__(self, user, *args, **kwargs):</font>
<font color="red"> 347.         self.user = user</font>
<font color="red"> 348.         super(AdminPasswordChangeForm, self).__init__(*args, **kwargs)</font>
<font color="black"> 349. </font>
<font color="green"> 350.     def clean_password2(self):</font>
<font color="red"> 351.         password1 = self.cleaned_data.get('password1')</font>
<font color="red"> 352.         password2 = self.cleaned_data.get('password2')</font>
<font color="red"> 353.         if password1 and password2:</font>
<font color="red"> 354.             if password1 != password2:</font>
<font color="red"> 355.                 raise forms.ValidationError(</font>
<font color="red"> 356.                     self.error_messages['password_mismatch'],</font>
<font color="red"> 357.                     code='password_mismatch',</font>
<font color="black"> 358.                 )</font>
<font color="red"> 359.         password_validation.validate_password(password2, self.user)</font>
<font color="red"> 360.         return password2</font>
<font color="black"> 361. </font>
<font color="green"> 362.     def save(self, commit=True):</font>
<font color="black"> 363.         &quot;&quot;&quot;</font>
<font color="black"> 364.         Saves the new password.</font>
<font color="black"> 365.         &quot;&quot;&quot;</font>
<font color="red"> 366.         password = self.cleaned_data[&quot;password1&quot;]</font>
<font color="red"> 367.         self.user.set_password(password)</font>
<font color="red"> 368.         if commit:</font>
<font color="red"> 369.             self.user.save()</font>
<font color="red"> 370.         return self.user</font>
<font color="black"> 371. </font>
<font color="green"> 372.     def _get_changed_data(self):</font>
<font color="red"> 373.         data = super(AdminPasswordChangeForm, self).changed_data</font>
<font color="red"> 374.         for name in self.fields.keys():</font>
<font color="red"> 375.             if name not in data:</font>
<font color="red"> 376.                 return []</font>
<font color="red"> 377.         return ['password']</font>
<font color="green"> 378.     changed_data = property(_get_changed_data)</font>
</pre>


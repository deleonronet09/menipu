source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/admin/sites.py</b><br>


file stats: <b>287 lines, 79 executed: 27.5% covered</b>
<pre>
<font color="green">   1. from functools import update_wrapper</font>
<font color="black">   2. </font>
<font color="green">   3. from django.apps import apps</font>
<font color="green">   4. from django.conf import settings</font>
<font color="green">   5. from django.contrib.admin import ModelAdmin, actions</font>
<font color="green">   6. from django.contrib.auth import REDIRECT_FIELD_NAME</font>
<font color="green">   7. from django.core.exceptions import ImproperlyConfigured, PermissionDenied</font>
<font color="green">   8. from django.core.urlresolvers import NoReverseMatch, reverse</font>
<font color="green">   9. from django.db.models.base import ModelBase</font>
<font color="green">  10. from django.http import Http404, HttpResponseRedirect</font>
<font color="green">  11. from django.template.engine import Engine</font>
<font color="green">  12. from django.template.response import TemplateResponse</font>
<font color="green">  13. from django.utils import six</font>
<font color="green">  14. from django.utils.text import capfirst</font>
<font color="green">  15. from django.utils.translation import ugettext as _, ugettext_lazy</font>
<font color="green">  16. from django.views.decorators.cache import never_cache</font>
<font color="green">  17. from django.views.decorators.csrf import csrf_protect</font>
<font color="black">  18. </font>
<font color="green">  19. system_check_errors = []</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. class AlreadyRegistered(Exception):</font>
<font color="green">  23.     pass</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="green">  26. class NotRegistered(Exception):</font>
<font color="green">  27.     pass</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. class AdminSite(object):</font>
<font color="black">  31.     &quot;&quot;&quot;</font>
<font color="black">  32.     An AdminSite object encapsulates an instance of the Django admin application, ready</font>
<font color="black">  33.     to be hooked in to your URLconf. Models are registered with the AdminSite using the</font>
<font color="black">  34.     register() method, and the get_urls() method can then be used to access Django view</font>
<font color="black">  35.     functions that present a full admin interface for the collection of registered</font>
<font color="black">  36.     models.</font>
<font color="green">  37.     &quot;&quot;&quot;</font>
<font color="black">  38. </font>
<font color="black">  39.     # Text to put at the end of each page's &lt;title&gt;.</font>
<font color="green">  40.     site_title = ugettext_lazy('Django site admin')</font>
<font color="black">  41. </font>
<font color="black">  42.     # Text to put in each page's &lt;h1&gt;.</font>
<font color="green">  43.     site_header = ugettext_lazy('Django administration')</font>
<font color="black">  44. </font>
<font color="black">  45.     # Text to put at the top of the admin index page.</font>
<font color="green">  46.     index_title = ugettext_lazy('Site administration')</font>
<font color="black">  47. </font>
<font color="black">  48.     # URL for the &quot;View site&quot; link at the top of each admin page.</font>
<font color="green">  49.     site_url = '/'</font>
<font color="black">  50. </font>
<font color="green">  51.     _empty_value_display = '-'</font>
<font color="black">  52. </font>
<font color="green">  53.     login_form = None</font>
<font color="green">  54.     index_template = None</font>
<font color="green">  55.     app_index_template = None</font>
<font color="green">  56.     login_template = None</font>
<font color="green">  57.     logout_template = None</font>
<font color="green">  58.     password_change_template = None</font>
<font color="green">  59.     password_change_done_template = None</font>
<font color="black">  60. </font>
<font color="green">  61.     def __init__(self, name='admin'):</font>
<font color="green">  62.         self._registry = {}  # model_class class -&gt; admin_class instance</font>
<font color="green">  63.         self.name = name</font>
<font color="green">  64.         self._actions = {'delete_selected': actions.delete_selected}</font>
<font color="green">  65.         self._global_actions = self._actions.copy()</font>
<font color="black">  66. </font>
<font color="green">  67.     def register(self, model_or_iterable, admin_class=None, **options):</font>
<font color="black">  68.         &quot;&quot;&quot;</font>
<font color="black">  69.         Registers the given model(s) with the given admin class.</font>
<font color="black">  70. </font>
<font color="black">  71.         The model(s) should be Model classes, not instances.</font>
<font color="black">  72. </font>
<font color="black">  73.         If an admin class isn't given, it will use ModelAdmin (the default</font>
<font color="black">  74.         admin options). If keyword arguments are given -- e.g., list_display --</font>
<font color="black">  75.         they'll be applied as options to the admin class.</font>
<font color="black">  76. </font>
<font color="black">  77.         If a model is already registered, this will raise AlreadyRegistered.</font>
<font color="black">  78. </font>
<font color="black">  79.         If a model is abstract, this will raise ImproperlyConfigured.</font>
<font color="black">  80.         &quot;&quot;&quot;</font>
<font color="green">  81.         if not admin_class:</font>
<font color="red">  82.             admin_class = ModelAdmin</font>
<font color="black">  83. </font>
<font color="green">  84.         if isinstance(model_or_iterable, ModelBase):</font>
<font color="red">  85.             model_or_iterable = [model_or_iterable]</font>
<font color="green">  86.         for model in model_or_iterable:</font>
<font color="green">  87.             if model._meta.abstract:</font>
<font color="red">  88.                 raise ImproperlyConfigured('The model %s is abstract, so it '</font>
<font color="red">  89.                       'cannot be registered with admin.' % model.__name__)</font>
<font color="black">  90. </font>
<font color="green">  91.             if model in self._registry:</font>
<font color="red">  92.                 raise AlreadyRegistered('The model %s is already registered' % model.__name__)</font>
<font color="black">  93. </font>
<font color="black">  94.             # Ignore the registration if the model has been</font>
<font color="black">  95.             # swapped out.</font>
<font color="green">  96.             if not model._meta.swapped:</font>
<font color="black">  97.                 # If we got **options then dynamically construct a subclass of</font>
<font color="black">  98.                 # admin_class with those **options.</font>
<font color="green">  99.                 if options:</font>
<font color="black"> 100.                     # For reasons I don't quite understand, without a __module__</font>
<font color="black"> 101.                     # the created class appears to &quot;live&quot; in the wrong place,</font>
<font color="black"> 102.                     # which causes issues later on.</font>
<font color="red"> 103.                     options['__module__'] = __name__</font>
<font color="red"> 104.                     admin_class = type(&quot;%sAdmin&quot; % model.__name__, (admin_class,), options)</font>
<font color="black"> 105. </font>
<font color="black"> 106.                 # Instantiate the admin class to save in the registry</font>
<font color="green"> 107.                 admin_obj = admin_class(model, self)</font>
<font color="green"> 108.                 if admin_class is not ModelAdmin and settings.DEBUG:</font>
<font color="green"> 109.                     system_check_errors.extend(admin_obj.check())</font>
<font color="black"> 110. </font>
<font color="green"> 111.                 self._registry[model] = admin_obj</font>
<font color="black"> 112. </font>
<font color="green"> 113.     def unregister(self, model_or_iterable):</font>
<font color="black"> 114.         &quot;&quot;&quot;</font>
<font color="black"> 115.         Unregisters the given model(s).</font>
<font color="black"> 116. </font>
<font color="black"> 117.         If a model isn't already registered, this will raise NotRegistered.</font>
<font color="black"> 118.         &quot;&quot;&quot;</font>
<font color="red"> 119.         if isinstance(model_or_iterable, ModelBase):</font>
<font color="red"> 120.             model_or_iterable = [model_or_iterable]</font>
<font color="red"> 121.         for model in model_or_iterable:</font>
<font color="red"> 122.             if model not in self._registry:</font>
<font color="red"> 123.                 raise NotRegistered('The model %s is not registered' % model.__name__)</font>
<font color="red"> 124.             del self._registry[model]</font>
<font color="black"> 125. </font>
<font color="green"> 126.     def is_registered(self, model):</font>
<font color="black"> 127.         &quot;&quot;&quot;</font>
<font color="black"> 128.         Check if a model class is registered with this `AdminSite`.</font>
<font color="black"> 129.         &quot;&quot;&quot;</font>
<font color="red"> 130.         return model in self._registry</font>
<font color="black"> 131. </font>
<font color="green"> 132.     def add_action(self, action, name=None):</font>
<font color="black"> 133.         &quot;&quot;&quot;</font>
<font color="black"> 134.         Register an action to be available globally.</font>
<font color="black"> 135.         &quot;&quot;&quot;</font>
<font color="red"> 136.         name = name or action.__name__</font>
<font color="red"> 137.         self._actions[name] = action</font>
<font color="red"> 138.         self._global_actions[name] = action</font>
<font color="black"> 139. </font>
<font color="green"> 140.     def disable_action(self, name):</font>
<font color="black"> 141.         &quot;&quot;&quot;</font>
<font color="black"> 142.         Disable a globally-registered action. Raises KeyError for invalid names.</font>
<font color="black"> 143.         &quot;&quot;&quot;</font>
<font color="red"> 144.         del self._actions[name]</font>
<font color="black"> 145. </font>
<font color="green"> 146.     def get_action(self, name):</font>
<font color="black"> 147.         &quot;&quot;&quot;</font>
<font color="black"> 148.         Explicitly get a registered global action whether it's enabled or</font>
<font color="black"> 149.         not. Raises KeyError for invalid names.</font>
<font color="black"> 150.         &quot;&quot;&quot;</font>
<font color="red"> 151.         return self._global_actions[name]</font>
<font color="black"> 152. </font>
<font color="green"> 153.     @property</font>
<font color="black"> 154.     def actions(self):</font>
<font color="black"> 155.         &quot;&quot;&quot;</font>
<font color="black"> 156.         Get all the enabled actions as an iterable of (name, func).</font>
<font color="black"> 157.         &quot;&quot;&quot;</font>
<font color="red"> 158.         return six.iteritems(self._actions)</font>
<font color="black"> 159. </font>
<font color="green"> 160.     @property</font>
<font color="black"> 161.     def empty_value_display(self):</font>
<font color="red"> 162.         return self._empty_value_display</font>
<font color="black"> 163. </font>
<font color="green"> 164.     @empty_value_display.setter</font>
<font color="black"> 165.     def empty_value_display(self, empty_value_display):</font>
<font color="red"> 166.         self._empty_value_display = empty_value_display</font>
<font color="black"> 167. </font>
<font color="green"> 168.     def has_permission(self, request):</font>
<font color="black"> 169.         &quot;&quot;&quot;</font>
<font color="black"> 170.         Returns True if the given HttpRequest has permission to view</font>
<font color="black"> 171.         *at least one* page in the admin site.</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="red"> 173.         return request.user.is_active and request.user.is_staff</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def check_dependencies(self):</font>
<font color="black"> 176.         &quot;&quot;&quot;</font>
<font color="black"> 177.         Check that all things needed to run the admin have been correctly installed.</font>
<font color="black"> 178. </font>
<font color="black"> 179.         The default implementation checks that admin and contenttypes apps are</font>
<font color="black"> 180.         installed, as well as the auth context processor.</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="red"> 182.         if not apps.is_installed('django.contrib.admin'):</font>
<font color="red"> 183.             raise ImproperlyConfigured(</font>
<font color="red"> 184.                 &quot;Put 'django.contrib.admin' in your INSTALLED_APPS &quot;</font>
<font color="black"> 185.                 &quot;setting in order to use the admin application.&quot;)</font>
<font color="red"> 186.         if not apps.is_installed('django.contrib.contenttypes'):</font>
<font color="red"> 187.             raise ImproperlyConfigured(</font>
<font color="red"> 188.                 &quot;Put 'django.contrib.contenttypes' in your INSTALLED_APPS &quot;</font>
<font color="black"> 189.                 &quot;setting in order to use the admin application.&quot;)</font>
<font color="red"> 190.         try:</font>
<font color="red"> 191.             default_template_engine = Engine.get_default()</font>
<font color="red"> 192.         except Exception:</font>
<font color="black"> 193.             # Skip this non-critical check:</font>
<font color="black"> 194.             # 1. if the user has a non-trivial TEMPLATES setting and Django</font>
<font color="black"> 195.             #    can't find a default template engine</font>
<font color="black"> 196.             # 2. if anything goes wrong while loading template engines, in</font>
<font color="black"> 197.             #    order to avoid raising an exception from a confusing location</font>
<font color="black"> 198.             # Catching ImproperlyConfigured suffices for 1. but 2. requires</font>
<font color="black"> 199.             # catching all exceptions.</font>
<font color="red"> 200.             pass</font>
<font color="black"> 201.         else:</font>
<font color="red"> 202.             if ('django.contrib.auth.context_processors.auth'</font>
<font color="red"> 203.                     not in default_template_engine.context_processors):</font>
<font color="red"> 204.                 raise ImproperlyConfigured(</font>
<font color="red"> 205.                     &quot;Enable 'django.contrib.auth.context_processors.auth' &quot;</font>
<font color="black"> 206.                     &quot;in your TEMPLATES setting in order to use the admin &quot;</font>
<font color="black"> 207.                     &quot;application.&quot;)</font>
<font color="black"> 208. </font>
<font color="green"> 209.     def admin_view(self, view, cacheable=False):</font>
<font color="black"> 210.         &quot;&quot;&quot;</font>
<font color="black"> 211.         Decorator to create an admin view attached to this ``AdminSite``. This</font>
<font color="black"> 212.         wraps the view and provides permission checking by calling</font>
<font color="black"> 213.         ``self.has_permission``.</font>
<font color="black"> 214. </font>
<font color="black"> 215.         You'll want to use this from within ``AdminSite.get_urls()``:</font>
<font color="black"> 216. </font>
<font color="black"> 217.             class MyAdminSite(AdminSite):</font>
<font color="black"> 218. </font>
<font color="black"> 219.                 def get_urls(self):</font>
<font color="black"> 220.                     from django.conf.urls import url</font>
<font color="black"> 221. </font>
<font color="black"> 222.                     urls = super(MyAdminSite, self).get_urls()</font>
<font color="black"> 223.                     urls += [</font>
<font color="black"> 224.                         url(r'^my_view/$', self.admin_view(some_view))</font>
<font color="black"> 225.                     ]</font>
<font color="black"> 226.                     return urls</font>
<font color="black"> 227. </font>
<font color="black"> 228.         By default, admin_views are marked non-cacheable using the</font>
<font color="black"> 229.         ``never_cache`` decorator. If the view can be safely cached, set</font>
<font color="black"> 230.         cacheable=True.</font>
<font color="black"> 231.         &quot;&quot;&quot;</font>
<font color="red"> 232.         def inner(request, *args, **kwargs):</font>
<font color="red"> 233.             if not self.has_permission(request):</font>
<font color="red"> 234.                 if request.path == reverse('admin:logout', current_app=self.name):</font>
<font color="red"> 235.                     index_path = reverse('admin:index', current_app=self.name)</font>
<font color="red"> 236.                     return HttpResponseRedirect(index_path)</font>
<font color="black"> 237.                 # Inner import to prevent django.contrib.admin (app) from</font>
<font color="black"> 238.                 # importing django.contrib.auth.models.User (unrelated model).</font>
<font color="red"> 239.                 from django.contrib.auth.views import redirect_to_login</font>
<font color="red"> 240.                 return redirect_to_login(</font>
<font color="red"> 241.                     request.get_full_path(),</font>
<font color="red"> 242.                     reverse('admin:login', current_app=self.name)</font>
<font color="black"> 243.                 )</font>
<font color="red"> 244.             return view(request, *args, **kwargs)</font>
<font color="red"> 245.         if not cacheable:</font>
<font color="red"> 246.             inner = never_cache(inner)</font>
<font color="black"> 247.         # We add csrf_protect here so this function can be used as a utility</font>
<font color="black"> 248.         # function for any view, without having to repeat 'csrf_protect'.</font>
<font color="red"> 249.         if not getattr(view, 'csrf_exempt', False):</font>
<font color="red"> 250.             inner = csrf_protect(inner)</font>
<font color="red"> 251.         return update_wrapper(inner, view)</font>
<font color="black"> 252. </font>
<font color="green"> 253.     def get_urls(self):</font>
<font color="red"> 254.         from django.conf.urls import url, include</font>
<font color="black"> 255.         # Since this module gets imported in the application's root package,</font>
<font color="black"> 256.         # it cannot import models from other applications at the module level,</font>
<font color="black"> 257.         # and django.contrib.contenttypes.views imports ContentType.</font>
<font color="red"> 258.         from django.contrib.contenttypes import views as contenttype_views</font>
<font color="black"> 259. </font>
<font color="red"> 260.         if settings.DEBUG:</font>
<font color="red"> 261.             self.check_dependencies()</font>
<font color="black"> 262. </font>
<font color="red"> 263.         def wrap(view, cacheable=False):</font>
<font color="red"> 264.             def wrapper(*args, **kwargs):</font>
<font color="red"> 265.                 return self.admin_view(view, cacheable)(*args, **kwargs)</font>
<font color="red"> 266.             wrapper.admin_site = self</font>
<font color="red"> 267.             return update_wrapper(wrapper, view)</font>
<font color="black"> 268. </font>
<font color="black"> 269.         # Admin-site-wide views.</font>
<font color="black"> 270.         urlpatterns = [</font>
<font color="red"> 271.             url(r'^$', wrap(self.index), name='index'),</font>
<font color="red"> 272.             url(r'^login/$', self.login, name='login'),</font>
<font color="red"> 273.             url(r'^logout/$', wrap(self.logout), name='logout'),</font>
<font color="red"> 274.             url(r'^password_change/$', wrap(self.password_change, cacheable=True), name='password_change'),</font>
<font color="red"> 275.             url(r'^password_change/done/$', wrap(self.password_change_done, cacheable=True),</font>
<font color="red"> 276.                 name='password_change_done'),</font>
<font color="red"> 277.             url(r'^jsi18n/$', wrap(self.i18n_javascript, cacheable=True), name='jsi18n'),</font>
<font color="red"> 278.             url(r'^r/(?P&lt;content_type_id&gt;\d+)/(?P&lt;object_id&gt;.+)/$', wrap(contenttype_views.shortcut),</font>
<font color="red"> 279.                 name='view_on_site'),</font>
<font color="black"> 280.         ]</font>
<font color="black"> 281. </font>
<font color="black"> 282.         # Add in each model's views, and create a list of valid URLS for the</font>
<font color="black"> 283.         # app_index</font>
<font color="red"> 284.         valid_app_labels = []</font>
<font color="red"> 285.         for model, model_admin in self._registry.items():</font>
<font color="red"> 286.             urlpatterns += [</font>
<font color="red"> 287.                 url(r'^%s/%s/' % (model._meta.app_label, model._meta.model_name), include(model_admin.urls)),</font>
<font color="black"> 288.             ]</font>
<font color="red"> 289.             if model._meta.app_label not in valid_app_labels:</font>
<font color="red"> 290.                 valid_app_labels.append(model._meta.app_label)</font>
<font color="black"> 291. </font>
<font color="black"> 292.         # If there were ModelAdmins registered, we should have a list of app</font>
<font color="black"> 293.         # labels for which we need to allow access to the app_index view,</font>
<font color="red"> 294.         if valid_app_labels:</font>
<font color="red"> 295.             regex = r'^(?P&lt;app_label&gt;' + '|'.join(valid_app_labels) + ')/$'</font>
<font color="red"> 296.             urlpatterns += [</font>
<font color="red"> 297.                 url(regex, wrap(self.app_index), name='app_list'),</font>
<font color="black"> 298.             ]</font>
<font color="red"> 299.         return urlpatterns</font>
<font color="black"> 300. </font>
<font color="green"> 301.     @property</font>
<font color="black"> 302.     def urls(self):</font>
<font color="red"> 303.         return self.get_urls(), 'admin', self.name</font>
<font color="black"> 304. </font>
<font color="green"> 305.     def each_context(self, request):</font>
<font color="black"> 306.         &quot;&quot;&quot;</font>
<font color="black"> 307.         Returns a dictionary of variables to put in the template context for</font>
<font color="black"> 308.         *every* page in the admin site.</font>
<font color="black"> 309.         &quot;&quot;&quot;</font>
<font color="red"> 310.         return {</font>
<font color="red"> 311.             'site_title': self.site_title,</font>
<font color="red"> 312.             'site_header': self.site_header,</font>
<font color="red"> 313.             'site_url': self.site_url,</font>
<font color="red"> 314.             'has_permission': self.has_permission(request),</font>
<font color="red"> 315.             'available_apps': self.get_app_list(request),</font>
<font color="black"> 316.         }</font>
<font color="black"> 317. </font>
<font color="green"> 318.     def password_change(self, request, extra_context=None):</font>
<font color="black"> 319.         &quot;&quot;&quot;</font>
<font color="black"> 320.         Handles the &quot;change password&quot; task -- both form display and validation.</font>
<font color="black"> 321.         &quot;&quot;&quot;</font>
<font color="red"> 322.         from django.contrib.admin.forms import AdminPasswordChangeForm</font>
<font color="red"> 323.         from django.contrib.auth.views import password_change</font>
<font color="red"> 324.         url = reverse('admin:password_change_done', current_app=self.name)</font>
<font color="red"> 325.         defaults = {</font>
<font color="red"> 326.             'password_change_form': AdminPasswordChangeForm,</font>
<font color="red"> 327.             'post_change_redirect': url,</font>
<font color="red"> 328.             'extra_context': dict(self.each_context(request), **(extra_context or {})),</font>
<font color="black"> 329.         }</font>
<font color="red"> 330.         if self.password_change_template is not None:</font>
<font color="red"> 331.             defaults['template_name'] = self.password_change_template</font>
<font color="red"> 332.         request.current_app = self.name</font>
<font color="red"> 333.         return password_change(request, **defaults)</font>
<font color="black"> 334. </font>
<font color="green"> 335.     def password_change_done(self, request, extra_context=None):</font>
<font color="black"> 336.         &quot;&quot;&quot;</font>
<font color="black"> 337.         Displays the &quot;success&quot; page after a password change.</font>
<font color="black"> 338.         &quot;&quot;&quot;</font>
<font color="red"> 339.         from django.contrib.auth.views import password_change_done</font>
<font color="red"> 340.         defaults = {</font>
<font color="red"> 341.             'extra_context': dict(self.each_context(request), **(extra_context or {})),</font>
<font color="black"> 342.         }</font>
<font color="red"> 343.         if self.password_change_done_template is not None:</font>
<font color="red"> 344.             defaults['template_name'] = self.password_change_done_template</font>
<font color="red"> 345.         request.current_app = self.name</font>
<font color="red"> 346.         return password_change_done(request, **defaults)</font>
<font color="black"> 347. </font>
<font color="green"> 348.     def i18n_javascript(self, request):</font>
<font color="black"> 349.         &quot;&quot;&quot;</font>
<font color="black"> 350.         Displays the i18n JavaScript that the Django admin requires.</font>
<font color="black"> 351. </font>
<font color="black"> 352.         This takes into account the USE_I18N setting. If it's set to False, the</font>
<font color="black"> 353.         generated JavaScript will be leaner and faster.</font>
<font color="black"> 354.         &quot;&quot;&quot;</font>
<font color="red"> 355.         if settings.USE_I18N:</font>
<font color="red"> 356.             from django.views.i18n import javascript_catalog</font>
<font color="black"> 357.         else:</font>
<font color="red"> 358.             from django.views.i18n import null_javascript_catalog as javascript_catalog</font>
<font color="red"> 359.         return javascript_catalog(request, packages=['django.conf', 'django.contrib.admin'])</font>
<font color="black"> 360. </font>
<font color="green"> 361.     @never_cache</font>
<font color="green"> 362.     def logout(self, request, extra_context=None):</font>
<font color="black"> 363.         &quot;&quot;&quot;</font>
<font color="black"> 364.         Logs out the user for the given HttpRequest.</font>
<font color="black"> 365. </font>
<font color="black"> 366.         This should *not* assume the user is already logged in.</font>
<font color="black"> 367.         &quot;&quot;&quot;</font>
<font color="red"> 368.         from django.contrib.auth.views import logout</font>
<font color="red"> 369.         defaults = {</font>
<font color="red"> 370.             'extra_context': dict(self.each_context(request), **(extra_context or {})),</font>
<font color="black"> 371.         }</font>
<font color="red"> 372.         if self.logout_template is not None:</font>
<font color="red"> 373.             defaults['template_name'] = self.logout_template</font>
<font color="red"> 374.         request.current_app = self.name</font>
<font color="red"> 375.         return logout(request, **defaults)</font>
<font color="black"> 376. </font>
<font color="green"> 377.     @never_cache</font>
<font color="green"> 378.     def login(self, request, extra_context=None):</font>
<font color="black"> 379.         &quot;&quot;&quot;</font>
<font color="black"> 380.         Displays the login form for the given HttpRequest.</font>
<font color="black"> 381.         &quot;&quot;&quot;</font>
<font color="red"> 382.         if request.method == 'GET' and self.has_permission(request):</font>
<font color="black"> 383.             # Already logged-in, redirect to admin index</font>
<font color="red"> 384.             index_path = reverse('admin:index', current_app=self.name)</font>
<font color="red"> 385.             return HttpResponseRedirect(index_path)</font>
<font color="black"> 386. </font>
<font color="red"> 387.         from django.contrib.auth.views import login</font>
<font color="black"> 388.         # Since this module gets imported in the application's root package,</font>
<font color="black"> 389.         # it cannot import models from other applications at the module level,</font>
<font color="black"> 390.         # and django.contrib.admin.forms eventually imports User.</font>
<font color="red"> 391.         from django.contrib.admin.forms import AdminAuthenticationForm</font>
<font color="red"> 392.         context = dict(self.each_context(request),</font>
<font color="red"> 393.             title=_('Log in'),</font>
<font color="red"> 394.             app_path=request.get_full_path(),</font>
<font color="black"> 395.         )</font>
<font color="red"> 396.         if (REDIRECT_FIELD_NAME not in request.GET and</font>
<font color="red"> 397.                 REDIRECT_FIELD_NAME not in request.POST):</font>
<font color="red"> 398.             context[REDIRECT_FIELD_NAME] = reverse('admin:index', current_app=self.name)</font>
<font color="red"> 399.         context.update(extra_context or {})</font>
<font color="black"> 400. </font>
<font color="red"> 401.         defaults = {</font>
<font color="red"> 402.             'extra_context': context,</font>
<font color="red"> 403.             'authentication_form': self.login_form or AdminAuthenticationForm,</font>
<font color="red"> 404.             'template_name': self.login_template or 'admin/login.html',</font>
<font color="black"> 405.         }</font>
<font color="red"> 406.         request.current_app = self.name</font>
<font color="red"> 407.         return login(request, **defaults)</font>
<font color="black"> 408. </font>
<font color="green"> 409.     def _build_app_dict(self, request, label=None):</font>
<font color="black"> 410.         &quot;&quot;&quot;</font>
<font color="black"> 411.         Builds the app dictionary. Takes an optional label parameters to filter</font>
<font color="black"> 412.         models of a specific app.</font>
<font color="black"> 413.         &quot;&quot;&quot;</font>
<font color="red"> 414.         app_dict = {}</font>
<font color="black"> 415. </font>
<font color="red"> 416.         if label:</font>
<font color="black"> 417.             models = {</font>
<font color="red"> 418.                 m: m_a for m, m_a in self._registry.items()</font>
<font color="red"> 419.                 if m._meta.app_label == label</font>
<font color="black"> 420.             }</font>
<font color="black"> 421.         else:</font>
<font color="red"> 422.             models = self._registry</font>
<font color="black"> 423. </font>
<font color="red"> 424.         for model, model_admin in models.items():</font>
<font color="red"> 425.             app_label = model._meta.app_label</font>
<font color="black"> 426. </font>
<font color="red"> 427.             has_module_perms = model_admin.has_module_permission(request)</font>
<font color="red"> 428.             if not has_module_perms:</font>
<font color="red"> 429.                 if label:</font>
<font color="red"> 430.                     raise PermissionDenied</font>
<font color="red"> 431.                 continue</font>
<font color="black"> 432. </font>
<font color="red"> 433.             perms = model_admin.get_model_perms(request)</font>
<font color="black"> 434. </font>
<font color="black"> 435.             # Check whether user has any perm for this module.</font>
<font color="black"> 436.             # If so, add the module to the model_list.</font>
<font color="red"> 437.             if True not in perms.values():</font>
<font color="red"> 438.                 continue</font>
<font color="black"> 439. </font>
<font color="red"> 440.             info = (app_label, model._meta.model_name)</font>
<font color="red"> 441.             model_dict = {</font>
<font color="red"> 442.                 'name': capfirst(model._meta.verbose_name_plural),</font>
<font color="red"> 443.                 'object_name': model._meta.object_name,</font>
<font color="red"> 444.                 'perms': perms,</font>
<font color="black"> 445.             }</font>
<font color="red"> 446.             if perms.get('change'):</font>
<font color="red"> 447.                 try:</font>
<font color="red"> 448.                     model_dict['admin_url'] = reverse('admin:%s_%s_changelist' % info, current_app=self.name)</font>
<font color="red"> 449.                 except NoReverseMatch:</font>
<font color="red"> 450.                     pass</font>
<font color="red"> 451.             if perms.get('add'):</font>
<font color="red"> 452.                 try:</font>
<font color="red"> 453.                     model_dict['add_url'] = reverse('admin:%s_%s_add' % info, current_app=self.name)</font>
<font color="red"> 454.                 except NoReverseMatch:</font>
<font color="red"> 455.                     pass</font>
<font color="black"> 456. </font>
<font color="red"> 457.             if app_label in app_dict:</font>
<font color="red"> 458.                 app_dict[app_label]['models'].append(model_dict)</font>
<font color="black"> 459.             else:</font>
<font color="red"> 460.                 app_dict[app_label] = {</font>
<font color="red"> 461.                     'name': apps.get_app_config(app_label).verbose_name,</font>
<font color="red"> 462.                     'app_label': app_label,</font>
<font color="red"> 463.                     'app_url': reverse(</font>
<font color="red"> 464.                         'admin:app_list',</font>
<font color="red"> 465.                         kwargs={'app_label': app_label},</font>
<font color="red"> 466.                         current_app=self.name,</font>
<font color="black"> 467.                     ),</font>
<font color="red"> 468.                     'has_module_perms': has_module_perms,</font>
<font color="red"> 469.                     'models': [model_dict],</font>
<font color="black"> 470.                 }</font>
<font color="black"> 471. </font>
<font color="red"> 472.         if label:</font>
<font color="red"> 473.             return app_dict.get(label)</font>
<font color="red"> 474.         return app_dict</font>
<font color="black"> 475. </font>
<font color="green"> 476.     def get_app_list(self, request):</font>
<font color="black"> 477.         &quot;&quot;&quot;</font>
<font color="black"> 478.         Returns a sorted list of all the installed apps that have been</font>
<font color="black"> 479.         registered in this site.</font>
<font color="black"> 480.         &quot;&quot;&quot;</font>
<font color="red"> 481.         app_dict = self._build_app_dict(request)</font>
<font color="black"> 482. </font>
<font color="black"> 483.         # Sort the apps alphabetically.</font>
<font color="red"> 484.         app_list = sorted(app_dict.values(), key=lambda x: x['name'].lower())</font>
<font color="black"> 485. </font>
<font color="black"> 486.         # Sort the models alphabetically within each app.</font>
<font color="red"> 487.         for app in app_list:</font>
<font color="red"> 488.             app['models'].sort(key=lambda x: x['name'])</font>
<font color="black"> 489. </font>
<font color="red"> 490.         return app_list</font>
<font color="black"> 491. </font>
<font color="green"> 492.     @never_cache</font>
<font color="green"> 493.     def index(self, request, extra_context=None):</font>
<font color="black"> 494.         &quot;&quot;&quot;</font>
<font color="black"> 495.         Displays the main admin index page, which lists all of the installed</font>
<font color="black"> 496.         apps that have been registered in this site.</font>
<font color="black"> 497.         &quot;&quot;&quot;</font>
<font color="red"> 498.         app_list = self.get_app_list(request)</font>
<font color="black"> 499. </font>
<font color="red"> 500.         context = dict(</font>
<font color="red"> 501.             self.each_context(request),</font>
<font color="red"> 502.             title=self.index_title,</font>
<font color="red"> 503.             app_list=app_list,</font>
<font color="black"> 504.         )</font>
<font color="red"> 505.         context.update(extra_context or {})</font>
<font color="black"> 506. </font>
<font color="red"> 507.         request.current_app = self.name</font>
<font color="black"> 508. </font>
<font color="red"> 509.         return TemplateResponse(request, self.index_template or</font>
<font color="red"> 510.                                 'admin/index.html', context)</font>
<font color="black"> 511. </font>
<font color="green"> 512.     def app_index(self, request, app_label, extra_context=None):</font>
<font color="red"> 513.         app_dict = self._build_app_dict(request, app_label)</font>
<font color="red"> 514.         if not app_dict:</font>
<font color="red"> 515.             raise Http404('The requested admin page does not exist.')</font>
<font color="black"> 516.         # Sort the models alphabetically within each app.</font>
<font color="red"> 517.         app_dict['models'].sort(key=lambda x: x['name'])</font>
<font color="red"> 518.         app_name = apps.get_app_config(app_label).verbose_name</font>
<font color="red"> 519.         context = dict(self.each_context(request),</font>
<font color="red"> 520.             title=_('%(app)s administration') % {'app': app_name},</font>
<font color="red"> 521.             app_list=[app_dict],</font>
<font color="red"> 522.             app_label=app_label,</font>
<font color="black"> 523.         )</font>
<font color="red"> 524.         context.update(extra_context or {})</font>
<font color="black"> 525. </font>
<font color="red"> 526.         request.current_app = self.name</font>
<font color="black"> 527. </font>
<font color="red"> 528.         return TemplateResponse(request, self.app_index_template or [</font>
<font color="red"> 529.             'admin/%s/app_index.html' % app_label,</font>
<font color="red"> 530.             'admin/app_index.html'</font>
<font color="red"> 531.         ], context)</font>
<font color="black"> 532. </font>
<font color="black"> 533. # This global object represents the default admin site, for the common case.</font>
<font color="black"> 534. # You can instantiate AdminSite in your own code to create a custom admin site.</font>
<font color="green"> 535. site = AdminSite()</font>
</pre>


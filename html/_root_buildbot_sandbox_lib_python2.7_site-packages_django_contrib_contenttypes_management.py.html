source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/contenttypes/management.py</b><br>


file stats: <b>46 lines, 25 executed: 54.3% covered</b>
<pre>
<font color="green">   1. from django.apps import apps</font>
<font color="green">   2. from django.db import DEFAULT_DB_ALIAS, router</font>
<font color="green">   3. from django.utils import six</font>
<font color="green">   4. from django.utils.six.moves import input</font>
<font color="black">   5. </font>
<font color="black">   6. </font>
<font color="green">   7. def update_contenttypes(app_config, verbosity=2, interactive=True, using=DEFAULT_DB_ALIAS, **kwargs):</font>
<font color="black">   8.     &quot;&quot;&quot;</font>
<font color="black">   9.     Creates content types for models in the given app, removing any model</font>
<font color="black">  10.     entries that no longer have a matching model class.</font>
<font color="black">  11.     &quot;&quot;&quot;</font>
<font color="green">  12.     if not app_config.models_module:</font>
<font color="red">  13.         return</font>
<font color="black">  14. </font>
<font color="green">  15.     try:</font>
<font color="green">  16.         ContentType = apps.get_model('contenttypes', 'ContentType')</font>
<font color="red">  17.     except LookupError:</font>
<font color="red">  18.         return</font>
<font color="black">  19. </font>
<font color="green">  20.     if not router.allow_migrate_model(using, ContentType):</font>
<font color="red">  21.         return</font>
<font color="black">  22. </font>
<font color="green">  23.     ContentType.objects.clear_cache()</font>
<font color="black">  24. </font>
<font color="green">  25.     app_label = app_config.label</font>
<font color="black">  26. </font>
<font color="black">  27.     app_models = {</font>
<font color="green">  28.         model._meta.model_name: model</font>
<font color="green">  29.         for model in app_config.get_models()}</font>
<font color="black">  30. </font>
<font color="green">  31.     if not app_models:</font>
<font color="red">  32.         return</font>
<font color="black">  33. </font>
<font color="black">  34.     # Get all the content types</font>
<font color="black">  35.     content_types = {</font>
<font color="green">  36.         ct.model: ct</font>
<font color="green">  37.         for ct in ContentType.objects.using(using).filter(app_label=app_label)</font>
<font color="black">  38.     }</font>
<font color="black">  39.     to_remove = [</font>
<font color="green">  40.         ct</font>
<font color="green">  41.         for (model_name, ct) in six.iteritems(content_types)</font>
<font color="green">  42.         if model_name not in app_models</font>
<font color="black">  43.     ]</font>
<font color="black">  44. </font>
<font color="black">  45.     cts = [</font>
<font color="green">  46.         ContentType(</font>
<font color="black">  47.             app_label=app_label,</font>
<font color="black">  48.             model=model_name,</font>
<font color="black">  49.         )</font>
<font color="green">  50.         for (model_name, model) in six.iteritems(app_models)</font>
<font color="green">  51.         if model_name not in content_types</font>
<font color="black">  52.     ]</font>
<font color="green">  53.     ContentType.objects.using(using).bulk_create(cts)</font>
<font color="green">  54.     if verbosity &gt;= 2:</font>
<font color="red">  55.         for ct in cts:</font>
<font color="red">  56.             print(&quot;Adding content type '%s | %s'&quot; % (ct.app_label, ct.model))</font>
<font color="black">  57. </font>
<font color="black">  58.     # Confirm that the content type is stale before deletion.</font>
<font color="green">  59.     if to_remove:</font>
<font color="red">  60.         if interactive:</font>
<font color="red">  61.             content_type_display = '\n'.join(</font>
<font color="red">  62.                 '    %s | %s' % (ct.app_label, ct.model)</font>
<font color="red">  63.                 for ct in to_remove</font>
<font color="black">  64.             )</font>
<font color="red">  65.             ok_to_delete = input(&quot;&quot;&quot;The following content types are stale and need to be deleted:</font>
<font color="black">  66. </font>
<font color="black">  67. %s</font>
<font color="black">  68. </font>
<font color="black">  69. Any objects related to these content types by a foreign key will also</font>
<font color="black">  70. be deleted. Are you sure you want to delete these content types?</font>
<font color="black">  71. If you're unsure, answer 'no'.</font>
<font color="black">  72. </font>
<font color="red">  73.     Type 'yes' to continue, or 'no' to cancel: &quot;&quot;&quot; % content_type_display)</font>
<font color="black">  74.         else:</font>
<font color="red">  75.             ok_to_delete = False</font>
<font color="black">  76. </font>
<font color="red">  77.         if ok_to_delete == 'yes':</font>
<font color="red">  78.             for ct in to_remove:</font>
<font color="red">  79.                 if verbosity &gt;= 2:</font>
<font color="red">  80.                     print(&quot;Deleting stale content type '%s | %s'&quot; % (ct.app_label, ct.model))</font>
<font color="red">  81.                 ct.delete()</font>
<font color="black">  82.         else:</font>
<font color="red">  83.             if verbosity &gt;= 2:</font>
<font color="red">  84.                 print(&quot;Stale content types remain.&quot;)</font>
</pre>


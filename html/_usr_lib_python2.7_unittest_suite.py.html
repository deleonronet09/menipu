source file: <b>/usr/lib/python2.7/unittest/suite.py</b><br>


file stats: <b>215 lines, 132 executed: 61.4% covered</b>
<pre>
<font color="green">   1. &quot;&quot;&quot;TestSuite&quot;&quot;&quot;</font>
<font color="black">   2. </font>
<font color="green">   3. import sys</font>
<font color="black">   4. </font>
<font color="green">   5. from . import case</font>
<font color="green">   6. from . import util</font>
<font color="black">   7. </font>
<font color="green">   8. __unittest = True</font>
<font color="black">   9. </font>
<font color="black">  10. </font>
<font color="green">  11. def _call_if_exists(parent, attr):</font>
<font color="green">  12.     func = getattr(parent, attr, lambda: None)</font>
<font color="green">  13.     func()</font>
<font color="black">  14. </font>
<font color="black">  15. </font>
<font color="green">  16. class BaseTestSuite(object):</font>
<font color="black">  17.     &quot;&quot;&quot;A simple test suite that doesn't provide class or module shared fixtures.</font>
<font color="green">  18.     &quot;&quot;&quot;</font>
<font color="green">  19.     def __init__(self, tests=()):</font>
<font color="green">  20.         self._tests = []</font>
<font color="green">  21.         self.addTests(tests)</font>
<font color="black">  22. </font>
<font color="green">  23.     def __repr__(self):</font>
<font color="red">  24.         return &quot;&lt;%s tests=%s&gt;&quot; % (util.strclass(self.__class__), list(self))</font>
<font color="black">  25. </font>
<font color="green">  26.     def __eq__(self, other):</font>
<font color="red">  27.         if not isinstance(other, self.__class__):</font>
<font color="red">  28.             return NotImplemented</font>
<font color="red">  29.         return list(self) == list(other)</font>
<font color="black">  30. </font>
<font color="green">  31.     def __ne__(self, other):</font>
<font color="red">  32.         return not self == other</font>
<font color="black">  33. </font>
<font color="black">  34.     # Can't guarantee hash invariant, so flag as unhashable</font>
<font color="green">  35.     __hash__ = None</font>
<font color="black">  36. </font>
<font color="green">  37.     def __iter__(self):</font>
<font color="green">  38.         return iter(self._tests)</font>
<font color="black">  39. </font>
<font color="green">  40.     def countTestCases(self):</font>
<font color="red">  41.         cases = 0</font>
<font color="red">  42.         for test in self:</font>
<font color="red">  43.             cases += test.countTestCases()</font>
<font color="red">  44.         return cases</font>
<font color="black">  45. </font>
<font color="green">  46.     def addTest(self, test):</font>
<font color="black">  47.         # sanity checks</font>
<font color="green">  48.         if not hasattr(test, '__call__'):</font>
<font color="red">  49.             raise TypeError(&quot;{} is not callable&quot;.format(repr(test)))</font>
<font color="green">  50.         if isinstance(test, type) and issubclass(test,</font>
<font color="red">  51.                                                  (case.TestCase, TestSuite)):</font>
<font color="red">  52.             raise TypeError(&quot;TestCases and TestSuites must be instantiated &quot;</font>
<font color="black">  53.                             &quot;before passing them to addTest()&quot;)</font>
<font color="green">  54.         self._tests.append(test)</font>
<font color="black">  55. </font>
<font color="green">  56.     def addTests(self, tests):</font>
<font color="green">  57.         if isinstance(tests, basestring):</font>
<font color="red">  58.             raise TypeError(&quot;tests must be an iterable of tests, not a string&quot;)</font>
<font color="green">  59.         for test in tests:</font>
<font color="green">  60.             self.addTest(test)</font>
<font color="black">  61. </font>
<font color="green">  62.     def run(self, result):</font>
<font color="red">  63.         for test in self:</font>
<font color="red">  64.             if result.shouldStop:</font>
<font color="red">  65.                 break</font>
<font color="red">  66.             test(result)</font>
<font color="red">  67.         return result</font>
<font color="black">  68. </font>
<font color="green">  69.     def __call__(self, *args, **kwds):</font>
<font color="green">  70.         return self.run(*args, **kwds)</font>
<font color="black">  71. </font>
<font color="green">  72.     def debug(self):</font>
<font color="black">  73.         &quot;&quot;&quot;Run the tests without collecting errors in a TestResult&quot;&quot;&quot;</font>
<font color="red">  74.         for test in self:</font>
<font color="red">  75.             test.debug()</font>
<font color="black">  76. </font>
<font color="black">  77. </font>
<font color="green">  78. class TestSuite(BaseTestSuite):</font>
<font color="black">  79.     &quot;&quot;&quot;A test suite is a composite test consisting of a number of TestCases.</font>
<font color="black">  80. </font>
<font color="black">  81.     For use, create an instance of TestSuite, then add test case instances.</font>
<font color="black">  82.     When all tests have been added, the suite can be passed to a test</font>
<font color="black">  83.     runner, such as TextTestRunner. It will run the individual test cases</font>
<font color="black">  84.     in the order in which they were added, aggregating the results. When</font>
<font color="black">  85.     subclassing, do not forget to call the base class constructor.</font>
<font color="green">  86.     &quot;&quot;&quot;</font>
<font color="black">  87. </font>
<font color="green">  88.     def run(self, result, debug=False):</font>
<font color="green">  89.         topLevel = False</font>
<font color="green">  90.         if getattr(result, '_testRunEntered', False) is False:</font>
<font color="green">  91.             result._testRunEntered = topLevel = True</font>
<font color="black">  92. </font>
<font color="green">  93.         for test in self:</font>
<font color="green">  94.             if result.shouldStop:</font>
<font color="red">  95.                 break</font>
<font color="black">  96. </font>
<font color="green">  97.             if _isnotsuite(test):</font>
<font color="green">  98.                 self._tearDownPreviousClass(test, result)</font>
<font color="green">  99.                 self._handleModuleFixture(test, result)</font>
<font color="green"> 100.                 self._handleClassSetUp(test, result)</font>
<font color="green"> 101.                 result._previousTestClass = test.__class__</font>
<font color="black"> 102. </font>
<font color="green"> 103.                 if (getattr(test.__class__, '_classSetupFailed', False) or</font>
<font color="green"> 104.                     getattr(result, '_moduleSetUpFailed', False)):</font>
<font color="red"> 105.                     continue</font>
<font color="black"> 106. </font>
<font color="green"> 107.             if not debug:</font>
<font color="green"> 108.                 test(result)</font>
<font color="black"> 109.             else:</font>
<font color="red"> 110.                 test.debug()</font>
<font color="black"> 111. </font>
<font color="green"> 112.         if topLevel:</font>
<font color="green"> 113.             self._tearDownPreviousClass(None, result)</font>
<font color="green"> 114.             self._handleModuleTearDown(result)</font>
<font color="green"> 115.             result._testRunEntered = False</font>
<font color="green"> 116.         return result</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def debug(self):</font>
<font color="black"> 119.         &quot;&quot;&quot;Run the tests without collecting errors in a TestResult&quot;&quot;&quot;</font>
<font color="red"> 120.         debug = _DebugResult()</font>
<font color="red"> 121.         self.run(debug, True)</font>
<font color="black"> 122. </font>
<font color="black"> 123.     ################################</font>
<font color="black"> 124. </font>
<font color="green"> 125.     def _handleClassSetUp(self, test, result):</font>
<font color="green"> 126.         previousClass = getattr(result, '_previousTestClass', None)</font>
<font color="green"> 127.         currentClass = test.__class__</font>
<font color="green"> 128.         if currentClass == previousClass:</font>
<font color="green"> 129.             return</font>
<font color="green"> 130.         if result._moduleSetUpFailed:</font>
<font color="red"> 131.             return</font>
<font color="green"> 132.         if getattr(currentClass, &quot;__unittest_skip__&quot;, False):</font>
<font color="red"> 133.             return</font>
<font color="black"> 134. </font>
<font color="green"> 135.         try:</font>
<font color="green"> 136.             currentClass._classSetupFailed = False</font>
<font color="red"> 137.         except TypeError:</font>
<font color="black"> 138.             # test may actually be a function</font>
<font color="black"> 139.             # so its class will be a builtin-type</font>
<font color="red"> 140.             pass</font>
<font color="black"> 141. </font>
<font color="green"> 142.         setUpClass = getattr(currentClass, 'setUpClass', None)</font>
<font color="green"> 143.         if setUpClass is not None:</font>
<font color="green"> 144.             _call_if_exists(result, '_setupStdout')</font>
<font color="green"> 145.             try:</font>
<font color="green"> 146.                 setUpClass()</font>
<font color="red"> 147.             except Exception as e:</font>
<font color="red"> 148.                 if isinstance(result, _DebugResult):</font>
<font color="red"> 149.                     raise</font>
<font color="red"> 150.                 currentClass._classSetupFailed = True</font>
<font color="red"> 151.                 className = util.strclass(currentClass)</font>
<font color="red"> 152.                 errorName = 'setUpClass (%s)' % className</font>
<font color="red"> 153.                 self._addClassOrModuleLevelException(result, e, errorName)</font>
<font color="black"> 154.             finally:</font>
<font color="green"> 155.                 _call_if_exists(result, '_restoreStdout')</font>
<font color="black"> 156. </font>
<font color="green"> 157.     def _get_previous_module(self, result):</font>
<font color="green"> 158.         previousModule = None</font>
<font color="green"> 159.         previousClass = getattr(result, '_previousTestClass', None)</font>
<font color="green"> 160.         if previousClass is not None:</font>
<font color="green"> 161.             previousModule = previousClass.__module__</font>
<font color="green"> 162.         return previousModule</font>
<font color="black"> 163. </font>
<font color="black"> 164. </font>
<font color="green"> 165.     def _handleModuleFixture(self, test, result):</font>
<font color="green"> 166.         previousModule = self._get_previous_module(result)</font>
<font color="green"> 167.         currentModule = test.__class__.__module__</font>
<font color="green"> 168.         if currentModule == previousModule:</font>
<font color="green"> 169.             return</font>
<font color="black"> 170. </font>
<font color="green"> 171.         self._handleModuleTearDown(result)</font>
<font color="black"> 172. </font>
<font color="green"> 173.         result._moduleSetUpFailed = False</font>
<font color="green"> 174.         try:</font>
<font color="green"> 175.             module = sys.modules[currentModule]</font>
<font color="red"> 176.         except KeyError:</font>
<font color="red"> 177.             return</font>
<font color="green"> 178.         setUpModule = getattr(module, 'setUpModule', None)</font>
<font color="green"> 179.         if setUpModule is not None:</font>
<font color="red"> 180.             _call_if_exists(result, '_setupStdout')</font>
<font color="red"> 181.             try:</font>
<font color="red"> 182.                 setUpModule()</font>
<font color="red"> 183.             except Exception, e:</font>
<font color="red"> 184.                 if isinstance(result, _DebugResult):</font>
<font color="red"> 185.                     raise</font>
<font color="red"> 186.                 result._moduleSetUpFailed = True</font>
<font color="red"> 187.                 errorName = 'setUpModule (%s)' % currentModule</font>
<font color="red"> 188.                 self._addClassOrModuleLevelException(result, e, errorName)</font>
<font color="black"> 189.             finally:</font>
<font color="red"> 190.                 _call_if_exists(result, '_restoreStdout')</font>
<font color="black"> 191. </font>
<font color="green"> 192.     def _addClassOrModuleLevelException(self, result, exception, errorName):</font>
<font color="red"> 193.         error = _ErrorHolder(errorName)</font>
<font color="red"> 194.         addSkip = getattr(result, 'addSkip', None)</font>
<font color="red"> 195.         if addSkip is not None and isinstance(exception, case.SkipTest):</font>
<font color="red"> 196.             addSkip(error, str(exception))</font>
<font color="black"> 197.         else:</font>
<font color="red"> 198.             result.addError(error, sys.exc_info())</font>
<font color="black"> 199. </font>
<font color="green"> 200.     def _handleModuleTearDown(self, result):</font>
<font color="green"> 201.         previousModule = self._get_previous_module(result)</font>
<font color="green"> 202.         if previousModule is None:</font>
<font color="green"> 203.             return</font>
<font color="green"> 204.         if result._moduleSetUpFailed:</font>
<font color="red"> 205.             return</font>
<font color="black"> 206. </font>
<font color="green"> 207.         try:</font>
<font color="green"> 208.             module = sys.modules[previousModule]</font>
<font color="red"> 209.         except KeyError:</font>
<font color="red"> 210.             return</font>
<font color="black"> 211. </font>
<font color="green"> 212.         tearDownModule = getattr(module, 'tearDownModule', None)</font>
<font color="green"> 213.         if tearDownModule is not None:</font>
<font color="red"> 214.             _call_if_exists(result, '_setupStdout')</font>
<font color="red"> 215.             try:</font>
<font color="red"> 216.                 tearDownModule()</font>
<font color="red"> 217.             except Exception as e:</font>
<font color="red"> 218.                 if isinstance(result, _DebugResult):</font>
<font color="red"> 219.                     raise</font>
<font color="red"> 220.                 errorName = 'tearDownModule (%s)' % previousModule</font>
<font color="red"> 221.                 self._addClassOrModuleLevelException(result, e, errorName)</font>
<font color="black"> 222.             finally:</font>
<font color="red"> 223.                 _call_if_exists(result, '_restoreStdout')</font>
<font color="black"> 224. </font>
<font color="green"> 225.     def _tearDownPreviousClass(self, test, result):</font>
<font color="green"> 226.         previousClass = getattr(result, '_previousTestClass', None)</font>
<font color="green"> 227.         currentClass = test.__class__</font>
<font color="green"> 228.         if currentClass == previousClass:</font>
<font color="green"> 229.             return</font>
<font color="green"> 230.         if getattr(previousClass, '_classSetupFailed', False):</font>
<font color="red"> 231.             return</font>
<font color="green"> 232.         if getattr(result, '_moduleSetUpFailed', False):</font>
<font color="red"> 233.             return</font>
<font color="green"> 234.         if getattr(previousClass, &quot;__unittest_skip__&quot;, False):</font>
<font color="red"> 235.             return</font>
<font color="black"> 236. </font>
<font color="green"> 237.         tearDownClass = getattr(previousClass, 'tearDownClass', None)</font>
<font color="green"> 238.         if tearDownClass is not None:</font>
<font color="green"> 239.             _call_if_exists(result, '_setupStdout')</font>
<font color="green"> 240.             try:</font>
<font color="green"> 241.                 tearDownClass()</font>
<font color="red"> 242.             except Exception, e:</font>
<font color="red"> 243.                 if isinstance(result, _DebugResult):</font>
<font color="red"> 244.                     raise</font>
<font color="red"> 245.                 className = util.strclass(previousClass)</font>
<font color="red"> 246.                 errorName = 'tearDownClass (%s)' % className</font>
<font color="red"> 247.                 self._addClassOrModuleLevelException(result, e, errorName)</font>
<font color="black"> 248.             finally:</font>
<font color="green"> 249.                 _call_if_exists(result, '_restoreStdout')</font>
<font color="black"> 250. </font>
<font color="black"> 251. </font>
<font color="green"> 252. class _ErrorHolder(object):</font>
<font color="black"> 253.     &quot;&quot;&quot;</font>
<font color="black"> 254.     Placeholder for a TestCase inside a result. As far as a TestResult</font>
<font color="black"> 255.     is concerned, this looks exactly like a unit test. Used to insert</font>
<font color="black"> 256.     arbitrary errors into a test suite run.</font>
<font color="green"> 257.     &quot;&quot;&quot;</font>
<font color="black"> 258.     # Inspired by the ErrorHolder from Twisted:</font>
<font color="black"> 259.     # http://twistedmatrix.com/trac/browser/trunk/twisted/trial/runner.py</font>
<font color="black"> 260. </font>
<font color="black"> 261.     # attribute used by TestResult._exc_info_to_string</font>
<font color="green"> 262.     failureException = None</font>
<font color="black"> 263. </font>
<font color="green"> 264.     def __init__(self, description):</font>
<font color="red"> 265.         self.description = description</font>
<font color="black"> 266. </font>
<font color="green"> 267.     def id(self):</font>
<font color="red"> 268.         return self.description</font>
<font color="black"> 269. </font>
<font color="green"> 270.     def shortDescription(self):</font>
<font color="red"> 271.         return None</font>
<font color="black"> 272. </font>
<font color="green"> 273.     def __repr__(self):</font>
<font color="red"> 274.         return &quot;&lt;ErrorHolder description=%r&gt;&quot; % (self.description,)</font>
<font color="black"> 275. </font>
<font color="green"> 276.     def __str__(self):</font>
<font color="red"> 277.         return self.id()</font>
<font color="black"> 278. </font>
<font color="green"> 279.     def run(self, result):</font>
<font color="black"> 280.         # could call result.addError(...) - but this test-like object</font>
<font color="black"> 281.         # shouldn't be run anyway</font>
<font color="red"> 282.         pass</font>
<font color="black"> 283. </font>
<font color="green"> 284.     def __call__(self, result):</font>
<font color="red"> 285.         return self.run(result)</font>
<font color="black"> 286. </font>
<font color="green"> 287.     def countTestCases(self):</font>
<font color="red"> 288.         return 0</font>
<font color="black"> 289. </font>
<font color="green"> 290. def _isnotsuite(test):</font>
<font color="black"> 291.     &quot;A crude way to tell apart testcases and suites with duck-typing&quot;</font>
<font color="green"> 292.     try:</font>
<font color="green"> 293.         iter(test)</font>
<font color="green"> 294.     except TypeError:</font>
<font color="green"> 295.         return True</font>
<font color="red"> 296.     return False</font>
<font color="black"> 297. </font>
<font color="black"> 298. </font>
<font color="green"> 299. class _DebugResult(object):</font>
<font color="green"> 300.     &quot;Used by the TestSuite to hold previous class when running in debug.&quot;</font>
<font color="green"> 301.     _previousTestClass = None</font>
<font color="green"> 302.     _moduleSetUpFailed = False</font>
<font color="green"> 303.     shouldStop = False</font>
</pre>


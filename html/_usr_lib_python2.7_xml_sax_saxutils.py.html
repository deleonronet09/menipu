source file: <b>/usr/lib/python2.7/xml/sax/saxutils.py</b><br>


file stats: <b>217 lines, 58 executed: 26.7% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;\</font>
<font color="black">   2. A library of useful helper classes to the SAX classes, for the</font>
<font color="black">   3. convenience of application and driver writers.</font>
<font color="green">   4. &quot;&quot;&quot;</font>
<font color="black">   5. </font>
<font color="green">   6. import os, urlparse, urllib, types</font>
<font color="green">   7. import io</font>
<font color="green">   8. import sys</font>
<font color="green">   9. import handler</font>
<font color="green">  10. import xmlreader</font>
<font color="black">  11. </font>
<font color="green">  12. try:</font>
<font color="green">  13.     _StringTypes = [types.StringType, types.UnicodeType]</font>
<font color="red">  14. except AttributeError:</font>
<font color="red">  15.     _StringTypes = [types.StringType]</font>
<font color="black">  16. </font>
<font color="green">  17. def __dict_replace(s, d):</font>
<font color="black">  18.     &quot;&quot;&quot;Replace substrings of a string using a dictionary.&quot;&quot;&quot;</font>
<font color="red">  19.     for key, value in d.items():</font>
<font color="red">  20.         s = s.replace(key, value)</font>
<font color="red">  21.     return s</font>
<font color="black">  22. </font>
<font color="green">  23. def escape(data, entities={}):</font>
<font color="black">  24.     &quot;&quot;&quot;Escape &amp;, &lt;, and &gt; in a string of data.</font>
<font color="black">  25. </font>
<font color="black">  26.     You can escape other strings of data by passing a dictionary as</font>
<font color="black">  27.     the optional entities parameter.  The keys and values must all be</font>
<font color="black">  28.     strings; each key will be replaced with its corresponding value.</font>
<font color="black">  29.     &quot;&quot;&quot;</font>
<font color="black">  30. </font>
<font color="black">  31.     # must do ampersand first</font>
<font color="red">  32.     data = data.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)</font>
<font color="red">  33.     data = data.replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)</font>
<font color="red">  34.     data = data.replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)</font>
<font color="red">  35.     if entities:</font>
<font color="red">  36.         data = __dict_replace(data, entities)</font>
<font color="red">  37.     return data</font>
<font color="black">  38. </font>
<font color="green">  39. def unescape(data, entities={}):</font>
<font color="black">  40.     &quot;&quot;&quot;Unescape &amp;amp;, &amp;lt;, and &amp;gt; in a string of data.</font>
<font color="black">  41. </font>
<font color="black">  42.     You can unescape other strings of data by passing a dictionary as</font>
<font color="black">  43.     the optional entities parameter.  The keys and values must all be</font>
<font color="black">  44.     strings; each key will be replaced with its corresponding value.</font>
<font color="black">  45.     &quot;&quot;&quot;</font>
<font color="red">  46.     data = data.replace(&quot;&amp;lt;&quot;, &quot;&lt;&quot;)</font>
<font color="red">  47.     data = data.replace(&quot;&amp;gt;&quot;, &quot;&gt;&quot;)</font>
<font color="red">  48.     if entities:</font>
<font color="red">  49.         data = __dict_replace(data, entities)</font>
<font color="black">  50.     # must do ampersand last</font>
<font color="red">  51.     return data.replace(&quot;&amp;amp;&quot;, &quot;&amp;&quot;)</font>
<font color="black">  52. </font>
<font color="green">  53. def quoteattr(data, entities={}):</font>
<font color="black">  54.     &quot;&quot;&quot;Escape and quote an attribute value.</font>
<font color="black">  55. </font>
<font color="black">  56.     Escape &amp;, &lt;, and &gt; in a string of data, then quote it for use as</font>
<font color="black">  57.     an attribute value.  The \&quot; character will be escaped as well, if</font>
<font color="black">  58.     necessary.</font>
<font color="black">  59. </font>
<font color="black">  60.     You can escape other strings of data by passing a dictionary as</font>
<font color="black">  61.     the optional entities parameter.  The keys and values must all be</font>
<font color="black">  62.     strings; each key will be replaced with its corresponding value.</font>
<font color="black">  63.     &quot;&quot;&quot;</font>
<font color="red">  64.     entities = entities.copy()</font>
<font color="red">  65.     entities.update({'\n': '&amp;#10;', '\r': '&amp;#13;', '\t':'&amp;#9;'})</font>
<font color="red">  66.     data = escape(data, entities)</font>
<font color="red">  67.     if '&quot;' in data:</font>
<font color="red">  68.         if &quot;'&quot; in data:</font>
<font color="red">  69.             data = '&quot;%s&quot;' % data.replace('&quot;', &quot;&amp;quot;&quot;)</font>
<font color="black">  70.         else:</font>
<font color="red">  71.             data = &quot;'%s'&quot; % data</font>
<font color="black">  72.     else:</font>
<font color="red">  73.         data = '&quot;%s&quot;' % data</font>
<font color="red">  74.     return data</font>
<font color="black">  75. </font>
<font color="black">  76. </font>
<font color="green">  77. def _gettextwriter(out, encoding):</font>
<font color="red">  78.     if out is None:</font>
<font color="red">  79.         import sys</font>
<font color="red">  80.         out = sys.stdout</font>
<font color="black">  81. </font>
<font color="red">  82.     if isinstance(out, io.RawIOBase):</font>
<font color="red">  83.         buffer = io.BufferedIOBase(out)</font>
<font color="black">  84.         # Keep the original file open when the TextIOWrapper is</font>
<font color="black">  85.         # destroyed</font>
<font color="red">  86.         buffer.close = lambda: None</font>
<font color="black">  87.     else:</font>
<font color="black">  88.         # This is to handle passed objects that aren't in the</font>
<font color="black">  89.         # IOBase hierarchy, but just have a write method</font>
<font color="red">  90.         buffer = io.BufferedIOBase()</font>
<font color="red">  91.         buffer.writable = lambda: True</font>
<font color="red">  92.         buffer.write = out.write</font>
<font color="red">  93.         try:</font>
<font color="black">  94.             # TextIOWrapper uses this methods to determine</font>
<font color="black">  95.             # if BOM (for UTF-16, etc) should be added</font>
<font color="red">  96.             buffer.seekable = out.seekable</font>
<font color="red">  97.             buffer.tell = out.tell</font>
<font color="red">  98.         except AttributeError:</font>
<font color="red">  99.             pass</font>
<font color="black"> 100.     # wrap a binary writer with TextIOWrapper</font>
<font color="red"> 101.     class UnbufferedTextIOWrapper(io.TextIOWrapper):</font>
<font color="red"> 102.         def write(self, s):</font>
<font color="red"> 103.             super(UnbufferedTextIOWrapper, self).write(s)</font>
<font color="red"> 104.             self.flush()</font>
<font color="red"> 105.     return UnbufferedTextIOWrapper(buffer, encoding=encoding,</font>
<font color="red"> 106.                                    errors='xmlcharrefreplace',</font>
<font color="red"> 107.                                    newline='\n')</font>
<font color="black"> 108. </font>
<font color="green"> 109. class XMLGenerator(handler.ContentHandler):</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def __init__(self, out=None, encoding=&quot;iso-8859-1&quot;):</font>
<font color="red"> 112.         handler.ContentHandler.__init__(self)</font>
<font color="red"> 113.         out = _gettextwriter(out, encoding)</font>
<font color="red"> 114.         self._write = out.write</font>
<font color="red"> 115.         self._flush = out.flush</font>
<font color="red"> 116.         self._ns_contexts = [{}] # contains uri -&gt; prefix dicts</font>
<font color="red"> 117.         self._current_context = self._ns_contexts[-1]</font>
<font color="red"> 118.         self._undeclared_ns_maps = []</font>
<font color="red"> 119.         self._encoding = encoding</font>
<font color="black"> 120. </font>
<font color="green"> 121.     def _qname(self, name):</font>
<font color="black"> 122.         &quot;&quot;&quot;Builds a qualified name from a (ns_url, localname) pair&quot;&quot;&quot;</font>
<font color="red"> 123.         if name[0]:</font>
<font color="black"> 124.             # Per http://www.w3.org/XML/1998/namespace, The 'xml' prefix is</font>
<font color="black"> 125.             # bound by definition to http://www.w3.org/XML/1998/namespace.  It</font>
<font color="black"> 126.             # does not need to be declared and will not usually be found in</font>
<font color="black"> 127.             # self._current_context.</font>
<font color="red"> 128.             if 'http://www.w3.org/XML/1998/namespace' == name[0]:</font>
<font color="red"> 129.                 return 'xml:' + name[1]</font>
<font color="black"> 130.             # The name is in a non-empty namespace</font>
<font color="red"> 131.             prefix = self._current_context[name[0]]</font>
<font color="red"> 132.             if prefix:</font>
<font color="black"> 133.                 # If it is not the default namespace, prepend the prefix</font>
<font color="red"> 134.                 return prefix + &quot;:&quot; + name[1]</font>
<font color="black"> 135.         # Return the unqualified name</font>
<font color="red"> 136.         return name[1]</font>
<font color="black"> 137. </font>
<font color="black"> 138.     # ContentHandler methods</font>
<font color="black"> 139. </font>
<font color="green"> 140.     def startDocument(self):</font>
<font color="red"> 141.         self._write(u'&lt;?xml version=&quot;1.0&quot; encoding=&quot;%s&quot;?&gt;\n' %</font>
<font color="red"> 142.                         self._encoding)</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def endDocument(self):</font>
<font color="red"> 145.         self._flush()</font>
<font color="black"> 146. </font>
<font color="green"> 147.     def startPrefixMapping(self, prefix, uri):</font>
<font color="red"> 148.         self._ns_contexts.append(self._current_context.copy())</font>
<font color="red"> 149.         self._current_context[uri] = prefix</font>
<font color="red"> 150.         self._undeclared_ns_maps.append((prefix, uri))</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def endPrefixMapping(self, prefix):</font>
<font color="red"> 153.         self._current_context = self._ns_contexts[-1]</font>
<font color="red"> 154.         del self._ns_contexts[-1]</font>
<font color="black"> 155. </font>
<font color="green"> 156.     def startElement(self, name, attrs):</font>
<font color="red"> 157.         self._write(u'&lt;' + name)</font>
<font color="red"> 158.         for (name, value) in attrs.items():</font>
<font color="red"> 159.             self._write(u' %s=%s' % (name, quoteattr(value)))</font>
<font color="red"> 160.         self._write(u'&gt;')</font>
<font color="black"> 161. </font>
<font color="green"> 162.     def endElement(self, name):</font>
<font color="red"> 163.         self._write(u'&lt;/%s&gt;' % name)</font>
<font color="black"> 164. </font>
<font color="green"> 165.     def startElementNS(self, name, qname, attrs):</font>
<font color="red"> 166.         self._write(u'&lt;' + self._qname(name))</font>
<font color="black"> 167. </font>
<font color="red"> 168.         for prefix, uri in self._undeclared_ns_maps:</font>
<font color="red"> 169.             if prefix:</font>
<font color="red"> 170.                 self._write(u' xmlns:%s=&quot;%s&quot;' % (prefix, uri))</font>
<font color="black"> 171.             else:</font>
<font color="red"> 172.                 self._write(u' xmlns=&quot;%s&quot;' % uri)</font>
<font color="red"> 173.         self._undeclared_ns_maps = []</font>
<font color="black"> 174. </font>
<font color="red"> 175.         for (name, value) in attrs.items():</font>
<font color="red"> 176.             self._write(u' %s=%s' % (self._qname(name), quoteattr(value)))</font>
<font color="red"> 177.         self._write(u'&gt;')</font>
<font color="black"> 178. </font>
<font color="green"> 179.     def endElementNS(self, name, qname):</font>
<font color="red"> 180.         self._write(u'&lt;/%s&gt;' % self._qname(name))</font>
<font color="black"> 181. </font>
<font color="green"> 182.     def characters(self, content):</font>
<font color="red"> 183.         if not isinstance(content, unicode):</font>
<font color="red"> 184.             content = unicode(content, self._encoding)</font>
<font color="red"> 185.         self._write(escape(content))</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def ignorableWhitespace(self, content):</font>
<font color="red"> 188.         if not isinstance(content, unicode):</font>
<font color="red"> 189.             content = unicode(content, self._encoding)</font>
<font color="red"> 190.         self._write(content)</font>
<font color="black"> 191. </font>
<font color="green"> 192.     def processingInstruction(self, target, data):</font>
<font color="red"> 193.         self._write(u'&lt;?%s %s?&gt;' % (target, data))</font>
<font color="black"> 194. </font>
<font color="black"> 195. </font>
<font color="green"> 196. class XMLFilterBase(xmlreader.XMLReader):</font>
<font color="black"> 197.     &quot;&quot;&quot;This class is designed to sit between an XMLReader and the</font>
<font color="black"> 198.     client application's event handlers.  By default, it does nothing</font>
<font color="black"> 199.     but pass requests up to the reader and events on to the handlers</font>
<font color="black"> 200.     unmodified, but subclasses can override specific methods to modify</font>
<font color="black"> 201.     the event stream or the configuration requests as they pass</font>
<font color="green"> 202.     through.&quot;&quot;&quot;</font>
<font color="black"> 203. </font>
<font color="green"> 204.     def __init__(self, parent = None):</font>
<font color="red"> 205.         xmlreader.XMLReader.__init__(self)</font>
<font color="red"> 206.         self._parent = parent</font>
<font color="black"> 207. </font>
<font color="black"> 208.     # ErrorHandler methods</font>
<font color="black"> 209. </font>
<font color="green"> 210.     def error(self, exception):</font>
<font color="red"> 211.         self._err_handler.error(exception)</font>
<font color="black"> 212. </font>
<font color="green"> 213.     def fatalError(self, exception):</font>
<font color="red"> 214.         self._err_handler.fatalError(exception)</font>
<font color="black"> 215. </font>
<font color="green"> 216.     def warning(self, exception):</font>
<font color="red"> 217.         self._err_handler.warning(exception)</font>
<font color="black"> 218. </font>
<font color="black"> 219.     # ContentHandler methods</font>
<font color="black"> 220. </font>
<font color="green"> 221.     def setDocumentLocator(self, locator):</font>
<font color="red"> 222.         self._cont_handler.setDocumentLocator(locator)</font>
<font color="black"> 223. </font>
<font color="green"> 224.     def startDocument(self):</font>
<font color="red"> 225.         self._cont_handler.startDocument()</font>
<font color="black"> 226. </font>
<font color="green"> 227.     def endDocument(self):</font>
<font color="red"> 228.         self._cont_handler.endDocument()</font>
<font color="black"> 229. </font>
<font color="green"> 230.     def startPrefixMapping(self, prefix, uri):</font>
<font color="red"> 231.         self._cont_handler.startPrefixMapping(prefix, uri)</font>
<font color="black"> 232. </font>
<font color="green"> 233.     def endPrefixMapping(self, prefix):</font>
<font color="red"> 234.         self._cont_handler.endPrefixMapping(prefix)</font>
<font color="black"> 235. </font>
<font color="green"> 236.     def startElement(self, name, attrs):</font>
<font color="red"> 237.         self._cont_handler.startElement(name, attrs)</font>
<font color="black"> 238. </font>
<font color="green"> 239.     def endElement(self, name):</font>
<font color="red"> 240.         self._cont_handler.endElement(name)</font>
<font color="black"> 241. </font>
<font color="green"> 242.     def startElementNS(self, name, qname, attrs):</font>
<font color="red"> 243.         self._cont_handler.startElementNS(name, qname, attrs)</font>
<font color="black"> 244. </font>
<font color="green"> 245.     def endElementNS(self, name, qname):</font>
<font color="red"> 246.         self._cont_handler.endElementNS(name, qname)</font>
<font color="black"> 247. </font>
<font color="green"> 248.     def characters(self, content):</font>
<font color="red"> 249.         self._cont_handler.characters(content)</font>
<font color="black"> 250. </font>
<font color="green"> 251.     def ignorableWhitespace(self, chars):</font>
<font color="red"> 252.         self._cont_handler.ignorableWhitespace(chars)</font>
<font color="black"> 253. </font>
<font color="green"> 254.     def processingInstruction(self, target, data):</font>
<font color="red"> 255.         self._cont_handler.processingInstruction(target, data)</font>
<font color="black"> 256. </font>
<font color="green"> 257.     def skippedEntity(self, name):</font>
<font color="red"> 258.         self._cont_handler.skippedEntity(name)</font>
<font color="black"> 259. </font>
<font color="black"> 260.     # DTDHandler methods</font>
<font color="black"> 261. </font>
<font color="green"> 262.     def notationDecl(self, name, publicId, systemId):</font>
<font color="red"> 263.         self._dtd_handler.notationDecl(name, publicId, systemId)</font>
<font color="black"> 264. </font>
<font color="green"> 265.     def unparsedEntityDecl(self, name, publicId, systemId, ndata):</font>
<font color="red"> 266.         self._dtd_handler.unparsedEntityDecl(name, publicId, systemId, ndata)</font>
<font color="black"> 267. </font>
<font color="black"> 268.     # EntityResolver methods</font>
<font color="black"> 269. </font>
<font color="green"> 270.     def resolveEntity(self, publicId, systemId):</font>
<font color="red"> 271.         return self._ent_handler.resolveEntity(publicId, systemId)</font>
<font color="black"> 272. </font>
<font color="black"> 273.     # XMLReader methods</font>
<font color="black"> 274. </font>
<font color="green"> 275.     def parse(self, source):</font>
<font color="red"> 276.         self._parent.setContentHandler(self)</font>
<font color="red"> 277.         self._parent.setErrorHandler(self)</font>
<font color="red"> 278.         self._parent.setEntityResolver(self)</font>
<font color="red"> 279.         self._parent.setDTDHandler(self)</font>
<font color="red"> 280.         self._parent.parse(source)</font>
<font color="black"> 281. </font>
<font color="green"> 282.     def setLocale(self, locale):</font>
<font color="red"> 283.         self._parent.setLocale(locale)</font>
<font color="black"> 284. </font>
<font color="green"> 285.     def getFeature(self, name):</font>
<font color="red"> 286.         return self._parent.getFeature(name)</font>
<font color="black"> 287. </font>
<font color="green"> 288.     def setFeature(self, name, state):</font>
<font color="red"> 289.         self._parent.setFeature(name, state)</font>
<font color="black"> 290. </font>
<font color="green"> 291.     def getProperty(self, name):</font>
<font color="red"> 292.         return self._parent.getProperty(name)</font>
<font color="black"> 293. </font>
<font color="green"> 294.     def setProperty(self, name, value):</font>
<font color="red"> 295.         self._parent.setProperty(name, value)</font>
<font color="black"> 296. </font>
<font color="black"> 297.     # XMLFilter methods</font>
<font color="black"> 298. </font>
<font color="green"> 299.     def getParent(self):</font>
<font color="red"> 300.         return self._parent</font>
<font color="black"> 301. </font>
<font color="green"> 302.     def setParent(self, parent):</font>
<font color="red"> 303.         self._parent = parent</font>
<font color="black"> 304. </font>
<font color="black"> 305. # --- Utility functions</font>
<font color="black"> 306. </font>
<font color="green"> 307. def prepare_input_source(source, base = &quot;&quot;):</font>
<font color="black"> 308.     &quot;&quot;&quot;This function takes an InputSource and an optional base URL and</font>
<font color="black"> 309.     returns a fully resolved InputSource object ready for reading.&quot;&quot;&quot;</font>
<font color="black"> 310. </font>
<font color="red"> 311.     if type(source) in _StringTypes:</font>
<font color="red"> 312.         source = xmlreader.InputSource(source)</font>
<font color="red"> 313.     elif hasattr(source, &quot;read&quot;):</font>
<font color="red"> 314.         f = source</font>
<font color="red"> 315.         source = xmlreader.InputSource()</font>
<font color="red"> 316.         source.setByteStream(f)</font>
<font color="red"> 317.         if hasattr(f, &quot;name&quot;):</font>
<font color="red"> 318.             source.setSystemId(f.name)</font>
<font color="black"> 319. </font>
<font color="red"> 320.     if source.getByteStream() is None:</font>
<font color="red"> 321.         try:</font>
<font color="red"> 322.             sysid = source.getSystemId()</font>
<font color="red"> 323.             basehead = os.path.dirname(os.path.normpath(base))</font>
<font color="red"> 324.             encoding = sys.getfilesystemencoding()</font>
<font color="red"> 325.             if isinstance(sysid, unicode):</font>
<font color="red"> 326.                 if not isinstance(basehead, unicode):</font>
<font color="red"> 327.                     try:</font>
<font color="red"> 328.                         basehead = basehead.decode(encoding)</font>
<font color="red"> 329.                     except UnicodeDecodeError:</font>
<font color="red"> 330.                         sysid = sysid.encode(encoding)</font>
<font color="black"> 331.             else:</font>
<font color="red"> 332.                 if isinstance(basehead, unicode):</font>
<font color="red"> 333.                     try:</font>
<font color="red"> 334.                         sysid = sysid.decode(encoding)</font>
<font color="red"> 335.                     except UnicodeDecodeError:</font>
<font color="red"> 336.                         basehead = basehead.encode(encoding)</font>
<font color="red"> 337.             sysidfilename = os.path.join(basehead, sysid)</font>
<font color="red"> 338.             isfile = os.path.isfile(sysidfilename)</font>
<font color="red"> 339.         except UnicodeError:</font>
<font color="red"> 340.             isfile = False</font>
<font color="red"> 341.         if isfile:</font>
<font color="red"> 342.             source.setSystemId(sysidfilename)</font>
<font color="red"> 343.             f = open(sysidfilename, &quot;rb&quot;)</font>
<font color="black"> 344.         else:</font>
<font color="red"> 345.             source.setSystemId(urlparse.urljoin(base, source.getSystemId()))</font>
<font color="red"> 346.             f = urllib.urlopen(source.getSystemId())</font>
<font color="black"> 347. </font>
<font color="red"> 348.         source.setByteStream(f)</font>
<font color="black"> 349. </font>
<font color="red"> 350.     return source</font>
</pre>


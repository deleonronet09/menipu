source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/management/commands/migrate.py</b><br>


file stats: <b>208 lines, 88 executed: 42.3% covered</b>
<pre>
<font color="black">   1. # -*- coding: utf-8 -*-</font>
<font color="green">   2. from __future__ import unicode_literals</font>
<font color="black">   3. </font>
<font color="green">   4. import time</font>
<font color="green">   5. import warnings</font>
<font color="green">   6. from collections import OrderedDict</font>
<font color="green">   7. from importlib import import_module</font>
<font color="black">   8. </font>
<font color="green">   9. from django.apps import apps</font>
<font color="green">  10. from django.core.management import call_command</font>
<font color="green">  11. from django.core.management.base import BaseCommand, CommandError</font>
<font color="green">  12. from django.core.management.sql import (</font>
<font color="black">  13.     emit_post_migrate_signal, emit_pre_migrate_signal,</font>
<font color="black">  14. )</font>
<font color="green">  15. from django.db import DEFAULT_DB_ALIAS, connections, router, transaction</font>
<font color="green">  16. from django.db.migrations.autodetector import MigrationAutodetector</font>
<font color="green">  17. from django.db.migrations.executor import MigrationExecutor</font>
<font color="green">  18. from django.db.migrations.loader import AmbiguityError</font>
<font color="green">  19. from django.db.migrations.state import ProjectState</font>
<font color="green">  20. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  21. from django.utils.module_loading import module_has_submodule</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. class Command(BaseCommand):</font>
<font color="green">  25.     help = &quot;Updates database schema. Manages both apps with migrations and those without.&quot;</font>
<font color="black">  26. </font>
<font color="green">  27.     def add_arguments(self, parser):</font>
<font color="green">  28.         parser.add_argument('app_label', nargs='?',</font>
<font color="green">  29.             help='App label of an application to synchronize the state.')</font>
<font color="green">  30.         parser.add_argument('migration_name', nargs='?',</font>
<font color="black">  31.             help=(</font>
<font color="green">  32.                 'Database state will be brought to the state after that '</font>
<font color="black">  33.                 'migration. Use the name &quot;zero&quot; to unapply all migrations.'</font>
<font color="black">  34.             ),</font>
<font color="black">  35.         )</font>
<font color="green">  36.         parser.add_argument('--noinput', '--no-input',</font>
<font color="green">  37.             action='store_false', dest='interactive', default=True,</font>
<font color="green">  38.             help='Tells Django to NOT prompt the user for input of any kind.')</font>
<font color="green">  39.         parser.add_argument('--database', action='store', dest='database',</font>
<font color="green">  40.             default=DEFAULT_DB_ALIAS, help='Nominates a database to synchronize. '</font>
<font color="black">  41.                 'Defaults to the &quot;default&quot; database.')</font>
<font color="green">  42.         parser.add_argument('--fake', action='store_true', dest='fake', default=False,</font>
<font color="green">  43.             help='Mark migrations as run without actually running them.')</font>
<font color="green">  44.         parser.add_argument('--fake-initial', action='store_true', dest='fake_initial', default=False,</font>
<font color="green">  45.             help='Detect if tables already exist and fake-apply initial migrations if so. Make sure '</font>
<font color="black">  46.                  'that the current database schema matches your initial migration before using this '</font>
<font color="black">  47.                  'flag. Django will only check for an existing table name.')</font>
<font color="green">  48.         parser.add_argument('--list', '-l', action='store_true', dest='list', default=False,</font>
<font color="green">  49.             help='Show a list of all known migrations and which are applied.')</font>
<font color="green">  50.         parser.add_argument('--run-syncdb', action='store_true', dest='run_syncdb',</font>
<font color="green">  51.             help='Creates tables for apps without migrations.')</font>
<font color="black">  52. </font>
<font color="green">  53.     def handle(self, *args, **options):</font>
<font color="black">  54. </font>
<font color="green">  55.         self.verbosity = options.get('verbosity')</font>
<font color="green">  56.         self.interactive = options.get('interactive')</font>
<font color="black">  57. </font>
<font color="black">  58.         # Import the 'management' module within each installed app, to register</font>
<font color="black">  59.         # dispatcher events.</font>
<font color="green">  60.         for app_config in apps.get_app_configs():</font>
<font color="green">  61.             if module_has_submodule(app_config.module, &quot;management&quot;):</font>
<font color="green">  62.                 import_module('.management', app_config.name)</font>
<font color="black">  63. </font>
<font color="black">  64.         # Get the database we're operating from</font>
<font color="green">  65.         db = options.get('database')</font>
<font color="green">  66.         connection = connections[db]</font>
<font color="black">  67. </font>
<font color="black">  68.         # If they asked for a migration listing, quit main execution flow and show it</font>
<font color="green">  69.         if options.get(&quot;list&quot;, False):</font>
<font color="red">  70.             warnings.warn(</font>
<font color="red">  71.                 &quot;The 'migrate --list' command is deprecated. Use 'showmigrations' instead.&quot;,</font>
<font color="red">  72.                 RemovedInDjango110Warning, stacklevel=2)</font>
<font color="red">  73.             self.stdout.ending = None  # Remove when #21429 is fixed</font>
<font color="red">  74.             return call_command(</font>
<font color="red">  75.                 'showmigrations',</font>
<font color="red">  76.                 '--list',</font>
<font color="red">  77.                 app_labels=[options['app_label']] if options['app_label'] else None,</font>
<font color="red">  78.                 database=db,</font>
<font color="red">  79.                 no_color=options.get('no_color'),</font>
<font color="red">  80.                 settings=options.get('settings'),</font>
<font color="red">  81.                 stdout=self.stdout,</font>
<font color="red">  82.                 traceback=options.get('traceback'),</font>
<font color="red">  83.                 verbosity=self.verbosity,</font>
<font color="black">  84.             )</font>
<font color="black">  85. </font>
<font color="black">  86.         # Hook for backends needing any database preparation</font>
<font color="green">  87.         connection.prepare_database()</font>
<font color="black">  88.         # Work out which apps have migrations and which do not</font>
<font color="green">  89.         executor = MigrationExecutor(connection, self.migration_progress_callback)</font>
<font color="black">  90. </font>
<font color="black">  91.         # Before anything else, see if there's conflicting apps and drop out</font>
<font color="black">  92.         # hard if there are any</font>
<font color="green">  93.         conflicts = executor.loader.detect_conflicts()</font>
<font color="green">  94.         if conflicts:</font>
<font color="red">  95.             name_str = &quot;; &quot;.join(</font>
<font color="red">  96.                 &quot;%s in %s&quot; % (&quot;, &quot;.join(names), app)</font>
<font color="red">  97.                 for app, names in conflicts.items()</font>
<font color="black">  98.             )</font>
<font color="red">  99.             raise CommandError(</font>
<font color="red"> 100.                 &quot;Conflicting migrations detected; multiple leaf nodes in the &quot;</font>
<font color="black"> 101.                 &quot;migration graph: (%s).\nTo fix them run &quot;</font>
<font color="red"> 102.                 &quot;'python manage.py makemigrations --merge'&quot; % name_str</font>
<font color="black"> 103.             )</font>
<font color="black"> 104. </font>
<font color="black"> 105.         # If they supplied command line arguments, work out what they mean.</font>
<font color="green"> 106.         target_app_labels_only = True</font>
<font color="green"> 107.         if options['app_label'] and options['migration_name']:</font>
<font color="red"> 108.             app_label, migration_name = options['app_label'], options['migration_name']</font>
<font color="red"> 109.             if app_label not in executor.loader.migrated_apps:</font>
<font color="red"> 110.                 raise CommandError(</font>
<font color="red"> 111.                     &quot;App '%s' does not have migrations.&quot; % app_label</font>
<font color="black"> 112.                 )</font>
<font color="red"> 113.             if migration_name == &quot;zero&quot;:</font>
<font color="red"> 114.                 targets = [(app_label, None)]</font>
<font color="black"> 115.             else:</font>
<font color="red"> 116.                 try:</font>
<font color="red"> 117.                     migration = executor.loader.get_migration_by_prefix(app_label, migration_name)</font>
<font color="red"> 118.                 except AmbiguityError:</font>
<font color="red"> 119.                     raise CommandError(</font>
<font color="red"> 120.                         &quot;More than one migration matches '%s' in app '%s'. &quot;</font>
<font color="black"> 121.                         &quot;Please be more specific.&quot; %</font>
<font color="red"> 122.                         (migration_name, app_label)</font>
<font color="black"> 123.                     )</font>
<font color="red"> 124.                 except KeyError:</font>
<font color="red"> 125.                     raise CommandError(&quot;Cannot find a migration matching '%s' from app '%s'.&quot; % (</font>
<font color="red"> 126.                         migration_name, app_label))</font>
<font color="red"> 127.                 targets = [(app_label, migration.name)]</font>
<font color="red"> 128.             target_app_labels_only = False</font>
<font color="green"> 129.         elif options['app_label']:</font>
<font color="red"> 130.             app_label = options['app_label']</font>
<font color="red"> 131.             if app_label not in executor.loader.migrated_apps:</font>
<font color="red"> 132.                 raise CommandError(</font>
<font color="red"> 133.                     &quot;App '%s' does not have migrations.&quot; % app_label</font>
<font color="black"> 134.                 )</font>
<font color="red"> 135.             targets = [key for key in executor.loader.graph.leaf_nodes() if key[0] == app_label]</font>
<font color="black"> 136.         else:</font>
<font color="green"> 137.             targets = executor.loader.graph.leaf_nodes()</font>
<font color="black"> 138. </font>
<font color="green"> 139.         plan = executor.migration_plan(targets)</font>
<font color="green"> 140.         run_syncdb = options.get('run_syncdb') and executor.loader.unmigrated_apps</font>
<font color="black"> 141. </font>
<font color="black"> 142.         # Print some useful info</font>
<font color="green"> 143.         if self.verbosity &gt;= 1:</font>
<font color="red"> 144.             self.stdout.write(self.style.MIGRATE_HEADING(&quot;Operations to perform:&quot;))</font>
<font color="red"> 145.             if run_syncdb:</font>
<font color="red"> 146.                 self.stdout.write(</font>
<font color="red"> 147.                     self.style.MIGRATE_LABEL(&quot;  Synchronize unmigrated apps: &quot;) +</font>
<font color="red"> 148.                     (&quot;, &quot;.join(executor.loader.unmigrated_apps))</font>
<font color="black"> 149.                 )</font>
<font color="red"> 150.             if target_app_labels_only:</font>
<font color="red"> 151.                 self.stdout.write(</font>
<font color="red"> 152.                     self.style.MIGRATE_LABEL(&quot;  Apply all migrations: &quot;) +</font>
<font color="red"> 153.                     (&quot;, &quot;.join(set(a for a, n in targets)) or &quot;(none)&quot;)</font>
<font color="black"> 154.                 )</font>
<font color="black"> 155.             else:</font>
<font color="red"> 156.                 if targets[0][1] is None:</font>
<font color="red"> 157.                     self.stdout.write(self.style.MIGRATE_LABEL(</font>
<font color="red"> 158.                         &quot;  Unapply all migrations: &quot;) + &quot;%s&quot; % (targets[0][0], )</font>
<font color="black"> 159.                     )</font>
<font color="black"> 160.                 else:</font>
<font color="red"> 161.                     self.stdout.write(self.style.MIGRATE_LABEL(</font>
<font color="red"> 162.                         &quot;  Target specific migration: &quot;) + &quot;%s, from %s&quot;</font>
<font color="red"> 163.                         % (targets[0][1], targets[0][0])</font>
<font color="black"> 164.                     )</font>
<font color="black"> 165. </font>
<font color="green"> 166.         emit_pre_migrate_signal(self.verbosity, self.interactive, connection.alias)</font>
<font color="black"> 167. </font>
<font color="black"> 168.         # Run the syncdb phase.</font>
<font color="green"> 169.         if run_syncdb:</font>
<font color="green"> 170.             if self.verbosity &gt;= 1:</font>
<font color="red"> 171.                 self.stdout.write(self.style.MIGRATE_HEADING(&quot;Synchronizing apps without migrations:&quot;))</font>
<font color="green"> 172.             self.sync_apps(connection, executor.loader.unmigrated_apps)</font>
<font color="black"> 173. </font>
<font color="black"> 174.         # Migrate!</font>
<font color="green"> 175.         if self.verbosity &gt;= 1:</font>
<font color="red"> 176.             self.stdout.write(self.style.MIGRATE_HEADING(&quot;Running migrations:&quot;))</font>
<font color="green"> 177.         if not plan:</font>
<font color="red"> 178.             executor.check_replacements()</font>
<font color="red"> 179.             if self.verbosity &gt;= 1:</font>
<font color="red"> 180.                 self.stdout.write(&quot;  No migrations to apply.&quot;)</font>
<font color="black"> 181.                 # If there's changes that aren't in migrations yet, tell them how to fix it.</font>
<font color="red"> 182.                 autodetector = MigrationAutodetector(</font>
<font color="red"> 183.                     executor.loader.project_state(),</font>
<font color="red"> 184.                     ProjectState.from_apps(apps),</font>
<font color="black"> 185.                 )</font>
<font color="red"> 186.                 changes = autodetector.changes(graph=executor.loader.graph)</font>
<font color="red"> 187.                 if changes:</font>
<font color="red"> 188.                     self.stdout.write(self.style.NOTICE(</font>
<font color="red"> 189.                         &quot;  Your models have changes that are not yet reflected &quot;</font>
<font color="black"> 190.                         &quot;in a migration, and so won't be applied.&quot;</font>
<font color="black"> 191.                     ))</font>
<font color="red"> 192.                     self.stdout.write(self.style.NOTICE(</font>
<font color="red"> 193.                         &quot;  Run 'manage.py makemigrations' to make new &quot;</font>
<font color="black"> 194.                         &quot;migrations, and then re-run 'manage.py migrate' to &quot;</font>
<font color="black"> 195.                         &quot;apply them.&quot;</font>
<font color="black"> 196.                     ))</font>
<font color="black"> 197.         else:</font>
<font color="green"> 198.             fake = options.get(&quot;fake&quot;)</font>
<font color="green"> 199.             fake_initial = options.get(&quot;fake_initial&quot;)</font>
<font color="green"> 200.             executor.migrate(targets, plan, fake=fake, fake_initial=fake_initial)</font>
<font color="black"> 201. </font>
<font color="black"> 202.         # Send the post_migrate signal, so individual apps can do whatever they need</font>
<font color="black"> 203.         # to do at this point.</font>
<font color="green"> 204.         emit_post_migrate_signal(self.verbosity, self.interactive, connection.alias)</font>
<font color="black"> 205. </font>
<font color="green"> 206.     def migration_progress_callback(self, action, migration=None, fake=False):</font>
<font color="green"> 207.         if self.verbosity &gt;= 1:</font>
<font color="red"> 208.             compute_time = self.verbosity &gt; 1</font>
<font color="red"> 209.             if action == &quot;apply_start&quot;:</font>
<font color="red"> 210.                 if compute_time:</font>
<font color="red"> 211.                     self.start = time.time()</font>
<font color="red"> 212.                 self.stdout.write(&quot;  Applying %s...&quot; % migration, ending=&quot;&quot;)</font>
<font color="red"> 213.                 self.stdout.flush()</font>
<font color="red"> 214.             elif action == &quot;apply_success&quot;:</font>
<font color="red"> 215.                 elapsed = &quot; (%.3fs)&quot; % (time.time() - self.start) if compute_time else &quot;&quot;</font>
<font color="red"> 216.                 if fake:</font>
<font color="red"> 217.                     self.stdout.write(self.style.MIGRATE_SUCCESS(&quot; FAKED&quot; + elapsed))</font>
<font color="black"> 218.                 else:</font>
<font color="red"> 219.                     self.stdout.write(self.style.MIGRATE_SUCCESS(&quot; OK&quot; + elapsed))</font>
<font color="red"> 220.             elif action == &quot;unapply_start&quot;:</font>
<font color="red"> 221.                 if compute_time:</font>
<font color="red"> 222.                     self.start = time.time()</font>
<font color="red"> 223.                 self.stdout.write(&quot;  Unapplying %s...&quot; % migration, ending=&quot;&quot;)</font>
<font color="red"> 224.                 self.stdout.flush()</font>
<font color="red"> 225.             elif action == &quot;unapply_success&quot;:</font>
<font color="red"> 226.                 elapsed = &quot; (%.3fs)&quot; % (time.time() - self.start) if compute_time else &quot;&quot;</font>
<font color="red"> 227.                 if fake:</font>
<font color="red"> 228.                     self.stdout.write(self.style.MIGRATE_SUCCESS(&quot; FAKED&quot; + elapsed))</font>
<font color="black"> 229.                 else:</font>
<font color="red"> 230.                     self.stdout.write(self.style.MIGRATE_SUCCESS(&quot; OK&quot; + elapsed))</font>
<font color="red"> 231.             elif action == &quot;render_start&quot;:</font>
<font color="red"> 232.                 if compute_time:</font>
<font color="red"> 233.                     self.start = time.time()</font>
<font color="red"> 234.                 self.stdout.write(&quot;  Rendering model states...&quot;, ending=&quot;&quot;)</font>
<font color="red"> 235.                 self.stdout.flush()</font>
<font color="red"> 236.             elif action == &quot;render_success&quot;:</font>
<font color="red"> 237.                 elapsed = &quot; (%.3fs)&quot; % (time.time() - self.start) if compute_time else &quot;&quot;</font>
<font color="red"> 238.                 self.stdout.write(self.style.MIGRATE_SUCCESS(&quot; DONE&quot; + elapsed))</font>
<font color="black"> 239. </font>
<font color="green"> 240.     def sync_apps(self, connection, app_labels):</font>
<font color="black"> 241.         &quot;Runs the old syncdb-style operation on a list of app_labels.&quot;</font>
<font color="green"> 242.         cursor = connection.cursor()</font>
<font color="black"> 243. </font>
<font color="green"> 244.         try:</font>
<font color="black"> 245.             # Get a list of already installed *models* so that references work right.</font>
<font color="green"> 246.             tables = connection.introspection.table_names(cursor)</font>
<font color="green"> 247.             created_models = set()</font>
<font color="black"> 248. </font>
<font color="black"> 249.             # Build the manifest of apps and models that are to be synchronized</font>
<font color="black"> 250.             all_models = [</font>
<font color="green"> 251.                 (app_config.label,</font>
<font color="black"> 252.                     router.get_migratable_models(app_config, connection.alias, include_auto_created=False))</font>
<font color="green"> 253.                 for app_config in apps.get_app_configs()</font>
<font color="green"> 254.                 if app_config.models_module is not None and app_config.label in app_labels</font>
<font color="black"> 255.             ]</font>
<font color="black"> 256. </font>
<font color="green"> 257.             def model_installed(model):</font>
<font color="red"> 258.                 opts = model._meta</font>
<font color="red"> 259.                 converter = connection.introspection.table_name_converter</font>
<font color="black"> 260.                 # Note that if a model is unmanaged we short-circuit and never try to install it</font>
<font color="red"> 261.                 return not ((converter(opts.db_table) in tables) or</font>
<font color="red"> 262.                     (opts.auto_created and converter(opts.auto_created._meta.db_table) in tables))</font>
<font color="black"> 263. </font>
<font color="green"> 264.             manifest = OrderedDict(</font>
<font color="green"> 265.                 (app_name, list(filter(model_installed, model_list)))</font>
<font color="green"> 266.                 for app_name, model_list in all_models</font>
<font color="black"> 267.             )</font>
<font color="black"> 268. </font>
<font color="black"> 269.             # Create the tables for each model</font>
<font color="green"> 270.             if self.verbosity &gt;= 1:</font>
<font color="red"> 271.                 self.stdout.write(&quot;  Creating tables...\n&quot;)</font>
<font color="green"> 272.             with transaction.atomic(using=connection.alias, savepoint=connection.features.can_rollback_ddl):</font>
<font color="green"> 273.                 deferred_sql = []</font>
<font color="green"> 274.                 for app_name, model_list in manifest.items():</font>
<font color="red"> 275.                     for model in model_list:</font>
<font color="red"> 276.                         if not model._meta.can_migrate(connection):</font>
<font color="red"> 277.                             continue</font>
<font color="red"> 278.                         if self.verbosity &gt;= 3:</font>
<font color="red"> 279.                             self.stdout.write(</font>
<font color="red"> 280.                                 &quot;    Processing %s.%s model\n&quot; % (app_name, model._meta.object_name)</font>
<font color="black"> 281.                             )</font>
<font color="red"> 282.                         with connection.schema_editor() as editor:</font>
<font color="red"> 283.                             if self.verbosity &gt;= 1:</font>
<font color="red"> 284.                                 self.stdout.write(&quot;    Creating table %s\n&quot; % model._meta.db_table)</font>
<font color="red"> 285.                             editor.create_model(model)</font>
<font color="red"> 286.                             deferred_sql.extend(editor.deferred_sql)</font>
<font color="red"> 287.                             editor.deferred_sql = []</font>
<font color="red"> 288.                         created_models.add(model)</font>
<font color="black"> 289. </font>
<font color="green"> 290.                 if self.verbosity &gt;= 1:</font>
<font color="red"> 291.                     self.stdout.write(&quot;    Running deferred SQL...\n&quot;)</font>
<font color="green"> 292.                 for statement in deferred_sql:</font>
<font color="red"> 293.                     cursor.execute(statement)</font>
<font color="black"> 294.         finally:</font>
<font color="green"> 295.             cursor.close()</font>
<font color="black"> 296. </font>
<font color="green"> 297.         return created_models</font>
</pre>


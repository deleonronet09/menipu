source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/optimizer.py</b><br>


file stats: <b>201 lines, 28 executed: 13.9% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.db.migrations import (</font>
<font color="black">   4.     AddField, AlterField, AlterIndexTogether, AlterModelTable,</font>
<font color="black">   5.     AlterOrderWithRespectTo, AlterUniqueTogether, CreateModel, DeleteModel,</font>
<font color="black">   6.     RemoveField, RenameField, RenameModel,</font>
<font color="black">   7. )</font>
<font color="green">   8. from django.utils import six</font>
<font color="black">   9. </font>
<font color="black">  10. </font>
<font color="green">  11. class MigrationOptimizer(object):</font>
<font color="black">  12.     &quot;&quot;&quot;</font>
<font color="black">  13.     Powers the optimization process, where you provide a list of Operations</font>
<font color="black">  14.     and you are returned a list of equal or shorter length - operations</font>
<font color="black">  15.     are merged into one if possible.</font>
<font color="black">  16. </font>
<font color="black">  17.     For example, a CreateModel and an AddField can be optimized into a</font>
<font color="black">  18.     new CreateModel, and CreateModel and DeleteModel can be optimized into</font>
<font color="black">  19.     nothing.</font>
<font color="green">  20.     &quot;&quot;&quot;</font>
<font color="black">  21. </font>
<font color="green">  22.     def __init__(self):</font>
<font color="black">  23.         self.model_level_operations = (</font>
<font color="red">  24.             CreateModel,</font>
<font color="red">  25.             AlterModelTable,</font>
<font color="red">  26.             AlterUniqueTogether,</font>
<font color="red">  27.             AlterIndexTogether,</font>
<font color="red">  28.             AlterOrderWithRespectTo,</font>
<font color="black">  29.         )</font>
<font color="black">  30.         self.field_level_operations = (</font>
<font color="red">  31.             AddField,</font>
<font color="red">  32.             AlterField,</font>
<font color="black">  33.         )</font>
<font color="red">  34.         self.reduce_methods = {</font>
<font color="black">  35.             # (model operation, model operation)</font>
<font color="red">  36.             (CreateModel, DeleteModel): self.reduce_create_model_delete_model,</font>
<font color="red">  37.             (CreateModel, RenameModel): self.reduce_create_model_rename_model,</font>
<font color="red">  38.             (RenameModel, RenameModel): self.reduce_rename_model_rename_model,</font>
<font color="black">  39. </font>
<font color="red">  40.             (AlterIndexTogether, AlterIndexTogether): self.reduce_alter_model_alter_model,</font>
<font color="red">  41.             (AlterModelTable, AlterModelTable): self.reduce_alter_model_alter_model,</font>
<font color="red">  42.             (AlterOrderWithRespectTo, AlterOrderWithRespectTo): self.reduce_alter_model_alter_model,</font>
<font color="red">  43.             (AlterUniqueTogether, AlterUniqueTogether): self.reduce_alter_model_alter_model,</font>
<font color="black">  44. </font>
<font color="red">  45.             (AlterIndexTogether, DeleteModel): self.reduce_alter_model_delete_model,</font>
<font color="red">  46.             (AlterModelTable, DeleteModel): self.reduce_alter_model_delete_model,</font>
<font color="red">  47.             (AlterOrderWithRespectTo, DeleteModel): self.reduce_alter_model_delete_model,</font>
<font color="red">  48.             (AlterUniqueTogether, DeleteModel): self.reduce_alter_model_delete_model,</font>
<font color="black">  49. </font>
<font color="black">  50.             # (model operation, field operation)</font>
<font color="red">  51.             (CreateModel, AddField): self.reduce_create_model_add_field,</font>
<font color="red">  52.             (CreateModel, AlterField): self.reduce_create_model_alter_field,</font>
<font color="red">  53.             (CreateModel, RemoveField): self.reduce_create_model_remove_field,</font>
<font color="red">  54.             (CreateModel, RenameField): self.reduce_create_model_rename_field,</font>
<font color="black">  55. </font>
<font color="red">  56.             (AlterIndexTogether, AddField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  57.             (AlterIndexTogether, AlterField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  58.             (AlterIndexTogether, RemoveField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  59.             (AlterOrderWithRespectTo, AddField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  60.             (AlterOrderWithRespectTo, AlterField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  61.             (AlterOrderWithRespectTo, RemoveField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  62.             (AlterUniqueTogether, AddField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  63.             (AlterUniqueTogether, AlterField): self.reduce_alter_model_addalterremove_field,</font>
<font color="red">  64.             (AlterUniqueTogether, RemoveField): self.reduce_alter_model_addalterremove_field,</font>
<font color="black">  65. </font>
<font color="red">  66.             (AlterIndexTogether, RenameField): self.reduce_alter_model_rename_field,</font>
<font color="red">  67.             (AlterOrderWithRespectTo, RenameField): self.reduce_alter_model_rename_field,</font>
<font color="red">  68.             (AlterUniqueTogether, RenameField): self.reduce_alter_model_rename_field,</font>
<font color="black">  69. </font>
<font color="black">  70.             # (field operation, field operation)</font>
<font color="red">  71.             (AddField, AlterField): self.reduce_add_field_alter_field,</font>
<font color="red">  72.             (AddField, RemoveField): self.reduce_add_field_remove_field,</font>
<font color="red">  73.             (AddField, RenameField): self.reduce_add_field_rename_field,</font>
<font color="red">  74.             (AlterField, RemoveField): self.reduce_alter_field_remove_field,</font>
<font color="red">  75.             (AlterField, RenameField): self.reduce_alter_field_rename_field,</font>
<font color="red">  76.             (RenameField, RenameField): self.reduce_rename_field_rename_field,</font>
<font color="black">  77.         }</font>
<font color="black">  78. </font>
<font color="green">  79.     def optimize(self, operations, app_label=None):</font>
<font color="black">  80.         &quot;&quot;&quot;</font>
<font color="black">  81.         Main optimization entry point. Pass in a list of Operation instances,</font>
<font color="black">  82.         get out a new list of Operation instances.</font>
<font color="black">  83. </font>
<font color="black">  84.         Unfortunately, due to the scope of the optimization (two combinable</font>
<font color="black">  85.         operations might be separated by several hundred others), this can't be</font>
<font color="black">  86.         done as a peephole optimization with checks/output implemented on</font>
<font color="black">  87.         the Operations themselves; instead, the optimizer looks at each</font>
<font color="black">  88.         individual operation and scans forwards in the list to see if there</font>
<font color="black">  89.         are any matches, stopping at boundaries - operations which can't</font>
<font color="black">  90.         be optimized over (RunSQL, operations on the same field/model, etc.)</font>
<font color="black">  91. </font>
<font color="black">  92.         The inner loop is run until the starting list is the same as the result</font>
<font color="black">  93.         list, and then the result is returned. This means that operation</font>
<font color="black">  94.         optimization must be stable and always return an equal or shorter list.</font>
<font color="black">  95. </font>
<font color="black">  96.         The app_label argument is optional, but if you pass it you'll get more</font>
<font color="black">  97.         efficient optimization.</font>
<font color="black">  98.         &quot;&quot;&quot;</font>
<font color="black">  99.         # Internal tracking variable for test assertions about # of loops</font>
<font color="red"> 100.         self._iterations = 0</font>
<font color="red"> 101.         while True:</font>
<font color="red"> 102.             result = self.optimize_inner(operations, app_label)</font>
<font color="red"> 103.             self._iterations += 1</font>
<font color="red"> 104.             if result == operations:</font>
<font color="red"> 105.                 return result</font>
<font color="red"> 106.             operations = result</font>
<font color="black"> 107. </font>
<font color="green"> 108.     def optimize_inner(self, operations, app_label=None):</font>
<font color="black"> 109.         &quot;&quot;&quot;</font>
<font color="black"> 110.         Inner optimization loop.</font>
<font color="black"> 111.         &quot;&quot;&quot;</font>
<font color="red"> 112.         new_operations = []</font>
<font color="red"> 113.         for i, operation in enumerate(operations):</font>
<font color="black"> 114.             # Compare it to each operation after it</font>
<font color="red"> 115.             for j, other in enumerate(operations[i + 1:]):</font>
<font color="red"> 116.                 result = self.reduce(operation, other, operations[i + 1:i + j + 1])</font>
<font color="red"> 117.                 if result is not None:</font>
<font color="black"> 118.                     # Optimize! Add result, then remaining others, then return</font>
<font color="red"> 119.                     new_operations.extend(result)</font>
<font color="red"> 120.                     new_operations.extend(operations[i + 1:i + 1 + j])</font>
<font color="red"> 121.                     new_operations.extend(operations[i + j + 2:])</font>
<font color="red"> 122.                     return new_operations</font>
<font color="red"> 123.                 if not self.can_optimize_through(operation, other, app_label):</font>
<font color="red"> 124.                     new_operations.append(operation)</font>
<font color="red"> 125.                     break</font>
<font color="black"> 126.             else:</font>
<font color="red"> 127.                 new_operations.append(operation)</font>
<font color="red"> 128.         return new_operations</font>
<font color="black"> 129. </font>
<font color="black"> 130.     # REDUCTION</font>
<font color="black"> 131. </font>
<font color="green"> 132.     def reduce(self, operation, other, in_between=None):</font>
<font color="black"> 133.         &quot;&quot;&quot;</font>
<font color="black"> 134.         Either returns a list of zero, one or two operations,</font>
<font color="black"> 135.         or None, meaning this pair cannot be optimized.</font>
<font color="black"> 136.         &quot;&quot;&quot;</font>
<font color="red"> 137.         method = self.reduce_methods.get((type(operation), type(other)))</font>
<font color="red"> 138.         if method:</font>
<font color="red"> 139.             return method(operation, other, in_between or [])</font>
<font color="red"> 140.         return None</font>
<font color="black"> 141. </font>
<font color="green"> 142.     def model_to_key(self, model):</font>
<font color="black"> 143.         &quot;&quot;&quot;</font>
<font color="black"> 144.         Takes either a model class or a &quot;appname.ModelName&quot; string</font>
<font color="black"> 145.         and returns (appname, modelname)</font>
<font color="black"> 146.         &quot;&quot;&quot;</font>
<font color="red"> 147.         if isinstance(model, six.string_types):</font>
<font color="red"> 148.             return model.split(&quot;.&quot;, 1)</font>
<font color="black"> 149.         else:</font>
<font color="black"> 150.             return (</font>
<font color="red"> 151.                 model._meta.app_label,</font>
<font color="red"> 152.                 model._meta.object_name,</font>
<font color="black"> 153.             )</font>
<font color="black"> 154. </font>
<font color="black"> 155.     # REDUCE METHODS: (MODEL OPERATION, MODEL OPERATION)</font>
<font color="black"> 156. </font>
<font color="green"> 157.     def reduce_create_model_delete_model(self, operation, other, in_between):</font>
<font color="black"> 158.         &quot;&quot;&quot;</font>
<font color="black"> 159.         Folds a CreateModel and a DeleteModel into nothing.</font>
<font color="black"> 160.         &quot;&quot;&quot;</font>
<font color="red"> 161.         if (operation.name_lower == other.name_lower and</font>
<font color="red"> 162.                 not operation.options.get(&quot;proxy&quot;, False)):</font>
<font color="red"> 163.             return []</font>
<font color="black"> 164. </font>
<font color="green"> 165.     def reduce_create_model_rename_model(self, operation, other, in_between):</font>
<font color="black"> 166.         &quot;&quot;&quot;</font>
<font color="black"> 167.         Folds a model rename into its create</font>
<font color="black"> 168.         &quot;&quot;&quot;</font>
<font color="red"> 169.         if operation.name_lower == other.old_name_lower:</font>
<font color="black"> 170.             return [</font>
<font color="red"> 171.                 CreateModel(</font>
<font color="red"> 172.                     other.new_name,</font>
<font color="red"> 173.                     fields=operation.fields,</font>
<font color="red"> 174.                     options=operation.options,</font>
<font color="red"> 175.                     bases=operation.bases,</font>
<font color="red"> 176.                     managers=operation.managers,</font>
<font color="black"> 177.                 )</font>
<font color="black"> 178.             ]</font>
<font color="black"> 179. </font>
<font color="green"> 180.     def reduce_rename_model_rename_model(self, operation, other, in_between):</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="black"> 182.         Folds a model rename into another one</font>
<font color="black"> 183.         &quot;&quot;&quot;</font>
<font color="red"> 184.         if operation.new_name_lower == other.old_name_lower:</font>
<font color="black"> 185.             return [</font>
<font color="red"> 186.                 RenameModel(</font>
<font color="red"> 187.                     operation.old_name,</font>
<font color="red"> 188.                     other.new_name,</font>
<font color="black"> 189.                 )</font>
<font color="black"> 190.             ]</font>
<font color="black"> 191. </font>
<font color="green"> 192.     def reduce_alter_model_alter_model(self, operation, other, in_between):</font>
<font color="black"> 193.         &quot;&quot;&quot;</font>
<font color="black"> 194.         Folds two AlterModelTable, AlterFooTogether, or AlterOrderWithRespectTo</font>
<font color="black"> 195.         operations into the latter.</font>
<font color="black"> 196.         &quot;&quot;&quot;</font>
<font color="red"> 197.         if operation.name_lower == other.name_lower:</font>
<font color="red"> 198.             return [other]</font>
<font color="black"> 199. </font>
<font color="green"> 200.     def reduce_alter_model_delete_model(self, operation, other, in_between):</font>
<font color="black"> 201.         &quot;&quot;&quot;</font>
<font color="black"> 202.         Folds an AlterModelSomething and a DeleteModel into just delete.</font>
<font color="black"> 203.         &quot;&quot;&quot;</font>
<font color="red"> 204.         if operation.name_lower == other.name_lower:</font>
<font color="red"> 205.             return [other]</font>
<font color="black"> 206. </font>
<font color="black"> 207.     # REDUCE METHODS: (MODEL OPERATION, FIELD OPERATION)</font>
<font color="black"> 208. </font>
<font color="green"> 209.     def reduce_create_model_add_field(self, operation, other, in_between):</font>
<font color="red"> 210.         if operation.name_lower == other.model_name_lower:</font>
<font color="black"> 211.             # Don't allow optimizations of FKs through models they reference</font>
<font color="red"> 212.             if hasattr(other.field, &quot;remote_field&quot;) and other.field.remote_field:</font>
<font color="red"> 213.                 for between in in_between:</font>
<font color="black"> 214.                     # Check that it doesn't point to the model</font>
<font color="red"> 215.                     app_label, object_name = self.model_to_key(other.field.remote_field.model)</font>
<font color="red"> 216.                     if between.references_model(object_name, app_label):</font>
<font color="red"> 217.                         return None</font>
<font color="black"> 218.                     # Check that it's not through the model</font>
<font color="red"> 219.                     if getattr(other.field.remote_field, &quot;through&quot;, None):</font>
<font color="red"> 220.                         app_label, object_name = self.model_to_key(other.field.remote_field.through)</font>
<font color="red"> 221.                         if between.references_model(object_name, app_label):</font>
<font color="red"> 222.                             return None</font>
<font color="black"> 223.             # OK, that's fine</font>
<font color="black"> 224.             return [</font>
<font color="red"> 225.                 CreateModel(</font>
<font color="red"> 226.                     operation.name,</font>
<font color="red"> 227.                     fields=operation.fields + [(other.name, other.field)],</font>
<font color="red"> 228.                     options=operation.options,</font>
<font color="red"> 229.                     bases=operation.bases,</font>
<font color="red"> 230.                     managers=operation.managers,</font>
<font color="black"> 231.                 )</font>
<font color="black"> 232.             ]</font>
<font color="black"> 233. </font>
<font color="green"> 234.     def reduce_create_model_alter_field(self, operation, other, in_between):</font>
<font color="red"> 235.         if operation.name_lower == other.model_name_lower:</font>
<font color="black"> 236.             return [</font>
<font color="red"> 237.                 CreateModel(</font>
<font color="red"> 238.                     operation.name,</font>
<font color="black"> 239.                     fields=[</font>
<font color="red"> 240.                         (n, other.field if n == other.name else v)</font>
<font color="red"> 241.                         for n, v in operation.fields</font>
<font color="black"> 242.                     ],</font>
<font color="red"> 243.                     options=operation.options,</font>
<font color="red"> 244.                     bases=operation.bases,</font>
<font color="red"> 245.                     managers=operation.managers,</font>
<font color="black"> 246.                 )</font>
<font color="black"> 247.             ]</font>
<font color="black"> 248. </font>
<font color="green"> 249.     def reduce_create_model_remove_field(self, operation, other, in_between):</font>
<font color="red"> 250.         if operation.name_lower == other.model_name_lower:</font>
<font color="black"> 251.             return [</font>
<font color="red"> 252.                 CreateModel(</font>
<font color="red"> 253.                     operation.name,</font>
<font color="black"> 254.                     fields=[</font>
<font color="red"> 255.                         (n, v)</font>
<font color="red"> 256.                         for n, v in operation.fields</font>
<font color="red"> 257.                         if n.lower() != other.name_lower</font>
<font color="black"> 258.                     ],</font>
<font color="red"> 259.                     options=operation.options,</font>
<font color="red"> 260.                     bases=operation.bases,</font>
<font color="red"> 261.                     managers=operation.managers,</font>
<font color="black"> 262.                 )</font>
<font color="black"> 263.             ]</font>
<font color="black"> 264. </font>
<font color="green"> 265.     def reduce_create_model_rename_field(self, operation, other, in_between):</font>
<font color="red"> 266.         if operation.name_lower == other.model_name_lower:</font>
<font color="black"> 267.             return [</font>
<font color="red"> 268.                 CreateModel(</font>
<font color="red"> 269.                     operation.name,</font>
<font color="black"> 270.                     fields=[</font>
<font color="red"> 271.                         (other.new_name if n == other.old_name else n, v)</font>
<font color="red"> 272.                         for n, v in operation.fields</font>
<font color="black"> 273.                     ],</font>
<font color="red"> 274.                     options=operation.options,</font>
<font color="red"> 275.                     bases=operation.bases,</font>
<font color="red"> 276.                     managers=operation.managers,</font>
<font color="black"> 277.                 )</font>
<font color="black"> 278.             ]</font>
<font color="black"> 279. </font>
<font color="green"> 280.     def reduce_alter_model_addalterremove_field(self, operation, other, in_between):</font>
<font color="red"> 281.         if (operation.name_lower == other.model_name_lower and</font>
<font color="red"> 282.                 not operation.references_field(other.model_name, other.name)):</font>
<font color="red"> 283.             return [other, operation]</font>
<font color="black"> 284. </font>
<font color="green"> 285.     def reduce_alter_model_rename_field(self, operation, other, in_between):</font>
<font color="red"> 286.         if (operation.name_lower == other.model_name_lower and</font>
<font color="red"> 287.                 not operation.references_field(other.model_name, other.old_name)):</font>
<font color="red"> 288.             return [other, operation]</font>
<font color="black"> 289. </font>
<font color="black"> 290.     # REDUCE METHODS: (FIELD OPERATION, FIELD OPERATION)</font>
<font color="black"> 291. </font>
<font color="green"> 292.     def reduce_add_field_alter_field(self, operation, other, in_between):</font>
<font color="red"> 293.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 294.                 operation.name_lower == other.name_lower):</font>
<font color="black"> 295.             return [</font>
<font color="red"> 296.                 AddField(</font>
<font color="red"> 297.                     model_name=operation.model_name,</font>
<font color="red"> 298.                     name=operation.name,</font>
<font color="red"> 299.                     field=other.field,</font>
<font color="black"> 300.                 )</font>
<font color="black"> 301.             ]</font>
<font color="black"> 302. </font>
<font color="green"> 303.     def reduce_add_field_remove_field(self, operation, other, in_between):</font>
<font color="red"> 304.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 305.                 operation.name_lower == other.name_lower):</font>
<font color="red"> 306.             return []</font>
<font color="black"> 307. </font>
<font color="green"> 308.     def reduce_add_field_rename_field(self, operation, other, in_between):</font>
<font color="red"> 309.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 310.                 operation.name_lower == other.old_name_lower):</font>
<font color="black"> 311.             return [</font>
<font color="red"> 312.                 AddField(</font>
<font color="red"> 313.                     model_name=operation.model_name,</font>
<font color="red"> 314.                     name=other.new_name,</font>
<font color="red"> 315.                     field=operation.field,</font>
<font color="black"> 316.                 )</font>
<font color="black"> 317.             ]</font>
<font color="black"> 318. </font>
<font color="green"> 319.     def reduce_alter_field_remove_field(self, operation, other, in_between):</font>
<font color="red"> 320.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 321.                 operation.name_lower == other.name_lower):</font>
<font color="red"> 322.             return [other]</font>
<font color="black"> 323. </font>
<font color="green"> 324.     def reduce_alter_field_rename_field(self, operation, other, in_between):</font>
<font color="red"> 325.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 326.                 operation.name_lower == other.old_name_lower):</font>
<font color="black"> 327.             return [</font>
<font color="red"> 328.                 other,</font>
<font color="red"> 329.                 AlterField(</font>
<font color="red"> 330.                     model_name=operation.model_name,</font>
<font color="red"> 331.                     name=other.new_name,</font>
<font color="red"> 332.                     field=operation.field,</font>
<font color="black"> 333.                 ),</font>
<font color="black"> 334.             ]</font>
<font color="black"> 335. </font>
<font color="green"> 336.     def reduce_rename_field_rename_field(self, operation, other, in_between):</font>
<font color="red"> 337.         if (operation.model_name_lower == other.model_name_lower and</font>
<font color="red"> 338.                 operation.new_name_lower == other.old_name_lower):</font>
<font color="black"> 339.             return [</font>
<font color="red"> 340.                 RenameField(</font>
<font color="red"> 341.                     operation.model_name,</font>
<font color="red"> 342.                     operation.old_name,</font>
<font color="red"> 343.                     other.new_name,</font>
<font color="black"> 344.                 ),</font>
<font color="black"> 345.             ]</font>
<font color="black"> 346. </font>
<font color="black"> 347.     # THROUGH CHECKS</font>
<font color="black"> 348. </font>
<font color="green"> 349.     def can_optimize_through(self, operation, other, app_label=None):</font>
<font color="black"> 350.         &quot;&quot;&quot;</font>
<font color="black"> 351.         Returns True if it's possible to optimize 'operation' with something</font>
<font color="black"> 352.         the other side of 'other'. This is possible if, for example, they</font>
<font color="black"> 353.         affect different models.</font>
<font color="black"> 354.         &quot;&quot;&quot;</font>
<font color="black"> 355.         # If it's a model level operation, let it through if there's</font>
<font color="black"> 356.         # nothing that looks like a reference to us in 'other'.</font>
<font color="red"> 357.         if isinstance(operation, self.model_level_operations):</font>
<font color="red"> 358.             if not other.references_model(operation.name, app_label):</font>
<font color="red"> 359.                 return True</font>
<font color="black"> 360.         # If it's field level, only let it through things that don't reference</font>
<font color="black"> 361.         # the field (which includes not referencing the model)</font>
<font color="red"> 362.         if isinstance(operation, self.field_level_operations):</font>
<font color="red"> 363.             if not other.references_field(operation.model_name, operation.name, app_label):</font>
<font color="red"> 364.                 return True</font>
<font color="red"> 365.         return False</font>
</pre>


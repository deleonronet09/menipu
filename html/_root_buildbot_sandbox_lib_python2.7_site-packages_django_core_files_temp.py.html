source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/files/temp.py</b><br>


file stats: <b>38 lines, 8 executed: 21.1% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. The temp module provides a NamedTemporaryFile that can be reopened in the same</font>
<font color="black">   3. process on any platform. Most platforms use the standard Python</font>
<font color="black">   4. tempfile.NamedTemporaryFile class, but Windows users are given a custom class.</font>
<font color="black">   5. </font>
<font color="black">   6. This is needed because the Python implementation of NamedTemporaryFile uses the</font>
<font color="black">   7. O_TEMPORARY flag under Windows, which prevents the file from being reopened</font>
<font color="black">   8. if the same flag is not provided [1][2]. Note that this does not address the</font>
<font color="black">   9. more general issue of opening a file for writing and reading in multiple</font>
<font color="black">  10. processes in a manner that works across platforms.</font>
<font color="black">  11. </font>
<font color="black">  12. Also note that the custom version of NamedTemporaryFile does not support the</font>
<font color="black">  13. full range of keyword arguments available in Python 2.6+ and 3.0+.</font>
<font color="black">  14. </font>
<font color="black">  15. 1: https://mail.python.org/pipermail/python-list/2005-December/336958.html</font>
<font color="black">  16. 2: http://bugs.python.org/issue14243</font>
<font color="green">  17. &quot;&quot;&quot;</font>
<font color="black">  18. </font>
<font color="green">  19. import os</font>
<font color="green">  20. import tempfile</font>
<font color="black">  21. </font>
<font color="green">  22. from django.core.files.utils import FileProxyMixin</font>
<font color="black">  23. </font>
<font color="green">  24. __all__ = ('NamedTemporaryFile', 'gettempdir',)</font>
<font color="black">  25. </font>
<font color="black">  26. </font>
<font color="green">  27. if os.name == 'nt':</font>
<font color="red">  28.     class TemporaryFile(FileProxyMixin):</font>
<font color="black">  29.         &quot;&quot;&quot;</font>
<font color="black">  30.         Temporary file object constructor that supports reopening of the</font>
<font color="black">  31.         temporary file in Windows.</font>
<font color="black">  32. </font>
<font color="black">  33.         Note that unlike tempfile.NamedTemporaryFile from the standard library,</font>
<font color="black">  34.         __init__() does not support the 'delete' keyword argument in</font>
<font color="black">  35.         Python 2.6+, or the 'delete', 'buffering', 'encoding', or 'newline'</font>
<font color="black">  36.         keyword arguments in Python 3.0+.</font>
<font color="red">  37.         &quot;&quot;&quot;</font>
<font color="red">  38.         def __init__(self, mode='w+b', bufsize=-1, suffix='', prefix='',</font>
<font color="red">  39.                 dir=None):</font>
<font color="red">  40.             fd, name = tempfile.mkstemp(suffix=suffix, prefix=prefix, dir=dir)</font>
<font color="red">  41.             self.name = name</font>
<font color="red">  42.             self.file = os.fdopen(fd, mode, bufsize)</font>
<font color="red">  43.             self.close_called = False</font>
<font color="black">  44. </font>
<font color="black">  45.         # Because close can be called during shutdown</font>
<font color="black">  46.         # we need to cache os.unlink and access it</font>
<font color="black">  47.         # as self.unlink only</font>
<font color="red">  48.         unlink = os.unlink</font>
<font color="black">  49. </font>
<font color="red">  50.         def close(self):</font>
<font color="red">  51.             if not self.close_called:</font>
<font color="red">  52.                 self.close_called = True</font>
<font color="red">  53.                 try:</font>
<font color="red">  54.                     self.file.close()</font>
<font color="red">  55.                 except (OSError, IOError):</font>
<font color="red">  56.                     pass</font>
<font color="red">  57.                 try:</font>
<font color="red">  58.                     self.unlink(self.name)</font>
<font color="red">  59.                 except (OSError):</font>
<font color="red">  60.                     pass</font>
<font color="black">  61. </font>
<font color="red">  62.         @property</font>
<font color="black">  63.         def closed(self):</font>
<font color="black">  64.             &quot;&quot;&quot;</font>
<font color="black">  65.             This attribute needs to be accessible in certain situations,</font>
<font color="black">  66.             because this class is supposed to mock the API of the class</font>
<font color="black">  67.             tempfile.NamedTemporaryFile in the Python standard library.</font>
<font color="black">  68.             &quot;&quot;&quot;</font>
<font color="red">  69.             return self.file.closed</font>
<font color="black">  70. </font>
<font color="red">  71.         def __del__(self):</font>
<font color="red">  72.             self.close()</font>
<font color="black">  73. </font>
<font color="red">  74.         def __enter__(self):</font>
<font color="red">  75.             self.file.__enter__()</font>
<font color="red">  76.             return self</font>
<font color="black">  77. </font>
<font color="red">  78.         def __exit__(self, exc, value, tb):</font>
<font color="red">  79.             self.file.__exit__(exc, value, tb)</font>
<font color="black">  80. </font>
<font color="red">  81.     NamedTemporaryFile = TemporaryFile</font>
<font color="black">  82. else:</font>
<font color="green">  83.     NamedTemporaryFile = tempfile.NamedTemporaryFile</font>
<font color="black">  84. </font>
<font color="green">  85. gettempdir = tempfile.gettempdir</font>
</pre>


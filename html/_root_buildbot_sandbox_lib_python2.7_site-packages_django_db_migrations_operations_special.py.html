source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/operations/special.py</b><br>


file stats: <b>129 lines, 45 executed: 34.9% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.db import router</font>
<font color="black">   4. </font>
<font color="green">   5. from .base import Operation</font>
<font color="black">   6. </font>
<font color="black">   7. </font>
<font color="green">   8. class SeparateDatabaseAndState(Operation):</font>
<font color="black">   9.     &quot;&quot;&quot;</font>
<font color="black">  10.     Takes two lists of operations - ones that will be used for the database,</font>
<font color="black">  11.     and ones that will be used for the state change. This allows operations</font>
<font color="black">  12.     that don't support state change to have it applied, or have operations</font>
<font color="black">  13.     that affect the state or not the database, or so on.</font>
<font color="green">  14.     &quot;&quot;&quot;</font>
<font color="black">  15. </font>
<font color="green">  16.     serialization_expand_args = ['database_operations', 'state_operations']</font>
<font color="black">  17. </font>
<font color="green">  18.     def __init__(self, database_operations=None, state_operations=None):</font>
<font color="red">  19.         self.database_operations = database_operations or []</font>
<font color="red">  20.         self.state_operations = state_operations or []</font>
<font color="black">  21. </font>
<font color="green">  22.     def deconstruct(self):</font>
<font color="red">  23.         kwargs = {}</font>
<font color="red">  24.         if self.database_operations:</font>
<font color="red">  25.             kwargs['database_operations'] = self.database_operations</font>
<font color="red">  26.         if self.state_operations:</font>
<font color="red">  27.             kwargs['state_operations'] = self.state_operations</font>
<font color="black">  28.         return (</font>
<font color="red">  29.             self.__class__.__name__,</font>
<font color="red">  30.             [],</font>
<font color="red">  31.             kwargs</font>
<font color="black">  32.         )</font>
<font color="black">  33. </font>
<font color="green">  34.     def state_forwards(self, app_label, state):</font>
<font color="red">  35.         for state_operation in self.state_operations:</font>
<font color="red">  36.             state_operation.state_forwards(app_label, state)</font>
<font color="black">  37. </font>
<font color="green">  38.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="black">  39.         # We calculate state separately in here since our state functions aren't useful</font>
<font color="red">  40.         for database_operation in self.database_operations:</font>
<font color="red">  41.             to_state = from_state.clone()</font>
<font color="red">  42.             database_operation.state_forwards(app_label, to_state)</font>
<font color="red">  43.             database_operation.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="red">  44.             from_state = to_state</font>
<font color="black">  45. </font>
<font color="green">  46.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="black">  47.         # We calculate state separately in here since our state functions aren't useful</font>
<font color="red">  48.         base_state = to_state</font>
<font color="red">  49.         for pos, database_operation in enumerate(reversed(self.database_operations)):</font>
<font color="red">  50.             to_state = base_state.clone()</font>
<font color="red">  51.             for dbop in self.database_operations[:-(pos + 1)]:</font>
<font color="red">  52.                 dbop.state_forwards(app_label, to_state)</font>
<font color="red">  53.             from_state = base_state.clone()</font>
<font color="red">  54.             database_operation.state_forwards(app_label, from_state)</font>
<font color="red">  55.             database_operation.database_backwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black">  56. </font>
<font color="green">  57.     def describe(self):</font>
<font color="red">  58.         return &quot;Custom state/database change combination&quot;</font>
<font color="black">  59. </font>
<font color="black">  60. </font>
<font color="green">  61. class RunSQL(Operation):</font>
<font color="black">  62.     &quot;&quot;&quot;</font>
<font color="black">  63.     Runs some raw SQL. A reverse SQL statement may be provided.</font>
<font color="black">  64. </font>
<font color="black">  65.     Also accepts a list of operations that represent the state change effected</font>
<font color="black">  66.     by this SQL change, in case it's custom column/table creation/deletion.</font>
<font color="green">  67.     &quot;&quot;&quot;</font>
<font color="green">  68.     noop = ''</font>
<font color="black">  69. </font>
<font color="green">  70.     def __init__(self, sql, reverse_sql=None, state_operations=None, hints=None):</font>
<font color="red">  71.         self.sql = sql</font>
<font color="red">  72.         self.reverse_sql = reverse_sql</font>
<font color="red">  73.         self.state_operations = state_operations or []</font>
<font color="red">  74.         self.hints = hints or {}</font>
<font color="black">  75. </font>
<font color="green">  76.     def deconstruct(self):</font>
<font color="red">  77.         kwargs = {</font>
<font color="red">  78.             'sql': self.sql,</font>
<font color="black">  79.         }</font>
<font color="red">  80.         if self.reverse_sql is not None:</font>
<font color="red">  81.             kwargs['reverse_sql'] = self.reverse_sql</font>
<font color="red">  82.         if self.state_operations:</font>
<font color="red">  83.             kwargs['state_operations'] = self.state_operations</font>
<font color="red">  84.         if self.hints:</font>
<font color="red">  85.             kwargs['hints'] = self.hints</font>
<font color="black">  86.         return (</font>
<font color="red">  87.             self.__class__.__name__,</font>
<font color="red">  88.             [],</font>
<font color="red">  89.             kwargs</font>
<font color="black">  90.         )</font>
<font color="black">  91. </font>
<font color="green">  92.     @property</font>
<font color="black">  93.     def reversible(self):</font>
<font color="red">  94.         return self.reverse_sql is not None</font>
<font color="black">  95. </font>
<font color="green">  96.     def state_forwards(self, app_label, state):</font>
<font color="red">  97.         for state_operation in self.state_operations:</font>
<font color="red">  98.             state_operation.state_forwards(app_label, state)</font>
<font color="black">  99. </font>
<font color="green"> 100.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 101.         if router.allow_migrate(schema_editor.connection.alias, app_label, **self.hints):</font>
<font color="red"> 102.             self._run_sql(schema_editor, self.sql)</font>
<font color="black"> 103. </font>
<font color="green"> 104.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 105.         if self.reverse_sql is None:</font>
<font color="red"> 106.             raise NotImplementedError(&quot;You cannot reverse this operation&quot;)</font>
<font color="red"> 107.         if router.allow_migrate(schema_editor.connection.alias, app_label, **self.hints):</font>
<font color="red"> 108.             self._run_sql(schema_editor, self.reverse_sql)</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def describe(self):</font>
<font color="red"> 111.         return &quot;Raw SQL operation&quot;</font>
<font color="black"> 112. </font>
<font color="green"> 113.     def _run_sql(self, schema_editor, sqls):</font>
<font color="red"> 114.         if isinstance(sqls, (list, tuple)):</font>
<font color="red"> 115.             for sql in sqls:</font>
<font color="red"> 116.                 params = None</font>
<font color="red"> 117.                 if isinstance(sql, (list, tuple)):</font>
<font color="red"> 118.                     elements = len(sql)</font>
<font color="red"> 119.                     if elements == 2:</font>
<font color="red"> 120.                         sql, params = sql</font>
<font color="black"> 121.                     else:</font>
<font color="red"> 122.                         raise ValueError(&quot;Expected a 2-tuple but got %d&quot; % elements)</font>
<font color="red"> 123.                 schema_editor.execute(sql, params=params)</font>
<font color="red"> 124.         elif sqls != RunSQL.noop:</font>
<font color="red"> 125.             statements = schema_editor.connection.ops.prepare_sql_script(sqls)</font>
<font color="red"> 126.             for statement in statements:</font>
<font color="red"> 127.                 schema_editor.execute(statement, params=None)</font>
<font color="black"> 128. </font>
<font color="black"> 129. </font>
<font color="green"> 130. class RunPython(Operation):</font>
<font color="black"> 131.     &quot;&quot;&quot;</font>
<font color="black"> 132.     Runs Python code in a context suitable for doing versioned ORM operations.</font>
<font color="green"> 133.     &quot;&quot;&quot;</font>
<font color="black"> 134. </font>
<font color="green"> 135.     reduces_to_sql = False</font>
<font color="black"> 136. </font>
<font color="green"> 137.     def __init__(self, code, reverse_code=None, atomic=True, hints=None):</font>
<font color="green"> 138.         self.atomic = atomic</font>
<font color="black"> 139.         # Forwards code</font>
<font color="green"> 140.         if not callable(code):</font>
<font color="red"> 141.             raise ValueError(&quot;RunPython must be supplied with a callable&quot;)</font>
<font color="green"> 142.         self.code = code</font>
<font color="black"> 143.         # Reverse code</font>
<font color="green"> 144.         if reverse_code is None:</font>
<font color="red"> 145.             self.reverse_code = None</font>
<font color="black"> 146.         else:</font>
<font color="green"> 147.             if not callable(reverse_code):</font>
<font color="red"> 148.                 raise ValueError(&quot;RunPython must be supplied with callable arguments&quot;)</font>
<font color="green"> 149.             self.reverse_code = reverse_code</font>
<font color="green"> 150.         self.hints = hints or {}</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def deconstruct(self):</font>
<font color="red"> 153.         kwargs = {</font>
<font color="red"> 154.             'code': self.code,</font>
<font color="black"> 155.         }</font>
<font color="red"> 156.         if self.reverse_code is not None:</font>
<font color="red"> 157.             kwargs['reverse_code'] = self.reverse_code</font>
<font color="red"> 158.         if self.atomic is not True:</font>
<font color="red"> 159.             kwargs['atomic'] = self.atomic</font>
<font color="red"> 160.         if self.hints:</font>
<font color="red"> 161.             kwargs['hints'] = self.hints</font>
<font color="black"> 162.         return (</font>
<font color="red"> 163.             self.__class__.__name__,</font>
<font color="red"> 164.             [],</font>
<font color="red"> 165.             kwargs</font>
<font color="black"> 166.         )</font>
<font color="black"> 167. </font>
<font color="green"> 168.     @property</font>
<font color="black"> 169.     def reversible(self):</font>
<font color="red"> 170.         return self.reverse_code is not None</font>
<font color="black"> 171. </font>
<font color="green"> 172.     def state_forwards(self, app_label, state):</font>
<font color="black"> 173.         # RunPython objects have no state effect. To add some, combine this</font>
<font color="black"> 174.         # with SeparateDatabaseAndState.</font>
<font color="green"> 175.         pass</font>
<font color="black"> 176. </font>
<font color="green"> 177.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green"> 178.         if router.allow_migrate(schema_editor.connection.alias, app_label, **self.hints):</font>
<font color="black"> 179.             # We now execute the Python code in a context that contains a 'models'</font>
<font color="black"> 180.             # object, representing the versioned models as an app registry.</font>
<font color="black"> 181.             # We could try to override the global cache, but then people will still</font>
<font color="black"> 182.             # use direct imports, so we go with a documentation approach instead.</font>
<font color="green"> 183.             self.code(from_state.apps, schema_editor)</font>
<font color="black"> 184. </font>
<font color="green"> 185.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 186.         if self.reverse_code is None:</font>
<font color="red"> 187.             raise NotImplementedError(&quot;You cannot reverse this operation&quot;)</font>
<font color="red"> 188.         if router.allow_migrate(schema_editor.connection.alias, app_label, **self.hints):</font>
<font color="red"> 189.             self.reverse_code(from_state.apps, schema_editor)</font>
<font color="black"> 190. </font>
<font color="green"> 191.     def describe(self):</font>
<font color="red"> 192.         return &quot;Raw Python operation&quot;</font>
<font color="black"> 193. </font>
<font color="green"> 194.     @staticmethod</font>
<font color="black"> 195.     def noop(apps, schema_editor):</font>
<font color="green"> 196.         return None</font>
</pre>


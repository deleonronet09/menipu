source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/operations/models.py</b><br>


file stats: <b>391 lines, 153 executed: 39.1% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.db import models</font>
<font color="green">   4. from django.db.migrations.operations.base import Operation</font>
<font color="green">   5. from django.db.migrations.state import ModelState</font>
<font color="green">   6. from django.db.models.options import normalize_together</font>
<font color="green">   7. from django.utils import six</font>
<font color="green">   8. from django.utils.functional import cached_property</font>
<font color="black">   9. </font>
<font color="black">  10. </font>
<font color="green">  11. class CreateModel(Operation):</font>
<font color="black">  12.     &quot;&quot;&quot;</font>
<font color="black">  13.     Create a model's table.</font>
<font color="green">  14.     &quot;&quot;&quot;</font>
<font color="black">  15. </font>
<font color="green">  16.     serialization_expand_args = ['fields', 'options', 'managers']</font>
<font color="black">  17. </font>
<font color="green">  18.     def __init__(self, name, fields, options=None, bases=None, managers=None):</font>
<font color="green">  19.         self.name = name</font>
<font color="green">  20.         self.fields = fields</font>
<font color="green">  21.         self.options = options or {}</font>
<font color="green">  22.         self.bases = bases or (models.Model,)</font>
<font color="green">  23.         self.managers = managers or []</font>
<font color="black">  24. </font>
<font color="green">  25.     @cached_property</font>
<font color="black">  26.     def name_lower(self):</font>
<font color="red">  27.         return self.name.lower()</font>
<font color="black">  28. </font>
<font color="green">  29.     def deconstruct(self):</font>
<font color="red">  30.         kwargs = {</font>
<font color="red">  31.             'name': self.name,</font>
<font color="red">  32.             'fields': self.fields,</font>
<font color="black">  33.         }</font>
<font color="red">  34.         if self.options:</font>
<font color="red">  35.             kwargs['options'] = self.options</font>
<font color="red">  36.         if self.bases and self.bases != (models.Model,):</font>
<font color="red">  37.             kwargs['bases'] = self.bases</font>
<font color="red">  38.         if self.managers and self.managers != [('objects', models.Manager())]:</font>
<font color="red">  39.             kwargs['managers'] = self.managers</font>
<font color="black">  40.         return (</font>
<font color="red">  41.             self.__class__.__name__,</font>
<font color="red">  42.             [],</font>
<font color="red">  43.             kwargs</font>
<font color="black">  44.         )</font>
<font color="black">  45. </font>
<font color="green">  46.     def state_forwards(self, app_label, state):</font>
<font color="green">  47.         state.add_model(ModelState(</font>
<font color="green">  48.             app_label,</font>
<font color="green">  49.             self.name,</font>
<font color="green">  50.             list(self.fields),</font>
<font color="green">  51.             dict(self.options),</font>
<font color="green">  52.             tuple(self.bases),</font>
<font color="green">  53.             list(self.managers),</font>
<font color="black">  54.         ))</font>
<font color="black">  55. </font>
<font color="green">  56.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green">  57.         model = to_state.apps.get_model(app_label, self.name)</font>
<font color="green">  58.         if self.allow_migrate_model(schema_editor.connection.alias, model):</font>
<font color="green">  59.             schema_editor.create_model(model)</font>
<font color="black">  60. </font>
<font color="green">  61.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red">  62.         model = from_state.apps.get_model(app_label, self.name)</font>
<font color="red">  63.         if self.allow_migrate_model(schema_editor.connection.alias, model):</font>
<font color="red">  64.             schema_editor.delete_model(model)</font>
<font color="black">  65. </font>
<font color="green">  66.     def describe(self):</font>
<font color="red">  67.         return &quot;Create %smodel %s&quot; % (&quot;proxy &quot; if self.options.get(&quot;proxy&quot;, False) else &quot;&quot;, self.name)</font>
<font color="black">  68. </font>
<font color="green">  69.     def references_model(self, name, app_label=None):</font>
<font color="red">  70.         strings_to_check = [self.name]</font>
<font color="black">  71.         # Check we didn't inherit from the model</font>
<font color="red">  72.         for base in self.bases:</font>
<font color="red">  73.             if isinstance(base, six.string_types):</font>
<font color="red">  74.                 strings_to_check.append(base.split(&quot;.&quot;)[-1])</font>
<font color="black">  75.         # Check we have no FKs/M2Ms with it</font>
<font color="red">  76.         for fname, field in self.fields:</font>
<font color="red">  77.             if field.remote_field:</font>
<font color="red">  78.                 if isinstance(field.remote_field.model, six.string_types):</font>
<font color="red">  79.                     strings_to_check.append(field.remote_field.model.split(&quot;.&quot;)[-1])</font>
<font color="black">  80.         # Now go over all the strings and compare them</font>
<font color="red">  81.         for string in strings_to_check:</font>
<font color="red">  82.             if string.lower() == name.lower():</font>
<font color="red">  83.                 return True</font>
<font color="red">  84.         return False</font>
<font color="black">  85. </font>
<font color="black">  86. </font>
<font color="green">  87. class DeleteModel(Operation):</font>
<font color="black">  88.     &quot;&quot;&quot;</font>
<font color="black">  89.     Drops a model's table.</font>
<font color="green">  90.     &quot;&quot;&quot;</font>
<font color="black">  91. </font>
<font color="green">  92.     def __init__(self, name):</font>
<font color="red">  93.         self.name = name</font>
<font color="black">  94. </font>
<font color="green">  95.     @cached_property</font>
<font color="black">  96.     def name_lower(self):</font>
<font color="red">  97.         return self.name.lower()</font>
<font color="black">  98. </font>
<font color="green">  99.     def deconstruct(self):</font>
<font color="red"> 100.         kwargs = {</font>
<font color="red"> 101.             'name': self.name,</font>
<font color="black"> 102.         }</font>
<font color="black"> 103.         return (</font>
<font color="red"> 104.             self.__class__.__name__,</font>
<font color="red"> 105.             [],</font>
<font color="red"> 106.             kwargs</font>
<font color="black"> 107.         )</font>
<font color="black"> 108. </font>
<font color="green"> 109.     def state_forwards(self, app_label, state):</font>
<font color="red"> 110.         state.remove_model(app_label, self.name_lower)</font>
<font color="black"> 111. </font>
<font color="green"> 112.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 113.         model = from_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 114.         if self.allow_migrate_model(schema_editor.connection.alias, model):</font>
<font color="red"> 115.             schema_editor.delete_model(model)</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 118.         model = to_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 119.         if self.allow_migrate_model(schema_editor.connection.alias, model):</font>
<font color="red"> 120.             schema_editor.create_model(model)</font>
<font color="black"> 121. </font>
<font color="green"> 122.     def references_model(self, name, app_label=None):</font>
<font color="red"> 123.         return name.lower() == self.name_lower</font>
<font color="black"> 124. </font>
<font color="green"> 125.     def describe(self):</font>
<font color="red"> 126.         return &quot;Delete model %s&quot; % (self.name, )</font>
<font color="black"> 127. </font>
<font color="black"> 128. </font>
<font color="green"> 129. class RenameModel(Operation):</font>
<font color="black"> 130.     &quot;&quot;&quot;</font>
<font color="black"> 131.     Renames a model.</font>
<font color="green"> 132.     &quot;&quot;&quot;</font>
<font color="black"> 133. </font>
<font color="green"> 134.     def __init__(self, old_name, new_name):</font>
<font color="red"> 135.         self.old_name = old_name</font>
<font color="red"> 136.         self.new_name = new_name</font>
<font color="black"> 137. </font>
<font color="green"> 138.     @cached_property</font>
<font color="black"> 139.     def old_name_lower(self):</font>
<font color="red"> 140.         return self.old_name.lower()</font>
<font color="black"> 141. </font>
<font color="green"> 142.     @cached_property</font>
<font color="black"> 143.     def new_name_lower(self):</font>
<font color="red"> 144.         return self.new_name.lower()</font>
<font color="black"> 145. </font>
<font color="green"> 146.     def deconstruct(self):</font>
<font color="red"> 147.         kwargs = {</font>
<font color="red"> 148.             'old_name': self.old_name,</font>
<font color="red"> 149.             'new_name': self.new_name,</font>
<font color="black"> 150.         }</font>
<font color="black"> 151.         return (</font>
<font color="red"> 152.             self.__class__.__name__,</font>
<font color="red"> 153.             [],</font>
<font color="red"> 154.             kwargs</font>
<font color="black"> 155.         )</font>
<font color="black"> 156. </font>
<font color="green"> 157.     def state_forwards(self, app_label, state):</font>
<font color="red"> 158.         apps = state.apps</font>
<font color="red"> 159.         model = apps.get_model(app_label, self.old_name)</font>
<font color="red"> 160.         model._meta.apps = apps</font>
<font color="black"> 161.         # Get all of the related objects we need to repoint</font>
<font color="black"> 162.         all_related_objects = (</font>
<font color="red"> 163.             f for f in model._meta.get_fields(include_hidden=True)</font>
<font color="red"> 164.             if f.auto_created and not f.concrete and (not f.hidden or f.many_to_many)</font>
<font color="black"> 165.         )</font>
<font color="black"> 166.         # Rename the model</font>
<font color="red"> 167.         state.models[app_label, self.new_name_lower] = state.models[app_label, self.old_name_lower]</font>
<font color="red"> 168.         state.models[app_label, self.new_name_lower].name = self.new_name</font>
<font color="red"> 169.         state.remove_model(app_label, self.old_name_lower)</font>
<font color="black"> 170.         # Repoint the FKs and M2Ms pointing to us</font>
<font color="red"> 171.         for related_object in all_related_objects:</font>
<font color="red"> 172.             if related_object.model is not model:</font>
<font color="black"> 173.                 # The model being renamed does not participate in this relation</font>
<font color="black"> 174.                 # directly. Rather, a superclass does.</font>
<font color="red"> 175.                 continue</font>
<font color="black"> 176.             # Use the new related key for self referential related objects.</font>
<font color="red"> 177.             if related_object.related_model == model:</font>
<font color="red"> 178.                 related_key = (app_label, self.new_name_lower)</font>
<font color="black"> 179.             else:</font>
<font color="black"> 180.                 related_key = (</font>
<font color="red"> 181.                     related_object.related_model._meta.app_label,</font>
<font color="red"> 182.                     related_object.related_model._meta.model_name,</font>
<font color="black"> 183.                 )</font>
<font color="red"> 184.             new_fields = []</font>
<font color="red"> 185.             for name, field in state.models[related_key].fields:</font>
<font color="red"> 186.                 if name == related_object.field.name:</font>
<font color="red"> 187.                     field = field.clone()</font>
<font color="red"> 188.                     field.remote_field.model = &quot;%s.%s&quot; % (app_label, self.new_name)</font>
<font color="red"> 189.                 new_fields.append((name, field))</font>
<font color="red"> 190.             state.models[related_key].fields = new_fields</font>
<font color="red"> 191.             state.reload_model(*related_key)</font>
<font color="red"> 192.         state.reload_model(app_label, self.new_name_lower)</font>
<font color="black"> 193. </font>
<font color="green"> 194.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 195.         new_model = to_state.apps.get_model(app_label, self.new_name)</font>
<font color="red"> 196.         if self.allow_migrate_model(schema_editor.connection.alias, new_model):</font>
<font color="red"> 197.             old_model = from_state.apps.get_model(app_label, self.old_name)</font>
<font color="black"> 198.             # Move the main table</font>
<font color="red"> 199.             schema_editor.alter_db_table(</font>
<font color="red"> 200.                 new_model,</font>
<font color="red"> 201.                 old_model._meta.db_table,</font>
<font color="red"> 202.                 new_model._meta.db_table,</font>
<font color="black"> 203.             )</font>
<font color="black"> 204.             # Alter the fields pointing to us</font>
<font color="red"> 205.             for related_object in old_model._meta.related_objects:</font>
<font color="red"> 206.                 if related_object.related_model == old_model:</font>
<font color="red"> 207.                     model = new_model</font>
<font color="red"> 208.                     related_key = (app_label, self.new_name_lower)</font>
<font color="black"> 209.                 else:</font>
<font color="red"> 210.                     model = related_object.related_model</font>
<font color="black"> 211.                     related_key = (</font>
<font color="red"> 212.                         related_object.related_model._meta.app_label,</font>
<font color="red"> 213.                         related_object.related_model._meta.model_name,</font>
<font color="black"> 214.                     )</font>
<font color="red"> 215.                 to_field = to_state.apps.get_model(</font>
<font color="red"> 216.                     *related_key</font>
<font color="red"> 217.                 )._meta.get_field(related_object.field.name)</font>
<font color="red"> 218.                 schema_editor.alter_field(</font>
<font color="red"> 219.                     model,</font>
<font color="red"> 220.                     related_object.field,</font>
<font color="red"> 221.                     to_field,</font>
<font color="black"> 222.                 )</font>
<font color="black"> 223.             # Rename M2M fields whose name is based on this model's name.</font>
<font color="red"> 224.             fields = zip(old_model._meta.local_many_to_many, new_model._meta.local_many_to_many)</font>
<font color="red"> 225.             for (old_field, new_field) in fields:</font>
<font color="black"> 226.                 # Skip self-referential fields as these are renamed above.</font>
<font color="red"> 227.                 if new_field.model == new_field.related_model or not new_field.remote_field.through._meta.auto_created:</font>
<font color="red"> 228.                     continue</font>
<font color="black"> 229.                 # Rename the M2M table that's based on this model's name.</font>
<font color="red"> 230.                 old_m2m_model = old_field.remote_field.through</font>
<font color="red"> 231.                 new_m2m_model = new_field.remote_field.through</font>
<font color="red"> 232.                 schema_editor.alter_db_table(</font>
<font color="red"> 233.                     new_m2m_model,</font>
<font color="red"> 234.                     old_m2m_model._meta.db_table,</font>
<font color="red"> 235.                     new_m2m_model._meta.db_table,</font>
<font color="black"> 236.                 )</font>
<font color="black"> 237.                 # Rename the column in the M2M table that's based on this</font>
<font color="black"> 238.                 # model's name.</font>
<font color="red"> 239.                 schema_editor.alter_field(</font>
<font color="red"> 240.                     new_m2m_model,</font>
<font color="red"> 241.                     old_m2m_model._meta.get_field(old_model._meta.model_name),</font>
<font color="red"> 242.                     new_m2m_model._meta.get_field(new_model._meta.model_name),</font>
<font color="black"> 243.                 )</font>
<font color="black"> 244. </font>
<font color="green"> 245.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 246.         self.new_name_lower, self.old_name_lower = self.old_name_lower, self.new_name_lower</font>
<font color="red"> 247.         self.new_name, self.old_name = self.old_name, self.new_name</font>
<font color="black"> 248. </font>
<font color="red"> 249.         self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 250. </font>
<font color="red"> 251.         self.new_name_lower, self.old_name_lower = self.old_name_lower, self.new_name_lower</font>
<font color="red"> 252.         self.new_name, self.old_name = self.old_name, self.new_name</font>
<font color="black"> 253. </font>
<font color="green"> 254.     def references_model(self, name, app_label=None):</font>
<font color="black"> 255.         return (</font>
<font color="red"> 256.             name.lower() == self.old_name_lower or</font>
<font color="red"> 257.             name.lower() == self.new_name_lower</font>
<font color="black"> 258.         )</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def describe(self):</font>
<font color="red"> 261.         return &quot;Rename model %s to %s&quot; % (self.old_name, self.new_name)</font>
<font color="black"> 262. </font>
<font color="black"> 263. </font>
<font color="green"> 264. class AlterModelTable(Operation):</font>
<font color="black"> 265.     &quot;&quot;&quot;</font>
<font color="black"> 266.     Renames a model's table</font>
<font color="green"> 267.     &quot;&quot;&quot;</font>
<font color="black"> 268. </font>
<font color="green"> 269.     def __init__(self, name, table):</font>
<font color="red"> 270.         self.name = name</font>
<font color="red"> 271.         self.table = table</font>
<font color="black"> 272. </font>
<font color="green"> 273.     @cached_property</font>
<font color="black"> 274.     def name_lower(self):</font>
<font color="red"> 275.         return self.name.lower()</font>
<font color="black"> 276. </font>
<font color="green"> 277.     def deconstruct(self):</font>
<font color="red"> 278.         kwargs = {</font>
<font color="red"> 279.             'name': self.name,</font>
<font color="red"> 280.             'table': self.table,</font>
<font color="black"> 281.         }</font>
<font color="black"> 282.         return (</font>
<font color="red"> 283.             self.__class__.__name__,</font>
<font color="red"> 284.             [],</font>
<font color="red"> 285.             kwargs</font>
<font color="black"> 286.         )</font>
<font color="black"> 287. </font>
<font color="green"> 288.     def state_forwards(self, app_label, state):</font>
<font color="red"> 289.         state.models[app_label, self.name_lower].options[&quot;db_table&quot;] = self.table</font>
<font color="red"> 290.         state.reload_model(app_label, self.name_lower)</font>
<font color="black"> 291. </font>
<font color="green"> 292.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 293.         new_model = to_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 294.         if self.allow_migrate_model(schema_editor.connection.alias, new_model):</font>
<font color="red"> 295.             old_model = from_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 296.             schema_editor.alter_db_table(</font>
<font color="red"> 297.                 new_model,</font>
<font color="red"> 298.                 old_model._meta.db_table,</font>
<font color="red"> 299.                 new_model._meta.db_table,</font>
<font color="black"> 300.             )</font>
<font color="black"> 301.             # Rename M2M fields whose name is based on this model's db_table</font>
<font color="red"> 302.             for (old_field, new_field) in zip(old_model._meta.local_many_to_many, new_model._meta.local_many_to_many):</font>
<font color="red"> 303.                 if new_field.remote_field.through._meta.auto_created:</font>
<font color="red"> 304.                     schema_editor.alter_db_table(</font>
<font color="red"> 305.                         new_field.remote_field.through,</font>
<font color="red"> 306.                         old_field.remote_field.through._meta.db_table,</font>
<font color="red"> 307.                         new_field.remote_field.through._meta.db_table,</font>
<font color="black"> 308.                     )</font>
<font color="black"> 309. </font>
<font color="green"> 310.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 311.         return self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 312. </font>
<font color="green"> 313.     def references_model(self, name, app_label=None):</font>
<font color="red"> 314.         return name.lower() == self.name_lower</font>
<font color="black"> 315. </font>
<font color="green"> 316.     def describe(self):</font>
<font color="red"> 317.         return &quot;Rename table for %s to %s&quot; % (self.name, self.table)</font>
<font color="black"> 318. </font>
<font color="black"> 319. </font>
<font color="green"> 320. class AlterUniqueTogether(Operation):</font>
<font color="black"> 321.     &quot;&quot;&quot;</font>
<font color="black"> 322.     Changes the value of unique_together to the target one.</font>
<font color="black"> 323.     Input value of unique_together must be a set of tuples.</font>
<font color="green"> 324.     &quot;&quot;&quot;</font>
<font color="green"> 325.     option_name = &quot;unique_together&quot;</font>
<font color="black"> 326. </font>
<font color="green"> 327.     def __init__(self, name, unique_together):</font>
<font color="green"> 328.         self.name = name</font>
<font color="green"> 329.         unique_together = normalize_together(unique_together)</font>
<font color="green"> 330.         self.unique_together = set(tuple(cons) for cons in unique_together)</font>
<font color="black"> 331. </font>
<font color="green"> 332.     @cached_property</font>
<font color="black"> 333.     def name_lower(self):</font>
<font color="green"> 334.         return self.name.lower()</font>
<font color="black"> 335. </font>
<font color="green"> 336.     def deconstruct(self):</font>
<font color="red"> 337.         kwargs = {</font>
<font color="red"> 338.             'name': self.name,</font>
<font color="red"> 339.             'unique_together': self.unique_together,</font>
<font color="black"> 340.         }</font>
<font color="black"> 341.         return (</font>
<font color="red"> 342.             self.__class__.__name__,</font>
<font color="red"> 343.             [],</font>
<font color="red"> 344.             kwargs</font>
<font color="black"> 345.         )</font>
<font color="black"> 346. </font>
<font color="green"> 347.     def state_forwards(self, app_label, state):</font>
<font color="green"> 348.         model_state = state.models[app_label, self.name_lower]</font>
<font color="green"> 349.         model_state.options[self.option_name] = self.unique_together</font>
<font color="green"> 350.         state.reload_model(app_label, self.name_lower)</font>
<font color="black"> 351. </font>
<font color="green"> 352.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green"> 353.         new_model = to_state.apps.get_model(app_label, self.name)</font>
<font color="green"> 354.         if self.allow_migrate_model(schema_editor.connection.alias, new_model):</font>
<font color="green"> 355.             old_model = from_state.apps.get_model(app_label, self.name)</font>
<font color="green"> 356.             schema_editor.alter_unique_together(</font>
<font color="green"> 357.                 new_model,</font>
<font color="green"> 358.                 getattr(old_model._meta, self.option_name, set()),</font>
<font color="green"> 359.                 getattr(new_model._meta, self.option_name, set()),</font>
<font color="black"> 360.             )</font>
<font color="black"> 361. </font>
<font color="green"> 362.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 363.         return self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 364. </font>
<font color="green"> 365.     def references_model(self, name, app_label=None):</font>
<font color="red"> 366.         return name.lower() == self.name_lower</font>
<font color="black"> 367. </font>
<font color="green"> 368.     def references_field(self, model_name, name, app_label=None):</font>
<font color="black"> 369.         return (</font>
<font color="red"> 370.             self.references_model(model_name, app_label) and</font>
<font color="black"> 371.             (</font>
<font color="red"> 372.                 not self.unique_together or</font>
<font color="red"> 373.                 any((name in together) for together in self.unique_together)</font>
<font color="black"> 374.             )</font>
<font color="black"> 375.         )</font>
<font color="black"> 376. </font>
<font color="green"> 377.     def describe(self):</font>
<font color="red"> 378.         return &quot;Alter %s for %s (%s constraint(s))&quot; % (self.option_name, self.name, len(self.unique_together or ''))</font>
<font color="black"> 379. </font>
<font color="black"> 380. </font>
<font color="green"> 381. class AlterIndexTogether(Operation):</font>
<font color="black"> 382.     &quot;&quot;&quot;</font>
<font color="black"> 383.     Changes the value of index_together to the target one.</font>
<font color="black"> 384.     Input value of index_together must be a set of tuples.</font>
<font color="green"> 385.     &quot;&quot;&quot;</font>
<font color="green"> 386.     option_name = &quot;index_together&quot;</font>
<font color="black"> 387. </font>
<font color="green"> 388.     def __init__(self, name, index_together):</font>
<font color="red"> 389.         self.name = name</font>
<font color="red"> 390.         index_together = normalize_together(index_together)</font>
<font color="red"> 391.         self.index_together = set(tuple(cons) for cons in index_together)</font>
<font color="black"> 392. </font>
<font color="green"> 393.     @cached_property</font>
<font color="black"> 394.     def name_lower(self):</font>
<font color="red"> 395.         return self.name.lower()</font>
<font color="black"> 396. </font>
<font color="green"> 397.     def deconstruct(self):</font>
<font color="red"> 398.         kwargs = {</font>
<font color="red"> 399.             'name': self.name,</font>
<font color="red"> 400.             'index_together': self.index_together,</font>
<font color="black"> 401.         }</font>
<font color="black"> 402.         return (</font>
<font color="red"> 403.             self.__class__.__name__,</font>
<font color="red"> 404.             [],</font>
<font color="red"> 405.             kwargs</font>
<font color="black"> 406.         )</font>
<font color="black"> 407. </font>
<font color="green"> 408.     def state_forwards(self, app_label, state):</font>
<font color="red"> 409.         model_state = state.models[app_label, self.name_lower]</font>
<font color="red"> 410.         model_state.options[self.option_name] = self.index_together</font>
<font color="red"> 411.         state.reload_model(app_label, self.name_lower)</font>
<font color="black"> 412. </font>
<font color="green"> 413.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 414.         new_model = to_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 415.         if self.allow_migrate_model(schema_editor.connection.alias, new_model):</font>
<font color="red"> 416.             old_model = from_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 417.             schema_editor.alter_index_together(</font>
<font color="red"> 418.                 new_model,</font>
<font color="red"> 419.                 getattr(old_model._meta, self.option_name, set()),</font>
<font color="red"> 420.                 getattr(new_model._meta, self.option_name, set()),</font>
<font color="black"> 421.             )</font>
<font color="black"> 422. </font>
<font color="green"> 423.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 424.         return self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 425. </font>
<font color="green"> 426.     def references_model(self, name, app_label=None):</font>
<font color="red"> 427.         return name.lower() == self.name_lower</font>
<font color="black"> 428. </font>
<font color="green"> 429.     def references_field(self, model_name, name, app_label=None):</font>
<font color="black"> 430.         return (</font>
<font color="red"> 431.             self.references_model(model_name, app_label) and</font>
<font color="black"> 432.             (</font>
<font color="red"> 433.                 not self.index_together or</font>
<font color="red"> 434.                 any((name in together) for together in self.index_together)</font>
<font color="black"> 435.             )</font>
<font color="black"> 436.         )</font>
<font color="black"> 437. </font>
<font color="green"> 438.     def describe(self):</font>
<font color="red"> 439.         return &quot;Alter %s for %s (%s constraint(s))&quot; % (self.option_name, self.name, len(self.index_together or ''))</font>
<font color="black"> 440. </font>
<font color="black"> 441. </font>
<font color="green"> 442. class AlterOrderWithRespectTo(Operation):</font>
<font color="black"> 443.     &quot;&quot;&quot;</font>
<font color="black"> 444.     Represents a change with the order_with_respect_to option.</font>
<font color="green"> 445.     &quot;&quot;&quot;</font>
<font color="black"> 446. </font>
<font color="green"> 447.     def __init__(self, name, order_with_respect_to):</font>
<font color="red"> 448.         self.name = name</font>
<font color="red"> 449.         self.order_with_respect_to = order_with_respect_to</font>
<font color="black"> 450. </font>
<font color="green"> 451.     @cached_property</font>
<font color="black"> 452.     def name_lower(self):</font>
<font color="red"> 453.         return self.name.lower()</font>
<font color="black"> 454. </font>
<font color="green"> 455.     def deconstruct(self):</font>
<font color="red"> 456.         kwargs = {</font>
<font color="red"> 457.             'name': self.name,</font>
<font color="red"> 458.             'order_with_respect_to': self.order_with_respect_to,</font>
<font color="black"> 459.         }</font>
<font color="black"> 460.         return (</font>
<font color="red"> 461.             self.__class__.__name__,</font>
<font color="red"> 462.             [],</font>
<font color="red"> 463.             kwargs</font>
<font color="black"> 464.         )</font>
<font color="black"> 465. </font>
<font color="green"> 466.     def state_forwards(self, app_label, state):</font>
<font color="red"> 467.         model_state = state.models[app_label, self.name_lower]</font>
<font color="red"> 468.         model_state.options['order_with_respect_to'] = self.order_with_respect_to</font>
<font color="red"> 469.         state.reload_model(app_label, self.name_lower)</font>
<font color="black"> 470. </font>
<font color="green"> 471.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 472.         to_model = to_state.apps.get_model(app_label, self.name)</font>
<font color="red"> 473.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="red"> 474.             from_model = from_state.apps.get_model(app_label, self.name)</font>
<font color="black"> 475.             # Remove a field if we need to</font>
<font color="red"> 476.             if from_model._meta.order_with_respect_to and not to_model._meta.order_with_respect_to:</font>
<font color="red"> 477.                 schema_editor.remove_field(from_model, from_model._meta.get_field(&quot;_order&quot;))</font>
<font color="black"> 478.             # Add a field if we need to (altering the column is untouched as</font>
<font color="black"> 479.             # it's likely a rename)</font>
<font color="red"> 480.             elif to_model._meta.order_with_respect_to and not from_model._meta.order_with_respect_to:</font>
<font color="red"> 481.                 field = to_model._meta.get_field(&quot;_order&quot;)</font>
<font color="red"> 482.                 if not field.has_default():</font>
<font color="red"> 483.                     field.default = 0</font>
<font color="red"> 484.                 schema_editor.add_field(</font>
<font color="red"> 485.                     from_model,</font>
<font color="red"> 486.                     field,</font>
<font color="black"> 487.                 )</font>
<font color="black"> 488. </font>
<font color="green"> 489.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 490.         self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 491. </font>
<font color="green"> 492.     def references_model(self, name, app_label=None):</font>
<font color="red"> 493.         return name.lower() == self.name_lower</font>
<font color="black"> 494. </font>
<font color="green"> 495.     def references_field(self, model_name, name, app_label=None):</font>
<font color="black"> 496.         return (</font>
<font color="red"> 497.             self.references_model(model_name, app_label) and</font>
<font color="black"> 498.             (</font>
<font color="red"> 499.                 self.order_with_respect_to is None or</font>
<font color="red"> 500.                 name == self.order_with_respect_to</font>
<font color="black"> 501.             )</font>
<font color="black"> 502.         )</font>
<font color="black"> 503. </font>
<font color="green"> 504.     def describe(self):</font>
<font color="red"> 505.         return &quot;Set order_with_respect_to on %s to %s&quot; % (self.name, self.order_with_respect_to)</font>
<font color="black"> 506. </font>
<font color="black"> 507. </font>
<font color="green"> 508. class AlterModelOptions(Operation):</font>
<font color="black"> 509.     &quot;&quot;&quot;</font>
<font color="black"> 510.     Sets new model options that don't directly affect the database schema</font>
<font color="black"> 511.     (like verbose_name, permissions, ordering). Python code in migrations</font>
<font color="black"> 512.     may still need them.</font>
<font color="green"> 513.     &quot;&quot;&quot;</font>
<font color="black"> 514. </font>
<font color="black"> 515.     # Model options we want to compare and preserve in an AlterModelOptions op</font>
<font color="black"> 516.     ALTER_OPTION_KEYS = [</font>
<font color="green"> 517.         &quot;get_latest_by&quot;,</font>
<font color="green"> 518.         &quot;managed&quot;,</font>
<font color="green"> 519.         &quot;ordering&quot;,</font>
<font color="green"> 520.         &quot;permissions&quot;,</font>
<font color="green"> 521.         &quot;default_permissions&quot;,</font>
<font color="green"> 522.         &quot;select_on_save&quot;,</font>
<font color="green"> 523.         &quot;verbose_name&quot;,</font>
<font color="green"> 524.         &quot;verbose_name_plural&quot;,</font>
<font color="black"> 525.     ]</font>
<font color="black"> 526. </font>
<font color="green"> 527.     def __init__(self, name, options):</font>
<font color="green"> 528.         self.name = name</font>
<font color="green"> 529.         self.options = options</font>
<font color="black"> 530. </font>
<font color="green"> 531.     @cached_property</font>
<font color="black"> 532.     def name_lower(self):</font>
<font color="green"> 533.         return self.name.lower()</font>
<font color="black"> 534. </font>
<font color="green"> 535.     def deconstruct(self):</font>
<font color="red"> 536.         kwargs = {</font>
<font color="red"> 537.             'name': self.name,</font>
<font color="red"> 538.             'options': self.options,</font>
<font color="black"> 539.         }</font>
<font color="black"> 540.         return (</font>
<font color="red"> 541.             self.__class__.__name__,</font>
<font color="red"> 542.             [],</font>
<font color="red"> 543.             kwargs</font>
<font color="black"> 544.         )</font>
<font color="black"> 545. </font>
<font color="green"> 546.     def state_forwards(self, app_label, state):</font>
<font color="green"> 547.         model_state = state.models[app_label, self.name_lower]</font>
<font color="green"> 548.         model_state.options = dict(model_state.options)</font>
<font color="green"> 549.         model_state.options.update(self.options)</font>
<font color="green"> 550.         for key in self.ALTER_OPTION_KEYS:</font>
<font color="green"> 551.             if key not in self.options and key in model_state.options:</font>
<font color="green"> 552.                 del model_state.options[key]</font>
<font color="green"> 553.         state.reload_model(app_label, self.name_lower)</font>
<font color="black"> 554. </font>
<font color="green"> 555.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green"> 556.         pass</font>
<font color="black"> 557. </font>
<font color="green"> 558.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 559.         pass</font>
<font color="black"> 560. </font>
<font color="green"> 561.     def references_model(self, name, app_label=None):</font>
<font color="red"> 562.         return name.lower() == self.name_lower</font>
<font color="black"> 563. </font>
<font color="green"> 564.     def describe(self):</font>
<font color="red"> 565.         return &quot;Change Meta options on %s&quot; % (self.name, )</font>
<font color="black"> 566. </font>
<font color="black"> 567. </font>
<font color="green"> 568. class AlterModelManagers(Operation):</font>
<font color="black"> 569.     &quot;&quot;&quot;</font>
<font color="black"> 570.     Alters the model's managers</font>
<font color="green"> 571.     &quot;&quot;&quot;</font>
<font color="black"> 572. </font>
<font color="green"> 573.     serialization_expand_args = ['managers']</font>
<font color="black"> 574. </font>
<font color="green"> 575.     def __init__(self, name, managers):</font>
<font color="red"> 576.         self.name = name</font>
<font color="red"> 577.         self.managers = managers</font>
<font color="black"> 578. </font>
<font color="green"> 579.     @cached_property</font>
<font color="black"> 580.     def name_lower(self):</font>
<font color="red"> 581.         return self.name.lower()</font>
<font color="black"> 582. </font>
<font color="green"> 583.     def deconstruct(self):</font>
<font color="black"> 584.         return (</font>
<font color="red"> 585.             self.__class__.__name__,</font>
<font color="red"> 586.             [self.name, self.managers],</font>
<font color="red"> 587.             {}</font>
<font color="black"> 588.         )</font>
<font color="black"> 589. </font>
<font color="green"> 590.     def state_forwards(self, app_label, state):</font>
<font color="red"> 591.         model_state = state.models[app_label, self.name_lower]</font>
<font color="red"> 592.         model_state.managers = list(self.managers)</font>
<font color="black"> 593. </font>
<font color="green"> 594.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 595.         pass</font>
<font color="black"> 596. </font>
<font color="green"> 597.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 598.         pass</font>
<font color="black"> 599. </font>
<font color="green"> 600.     def references_model(self, name, app_label=None):</font>
<font color="red"> 601.         return name.lower() == self.name_lower</font>
<font color="black"> 602. </font>
<font color="green"> 603.     def describe(self):</font>
<font color="red"> 604.         return &quot;Change managers on %s&quot; % (self.name, )</font>
</pre>


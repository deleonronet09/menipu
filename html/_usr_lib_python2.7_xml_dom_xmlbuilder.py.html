source file: <b>/usr/lib/python2.7/xml/dom/xmlbuilder.py</b><br>


file stats: <b>266 lines, 136 executed: 51.1% covered</b>
<pre>
<font color="green">   1. &quot;&quot;&quot;Implementation of the DOM Level 3 'LS-Load' feature.&quot;&quot;&quot;</font>
<font color="black">   2. </font>
<font color="green">   3. import copy</font>
<font color="green">   4. import xml.dom</font>
<font color="black">   5. </font>
<font color="green">   6. from xml.dom.NodeFilter import NodeFilter</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="green">   9. __all__ = [&quot;DOMBuilder&quot;, &quot;DOMEntityResolver&quot;, &quot;DOMInputSource&quot;]</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. class Options:</font>
<font color="black">  13.     &quot;&quot;&quot;Features object that has variables set for each DOMBuilder feature.</font>
<font color="black">  14. </font>
<font color="black">  15.     The DOMBuilder class uses an instance of this class to pass settings to</font>
<font color="black">  16.     the ExpatBuilder class.</font>
<font color="green">  17.     &quot;&quot;&quot;</font>
<font color="black">  18. </font>
<font color="black">  19.     # Note that the DOMBuilder class in LoadSave constrains which of these</font>
<font color="black">  20.     # values can be set using the DOM Level 3 LoadSave feature.</font>
<font color="black">  21. </font>
<font color="green">  22.     namespaces = 1</font>
<font color="green">  23.     namespace_declarations = True</font>
<font color="green">  24.     validation = False</font>
<font color="green">  25.     external_parameter_entities = True</font>
<font color="green">  26.     external_general_entities = True</font>
<font color="green">  27.     external_dtd_subset = True</font>
<font color="green">  28.     validate_if_schema = False</font>
<font color="green">  29.     validate = False</font>
<font color="green">  30.     datatype_normalization = False</font>
<font color="green">  31.     create_entity_ref_nodes = True</font>
<font color="green">  32.     entities = True</font>
<font color="green">  33.     whitespace_in_element_content = True</font>
<font color="green">  34.     cdata_sections = True</font>
<font color="green">  35.     comments = True</font>
<font color="green">  36.     charset_overrides_xml_encoding = True</font>
<font color="green">  37.     infoset = False</font>
<font color="green">  38.     supported_mediatypes_only = False</font>
<font color="black">  39. </font>
<font color="green">  40.     errorHandler = None</font>
<font color="green">  41.     filter = None</font>
<font color="black">  42. </font>
<font color="black">  43. </font>
<font color="green">  44. class DOMBuilder:</font>
<font color="green">  45.     entityResolver = None</font>
<font color="green">  46.     errorHandler = None</font>
<font color="green">  47.     filter = None</font>
<font color="black">  48. </font>
<font color="green">  49.     ACTION_REPLACE = 1</font>
<font color="green">  50.     ACTION_APPEND_AS_CHILDREN = 2</font>
<font color="green">  51.     ACTION_INSERT_AFTER = 3</font>
<font color="green">  52.     ACTION_INSERT_BEFORE = 4</font>
<font color="black">  53. </font>
<font color="green">  54.     _legal_actions = (ACTION_REPLACE, ACTION_APPEND_AS_CHILDREN,</font>
<font color="green">  55.                       ACTION_INSERT_AFTER, ACTION_INSERT_BEFORE)</font>
<font color="black">  56. </font>
<font color="green">  57.     def __init__(self):</font>
<font color="red">  58.         self._options = Options()</font>
<font color="black">  59. </font>
<font color="green">  60.     def _get_entityResolver(self):</font>
<font color="red">  61.         return self.entityResolver</font>
<font color="green">  62.     def _set_entityResolver(self, entityResolver):</font>
<font color="red">  63.         self.entityResolver = entityResolver</font>
<font color="black">  64. </font>
<font color="green">  65.     def _get_errorHandler(self):</font>
<font color="red">  66.         return self.errorHandler</font>
<font color="green">  67.     def _set_errorHandler(self, errorHandler):</font>
<font color="red">  68.         self.errorHandler = errorHandler</font>
<font color="black">  69. </font>
<font color="green">  70.     def _get_filter(self):</font>
<font color="red">  71.         return self.filter</font>
<font color="green">  72.     def _set_filter(self, filter):</font>
<font color="red">  73.         self.filter = filter</font>
<font color="black">  74. </font>
<font color="green">  75.     def setFeature(self, name, state):</font>
<font color="red">  76.         if self.supportsFeature(name):</font>
<font color="red">  77.             state = state and 1 or 0</font>
<font color="red">  78.             try:</font>
<font color="red">  79.                 settings = self._settings[(_name_xform(name), state)]</font>
<font color="red">  80.             except KeyError:</font>
<font color="red">  81.                 raise xml.dom.NotSupportedErr(</font>
<font color="red">  82.                     &quot;unsupported feature: %r&quot; % (name,))</font>
<font color="black">  83.             else:</font>
<font color="red">  84.                 for name, value in settings:</font>
<font color="red">  85.                     setattr(self._options, name, value)</font>
<font color="black">  86.         else:</font>
<font color="red">  87.             raise xml.dom.NotFoundErr(&quot;unknown feature: &quot; + repr(name))</font>
<font color="black">  88. </font>
<font color="green">  89.     def supportsFeature(self, name):</font>
<font color="red">  90.         return hasattr(self._options, _name_xform(name))</font>
<font color="black">  91. </font>
<font color="green">  92.     def canSetFeature(self, name, state):</font>
<font color="red">  93.         key = (_name_xform(name), state and 1 or 0)</font>
<font color="red">  94.         return key in self._settings</font>
<font color="black">  95. </font>
<font color="black">  96.     # This dictionary maps from (feature,value) to a list of</font>
<font color="black">  97.     # (option,value) pairs that should be set on the Options object.</font>
<font color="black">  98.     # If a (feature,value) setting is not in this dictionary, it is</font>
<font color="black">  99.     # not supported by the DOMBuilder.</font>
<font color="black"> 100.     #</font>
<font color="green"> 101.     _settings = {</font>
<font color="black"> 102.         (&quot;namespace_declarations&quot;, 0): [</font>
<font color="green"> 103.             (&quot;namespace_declarations&quot;, 0)],</font>
<font color="black"> 104.         (&quot;namespace_declarations&quot;, 1): [</font>
<font color="green"> 105.             (&quot;namespace_declarations&quot;, 1)],</font>
<font color="black"> 106.         (&quot;validation&quot;, 0): [</font>
<font color="green"> 107.             (&quot;validation&quot;, 0)],</font>
<font color="black"> 108.         (&quot;external_general_entities&quot;, 0): [</font>
<font color="green"> 109.             (&quot;external_general_entities&quot;, 0)],</font>
<font color="black"> 110.         (&quot;external_general_entities&quot;, 1): [</font>
<font color="green"> 111.             (&quot;external_general_entities&quot;, 1)],</font>
<font color="black"> 112.         (&quot;external_parameter_entities&quot;, 0): [</font>
<font color="green"> 113.             (&quot;external_parameter_entities&quot;, 0)],</font>
<font color="black"> 114.         (&quot;external_parameter_entities&quot;, 1): [</font>
<font color="green"> 115.             (&quot;external_parameter_entities&quot;, 1)],</font>
<font color="black"> 116.         (&quot;validate_if_schema&quot;, 0): [</font>
<font color="green"> 117.             (&quot;validate_if_schema&quot;, 0)],</font>
<font color="black"> 118.         (&quot;create_entity_ref_nodes&quot;, 0): [</font>
<font color="green"> 119.             (&quot;create_entity_ref_nodes&quot;, 0)],</font>
<font color="black"> 120.         (&quot;create_entity_ref_nodes&quot;, 1): [</font>
<font color="green"> 121.             (&quot;create_entity_ref_nodes&quot;, 1)],</font>
<font color="black"> 122.         (&quot;entities&quot;, 0): [</font>
<font color="green"> 123.             (&quot;create_entity_ref_nodes&quot;, 0),</font>
<font color="green"> 124.             (&quot;entities&quot;, 0)],</font>
<font color="black"> 125.         (&quot;entities&quot;, 1): [</font>
<font color="green"> 126.             (&quot;entities&quot;, 1)],</font>
<font color="black"> 127.         (&quot;whitespace_in_element_content&quot;, 0): [</font>
<font color="green"> 128.             (&quot;whitespace_in_element_content&quot;, 0)],</font>
<font color="black"> 129.         (&quot;whitespace_in_element_content&quot;, 1): [</font>
<font color="green"> 130.             (&quot;whitespace_in_element_content&quot;, 1)],</font>
<font color="black"> 131.         (&quot;cdata_sections&quot;, 0): [</font>
<font color="green"> 132.             (&quot;cdata_sections&quot;, 0)],</font>
<font color="black"> 133.         (&quot;cdata_sections&quot;, 1): [</font>
<font color="green"> 134.             (&quot;cdata_sections&quot;, 1)],</font>
<font color="black"> 135.         (&quot;comments&quot;, 0): [</font>
<font color="green"> 136.             (&quot;comments&quot;, 0)],</font>
<font color="black"> 137.         (&quot;comments&quot;, 1): [</font>
<font color="green"> 138.             (&quot;comments&quot;, 1)],</font>
<font color="black"> 139.         (&quot;charset_overrides_xml_encoding&quot;, 0): [</font>
<font color="green"> 140.             (&quot;charset_overrides_xml_encoding&quot;, 0)],</font>
<font color="black"> 141.         (&quot;charset_overrides_xml_encoding&quot;, 1): [</font>
<font color="green"> 142.             (&quot;charset_overrides_xml_encoding&quot;, 1)],</font>
<font color="green"> 143.         (&quot;infoset&quot;, 0): [],</font>
<font color="black"> 144.         (&quot;infoset&quot;, 1): [</font>
<font color="green"> 145.             (&quot;namespace_declarations&quot;, 0),</font>
<font color="green"> 146.             (&quot;validate_if_schema&quot;, 0),</font>
<font color="green"> 147.             (&quot;create_entity_ref_nodes&quot;, 0),</font>
<font color="green"> 148.             (&quot;entities&quot;, 0),</font>
<font color="green"> 149.             (&quot;cdata_sections&quot;, 0),</font>
<font color="green"> 150.             (&quot;datatype_normalization&quot;, 1),</font>
<font color="green"> 151.             (&quot;whitespace_in_element_content&quot;, 1),</font>
<font color="green"> 152.             (&quot;comments&quot;, 1),</font>
<font color="green"> 153.             (&quot;charset_overrides_xml_encoding&quot;, 1)],</font>
<font color="black"> 154.         (&quot;supported_mediatypes_only&quot;, 0): [</font>
<font color="green"> 155.             (&quot;supported_mediatypes_only&quot;, 0)],</font>
<font color="black"> 156.         (&quot;namespaces&quot;, 0): [</font>
<font color="green"> 157.             (&quot;namespaces&quot;, 0)],</font>
<font color="black"> 158.         (&quot;namespaces&quot;, 1): [</font>
<font color="green"> 159.             (&quot;namespaces&quot;, 1)],</font>
<font color="black"> 160.     }</font>
<font color="black"> 161. </font>
<font color="green"> 162.     def getFeature(self, name):</font>
<font color="red"> 163.         xname = _name_xform(name)</font>
<font color="red"> 164.         try:</font>
<font color="red"> 165.             return getattr(self._options, xname)</font>
<font color="red"> 166.         except AttributeError:</font>
<font color="red"> 167.             if name == &quot;infoset&quot;:</font>
<font color="red"> 168.                 options = self._options</font>
<font color="red"> 169.                 return (options.datatype_normalization</font>
<font color="red"> 170.                         and options.whitespace_in_element_content</font>
<font color="red"> 171.                         and options.comments</font>
<font color="red"> 172.                         and options.charset_overrides_xml_encoding</font>
<font color="red"> 173.                         and not (options.namespace_declarations</font>
<font color="red"> 174.                                  or options.validate_if_schema</font>
<font color="red"> 175.                                  or options.create_entity_ref_nodes</font>
<font color="red"> 176.                                  or options.entities</font>
<font color="red"> 177.                                  or options.cdata_sections))</font>
<font color="red"> 178.             raise xml.dom.NotFoundErr(&quot;feature %s not known&quot; % repr(name))</font>
<font color="black"> 179. </font>
<font color="green"> 180.     def parseURI(self, uri):</font>
<font color="red"> 181.         if self.entityResolver:</font>
<font color="red"> 182.             input = self.entityResolver.resolveEntity(None, uri)</font>
<font color="black"> 183.         else:</font>
<font color="red"> 184.             input = DOMEntityResolver().resolveEntity(None, uri)</font>
<font color="red"> 185.         return self.parse(input)</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def parse(self, input):</font>
<font color="red"> 188.         options = copy.copy(self._options)</font>
<font color="red"> 189.         options.filter = self.filter</font>
<font color="red"> 190.         options.errorHandler = self.errorHandler</font>
<font color="red"> 191.         fp = input.byteStream</font>
<font color="red"> 192.         if fp is None and options.systemId:</font>
<font color="red"> 193.             import urllib2</font>
<font color="red"> 194.             fp = urllib2.urlopen(input.systemId)</font>
<font color="red"> 195.         return self._parse_bytestream(fp, options)</font>
<font color="black"> 196. </font>
<font color="green"> 197.     def parseWithContext(self, input, cnode, action):</font>
<font color="red"> 198.         if action not in self._legal_actions:</font>
<font color="red"> 199.             raise ValueError(&quot;not a legal action&quot;)</font>
<font color="red"> 200.         raise NotImplementedError(&quot;Haven't written this yet...&quot;)</font>
<font color="black"> 201. </font>
<font color="green"> 202.     def _parse_bytestream(self, stream, options):</font>
<font color="red"> 203.         import xml.dom.expatbuilder</font>
<font color="red"> 204.         builder = xml.dom.expatbuilder.makeBuilder(options)</font>
<font color="red"> 205.         return builder.parseFile(stream)</font>
<font color="black"> 206. </font>
<font color="black"> 207. </font>
<font color="green"> 208. def _name_xform(name):</font>
<font color="red"> 209.     return name.lower().replace('-', '_')</font>
<font color="black"> 210. </font>
<font color="black"> 211. </font>
<font color="green"> 212. class DOMEntityResolver(object):</font>
<font color="green"> 213.     __slots__ = '_opener',</font>
<font color="black"> 214. </font>
<font color="green"> 215.     def resolveEntity(self, publicId, systemId):</font>
<font color="red"> 216.         assert systemId is not None</font>
<font color="red"> 217.         source = DOMInputSource()</font>
<font color="red"> 218.         source.publicId = publicId</font>
<font color="red"> 219.         source.systemId = systemId</font>
<font color="red"> 220.         source.byteStream = self._get_opener().open(systemId)</font>
<font color="black"> 221. </font>
<font color="black"> 222.         # determine the encoding if the transport provided it</font>
<font color="red"> 223.         source.encoding = self._guess_media_encoding(source)</font>
<font color="black"> 224. </font>
<font color="black"> 225.         # determine the base URI is we can</font>
<font color="red"> 226.         import posixpath, urlparse</font>
<font color="red"> 227.         parts = urlparse.urlparse(systemId)</font>
<font color="red"> 228.         scheme, netloc, path, params, query, fragment = parts</font>
<font color="black"> 229.         # XXX should we check the scheme here as well?</font>
<font color="red"> 230.         if path and not path.endswith(&quot;/&quot;):</font>
<font color="red"> 231.             path = posixpath.dirname(path) + &quot;/&quot;</font>
<font color="red"> 232.             parts = scheme, netloc, path, params, query, fragment</font>
<font color="red"> 233.             source.baseURI = urlparse.urlunparse(parts)</font>
<font color="black"> 234. </font>
<font color="red"> 235.         return source</font>
<font color="black"> 236. </font>
<font color="green"> 237.     def _get_opener(self):</font>
<font color="red"> 238.         try:</font>
<font color="red"> 239.             return self._opener</font>
<font color="red"> 240.         except AttributeError:</font>
<font color="red"> 241.             self._opener = self._create_opener()</font>
<font color="red"> 242.             return self._opener</font>
<font color="black"> 243. </font>
<font color="green"> 244.     def _create_opener(self):</font>
<font color="red"> 245.         import urllib2</font>
<font color="red"> 246.         return urllib2.build_opener()</font>
<font color="black"> 247. </font>
<font color="green"> 248.     def _guess_media_encoding(self, source):</font>
<font color="red"> 249.         info = source.byteStream.info()</font>
<font color="red"> 250.         if &quot;Content-Type&quot; in info:</font>
<font color="red"> 251.             for param in info.getplist():</font>
<font color="red"> 252.                 if param.startswith(&quot;charset=&quot;):</font>
<font color="red"> 253.                     return param.split(&quot;=&quot;, 1)[1].lower()</font>
<font color="black"> 254. </font>
<font color="black"> 255. </font>
<font color="green"> 256. class DOMInputSource(object):</font>
<font color="black"> 257.     __slots__ = ('byteStream', 'characterStream', 'stringData',</font>
<font color="green"> 258.                  'encoding', 'publicId', 'systemId', 'baseURI')</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def __init__(self):</font>
<font color="red"> 261.         self.byteStream = None</font>
<font color="red"> 262.         self.characterStream = None</font>
<font color="red"> 263.         self.stringData = None</font>
<font color="red"> 264.         self.encoding = None</font>
<font color="red"> 265.         self.publicId = None</font>
<font color="red"> 266.         self.systemId = None</font>
<font color="red"> 267.         self.baseURI = None</font>
<font color="black"> 268. </font>
<font color="green"> 269.     def _get_byteStream(self):</font>
<font color="red"> 270.         return self.byteStream</font>
<font color="green"> 271.     def _set_byteStream(self, byteStream):</font>
<font color="red"> 272.         self.byteStream = byteStream</font>
<font color="black"> 273. </font>
<font color="green"> 274.     def _get_characterStream(self):</font>
<font color="red"> 275.         return self.characterStream</font>
<font color="green"> 276.     def _set_characterStream(self, characterStream):</font>
<font color="red"> 277.         self.characterStream = characterStream</font>
<font color="black"> 278. </font>
<font color="green"> 279.     def _get_stringData(self):</font>
<font color="red"> 280.         return self.stringData</font>
<font color="green"> 281.     def _set_stringData(self, data):</font>
<font color="red"> 282.         self.stringData = data</font>
<font color="black"> 283. </font>
<font color="green"> 284.     def _get_encoding(self):</font>
<font color="red"> 285.         return self.encoding</font>
<font color="green"> 286.     def _set_encoding(self, encoding):</font>
<font color="red"> 287.         self.encoding = encoding</font>
<font color="black"> 288. </font>
<font color="green"> 289.     def _get_publicId(self):</font>
<font color="red"> 290.         return self.publicId</font>
<font color="green"> 291.     def _set_publicId(self, publicId):</font>
<font color="red"> 292.         self.publicId = publicId</font>
<font color="black"> 293. </font>
<font color="green"> 294.     def _get_systemId(self):</font>
<font color="red"> 295.         return self.systemId</font>
<font color="green"> 296.     def _set_systemId(self, systemId):</font>
<font color="red"> 297.         self.systemId = systemId</font>
<font color="black"> 298. </font>
<font color="green"> 299.     def _get_baseURI(self):</font>
<font color="red"> 300.         return self.baseURI</font>
<font color="green"> 301.     def _set_baseURI(self, uri):</font>
<font color="red"> 302.         self.baseURI = uri</font>
<font color="black"> 303. </font>
<font color="black"> 304. </font>
<font color="green"> 305. class DOMBuilderFilter:</font>
<font color="black"> 306.     &quot;&quot;&quot;Element filter which can be used to tailor construction of</font>
<font color="black"> 307.     a DOM instance.</font>
<font color="green"> 308.     &quot;&quot;&quot;</font>
<font color="black"> 309. </font>
<font color="black"> 310.     # There's really no need for this class; concrete implementations</font>
<font color="black"> 311.     # should just implement the endElement() and startElement()</font>
<font color="black"> 312.     # methods as appropriate.  Using this makes it easy to only</font>
<font color="black"> 313.     # implement one of them.</font>
<font color="black"> 314. </font>
<font color="green"> 315.     FILTER_ACCEPT = 1</font>
<font color="green"> 316.     FILTER_REJECT = 2</font>
<font color="green"> 317.     FILTER_SKIP = 3</font>
<font color="green"> 318.     FILTER_INTERRUPT = 4</font>
<font color="black"> 319. </font>
<font color="green"> 320.     whatToShow = NodeFilter.SHOW_ALL</font>
<font color="black"> 321. </font>
<font color="green"> 322.     def _get_whatToShow(self):</font>
<font color="red"> 323.         return self.whatToShow</font>
<font color="black"> 324. </font>
<font color="green"> 325.     def acceptNode(self, element):</font>
<font color="red"> 326.         return self.FILTER_ACCEPT</font>
<font color="black"> 327. </font>
<font color="green"> 328.     def startContainer(self, element):</font>
<font color="red"> 329.         return self.FILTER_ACCEPT</font>
<font color="black"> 330. </font>
<font color="green"> 331. del NodeFilter</font>
<font color="black"> 332. </font>
<font color="black"> 333. </font>
<font color="green"> 334. class DocumentLS:</font>
<font color="green"> 335.     &quot;&quot;&quot;Mixin to create documents that conform to the load/save spec.&quot;&quot;&quot;</font>
<font color="black"> 336. </font>
<font color="green"> 337.     async = False</font>
<font color="black"> 338. </font>
<font color="green"> 339.     def _get_async(self):</font>
<font color="red"> 340.         return False</font>
<font color="green"> 341.     def _set_async(self, async):</font>
<font color="red"> 342.         if async:</font>
<font color="red"> 343.             raise xml.dom.NotSupportedErr(</font>
<font color="red"> 344.                 &quot;asynchronous document loading is not supported&quot;)</font>
<font color="black"> 345. </font>
<font color="green"> 346.     def abort(self):</font>
<font color="black"> 347.         # What does it mean to &quot;clear&quot; a document?  Does the</font>
<font color="black"> 348.         # documentElement disappear?</font>
<font color="red"> 349.         raise NotImplementedError(</font>
<font color="red"> 350.             &quot;haven't figured out what this means yet&quot;)</font>
<font color="black"> 351. </font>
<font color="green"> 352.     def load(self, uri):</font>
<font color="red"> 353.         raise NotImplementedError(&quot;haven't written this yet&quot;)</font>
<font color="black"> 354. </font>
<font color="green"> 355.     def loadXML(self, source):</font>
<font color="red"> 356.         raise NotImplementedError(&quot;haven't written this yet&quot;)</font>
<font color="black"> 357. </font>
<font color="green"> 358.     def saveXML(self, snode):</font>
<font color="red"> 359.         if snode is None:</font>
<font color="red"> 360.             snode = self</font>
<font color="red"> 361.         elif snode.ownerDocument is not self:</font>
<font color="red"> 362.             raise xml.dom.WrongDocumentErr()</font>
<font color="red"> 363.         return snode.toxml()</font>
<font color="black"> 364. </font>
<font color="black"> 365. </font>
<font color="green"> 366. class DOMImplementationLS:</font>
<font color="green"> 367.     MODE_SYNCHRONOUS = 1</font>
<font color="green"> 368.     MODE_ASYNCHRONOUS = 2</font>
<font color="black"> 369. </font>
<font color="green"> 370.     def createDOMBuilder(self, mode, schemaType):</font>
<font color="red"> 371.         if schemaType is not None:</font>
<font color="red"> 372.             raise xml.dom.NotSupportedErr(</font>
<font color="red"> 373.                 &quot;schemaType not yet supported&quot;)</font>
<font color="red"> 374.         if mode == self.MODE_SYNCHRONOUS:</font>
<font color="red"> 375.             return DOMBuilder()</font>
<font color="red"> 376.         if mode == self.MODE_ASYNCHRONOUS:</font>
<font color="red"> 377.             raise xml.dom.NotSupportedErr(</font>
<font color="red"> 378.                 &quot;asynchronous builders are not supported&quot;)</font>
<font color="red"> 379.         raise ValueError(&quot;unknown value for mode&quot;)</font>
<font color="black"> 380. </font>
<font color="green"> 381.     def createDOMWriter(self):</font>
<font color="red"> 382.         raise NotImplementedError(</font>
<font color="red"> 383.             &quot;the writer interface hasn't been written yet!&quot;)</font>
<font color="black"> 384. </font>
<font color="green"> 385.     def createDOMInputSource(self):</font>
<font color="red"> 386.         return DOMInputSource()</font>
</pre>


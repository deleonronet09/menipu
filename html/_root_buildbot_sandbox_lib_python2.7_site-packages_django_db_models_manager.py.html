source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/models/manager.py</b><br>


file stats: <b>169 lines, 137 executed: 81.1% covered</b>
<pre>
<font color="green">   1. import copy</font>
<font color="green">   2. import inspect</font>
<font color="green">   3. from importlib import import_module</font>
<font color="black">   4. </font>
<font color="green">   5. from django.db import router</font>
<font color="green">   6. from django.db.models.query import QuerySet</font>
<font color="green">   7. from django.utils import six</font>
<font color="green">   8. from django.utils.encoding import python_2_unicode_compatible</font>
<font color="black">   9. </font>
<font color="black">  10. </font>
<font color="green">  11. def ensure_default_manager(cls):</font>
<font color="black">  12.     &quot;&quot;&quot;</font>
<font color="black">  13.     Ensures that a Model subclass contains a default manager  and sets the</font>
<font color="black">  14.     _default_manager attribute on the class. Also sets up the _base_manager</font>
<font color="black">  15.     points to a plain Manager instance (which could be the same as</font>
<font color="black">  16.     _default_manager if it's not a subclass of Manager).</font>
<font color="black">  17.     &quot;&quot;&quot;</font>
<font color="green">  18.     if cls._meta.swapped:</font>
<font color="red">  19.         setattr(cls, 'objects', SwappedManagerDescriptor(cls))</font>
<font color="red">  20.         return</font>
<font color="green">  21.     if not getattr(cls, '_default_manager', None):</font>
<font color="green">  22.         if any(f.name == 'objects' for f in cls._meta.fields):</font>
<font color="red">  23.             raise ValueError(</font>
<font color="red">  24.                 &quot;Model %s must specify a custom Manager, because it has a &quot;</font>
<font color="red">  25.                 &quot;field named 'objects'&quot; % cls.__name__</font>
<font color="black">  26.             )</font>
<font color="black">  27.         # Create the default manager, if needed.</font>
<font color="green">  28.         cls.add_to_class('objects', Manager())</font>
<font color="green">  29.         cls._base_manager = cls.objects</font>
<font color="green">  30.     elif not getattr(cls, '_base_manager', None):</font>
<font color="green">  31.         default_mgr = cls._default_manager.__class__</font>
<font color="green">  32.         if (default_mgr is Manager or</font>
<font color="green">  33.                 getattr(default_mgr, &quot;use_for_related_fields&quot;, False)):</font>
<font color="red">  34.             cls._base_manager = cls._default_manager</font>
<font color="black">  35.         else:</font>
<font color="black">  36.             # Default manager isn't a plain Manager class, or a suitable</font>
<font color="black">  37.             # replacement, so we walk up the base class hierarchy until we hit</font>
<font color="black">  38.             # something appropriate.</font>
<font color="green">  39.             for base_class in default_mgr.mro()[1:]:</font>
<font color="green">  40.                 if (base_class is Manager or</font>
<font color="green">  41.                         getattr(base_class, &quot;use_for_related_fields&quot;, False)):</font>
<font color="green">  42.                     cls.add_to_class('_base_manager', base_class())</font>
<font color="green">  43.                     return</font>
<font color="red">  44.             raise AssertionError(</font>
<font color="red">  45.                 &quot;Should never get here. Please report a bug, including your &quot;</font>
<font color="black">  46.                 &quot;model and model manager setup.&quot;</font>
<font color="black">  47.             )</font>
<font color="black">  48. </font>
<font color="black">  49. </font>
<font color="green">  50. @python_2_unicode_compatible</font>
<font color="green">  51. class BaseManager(object):</font>
<font color="black">  52.     # Tracks each time a Manager instance is created. Used to retain order.</font>
<font color="green">  53.     creation_counter = 0</font>
<font color="black">  54. </font>
<font color="black">  55.     #: If set to True the manager will be serialized into migrations and will</font>
<font color="black">  56.     #: thus be available in e.g. RunPython operations</font>
<font color="green">  57.     use_in_migrations = False</font>
<font color="black">  58. </font>
<font color="green">  59.     def __new__(cls, *args, **kwargs):</font>
<font color="black">  60.         # We capture the arguments to make returning them trivial</font>
<font color="green">  61.         obj = super(BaseManager, cls).__new__(cls)</font>
<font color="green">  62.         obj._constructor_args = (args, kwargs)</font>
<font color="green">  63.         return obj</font>
<font color="black">  64. </font>
<font color="green">  65.     def __init__(self):</font>
<font color="green">  66.         super(BaseManager, self).__init__()</font>
<font color="green">  67.         self._set_creation_counter()</font>
<font color="green">  68.         self.model = None</font>
<font color="green">  69.         self.name = None</font>
<font color="green">  70.         self._inherited = False</font>
<font color="green">  71.         self._db = None</font>
<font color="green">  72.         self._hints = {}</font>
<font color="black">  73. </font>
<font color="green">  74.     def __str__(self):</font>
<font color="black">  75.         &quot;&quot;&quot; Return &quot;app_label.model_label.manager_name&quot;. &quot;&quot;&quot;</font>
<font color="red">  76.         return '%s.%s' % (self.model._meta.label, self.name)</font>
<font color="black">  77. </font>
<font color="green">  78.     def deconstruct(self):</font>
<font color="black">  79.         &quot;&quot;&quot;</font>
<font color="black">  80.         Returns a 5-tuple of the form (as_manager (True), manager_class,</font>
<font color="black">  81.         queryset_class, args, kwargs).</font>
<font color="black">  82. </font>
<font color="black">  83.         Raises a ValueError if the manager is dynamically generated.</font>
<font color="black">  84.         &quot;&quot;&quot;</font>
<font color="green">  85.         qs_class = self._queryset_class</font>
<font color="green">  86.         if getattr(self, '_built_with_as_manager', False):</font>
<font color="black">  87.             # using MyQuerySet.as_manager()</font>
<font color="black">  88.             return (</font>
<font color="red">  89.                 True,  # as_manager</font>
<font color="red">  90.                 None,  # manager_class</font>
<font color="red">  91.                 '%s.%s' % (qs_class.__module__, qs_class.__name__),  # qs_class</font>
<font color="red">  92.                 None,  # args</font>
<font color="red">  93.                 None,  # kwargs</font>
<font color="black">  94.             )</font>
<font color="black">  95.         else:</font>
<font color="green">  96.             module_name = self.__module__</font>
<font color="green">  97.             name = self.__class__.__name__</font>
<font color="black">  98.             # Make sure it's actually there and not an inner class</font>
<font color="green">  99.             module = import_module(module_name)</font>
<font color="green"> 100.             if not hasattr(module, name):</font>
<font color="red"> 101.                 raise ValueError(</font>
<font color="red"> 102.                     &quot;Could not find manager %s in %s.\n&quot;</font>
<font color="black"> 103.                     &quot;Please note that you need to inherit from managers you &quot;</font>
<font color="black"> 104.                     &quot;dynamically generated with 'from_queryset()'.&quot;</font>
<font color="red"> 105.                     % (name, module_name)</font>
<font color="black"> 106.                 )</font>
<font color="black"> 107.             return (</font>
<font color="green"> 108.                 False,  # as_manager</font>
<font color="green"> 109.                 '%s.%s' % (module_name, name),  # manager_class</font>
<font color="green"> 110.                 None,  # qs_class</font>
<font color="green"> 111.                 self._constructor_args[0],  # args</font>
<font color="green"> 112.                 self._constructor_args[1],  # kwargs</font>
<font color="black"> 113.             )</font>
<font color="black"> 114. </font>
<font color="green"> 115.     def check(self, **kwargs):</font>
<font color="red"> 116.         return []</font>
<font color="black"> 117. </font>
<font color="green"> 118.     @classmethod</font>
<font color="black"> 119.     def _get_queryset_methods(cls, queryset_class):</font>
<font color="green"> 120.         def create_method(name, method):</font>
<font color="green"> 121.             def manager_method(self, *args, **kwargs):</font>
<font color="green"> 122.                 return getattr(self.get_queryset(), name)(*args, **kwargs)</font>
<font color="green"> 123.             manager_method.__name__ = method.__name__</font>
<font color="green"> 124.             manager_method.__doc__ = method.__doc__</font>
<font color="green"> 125.             return manager_method</font>
<font color="black"> 126. </font>
<font color="green"> 127.         new_methods = {}</font>
<font color="black"> 128.         # Refs http://bugs.python.org/issue1785.</font>
<font color="green"> 129.         predicate = inspect.isfunction if six.PY3 else inspect.ismethod</font>
<font color="green"> 130.         for name, method in inspect.getmembers(queryset_class, predicate=predicate):</font>
<font color="black"> 131.             # Only copy missing methods.</font>
<font color="green"> 132.             if hasattr(cls, name):</font>
<font color="green"> 133.                 continue</font>
<font color="black"> 134.             # Only copy public methods or methods with the attribute `queryset_only=False`.</font>
<font color="green"> 135.             queryset_only = getattr(method, 'queryset_only', None)</font>
<font color="green"> 136.             if queryset_only or (queryset_only is None and name.startswith('_')):</font>
<font color="green"> 137.                 continue</font>
<font color="black"> 138.             # Copy the method onto the manager.</font>
<font color="green"> 139.             new_methods[name] = create_method(name, method)</font>
<font color="green"> 140.         return new_methods</font>
<font color="black"> 141. </font>
<font color="green"> 142.     @classmethod</font>
<font color="green"> 143.     def from_queryset(cls, queryset_class, class_name=None):</font>
<font color="green"> 144.         if class_name is None:</font>
<font color="green"> 145.             class_name = '%sFrom%s' % (cls.__name__, queryset_class.__name__)</font>
<font color="green"> 146.         class_dict = {</font>
<font color="green"> 147.             '_queryset_class': queryset_class,</font>
<font color="black"> 148.         }</font>
<font color="green"> 149.         class_dict.update(cls._get_queryset_methods(queryset_class))</font>
<font color="green"> 150.         return type(class_name, (cls,), class_dict)</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def contribute_to_class(self, model, name):</font>
<font color="black"> 153.         # TODO: Use weakref because of possible memory leak / circular reference.</font>
<font color="green"> 154.         self.model = model</font>
<font color="green"> 155.         if not self.name:</font>
<font color="green"> 156.             self.name = name</font>
<font color="black"> 157.         # Only contribute the manager if the model is concrete</font>
<font color="green"> 158.         if model._meta.abstract:</font>
<font color="green"> 159.             setattr(model, name, AbstractManagerDescriptor(model))</font>
<font color="green"> 160.         elif model._meta.swapped:</font>
<font color="red"> 161.             setattr(model, name, SwappedManagerDescriptor(model))</font>
<font color="black"> 162.         else:</font>
<font color="black"> 163.             # if not model._meta.abstract and not model._meta.swapped:</font>
<font color="green"> 164.             setattr(model, name, ManagerDescriptor(self))</font>
<font color="green"> 165.         if (not getattr(model, '_default_manager', None) or</font>
<font color="green"> 166.                 self.creation_counter &lt; model._default_manager.creation_counter):</font>
<font color="green"> 167.             model._default_manager = self</font>
<font color="black"> 168. </font>
<font color="green"> 169.         abstract = False</font>
<font color="green"> 170.         if model._meta.abstract or (self._inherited and not self.model._meta.proxy):</font>
<font color="green"> 171.             abstract = True</font>
<font color="green"> 172.         model._meta.managers.append((self.creation_counter, self, abstract))</font>
<font color="black"> 173. </font>
<font color="green"> 174.     def _set_creation_counter(self):</font>
<font color="black"> 175.         &quot;&quot;&quot;</font>
<font color="black"> 176.         Sets the creation counter value for this instance and increments the</font>
<font color="black"> 177.         class-level copy.</font>
<font color="black"> 178.         &quot;&quot;&quot;</font>
<font color="green"> 179.         self.creation_counter = BaseManager.creation_counter</font>
<font color="green"> 180.         BaseManager.creation_counter += 1</font>
<font color="black"> 181. </font>
<font color="green"> 182.     def _copy_to_model(self, model):</font>
<font color="black"> 183.         &quot;&quot;&quot;</font>
<font color="black"> 184.         Makes a copy of the manager and assigns it to 'model', which should be</font>
<font color="black"> 185.         a child of the existing model (used when inheriting a manager from an</font>
<font color="black"> 186.         abstract base class).</font>
<font color="black"> 187.         &quot;&quot;&quot;</font>
<font color="green"> 188.         assert issubclass(model, self.model)</font>
<font color="green"> 189.         mgr = copy.copy(self)</font>
<font color="green"> 190.         mgr._set_creation_counter()</font>
<font color="green"> 191.         mgr.model = model</font>
<font color="green"> 192.         mgr._inherited = True</font>
<font color="green"> 193.         return mgr</font>
<font color="black"> 194. </font>
<font color="green"> 195.     def db_manager(self, using=None, hints=None):</font>
<font color="green"> 196.         obj = copy.copy(self)</font>
<font color="green"> 197.         obj._db = using or self._db</font>
<font color="green"> 198.         obj._hints = hints or self._hints</font>
<font color="green"> 199.         return obj</font>
<font color="black"> 200. </font>
<font color="green"> 201.     @property</font>
<font color="black"> 202.     def db(self):</font>
<font color="green"> 203.         return self._db or router.db_for_read(self.model, **self._hints)</font>
<font color="black"> 204. </font>
<font color="black"> 205.     #######################</font>
<font color="black"> 206.     # PROXIES TO QUERYSET #</font>
<font color="black"> 207.     #######################</font>
<font color="black"> 208. </font>
<font color="green"> 209.     def get_queryset(self):</font>
<font color="black"> 210.         &quot;&quot;&quot;</font>
<font color="black"> 211.         Returns a new QuerySet object.  Subclasses can override this method to</font>
<font color="black"> 212.         easily customize the behavior of the Manager.</font>
<font color="black"> 213.         &quot;&quot;&quot;</font>
<font color="green"> 214.         return self._queryset_class(model=self.model, using=self._db, hints=self._hints)</font>
<font color="black"> 215. </font>
<font color="green"> 216.     def all(self):</font>
<font color="black"> 217.         # We can't proxy this method through the `QuerySet` like we do for the</font>
<font color="black"> 218.         # rest of the `QuerySet` methods. This is because `QuerySet.all()`</font>
<font color="black"> 219.         # works by creating a &quot;copy&quot; of the current queryset and in making said</font>
<font color="black"> 220.         # copy, all the cached `prefetch_related` lookups are lost. See the</font>
<font color="black"> 221.         # implementation of `RelatedManager.get_queryset()` for a better</font>
<font color="black"> 222.         # understanding of how this comes into play.</font>
<font color="red"> 223.         return self.get_queryset()</font>
<font color="black"> 224. </font>
<font color="green"> 225.     def __eq__(self, other):</font>
<font color="black"> 226.         return (</font>
<font color="red"> 227.             isinstance(other, self.__class__) and</font>
<font color="red"> 228.             self._constructor_args == other._constructor_args</font>
<font color="black"> 229.         )</font>
<font color="black"> 230. </font>
<font color="green"> 231.     def __ne__(self, other):</font>
<font color="red"> 232.         return not (self == other)</font>
<font color="black"> 233. </font>
<font color="green"> 234.     def __hash__(self):</font>
<font color="red"> 235.         return id(self)</font>
<font color="black"> 236. </font>
<font color="black"> 237. </font>
<font color="green"> 238. class Manager(BaseManager.from_queryset(QuerySet)):</font>
<font color="green"> 239.     pass</font>
<font color="black"> 240. </font>
<font color="black"> 241. </font>
<font color="green"> 242. class ManagerDescriptor(object):</font>
<font color="black"> 243.     # This class ensures managers aren't accessible via model instances.</font>
<font color="black"> 244.     # For example, Poll.objects works, but poll_obj.objects raises AttributeError.</font>
<font color="green"> 245.     def __init__(self, manager):</font>
<font color="green"> 246.         self.manager = manager</font>
<font color="black"> 247. </font>
<font color="green"> 248.     def __get__(self, instance, type=None):</font>
<font color="green"> 249.         if instance is not None:</font>
<font color="red"> 250.             raise AttributeError(&quot;Manager isn't accessible via %s instances&quot; % type.__name__)</font>
<font color="green"> 251.         return self.manager</font>
<font color="black"> 252. </font>
<font color="black"> 253. </font>
<font color="green"> 254. class AbstractManagerDescriptor(object):</font>
<font color="black"> 255.     # This class provides a better error message when you try to access a</font>
<font color="black"> 256.     # manager on an abstract model.</font>
<font color="green"> 257.     def __init__(self, model):</font>
<font color="green"> 258.         self.model = model</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def __get__(self, instance, type=None):</font>
<font color="green"> 261.         raise AttributeError(&quot;Manager isn't available; %s is abstract&quot; % (</font>
<font color="green"> 262.             self.model._meta.object_name,</font>
<font color="black"> 263.         ))</font>
<font color="black"> 264. </font>
<font color="black"> 265. </font>
<font color="green"> 266. class SwappedManagerDescriptor(object):</font>
<font color="black"> 267.     # This class provides a better error message when you try to access a</font>
<font color="black"> 268.     # manager on a swapped model.</font>
<font color="green"> 269.     def __init__(self, model):</font>
<font color="red"> 270.         self.model = model</font>
<font color="black"> 271. </font>
<font color="green"> 272.     def __get__(self, instance, type=None):</font>
<font color="red"> 273.         raise AttributeError(</font>
<font color="red"> 274.             &quot;Manager isn't available; '%s.%s' has been swapped for '%s'&quot; % (</font>
<font color="red"> 275.                 self.model._meta.app_label,</font>
<font color="red"> 276.                 self.model._meta.object_name,</font>
<font color="red"> 277.                 self.model._meta.swapped,</font>
<font color="black"> 278.             )</font>
<font color="black"> 279.         )</font>
<font color="black"> 280. </font>
<font color="black"> 281. </font>
<font color="green"> 282. class EmptyManager(Manager):</font>
<font color="green"> 283.     def __init__(self, model):</font>
<font color="green"> 284.         super(EmptyManager, self).__init__()</font>
<font color="green"> 285.         self.model = model</font>
<font color="black"> 286. </font>
<font color="green"> 287.     def get_queryset(self):</font>
<font color="red"> 288.         return super(EmptyManager, self).get_queryset().none()</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/views/decorators/csrf.py</b><br>


file stats: <b>27 lines, 18 executed: 66.7% covered</b>
<pre>
<font color="green">   1. from functools import wraps</font>
<font color="black">   2. </font>
<font color="green">   3. from django.middleware.csrf import CsrfViewMiddleware, get_token</font>
<font color="green">   4. from django.utils.decorators import available_attrs, decorator_from_middleware</font>
<font color="black">   5. </font>
<font color="green">   6. csrf_protect = decorator_from_middleware(CsrfViewMiddleware)</font>
<font color="green">   7. csrf_protect.__name__ = &quot;csrf_protect&quot;</font>
<font color="black">   8. csrf_protect.__doc__ = &quot;&quot;&quot;</font>
<font color="black">   9. This decorator adds CSRF protection in exactly the same way as</font>
<font color="black">  10. CsrfViewMiddleware, but it can be used on a per view basis.  Using both, or</font>
<font color="black">  11. using the decorator multiple times, is harmless and efficient.</font>
<font color="green">  12. &quot;&quot;&quot;</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class _EnsureCsrfToken(CsrfViewMiddleware):</font>
<font color="black">  16.     # We need this to behave just like the CsrfViewMiddleware, but not reject</font>
<font color="black">  17.     # requests or log warnings.</font>
<font color="green">  18.     def _reject(self, request, reason):</font>
<font color="red">  19.         return None</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. requires_csrf_token = decorator_from_middleware(_EnsureCsrfToken)</font>
<font color="green">  23. requires_csrf_token.__name__ = 'requires_csrf_token'</font>
<font color="black">  24. requires_csrf_token.__doc__ = &quot;&quot;&quot;</font>
<font color="black">  25. Use this decorator on views that need a correct csrf_token available to</font>
<font color="black">  26. RequestContext, but without the CSRF protection that csrf_protect</font>
<font color="black">  27. enforces.</font>
<font color="green">  28. &quot;&quot;&quot;</font>
<font color="black">  29. </font>
<font color="black">  30. </font>
<font color="green">  31. class _EnsureCsrfCookie(CsrfViewMiddleware):</font>
<font color="green">  32.     def _reject(self, request, reason):</font>
<font color="red">  33.         return None</font>
<font color="black">  34. </font>
<font color="green">  35.     def process_view(self, request, callback, callback_args, callback_kwargs):</font>
<font color="red">  36.         retval = super(_EnsureCsrfCookie, self).process_view(request, callback, callback_args, callback_kwargs)</font>
<font color="black">  37.         # Forces process_response to send the cookie</font>
<font color="red">  38.         get_token(request)</font>
<font color="red">  39.         return retval</font>
<font color="black">  40. </font>
<font color="black">  41. </font>
<font color="green">  42. ensure_csrf_cookie = decorator_from_middleware(_EnsureCsrfCookie)</font>
<font color="green">  43. ensure_csrf_cookie.__name__ = 'ensure_csrf_cookie'</font>
<font color="black">  44. ensure_csrf_cookie.__doc__ = &quot;&quot;&quot;</font>
<font color="black">  45. Use this decorator to ensure that a view sets a CSRF cookie, whether or not it</font>
<font color="black">  46. uses the csrf_token template tag, or the CsrfViewMiddleware is used.</font>
<font color="green">  47. &quot;&quot;&quot;</font>
<font color="black">  48. </font>
<font color="black">  49. </font>
<font color="green">  50. def csrf_exempt(view_func):</font>
<font color="black">  51.     &quot;&quot;&quot;</font>
<font color="black">  52.     Marks a view function as being exempt from the CSRF view protection.</font>
<font color="black">  53.     &quot;&quot;&quot;</font>
<font color="black">  54.     # We could just do view_func.csrf_exempt = True, but decorators</font>
<font color="black">  55.     # are nicer if they don't have side-effects, so we return a new</font>
<font color="black">  56.     # function.</font>
<font color="red">  57.     def wrapped_view(*args, **kwargs):</font>
<font color="red">  58.         return view_func(*args, **kwargs)</font>
<font color="red">  59.     wrapped_view.csrf_exempt = True</font>
<font color="red">  60.     return wraps(view_func, assigned=available_attrs(view_func))(wrapped_view)</font>
</pre>


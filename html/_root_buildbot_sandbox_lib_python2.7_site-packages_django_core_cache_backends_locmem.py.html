source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/cache/backends/locmem.py</b><br>


file stats: <b>110 lines, 28 executed: 25.5% covered</b>
<pre>
<font color="green">   1. &quot;Thread-safe in-memory cache backend.&quot;</font>
<font color="black">   2. </font>
<font color="green">   3. import time</font>
<font color="green">   4. from contextlib import contextmanager</font>
<font color="black">   5. </font>
<font color="green">   6. from django.core.cache.backends.base import DEFAULT_TIMEOUT, BaseCache</font>
<font color="green">   7. from django.utils.synch import RWLock</font>
<font color="black">   8. </font>
<font color="green">   9. try:</font>
<font color="green">  10.     from django.utils.six.moves import cPickle as pickle</font>
<font color="red">  11. except ImportError:</font>
<font color="red">  12.     import pickle</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="black">  15. # Global in-memory store of cache data. Keyed by name, to provide</font>
<font color="black">  16. # multiple named local memory caches.</font>
<font color="green">  17. _caches = {}</font>
<font color="green">  18. _expire_info = {}</font>
<font color="green">  19. _locks = {}</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. @contextmanager</font>
<font color="black">  23. def dummy():</font>
<font color="black">  24.     &quot;&quot;&quot;A context manager that does nothing special.&quot;&quot;&quot;</font>
<font color="red">  25.     yield</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. class LocMemCache(BaseCache):</font>
<font color="green">  29.     def __init__(self, name, params):</font>
<font color="green">  30.         BaseCache.__init__(self, params)</font>
<font color="green">  31.         self._cache = _caches.setdefault(name, {})</font>
<font color="green">  32.         self._expire_info = _expire_info.setdefault(name, {})</font>
<font color="green">  33.         self._lock = _locks.setdefault(name, RWLock())</font>
<font color="black">  34. </font>
<font color="green">  35.     def add(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="red">  36.         key = self.make_key(key, version=version)</font>
<font color="red">  37.         self.validate_key(key)</font>
<font color="red">  38.         pickled = pickle.dumps(value, pickle.HIGHEST_PROTOCOL)</font>
<font color="red">  39.         with self._lock.writer():</font>
<font color="red">  40.             if self._has_expired(key):</font>
<font color="red">  41.                 self._set(key, pickled, timeout)</font>
<font color="red">  42.                 return True</font>
<font color="red">  43.             return False</font>
<font color="black">  44. </font>
<font color="green">  45.     def get(self, key, default=None, version=None, acquire_lock=True):</font>
<font color="red">  46.         key = self.make_key(key, version=version)</font>
<font color="red">  47.         self.validate_key(key)</font>
<font color="red">  48.         pickled = None</font>
<font color="red">  49.         with (self._lock.reader() if acquire_lock else dummy()):</font>
<font color="red">  50.             if not self._has_expired(key):</font>
<font color="red">  51.                 pickled = self._cache[key]</font>
<font color="red">  52.         if pickled is not None:</font>
<font color="red">  53.             try:</font>
<font color="red">  54.                 return pickle.loads(pickled)</font>
<font color="red">  55.             except pickle.PickleError:</font>
<font color="red">  56.                 return default</font>
<font color="black">  57. </font>
<font color="red">  58.         with (self._lock.writer() if acquire_lock else dummy()):</font>
<font color="red">  59.             try:</font>
<font color="red">  60.                 del self._cache[key]</font>
<font color="red">  61.                 del self._expire_info[key]</font>
<font color="red">  62.             except KeyError:</font>
<font color="red">  63.                 pass</font>
<font color="red">  64.             return default</font>
<font color="black">  65. </font>
<font color="green">  66.     def _set(self, key, value, timeout=DEFAULT_TIMEOUT):</font>
<font color="red">  67.         if len(self._cache) &gt;= self._max_entries:</font>
<font color="red">  68.             self._cull()</font>
<font color="red">  69.         self._cache[key] = value</font>
<font color="red">  70.         self._expire_info[key] = self.get_backend_timeout(timeout)</font>
<font color="black">  71. </font>
<font color="green">  72.     def set(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="red">  73.         key = self.make_key(key, version=version)</font>
<font color="red">  74.         self.validate_key(key)</font>
<font color="red">  75.         pickled = pickle.dumps(value, pickle.HIGHEST_PROTOCOL)</font>
<font color="red">  76.         with self._lock.writer():</font>
<font color="red">  77.             self._set(key, pickled, timeout)</font>
<font color="black">  78. </font>
<font color="green">  79.     def incr(self, key, delta=1, version=None):</font>
<font color="red">  80.         with self._lock.writer():</font>
<font color="red">  81.             value = self.get(key, version=version, acquire_lock=False)</font>
<font color="red">  82.             if value is None:</font>
<font color="red">  83.                 raise ValueError(&quot;Key '%s' not found&quot; % key)</font>
<font color="red">  84.             new_value = value + delta</font>
<font color="red">  85.             key = self.make_key(key, version=version)</font>
<font color="red">  86.             pickled = pickle.dumps(new_value, pickle.HIGHEST_PROTOCOL)</font>
<font color="red">  87.             self._cache[key] = pickled</font>
<font color="red">  88.         return new_value</font>
<font color="black">  89. </font>
<font color="green">  90.     def has_key(self, key, version=None):</font>
<font color="red">  91.         key = self.make_key(key, version=version)</font>
<font color="red">  92.         self.validate_key(key)</font>
<font color="red">  93.         with self._lock.reader():</font>
<font color="red">  94.             if not self._has_expired(key):</font>
<font color="red">  95.                 return True</font>
<font color="black">  96. </font>
<font color="red">  97.         with self._lock.writer():</font>
<font color="red">  98.             try:</font>
<font color="red">  99.                 del self._cache[key]</font>
<font color="red"> 100.                 del self._expire_info[key]</font>
<font color="red"> 101.             except KeyError:</font>
<font color="red"> 102.                 pass</font>
<font color="red"> 103.             return False</font>
<font color="black"> 104. </font>
<font color="green"> 105.     def _has_expired(self, key):</font>
<font color="red"> 106.         exp = self._expire_info.get(key, -1)</font>
<font color="red"> 107.         if exp is None or exp &gt; time.time():</font>
<font color="red"> 108.             return False</font>
<font color="red"> 109.         return True</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def _cull(self):</font>
<font color="red"> 112.         if self._cull_frequency == 0:</font>
<font color="red"> 113.             self.clear()</font>
<font color="black"> 114.         else:</font>
<font color="red"> 115.             doomed = [k for (i, k) in enumerate(self._cache) if i % self._cull_frequency == 0]</font>
<font color="red"> 116.             for k in doomed:</font>
<font color="red"> 117.                 self._delete(k)</font>
<font color="black"> 118. </font>
<font color="green"> 119.     def _delete(self, key):</font>
<font color="red"> 120.         try:</font>
<font color="red"> 121.             del self._cache[key]</font>
<font color="red"> 122.         except KeyError:</font>
<font color="red"> 123.             pass</font>
<font color="red"> 124.         try:</font>
<font color="red"> 125.             del self._expire_info[key]</font>
<font color="red"> 126.         except KeyError:</font>
<font color="red"> 127.             pass</font>
<font color="black"> 128. </font>
<font color="green"> 129.     def delete(self, key, version=None):</font>
<font color="red"> 130.         key = self.make_key(key, version=version)</font>
<font color="red"> 131.         self.validate_key(key)</font>
<font color="red"> 132.         with self._lock.writer():</font>
<font color="red"> 133.             self._delete(key)</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def clear(self):</font>
<font color="red"> 136.         self._cache.clear()</font>
<font color="red"> 137.         self._expire_info.clear()</font>
</pre>


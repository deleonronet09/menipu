source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/backends/base/base.py</b><br>


file stats: <b>312 lines, 208 executed: 66.7% covered</b>
<pre>
<font color="green">   1. import copy</font>
<font color="green">   2. import time</font>
<font color="green">   3. import warnings</font>
<font color="green">   4. from collections import deque</font>
<font color="green">   5. from contextlib import contextmanager</font>
<font color="black">   6. </font>
<font color="green">   7. from django.conf import settings</font>
<font color="green">   8. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   9. from django.db import DEFAULT_DB_ALIAS</font>
<font color="green">  10. from django.db.backends import utils</font>
<font color="green">  11. from django.db.backends.signals import connection_created</font>
<font color="green">  12. from django.db.transaction import TransactionManagementError</font>
<font color="green">  13. from django.db.utils import DatabaseError, DatabaseErrorWrapper</font>
<font color="green">  14. from django.utils import timezone</font>
<font color="green">  15. from django.utils.functional import cached_property</font>
<font color="green">  16. from django.utils.six.moves import _thread as thread</font>
<font color="black">  17. </font>
<font color="green">  18. try:</font>
<font color="green">  19.     import pytz</font>
<font color="green">  20. except ImportError:</font>
<font color="green">  21.     pytz = None</font>
<font color="black">  22. </font>
<font color="green">  23. NO_DB_ALIAS = '__no_db__'</font>
<font color="black">  24. </font>
<font color="black">  25. </font>
<font color="green">  26. class BaseDatabaseWrapper(object):</font>
<font color="black">  27.     &quot;&quot;&quot;</font>
<font color="black">  28.     Represents a database connection.</font>
<font color="green">  29.     &quot;&quot;&quot;</font>
<font color="black">  30.     # Mapping of Field objects to their column types.</font>
<font color="green">  31.     data_types = {}</font>
<font color="black">  32.     # Mapping of Field objects to their SQL suffix such as AUTOINCREMENT.</font>
<font color="green">  33.     data_types_suffix = {}</font>
<font color="black">  34.     # Mapping of Field objects to their SQL for CHECK constraints.</font>
<font color="green">  35.     data_type_check_constraints = {}</font>
<font color="green">  36.     ops = None</font>
<font color="green">  37.     vendor = 'unknown'</font>
<font color="green">  38.     SchemaEditorClass = None</font>
<font color="black">  39. </font>
<font color="green">  40.     queries_limit = 9000</font>
<font color="black">  41. </font>
<font color="green">  42.     def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS,</font>
<font color="green">  43.                  allow_thread_sharing=False):</font>
<font color="black">  44.         # Connection related attributes.</font>
<font color="black">  45.         # The underlying database connection.</font>
<font color="green">  46.         self.connection = None</font>
<font color="black">  47.         # `settings_dict` should be a dictionary containing keys such as</font>
<font color="black">  48.         # NAME, USER, etc. It's called `settings_dict` instead of `settings`</font>
<font color="black">  49.         # to disambiguate it from Django settings modules.</font>
<font color="green">  50.         self.settings_dict = settings_dict</font>
<font color="green">  51.         self.alias = alias</font>
<font color="black">  52.         # Query logging in debug mode or when explicitly enabled.</font>
<font color="green">  53.         self.queries_log = deque(maxlen=self.queries_limit)</font>
<font color="green">  54.         self.force_debug_cursor = False</font>
<font color="black">  55. </font>
<font color="black">  56.         # Transaction related attributes.</font>
<font color="black">  57.         # Tracks if the connection is in autocommit mode. Per PEP 249, by</font>
<font color="black">  58.         # default, it isn't.</font>
<font color="green">  59.         self.autocommit = False</font>
<font color="black">  60.         # Tracks if the connection is in a transaction managed by 'atomic'.</font>
<font color="green">  61.         self.in_atomic_block = False</font>
<font color="black">  62.         # Increment to generate unique savepoint ids.</font>
<font color="green">  63.         self.savepoint_state = 0</font>
<font color="black">  64.         # List of savepoints created by 'atomic'.</font>
<font color="green">  65.         self.savepoint_ids = []</font>
<font color="black">  66.         # Tracks if the outermost 'atomic' block should commit on exit,</font>
<font color="black">  67.         # ie. if autocommit was active on entry.</font>
<font color="green">  68.         self.commit_on_exit = True</font>
<font color="black">  69.         # Tracks if the transaction should be rolled back to the next</font>
<font color="black">  70.         # available savepoint because of an exception in an inner block.</font>
<font color="green">  71.         self.needs_rollback = False</font>
<font color="black">  72. </font>
<font color="black">  73.         # Connection termination related attributes.</font>
<font color="green">  74.         self.close_at = None</font>
<font color="green">  75.         self.closed_in_transaction = False</font>
<font color="green">  76.         self.errors_occurred = False</font>
<font color="black">  77. </font>
<font color="black">  78.         # Thread-safety related attributes.</font>
<font color="green">  79.         self.allow_thread_sharing = allow_thread_sharing</font>
<font color="green">  80.         self._thread_ident = thread.get_ident()</font>
<font color="black">  81. </font>
<font color="black">  82.         # A list of no-argument functions to run when the transaction commits.</font>
<font color="black">  83.         # Each entry is an (sids, func) tuple, where sids is a set of the</font>
<font color="black">  84.         # active savepoint IDs when this function was registered.</font>
<font color="green">  85.         self.run_on_commit = []</font>
<font color="black">  86. </font>
<font color="black">  87.         # Should we run the on-commit hooks the next time set_autocommit(True)</font>
<font color="black">  88.         # is called?</font>
<font color="green">  89.         self.run_commit_hooks_on_set_autocommit_on = False</font>
<font color="black">  90. </font>
<font color="green">  91.     @cached_property</font>
<font color="black">  92.     def timezone(self):</font>
<font color="black">  93.         &quot;&quot;&quot;</font>
<font color="black">  94.         Time zone for datetimes stored as naive values in the database.</font>
<font color="black">  95. </font>
<font color="black">  96.         Returns a tzinfo object or None.</font>
<font color="black">  97. </font>
<font color="black">  98.         This is only needed when time zone support is enabled and the database</font>
<font color="black">  99.         doesn't support time zones. (When the database supports time zones,</font>
<font color="black"> 100.         the adapter handles aware datetimes so Django doesn't need to.)</font>
<font color="black"> 101.         &quot;&quot;&quot;</font>
<font color="green"> 102.         if not settings.USE_TZ:</font>
<font color="red"> 103.             return None</font>
<font color="green"> 104.         elif self.features.supports_timezones:</font>
<font color="red"> 105.             return None</font>
<font color="green"> 106.         elif self.settings_dict['TIME_ZONE'] is None:</font>
<font color="green"> 107.             return timezone.utc</font>
<font color="black"> 108.         else:</font>
<font color="black"> 109.             # Only this branch requires pytz.</font>
<font color="red"> 110.             return pytz.timezone(self.settings_dict['TIME_ZONE'])</font>
<font color="black"> 111. </font>
<font color="green"> 112.     @cached_property</font>
<font color="black"> 113.     def timezone_name(self):</font>
<font color="black"> 114.         &quot;&quot;&quot;</font>
<font color="black"> 115.         Name of the time zone of the database connection.</font>
<font color="black"> 116.         &quot;&quot;&quot;</font>
<font color="red"> 117.         if not settings.USE_TZ:</font>
<font color="red"> 118.             return settings.TIME_ZONE</font>
<font color="red"> 119.         elif self.settings_dict['TIME_ZONE'] is None:</font>
<font color="red"> 120.             return 'UTC'</font>
<font color="black"> 121.         else:</font>
<font color="red"> 122.             return self.settings_dict['TIME_ZONE']</font>
<font color="black"> 123. </font>
<font color="green"> 124.     @property</font>
<font color="black"> 125.     def queries_logged(self):</font>
<font color="green"> 126.         return self.force_debug_cursor or settings.DEBUG</font>
<font color="black"> 127. </font>
<font color="green"> 128.     @property</font>
<font color="black"> 129.     def queries(self):</font>
<font color="red"> 130.         if len(self.queries_log) == self.queries_log.maxlen:</font>
<font color="red"> 131.             warnings.warn(</font>
<font color="red"> 132.                 &quot;Limit for query logging exceeded, only the last {} queries &quot;</font>
<font color="red"> 133.                 &quot;will be returned.&quot;.format(self.queries_log.maxlen))</font>
<font color="red"> 134.         return list(self.queries_log)</font>
<font color="black"> 135. </font>
<font color="black"> 136.     # ##### Backend-specific methods for creating connections and cursors #####</font>
<font color="black"> 137. </font>
<font color="green"> 138.     def get_connection_params(self):</font>
<font color="black"> 139.         &quot;&quot;&quot;Returns a dict of parameters suitable for get_new_connection.&quot;&quot;&quot;</font>
<font color="red"> 140.         raise NotImplementedError('subclasses of BaseDatabaseWrapper may require a get_connection_params() method')</font>
<font color="black"> 141. </font>
<font color="green"> 142.     def get_new_connection(self, conn_params):</font>
<font color="black"> 143.         &quot;&quot;&quot;Opens a connection to the database.&quot;&quot;&quot;</font>
<font color="red"> 144.         raise NotImplementedError('subclasses of BaseDatabaseWrapper may require a get_new_connection() method')</font>
<font color="black"> 145. </font>
<font color="green"> 146.     def init_connection_state(self):</font>
<font color="black"> 147.         &quot;&quot;&quot;Initializes the database connection settings.&quot;&quot;&quot;</font>
<font color="red"> 148.         raise NotImplementedError('subclasses of BaseDatabaseWrapper may require an init_connection_state() method')</font>
<font color="black"> 149. </font>
<font color="green"> 150.     def create_cursor(self):</font>
<font color="black"> 151.         &quot;&quot;&quot;Creates a cursor. Assumes that a connection is established.&quot;&quot;&quot;</font>
<font color="red"> 152.         raise NotImplementedError('subclasses of BaseDatabaseWrapper may require a create_cursor() method')</font>
<font color="black"> 153. </font>
<font color="black"> 154.     # ##### Backend-specific methods for creating connections #####</font>
<font color="black"> 155. </font>
<font color="green"> 156.     def connect(self):</font>
<font color="black"> 157.         &quot;&quot;&quot;Connects to the database. Assumes that the connection is closed.&quot;&quot;&quot;</font>
<font color="black"> 158.         # Check for invalid configurations.</font>
<font color="green"> 159.         self.check_settings()</font>
<font color="black"> 160.         # In case the previous connection was closed while in an atomic block</font>
<font color="green"> 161.         self.in_atomic_block = False</font>
<font color="green"> 162.         self.savepoint_ids = []</font>
<font color="green"> 163.         self.needs_rollback = False</font>
<font color="black"> 164.         # Reset parameters defining when to close the connection</font>
<font color="green"> 165.         max_age = self.settings_dict['CONN_MAX_AGE']</font>
<font color="green"> 166.         self.close_at = None if max_age is None else time.time() + max_age</font>
<font color="green"> 167.         self.closed_in_transaction = False</font>
<font color="green"> 168.         self.errors_occurred = False</font>
<font color="black"> 169.         # Establish the connection</font>
<font color="green"> 170.         conn_params = self.get_connection_params()</font>
<font color="green"> 171.         self.connection = self.get_new_connection(conn_params)</font>
<font color="green"> 172.         self.set_autocommit(self.settings_dict['AUTOCOMMIT'])</font>
<font color="green"> 173.         self.init_connection_state()</font>
<font color="green"> 174.         connection_created.send(sender=self.__class__, connection=self)</font>
<font color="black"> 175. </font>
<font color="green"> 176.         self.run_on_commit = []</font>
<font color="black"> 177. </font>
<font color="green"> 178.     def check_settings(self):</font>
<font color="green"> 179.         if self.settings_dict['TIME_ZONE'] is not None:</font>
<font color="red"> 180.             if not settings.USE_TZ:</font>
<font color="red"> 181.                 raise ImproperlyConfigured(</font>
<font color="red"> 182.                     &quot;Connection '%s' cannot set TIME_ZONE because USE_TZ is &quot;</font>
<font color="red"> 183.                     &quot;False.&quot; % self.alias)</font>
<font color="red"> 184.             elif self.features.supports_timezones:</font>
<font color="red"> 185.                 raise ImproperlyConfigured(</font>
<font color="red"> 186.                     &quot;Connection '%s' cannot set TIME_ZONE because its engine &quot;</font>
<font color="red"> 187.                     &quot;handles time zones conversions natively.&quot; % self.alias)</font>
<font color="red"> 188.             elif pytz is None:</font>
<font color="red"> 189.                 raise ImproperlyConfigured(</font>
<font color="red"> 190.                     &quot;Connection '%s' cannot set TIME_ZONE because pytz isn't &quot;</font>
<font color="red"> 191.                     &quot;installed.&quot; % self.alias)</font>
<font color="black"> 192. </font>
<font color="green"> 193.     def ensure_connection(self):</font>
<font color="black"> 194.         &quot;&quot;&quot;</font>
<font color="black"> 195.         Guarantees that a connection to the database is established.</font>
<font color="black"> 196.         &quot;&quot;&quot;</font>
<font color="green"> 197.         if self.connection is None:</font>
<font color="green"> 198.             with self.wrap_database_errors:</font>
<font color="green"> 199.                 self.connect()</font>
<font color="black"> 200. </font>
<font color="black"> 201.     # ##### Backend-specific wrappers for PEP-249 connection methods #####</font>
<font color="black"> 202. </font>
<font color="green"> 203.     def _cursor(self):</font>
<font color="green"> 204.         self.ensure_connection()</font>
<font color="green"> 205.         with self.wrap_database_errors:</font>
<font color="green"> 206.             return self.create_cursor()</font>
<font color="black"> 207. </font>
<font color="green"> 208.     def _commit(self):</font>
<font color="green"> 209.         if self.connection is not None:</font>
<font color="green"> 210.             with self.wrap_database_errors:</font>
<font color="green"> 211.                 return self.connection.commit()</font>
<font color="black"> 212. </font>
<font color="green"> 213.     def _rollback(self):</font>
<font color="green"> 214.         if self.connection is not None:</font>
<font color="green"> 215.             with self.wrap_database_errors:</font>
<font color="green"> 216.                 return self.connection.rollback()</font>
<font color="black"> 217. </font>
<font color="green"> 218.     def _close(self):</font>
<font color="green"> 219.         if self.connection is not None:</font>
<font color="green"> 220.             with self.wrap_database_errors:</font>
<font color="green"> 221.                 return self.connection.close()</font>
<font color="black"> 222. </font>
<font color="black"> 223.     # ##### Generic wrappers for PEP-249 connection methods #####</font>
<font color="black"> 224. </font>
<font color="green"> 225.     def cursor(self):</font>
<font color="black"> 226.         &quot;&quot;&quot;</font>
<font color="black"> 227.         Creates a cursor, opening a connection if necessary.</font>
<font color="black"> 228.         &quot;&quot;&quot;</font>
<font color="green"> 229.         self.validate_thread_sharing()</font>
<font color="green"> 230.         if self.queries_logged:</font>
<font color="red"> 231.             cursor = self.make_debug_cursor(self._cursor())</font>
<font color="black"> 232.         else:</font>
<font color="green"> 233.             cursor = self.make_cursor(self._cursor())</font>
<font color="green"> 234.         return cursor</font>
<font color="black"> 235. </font>
<font color="green"> 236.     def commit(self):</font>
<font color="black"> 237.         &quot;&quot;&quot;</font>
<font color="black"> 238.         Commits a transaction and resets the dirty flag.</font>
<font color="black"> 239.         &quot;&quot;&quot;</font>
<font color="green"> 240.         self.validate_thread_sharing()</font>
<font color="green"> 241.         self.validate_no_atomic_block()</font>
<font color="green"> 242.         self._commit()</font>
<font color="black"> 243.         # A successful commit means that the database connection works.</font>
<font color="green"> 244.         self.errors_occurred = False</font>
<font color="green"> 245.         self.run_commit_hooks_on_set_autocommit_on = True</font>
<font color="black"> 246. </font>
<font color="green"> 247.     def rollback(self):</font>
<font color="black"> 248.         &quot;&quot;&quot;</font>
<font color="black"> 249.         Rolls back a transaction and resets the dirty flag.</font>
<font color="black"> 250.         &quot;&quot;&quot;</font>
<font color="green"> 251.         self.validate_thread_sharing()</font>
<font color="green"> 252.         self.validate_no_atomic_block()</font>
<font color="green"> 253.         self._rollback()</font>
<font color="black"> 254.         # A successful rollback means that the database connection works.</font>
<font color="green"> 255.         self.errors_occurred = False</font>
<font color="black"> 256. </font>
<font color="green"> 257.         self.run_on_commit = []</font>
<font color="black"> 258. </font>
<font color="green"> 259.     def close(self):</font>
<font color="black"> 260.         &quot;&quot;&quot;</font>
<font color="black"> 261.         Closes the connection to the database.</font>
<font color="black"> 262.         &quot;&quot;&quot;</font>
<font color="green"> 263.         self.validate_thread_sharing()</font>
<font color="green"> 264.         self.run_on_commit = []</font>
<font color="black"> 265. </font>
<font color="black"> 266.         # Don't call validate_no_atomic_block() to avoid making it difficult</font>
<font color="black"> 267.         # to get rid of a connection in an invalid state. The next connect()</font>
<font color="black"> 268.         # will reset the transaction state anyway.</font>
<font color="green"> 269.         if self.closed_in_transaction or self.connection is None:</font>
<font color="green"> 270.             return</font>
<font color="green"> 271.         try:</font>
<font color="green"> 272.             self._close()</font>
<font color="black"> 273.         finally:</font>
<font color="green"> 274.             if self.in_atomic_block:</font>
<font color="red"> 275.                 self.closed_in_transaction = True</font>
<font color="red"> 276.                 self.needs_rollback = True</font>
<font color="black"> 277.             else:</font>
<font color="green"> 278.                 self.connection = None</font>
<font color="black"> 279. </font>
<font color="black"> 280.     # ##### Backend-specific savepoint management methods #####</font>
<font color="black"> 281. </font>
<font color="green"> 282.     def _savepoint(self, sid):</font>
<font color="green"> 283.         with self.cursor() as cursor:</font>
<font color="green"> 284.             cursor.execute(self.ops.savepoint_create_sql(sid))</font>
<font color="black"> 285. </font>
<font color="green"> 286.     def _savepoint_rollback(self, sid):</font>
<font color="green"> 287.         with self.cursor() as cursor:</font>
<font color="green"> 288.             cursor.execute(self.ops.savepoint_rollback_sql(sid))</font>
<font color="black"> 289. </font>
<font color="green"> 290.     def _savepoint_commit(self, sid):</font>
<font color="green"> 291.         with self.cursor() as cursor:</font>
<font color="green"> 292.             cursor.execute(self.ops.savepoint_commit_sql(sid))</font>
<font color="black"> 293. </font>
<font color="green"> 294.     def _savepoint_allowed(self):</font>
<font color="black"> 295.         # Savepoints cannot be created outside a transaction</font>
<font color="red"> 296.         return self.features.uses_savepoints and not self.get_autocommit()</font>
<font color="black"> 297. </font>
<font color="black"> 298.     # ##### Generic savepoint management methods #####</font>
<font color="black"> 299. </font>
<font color="green"> 300.     def savepoint(self):</font>
<font color="black"> 301.         &quot;&quot;&quot;</font>
<font color="black"> 302.         Creates a savepoint inside the current transaction. Returns an</font>
<font color="black"> 303.         identifier for the savepoint that will be used for the subsequent</font>
<font color="black"> 304.         rollback or commit. Does nothing if savepoints are not supported.</font>
<font color="black"> 305.         &quot;&quot;&quot;</font>
<font color="green"> 306.         if not self._savepoint_allowed():</font>
<font color="red"> 307.             return</font>
<font color="black"> 308. </font>
<font color="green"> 309.         thread_ident = thread.get_ident()</font>
<font color="green"> 310.         tid = str(thread_ident).replace('-', '')</font>
<font color="black"> 311. </font>
<font color="green"> 312.         self.savepoint_state += 1</font>
<font color="green"> 313.         sid = &quot;s%s_x%d&quot; % (tid, self.savepoint_state)</font>
<font color="black"> 314. </font>
<font color="green"> 315.         self.validate_thread_sharing()</font>
<font color="green"> 316.         self._savepoint(sid)</font>
<font color="black"> 317. </font>
<font color="green"> 318.         return sid</font>
<font color="black"> 319. </font>
<font color="green"> 320.     def savepoint_rollback(self, sid):</font>
<font color="black"> 321.         &quot;&quot;&quot;</font>
<font color="black"> 322.         Rolls back to a savepoint. Does nothing if savepoints are not supported.</font>
<font color="black"> 323.         &quot;&quot;&quot;</font>
<font color="green"> 324.         if not self._savepoint_allowed():</font>
<font color="red"> 325.             return</font>
<font color="black"> 326. </font>
<font color="green"> 327.         self.validate_thread_sharing()</font>
<font color="green"> 328.         self._savepoint_rollback(sid)</font>
<font color="black"> 329. </font>
<font color="black"> 330.         # Remove any callbacks registered while this savepoint was active.</font>
<font color="black"> 331.         self.run_on_commit = [</font>
<font color="green"> 332.             (sids, func) for (sids, func) in self.run_on_commit if sid not in sids</font>
<font color="black"> 333.         ]</font>
<font color="black"> 334. </font>
<font color="green"> 335.     def savepoint_commit(self, sid):</font>
<font color="black"> 336.         &quot;&quot;&quot;</font>
<font color="black"> 337.         Releases a savepoint. Does nothing if savepoints are not supported.</font>
<font color="black"> 338.         &quot;&quot;&quot;</font>
<font color="green"> 339.         if not self._savepoint_allowed():</font>
<font color="red"> 340.             return</font>
<font color="black"> 341. </font>
<font color="green"> 342.         self.validate_thread_sharing()</font>
<font color="green"> 343.         self._savepoint_commit(sid)</font>
<font color="black"> 344. </font>
<font color="green"> 345.     def clean_savepoints(self):</font>
<font color="black"> 346.         &quot;&quot;&quot;</font>
<font color="black"> 347.         Resets the counter used to generate unique savepoint ids in this thread.</font>
<font color="black"> 348.         &quot;&quot;&quot;</font>
<font color="red"> 349.         self.savepoint_state = 0</font>
<font color="black"> 350. </font>
<font color="black"> 351.     # ##### Backend-specific transaction management methods #####</font>
<font color="black"> 352. </font>
<font color="green"> 353.     def _set_autocommit(self, autocommit):</font>
<font color="black"> 354.         &quot;&quot;&quot;</font>
<font color="black"> 355.         Backend-specific implementation to enable or disable autocommit.</font>
<font color="black"> 356.         &quot;&quot;&quot;</font>
<font color="red"> 357.         raise NotImplementedError('subclasses of BaseDatabaseWrapper may require a _set_autocommit() method')</font>
<font color="black"> 358. </font>
<font color="black"> 359.     # ##### Generic transaction management methods #####</font>
<font color="black"> 360. </font>
<font color="green"> 361.     def get_autocommit(self):</font>
<font color="black"> 362.         &quot;&quot;&quot;</font>
<font color="black"> 363.         Check the autocommit state.</font>
<font color="black"> 364.         &quot;&quot;&quot;</font>
<font color="green"> 365.         self.ensure_connection()</font>
<font color="green"> 366.         return self.autocommit</font>
<font color="black"> 367. </font>
<font color="green"> 368.     def set_autocommit(self, autocommit, force_begin_transaction_with_broken_autocommit=False):</font>
<font color="black"> 369.         &quot;&quot;&quot;</font>
<font color="black"> 370.         Enable or disable autocommit.</font>
<font color="black"> 371. </font>
<font color="black"> 372.         The usual way to start a transaction is to turn autocommit off.</font>
<font color="black"> 373.         SQLite does not properly start a transaction when disabling</font>
<font color="black"> 374.         autocommit. To avoid this buggy behavior and to actually enter a new</font>
<font color="black"> 375.         transaction, an explcit BEGIN is required. Using</font>
<font color="black"> 376.         force_begin_transaction_with_broken_autocommit=True will issue an</font>
<font color="black"> 377.         explicit BEGIN with SQLite. This option will be ignored for other</font>
<font color="black"> 378.         backends.</font>
<font color="black"> 379.         &quot;&quot;&quot;</font>
<font color="green"> 380.         self.validate_no_atomic_block()</font>
<font color="green"> 381.         self.ensure_connection()</font>
<font color="black"> 382. </font>
<font color="black"> 383.         start_transaction_under_autocommit = (</font>
<font color="green"> 384.             force_begin_transaction_with_broken_autocommit</font>
<font color="green"> 385.             and not autocommit</font>
<font color="green"> 386.             and self.features.autocommits_when_autocommit_is_off</font>
<font color="black"> 387.         )</font>
<font color="black"> 388. </font>
<font color="green"> 389.         if start_transaction_under_autocommit:</font>
<font color="green"> 390.             self._start_transaction_under_autocommit()</font>
<font color="black"> 391.         else:</font>
<font color="green"> 392.             self._set_autocommit(autocommit)</font>
<font color="black"> 393. </font>
<font color="green"> 394.         self.autocommit = autocommit</font>
<font color="black"> 395. </font>
<font color="green"> 396.         if autocommit and self.run_commit_hooks_on_set_autocommit_on:</font>
<font color="green"> 397.             self.run_and_clear_commit_hooks()</font>
<font color="green"> 398.             self.run_commit_hooks_on_set_autocommit_on = False</font>
<font color="black"> 399. </font>
<font color="green"> 400.     def get_rollback(self):</font>
<font color="black"> 401.         &quot;&quot;&quot;</font>
<font color="black"> 402.         Get the &quot;needs rollback&quot; flag -- for *advanced use* only.</font>
<font color="black"> 403.         &quot;&quot;&quot;</font>
<font color="red"> 404.         if not self.in_atomic_block:</font>
<font color="red"> 405.             raise TransactionManagementError(</font>
<font color="red"> 406.                 &quot;The rollback flag doesn't work outside of an 'atomic' block.&quot;)</font>
<font color="red"> 407.         return self.needs_rollback</font>
<font color="black"> 408. </font>
<font color="green"> 409.     def set_rollback(self, rollback):</font>
<font color="black"> 410.         &quot;&quot;&quot;</font>
<font color="black"> 411.         Set or unset the &quot;needs rollback&quot; flag -- for *advanced use* only.</font>
<font color="black"> 412.         &quot;&quot;&quot;</font>
<font color="green"> 413.         if not self.in_atomic_block:</font>
<font color="red"> 414.             raise TransactionManagementError(</font>
<font color="red"> 415.                 &quot;The rollback flag doesn't work outside of an 'atomic' block.&quot;)</font>
<font color="green"> 416.         self.needs_rollback = rollback</font>
<font color="black"> 417. </font>
<font color="green"> 418.     def validate_no_atomic_block(self):</font>
<font color="black"> 419.         &quot;&quot;&quot;</font>
<font color="black"> 420.         Raise an error if an atomic block is active.</font>
<font color="black"> 421.         &quot;&quot;&quot;</font>
<font color="green"> 422.         if self.in_atomic_block:</font>
<font color="red"> 423.             raise TransactionManagementError(</font>
<font color="red"> 424.                 &quot;This is forbidden when an 'atomic' block is active.&quot;)</font>
<font color="black"> 425. </font>
<font color="green"> 426.     def validate_no_broken_transaction(self):</font>
<font color="green"> 427.         if self.needs_rollback:</font>
<font color="red"> 428.             raise TransactionManagementError(</font>
<font color="red"> 429.                 &quot;An error occurred in the current transaction. You can't &quot;</font>
<font color="black"> 430.                 &quot;execute queries until the end of the 'atomic' block.&quot;)</font>
<font color="black"> 431. </font>
<font color="black"> 432.     # ##### Foreign key constraints checks handling #####</font>
<font color="black"> 433. </font>
<font color="green"> 434.     @contextmanager</font>
<font color="black"> 435.     def constraint_checks_disabled(self):</font>
<font color="black"> 436.         &quot;&quot;&quot;</font>
<font color="black"> 437.         Context manager that disables foreign key constraint checking.</font>
<font color="black"> 438.         &quot;&quot;&quot;</font>
<font color="red"> 439.         disabled = self.disable_constraint_checking()</font>
<font color="red"> 440.         try:</font>
<font color="red"> 441.             yield</font>
<font color="black"> 442.         finally:</font>
<font color="red"> 443.             if disabled:</font>
<font color="red"> 444.                 self.enable_constraint_checking()</font>
<font color="black"> 445. </font>
<font color="green"> 446.     def disable_constraint_checking(self):</font>
<font color="black"> 447.         &quot;&quot;&quot;</font>
<font color="black"> 448.         Backends can implement as needed to temporarily disable foreign key</font>
<font color="black"> 449.         constraint checking. Should return True if the constraints were</font>
<font color="black"> 450.         disabled and will need to be reenabled.</font>
<font color="black"> 451.         &quot;&quot;&quot;</font>
<font color="red"> 452.         return False</font>
<font color="black"> 453. </font>
<font color="green"> 454.     def enable_constraint_checking(self):</font>
<font color="black"> 455.         &quot;&quot;&quot;</font>
<font color="black"> 456.         Backends can implement as needed to re-enable foreign key constraint</font>
<font color="black"> 457.         checking.</font>
<font color="black"> 458.         &quot;&quot;&quot;</font>
<font color="red"> 459.         pass</font>
<font color="black"> 460. </font>
<font color="green"> 461.     def check_constraints(self, table_names=None):</font>
<font color="black"> 462.         &quot;&quot;&quot;</font>
<font color="black"> 463.         Backends can override this method if they can apply constraint</font>
<font color="black"> 464.         checking (e.g. via &quot;SET CONSTRAINTS ALL IMMEDIATE&quot;). Should raise an</font>
<font color="black"> 465.         IntegrityError if any invalid foreign key references are encountered.</font>
<font color="black"> 466.         &quot;&quot;&quot;</font>
<font color="red"> 467.         pass</font>
<font color="black"> 468. </font>
<font color="black"> 469.     # ##### Connection termination handling #####</font>
<font color="black"> 470. </font>
<font color="green"> 471.     def is_usable(self):</font>
<font color="black"> 472.         &quot;&quot;&quot;</font>
<font color="black"> 473.         Tests if the database connection is usable.</font>
<font color="black"> 474. </font>
<font color="black"> 475.         This function may assume that self.connection is not None.</font>
<font color="black"> 476. </font>
<font color="black"> 477.         Actual implementations should take care not to raise exceptions</font>
<font color="black"> 478.         as that may prevent Django from recycling unusable connections.</font>
<font color="black"> 479.         &quot;&quot;&quot;</font>
<font color="red"> 480.         raise NotImplementedError(</font>
<font color="red"> 481.             &quot;subclasses of BaseDatabaseWrapper may require an is_usable() method&quot;)</font>
<font color="black"> 482. </font>
<font color="green"> 483.     def close_if_unusable_or_obsolete(self):</font>
<font color="black"> 484.         &quot;&quot;&quot;</font>
<font color="black"> 485.         Closes the current connection if unrecoverable errors have occurred,</font>
<font color="black"> 486.         or if it outlived its maximum age.</font>
<font color="black"> 487.         &quot;&quot;&quot;</font>
<font color="red"> 488.         if self.connection is not None:</font>
<font color="black"> 489.             # If the application didn't restore the original autocommit setting,</font>
<font color="black"> 490.             # don't take chances, drop the connection.</font>
<font color="red"> 491.             if self.get_autocommit() != self.settings_dict['AUTOCOMMIT']:</font>
<font color="red"> 492.                 self.close()</font>
<font color="red"> 493.                 return</font>
<font color="black"> 494. </font>
<font color="black"> 495.             # If an exception other than DataError or IntegrityError occurred</font>
<font color="black"> 496.             # since the last commit / rollback, check if the connection works.</font>
<font color="red"> 497.             if self.errors_occurred:</font>
<font color="red"> 498.                 if self.is_usable():</font>
<font color="red"> 499.                     self.errors_occurred = False</font>
<font color="black"> 500.                 else:</font>
<font color="red"> 501.                     self.close()</font>
<font color="red"> 502.                     return</font>
<font color="black"> 503. </font>
<font color="red"> 504.             if self.close_at is not None and time.time() &gt;= self.close_at:</font>
<font color="red"> 505.                 self.close()</font>
<font color="red"> 506.                 return</font>
<font color="black"> 507. </font>
<font color="black"> 508.     # ##### Thread safety handling #####</font>
<font color="black"> 509. </font>
<font color="green"> 510.     def validate_thread_sharing(self):</font>
<font color="black"> 511.         &quot;&quot;&quot;</font>
<font color="black"> 512.         Validates that the connection isn't accessed by another thread than the</font>
<font color="black"> 513.         one which originally created it, unless the connection was explicitly</font>
<font color="black"> 514.         authorized to be shared between threads (via the `allow_thread_sharing`</font>
<font color="black"> 515.         property). Raises an exception if the validation fails.</font>
<font color="black"> 516.         &quot;&quot;&quot;</font>
<font color="green"> 517.         if not (self.allow_thread_sharing</font>
<font color="green"> 518.                 or self._thread_ident == thread.get_ident()):</font>
<font color="red"> 519.             raise DatabaseError(&quot;DatabaseWrapper objects created in a &quot;</font>
<font color="black"> 520.                 &quot;thread can only be used in that same thread. The object &quot;</font>
<font color="black"> 521.                 &quot;with alias '%s' was created in thread id %s and this is &quot;</font>
<font color="black"> 522.                 &quot;thread id %s.&quot;</font>
<font color="red"> 523.                 % (self.alias, self._thread_ident, thread.get_ident()))</font>
<font color="black"> 524. </font>
<font color="black"> 525.     # ##### Miscellaneous #####</font>
<font color="black"> 526. </font>
<font color="green"> 527.     def prepare_database(self):</font>
<font color="black"> 528.         &quot;&quot;&quot;</font>
<font color="black"> 529.         Hook to do any database check or preparation, generally called before</font>
<font color="black"> 530.         migrating a project or an app.</font>
<font color="black"> 531.         &quot;&quot;&quot;</font>
<font color="green"> 532.         pass</font>
<font color="black"> 533. </font>
<font color="green"> 534.     @cached_property</font>
<font color="black"> 535.     def wrap_database_errors(self):</font>
<font color="black"> 536.         &quot;&quot;&quot;</font>
<font color="black"> 537.         Context manager and decorator that re-throws backend-specific database</font>
<font color="black"> 538.         exceptions using Django's common wrappers.</font>
<font color="black"> 539.         &quot;&quot;&quot;</font>
<font color="green"> 540.         return DatabaseErrorWrapper(self)</font>
<font color="black"> 541. </font>
<font color="green"> 542.     def make_debug_cursor(self, cursor):</font>
<font color="black"> 543.         &quot;&quot;&quot;</font>
<font color="black"> 544.         Creates a cursor that logs all queries in self.queries_log.</font>
<font color="black"> 545.         &quot;&quot;&quot;</font>
<font color="red"> 546.         return utils.CursorDebugWrapper(cursor, self)</font>
<font color="black"> 547. </font>
<font color="green"> 548.     def make_cursor(self, cursor):</font>
<font color="black"> 549.         &quot;&quot;&quot;</font>
<font color="black"> 550.         Creates a cursor without debug logging.</font>
<font color="black"> 551.         &quot;&quot;&quot;</font>
<font color="green"> 552.         return utils.CursorWrapper(cursor, self)</font>
<font color="black"> 553. </font>
<font color="green"> 554.     @contextmanager</font>
<font color="black"> 555.     def temporary_connection(self):</font>
<font color="black"> 556.         &quot;&quot;&quot;</font>
<font color="black"> 557.         Context manager that ensures that a connection is established, and</font>
<font color="black"> 558.         if it opened one, closes it to avoid leaving a dangling connection.</font>
<font color="black"> 559.         This is useful for operations outside of the request-response cycle.</font>
<font color="black"> 560. </font>
<font color="black"> 561.         Provides a cursor: with self.temporary_connection() as cursor: ...</font>
<font color="black"> 562.         &quot;&quot;&quot;</font>
<font color="red"> 563.         must_close = self.connection is None</font>
<font color="red"> 564.         cursor = self.cursor()</font>
<font color="red"> 565.         try:</font>
<font color="red"> 566.             yield cursor</font>
<font color="black"> 567.         finally:</font>
<font color="red"> 568.             cursor.close()</font>
<font color="red"> 569.             if must_close:</font>
<font color="red"> 570.                 self.close()</font>
<font color="black"> 571. </font>
<font color="green"> 572.     @property</font>
<font color="black"> 573.     def _nodb_connection(self):</font>
<font color="black"> 574.         &quot;&quot;&quot;</font>
<font color="black"> 575.         Return an alternative connection to be used when there is no need to access</font>
<font color="black"> 576.         the main database, specifically for test db creation/deletion.</font>
<font color="black"> 577.         This also prevents the production database from being exposed to</font>
<font color="black"> 578.         potential child threads while (or after) the test database is destroyed.</font>
<font color="black"> 579.         Refs #10868, #17786, #16969.</font>
<font color="black"> 580.         &quot;&quot;&quot;</font>
<font color="red"> 581.         settings_dict = self.settings_dict.copy()</font>
<font color="red"> 582.         settings_dict['NAME'] = None</font>
<font color="red"> 583.         nodb_connection = self.__class__(</font>
<font color="red"> 584.             settings_dict,</font>
<font color="red"> 585.             alias=NO_DB_ALIAS,</font>
<font color="red"> 586.             allow_thread_sharing=False)</font>
<font color="red"> 587.         return nodb_connection</font>
<font color="black"> 588. </font>
<font color="green"> 589.     def _start_transaction_under_autocommit(self):</font>
<font color="black"> 590.         &quot;&quot;&quot;</font>
<font color="black"> 591.         Only required when autocommits_when_autocommit_is_off = True.</font>
<font color="black"> 592.         &quot;&quot;&quot;</font>
<font color="red"> 593.         raise NotImplementedError(</font>
<font color="red"> 594.             'subclasses of BaseDatabaseWrapper may require a '</font>
<font color="black"> 595.             '_start_transaction_under_autocommit() method'</font>
<font color="black"> 596.         )</font>
<font color="black"> 597. </font>
<font color="green"> 598.     def schema_editor(self, *args, **kwargs):</font>
<font color="black"> 599.         &quot;&quot;&quot;</font>
<font color="black"> 600.         Returns a new instance of this backend's SchemaEditor.</font>
<font color="black"> 601.         &quot;&quot;&quot;</font>
<font color="green"> 602.         if self.SchemaEditorClass is None:</font>
<font color="red"> 603.             raise NotImplementedError(</font>
<font color="red"> 604.                 'The SchemaEditorClass attribute of this database wrapper is still None')</font>
<font color="green"> 605.         return self.SchemaEditorClass(self, *args, **kwargs)</font>
<font color="black"> 606. </font>
<font color="green"> 607.     def on_commit(self, func):</font>
<font color="red"> 608.         if self.in_atomic_block:</font>
<font color="black"> 609.             # Transaction in progress; save for execution on commit.</font>
<font color="red"> 610.             self.run_on_commit.append((set(self.savepoint_ids), func))</font>
<font color="red"> 611.         elif not self.get_autocommit():</font>
<font color="red"> 612.             raise TransactionManagementError('on_commit() cannot be used in manual transaction management')</font>
<font color="black"> 613.         else:</font>
<font color="black"> 614.             # No transaction in progress and in autocommit mode; execute</font>
<font color="black"> 615.             # immediately.</font>
<font color="red"> 616.             func()</font>
<font color="black"> 617. </font>
<font color="green"> 618.     def run_and_clear_commit_hooks(self):</font>
<font color="green"> 619.         self.validate_no_atomic_block()</font>
<font color="green"> 620.         try:</font>
<font color="green"> 621.             while self.run_on_commit:</font>
<font color="red"> 622.                 sids, func = self.run_on_commit.pop(0)</font>
<font color="red"> 623.                 func()</font>
<font color="black"> 624.         finally:</font>
<font color="green"> 625.             self.run_on_commit = []</font>
<font color="black"> 626. </font>
<font color="green"> 627.     def copy(self, alias=None, allow_thread_sharing=None):</font>
<font color="black"> 628.         &quot;&quot;&quot;</font>
<font color="black"> 629.         Return a copy of this connection.</font>
<font color="black"> 630. </font>
<font color="black"> 631.         For tests that require two connections to the same database.</font>
<font color="black"> 632.         &quot;&quot;&quot;</font>
<font color="red"> 633.         settings_dict = copy.deepcopy(self.settings_dict)</font>
<font color="red"> 634.         if alias is None:</font>
<font color="red"> 635.             alias = self.alias</font>
<font color="red"> 636.         if allow_thread_sharing is None:</font>
<font color="red"> 637.             allow_thread_sharing = self.allow_thread_sharing</font>
<font color="red"> 638.         return type(self)(settings_dict, alias, allow_thread_sharing)</font>
</pre>


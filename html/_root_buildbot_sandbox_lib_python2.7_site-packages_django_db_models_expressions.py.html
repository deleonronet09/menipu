source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/models/expressions.py</b><br>


file stats: <b>632 lines, 244 executed: 38.6% covered</b>
<pre>
<font color="green">   1. import copy</font>
<font color="green">   2. import datetime</font>
<font color="black">   3. </font>
<font color="green">   4. from django.conf import settings</font>
<font color="green">   5. from django.core.exceptions import FieldError</font>
<font color="green">   6. from django.db.backends import utils as backend_utils</font>
<font color="green">   7. from django.db.models import fields</font>
<font color="green">   8. from django.db.models.constants import LOOKUP_SEP</font>
<font color="green">   9. from django.db.models.query_utils import Q, refs_aggregate</font>
<font color="green">  10. from django.utils import six, timezone</font>
<font color="green">  11. from django.utils.functional import cached_property</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. class Combinable(object):</font>
<font color="black">  15.     &quot;&quot;&quot;</font>
<font color="black">  16.     Provides the ability to combine one or two objects with</font>
<font color="black">  17.     some connector. For example F('foo') + F('bar').</font>
<font color="green">  18.     &quot;&quot;&quot;</font>
<font color="black">  19. </font>
<font color="black">  20.     # Arithmetic connectors</font>
<font color="green">  21.     ADD = '+'</font>
<font color="green">  22.     SUB = '-'</font>
<font color="green">  23.     MUL = '*'</font>
<font color="green">  24.     DIV = '/'</font>
<font color="green">  25.     POW = '^'</font>
<font color="black">  26.     # The following is a quoted % operator - it is quoted because it can be</font>
<font color="black">  27.     # used in strings that also have parameter substitution.</font>
<font color="green">  28.     MOD = '%%'</font>
<font color="black">  29. </font>
<font color="black">  30.     # Bitwise operators - note that these are generated by .bitand()</font>
<font color="black">  31.     # and .bitor(), the '&amp;' and '|' are reserved for boolean operator</font>
<font color="black">  32.     # usage.</font>
<font color="green">  33.     BITAND = '&amp;'</font>
<font color="green">  34.     BITOR = '|'</font>
<font color="black">  35. </font>
<font color="green">  36.     def _combine(self, other, connector, reversed, node=None):</font>
<font color="red">  37.         if not hasattr(other, 'resolve_expression'):</font>
<font color="black">  38.             # everything must be resolvable to an expression</font>
<font color="red">  39.             if isinstance(other, datetime.timedelta):</font>
<font color="red">  40.                 other = DurationValue(other, output_field=fields.DurationField())</font>
<font color="black">  41.             else:</font>
<font color="red">  42.                 other = Value(other)</font>
<font color="black">  43. </font>
<font color="red">  44.         if reversed:</font>
<font color="red">  45.             return CombinedExpression(other, connector, self)</font>
<font color="red">  46.         return CombinedExpression(self, connector, other)</font>
<font color="black">  47. </font>
<font color="black">  48.     #############</font>
<font color="black">  49.     # OPERATORS #</font>
<font color="black">  50.     #############</font>
<font color="black">  51. </font>
<font color="green">  52.     def __add__(self, other):</font>
<font color="red">  53.         return self._combine(other, self.ADD, False)</font>
<font color="black">  54. </font>
<font color="green">  55.     def __sub__(self, other):</font>
<font color="red">  56.         return self._combine(other, self.SUB, False)</font>
<font color="black">  57. </font>
<font color="green">  58.     def __mul__(self, other):</font>
<font color="red">  59.         return self._combine(other, self.MUL, False)</font>
<font color="black">  60. </font>
<font color="green">  61.     def __truediv__(self, other):</font>
<font color="red">  62.         return self._combine(other, self.DIV, False)</font>
<font color="black">  63. </font>
<font color="green">  64.     def __div__(self, other):  # Python 2 compatibility</font>
<font color="red">  65.         return type(self).__truediv__(self, other)</font>
<font color="black">  66. </font>
<font color="green">  67.     def __mod__(self, other):</font>
<font color="red">  68.         return self._combine(other, self.MOD, False)</font>
<font color="black">  69. </font>
<font color="green">  70.     def __pow__(self, other):</font>
<font color="red">  71.         return self._combine(other, self.POW, False)</font>
<font color="black">  72. </font>
<font color="green">  73.     def __and__(self, other):</font>
<font color="red">  74.         raise NotImplementedError(</font>
<font color="red">  75.             &quot;Use .bitand() and .bitor() for bitwise logical operations.&quot;</font>
<font color="black">  76.         )</font>
<font color="black">  77. </font>
<font color="green">  78.     def bitand(self, other):</font>
<font color="red">  79.         return self._combine(other, self.BITAND, False)</font>
<font color="black">  80. </font>
<font color="green">  81.     def __or__(self, other):</font>
<font color="red">  82.         raise NotImplementedError(</font>
<font color="red">  83.             &quot;Use .bitand() and .bitor() for bitwise logical operations.&quot;</font>
<font color="black">  84.         )</font>
<font color="black">  85. </font>
<font color="green">  86.     def bitor(self, other):</font>
<font color="red">  87.         return self._combine(other, self.BITOR, False)</font>
<font color="black">  88. </font>
<font color="green">  89.     def __radd__(self, other):</font>
<font color="red">  90.         return self._combine(other, self.ADD, True)</font>
<font color="black">  91. </font>
<font color="green">  92.     def __rsub__(self, other):</font>
<font color="red">  93.         return self._combine(other, self.SUB, True)</font>
<font color="black">  94. </font>
<font color="green">  95.     def __rmul__(self, other):</font>
<font color="red">  96.         return self._combine(other, self.MUL, True)</font>
<font color="black">  97. </font>
<font color="green">  98.     def __rtruediv__(self, other):</font>
<font color="red">  99.         return self._combine(other, self.DIV, True)</font>
<font color="black"> 100. </font>
<font color="green"> 101.     def __rdiv__(self, other):  # Python 2 compatibility</font>
<font color="red"> 102.         return type(self).__rtruediv__(self, other)</font>
<font color="black"> 103. </font>
<font color="green"> 104.     def __rmod__(self, other):</font>
<font color="red"> 105.         return self._combine(other, self.MOD, True)</font>
<font color="black"> 106. </font>
<font color="green"> 107.     def __rpow__(self, other):</font>
<font color="red"> 108.         return self._combine(other, self.POW, True)</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def __rand__(self, other):</font>
<font color="red"> 111.         raise NotImplementedError(</font>
<font color="red"> 112.             &quot;Use .bitand() and .bitor() for bitwise logical operations.&quot;</font>
<font color="black"> 113.         )</font>
<font color="black"> 114. </font>
<font color="green"> 115.     def __ror__(self, other):</font>
<font color="red"> 116.         raise NotImplementedError(</font>
<font color="red"> 117.             &quot;Use .bitand() and .bitor() for bitwise logical operations.&quot;</font>
<font color="black"> 118.         )</font>
<font color="black"> 119. </font>
<font color="black"> 120. </font>
<font color="green"> 121. class BaseExpression(object):</font>
<font color="black"> 122.     &quot;&quot;&quot;</font>
<font color="black"> 123.     Base class for all query expressions.</font>
<font color="green"> 124.     &quot;&quot;&quot;</font>
<font color="black"> 125. </font>
<font color="black"> 126.     # aggregate specific fields</font>
<font color="green"> 127.     is_summary = False</font>
<font color="black"> 128. </font>
<font color="green"> 129.     def __init__(self, output_field=None):</font>
<font color="green"> 130.         self._output_field = output_field</font>
<font color="black"> 131. </font>
<font color="green"> 132.     def get_db_converters(self, connection):</font>
<font color="red"> 133.         return [self.convert_value] + self.output_field.get_db_converters(connection)</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def get_source_expressions(self):</font>
<font color="green"> 136.         return []</font>
<font color="black"> 137. </font>
<font color="green"> 138.     def set_source_expressions(self, exprs):</font>
<font color="green"> 139.         assert len(exprs) == 0</font>
<font color="black"> 140. </font>
<font color="green"> 141.     def _parse_expressions(self, *expressions):</font>
<font color="black"> 142.         return [</font>
<font color="red"> 143.             arg if hasattr(arg, 'resolve_expression') else (</font>
<font color="black"> 144.                 F(arg) if isinstance(arg, six.string_types) else Value(arg)</font>
<font color="red"> 145.             ) for arg in expressions</font>
<font color="black"> 146.         ]</font>
<font color="black"> 147. </font>
<font color="green"> 148.     def as_sql(self, compiler, connection):</font>
<font color="black"> 149.         &quot;&quot;&quot;</font>
<font color="black"> 150.         Responsible for returning a (sql, [params]) tuple to be included</font>
<font color="black"> 151.         in the current query.</font>
<font color="black"> 152. </font>
<font color="black"> 153.         Different backends can provide their own implementation, by</font>
<font color="black"> 154.         providing an `as_{vendor}` method and patching the Expression:</font>
<font color="black"> 155. </font>
<font color="black"> 156.         ```</font>
<font color="black"> 157.         def override_as_sql(self, compiler, connection):</font>
<font color="black"> 158.             # custom logic</font>
<font color="black"> 159.             return super(Expression, self).as_sql(compiler, connection)</font>
<font color="black"> 160.         setattr(Expression, 'as_' + connection.vendor, override_as_sql)</font>
<font color="black"> 161.         ```</font>
<font color="black"> 162. </font>
<font color="black"> 163.         Arguments:</font>
<font color="black"> 164.          * compiler: the query compiler responsible for generating the query.</font>
<font color="black"> 165.            Must have a compile method, returning a (sql, [params]) tuple.</font>
<font color="black"> 166.            Calling compiler(value) will return a quoted `value`.</font>
<font color="black"> 167. </font>
<font color="black"> 168.          * connection: the database connection used for the current query.</font>
<font color="black"> 169. </font>
<font color="black"> 170.         Returns: (sql, params)</font>
<font color="black"> 171.           Where `sql` is a string containing ordered sql parameters to be</font>
<font color="black"> 172.           replaced with the elements of the list `params`.</font>
<font color="black"> 173.         &quot;&quot;&quot;</font>
<font color="red"> 174.         raise NotImplementedError(&quot;Subclasses must implement as_sql()&quot;)</font>
<font color="black"> 175. </font>
<font color="green"> 176.     @cached_property</font>
<font color="black"> 177.     def contains_aggregate(self):</font>
<font color="green"> 178.         for expr in self.get_source_expressions():</font>
<font color="red"> 179.             if expr and expr.contains_aggregate:</font>
<font color="red"> 180.                 return True</font>
<font color="green"> 181.         return False</font>
<font color="black"> 182. </font>
<font color="green"> 183.     @cached_property</font>
<font color="black"> 184.     def contains_column_references(self):</font>
<font color="red"> 185.         for expr in self.get_source_expressions():</font>
<font color="red"> 186.             if expr and expr.contains_column_references:</font>
<font color="red"> 187.                 return True</font>
<font color="red"> 188.         return False</font>
<font color="black"> 189. </font>
<font color="green"> 190.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="black"> 191.         &quot;&quot;&quot;</font>
<font color="black"> 192.         Provides the chance to do any preprocessing or validation before being</font>
<font color="black"> 193.         added to the query.</font>
<font color="black"> 194. </font>
<font color="black"> 195.         Arguments:</font>
<font color="black"> 196.          * query: the backend query implementation</font>
<font color="black"> 197.          * allow_joins: boolean allowing or denying use of joins</font>
<font color="black"> 198.            in this query</font>
<font color="black"> 199.          * reuse: a set of reusable joins for multijoins</font>
<font color="black"> 200.          * summarize: a terminal aggregate clause</font>
<font color="black"> 201.          * for_save: whether this expression about to be used in a save or update</font>
<font color="black"> 202. </font>
<font color="black"> 203.         Returns: an Expression to be added to the query.</font>
<font color="black"> 204.         &quot;&quot;&quot;</font>
<font color="green"> 205.         c = self.copy()</font>
<font color="green"> 206.         c.is_summary = summarize</font>
<font color="green"> 207.         c.set_source_expressions([</font>
<font color="green"> 208.             expr.resolve_expression(query, allow_joins, reuse, summarize)</font>
<font color="green"> 209.             for expr in c.get_source_expressions()</font>
<font color="black"> 210.         ])</font>
<font color="green"> 211.         return c</font>
<font color="black"> 212. </font>
<font color="green"> 213.     def _prepare(self):</font>
<font color="black"> 214.         &quot;&quot;&quot;</font>
<font color="black"> 215.         Hook used by Field.get_prep_lookup() to do custom preparation.</font>
<font color="black"> 216.         &quot;&quot;&quot;</font>
<font color="red"> 217.         return self</font>
<font color="black"> 218. </font>
<font color="green"> 219.     @property</font>
<font color="black"> 220.     def field(self):</font>
<font color="red"> 221.         return self.output_field</font>
<font color="black"> 222. </font>
<font color="green"> 223.     @cached_property</font>
<font color="black"> 224.     def output_field(self):</font>
<font color="black"> 225.         &quot;&quot;&quot;</font>
<font color="black"> 226.         Returns the output type of this expressions.</font>
<font color="black"> 227.         &quot;&quot;&quot;</font>
<font color="green"> 228.         if self._output_field_or_none is None:</font>
<font color="red"> 229.             raise FieldError(&quot;Cannot resolve expression type, unknown output_field&quot;)</font>
<font color="green"> 230.         return self._output_field_or_none</font>
<font color="black"> 231. </font>
<font color="green"> 232.     @cached_property</font>
<font color="black"> 233.     def _output_field_or_none(self):</font>
<font color="black"> 234.         &quot;&quot;&quot;</font>
<font color="black"> 235.         Returns the output field of this expression, or None if no output type</font>
<font color="black"> 236.         can be resolved. Note that the 'output_field' property will raise</font>
<font color="black"> 237.         FieldError if no type can be resolved, but this attribute allows for</font>
<font color="black"> 238.         None values.</font>
<font color="black"> 239.         &quot;&quot;&quot;</font>
<font color="green"> 240.         if self._output_field is None:</font>
<font color="red"> 241.             self._resolve_output_field()</font>
<font color="green"> 242.         return self._output_field</font>
<font color="black"> 243. </font>
<font color="green"> 244.     def _resolve_output_field(self):</font>
<font color="black"> 245.         &quot;&quot;&quot;</font>
<font color="black"> 246.         Attempts to infer the output type of the expression. If the output</font>
<font color="black"> 247.         fields of all source fields match then we can simply infer the same</font>
<font color="black"> 248.         type here. This isn't always correct, but it makes sense most of the</font>
<font color="black"> 249.         time.</font>
<font color="black"> 250. </font>
<font color="black"> 251.         Consider the difference between `2 + 2` and `2 / 3`. Inferring</font>
<font color="black"> 252.         the type here is a convenience for the common case. The user should</font>
<font color="black"> 253.         supply their own output_field with more complex computations.</font>
<font color="black"> 254. </font>
<font color="black"> 255.         If a source does not have an `_output_field` then we exclude it from</font>
<font color="black"> 256.         this check. If all sources are `None`, then an error will be thrown</font>
<font color="black"> 257.         higher up the stack in the `output_field` property.</font>
<font color="black"> 258.         &quot;&quot;&quot;</font>
<font color="red"> 259.         if self._output_field is None:</font>
<font color="red"> 260.             sources = self.get_source_fields()</font>
<font color="red"> 261.             num_sources = len(sources)</font>
<font color="red"> 262.             if num_sources == 0:</font>
<font color="red"> 263.                 self._output_field = None</font>
<font color="black"> 264.             else:</font>
<font color="red"> 265.                 for source in sources:</font>
<font color="red"> 266.                     if self._output_field is None:</font>
<font color="red"> 267.                         self._output_field = source</font>
<font color="red"> 268.                     if source is not None and not isinstance(self._output_field, source.__class__):</font>
<font color="red"> 269.                         raise FieldError(</font>
<font color="red"> 270.                             &quot;Expression contains mixed types. You must set output_field&quot;)</font>
<font color="black"> 271. </font>
<font color="green"> 272.     def convert_value(self, value, expression, connection, context):</font>
<font color="black"> 273.         &quot;&quot;&quot;</font>
<font color="black"> 274.         Expressions provide their own converters because users have the option</font>
<font color="black"> 275.         of manually specifying the output_field which may be a different type</font>
<font color="black"> 276.         from the one the database returns.</font>
<font color="black"> 277.         &quot;&quot;&quot;</font>
<font color="red"> 278.         field = self.output_field</font>
<font color="red"> 279.         internal_type = field.get_internal_type()</font>
<font color="red"> 280.         if value is None:</font>
<font color="red"> 281.             return value</font>
<font color="red"> 282.         elif internal_type == 'FloatField':</font>
<font color="red"> 283.             return float(value)</font>
<font color="red"> 284.         elif internal_type.endswith('IntegerField'):</font>
<font color="red"> 285.             return int(value)</font>
<font color="red"> 286.         elif internal_type == 'DecimalField':</font>
<font color="red"> 287.             return backend_utils.typecast_decimal(value)</font>
<font color="red"> 288.         return value</font>
<font color="black"> 289. </font>
<font color="green"> 290.     def get_lookup(self, lookup):</font>
<font color="green"> 291.         return self.output_field.get_lookup(lookup)</font>
<font color="black"> 292. </font>
<font color="green"> 293.     def get_transform(self, name):</font>
<font color="red"> 294.         return self.output_field.get_transform(name)</font>
<font color="black"> 295. </font>
<font color="green"> 296.     def relabeled_clone(self, change_map):</font>
<font color="red"> 297.         clone = self.copy()</font>
<font color="red"> 298.         clone.set_source_expressions(</font>
<font color="red"> 299.             [e.relabeled_clone(change_map) for e in self.get_source_expressions()])</font>
<font color="red"> 300.         return clone</font>
<font color="black"> 301. </font>
<font color="green"> 302.     def copy(self):</font>
<font color="green"> 303.         c = copy.copy(self)</font>
<font color="green"> 304.         c.copied = True</font>
<font color="green"> 305.         return c</font>
<font color="black"> 306. </font>
<font color="green"> 307.     def refs_aggregate(self, existing_aggregates):</font>
<font color="black"> 308.         &quot;&quot;&quot;</font>
<font color="black"> 309.         Does this expression contain a reference to some of the</font>
<font color="black"> 310.         existing aggregates? If so, returns the aggregate and also</font>
<font color="black"> 311.         the lookup parts that *weren't* found. So, if</font>
<font color="black"> 312.             exsiting_aggregates = {'max_id': Max('id')}</font>
<font color="black"> 313.             self.name = 'max_id'</font>
<font color="black"> 314.             queryset.filter(max_id__range=[10,100])</font>
<font color="black"> 315.         then this method will return Max('id') and those parts of the</font>
<font color="black"> 316.         name that weren't found. In this case `max_id` is found and the range</font>
<font color="black"> 317.         portion is returned as ('range',).</font>
<font color="black"> 318.         &quot;&quot;&quot;</font>
<font color="red"> 319.         for node in self.get_source_expressions():</font>
<font color="red"> 320.             agg, lookup = node.refs_aggregate(existing_aggregates)</font>
<font color="red"> 321.             if agg:</font>
<font color="red"> 322.                 return agg, lookup</font>
<font color="red"> 323.         return False, ()</font>
<font color="black"> 324. </font>
<font color="green"> 325.     def get_group_by_cols(self):</font>
<font color="red"> 326.         if not self.contains_aggregate:</font>
<font color="red"> 327.             return [self]</font>
<font color="red"> 328.         cols = []</font>
<font color="red"> 329.         for source in self.get_source_expressions():</font>
<font color="red"> 330.             cols.extend(source.get_group_by_cols())</font>
<font color="red"> 331.         return cols</font>
<font color="black"> 332. </font>
<font color="green"> 333.     def get_source_fields(self):</font>
<font color="black"> 334.         &quot;&quot;&quot;</font>
<font color="black"> 335.         Returns the underlying field types used by this</font>
<font color="black"> 336.         aggregate.</font>
<font color="black"> 337.         &quot;&quot;&quot;</font>
<font color="red"> 338.         return [e._output_field_or_none for e in self.get_source_expressions()]</font>
<font color="black"> 339. </font>
<font color="green"> 340.     def asc(self):</font>
<font color="red"> 341.         return OrderBy(self)</font>
<font color="black"> 342. </font>
<font color="green"> 343.     def desc(self):</font>
<font color="red"> 344.         return OrderBy(self, descending=True)</font>
<font color="black"> 345. </font>
<font color="green"> 346.     def reverse_ordering(self):</font>
<font color="red"> 347.         return self</font>
<font color="black"> 348. </font>
<font color="green"> 349.     def flatten(self):</font>
<font color="black"> 350.         &quot;&quot;&quot;</font>
<font color="black"> 351.         Recursively yield this expression and all subexpressions, in</font>
<font color="black"> 352.         depth-first order.</font>
<font color="black"> 353.         &quot;&quot;&quot;</font>
<font color="red"> 354.         yield self</font>
<font color="red"> 355.         for expr in self.get_source_expressions():</font>
<font color="red"> 356.             if expr:</font>
<font color="red"> 357.                 for inner_expr in expr.flatten():</font>
<font color="red"> 358.                     yield inner_expr</font>
<font color="black"> 359. </font>
<font color="black"> 360. </font>
<font color="green"> 361. class Expression(BaseExpression, Combinable):</font>
<font color="black"> 362.     &quot;&quot;&quot;</font>
<font color="black"> 363.     An expression that can be combined with other expressions.</font>
<font color="green"> 364.     &quot;&quot;&quot;</font>
<font color="green"> 365.     pass</font>
<font color="black"> 366. </font>
<font color="black"> 367. </font>
<font color="green"> 368. class CombinedExpression(Expression):</font>
<font color="black"> 369. </font>
<font color="green"> 370.     def __init__(self, lhs, connector, rhs, output_field=None):</font>
<font color="red"> 371.         super(CombinedExpression, self).__init__(output_field=output_field)</font>
<font color="red"> 372.         self.connector = connector</font>
<font color="red"> 373.         self.lhs = lhs</font>
<font color="red"> 374.         self.rhs = rhs</font>
<font color="black"> 375. </font>
<font color="green"> 376.     def __repr__(self):</font>
<font color="red"> 377.         return &quot;&lt;{}: {}&gt;&quot;.format(self.__class__.__name__, self)</font>
<font color="black"> 378. </font>
<font color="green"> 379.     def __str__(self):</font>
<font color="red"> 380.         return &quot;{} {} {}&quot;.format(self.lhs, self.connector, self.rhs)</font>
<font color="black"> 381. </font>
<font color="green"> 382.     def get_source_expressions(self):</font>
<font color="red"> 383.         return [self.lhs, self.rhs]</font>
<font color="black"> 384. </font>
<font color="green"> 385.     def set_source_expressions(self, exprs):</font>
<font color="red"> 386.         self.lhs, self.rhs = exprs</font>
<font color="black"> 387. </font>
<font color="green"> 388.     def as_sql(self, compiler, connection):</font>
<font color="red"> 389.         try:</font>
<font color="red"> 390.             lhs_output = self.lhs.output_field</font>
<font color="red"> 391.         except FieldError:</font>
<font color="red"> 392.             lhs_output = None</font>
<font color="red"> 393.         try:</font>
<font color="red"> 394.             rhs_output = self.rhs.output_field</font>
<font color="red"> 395.         except FieldError:</font>
<font color="red"> 396.             rhs_output = None</font>
<font color="red"> 397.         if (not connection.features.has_native_duration_field and</font>
<font color="red"> 398.                 ((lhs_output and lhs_output.get_internal_type() == 'DurationField')</font>
<font color="red"> 399.                 or (rhs_output and rhs_output.get_internal_type() == 'DurationField'))):</font>
<font color="red"> 400.             return DurationExpression(self.lhs, self.connector, self.rhs).as_sql(compiler, connection)</font>
<font color="red"> 401.         expressions = []</font>
<font color="red"> 402.         expression_params = []</font>
<font color="red"> 403.         sql, params = compiler.compile(self.lhs)</font>
<font color="red"> 404.         expressions.append(sql)</font>
<font color="red"> 405.         expression_params.extend(params)</font>
<font color="red"> 406.         sql, params = compiler.compile(self.rhs)</font>
<font color="red"> 407.         expressions.append(sql)</font>
<font color="red"> 408.         expression_params.extend(params)</font>
<font color="black"> 409.         # order of precedence</font>
<font color="red"> 410.         expression_wrapper = '(%s)'</font>
<font color="red"> 411.         sql = connection.ops.combine_expression(self.connector, expressions)</font>
<font color="red"> 412.         return expression_wrapper % sql, expression_params</font>
<font color="black"> 413. </font>
<font color="green"> 414.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 415.         c = self.copy()</font>
<font color="red"> 416.         c.is_summary = summarize</font>
<font color="red"> 417.         c.lhs = c.lhs.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 418.         c.rhs = c.rhs.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 419.         return c</font>
<font color="black"> 420. </font>
<font color="black"> 421. </font>
<font color="green"> 422. class DurationExpression(CombinedExpression):</font>
<font color="green"> 423.     def compile(self, side, compiler, connection):</font>
<font color="red"> 424.         if not isinstance(side, DurationValue):</font>
<font color="red"> 425.             try:</font>
<font color="red"> 426.                 output = side.output_field</font>
<font color="red"> 427.             except FieldError:</font>
<font color="red"> 428.                 pass</font>
<font color="black"> 429.             else:</font>
<font color="red"> 430.                 if output.get_internal_type() == 'DurationField':</font>
<font color="red"> 431.                     sql, params = compiler.compile(side)</font>
<font color="red"> 432.                     return connection.ops.format_for_duration_arithmetic(sql), params</font>
<font color="red"> 433.         return compiler.compile(side)</font>
<font color="black"> 434. </font>
<font color="green"> 435.     def as_sql(self, compiler, connection):</font>
<font color="red"> 436.         connection.ops.check_expression_support(self)</font>
<font color="red"> 437.         expressions = []</font>
<font color="red"> 438.         expression_params = []</font>
<font color="red"> 439.         sql, params = self.compile(self.lhs, compiler, connection)</font>
<font color="red"> 440.         expressions.append(sql)</font>
<font color="red"> 441.         expression_params.extend(params)</font>
<font color="red"> 442.         sql, params = self.compile(self.rhs, compiler, connection)</font>
<font color="red"> 443.         expressions.append(sql)</font>
<font color="red"> 444.         expression_params.extend(params)</font>
<font color="black"> 445.         # order of precedence</font>
<font color="red"> 446.         expression_wrapper = '(%s)'</font>
<font color="red"> 447.         sql = connection.ops.combine_duration_expression(self.connector, expressions)</font>
<font color="red"> 448.         return expression_wrapper % sql, expression_params</font>
<font color="black"> 449. </font>
<font color="black"> 450. </font>
<font color="green"> 451. class F(Combinable):</font>
<font color="black"> 452.     &quot;&quot;&quot;</font>
<font color="black"> 453.     An object capable of resolving references to existing query objects.</font>
<font color="green"> 454.     &quot;&quot;&quot;</font>
<font color="green"> 455.     def __init__(self, name):</font>
<font color="black"> 456.         &quot;&quot;&quot;</font>
<font color="black"> 457.         Arguments:</font>
<font color="black"> 458.          * name: the name of the field this expression references</font>
<font color="black"> 459.         &quot;&quot;&quot;</font>
<font color="red"> 460.         self.name = name</font>
<font color="black"> 461. </font>
<font color="green"> 462.     def __repr__(self):</font>
<font color="red"> 463.         return &quot;{}({})&quot;.format(self.__class__.__name__, self.name)</font>
<font color="black"> 464. </font>
<font color="green"> 465.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 466.         return query.resolve_ref(self.name, allow_joins, reuse, summarize)</font>
<font color="black"> 467. </font>
<font color="green"> 468.     def refs_aggregate(self, existing_aggregates):</font>
<font color="red"> 469.         return refs_aggregate(self.name.split(LOOKUP_SEP), existing_aggregates)</font>
<font color="black"> 470. </font>
<font color="green"> 471.     def asc(self):</font>
<font color="red"> 472.         return OrderBy(self)</font>
<font color="black"> 473. </font>
<font color="green"> 474.     def desc(self):</font>
<font color="red"> 475.         return OrderBy(self, descending=True)</font>
<font color="black"> 476. </font>
<font color="black"> 477. </font>
<font color="green"> 478. class Func(Expression):</font>
<font color="black"> 479.     &quot;&quot;&quot;</font>
<font color="black"> 480.     A SQL function call.</font>
<font color="green"> 481.     &quot;&quot;&quot;</font>
<font color="green"> 482.     function = None</font>
<font color="green"> 483.     template = '%(function)s(%(expressions)s)'</font>
<font color="green"> 484.     arg_joiner = ', '</font>
<font color="black"> 485. </font>
<font color="green"> 486.     def __init__(self, *expressions, **extra):</font>
<font color="red"> 487.         output_field = extra.pop('output_field', None)</font>
<font color="red"> 488.         super(Func, self).__init__(output_field=output_field)</font>
<font color="red"> 489.         self.source_expressions = self._parse_expressions(*expressions)</font>
<font color="red"> 490.         self.extra = extra</font>
<font color="black"> 491. </font>
<font color="green"> 492.     def __repr__(self):</font>
<font color="red"> 493.         args = self.arg_joiner.join(str(arg) for arg in self.source_expressions)</font>
<font color="red"> 494.         extra = ', '.join(str(key) + '=' + str(val) for key, val in self.extra.items())</font>
<font color="red"> 495.         if extra:</font>
<font color="red"> 496.             return &quot;{}({}, {})&quot;.format(self.__class__.__name__, args, extra)</font>
<font color="red"> 497.         return &quot;{}({})&quot;.format(self.__class__.__name__, args)</font>
<font color="black"> 498. </font>
<font color="green"> 499.     def get_source_expressions(self):</font>
<font color="red"> 500.         return self.source_expressions</font>
<font color="black"> 501. </font>
<font color="green"> 502.     def set_source_expressions(self, exprs):</font>
<font color="red"> 503.         self.source_expressions = exprs</font>
<font color="black"> 504. </font>
<font color="green"> 505.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 506.         c = self.copy()</font>
<font color="red"> 507.         c.is_summary = summarize</font>
<font color="red"> 508.         for pos, arg in enumerate(c.source_expressions):</font>
<font color="red"> 509.             c.source_expressions[pos] = arg.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 510.         return c</font>
<font color="black"> 511. </font>
<font color="green"> 512.     def as_sql(self, compiler, connection, function=None, template=None):</font>
<font color="red"> 513.         connection.ops.check_expression_support(self)</font>
<font color="red"> 514.         sql_parts = []</font>
<font color="red"> 515.         params = []</font>
<font color="red"> 516.         for arg in self.source_expressions:</font>
<font color="red"> 517.             arg_sql, arg_params = compiler.compile(arg)</font>
<font color="red"> 518.             sql_parts.append(arg_sql)</font>
<font color="red"> 519.             params.extend(arg_params)</font>
<font color="red"> 520.         if function is None:</font>
<font color="red"> 521.             self.extra['function'] = self.extra.get('function', self.function)</font>
<font color="black"> 522.         else:</font>
<font color="red"> 523.             self.extra['function'] = function</font>
<font color="red"> 524.         self.extra['expressions'] = self.extra['field'] = self.arg_joiner.join(sql_parts)</font>
<font color="red"> 525.         template = template or self.extra.get('template', self.template)</font>
<font color="red"> 526.         return template % self.extra, params</font>
<font color="black"> 527. </font>
<font color="green"> 528.     def as_sqlite(self, *args, **kwargs):</font>
<font color="red"> 529.         sql, params = self.as_sql(*args, **kwargs)</font>
<font color="red"> 530.         try:</font>
<font color="red"> 531.             if self.output_field.get_internal_type() == 'DecimalField':</font>
<font color="red"> 532.                 sql = 'CAST(%s AS NUMERIC)' % sql</font>
<font color="red"> 533.         except FieldError:</font>
<font color="red"> 534.             pass</font>
<font color="red"> 535.         return sql, params</font>
<font color="black"> 536. </font>
<font color="green"> 537.     def copy(self):</font>
<font color="red"> 538.         copy = super(Func, self).copy()</font>
<font color="red"> 539.         copy.source_expressions = self.source_expressions[:]</font>
<font color="red"> 540.         copy.extra = self.extra.copy()</font>
<font color="red"> 541.         return copy</font>
<font color="black"> 542. </font>
<font color="black"> 543. </font>
<font color="green"> 544. class Value(Expression):</font>
<font color="black"> 545.     &quot;&quot;&quot;</font>
<font color="black"> 546.     Represents a wrapped value as a node within an expression</font>
<font color="green"> 547.     &quot;&quot;&quot;</font>
<font color="green"> 548.     def __init__(self, value, output_field=None):</font>
<font color="black"> 549.         &quot;&quot;&quot;</font>
<font color="black"> 550.         Arguments:</font>
<font color="black"> 551.          * value: the value this expression represents. The value will be</font>
<font color="black"> 552.            added into the sql parameter list and properly quoted.</font>
<font color="black"> 553. </font>
<font color="black"> 554.          * output_field: an instance of the model field type that this</font>
<font color="black"> 555.            expression will return, such as IntegerField() or CharField().</font>
<font color="black"> 556.         &quot;&quot;&quot;</font>
<font color="red"> 557.         super(Value, self).__init__(output_field=output_field)</font>
<font color="red"> 558.         self.value = value</font>
<font color="black"> 559. </font>
<font color="green"> 560.     def __repr__(self):</font>
<font color="red"> 561.         return &quot;{}({})&quot;.format(self.__class__.__name__, self.value)</font>
<font color="black"> 562. </font>
<font color="green"> 563.     def as_sql(self, compiler, connection):</font>
<font color="red"> 564.         connection.ops.check_expression_support(self)</font>
<font color="red"> 565.         val = self.value</font>
<font color="black"> 566.         # check _output_field to avoid triggering an exception</font>
<font color="red"> 567.         if self._output_field is not None:</font>
<font color="red"> 568.             if self.for_save:</font>
<font color="red"> 569.                 val = self.output_field.get_db_prep_save(val, connection=connection)</font>
<font color="black"> 570.             else:</font>
<font color="red"> 571.                 val = self.output_field.get_db_prep_value(val, connection=connection)</font>
<font color="red"> 572.         if val is None:</font>
<font color="black"> 573.             # cx_Oracle does not always convert None to the appropriate</font>
<font color="black"> 574.             # NULL type (like in case expressions using numbers), so we</font>
<font color="black"> 575.             # use a literal SQL NULL</font>
<font color="red"> 576.             return 'NULL', []</font>
<font color="red"> 577.         return '%s', [val]</font>
<font color="black"> 578. </font>
<font color="green"> 579.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 580.         c = super(Value, self).resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 581.         c.for_save = for_save</font>
<font color="red"> 582.         return c</font>
<font color="black"> 583. </font>
<font color="green"> 584.     def get_group_by_cols(self):</font>
<font color="red"> 585.         return []</font>
<font color="black"> 586. </font>
<font color="black"> 587. </font>
<font color="green"> 588. class DurationValue(Value):</font>
<font color="green"> 589.     def as_sql(self, compiler, connection):</font>
<font color="red"> 590.         connection.ops.check_expression_support(self)</font>
<font color="red"> 591.         if (connection.features.has_native_duration_field and</font>
<font color="red"> 592.                 connection.features.driver_supports_timedelta_args):</font>
<font color="red"> 593.             return super(DurationValue, self).as_sql(compiler, connection)</font>
<font color="red"> 594.         return connection.ops.date_interval_sql(self.value)</font>
<font color="black"> 595. </font>
<font color="black"> 596. </font>
<font color="green"> 597. class RawSQL(Expression):</font>
<font color="green"> 598.     def __init__(self, sql, params, output_field=None):</font>
<font color="red"> 599.         if output_field is None:</font>
<font color="red"> 600.             output_field = fields.Field()</font>
<font color="red"> 601.         self.sql, self.params = sql, params</font>
<font color="red"> 602.         super(RawSQL, self).__init__(output_field=output_field)</font>
<font color="black"> 603. </font>
<font color="green"> 604.     def __repr__(self):</font>
<font color="red"> 605.         return &quot;{}({}, {})&quot;.format(self.__class__.__name__, self.sql, self.params)</font>
<font color="black"> 606. </font>
<font color="green"> 607.     def as_sql(self, compiler, connection):</font>
<font color="red"> 608.         return '(%s)' % self.sql, self.params</font>
<font color="black"> 609. </font>
<font color="green"> 610.     def get_group_by_cols(self):</font>
<font color="red"> 611.         return [self]</font>
<font color="black"> 612. </font>
<font color="black"> 613. </font>
<font color="green"> 614. class Star(Expression):</font>
<font color="green"> 615.     def __repr__(self):</font>
<font color="red"> 616.         return &quot;'*'&quot;</font>
<font color="black"> 617. </font>
<font color="green"> 618.     def as_sql(self, compiler, connection):</font>
<font color="red"> 619.         return '*', []</font>
<font color="black"> 620. </font>
<font color="black"> 621. </font>
<font color="green"> 622. class Random(Expression):</font>
<font color="green"> 623.     def __init__(self):</font>
<font color="red"> 624.         super(Random, self).__init__(output_field=fields.FloatField())</font>
<font color="black"> 625. </font>
<font color="green"> 626.     def __repr__(self):</font>
<font color="red"> 627.         return &quot;Random()&quot;</font>
<font color="black"> 628. </font>
<font color="green"> 629.     def as_sql(self, compiler, connection):</font>
<font color="red"> 630.         return connection.ops.random_function_sql(), []</font>
<font color="black"> 631. </font>
<font color="black"> 632. </font>
<font color="green"> 633. class Col(Expression):</font>
<font color="black"> 634. </font>
<font color="green"> 635.     contains_column_references = True</font>
<font color="black"> 636. </font>
<font color="green"> 637.     def __init__(self, alias, target, output_field=None):</font>
<font color="green"> 638.         if output_field is None:</font>
<font color="green"> 639.             output_field = target</font>
<font color="green"> 640.         super(Col, self).__init__(output_field=output_field)</font>
<font color="green"> 641.         self.alias, self.target = alias, target</font>
<font color="black"> 642. </font>
<font color="green"> 643.     def __repr__(self):</font>
<font color="red"> 644.         return &quot;{}({}, {})&quot;.format(</font>
<font color="red"> 645.             self.__class__.__name__, self.alias, self.target)</font>
<font color="black"> 646. </font>
<font color="green"> 647.     def as_sql(self, compiler, connection):</font>
<font color="green"> 648.         qn = compiler.quote_name_unless_alias</font>
<font color="green"> 649.         return &quot;%s.%s&quot; % (qn(self.alias), qn(self.target.column)), []</font>
<font color="black"> 650. </font>
<font color="green"> 651.     def relabeled_clone(self, relabels):</font>
<font color="red"> 652.         return self.__class__(relabels.get(self.alias, self.alias), self.target, self.output_field)</font>
<font color="black"> 653. </font>
<font color="green"> 654.     def get_group_by_cols(self):</font>
<font color="red"> 655.         return [self]</font>
<font color="black"> 656. </font>
<font color="green"> 657.     def get_db_converters(self, connection):</font>
<font color="green"> 658.         if self.target == self.output_field:</font>
<font color="green"> 659.             return self.output_field.get_db_converters(connection)</font>
<font color="green"> 660.         return (self.output_field.get_db_converters(connection) +</font>
<font color="green"> 661.                 self.target.get_db_converters(connection))</font>
<font color="black"> 662. </font>
<font color="black"> 663. </font>
<font color="green"> 664. class Ref(Expression):</font>
<font color="black"> 665.     &quot;&quot;&quot;</font>
<font color="black"> 666.     Reference to column alias of the query. For example, Ref('sum_cost') in</font>
<font color="black"> 667.     qs.annotate(sum_cost=Sum('cost')) query.</font>
<font color="green"> 668.     &quot;&quot;&quot;</font>
<font color="green"> 669.     def __init__(self, refs, source):</font>
<font color="red"> 670.         super(Ref, self).__init__()</font>
<font color="red"> 671.         self.refs, self.source = refs, source</font>
<font color="black"> 672. </font>
<font color="green"> 673.     def __repr__(self):</font>
<font color="red"> 674.         return &quot;{}({}, {})&quot;.format(self.__class__.__name__, self.refs, self.source)</font>
<font color="black"> 675. </font>
<font color="green"> 676.     def get_source_expressions(self):</font>
<font color="red"> 677.         return [self.source]</font>
<font color="black"> 678. </font>
<font color="green"> 679.     def set_source_expressions(self, exprs):</font>
<font color="red"> 680.         self.source, = exprs</font>
<font color="black"> 681. </font>
<font color="green"> 682.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="black"> 683.         # The sub-expression `source` has already been resolved, as this is</font>
<font color="black"> 684.         # just a reference to the name of `source`.</font>
<font color="red"> 685.         return self</font>
<font color="black"> 686. </font>
<font color="green"> 687.     def relabeled_clone(self, relabels):</font>
<font color="red"> 688.         return self</font>
<font color="black"> 689. </font>
<font color="green"> 690.     def as_sql(self, compiler, connection):</font>
<font color="red"> 691.         return &quot;%s&quot; % connection.ops.quote_name(self.refs), []</font>
<font color="black"> 692. </font>
<font color="green"> 693.     def get_group_by_cols(self):</font>
<font color="red"> 694.         return [self]</font>
<font color="black"> 695. </font>
<font color="black"> 696. </font>
<font color="green"> 697. class ExpressionWrapper(Expression):</font>
<font color="black"> 698.     &quot;&quot;&quot;</font>
<font color="black"> 699.     An expression that can wrap another expression so that it can provide</font>
<font color="black"> 700.     extra context to the inner expression, such as the output_field.</font>
<font color="green"> 701.     &quot;&quot;&quot;</font>
<font color="black"> 702. </font>
<font color="green"> 703.     def __init__(self, expression, output_field):</font>
<font color="red"> 704.         super(ExpressionWrapper, self).__init__(output_field=output_field)</font>
<font color="red"> 705.         self.expression = expression</font>
<font color="black"> 706. </font>
<font color="green"> 707.     def set_source_expressions(self, exprs):</font>
<font color="red"> 708.         self.expression = exprs[0]</font>
<font color="black"> 709. </font>
<font color="green"> 710.     def get_source_expressions(self):</font>
<font color="red"> 711.         return [self.expression]</font>
<font color="black"> 712. </font>
<font color="green"> 713.     def as_sql(self, compiler, connection):</font>
<font color="red"> 714.         return self.expression.as_sql(compiler, connection)</font>
<font color="black"> 715. </font>
<font color="green"> 716.     def __repr__(self):</font>
<font color="red"> 717.         return &quot;{}({})&quot;.format(self.__class__.__name__, self.expression)</font>
<font color="black"> 718. </font>
<font color="black"> 719. </font>
<font color="green"> 720. class When(Expression):</font>
<font color="green"> 721.     template = 'WHEN %(condition)s THEN %(result)s'</font>
<font color="black"> 722. </font>
<font color="green"> 723.     def __init__(self, condition=None, then=None, **lookups):</font>
<font color="red"> 724.         if lookups and condition is None:</font>
<font color="red"> 725.             condition, lookups = Q(**lookups), None</font>
<font color="red"> 726.         if condition is None or not isinstance(condition, Q) or lookups:</font>
<font color="red"> 727.             raise TypeError(&quot;__init__() takes either a Q object or lookups as keyword arguments&quot;)</font>
<font color="red"> 728.         super(When, self).__init__(output_field=None)</font>
<font color="red"> 729.         self.condition = condition</font>
<font color="red"> 730.         self.result = self._parse_expressions(then)[0]</font>
<font color="black"> 731. </font>
<font color="green"> 732.     def __str__(self):</font>
<font color="red"> 733.         return &quot;WHEN %r THEN %r&quot; % (self.condition, self.result)</font>
<font color="black"> 734. </font>
<font color="green"> 735.     def __repr__(self):</font>
<font color="red"> 736.         return &quot;&lt;%s: %s&gt;&quot; % (self.__class__.__name__, self)</font>
<font color="black"> 737. </font>
<font color="green"> 738.     def get_source_expressions(self):</font>
<font color="red"> 739.         return [self.condition, self.result]</font>
<font color="black"> 740. </font>
<font color="green"> 741.     def set_source_expressions(self, exprs):</font>
<font color="red"> 742.         self.condition, self.result = exprs</font>
<font color="black"> 743. </font>
<font color="green"> 744.     def get_source_fields(self):</font>
<font color="black"> 745.         # We're only interested in the fields of the result expressions.</font>
<font color="red"> 746.         return [self.result._output_field_or_none]</font>
<font color="black"> 747. </font>
<font color="green"> 748.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 749.         c = self.copy()</font>
<font color="red"> 750.         c.is_summary = summarize</font>
<font color="red"> 751.         c.condition = c.condition.resolve_expression(query, allow_joins, reuse, summarize, False)</font>
<font color="red"> 752.         c.result = c.result.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 753.         return c</font>
<font color="black"> 754. </font>
<font color="green"> 755.     def as_sql(self, compiler, connection, template=None):</font>
<font color="red"> 756.         connection.ops.check_expression_support(self)</font>
<font color="red"> 757.         template_params = {}</font>
<font color="red"> 758.         sql_params = []</font>
<font color="red"> 759.         condition_sql, condition_params = compiler.compile(self.condition)</font>
<font color="red"> 760.         template_params['condition'] = condition_sql</font>
<font color="red"> 761.         sql_params.extend(condition_params)</font>
<font color="red"> 762.         result_sql, result_params = compiler.compile(self.result)</font>
<font color="red"> 763.         template_params['result'] = result_sql</font>
<font color="red"> 764.         sql_params.extend(result_params)</font>
<font color="red"> 765.         template = template or self.template</font>
<font color="red"> 766.         return template % template_params, sql_params</font>
<font color="black"> 767. </font>
<font color="green"> 768.     def get_group_by_cols(self):</font>
<font color="black"> 769.         # This is not a complete expression and cannot be used in GROUP BY.</font>
<font color="red"> 770.         cols = []</font>
<font color="red"> 771.         for source in self.get_source_expressions():</font>
<font color="red"> 772.             cols.extend(source.get_group_by_cols())</font>
<font color="red"> 773.         return cols</font>
<font color="black"> 774. </font>
<font color="black"> 775. </font>
<font color="green"> 776. class Case(Expression):</font>
<font color="black"> 777.     &quot;&quot;&quot;</font>
<font color="black"> 778.     An SQL searched CASE expression:</font>
<font color="black"> 779. </font>
<font color="black"> 780.         CASE</font>
<font color="black"> 781.             WHEN n &gt; 0</font>
<font color="black"> 782.                 THEN 'positive'</font>
<font color="black"> 783.             WHEN n &lt; 0</font>
<font color="black"> 784.                 THEN 'negative'</font>
<font color="black"> 785.             ELSE 'zero'</font>
<font color="black"> 786.         END</font>
<font color="green"> 787.     &quot;&quot;&quot;</font>
<font color="green"> 788.     template = 'CASE %(cases)s ELSE %(default)s END'</font>
<font color="green"> 789.     case_joiner = ' '</font>
<font color="black"> 790. </font>
<font color="green"> 791.     def __init__(self, *cases, **extra):</font>
<font color="red"> 792.         if not all(isinstance(case, When) for case in cases):</font>
<font color="red"> 793.             raise TypeError(&quot;Positional arguments must all be When objects.&quot;)</font>
<font color="red"> 794.         default = extra.pop('default', None)</font>
<font color="red"> 795.         output_field = extra.pop('output_field', None)</font>
<font color="red"> 796.         super(Case, self).__init__(output_field)</font>
<font color="red"> 797.         self.cases = list(cases)</font>
<font color="red"> 798.         self.default = self._parse_expressions(default)[0]</font>
<font color="black"> 799. </font>
<font color="green"> 800.     def __str__(self):</font>
<font color="red"> 801.         return &quot;CASE %s, ELSE %r&quot; % (', '.join(str(c) for c in self.cases), self.default)</font>
<font color="black"> 802. </font>
<font color="green"> 803.     def __repr__(self):</font>
<font color="red"> 804.         return &quot;&lt;%s: %s&gt;&quot; % (self.__class__.__name__, self)</font>
<font color="black"> 805. </font>
<font color="green"> 806.     def get_source_expressions(self):</font>
<font color="red"> 807.         return self.cases + [self.default]</font>
<font color="black"> 808. </font>
<font color="green"> 809.     def set_source_expressions(self, exprs):</font>
<font color="red"> 810.         self.cases = exprs[:-1]</font>
<font color="red"> 811.         self.default = exprs[-1]</font>
<font color="black"> 812. </font>
<font color="green"> 813.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 814.         c = self.copy()</font>
<font color="red"> 815.         c.is_summary = summarize</font>
<font color="red"> 816.         for pos, case in enumerate(c.cases):</font>
<font color="red"> 817.             c.cases[pos] = case.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 818.         c.default = c.default.resolve_expression(query, allow_joins, reuse, summarize, for_save)</font>
<font color="red"> 819.         return c</font>
<font color="black"> 820. </font>
<font color="green"> 821.     def copy(self):</font>
<font color="red"> 822.         c = super(Case, self).copy()</font>
<font color="red"> 823.         c.cases = c.cases[:]</font>
<font color="red"> 824.         return c</font>
<font color="black"> 825. </font>
<font color="green"> 826.     def as_sql(self, compiler, connection, template=None, extra=None):</font>
<font color="red"> 827.         connection.ops.check_expression_support(self)</font>
<font color="red"> 828.         if not self.cases:</font>
<font color="red"> 829.             return compiler.compile(self.default)</font>
<font color="red"> 830.         template_params = dict(extra) if extra else {}</font>
<font color="red"> 831.         case_parts = []</font>
<font color="red"> 832.         sql_params = []</font>
<font color="red"> 833.         for case in self.cases:</font>
<font color="red"> 834.             case_sql, case_params = compiler.compile(case)</font>
<font color="red"> 835.             case_parts.append(case_sql)</font>
<font color="red"> 836.             sql_params.extend(case_params)</font>
<font color="red"> 837.         template_params['cases'] = self.case_joiner.join(case_parts)</font>
<font color="red"> 838.         default_sql, default_params = compiler.compile(self.default)</font>
<font color="red"> 839.         template_params['default'] = default_sql</font>
<font color="red"> 840.         sql_params.extend(default_params)</font>
<font color="red"> 841.         template = template or self.template</font>
<font color="red"> 842.         sql = template % template_params</font>
<font color="red"> 843.         if self._output_field_or_none is not None:</font>
<font color="red"> 844.             sql = connection.ops.unification_cast_sql(self.output_field) % sql</font>
<font color="red"> 845.         return sql, sql_params</font>
<font color="black"> 846. </font>
<font color="black"> 847. </font>
<font color="green"> 848. class Date(Expression):</font>
<font color="black"> 849.     &quot;&quot;&quot;</font>
<font color="black"> 850.     Add a date selection column.</font>
<font color="green"> 851.     &quot;&quot;&quot;</font>
<font color="green"> 852.     def __init__(self, lookup, lookup_type):</font>
<font color="red"> 853.         super(Date, self).__init__(output_field=fields.DateField())</font>
<font color="red"> 854.         self.lookup = lookup</font>
<font color="red"> 855.         self.col = None</font>
<font color="red"> 856.         self.lookup_type = lookup_type</font>
<font color="black"> 857. </font>
<font color="green"> 858.     def __repr__(self):</font>
<font color="red"> 859.         return &quot;{}({}, {})&quot;.format(self.__class__.__name__, self.lookup, self.lookup_type)</font>
<font color="black"> 860. </font>
<font color="green"> 861.     def get_source_expressions(self):</font>
<font color="red"> 862.         return [self.col]</font>
<font color="black"> 863. </font>
<font color="green"> 864.     def set_source_expressions(self, exprs):</font>
<font color="red"> 865.         self.col, = exprs</font>
<font color="black"> 866. </font>
<font color="green"> 867.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 868.         copy = self.copy()</font>
<font color="red"> 869.         copy.col = query.resolve_ref(self.lookup, allow_joins, reuse, summarize)</font>
<font color="red"> 870.         field = copy.col.output_field</font>
<font color="red"> 871.         assert isinstance(field, fields.DateField), &quot;%r isn't a DateField.&quot; % field.name</font>
<font color="red"> 872.         if settings.USE_TZ:</font>
<font color="red"> 873.             assert not isinstance(field, fields.DateTimeField), (</font>
<font color="red"> 874.                 &quot;%r is a DateTimeField, not a DateField.&quot; % field.name</font>
<font color="black"> 875.             )</font>
<font color="red"> 876.         return copy</font>
<font color="black"> 877. </font>
<font color="green"> 878.     def as_sql(self, compiler, connection):</font>
<font color="red"> 879.         sql, params = self.col.as_sql(compiler, connection)</font>
<font color="red"> 880.         assert not(params)</font>
<font color="red"> 881.         return connection.ops.date_trunc_sql(self.lookup_type, sql), []</font>
<font color="black"> 882. </font>
<font color="green"> 883.     def copy(self):</font>
<font color="red"> 884.         copy = super(Date, self).copy()</font>
<font color="red"> 885.         copy.lookup = self.lookup</font>
<font color="red"> 886.         copy.lookup_type = self.lookup_type</font>
<font color="red"> 887.         return copy</font>
<font color="black"> 888. </font>
<font color="green"> 889.     def convert_value(self, value, expression, connection, context):</font>
<font color="red"> 890.         if isinstance(value, datetime.datetime):</font>
<font color="red"> 891.             value = value.date()</font>
<font color="red"> 892.         return value</font>
<font color="black"> 893. </font>
<font color="black"> 894. </font>
<font color="green"> 895. class DateTime(Expression):</font>
<font color="black"> 896.     &quot;&quot;&quot;</font>
<font color="black"> 897.     Add a datetime selection column.</font>
<font color="green"> 898.     &quot;&quot;&quot;</font>
<font color="green"> 899.     def __init__(self, lookup, lookup_type, tzinfo):</font>
<font color="red"> 900.         super(DateTime, self).__init__(output_field=fields.DateTimeField())</font>
<font color="red"> 901.         self.lookup = lookup</font>
<font color="red"> 902.         self.col = None</font>
<font color="red"> 903.         self.lookup_type = lookup_type</font>
<font color="red"> 904.         if tzinfo is None:</font>
<font color="red"> 905.             self.tzname = None</font>
<font color="black"> 906.         else:</font>
<font color="red"> 907.             self.tzname = timezone._get_timezone_name(tzinfo)</font>
<font color="red"> 908.         self.tzinfo = tzinfo</font>
<font color="black"> 909. </font>
<font color="green"> 910.     def __repr__(self):</font>
<font color="red"> 911.         return &quot;{}({}, {}, {})&quot;.format(</font>
<font color="red"> 912.             self.__class__.__name__, self.lookup, self.lookup_type, self.tzinfo)</font>
<font color="black"> 913. </font>
<font color="green"> 914.     def get_source_expressions(self):</font>
<font color="red"> 915.         return [self.col]</font>
<font color="black"> 916. </font>
<font color="green"> 917.     def set_source_expressions(self, exprs):</font>
<font color="red"> 918.         self.col, = exprs</font>
<font color="black"> 919. </font>
<font color="green"> 920.     def resolve_expression(self, query=None, allow_joins=True, reuse=None, summarize=False, for_save=False):</font>
<font color="red"> 921.         copy = self.copy()</font>
<font color="red"> 922.         copy.col = query.resolve_ref(self.lookup, allow_joins, reuse, summarize)</font>
<font color="red"> 923.         field = copy.col.output_field</font>
<font color="red"> 924.         assert isinstance(field, fields.DateTimeField), (</font>
<font color="red"> 925.             &quot;%r isn't a DateTimeField.&quot; % field.name</font>
<font color="black"> 926.         )</font>
<font color="red"> 927.         return copy</font>
<font color="black"> 928. </font>
<font color="green"> 929.     def as_sql(self, compiler, connection):</font>
<font color="red"> 930.         sql, params = self.col.as_sql(compiler, connection)</font>
<font color="red"> 931.         assert not(params)</font>
<font color="red"> 932.         return connection.ops.datetime_trunc_sql(self.lookup_type, sql, self.tzname)</font>
<font color="black"> 933. </font>
<font color="green"> 934.     def copy(self):</font>
<font color="red"> 935.         copy = super(DateTime, self).copy()</font>
<font color="red"> 936.         copy.lookup = self.lookup</font>
<font color="red"> 937.         copy.lookup_type = self.lookup_type</font>
<font color="red"> 938.         copy.tzname = self.tzname</font>
<font color="red"> 939.         return copy</font>
<font color="black"> 940. </font>
<font color="green"> 941.     def convert_value(self, value, expression, connection, context):</font>
<font color="red"> 942.         if settings.USE_TZ:</font>
<font color="red"> 943.             if value is None:</font>
<font color="red"> 944.                 raise ValueError(</font>
<font color="red"> 945.                     &quot;Database returned an invalid value in QuerySet.datetimes(). &quot;</font>
<font color="black"> 946.                     &quot;Are time zone definitions for your database and pytz installed?&quot;</font>
<font color="black"> 947.                 )</font>
<font color="red"> 948.             value = value.replace(tzinfo=None)</font>
<font color="red"> 949.             value = timezone.make_aware(value, self.tzinfo)</font>
<font color="red"> 950.         return value</font>
<font color="black"> 951. </font>
<font color="black"> 952. </font>
<font color="green"> 953. class OrderBy(BaseExpression):</font>
<font color="green"> 954.     template = '%(expression)s %(ordering)s'</font>
<font color="black"> 955. </font>
<font color="green"> 956.     def __init__(self, expression, descending=False):</font>
<font color="green"> 957.         self.descending = descending</font>
<font color="green"> 958.         if not hasattr(expression, 'resolve_expression'):</font>
<font color="red"> 959.             raise ValueError('expression must be an expression type')</font>
<font color="green"> 960.         self.expression = expression</font>
<font color="black"> 961. </font>
<font color="green"> 962.     def __repr__(self):</font>
<font color="red"> 963.         return &quot;{}({}, descending={})&quot;.format(</font>
<font color="red"> 964.             self.__class__.__name__, self.expression, self.descending)</font>
<font color="black"> 965. </font>
<font color="green"> 966.     def set_source_expressions(self, exprs):</font>
<font color="green"> 967.         self.expression = exprs[0]</font>
<font color="black"> 968. </font>
<font color="green"> 969.     def get_source_expressions(self):</font>
<font color="green"> 970.         return [self.expression]</font>
<font color="black"> 971. </font>
<font color="green"> 972.     def as_sql(self, compiler, connection):</font>
<font color="green"> 973.         connection.ops.check_expression_support(self)</font>
<font color="green"> 974.         expression_sql, params = compiler.compile(self.expression)</font>
<font color="green"> 975.         placeholders = {'expression': expression_sql}</font>
<font color="green"> 976.         placeholders['ordering'] = 'DESC' if self.descending else 'ASC'</font>
<font color="green"> 977.         return (self.template % placeholders).rstrip(), params</font>
<font color="black"> 978. </font>
<font color="green"> 979.     def get_group_by_cols(self):</font>
<font color="red"> 980.         cols = []</font>
<font color="red"> 981.         for source in self.get_source_expressions():</font>
<font color="red"> 982.             cols.extend(source.get_group_by_cols())</font>
<font color="red"> 983.         return cols</font>
<font color="black"> 984. </font>
<font color="green"> 985.     def reverse_ordering(self):</font>
<font color="red"> 986.         self.descending = not self.descending</font>
<font color="red"> 987.         return self</font>
<font color="black"> 988. </font>
<font color="green"> 989.     def asc(self):</font>
<font color="red"> 990.         self.descending = False</font>
<font color="black"> 991. </font>
<font color="green"> 992.     def desc(self):</font>
<font color="red"> 993.         self.descending = True</font>
</pre>


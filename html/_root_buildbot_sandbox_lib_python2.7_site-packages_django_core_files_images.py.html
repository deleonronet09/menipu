source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/files/images.py</b><br>


file stats: <b>48 lines, 12 executed: 25.0% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Utility functions for handling images.</font>
<font color="black">   3. </font>
<font color="black">   4. Requires Pillow as you might imagine.</font>
<font color="green">   5. &quot;&quot;&quot;</font>
<font color="green">   6. import struct</font>
<font color="green">   7. import zlib</font>
<font color="black">   8. </font>
<font color="green">   9. from django.core.files import File</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. class ImageFile(File):</font>
<font color="black">  13.     &quot;&quot;&quot;</font>
<font color="black">  14.     A mixin for use alongside django.core.files.base.File, which provides</font>
<font color="black">  15.     additional features for dealing with images.</font>
<font color="green">  16.     &quot;&quot;&quot;</font>
<font color="green">  17.     def _get_width(self):</font>
<font color="red">  18.         return self._get_image_dimensions()[0]</font>
<font color="green">  19.     width = property(_get_width)</font>
<font color="black">  20. </font>
<font color="green">  21.     def _get_height(self):</font>
<font color="red">  22.         return self._get_image_dimensions()[1]</font>
<font color="green">  23.     height = property(_get_height)</font>
<font color="black">  24. </font>
<font color="green">  25.     def _get_image_dimensions(self):</font>
<font color="red">  26.         if not hasattr(self, '_dimensions_cache'):</font>
<font color="red">  27.             close = self.closed</font>
<font color="red">  28.             self.open()</font>
<font color="red">  29.             self._dimensions_cache = get_image_dimensions(self, close=close)</font>
<font color="red">  30.         return self._dimensions_cache</font>
<font color="black">  31. </font>
<font color="black">  32. </font>
<font color="green">  33. def get_image_dimensions(file_or_path, close=False):</font>
<font color="black">  34.     &quot;&quot;&quot;</font>
<font color="black">  35.     Returns the (width, height) of an image, given an open file or a path.  Set</font>
<font color="black">  36.     'close' to True to close the file at the end if it is initially in an open</font>
<font color="black">  37.     state.</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="red">  39.     from PIL import ImageFile as PillowImageFile</font>
<font color="black">  40. </font>
<font color="red">  41.     p = PillowImageFile.Parser()</font>
<font color="red">  42.     if hasattr(file_or_path, 'read'):</font>
<font color="red">  43.         file = file_or_path</font>
<font color="red">  44.         file_pos = file.tell()</font>
<font color="red">  45.         file.seek(0)</font>
<font color="black">  46.     else:</font>
<font color="red">  47.         file = open(file_or_path, 'rb')</font>
<font color="red">  48.         close = True</font>
<font color="red">  49.     try:</font>
<font color="black">  50.         # Most of the time Pillow only needs a small chunk to parse the image</font>
<font color="black">  51.         # and get the dimensions, but with some TIFF files Pillow needs to</font>
<font color="black">  52.         # parse the whole file.</font>
<font color="red">  53.         chunk_size = 1024</font>
<font color="red">  54.         while 1:</font>
<font color="red">  55.             data = file.read(chunk_size)</font>
<font color="red">  56.             if not data:</font>
<font color="red">  57.                 break</font>
<font color="red">  58.             try:</font>
<font color="red">  59.                 p.feed(data)</font>
<font color="red">  60.             except zlib.error as e:</font>
<font color="black">  61.                 # ignore zlib complaining on truncated stream, just feed more</font>
<font color="black">  62.                 # data to parser (ticket #19457).</font>
<font color="red">  63.                 if e.args[0].startswith(&quot;Error -5&quot;):</font>
<font color="red">  64.                     pass</font>
<font color="black">  65.                 else:</font>
<font color="red">  66.                     raise</font>
<font color="red">  67.             except struct.error:</font>
<font color="black">  68.                 # Ignore PIL failing on a too short buffer when reads return</font>
<font color="black">  69.                 # less bytes than expected. Skip and feed more data to the</font>
<font color="black">  70.                 # parser (ticket #24544).</font>
<font color="red">  71.                 pass</font>
<font color="red">  72.             if p.image:</font>
<font color="red">  73.                 return p.image.size</font>
<font color="red">  74.             chunk_size *= 2</font>
<font color="red">  75.         return (None, None)</font>
<font color="black">  76.     finally:</font>
<font color="red">  77.         if close:</font>
<font color="red">  78.             file.close()</font>
<font color="black">  79.         else:</font>
<font color="red">  80.             file.seek(file_pos)</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/operations/fields.py</b><br>


file stats: <b>199 lines, 85 executed: 42.7% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.db.models.fields import NOT_PROVIDED</font>
<font color="green">   4. from django.utils import six</font>
<font color="green">   5. from django.utils.functional import cached_property</font>
<font color="black">   6. </font>
<font color="green">   7. from .base import Operation</font>
<font color="black">   8. </font>
<font color="black">   9. </font>
<font color="green">  10. class AddField(Operation):</font>
<font color="black">  11.     &quot;&quot;&quot;</font>
<font color="black">  12.     Adds a field to a model.</font>
<font color="green">  13.     &quot;&quot;&quot;</font>
<font color="black">  14. </font>
<font color="green">  15.     def __init__(self, model_name, name, field, preserve_default=True):</font>
<font color="red">  16.         self.model_name = model_name</font>
<font color="red">  17.         self.name = name</font>
<font color="red">  18.         self.field = field</font>
<font color="red">  19.         self.preserve_default = preserve_default</font>
<font color="black">  20. </font>
<font color="green">  21.     @cached_property</font>
<font color="black">  22.     def name_lower(self):</font>
<font color="red">  23.         return self.name.lower()</font>
<font color="black">  24. </font>
<font color="green">  25.     @cached_property</font>
<font color="black">  26.     def model_name_lower(self):</font>
<font color="red">  27.         return self.model_name.lower()</font>
<font color="black">  28. </font>
<font color="green">  29.     def deconstruct(self):</font>
<font color="red">  30.         kwargs = {</font>
<font color="red">  31.             'model_name': self.model_name,</font>
<font color="red">  32.             'name': self.name,</font>
<font color="red">  33.             'field': self.field,</font>
<font color="black">  34.         }</font>
<font color="red">  35.         if self.preserve_default is not True:</font>
<font color="red">  36.             kwargs['preserve_default'] = self.preserve_default</font>
<font color="black">  37.         return (</font>
<font color="red">  38.             self.__class__.__name__,</font>
<font color="red">  39.             [],</font>
<font color="red">  40.             kwargs</font>
<font color="black">  41.         )</font>
<font color="black">  42. </font>
<font color="green">  43.     def state_forwards(self, app_label, state):</font>
<font color="black">  44.         # If preserve default is off, don't use the default for future state</font>
<font color="red">  45.         if not self.preserve_default:</font>
<font color="red">  46.             field = self.field.clone()</font>
<font color="red">  47.             field.default = NOT_PROVIDED</font>
<font color="black">  48.         else:</font>
<font color="red">  49.             field = self.field</font>
<font color="red">  50.         state.models[app_label, self.model_name_lower].fields.append((self.name, field))</font>
<font color="red">  51.         state.reload_model(app_label, self.model_name_lower)</font>
<font color="black">  52. </font>
<font color="green">  53.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red">  54.         to_model = to_state.apps.get_model(app_label, self.model_name)</font>
<font color="red">  55.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="red">  56.             from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="red">  57.             field = to_model._meta.get_field(self.name)</font>
<font color="red">  58.             if not self.preserve_default:</font>
<font color="red">  59.                 field.default = self.field.default</font>
<font color="red">  60.             schema_editor.add_field(</font>
<font color="red">  61.                 from_model,</font>
<font color="red">  62.                 field,</font>
<font color="black">  63.             )</font>
<font color="red">  64.             if not self.preserve_default:</font>
<font color="red">  65.                 field.default = NOT_PROVIDED</font>
<font color="black">  66. </font>
<font color="green">  67.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red">  68.         from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="red">  69.         if self.allow_migrate_model(schema_editor.connection.alias, from_model):</font>
<font color="red">  70.             schema_editor.remove_field(from_model, from_model._meta.get_field(self.name))</font>
<font color="black">  71. </font>
<font color="green">  72.     def describe(self):</font>
<font color="red">  73.         return &quot;Add field %s to %s&quot; % (self.name, self.model_name)</font>
<font color="black">  74. </font>
<font color="green">  75.     def references_model(self, name, app_label=None):</font>
<font color="red">  76.         return name.lower() == self.model_name_lower</font>
<font color="black">  77. </font>
<font color="green">  78.     def references_field(self, model_name, name, app_label=None):</font>
<font color="red">  79.         return self.references_model(model_name) and name.lower() == self.name_lower</font>
<font color="black">  80. </font>
<font color="black">  81. </font>
<font color="green">  82. class RemoveField(Operation):</font>
<font color="black">  83.     &quot;&quot;&quot;</font>
<font color="black">  84.     Removes a field from a model.</font>
<font color="green">  85.     &quot;&quot;&quot;</font>
<font color="black">  86. </font>
<font color="green">  87.     def __init__(self, model_name, name):</font>
<font color="green">  88.         self.model_name = model_name</font>
<font color="green">  89.         self.name = name</font>
<font color="black">  90. </font>
<font color="green">  91.     @cached_property</font>
<font color="black">  92.     def name_lower(self):</font>
<font color="red">  93.         return self.name.lower()</font>
<font color="black">  94. </font>
<font color="green">  95.     @cached_property</font>
<font color="black">  96.     def model_name_lower(self):</font>
<font color="green">  97.         return self.model_name.lower()</font>
<font color="black">  98. </font>
<font color="green">  99.     def deconstruct(self):</font>
<font color="red"> 100.         kwargs = {</font>
<font color="red"> 101.             'model_name': self.model_name,</font>
<font color="red"> 102.             'name': self.name,</font>
<font color="black"> 103.         }</font>
<font color="black"> 104.         return (</font>
<font color="red"> 105.             self.__class__.__name__,</font>
<font color="red"> 106.             [],</font>
<font color="red"> 107.             kwargs</font>
<font color="black"> 108.         )</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def state_forwards(self, app_label, state):</font>
<font color="green"> 111.         new_fields = []</font>
<font color="green"> 112.         for name, instance in state.models[app_label, self.model_name_lower].fields:</font>
<font color="green"> 113.             if name != self.name:</font>
<font color="green"> 114.                 new_fields.append((name, instance))</font>
<font color="green"> 115.         state.models[app_label, self.model_name_lower].fields = new_fields</font>
<font color="green"> 116.         state.reload_model(app_label, self.model_name_lower)</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green"> 119.         from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="green"> 120.         if self.allow_migrate_model(schema_editor.connection.alias, from_model):</font>
<font color="green"> 121.             schema_editor.remove_field(from_model, from_model._meta.get_field(self.name))</font>
<font color="black"> 122. </font>
<font color="green"> 123.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 124.         to_model = to_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 125.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="red"> 126.             from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 127.             schema_editor.add_field(from_model, to_model._meta.get_field(self.name))</font>
<font color="black"> 128. </font>
<font color="green"> 129.     def describe(self):</font>
<font color="red"> 130.         return &quot;Remove field %s from %s&quot; % (self.name, self.model_name)</font>
<font color="black"> 131. </font>
<font color="green"> 132.     def references_model(self, name, app_label=None):</font>
<font color="red"> 133.         return name.lower() == self.model_name_lower</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def references_field(self, model_name, name, app_label=None):</font>
<font color="red"> 136.         return self.references_model(model_name) and name.lower() == self.name_lower</font>
<font color="black"> 137. </font>
<font color="black"> 138. </font>
<font color="green"> 139. class AlterField(Operation):</font>
<font color="black"> 140.     &quot;&quot;&quot;</font>
<font color="black"> 141.     Alters a field's database column (e.g. null, max_length) to the provided new field</font>
<font color="green"> 142.     &quot;&quot;&quot;</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def __init__(self, model_name, name, field, preserve_default=True):</font>
<font color="green"> 145.         self.model_name = model_name</font>
<font color="green"> 146.         self.name = name</font>
<font color="green"> 147.         self.field = field</font>
<font color="green"> 148.         self.preserve_default = preserve_default</font>
<font color="black"> 149. </font>
<font color="green"> 150.     @cached_property</font>
<font color="black"> 151.     def name_lower(self):</font>
<font color="red"> 152.         return self.name.lower()</font>
<font color="black"> 153. </font>
<font color="green"> 154.     @cached_property</font>
<font color="black"> 155.     def model_name_lower(self):</font>
<font color="green"> 156.         return self.model_name.lower()</font>
<font color="black"> 157. </font>
<font color="green"> 158.     def deconstruct(self):</font>
<font color="red"> 159.         kwargs = {</font>
<font color="red"> 160.             'model_name': self.model_name,</font>
<font color="red"> 161.             'name': self.name,</font>
<font color="red"> 162.             'field': self.field,</font>
<font color="black"> 163.         }</font>
<font color="red"> 164.         if self.preserve_default is not True:</font>
<font color="red"> 165.             kwargs['preserve_default'] = self.preserve_default</font>
<font color="black"> 166.         return (</font>
<font color="red"> 167.             self.__class__.__name__,</font>
<font color="red"> 168.             [],</font>
<font color="red"> 169.             kwargs</font>
<font color="black"> 170.         )</font>
<font color="black"> 171. </font>
<font color="green"> 172.     def state_forwards(self, app_label, state):</font>
<font color="green"> 173.         if not self.preserve_default:</font>
<font color="red"> 174.             field = self.field.clone()</font>
<font color="red"> 175.             field.default = NOT_PROVIDED</font>
<font color="black"> 176.         else:</font>
<font color="green"> 177.             field = self.field</font>
<font color="black"> 178.         state.models[app_label, self.model_name_lower].fields = [</font>
<font color="green"> 179.             (n, field if n == self.name else f)</font>
<font color="black"> 180.             for n, f in</font>
<font color="green"> 181.             state.models[app_label, self.model_name_lower].fields</font>
<font color="black"> 182.         ]</font>
<font color="green"> 183.         state.reload_model(app_label, self.model_name_lower)</font>
<font color="black"> 184. </font>
<font color="green"> 185.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="green"> 186.         to_model = to_state.apps.get_model(app_label, self.model_name)</font>
<font color="green"> 187.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="green"> 188.             from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="green"> 189.             from_field = from_model._meta.get_field(self.name)</font>
<font color="green"> 190.             to_field = to_model._meta.get_field(self.name)</font>
<font color="black"> 191.             # If the field is a relatedfield with an unresolved rel.to, just</font>
<font color="black"> 192.             # set it equal to the other field side. Bandaid fix for AlterField</font>
<font color="black"> 193.             # migrations that are part of a RenameModel change.</font>
<font color="green"> 194.             if from_field.remote_field and from_field.remote_field.model:</font>
<font color="red"> 195.                 if isinstance(from_field.remote_field.model, six.string_types):</font>
<font color="red"> 196.                     from_field.remote_field.model = to_field.remote_field.model</font>
<font color="red"> 197.                 elif to_field.remote_field and isinstance(to_field.remote_field.model, six.string_types):</font>
<font color="red"> 198.                     to_field.remote_field.model = from_field.remote_field.model</font>
<font color="green"> 199.             if not self.preserve_default:</font>
<font color="red"> 200.                 to_field.default = self.field.default</font>
<font color="green"> 201.             schema_editor.alter_field(from_model, from_field, to_field)</font>
<font color="green"> 202.             if not self.preserve_default:</font>
<font color="red"> 203.                 to_field.default = NOT_PROVIDED</font>
<font color="black"> 204. </font>
<font color="green"> 205.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 206.         self.database_forwards(app_label, schema_editor, from_state, to_state)</font>
<font color="black"> 207. </font>
<font color="green"> 208.     def describe(self):</font>
<font color="red"> 209.         return &quot;Alter field %s on %s&quot; % (self.name, self.model_name)</font>
<font color="black"> 210. </font>
<font color="green"> 211.     def references_model(self, name, app_label=None):</font>
<font color="red"> 212.         return name.lower() == self.model_name_lower</font>
<font color="black"> 213. </font>
<font color="green"> 214.     def references_field(self, model_name, name, app_label=None):</font>
<font color="red"> 215.         return self.references_model(model_name) and name.lower() == self.name_lower</font>
<font color="black"> 216. </font>
<font color="black"> 217. </font>
<font color="green"> 218. class RenameField(Operation):</font>
<font color="black"> 219.     &quot;&quot;&quot;</font>
<font color="black"> 220.     Renames a field on the model. Might affect db_column too.</font>
<font color="green"> 221.     &quot;&quot;&quot;</font>
<font color="black"> 222. </font>
<font color="green"> 223.     def __init__(self, model_name, old_name, new_name):</font>
<font color="red"> 224.         self.model_name = model_name</font>
<font color="red"> 225.         self.old_name = old_name</font>
<font color="red"> 226.         self.new_name = new_name</font>
<font color="black"> 227. </font>
<font color="green"> 228.     @cached_property</font>
<font color="black"> 229.     def old_name_lower(self):</font>
<font color="red"> 230.         return self.old_name.lower()</font>
<font color="black"> 231. </font>
<font color="green"> 232.     @cached_property</font>
<font color="black"> 233.     def new_name_lower(self):</font>
<font color="red"> 234.         return self.new_name.lower()</font>
<font color="black"> 235. </font>
<font color="green"> 236.     @cached_property</font>
<font color="black"> 237.     def model_name_lower(self):</font>
<font color="red"> 238.         return self.model_name.lower()</font>
<font color="black"> 239. </font>
<font color="green"> 240.     def deconstruct(self):</font>
<font color="red"> 241.         kwargs = {</font>
<font color="red"> 242.             'model_name': self.model_name,</font>
<font color="red"> 243.             'old_name': self.old_name,</font>
<font color="red"> 244.             'new_name': self.new_name,</font>
<font color="black"> 245.         }</font>
<font color="black"> 246.         return (</font>
<font color="red"> 247.             self.__class__.__name__,</font>
<font color="red"> 248.             [],</font>
<font color="red"> 249.             kwargs</font>
<font color="black"> 250.         )</font>
<font color="black"> 251. </font>
<font color="green"> 252.     def state_forwards(self, app_label, state):</font>
<font color="black"> 253.         # Rename the field</font>
<font color="black"> 254.         state.models[app_label, self.model_name_lower].fields = [</font>
<font color="red"> 255.             (self.new_name if n == self.old_name else n, f)</font>
<font color="red"> 256.             for n, f in state.models[app_label, self.model_name_lower].fields</font>
<font color="black"> 257.         ]</font>
<font color="black"> 258.         # Fix index/unique_together to refer to the new field</font>
<font color="red"> 259.         options = state.models[app_label, self.model_name_lower].options</font>
<font color="red"> 260.         for option in ('index_together', 'unique_together'):</font>
<font color="red"> 261.             if option in options:</font>
<font color="black"> 262.                 options[option] = [</font>
<font color="red"> 263.                     [self.new_name if n == self.old_name else n for n in together]</font>
<font color="red"> 264.                     for together in options[option]</font>
<font color="black"> 265.                 ]</font>
<font color="red"> 266.         state.reload_model(app_label, self.model_name_lower)</font>
<font color="black"> 267. </font>
<font color="green"> 268.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 269.         to_model = to_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 270.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="red"> 271.             from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 272.             schema_editor.alter_field(</font>
<font color="red"> 273.                 from_model,</font>
<font color="red"> 274.                 from_model._meta.get_field(self.old_name),</font>
<font color="red"> 275.                 to_model._meta.get_field(self.new_name),</font>
<font color="black"> 276.             )</font>
<font color="black"> 277. </font>
<font color="green"> 278.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="red"> 279.         to_model = to_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 280.         if self.allow_migrate_model(schema_editor.connection.alias, to_model):</font>
<font color="red"> 281.             from_model = from_state.apps.get_model(app_label, self.model_name)</font>
<font color="red"> 282.             schema_editor.alter_field(</font>
<font color="red"> 283.                 from_model,</font>
<font color="red"> 284.                 from_model._meta.get_field(self.new_name),</font>
<font color="red"> 285.                 to_model._meta.get_field(self.old_name),</font>
<font color="black"> 286.             )</font>
<font color="black"> 287. </font>
<font color="green"> 288.     def describe(self):</font>
<font color="red"> 289.         return &quot;Rename field %s on %s to %s&quot; % (self.old_name, self.model_name, self.new_name)</font>
<font color="black"> 290. </font>
<font color="green"> 291.     def references_model(self, name, app_label=None):</font>
<font color="red"> 292.         return name.lower() == self.model_name_lower</font>
<font color="black"> 293. </font>
<font color="green"> 294.     def references_field(self, model_name, name, app_label=None):</font>
<font color="red"> 295.         return self.references_model(model_name) and (</font>
<font color="red"> 296.             name.lower() == self.old_name_lower or</font>
<font color="red"> 297.             name.lower() == self.new_name_lower</font>
<font color="black"> 298.         )</font>
</pre>


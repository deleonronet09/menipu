source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/admin/filters.py</b><br>


file stats: <b>286 lines, 68 executed: 23.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. This encapsulates the logic for displaying filters in the Django admin.</font>
<font color="black">   3. Filters are specified in models with the &quot;list_filter&quot; option.</font>
<font color="black">   4. </font>
<font color="black">   5. Each filter subclass knows how to display a filter for a field that passes a</font>
<font color="black">   6. certain test -- e.g. being a DateField or ForeignKey.</font>
<font color="green">   7. &quot;&quot;&quot;</font>
<font color="green">   8. import datetime</font>
<font color="black">   9. </font>
<font color="green">  10. from django.contrib.admin.options import IncorrectLookupParameters</font>
<font color="green">  11. from django.contrib.admin.utils import (</font>
<font color="black">  12.     get_model_from_relation, prepare_lookup_value, reverse_field_path,</font>
<font color="black">  13. )</font>
<font color="green">  14. from django.core.exceptions import ImproperlyConfigured, ValidationError</font>
<font color="green">  15. from django.db import models</font>
<font color="green">  16. from django.utils import timezone</font>
<font color="green">  17. from django.utils.encoding import force_text, smart_text</font>
<font color="green">  18. from django.utils.translation import ugettext_lazy as _</font>
<font color="black">  19. </font>
<font color="black">  20. </font>
<font color="green">  21. class ListFilter(object):</font>
<font color="green">  22.     title = None  # Human-readable title to appear in the right sidebar.</font>
<font color="green">  23.     template = 'admin/filter.html'</font>
<font color="black">  24. </font>
<font color="green">  25.     def __init__(self, request, params, model, model_admin):</font>
<font color="black">  26.         # This dictionary will eventually contain the request's query string</font>
<font color="black">  27.         # parameters actually used by this filter.</font>
<font color="red">  28.         self.used_parameters = {}</font>
<font color="red">  29.         if self.title is None:</font>
<font color="red">  30.             raise ImproperlyConfigured(</font>
<font color="red">  31.                 &quot;The list filter '%s' does not specify &quot;</font>
<font color="red">  32.                 &quot;a 'title'.&quot; % self.__class__.__name__)</font>
<font color="black">  33. </font>
<font color="green">  34.     def has_output(self):</font>
<font color="black">  35.         &quot;&quot;&quot;</font>
<font color="black">  36.         Returns True if some choices would be output for this filter.</font>
<font color="black">  37.         &quot;&quot;&quot;</font>
<font color="red">  38.         raise NotImplementedError('subclasses of ListFilter must provide a has_output() method')</font>
<font color="black">  39. </font>
<font color="green">  40.     def choices(self, cl):</font>
<font color="black">  41.         &quot;&quot;&quot;</font>
<font color="black">  42.         Returns choices ready to be output in the template.</font>
<font color="black">  43.         &quot;&quot;&quot;</font>
<font color="red">  44.         raise NotImplementedError('subclasses of ListFilter must provide a choices() method')</font>
<font color="black">  45. </font>
<font color="green">  46.     def queryset(self, request, queryset):</font>
<font color="black">  47.         &quot;&quot;&quot;</font>
<font color="black">  48.         Returns the filtered queryset.</font>
<font color="black">  49.         &quot;&quot;&quot;</font>
<font color="red">  50.         raise NotImplementedError('subclasses of ListFilter must provide a queryset() method')</font>
<font color="black">  51. </font>
<font color="green">  52.     def expected_parameters(self):</font>
<font color="black">  53.         &quot;&quot;&quot;</font>
<font color="black">  54.         Returns the list of parameter names that are expected from the</font>
<font color="black">  55.         request's query string and that will be used by this filter.</font>
<font color="black">  56.         &quot;&quot;&quot;</font>
<font color="red">  57.         raise NotImplementedError('subclasses of ListFilter must provide an expected_parameters() method')</font>
<font color="black">  58. </font>
<font color="black">  59. </font>
<font color="green">  60. class SimpleListFilter(ListFilter):</font>
<font color="black">  61.     # The parameter that should be used in the query string for that filter.</font>
<font color="green">  62.     parameter_name = None</font>
<font color="black">  63. </font>
<font color="green">  64.     def __init__(self, request, params, model, model_admin):</font>
<font color="red">  65.         super(SimpleListFilter, self).__init__(</font>
<font color="red">  66.             request, params, model, model_admin)</font>
<font color="red">  67.         if self.parameter_name is None:</font>
<font color="red">  68.             raise ImproperlyConfigured(</font>
<font color="red">  69.                 &quot;The list filter '%s' does not specify &quot;</font>
<font color="red">  70.                 &quot;a 'parameter_name'.&quot; % self.__class__.__name__)</font>
<font color="red">  71.         if self.parameter_name in params:</font>
<font color="red">  72.             value = params.pop(self.parameter_name)</font>
<font color="red">  73.             self.used_parameters[self.parameter_name] = value</font>
<font color="red">  74.         lookup_choices = self.lookups(request, model_admin)</font>
<font color="red">  75.         if lookup_choices is None:</font>
<font color="red">  76.             lookup_choices = ()</font>
<font color="red">  77.         self.lookup_choices = list(lookup_choices)</font>
<font color="black">  78. </font>
<font color="green">  79.     def has_output(self):</font>
<font color="red">  80.         return len(self.lookup_choices) &gt; 0</font>
<font color="black">  81. </font>
<font color="green">  82.     def value(self):</font>
<font color="black">  83.         &quot;&quot;&quot;</font>
<font color="black">  84.         Returns the value (in string format) provided in the request's</font>
<font color="black">  85.         query string for this filter, if any. If the value wasn't provided then</font>
<font color="black">  86.         returns None.</font>
<font color="black">  87.         &quot;&quot;&quot;</font>
<font color="red">  88.         return self.used_parameters.get(self.parameter_name)</font>
<font color="black">  89. </font>
<font color="green">  90.     def lookups(self, request, model_admin):</font>
<font color="black">  91.         &quot;&quot;&quot;</font>
<font color="black">  92.         Must be overridden to return a list of tuples (value, verbose value)</font>
<font color="black">  93.         &quot;&quot;&quot;</font>
<font color="red">  94.         raise NotImplementedError(</font>
<font color="red">  95.             'The SimpleListFilter.lookups() method must be overridden to '</font>
<font color="black">  96.             'return a list of tuples (value, verbose value)')</font>
<font color="black">  97. </font>
<font color="green">  98.     def expected_parameters(self):</font>
<font color="red">  99.         return [self.parameter_name]</font>
<font color="black"> 100. </font>
<font color="green"> 101.     def choices(self, cl):</font>
<font color="red"> 102.         yield {</font>
<font color="red"> 103.             'selected': self.value() is None,</font>
<font color="red"> 104.             'query_string': cl.get_query_string({}, [self.parameter_name]),</font>
<font color="red"> 105.             'display': _('All'),</font>
<font color="black"> 106.         }</font>
<font color="red"> 107.         for lookup, title in self.lookup_choices:</font>
<font color="red"> 108.             yield {</font>
<font color="red"> 109.                 'selected': self.value() == force_text(lookup),</font>
<font color="red"> 110.                 'query_string': cl.get_query_string({</font>
<font color="red"> 111.                     self.parameter_name: lookup,</font>
<font color="red"> 112.                 }, []),</font>
<font color="red"> 113.                 'display': title,</font>
<font color="black"> 114.             }</font>
<font color="black"> 115. </font>
<font color="black"> 116. </font>
<font color="green"> 117. class FieldListFilter(ListFilter):</font>
<font color="green"> 118.     _field_list_filters = []</font>
<font color="green"> 119.     _take_priority_index = 0</font>
<font color="black"> 120. </font>
<font color="green"> 121.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 122.         self.field = field</font>
<font color="red"> 123.         self.field_path = field_path</font>
<font color="red"> 124.         self.title = getattr(field, 'verbose_name', field_path)</font>
<font color="red"> 125.         super(FieldListFilter, self).__init__(</font>
<font color="red"> 126.             request, params, model, model_admin)</font>
<font color="red"> 127.         for p in self.expected_parameters():</font>
<font color="red"> 128.             if p in params:</font>
<font color="red"> 129.                 value = params.pop(p)</font>
<font color="red"> 130.                 self.used_parameters[p] = prepare_lookup_value(p, value)</font>
<font color="black"> 131. </font>
<font color="green"> 132.     def has_output(self):</font>
<font color="red"> 133.         return True</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def queryset(self, request, queryset):</font>
<font color="red"> 136.         try:</font>
<font color="red"> 137.             return queryset.filter(**self.used_parameters)</font>
<font color="red"> 138.         except ValidationError as e:</font>
<font color="red"> 139.             raise IncorrectLookupParameters(e)</font>
<font color="black"> 140. </font>
<font color="green"> 141.     @classmethod</font>
<font color="green"> 142.     def register(cls, test, list_filter_class, take_priority=False):</font>
<font color="green"> 143.         if take_priority:</font>
<font color="black"> 144.             # This is to allow overriding the default filters for certain types</font>
<font color="black"> 145.             # of fields with some custom filters. The first found in the list</font>
<font color="black"> 146.             # is used in priority.</font>
<font color="red"> 147.             cls._field_list_filters.insert(</font>
<font color="red"> 148.                 cls._take_priority_index, (test, list_filter_class))</font>
<font color="red"> 149.             cls._take_priority_index += 1</font>
<font color="black"> 150.         else:</font>
<font color="green"> 151.             cls._field_list_filters.append((test, list_filter_class))</font>
<font color="black"> 152. </font>
<font color="green"> 153.     @classmethod</font>
<font color="black"> 154.     def create(cls, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 155.         for test, list_filter_class in cls._field_list_filters:</font>
<font color="red"> 156.             if not test(field):</font>
<font color="red"> 157.                 continue</font>
<font color="red"> 158.             return list_filter_class(field, request, params,</font>
<font color="red"> 159.                 model, model_admin, field_path=field_path)</font>
<font color="black"> 160. </font>
<font color="black"> 161. </font>
<font color="green"> 162. class RelatedFieldListFilter(FieldListFilter):</font>
<font color="green"> 163.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 164.         other_model = get_model_from_relation(field)</font>
<font color="red"> 165.         self.lookup_kwarg = '%s__%s__exact' % (field_path, field.target_field.name)</font>
<font color="red"> 166.         self.lookup_kwarg_isnull = '%s__isnull' % field_path</font>
<font color="red"> 167.         self.lookup_val = request.GET.get(self.lookup_kwarg)</font>
<font color="red"> 168.         self.lookup_val_isnull = request.GET.get(self.lookup_kwarg_isnull)</font>
<font color="red"> 169.         self.lookup_choices = self.field_choices(field, request, model_admin)</font>
<font color="red"> 170.         super(RelatedFieldListFilter, self).__init__(</font>
<font color="red"> 171.             field, request, params, model, model_admin, field_path)</font>
<font color="red"> 172.         if hasattr(field, 'verbose_name'):</font>
<font color="red"> 173.             self.lookup_title = field.verbose_name</font>
<font color="black"> 174.         else:</font>
<font color="red"> 175.             self.lookup_title = other_model._meta.verbose_name</font>
<font color="red"> 176.         self.title = self.lookup_title</font>
<font color="red"> 177.         self.empty_value_display = model_admin.get_empty_value_display()</font>
<font color="black"> 178. </font>
<font color="green"> 179.     @property</font>
<font color="black"> 180.     def include_empty_choice(self):</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="black"> 182.         Return True if a &quot;(None)&quot; choice should be included, which filters</font>
<font color="black"> 183.         out everything except empty relationships.</font>
<font color="black"> 184.         &quot;&quot;&quot;</font>
<font color="red"> 185.         return self.field.null or (self.field.is_relation and self.field.many_to_many)</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def has_output(self):</font>
<font color="red"> 188.         if self.include_empty_choice:</font>
<font color="red"> 189.             extra = 1</font>
<font color="black"> 190.         else:</font>
<font color="red"> 191.             extra = 0</font>
<font color="red"> 192.         return len(self.lookup_choices) + extra &gt; 1</font>
<font color="black"> 193. </font>
<font color="green"> 194.     def expected_parameters(self):</font>
<font color="red"> 195.         return [self.lookup_kwarg, self.lookup_kwarg_isnull]</font>
<font color="black"> 196. </font>
<font color="green"> 197.     def field_choices(self, field, request, model_admin):</font>
<font color="red"> 198.         return field.get_choices(include_blank=False)</font>
<font color="black"> 199. </font>
<font color="green"> 200.     def choices(self, cl):</font>
<font color="red"> 201.         yield {</font>
<font color="red"> 202.             'selected': self.lookup_val is None and not self.lookup_val_isnull,</font>
<font color="red"> 203.             'query_string': cl.get_query_string({},</font>
<font color="red"> 204.                 [self.lookup_kwarg, self.lookup_kwarg_isnull]),</font>
<font color="red"> 205.             'display': _('All'),</font>
<font color="black"> 206.         }</font>
<font color="red"> 207.         for pk_val, val in self.lookup_choices:</font>
<font color="red"> 208.             yield {</font>
<font color="red"> 209.                 'selected': self.lookup_val == smart_text(pk_val),</font>
<font color="red"> 210.                 'query_string': cl.get_query_string({</font>
<font color="red"> 211.                     self.lookup_kwarg: pk_val,</font>
<font color="red"> 212.                 }, [self.lookup_kwarg_isnull]),</font>
<font color="red"> 213.                 'display': val,</font>
<font color="black"> 214.             }</font>
<font color="red"> 215.         if self.include_empty_choice:</font>
<font color="red"> 216.             yield {</font>
<font color="red"> 217.                 'selected': bool(self.lookup_val_isnull),</font>
<font color="red"> 218.                 'query_string': cl.get_query_string({</font>
<font color="red"> 219.                     self.lookup_kwarg_isnull: 'True',</font>
<font color="red"> 220.                 }, [self.lookup_kwarg]),</font>
<font color="red"> 221.                 'display': self.empty_value_display,</font>
<font color="black"> 222.             }</font>
<font color="black"> 223. </font>
<font color="green"> 224. FieldListFilter.register(lambda f: f.remote_field, RelatedFieldListFilter)</font>
<font color="black"> 225. </font>
<font color="black"> 226. </font>
<font color="green"> 227. class BooleanFieldListFilter(FieldListFilter):</font>
<font color="green"> 228.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 229.         self.lookup_kwarg = '%s__exact' % field_path</font>
<font color="red"> 230.         self.lookup_kwarg2 = '%s__isnull' % field_path</font>
<font color="red"> 231.         self.lookup_val = request.GET.get(self.lookup_kwarg)</font>
<font color="red"> 232.         self.lookup_val2 = request.GET.get(self.lookup_kwarg2)</font>
<font color="red"> 233.         super(BooleanFieldListFilter, self).__init__(field,</font>
<font color="red"> 234.             request, params, model, model_admin, field_path)</font>
<font color="black"> 235. </font>
<font color="green"> 236.     def expected_parameters(self):</font>
<font color="red"> 237.         return [self.lookup_kwarg, self.lookup_kwarg2]</font>
<font color="black"> 238. </font>
<font color="green"> 239.     def choices(self, cl):</font>
<font color="red"> 240.         for lookup, title in (</font>
<font color="red"> 241.                 (None, _('All')),</font>
<font color="red"> 242.                 ('1', _('Yes')),</font>
<font color="red"> 243.                 ('0', _('No'))):</font>
<font color="red"> 244.             yield {</font>
<font color="red"> 245.                 'selected': self.lookup_val == lookup and not self.lookup_val2,</font>
<font color="red"> 246.                 'query_string': cl.get_query_string({</font>
<font color="red"> 247.                     self.lookup_kwarg: lookup,</font>
<font color="red"> 248.                 }, [self.lookup_kwarg2]),</font>
<font color="red"> 249.                 'display': title,</font>
<font color="black"> 250.             }</font>
<font color="red"> 251.         if isinstance(self.field, models.NullBooleanField):</font>
<font color="red"> 252.             yield {</font>
<font color="red"> 253.                 'selected': self.lookup_val2 == 'True',</font>
<font color="red"> 254.                 'query_string': cl.get_query_string({</font>
<font color="red"> 255.                     self.lookup_kwarg2: 'True',</font>
<font color="red"> 256.                 }, [self.lookup_kwarg]),</font>
<font color="red"> 257.                 'display': _('Unknown'),</font>
<font color="black"> 258.             }</font>
<font color="black"> 259. </font>
<font color="green"> 260. FieldListFilter.register(lambda f: isinstance(f,</font>
<font color="green"> 261.     (models.BooleanField, models.NullBooleanField)), BooleanFieldListFilter)</font>
<font color="black"> 262. </font>
<font color="black"> 263. </font>
<font color="green"> 264. class ChoicesFieldListFilter(FieldListFilter):</font>
<font color="green"> 265.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 266.         self.lookup_kwarg = '%s__exact' % field_path</font>
<font color="red"> 267.         self.lookup_val = request.GET.get(self.lookup_kwarg)</font>
<font color="red"> 268.         super(ChoicesFieldListFilter, self).__init__(</font>
<font color="red"> 269.             field, request, params, model, model_admin, field_path)</font>
<font color="black"> 270. </font>
<font color="green"> 271.     def expected_parameters(self):</font>
<font color="red"> 272.         return [self.lookup_kwarg]</font>
<font color="black"> 273. </font>
<font color="green"> 274.     def choices(self, cl):</font>
<font color="red"> 275.         yield {</font>
<font color="red"> 276.             'selected': self.lookup_val is None,</font>
<font color="red"> 277.             'query_string': cl.get_query_string({}, [self.lookup_kwarg]),</font>
<font color="red"> 278.             'display': _('All')</font>
<font color="black"> 279.         }</font>
<font color="red"> 280.         for lookup, title in self.field.flatchoices:</font>
<font color="red"> 281.             yield {</font>
<font color="red"> 282.                 'selected': smart_text(lookup) == self.lookup_val,</font>
<font color="red"> 283.                 'query_string': cl.get_query_string({</font>
<font color="red"> 284.                     self.lookup_kwarg: lookup}),</font>
<font color="red"> 285.                 'display': title,</font>
<font color="black"> 286.             }</font>
<font color="black"> 287. </font>
<font color="green"> 288. FieldListFilter.register(lambda f: bool(f.choices), ChoicesFieldListFilter)</font>
<font color="black"> 289. </font>
<font color="black"> 290. </font>
<font color="green"> 291. class DateFieldListFilter(FieldListFilter):</font>
<font color="green"> 292.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 293.         self.field_generic = '%s__' % field_path</font>
<font color="red"> 294.         self.date_params = {k: v for k, v in params.items()</font>
<font color="red"> 295.                             if k.startswith(self.field_generic)}</font>
<font color="black"> 296. </font>
<font color="red"> 297.         now = timezone.now()</font>
<font color="black"> 298.         # When time zone support is enabled, convert &quot;now&quot; to the user's time</font>
<font color="black"> 299.         # zone so Django's definition of &quot;Today&quot; matches what the user expects.</font>
<font color="red"> 300.         if timezone.is_aware(now):</font>
<font color="red"> 301.             now = timezone.localtime(now)</font>
<font color="black"> 302. </font>
<font color="red"> 303.         if isinstance(field, models.DateTimeField):</font>
<font color="red"> 304.             today = now.replace(hour=0, minute=0, second=0, microsecond=0)</font>
<font color="black"> 305.         else:       # field is a models.DateField</font>
<font color="red"> 306.             today = now.date()</font>
<font color="red"> 307.         tomorrow = today + datetime.timedelta(days=1)</font>
<font color="red"> 308.         if today.month == 12:</font>
<font color="red"> 309.             next_month = today.replace(year=today.year + 1, month=1, day=1)</font>
<font color="black"> 310.         else:</font>
<font color="red"> 311.             next_month = today.replace(month=today.month + 1, day=1)</font>
<font color="red"> 312.         next_year = today.replace(year=today.year + 1, month=1, day=1)</font>
<font color="black"> 313. </font>
<font color="red"> 314.         self.lookup_kwarg_since = '%s__gte' % field_path</font>
<font color="red"> 315.         self.lookup_kwarg_until = '%s__lt' % field_path</font>
<font color="black"> 316.         self.links = (</font>
<font color="red"> 317.             (_('Any date'), {}),</font>
<font color="red"> 318.             (_('Today'), {</font>
<font color="red"> 319.                 self.lookup_kwarg_since: str(today),</font>
<font color="red"> 320.                 self.lookup_kwarg_until: str(tomorrow),</font>
<font color="black"> 321.             }),</font>
<font color="red"> 322.             (_('Past 7 days'), {</font>
<font color="red"> 323.                 self.lookup_kwarg_since: str(today - datetime.timedelta(days=7)),</font>
<font color="red"> 324.                 self.lookup_kwarg_until: str(tomorrow),</font>
<font color="black"> 325.             }),</font>
<font color="red"> 326.             (_('This month'), {</font>
<font color="red"> 327.                 self.lookup_kwarg_since: str(today.replace(day=1)),</font>
<font color="red"> 328.                 self.lookup_kwarg_until: str(next_month),</font>
<font color="black"> 329.             }),</font>
<font color="red"> 330.             (_('This year'), {</font>
<font color="red"> 331.                 self.lookup_kwarg_since: str(today.replace(month=1, day=1)),</font>
<font color="red"> 332.                 self.lookup_kwarg_until: str(next_year),</font>
<font color="black"> 333.             }),</font>
<font color="black"> 334.         )</font>
<font color="red"> 335.         super(DateFieldListFilter, self).__init__(</font>
<font color="red"> 336.             field, request, params, model, model_admin, field_path)</font>
<font color="black"> 337. </font>
<font color="green"> 338.     def expected_parameters(self):</font>
<font color="red"> 339.         return [self.lookup_kwarg_since, self.lookup_kwarg_until]</font>
<font color="black"> 340. </font>
<font color="green"> 341.     def choices(self, cl):</font>
<font color="red"> 342.         for title, param_dict in self.links:</font>
<font color="red"> 343.             yield {</font>
<font color="red"> 344.                 'selected': self.date_params == param_dict,</font>
<font color="red"> 345.                 'query_string': cl.get_query_string(</font>
<font color="red"> 346.                     param_dict, [self.field_generic]),</font>
<font color="red"> 347.                 'display': title,</font>
<font color="black"> 348.             }</font>
<font color="black"> 349. </font>
<font color="green"> 350. FieldListFilter.register(</font>
<font color="green"> 351.     lambda f: isinstance(f, models.DateField), DateFieldListFilter)</font>
<font color="black"> 352. </font>
<font color="black"> 353. </font>
<font color="black"> 354. # This should be registered last, because it's a last resort. For example,</font>
<font color="black"> 355. # if a field is eligible to use the BooleanFieldListFilter, that'd be much</font>
<font color="black"> 356. # more appropriate, and the AllValuesFieldListFilter won't get used for it.</font>
<font color="green"> 357. class AllValuesFieldListFilter(FieldListFilter):</font>
<font color="green"> 358.     def __init__(self, field, request, params, model, model_admin, field_path):</font>
<font color="red"> 359.         self.lookup_kwarg = field_path</font>
<font color="red"> 360.         self.lookup_kwarg_isnull = '%s__isnull' % field_path</font>
<font color="red"> 361.         self.lookup_val = request.GET.get(self.lookup_kwarg)</font>
<font color="red"> 362.         self.lookup_val_isnull = request.GET.get(self.lookup_kwarg_isnull)</font>
<font color="red"> 363.         self.empty_value_display = model_admin.get_empty_value_display()</font>
<font color="red"> 364.         parent_model, reverse_path = reverse_field_path(model, field_path)</font>
<font color="black"> 365.         # Obey parent ModelAdmin queryset when deciding which options to show</font>
<font color="red"> 366.         if model == parent_model:</font>
<font color="red"> 367.             queryset = model_admin.get_queryset(request)</font>
<font color="black"> 368.         else:</font>
<font color="red"> 369.             queryset = parent_model._default_manager.all()</font>
<font color="red"> 370.         self.lookup_choices = (queryset</font>
<font color="black"> 371.                                .distinct()</font>
<font color="red"> 372.                                .order_by(field.name)</font>
<font color="red"> 373.                                .values_list(field.name, flat=True))</font>
<font color="red"> 374.         super(AllValuesFieldListFilter, self).__init__(</font>
<font color="red"> 375.             field, request, params, model, model_admin, field_path)</font>
<font color="black"> 376. </font>
<font color="green"> 377.     def expected_parameters(self):</font>
<font color="red"> 378.         return [self.lookup_kwarg, self.lookup_kwarg_isnull]</font>
<font color="black"> 379. </font>
<font color="green"> 380.     def choices(self, cl):</font>
<font color="red"> 381.         yield {</font>
<font color="red"> 382.             'selected': (self.lookup_val is None</font>
<font color="red"> 383.                 and self.lookup_val_isnull is None),</font>
<font color="red"> 384.             'query_string': cl.get_query_string({},</font>
<font color="red"> 385.                 [self.lookup_kwarg, self.lookup_kwarg_isnull]),</font>
<font color="red"> 386.             'display': _('All'),</font>
<font color="black"> 387.         }</font>
<font color="red"> 388.         include_none = False</font>
<font color="red"> 389.         for val in self.lookup_choices:</font>
<font color="red"> 390.             if val is None:</font>
<font color="red"> 391.                 include_none = True</font>
<font color="red"> 392.                 continue</font>
<font color="red"> 393.             val = smart_text(val)</font>
<font color="red"> 394.             yield {</font>
<font color="red"> 395.                 'selected': self.lookup_val == val,</font>
<font color="red"> 396.                 'query_string': cl.get_query_string({</font>
<font color="red"> 397.                     self.lookup_kwarg: val,</font>
<font color="red"> 398.                 }, [self.lookup_kwarg_isnull]),</font>
<font color="red"> 399.                 'display': val,</font>
<font color="black"> 400.             }</font>
<font color="red"> 401.         if include_none:</font>
<font color="red"> 402.             yield {</font>
<font color="red"> 403.                 'selected': bool(self.lookup_val_isnull),</font>
<font color="red"> 404.                 'query_string': cl.get_query_string({</font>
<font color="red"> 405.                     self.lookup_kwarg_isnull: 'True',</font>
<font color="red"> 406.                 }, [self.lookup_kwarg]),</font>
<font color="red"> 407.                 'display': self.empty_value_display,</font>
<font color="black"> 408.             }</font>
<font color="black"> 409. </font>
<font color="green"> 410. FieldListFilter.register(lambda f: True, AllValuesFieldListFilter)</font>
<font color="black"> 411. </font>
<font color="black"> 412. </font>
<font color="green"> 413. class RelatedOnlyFieldListFilter(RelatedFieldListFilter):</font>
<font color="green"> 414.     def field_choices(self, field, request, model_admin):</font>
<font color="red"> 415.         limit_choices_to = {'pk__in': set(model_admin.get_queryset(request).values_list(field.name, flat=True))}</font>
<font color="red"> 416.         return field.get_choices(include_blank=False, limit_choices_to=limit_choices_to)</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/contenttypes/forms.py</b><br>


file stats: <b>65 lines, 19 executed: 29.2% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.contrib.contenttypes.models import ContentType</font>
<font color="green">   4. from django.db import models</font>
<font color="green">   5. from django.forms import ModelForm, modelformset_factory</font>
<font color="green">   6. from django.forms.models import BaseModelFormSet</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="green">   9. class BaseGenericInlineFormSet(BaseModelFormSet):</font>
<font color="black">  10.     &quot;&quot;&quot;</font>
<font color="black">  11.     A formset for generic inline objects to a parent.</font>
<font color="green">  12.     &quot;&quot;&quot;</font>
<font color="black">  13. </font>
<font color="green">  14.     def __init__(self, data=None, files=None, instance=None, save_as_new=None,</font>
<font color="green">  15.                  prefix=None, queryset=None, **kwargs):</font>
<font color="red">  16.         opts = self.model._meta</font>
<font color="red">  17.         self.instance = instance</font>
<font color="red">  18.         self.rel_name = '-'.join((</font>
<font color="red">  19.             opts.app_label, opts.model_name,</font>
<font color="red">  20.             self.ct_field.name, self.ct_fk_field.name,</font>
<font color="black">  21.         ))</font>
<font color="red">  22.         if self.instance is None or self.instance.pk is None:</font>
<font color="red">  23.             qs = self.model._default_manager.none()</font>
<font color="black">  24.         else:</font>
<font color="red">  25.             if queryset is None:</font>
<font color="red">  26.                 queryset = self.model._default_manager</font>
<font color="red">  27.             qs = queryset.filter(**{</font>
<font color="red">  28.                 self.ct_field.name: ContentType.objects.get_for_model(</font>
<font color="red">  29.                     self.instance, for_concrete_model=self.for_concrete_model),</font>
<font color="red">  30.                 self.ct_fk_field.name: self.instance.pk,</font>
<font color="black">  31.             })</font>
<font color="red">  32.         super(BaseGenericInlineFormSet, self).__init__(</font>
<font color="red">  33.             queryset=qs, data=data, files=files,</font>
<font color="red">  34.             prefix=prefix,</font>
<font color="red">  35.             **kwargs</font>
<font color="black">  36.         )</font>
<font color="black">  37. </font>
<font color="green">  38.     @classmethod</font>
<font color="black">  39.     def get_default_prefix(cls):</font>
<font color="red">  40.         opts = cls.model._meta</font>
<font color="red">  41.         return '-'.join(</font>
<font color="red">  42.             (opts.app_label, opts.model_name,</font>
<font color="red">  43.             cls.ct_field.name, cls.ct_fk_field.name)</font>
<font color="black">  44.         )</font>
<font color="black">  45. </font>
<font color="green">  46.     def save_new(self, form, commit=True):</font>
<font color="red">  47.         setattr(form.instance, self.ct_field.get_attname(),</font>
<font color="red">  48.             ContentType.objects.get_for_model(self.instance).pk)</font>
<font color="red">  49.         setattr(form.instance, self.ct_fk_field.get_attname(),</font>
<font color="red">  50.             self.instance.pk)</font>
<font color="red">  51.         return form.save(commit=commit)</font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="green">  54. def generic_inlineformset_factory(model, form=ModelForm,</font>
<font color="green">  55.                                   formset=BaseGenericInlineFormSet,</font>
<font color="green">  56.                                   ct_field=&quot;content_type&quot;, fk_field=&quot;object_id&quot;,</font>
<font color="green">  57.                                   fields=None, exclude=None,</font>
<font color="green">  58.                                   extra=3, can_order=False, can_delete=True,</font>
<font color="green">  59.                                   max_num=None, formfield_callback=None,</font>
<font color="green">  60.                                   validate_max=False, for_concrete_model=True,</font>
<font color="green">  61.                                   min_num=None, validate_min=False):</font>
<font color="black">  62.     &quot;&quot;&quot;</font>
<font color="black">  63.     Returns a ``GenericInlineFormSet`` for the given kwargs.</font>
<font color="black">  64. </font>
<font color="black">  65.     You must provide ``ct_field`` and ``fk_field`` if they are different from</font>
<font color="black">  66.     the defaults ``content_type`` and ``object_id`` respectively.</font>
<font color="black">  67.     &quot;&quot;&quot;</font>
<font color="red">  68.     opts = model._meta</font>
<font color="black">  69.     # if there is no field called `ct_field` let the exception propagate</font>
<font color="red">  70.     ct_field = opts.get_field(ct_field)</font>
<font color="red">  71.     if not isinstance(ct_field, models.ForeignKey) or ct_field.remote_field.model != ContentType:</font>
<font color="red">  72.         raise Exception(&quot;fk_name '%s' is not a ForeignKey to ContentType&quot; % ct_field)</font>
<font color="red">  73.     fk_field = opts.get_field(fk_field)  # let the exception propagate</font>
<font color="red">  74.     if exclude is not None:</font>
<font color="red">  75.         exclude = list(exclude)</font>
<font color="red">  76.         exclude.extend([ct_field.name, fk_field.name])</font>
<font color="black">  77.     else:</font>
<font color="red">  78.         exclude = [ct_field.name, fk_field.name]</font>
<font color="red">  79.     FormSet = modelformset_factory(model, form=form,</font>
<font color="red">  80.                                    formfield_callback=formfield_callback,</font>
<font color="red">  81.                                    formset=formset,</font>
<font color="red">  82.                                    extra=extra, can_delete=can_delete, can_order=can_order,</font>
<font color="red">  83.                                    fields=fields, exclude=exclude, max_num=max_num,</font>
<font color="red">  84.                                    validate_max=validate_max, min_num=min_num,</font>
<font color="red">  85.                                    validate_min=validate_min)</font>
<font color="red">  86.     FormSet.ct_field = ct_field</font>
<font color="red">  87.     FormSet.ct_fk_field = fk_field</font>
<font color="red">  88.     FormSet.for_concrete_model = for_concrete_model</font>
<font color="red">  89.     return FormSet</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/formats.py</b><br>


file stats: <b>153 lines, 45 executed: 29.4% covered</b>
<pre>
<font color="green">   1. import datetime</font>
<font color="green">   2. import decimal</font>
<font color="green">   3. import unicodedata</font>
<font color="green">   4. from importlib import import_module</font>
<font color="black">   5. </font>
<font color="green">   6. from django.conf import settings</font>
<font color="green">   7. from django.utils import dateformat, datetime_safe, numberformat, six</font>
<font color="green">   8. from django.utils.encoding import force_str</font>
<font color="green">   9. from django.utils.functional import lazy</font>
<font color="green">  10. from django.utils.safestring import mark_safe</font>
<font color="green">  11. from django.utils.translation import (</font>
<font color="black">  12.     check_for_language, get_language, to_locale,</font>
<font color="black">  13. )</font>
<font color="black">  14. </font>
<font color="black">  15. # format_cache is a mapping from (format_type, lang) to the format string.</font>
<font color="black">  16. # By using the cache, it is possible to avoid running get_format_modules</font>
<font color="black">  17. # repeatedly.</font>
<font color="green">  18. _format_cache = {}</font>
<font color="green">  19. _format_modules_cache = {}</font>
<font color="black">  20. </font>
<font color="green">  21. ISO_INPUT_FORMATS = {</font>
<font color="green">  22.     'DATE_INPUT_FORMATS': ['%Y-%m-%d'],</font>
<font color="green">  23.     'TIME_INPUT_FORMATS': ['%H:%M:%S', '%H:%M:%S.%f', '%H:%M'],</font>
<font color="black">  24.     'DATETIME_INPUT_FORMATS': [</font>
<font color="green">  25.         '%Y-%m-%d %H:%M:%S',</font>
<font color="green">  26.         '%Y-%m-%d %H:%M:%S.%f',</font>
<font color="green">  27.         '%Y-%m-%d %H:%M',</font>
<font color="green">  28.         '%Y-%m-%d'</font>
<font color="black">  29.     ],</font>
<font color="black">  30. }</font>
<font color="black">  31. </font>
<font color="black">  32. </font>
<font color="green">  33. FORMAT_SETTINGS = frozenset([</font>
<font color="green">  34.     'DECIMAL_SEPARATOR',</font>
<font color="green">  35.     'THOUSAND_SEPARATOR',</font>
<font color="green">  36.     'NUMBER_GROUPING',</font>
<font color="green">  37.     'FIRST_DAY_OF_WEEK',</font>
<font color="green">  38.     'MONTH_DAY_FORMAT',</font>
<font color="green">  39.     'TIME_FORMAT',</font>
<font color="green">  40.     'DATE_FORMAT',</font>
<font color="green">  41.     'DATETIME_FORMAT',</font>
<font color="green">  42.     'SHORT_DATE_FORMAT',</font>
<font color="green">  43.     'SHORT_DATETIME_FORMAT',</font>
<font color="green">  44.     'YEAR_MONTH_FORMAT',</font>
<font color="green">  45.     'DATE_INPUT_FORMATS',</font>
<font color="green">  46.     'TIME_INPUT_FORMATS',</font>
<font color="green">  47.     'DATETIME_INPUT_FORMATS',</font>
<font color="black">  48. ])</font>
<font color="black">  49. </font>
<font color="black">  50. </font>
<font color="green">  51. def reset_format_cache():</font>
<font color="black">  52.     &quot;&quot;&quot;Clear any cached formats.</font>
<font color="black">  53. </font>
<font color="black">  54.     This method is provided primarily for testing purposes,</font>
<font color="black">  55.     so that the effects of cached formats can be removed.</font>
<font color="black">  56.     &quot;&quot;&quot;</font>
<font color="black">  57.     global _format_cache, _format_modules_cache</font>
<font color="red">  58.     _format_cache = {}</font>
<font color="red">  59.     _format_modules_cache = {}</font>
<font color="black">  60. </font>
<font color="black">  61. </font>
<font color="green">  62. def iter_format_modules(lang, format_module_path=None):</font>
<font color="black">  63.     &quot;&quot;&quot;</font>
<font color="black">  64.     Does the heavy lifting of finding format modules.</font>
<font color="black">  65.     &quot;&quot;&quot;</font>
<font color="red">  66.     if not check_for_language(lang):</font>
<font color="red">  67.         return</font>
<font color="black">  68. </font>
<font color="red">  69.     if format_module_path is None:</font>
<font color="red">  70.         format_module_path = settings.FORMAT_MODULE_PATH</font>
<font color="black">  71. </font>
<font color="red">  72.     format_locations = []</font>
<font color="red">  73.     if format_module_path:</font>
<font color="red">  74.         if isinstance(format_module_path, six.string_types):</font>
<font color="red">  75.             format_module_path = [format_module_path]</font>
<font color="red">  76.         for path in format_module_path:</font>
<font color="red">  77.             format_locations.append(path + '.%s')</font>
<font color="red">  78.     format_locations.append('django.conf.locale.%s')</font>
<font color="red">  79.     locale = to_locale(lang)</font>
<font color="red">  80.     locales = [locale]</font>
<font color="red">  81.     if '_' in locale:</font>
<font color="red">  82.         locales.append(locale.split('_')[0])</font>
<font color="red">  83.     for location in format_locations:</font>
<font color="red">  84.         for loc in locales:</font>
<font color="red">  85.             try:</font>
<font color="red">  86.                 yield import_module('%s.formats' % (location % loc))</font>
<font color="red">  87.             except ImportError:</font>
<font color="red">  88.                 pass</font>
<font color="black">  89. </font>
<font color="black">  90. </font>
<font color="green">  91. def get_format_modules(lang=None, reverse=False):</font>
<font color="black">  92.     &quot;&quot;&quot;</font>
<font color="black">  93.     Returns a list of the format modules found</font>
<font color="black">  94.     &quot;&quot;&quot;</font>
<font color="red">  95.     if lang is None:</font>
<font color="red">  96.         lang = get_language()</font>
<font color="red">  97.     modules = _format_modules_cache.setdefault(lang, list(iter_format_modules(lang, settings.FORMAT_MODULE_PATH)))</font>
<font color="red">  98.     if reverse:</font>
<font color="red">  99.         return list(reversed(modules))</font>
<font color="red"> 100.     return modules</font>
<font color="black"> 101. </font>
<font color="black"> 102. </font>
<font color="green"> 103. def get_format(format_type, lang=None, use_l10n=None):</font>
<font color="black"> 104.     &quot;&quot;&quot;</font>
<font color="black"> 105.     For a specific format type, returns the format for the current</font>
<font color="black"> 106.     language (locale), defaults to the format in the settings.</font>
<font color="black"> 107.     format_type is the name of the format, e.g. 'DATE_FORMAT'</font>
<font color="black"> 108. </font>
<font color="black"> 109.     If use_l10n is provided and is not None, that will force the value to</font>
<font color="black"> 110.     be localized (or not), overriding the value of settings.USE_L10N.</font>
<font color="black"> 111.     &quot;&quot;&quot;</font>
<font color="red"> 112.     format_type = force_str(format_type)</font>
<font color="red"> 113.     if use_l10n or (use_l10n is None and settings.USE_L10N):</font>
<font color="red"> 114.         if lang is None:</font>
<font color="red"> 115.             lang = get_language()</font>
<font color="red"> 116.         cache_key = (format_type, lang)</font>
<font color="red"> 117.         try:</font>
<font color="red"> 118.             cached = _format_cache[cache_key]</font>
<font color="red"> 119.             if cached is not None:</font>
<font color="red"> 120.                 return cached</font>
<font color="red"> 121.         except KeyError:</font>
<font color="red"> 122.             for module in get_format_modules(lang):</font>
<font color="red"> 123.                 try:</font>
<font color="red"> 124.                     val = getattr(module, format_type)</font>
<font color="red"> 125.                     for iso_input in ISO_INPUT_FORMATS.get(format_type, ()):</font>
<font color="red"> 126.                         if iso_input not in val:</font>
<font color="red"> 127.                             if isinstance(val, tuple):</font>
<font color="red"> 128.                                 val = list(val)</font>
<font color="red"> 129.                             val.append(iso_input)</font>
<font color="red"> 130.                     _format_cache[cache_key] = val</font>
<font color="red"> 131.                     return val</font>
<font color="red"> 132.                 except AttributeError:</font>
<font color="red"> 133.                     pass</font>
<font color="red"> 134.             _format_cache[cache_key] = None</font>
<font color="red"> 135.     if format_type not in FORMAT_SETTINGS:</font>
<font color="red"> 136.         return format_type</font>
<font color="black"> 137.     # Return the general setting by default</font>
<font color="red"> 138.     return getattr(settings, format_type)</font>
<font color="black"> 139. </font>
<font color="green"> 140. get_format_lazy = lazy(get_format, six.text_type, list, tuple)</font>
<font color="black"> 141. </font>
<font color="black"> 142. </font>
<font color="green"> 143. def date_format(value, format=None, use_l10n=None):</font>
<font color="black"> 144.     &quot;&quot;&quot;</font>
<font color="black"> 145.     Formats a datetime.date or datetime.datetime object using a</font>
<font color="black"> 146.     localizable format</font>
<font color="black"> 147. </font>
<font color="black"> 148.     If use_l10n is provided and is not None, that will force the value to</font>
<font color="black"> 149.     be localized (or not), overriding the value of settings.USE_L10N.</font>
<font color="black"> 150.     &quot;&quot;&quot;</font>
<font color="red"> 151.     return dateformat.format(value, get_format(format or 'DATE_FORMAT', use_l10n=use_l10n))</font>
<font color="black"> 152. </font>
<font color="black"> 153. </font>
<font color="green"> 154. def time_format(value, format=None, use_l10n=None):</font>
<font color="black"> 155.     &quot;&quot;&quot;</font>
<font color="black"> 156.     Formats a datetime.time object using a localizable format</font>
<font color="black"> 157. </font>
<font color="black"> 158.     If use_l10n is provided and is not None, that will force the value to</font>
<font color="black"> 159.     be localized (or not), overriding the value of settings.USE_L10N.</font>
<font color="black"> 160.     &quot;&quot;&quot;</font>
<font color="red"> 161.     return dateformat.time_format(value, get_format(format or 'TIME_FORMAT', use_l10n=use_l10n))</font>
<font color="black"> 162. </font>
<font color="black"> 163. </font>
<font color="green"> 164. def number_format(value, decimal_pos=None, use_l10n=None, force_grouping=False):</font>
<font color="black"> 165.     &quot;&quot;&quot;</font>
<font color="black"> 166.     Formats a numeric value using localization settings</font>
<font color="black"> 167. </font>
<font color="black"> 168.     If use_l10n is provided and is not None, that will force the value to</font>
<font color="black"> 169.     be localized (or not), overriding the value of settings.USE_L10N.</font>
<font color="black"> 170.     &quot;&quot;&quot;</font>
<font color="red"> 171.     if use_l10n or (use_l10n is None and settings.USE_L10N):</font>
<font color="red"> 172.         lang = get_language()</font>
<font color="black"> 173.     else:</font>
<font color="red"> 174.         lang = None</font>
<font color="red"> 175.     return numberformat.format(</font>
<font color="red"> 176.         value,</font>
<font color="red"> 177.         get_format('DECIMAL_SEPARATOR', lang, use_l10n=use_l10n),</font>
<font color="red"> 178.         decimal_pos,</font>
<font color="red"> 179.         get_format('NUMBER_GROUPING', lang, use_l10n=use_l10n),</font>
<font color="red"> 180.         get_format('THOUSAND_SEPARATOR', lang, use_l10n=use_l10n),</font>
<font color="red"> 181.         force_grouping=force_grouping</font>
<font color="black"> 182.     )</font>
<font color="black"> 183. </font>
<font color="black"> 184. </font>
<font color="green"> 185. def localize(value, use_l10n=None):</font>
<font color="black"> 186.     &quot;&quot;&quot;</font>
<font color="black"> 187.     Checks if value is a localizable type (date, number...) and returns it</font>
<font color="black"> 188.     formatted as a string using current locale format.</font>
<font color="black"> 189. </font>
<font color="black"> 190.     If use_l10n is provided and is not None, that will force the value to</font>
<font color="black"> 191.     be localized (or not), overriding the value of settings.USE_L10N.</font>
<font color="black"> 192.     &quot;&quot;&quot;</font>
<font color="red"> 193.     if isinstance(value, bool):</font>
<font color="red"> 194.         return mark_safe(six.text_type(value))</font>
<font color="red"> 195.     elif isinstance(value, (decimal.Decimal, float) + six.integer_types):</font>
<font color="red"> 196.         return number_format(value, use_l10n=use_l10n)</font>
<font color="red"> 197.     elif isinstance(value, datetime.datetime):</font>
<font color="red"> 198.         return date_format(value, 'DATETIME_FORMAT', use_l10n=use_l10n)</font>
<font color="red"> 199.     elif isinstance(value, datetime.date):</font>
<font color="red"> 200.         return date_format(value, use_l10n=use_l10n)</font>
<font color="red"> 201.     elif isinstance(value, datetime.time):</font>
<font color="red"> 202.         return time_format(value, 'TIME_FORMAT', use_l10n=use_l10n)</font>
<font color="black"> 203.     else:</font>
<font color="red"> 204.         return value</font>
<font color="black"> 205. </font>
<font color="black"> 206. </font>
<font color="green"> 207. def localize_input(value, default=None):</font>
<font color="black"> 208.     &quot;&quot;&quot;</font>
<font color="black"> 209.     Checks if an input value is a localizable type and returns it</font>
<font color="black"> 210.     formatted with the appropriate formatting string of the current locale.</font>
<font color="black"> 211.     &quot;&quot;&quot;</font>
<font color="red"> 212.     if isinstance(value, (decimal.Decimal, float) + six.integer_types):</font>
<font color="red"> 213.         return number_format(value)</font>
<font color="red"> 214.     elif isinstance(value, datetime.datetime):</font>
<font color="red"> 215.         value = datetime_safe.new_datetime(value)</font>
<font color="red"> 216.         format = force_str(default or get_format('DATETIME_INPUT_FORMATS')[0])</font>
<font color="red"> 217.         return value.strftime(format)</font>
<font color="red"> 218.     elif isinstance(value, datetime.date):</font>
<font color="red"> 219.         value = datetime_safe.new_date(value)</font>
<font color="red"> 220.         format = force_str(default or get_format('DATE_INPUT_FORMATS')[0])</font>
<font color="red"> 221.         return value.strftime(format)</font>
<font color="red"> 222.     elif isinstance(value, datetime.time):</font>
<font color="red"> 223.         format = force_str(default or get_format('TIME_INPUT_FORMATS')[0])</font>
<font color="red"> 224.         return value.strftime(format)</font>
<font color="red"> 225.     return value</font>
<font color="black"> 226. </font>
<font color="black"> 227. </font>
<font color="green"> 228. def sanitize_separators(value):</font>
<font color="black"> 229.     &quot;&quot;&quot;</font>
<font color="black"> 230.     Sanitizes a value according to the current decimal and</font>
<font color="black"> 231.     thousand separator setting. Used with form field input.</font>
<font color="black"> 232.     &quot;&quot;&quot;</font>
<font color="red"> 233.     if settings.USE_L10N and isinstance(value, six.string_types):</font>
<font color="red"> 234.         parts = []</font>
<font color="red"> 235.         decimal_separator = get_format('DECIMAL_SEPARATOR')</font>
<font color="red"> 236.         if decimal_separator in value:</font>
<font color="red"> 237.             value, decimals = value.split(decimal_separator, 1)</font>
<font color="red"> 238.             parts.append(decimals)</font>
<font color="red"> 239.         if settings.USE_THOUSAND_SEPARATOR:</font>
<font color="red"> 240.             thousand_sep = get_format('THOUSAND_SEPARATOR')</font>
<font color="red"> 241.             if thousand_sep == '.' and value.count('.') == 1 and len(value.split('.')[-1]) != 3:</font>
<font color="black"> 242.                 # Special case where we suspect a dot meant decimal separator (see #22171)</font>
<font color="red"> 243.                 pass</font>
<font color="black"> 244.             else:</font>
<font color="red"> 245.                 for replacement in {</font>
<font color="red"> 246.                         thousand_sep, unicodedata.normalize('NFKD', thousand_sep)}:</font>
<font color="red"> 247.                     value = value.replace(replacement, '')</font>
<font color="red"> 248.         parts.append(value)</font>
<font color="red"> 249.         value = '.'.join(reversed(parts))</font>
<font color="red"> 250.     return value</font>
</pre>


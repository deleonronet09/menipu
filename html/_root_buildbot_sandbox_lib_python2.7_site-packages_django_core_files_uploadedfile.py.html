source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/files/uploadedfile.py</b><br>


file stats: <b>70 lines, 32 executed: 45.7% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Classes representing uploaded files.</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="black">   4. </font>
<font color="green">   5. import errno</font>
<font color="green">   6. import os</font>
<font color="green">   7. from io import BytesIO</font>
<font color="black">   8. </font>
<font color="green">   9. from django.conf import settings</font>
<font color="green">  10. from django.core.files import temp as tempfile</font>
<font color="green">  11. from django.core.files.base import File</font>
<font color="green">  12. from django.utils.encoding import force_str</font>
<font color="black">  13. </font>
<font color="black">  14. __all__ = ('UploadedFile', 'TemporaryUploadedFile', 'InMemoryUploadedFile',</font>
<font color="green">  15.            'SimpleUploadedFile')</font>
<font color="black">  16. </font>
<font color="black">  17. </font>
<font color="green">  18. class UploadedFile(File):</font>
<font color="black">  19.     &quot;&quot;&quot;</font>
<font color="black">  20.     A abstract uploaded file (``TemporaryUploadedFile`` and</font>
<font color="black">  21.     ``InMemoryUploadedFile`` are the built-in concrete subclasses).</font>
<font color="black">  22. </font>
<font color="black">  23.     An ``UploadedFile`` object behaves somewhat like a file object and</font>
<font color="black">  24.     represents some file data that the user submitted with a form.</font>
<font color="green">  25.     &quot;&quot;&quot;</font>
<font color="green">  26.     DEFAULT_CHUNK_SIZE = 64 * 2 ** 10</font>
<font color="black">  27. </font>
<font color="green">  28.     def __init__(self, file=None, name=None, content_type=None, size=None, charset=None, content_type_extra=None):</font>
<font color="red">  29.         super(UploadedFile, self).__init__(file, name)</font>
<font color="red">  30.         self.size = size</font>
<font color="red">  31.         self.content_type = content_type</font>
<font color="red">  32.         self.charset = charset</font>
<font color="red">  33.         self.content_type_extra = content_type_extra</font>
<font color="black">  34. </font>
<font color="green">  35.     def __repr__(self):</font>
<font color="red">  36.         return force_str(&quot;&lt;%s: %s (%s)&gt;&quot; % (</font>
<font color="red">  37.             self.__class__.__name__, self.name, self.content_type))</font>
<font color="black">  38. </font>
<font color="green">  39.     def _get_name(self):</font>
<font color="red">  40.         return self._name</font>
<font color="black">  41. </font>
<font color="green">  42.     def _set_name(self, name):</font>
<font color="black">  43.         # Sanitize the file name so that it can't be dangerous.</font>
<font color="red">  44.         if name is not None:</font>
<font color="black">  45.             # Just use the basename of the file -- anything else is dangerous.</font>
<font color="red">  46.             name = os.path.basename(name)</font>
<font color="black">  47. </font>
<font color="black">  48.             # File names longer than 255 characters can cause problems on older OSes.</font>
<font color="red">  49.             if len(name) &gt; 255:</font>
<font color="red">  50.                 name, ext = os.path.splitext(name)</font>
<font color="red">  51.                 ext = ext[:255]</font>
<font color="red">  52.                 name = name[:255 - len(ext)] + ext</font>
<font color="black">  53. </font>
<font color="red">  54.         self._name = name</font>
<font color="black">  55. </font>
<font color="green">  56.     name = property(_get_name, _set_name)</font>
<font color="black">  57. </font>
<font color="black">  58. </font>
<font color="green">  59. class TemporaryUploadedFile(UploadedFile):</font>
<font color="black">  60.     &quot;&quot;&quot;</font>
<font color="black">  61.     A file uploaded to a temporary location (i.e. stream-to-disk).</font>
<font color="green">  62.     &quot;&quot;&quot;</font>
<font color="green">  63.     def __init__(self, name, content_type, size, charset, content_type_extra=None):</font>
<font color="red">  64.         if settings.FILE_UPLOAD_TEMP_DIR:</font>
<font color="red">  65.             file = tempfile.NamedTemporaryFile(suffix='.upload',</font>
<font color="red">  66.                 dir=settings.FILE_UPLOAD_TEMP_DIR)</font>
<font color="black">  67.         else:</font>
<font color="red">  68.             file = tempfile.NamedTemporaryFile(suffix='.upload')</font>
<font color="red">  69.         super(TemporaryUploadedFile, self).__init__(file, name, content_type, size, charset, content_type_extra)</font>
<font color="black">  70. </font>
<font color="green">  71.     def temporary_file_path(self):</font>
<font color="black">  72.         &quot;&quot;&quot;</font>
<font color="black">  73.         Returns the full path of this file.</font>
<font color="black">  74.         &quot;&quot;&quot;</font>
<font color="red">  75.         return self.file.name</font>
<font color="black">  76. </font>
<font color="green">  77.     def close(self):</font>
<font color="red">  78.         try:</font>
<font color="red">  79.             return self.file.close()</font>
<font color="red">  80.         except OSError as e:</font>
<font color="red">  81.             if e.errno != errno.ENOENT:</font>
<font color="black">  82.                 # Means the file was moved or deleted before the tempfile</font>
<font color="black">  83.                 # could unlink it.  Still sets self.file.close_called and</font>
<font color="black">  84.                 # calls self.file.file.close() before the exception</font>
<font color="red">  85.                 raise</font>
<font color="black">  86. </font>
<font color="black">  87. </font>
<font color="green">  88. class InMemoryUploadedFile(UploadedFile):</font>
<font color="black">  89.     &quot;&quot;&quot;</font>
<font color="black">  90.     A file uploaded into memory (i.e. stream-to-memory).</font>
<font color="green">  91.     &quot;&quot;&quot;</font>
<font color="green">  92.     def __init__(self, file, field_name, name, content_type, size, charset, content_type_extra=None):</font>
<font color="red">  93.         super(InMemoryUploadedFile, self).__init__(file, name, content_type, size, charset, content_type_extra)</font>
<font color="red">  94.         self.field_name = field_name</font>
<font color="black">  95. </font>
<font color="green">  96.     def open(self, mode=None):</font>
<font color="red">  97.         self.file.seek(0)</font>
<font color="black">  98. </font>
<font color="green">  99.     def chunks(self, chunk_size=None):</font>
<font color="red"> 100.         self.file.seek(0)</font>
<font color="red"> 101.         yield self.read()</font>
<font color="black"> 102. </font>
<font color="green"> 103.     def multiple_chunks(self, chunk_size=None):</font>
<font color="black"> 104.         # Since it's in memory, we'll never have multiple chunks.</font>
<font color="red"> 105.         return False</font>
<font color="black"> 106. </font>
<font color="black"> 107. </font>
<font color="green"> 108. class SimpleUploadedFile(InMemoryUploadedFile):</font>
<font color="black"> 109.     &quot;&quot;&quot;</font>
<font color="black"> 110.     A simple representation of a file, which just has content, size, and a name.</font>
<font color="green"> 111.     &quot;&quot;&quot;</font>
<font color="green"> 112.     def __init__(self, name, content, content_type='text/plain'):</font>
<font color="red"> 113.         content = content or b''</font>
<font color="red"> 114.         super(SimpleUploadedFile, self).__init__(BytesIO(content), None, name,</font>
<font color="red"> 115.                                                  content_type, len(content), None, None)</font>
<font color="black"> 116. </font>
<font color="green"> 117.     @classmethod</font>
<font color="black"> 118.     def from_dict(cls, file_dict):</font>
<font color="black"> 119.         &quot;&quot;&quot;</font>
<font color="black"> 120.         Creates a SimpleUploadedFile object from</font>
<font color="black"> 121.         a dictionary object with the following keys:</font>
<font color="black"> 122.            - filename</font>
<font color="black"> 123.            - content-type</font>
<font color="black"> 124.            - content</font>
<font color="black"> 125.         &quot;&quot;&quot;</font>
<font color="red"> 126.         return cls(file_dict['filename'],</font>
<font color="red"> 127.                    file_dict['content'],</font>
<font color="red"> 128.                    file_dict.get('content-type', 'text/plain'))</font>
</pre>


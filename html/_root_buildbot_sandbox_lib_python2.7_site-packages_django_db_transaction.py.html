source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/transaction.py</b><br>


file stats: <b>119 lines, 68 executed: 57.1% covered</b>
<pre>
<font color="green">   1. from django.db import (</font>
<font color="black">   2.     DEFAULT_DB_ALIAS, DatabaseError, Error, ProgrammingError, connections,</font>
<font color="black">   3. )</font>
<font color="green">   4. from django.utils.decorators import ContextDecorator</font>
<font color="black">   5. </font>
<font color="black">   6. </font>
<font color="green">   7. class TransactionManagementError(ProgrammingError):</font>
<font color="black">   8.     &quot;&quot;&quot;</font>
<font color="black">   9.     This exception is thrown when transaction management is used improperly.</font>
<font color="green">  10.     &quot;&quot;&quot;</font>
<font color="green">  11.     pass</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. def get_connection(using=None):</font>
<font color="black">  15.     &quot;&quot;&quot;</font>
<font color="black">  16.     Get a database connection by name, or the default database connection</font>
<font color="black">  17.     if no name is provided. This is a private API.</font>
<font color="black">  18.     &quot;&quot;&quot;</font>
<font color="green">  19.     if using is None:</font>
<font color="red">  20.         using = DEFAULT_DB_ALIAS</font>
<font color="green">  21.     return connections[using]</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. def get_autocommit(using=None):</font>
<font color="black">  25.     &quot;&quot;&quot;</font>
<font color="black">  26.     Get the autocommit status of the connection.</font>
<font color="black">  27.     &quot;&quot;&quot;</font>
<font color="red">  28.     return get_connection(using).get_autocommit()</font>
<font color="black">  29. </font>
<font color="black">  30. </font>
<font color="green">  31. def set_autocommit(autocommit, using=None):</font>
<font color="black">  32.     &quot;&quot;&quot;</font>
<font color="black">  33.     Set the autocommit status of the connection.</font>
<font color="black">  34.     &quot;&quot;&quot;</font>
<font color="red">  35.     return get_connection(using).set_autocommit(autocommit)</font>
<font color="black">  36. </font>
<font color="black">  37. </font>
<font color="green">  38. def commit(using=None):</font>
<font color="black">  39.     &quot;&quot;&quot;</font>
<font color="black">  40.     Commits a transaction.</font>
<font color="black">  41.     &quot;&quot;&quot;</font>
<font color="red">  42.     get_connection(using).commit()</font>
<font color="black">  43. </font>
<font color="black">  44. </font>
<font color="green">  45. def rollback(using=None):</font>
<font color="black">  46.     &quot;&quot;&quot;</font>
<font color="black">  47.     Rolls back a transaction.</font>
<font color="black">  48.     &quot;&quot;&quot;</font>
<font color="red">  49.     get_connection(using).rollback()</font>
<font color="black">  50. </font>
<font color="black">  51. </font>
<font color="green">  52. def savepoint(using=None):</font>
<font color="black">  53.     &quot;&quot;&quot;</font>
<font color="black">  54.     Creates a savepoint (if supported and required by the backend) inside the</font>
<font color="black">  55.     current transaction. Returns an identifier for the savepoint that will be</font>
<font color="black">  56.     used for the subsequent rollback or commit.</font>
<font color="black">  57.     &quot;&quot;&quot;</font>
<font color="red">  58.     return get_connection(using).savepoint()</font>
<font color="black">  59. </font>
<font color="black">  60. </font>
<font color="green">  61. def savepoint_rollback(sid, using=None):</font>
<font color="black">  62.     &quot;&quot;&quot;</font>
<font color="black">  63.     Rolls back the most recent savepoint (if one exists). Does nothing if</font>
<font color="black">  64.     savepoints are not supported.</font>
<font color="black">  65.     &quot;&quot;&quot;</font>
<font color="red">  66.     get_connection(using).savepoint_rollback(sid)</font>
<font color="black">  67. </font>
<font color="black">  68. </font>
<font color="green">  69. def savepoint_commit(sid, using=None):</font>
<font color="black">  70.     &quot;&quot;&quot;</font>
<font color="black">  71.     Commits the most recent savepoint (if one exists). Does nothing if</font>
<font color="black">  72.     savepoints are not supported.</font>
<font color="black">  73.     &quot;&quot;&quot;</font>
<font color="red">  74.     get_connection(using).savepoint_commit(sid)</font>
<font color="black">  75. </font>
<font color="black">  76. </font>
<font color="green">  77. def clean_savepoints(using=None):</font>
<font color="black">  78.     &quot;&quot;&quot;</font>
<font color="black">  79.     Resets the counter used to generate unique savepoint ids in this thread.</font>
<font color="black">  80.     &quot;&quot;&quot;</font>
<font color="red">  81.     get_connection(using).clean_savepoints()</font>
<font color="black">  82. </font>
<font color="black">  83. </font>
<font color="green">  84. def get_rollback(using=None):</font>
<font color="black">  85.     &quot;&quot;&quot;</font>
<font color="black">  86.     Gets the &quot;needs rollback&quot; flag -- for *advanced use* only.</font>
<font color="black">  87.     &quot;&quot;&quot;</font>
<font color="red">  88.     return get_connection(using).get_rollback()</font>
<font color="black">  89. </font>
<font color="black">  90. </font>
<font color="green">  91. def set_rollback(rollback, using=None):</font>
<font color="black">  92.     &quot;&quot;&quot;</font>
<font color="black">  93.     Sets or unsets the &quot;needs rollback&quot; flag -- for *advanced use* only.</font>
<font color="black">  94. </font>
<font color="black">  95.     When `rollback` is `True`, it triggers a rollback when exiting the</font>
<font color="black">  96.     innermost enclosing atomic block that has `savepoint=True` (that's the</font>
<font color="black">  97.     default). Use this to force a rollback without raising an exception.</font>
<font color="black">  98. </font>
<font color="black">  99.     When `rollback` is `False`, it prevents such a rollback. Use this only</font>
<font color="black"> 100.     after rolling back to a known-good state! Otherwise, you break the atomic</font>
<font color="black"> 101.     block and data corruption may occur.</font>
<font color="black"> 102.     &quot;&quot;&quot;</font>
<font color="green"> 103.     return get_connection(using).set_rollback(rollback)</font>
<font color="black"> 104. </font>
<font color="black"> 105. </font>
<font color="green"> 106. def on_commit(func, using=None):</font>
<font color="black"> 107.     &quot;&quot;&quot;</font>
<font color="black"> 108.     Register `func` to be called when the current transaction is committed.</font>
<font color="black"> 109.     If the current transaction is rolled back, `func` will not be called.</font>
<font color="black"> 110.     &quot;&quot;&quot;</font>
<font color="red"> 111.     get_connection(using).on_commit(func)</font>
<font color="black"> 112. </font>
<font color="black"> 113. </font>
<font color="black"> 114. #################################</font>
<font color="black"> 115. # Decorators / context managers #</font>
<font color="black"> 116. #################################</font>
<font color="black"> 117. </font>
<font color="green"> 118. class Atomic(ContextDecorator):</font>
<font color="black"> 119.     &quot;&quot;&quot;</font>
<font color="black"> 120.     This class guarantees the atomic execution of a given block.</font>
<font color="black"> 121. </font>
<font color="black"> 122.     An instance can be used either as a decorator or as a context manager.</font>
<font color="black"> 123. </font>
<font color="black"> 124.     When it's used as a decorator, __call__ wraps the execution of the</font>
<font color="black"> 125.     decorated function in the instance itself, used as a context manager.</font>
<font color="black"> 126. </font>
<font color="black"> 127.     When it's used as a context manager, __enter__ creates a transaction or a</font>
<font color="black"> 128.     savepoint, depending on whether a transaction is already in progress, and</font>
<font color="black"> 129.     __exit__ commits the transaction or releases the savepoint on normal exit,</font>
<font color="black"> 130.     and rolls back the transaction or to the savepoint on exceptions.</font>
<font color="black"> 131. </font>
<font color="black"> 132.     It's possible to disable the creation of savepoints if the goal is to</font>
<font color="black"> 133.     ensure that some code runs within a transaction without creating overhead.</font>
<font color="black"> 134. </font>
<font color="black"> 135.     A stack of savepoints identifiers is maintained as an attribute of the</font>
<font color="black"> 136.     connection. None denotes the absence of a savepoint.</font>
<font color="black"> 137. </font>
<font color="black"> 138.     This allows reentrancy even if the same AtomicWrapper is reused. For</font>
<font color="black"> 139.     example, it's possible to define `oa = @atomic('other')` and use `@oa` or</font>
<font color="black"> 140.     `with oa:` multiple times.</font>
<font color="black"> 141. </font>
<font color="black"> 142.     Since database connections are thread-local, this is thread-safe.</font>
<font color="black"> 143. </font>
<font color="black"> 144.     This is a private API.</font>
<font color="green"> 145.     &quot;&quot;&quot;</font>
<font color="black"> 146. </font>
<font color="green"> 147.     def __init__(self, using, savepoint):</font>
<font color="green"> 148.         self.using = using</font>
<font color="green"> 149.         self.savepoint = savepoint</font>
<font color="black"> 150. </font>
<font color="green"> 151.     def __enter__(self):</font>
<font color="green"> 152.         connection = get_connection(self.using)</font>
<font color="black"> 153. </font>
<font color="green"> 154.         if not connection.in_atomic_block:</font>
<font color="black"> 155.             # Reset state when entering an outermost atomic block.</font>
<font color="green"> 156.             connection.commit_on_exit = True</font>
<font color="green"> 157.             connection.needs_rollback = False</font>
<font color="green"> 158.             if not connection.get_autocommit():</font>
<font color="black"> 159.                 # Some database adapters (namely sqlite3) don't handle</font>
<font color="black"> 160.                 # transactions and savepoints properly when autocommit is off.</font>
<font color="black"> 161.                 # Turning autocommit back on isn't an option; it would trigger</font>
<font color="black"> 162.                 # a premature commit. Give up if that happens.</font>
<font color="red"> 163.                 if connection.features.autocommits_when_autocommit_is_off:</font>
<font color="red"> 164.                     raise TransactionManagementError(</font>
<font color="red"> 165.                         &quot;Your database backend doesn't behave properly when &quot;</font>
<font color="black"> 166.                         &quot;autocommit is off. Turn it on before using 'atomic'.&quot;)</font>
<font color="black"> 167.                 # Pretend we're already in an atomic block to bypass the code</font>
<font color="black"> 168.                 # that disables autocommit to enter a transaction, and make a</font>
<font color="black"> 169.                 # note to deal with this case in __exit__.</font>
<font color="red"> 170.                 connection.in_atomic_block = True</font>
<font color="red"> 171.                 connection.commit_on_exit = False</font>
<font color="black"> 172. </font>
<font color="green"> 173.         if connection.in_atomic_block:</font>
<font color="black"> 174.             # We're already in a transaction; create a savepoint, unless we</font>
<font color="black"> 175.             # were told not to or we're already waiting for a rollback. The</font>
<font color="black"> 176.             # second condition avoids creating useless savepoints and prevents</font>
<font color="black"> 177.             # overwriting needs_rollback until the rollback is performed.</font>
<font color="green"> 178.             if self.savepoint and not connection.needs_rollback:</font>
<font color="green"> 179.                 sid = connection.savepoint()</font>
<font color="green"> 180.                 connection.savepoint_ids.append(sid)</font>
<font color="black"> 181.             else:</font>
<font color="green"> 182.                 connection.savepoint_ids.append(None)</font>
<font color="black"> 183.         else:</font>
<font color="green"> 184.             connection.set_autocommit(False, force_begin_transaction_with_broken_autocommit=True)</font>
<font color="green"> 185.             connection.in_atomic_block = True</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def __exit__(self, exc_type, exc_value, traceback):</font>
<font color="green"> 188.         connection = get_connection(self.using)</font>
<font color="black"> 189. </font>
<font color="green"> 190.         if connection.savepoint_ids:</font>
<font color="green"> 191.             sid = connection.savepoint_ids.pop()</font>
<font color="black"> 192.         else:</font>
<font color="black"> 193.             # Prematurely unset this flag to allow using commit or rollback.</font>
<font color="green"> 194.             connection.in_atomic_block = False</font>
<font color="black"> 195. </font>
<font color="green"> 196.         try:</font>
<font color="green"> 197.             if connection.closed_in_transaction:</font>
<font color="black"> 198.                 # The database will perform a rollback by itself.</font>
<font color="black"> 199.                 # Wait until we exit the outermost block.</font>
<font color="red"> 200.                 pass</font>
<font color="black"> 201. </font>
<font color="green"> 202.             elif exc_type is None and not connection.needs_rollback:</font>
<font color="green"> 203.                 if connection.in_atomic_block:</font>
<font color="black"> 204.                     # Release savepoint if there is one</font>
<font color="green"> 205.                     if sid is not None:</font>
<font color="red"> 206.                         try:</font>
<font color="red"> 207.                             connection.savepoint_commit(sid)</font>
<font color="red"> 208.                         except DatabaseError:</font>
<font color="red"> 209.                             try:</font>
<font color="red"> 210.                                 connection.savepoint_rollback(sid)</font>
<font color="black"> 211.                                 # The savepoint won't be reused. Release it to</font>
<font color="black"> 212.                                 # minimize overhead for the database server.</font>
<font color="red"> 213.                                 connection.savepoint_commit(sid)</font>
<font color="red"> 214.                             except Error:</font>
<font color="black"> 215.                                 # If rolling back to a savepoint fails, mark for</font>
<font color="black"> 216.                                 # rollback at a higher level and avoid shadowing</font>
<font color="black"> 217.                                 # the original exception.</font>
<font color="red"> 218.                                 connection.needs_rollback = True</font>
<font color="red"> 219.                             raise</font>
<font color="black"> 220.                 else:</font>
<font color="black"> 221.                     # Commit transaction</font>
<font color="green"> 222.                     try:</font>
<font color="green"> 223.                         connection.commit()</font>
<font color="red"> 224.                     except DatabaseError:</font>
<font color="red"> 225.                         try:</font>
<font color="red"> 226.                             connection.rollback()</font>
<font color="red"> 227.                         except Error:</font>
<font color="black"> 228.                             # An error during rollback means that something</font>
<font color="black"> 229.                             # went wrong with the connection. Drop it.</font>
<font color="red"> 230.                             connection.close()</font>
<font color="red"> 231.                         raise</font>
<font color="black"> 232.             else:</font>
<font color="black"> 233.                 # This flag will be set to True again if there isn't a savepoint</font>
<font color="black"> 234.                 # allowing to perform the rollback at this level.</font>
<font color="green"> 235.                 connection.needs_rollback = False</font>
<font color="green"> 236.                 if connection.in_atomic_block:</font>
<font color="black"> 237.                     # Roll back to savepoint if there is one, mark for rollback</font>
<font color="black"> 238.                     # otherwise.</font>
<font color="green"> 239.                     if sid is None:</font>
<font color="red"> 240.                         connection.needs_rollback = True</font>
<font color="black"> 241.                     else:</font>
<font color="green"> 242.                         try:</font>
<font color="green"> 243.                             connection.savepoint_rollback(sid)</font>
<font color="black"> 244.                             # The savepoint won't be reused. Release it to</font>
<font color="black"> 245.                             # minimize overhead for the database server.</font>
<font color="green"> 246.                             connection.savepoint_commit(sid)</font>
<font color="red"> 247.                         except Error:</font>
<font color="black"> 248.                             # If rolling back to a savepoint fails, mark for</font>
<font color="black"> 249.                             # rollback at a higher level and avoid shadowing</font>
<font color="black"> 250.                             # the original exception.</font>
<font color="red"> 251.                             connection.needs_rollback = True</font>
<font color="black"> 252.                 else:</font>
<font color="black"> 253.                     # Roll back transaction</font>
<font color="green"> 254.                     try:</font>
<font color="green"> 255.                         connection.rollback()</font>
<font color="red"> 256.                     except Error:</font>
<font color="black"> 257.                         # An error during rollback means that something</font>
<font color="black"> 258.                         # went wrong with the connection. Drop it.</font>
<font color="red"> 259.                         connection.close()</font>
<font color="black"> 260. </font>
<font color="black"> 261.         finally:</font>
<font color="black"> 262.             # Outermost block exit when autocommit was enabled.</font>
<font color="green"> 263.             if not connection.in_atomic_block:</font>
<font color="green"> 264.                 if connection.closed_in_transaction:</font>
<font color="red"> 265.                     connection.connection = None</font>
<font color="black"> 266.                 else:</font>
<font color="green"> 267.                     connection.set_autocommit(True)</font>
<font color="black"> 268.             # Outermost block exit when autocommit was disabled.</font>
<font color="green"> 269.             elif not connection.savepoint_ids and not connection.commit_on_exit:</font>
<font color="red"> 270.                 if connection.closed_in_transaction:</font>
<font color="red"> 271.                     connection.connection = None</font>
<font color="black"> 272.                 else:</font>
<font color="red"> 273.                     connection.in_atomic_block = False</font>
<font color="black"> 274. </font>
<font color="black"> 275. </font>
<font color="green"> 276. def atomic(using=None, savepoint=True):</font>
<font color="black"> 277.     # Bare decorator: @atomic -- although the first argument is called</font>
<font color="black"> 278.     # `using`, it's actually the function being decorated.</font>
<font color="green"> 279.     if callable(using):</font>
<font color="green"> 280.         return Atomic(DEFAULT_DB_ALIAS, savepoint)(using)</font>
<font color="black"> 281.     # Decorator: @atomic(...) or context manager: with atomic(...): ...</font>
<font color="black"> 282.     else:</font>
<font color="green"> 283.         return Atomic(using, savepoint)</font>
<font color="black"> 284. </font>
<font color="black"> 285. </font>
<font color="green"> 286. def _non_atomic_requests(view, using):</font>
<font color="red"> 287.     try:</font>
<font color="red"> 288.         view._non_atomic_requests.add(using)</font>
<font color="red"> 289.     except AttributeError:</font>
<font color="red"> 290.         view._non_atomic_requests = {using}</font>
<font color="red"> 291.     return view</font>
<font color="black"> 292. </font>
<font color="black"> 293. </font>
<font color="green"> 294. def non_atomic_requests(using=None):</font>
<font color="red"> 295.     if callable(using):</font>
<font color="red"> 296.         return _non_atomic_requests(using, DEFAULT_DB_ALIAS)</font>
<font color="black"> 297.     else:</font>
<font color="red"> 298.         if using is None:</font>
<font color="red"> 299.             using = DEFAULT_DB_ALIAS</font>
<font color="red"> 300.         return lambda view: _non_atomic_requests(view, using)</font>
</pre>


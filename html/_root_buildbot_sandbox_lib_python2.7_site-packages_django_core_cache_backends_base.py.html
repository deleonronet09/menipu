source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/cache/backends/base.py</b><br>


file stats: <b>124 lines, 52 executed: 41.9% covered</b>
<pre>
<font color="green">   1. &quot;Base Cache class.&quot;</font>
<font color="green">   2. from __future__ import unicode_literals</font>
<font color="black">   3. </font>
<font color="green">   4. import time</font>
<font color="green">   5. import warnings</font>
<font color="black">   6. </font>
<font color="green">   7. from django.core.exceptions import DjangoRuntimeWarning, ImproperlyConfigured</font>
<font color="green">   8. from django.utils.module_loading import import_string</font>
<font color="black">   9. </font>
<font color="black">  10. </font>
<font color="green">  11. class InvalidCacheBackendError(ImproperlyConfigured):</font>
<font color="green">  12.     pass</font>
<font color="black">  13. </font>
<font color="black">  14. </font>
<font color="green">  15. class CacheKeyWarning(DjangoRuntimeWarning):</font>
<font color="green">  16.     pass</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="black">  19. # Stub class to ensure not passing in a `timeout` argument results in</font>
<font color="black">  20. # the default timeout</font>
<font color="green">  21. DEFAULT_TIMEOUT = object()</font>
<font color="black">  22. </font>
<font color="black">  23. # Memcached does not accept keys longer than this.</font>
<font color="green">  24. MEMCACHE_MAX_KEY_LENGTH = 250</font>
<font color="black">  25. </font>
<font color="black">  26. </font>
<font color="green">  27. def default_key_func(key, key_prefix, version):</font>
<font color="black">  28.     &quot;&quot;&quot;</font>
<font color="black">  29.     Default function to generate keys.</font>
<font color="black">  30. </font>
<font color="black">  31.     Constructs the key used by all other methods. By default it prepends</font>
<font color="black">  32.     the `key_prefix'. KEY_FUNCTION can be used to specify an alternate</font>
<font color="black">  33.     function with custom key making behavior.</font>
<font color="black">  34.     &quot;&quot;&quot;</font>
<font color="red">  35.     return '%s:%s:%s' % (key_prefix, version, key)</font>
<font color="black">  36. </font>
<font color="black">  37. </font>
<font color="green">  38. def get_key_func(key_func):</font>
<font color="black">  39.     &quot;&quot;&quot;</font>
<font color="black">  40.     Function to decide which key function to use.</font>
<font color="black">  41. </font>
<font color="black">  42.     Defaults to ``default_key_func``.</font>
<font color="black">  43.     &quot;&quot;&quot;</font>
<font color="green">  44.     if key_func is not None:</font>
<font color="red">  45.         if callable(key_func):</font>
<font color="red">  46.             return key_func</font>
<font color="black">  47.         else:</font>
<font color="red">  48.             return import_string(key_func)</font>
<font color="green">  49.     return default_key_func</font>
<font color="black">  50. </font>
<font color="black">  51. </font>
<font color="green">  52. class BaseCache(object):</font>
<font color="green">  53.     def __init__(self, params):</font>
<font color="green">  54.         timeout = params.get('timeout', params.get('TIMEOUT', 300))</font>
<font color="green">  55.         if timeout is not None:</font>
<font color="green">  56.             try:</font>
<font color="green">  57.                 timeout = int(timeout)</font>
<font color="red">  58.             except (ValueError, TypeError):</font>
<font color="red">  59.                 timeout = 300</font>
<font color="green">  60.         self.default_timeout = timeout</font>
<font color="black">  61. </font>
<font color="green">  62.         options = params.get('OPTIONS', {})</font>
<font color="green">  63.         max_entries = params.get('max_entries', options.get('MAX_ENTRIES', 300))</font>
<font color="green">  64.         try:</font>
<font color="green">  65.             self._max_entries = int(max_entries)</font>
<font color="red">  66.         except (ValueError, TypeError):</font>
<font color="red">  67.             self._max_entries = 300</font>
<font color="black">  68. </font>
<font color="green">  69.         cull_frequency = params.get('cull_frequency', options.get('CULL_FREQUENCY', 3))</font>
<font color="green">  70.         try:</font>
<font color="green">  71.             self._cull_frequency = int(cull_frequency)</font>
<font color="red">  72.         except (ValueError, TypeError):</font>
<font color="red">  73.             self._cull_frequency = 3</font>
<font color="black">  74. </font>
<font color="green">  75.         self.key_prefix = params.get('KEY_PREFIX', '')</font>
<font color="green">  76.         self.version = params.get('VERSION', 1)</font>
<font color="green">  77.         self.key_func = get_key_func(params.get('KEY_FUNCTION'))</font>
<font color="black">  78. </font>
<font color="green">  79.     def get_backend_timeout(self, timeout=DEFAULT_TIMEOUT):</font>
<font color="black">  80.         &quot;&quot;&quot;</font>
<font color="black">  81.         Returns the timeout value usable by this backend based upon the provided</font>
<font color="black">  82.         timeout.</font>
<font color="black">  83.         &quot;&quot;&quot;</font>
<font color="red">  84.         if timeout == DEFAULT_TIMEOUT:</font>
<font color="red">  85.             timeout = self.default_timeout</font>
<font color="red">  86.         elif timeout == 0:</font>
<font color="black">  87.             # ticket 21147 - avoid time.time() related precision issues</font>
<font color="red">  88.             timeout = -1</font>
<font color="red">  89.         return None if timeout is None else time.time() + timeout</font>
<font color="black">  90. </font>
<font color="green">  91.     def make_key(self, key, version=None):</font>
<font color="black">  92.         &quot;&quot;&quot;Constructs the key used by all other methods. By default it</font>
<font color="black">  93.         uses the key_func to generate a key (which, by default,</font>
<font color="black">  94.         prepends the `key_prefix' and 'version'). A different key</font>
<font color="black">  95.         function can be provided at the time of cache construction;</font>
<font color="black">  96.         alternatively, you can subclass the cache backend to provide</font>
<font color="black">  97.         custom key making behavior.</font>
<font color="black">  98.         &quot;&quot;&quot;</font>
<font color="red">  99.         if version is None:</font>
<font color="red"> 100.             version = self.version</font>
<font color="black"> 101. </font>
<font color="red"> 102.         new_key = self.key_func(key, self.key_prefix, version)</font>
<font color="red"> 103.         return new_key</font>
<font color="black"> 104. </font>
<font color="green"> 105.     def add(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="black"> 106.         &quot;&quot;&quot;</font>
<font color="black"> 107.         Set a value in the cache if the key does not already exist. If</font>
<font color="black"> 108.         timeout is given, that timeout will be used for the key; otherwise</font>
<font color="black"> 109.         the default cache timeout will be used.</font>
<font color="black"> 110. </font>
<font color="black"> 111.         Returns True if the value was stored, False otherwise.</font>
<font color="black"> 112.         &quot;&quot;&quot;</font>
<font color="red"> 113.         raise NotImplementedError('subclasses of BaseCache must provide an add() method')</font>
<font color="black"> 114. </font>
<font color="green"> 115.     def get(self, key, default=None, version=None):</font>
<font color="black"> 116.         &quot;&quot;&quot;</font>
<font color="black"> 117.         Fetch a given key from the cache. If the key does not exist, return</font>
<font color="black"> 118.         default, which itself defaults to None.</font>
<font color="black"> 119.         &quot;&quot;&quot;</font>
<font color="red"> 120.         raise NotImplementedError('subclasses of BaseCache must provide a get() method')</font>
<font color="black"> 121. </font>
<font color="green"> 122.     def set(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="black"> 123.         &quot;&quot;&quot;</font>
<font color="black"> 124.         Set a value in the cache. If timeout is given, that timeout will be</font>
<font color="black"> 125.         used for the key; otherwise the default cache timeout will be used.</font>
<font color="black"> 126.         &quot;&quot;&quot;</font>
<font color="red"> 127.         raise NotImplementedError('subclasses of BaseCache must provide a set() method')</font>
<font color="black"> 128. </font>
<font color="green"> 129.     def delete(self, key, version=None):</font>
<font color="black"> 130.         &quot;&quot;&quot;</font>
<font color="black"> 131.         Delete a key from the cache, failing silently.</font>
<font color="black"> 132.         &quot;&quot;&quot;</font>
<font color="red"> 133.         raise NotImplementedError('subclasses of BaseCache must provide a delete() method')</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def get_many(self, keys, version=None):</font>
<font color="black"> 136.         &quot;&quot;&quot;</font>
<font color="black"> 137.         Fetch a bunch of keys from the cache. For certain backends (memcached,</font>
<font color="black"> 138.         pgsql) this can be *much* faster when fetching multiple values.</font>
<font color="black"> 139. </font>
<font color="black"> 140.         Returns a dict mapping each key in keys to its value. If the given</font>
<font color="black"> 141.         key is missing, it will be missing from the response dict.</font>
<font color="black"> 142.         &quot;&quot;&quot;</font>
<font color="red"> 143.         d = {}</font>
<font color="red"> 144.         for k in keys:</font>
<font color="red"> 145.             val = self.get(k, version=version)</font>
<font color="red"> 146.             if val is not None:</font>
<font color="red"> 147.                 d[k] = val</font>
<font color="red"> 148.         return d</font>
<font color="black"> 149. </font>
<font color="green"> 150.     def get_or_set(self, key, default=None, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="black"> 151.         &quot;&quot;&quot;</font>
<font color="black"> 152.         Fetch a given key from the cache. If the key does not exist,</font>
<font color="black"> 153.         the key is added and set to the default value. The default value can</font>
<font color="black"> 154.         also be any callable. If timeout is given, that timeout will be used</font>
<font color="black"> 155.         for the key; otherwise the default cache timeout will be used.</font>
<font color="black"> 156. </font>
<font color="black"> 157.         Returns the value of the key stored or retrieved on success,</font>
<font color="black"> 158.         False on error.</font>
<font color="black"> 159.         &quot;&quot;&quot;</font>
<font color="red"> 160.         if default is None:</font>
<font color="red"> 161.             raise ValueError('You need to specify a value.')</font>
<font color="red"> 162.         val = self.get(key, version=version)</font>
<font color="red"> 163.         if val is None:</font>
<font color="red"> 164.             if callable(default):</font>
<font color="red"> 165.                 default = default()</font>
<font color="red"> 166.             val = self.add(key, default, timeout=timeout, version=version)</font>
<font color="red"> 167.             if val:</font>
<font color="red"> 168.                 return self.get(key, version=version)</font>
<font color="red"> 169.         return val</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def has_key(self, key, version=None):</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="black"> 173.         Returns True if the key is in the cache and has not expired.</font>
<font color="black"> 174.         &quot;&quot;&quot;</font>
<font color="red"> 175.         return self.get(key, version=version) is not None</font>
<font color="black"> 176. </font>
<font color="green"> 177.     def incr(self, key, delta=1, version=None):</font>
<font color="black"> 178.         &quot;&quot;&quot;</font>
<font color="black"> 179.         Add delta to value in the cache. If the key does not exist, raise a</font>
<font color="black"> 180.         ValueError exception.</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="red"> 182.         value = self.get(key, version=version)</font>
<font color="red"> 183.         if value is None:</font>
<font color="red"> 184.             raise ValueError(&quot;Key '%s' not found&quot; % key)</font>
<font color="red"> 185.         new_value = value + delta</font>
<font color="red"> 186.         self.set(key, new_value, version=version)</font>
<font color="red"> 187.         return new_value</font>
<font color="black"> 188. </font>
<font color="green"> 189.     def decr(self, key, delta=1, version=None):</font>
<font color="black"> 190.         &quot;&quot;&quot;</font>
<font color="black"> 191.         Subtract delta from value in the cache. If the key does not exist, raise</font>
<font color="black"> 192.         a ValueError exception.</font>
<font color="black"> 193.         &quot;&quot;&quot;</font>
<font color="red"> 194.         return self.incr(key, -delta, version=version)</font>
<font color="black"> 195. </font>
<font color="green"> 196.     def __contains__(self, key):</font>
<font color="black"> 197.         &quot;&quot;&quot;</font>
<font color="black"> 198.         Returns True if the key is in the cache and has not expired.</font>
<font color="black"> 199.         &quot;&quot;&quot;</font>
<font color="black"> 200.         # This is a separate method, rather than just a copy of has_key(),</font>
<font color="black"> 201.         # so that it always has the same functionality as has_key(), even</font>
<font color="black"> 202.         # if a subclass overrides it.</font>
<font color="red"> 203.         return self.has_key(key)</font>
<font color="black"> 204. </font>
<font color="green"> 205.     def set_many(self, data, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="black"> 206.         &quot;&quot;&quot;</font>
<font color="black"> 207.         Set a bunch of values in the cache at once from a dict of key/value</font>
<font color="black"> 208.         pairs.  For certain backends (memcached), this is much more efficient</font>
<font color="black"> 209.         than calling set() multiple times.</font>
<font color="black"> 210. </font>
<font color="black"> 211.         If timeout is given, that timeout will be used for the key; otherwise</font>
<font color="black"> 212.         the default cache timeout will be used.</font>
<font color="black"> 213.         &quot;&quot;&quot;</font>
<font color="red"> 214.         for key, value in data.items():</font>
<font color="red"> 215.             self.set(key, value, timeout=timeout, version=version)</font>
<font color="black"> 216. </font>
<font color="green"> 217.     def delete_many(self, keys, version=None):</font>
<font color="black"> 218.         &quot;&quot;&quot;</font>
<font color="black"> 219.         Set a bunch of values in the cache at once.  For certain backends</font>
<font color="black"> 220.         (memcached), this is much more efficient than calling delete() multiple</font>
<font color="black"> 221.         times.</font>
<font color="black"> 222.         &quot;&quot;&quot;</font>
<font color="red"> 223.         for key in keys:</font>
<font color="red"> 224.             self.delete(key, version=version)</font>
<font color="black"> 225. </font>
<font color="green"> 226.     def clear(self):</font>
<font color="black"> 227.         &quot;&quot;&quot;Remove *all* values from the cache at once.&quot;&quot;&quot;</font>
<font color="red"> 228.         raise NotImplementedError('subclasses of BaseCache must provide a clear() method')</font>
<font color="black"> 229. </font>
<font color="green"> 230.     def validate_key(self, key):</font>
<font color="black"> 231.         &quot;&quot;&quot;</font>
<font color="black"> 232.         Warn about keys that would not be portable to the memcached</font>
<font color="black"> 233.         backend. This encourages (but does not force) writing backend-portable</font>
<font color="black"> 234.         cache code.</font>
<font color="black"> 235.         &quot;&quot;&quot;</font>
<font color="red"> 236.         if len(key) &gt; MEMCACHE_MAX_KEY_LENGTH:</font>
<font color="red"> 237.             warnings.warn('Cache key will cause errors if used with memcached: '</font>
<font color="red"> 238.                     '%s (longer than %s)' % (key, MEMCACHE_MAX_KEY_LENGTH),</font>
<font color="red"> 239.                     CacheKeyWarning)</font>
<font color="red"> 240.         for char in key:</font>
<font color="red"> 241.             if ord(char) &lt; 33 or ord(char) == 127:</font>
<font color="red"> 242.                 warnings.warn('Cache key contains characters that will cause '</font>
<font color="red"> 243.                         'errors if used with memcached: %r' % key,</font>
<font color="red"> 244.                               CacheKeyWarning)</font>
<font color="black"> 245. </font>
<font color="green"> 246.     def incr_version(self, key, delta=1, version=None):</font>
<font color="black"> 247.         &quot;&quot;&quot;Adds delta to the cache version for the supplied key. Returns the</font>
<font color="black"> 248.         new version.</font>
<font color="black"> 249.         &quot;&quot;&quot;</font>
<font color="red"> 250.         if version is None:</font>
<font color="red"> 251.             version = self.version</font>
<font color="black"> 252. </font>
<font color="red"> 253.         value = self.get(key, version=version)</font>
<font color="red"> 254.         if value is None:</font>
<font color="red"> 255.             raise ValueError(&quot;Key '%s' not found&quot; % key)</font>
<font color="black"> 256. </font>
<font color="red"> 257.         self.set(key, value, version=version + delta)</font>
<font color="red"> 258.         self.delete(key, version=version)</font>
<font color="red"> 259.         return version + delta</font>
<font color="black"> 260. </font>
<font color="green"> 261.     def decr_version(self, key, delta=1, version=None):</font>
<font color="black"> 262.         &quot;&quot;&quot;Subtracts delta from the cache version for the supplied key. Returns</font>
<font color="black"> 263.         the new version.</font>
<font color="black"> 264.         &quot;&quot;&quot;</font>
<font color="red"> 265.         return self.incr_version(key, -delta, version)</font>
<font color="black"> 266. </font>
<font color="green"> 267.     def close(self, **kwargs):</font>
<font color="black"> 268.         &quot;&quot;&quot;Close the cache connection&quot;&quot;&quot;</font>
<font color="red"> 269.         pass</font>
</pre>


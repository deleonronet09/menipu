source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/synch.py</b><br>


file stats: <b>58 lines, 19 executed: 32.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Synchronization primitives:</font>
<font color="black">   3. </font>
<font color="black">   4.     - reader-writer lock (preference to writers)</font>
<font color="black">   5. </font>
<font color="black">   6. (Contributed to Django by eugene@lazutkin.com)</font>
<font color="green">   7. &quot;&quot;&quot;</font>
<font color="black">   8. </font>
<font color="green">   9. import contextlib</font>
<font color="green">  10. import threading</font>
<font color="black">  11. </font>
<font color="black">  12. </font>
<font color="green">  13. class RWLock(object):</font>
<font color="black">  14.     &quot;&quot;&quot;</font>
<font color="black">  15.     Classic implementation of reader-writer lock with preference to writers.</font>
<font color="black">  16. </font>
<font color="black">  17.     Readers can access a resource simultaneously.</font>
<font color="black">  18.     Writers get an exclusive access.</font>
<font color="black">  19. </font>
<font color="black">  20.     API is self-descriptive:</font>
<font color="black">  21.         reader_enters()</font>
<font color="black">  22.         reader_leaves()</font>
<font color="black">  23.         writer_enters()</font>
<font color="black">  24.         writer_leaves()</font>
<font color="green">  25.     &quot;&quot;&quot;</font>
<font color="green">  26.     def __init__(self):</font>
<font color="green">  27.         self.mutex = threading.RLock()</font>
<font color="green">  28.         self.can_read = threading.Semaphore(0)</font>
<font color="green">  29.         self.can_write = threading.Semaphore(0)</font>
<font color="green">  30.         self.active_readers = 0</font>
<font color="green">  31.         self.active_writers = 0</font>
<font color="green">  32.         self.waiting_readers = 0</font>
<font color="green">  33.         self.waiting_writers = 0</font>
<font color="black">  34. </font>
<font color="green">  35.     def reader_enters(self):</font>
<font color="red">  36.         with self.mutex:</font>
<font color="red">  37.             if self.active_writers == 0 and self.waiting_writers == 0:</font>
<font color="red">  38.                 self.active_readers += 1</font>
<font color="red">  39.                 self.can_read.release()</font>
<font color="black">  40.             else:</font>
<font color="red">  41.                 self.waiting_readers += 1</font>
<font color="red">  42.         self.can_read.acquire()</font>
<font color="black">  43. </font>
<font color="green">  44.     def reader_leaves(self):</font>
<font color="red">  45.         with self.mutex:</font>
<font color="red">  46.             self.active_readers -= 1</font>
<font color="red">  47.             if self.active_readers == 0 and self.waiting_writers != 0:</font>
<font color="red">  48.                 self.active_writers += 1</font>
<font color="red">  49.                 self.waiting_writers -= 1</font>
<font color="red">  50.                 self.can_write.release()</font>
<font color="black">  51. </font>
<font color="green">  52.     @contextlib.contextmanager</font>
<font color="black">  53.     def reader(self):</font>
<font color="red">  54.         self.reader_enters()</font>
<font color="red">  55.         try:</font>
<font color="red">  56.             yield</font>
<font color="black">  57.         finally:</font>
<font color="red">  58.             self.reader_leaves()</font>
<font color="black">  59. </font>
<font color="green">  60.     def writer_enters(self):</font>
<font color="red">  61.         with self.mutex:</font>
<font color="red">  62.             if self.active_writers == 0 and self.waiting_writers == 0 and self.active_readers == 0:</font>
<font color="red">  63.                 self.active_writers += 1</font>
<font color="red">  64.                 self.can_write.release()</font>
<font color="black">  65.             else:</font>
<font color="red">  66.                 self.waiting_writers += 1</font>
<font color="red">  67.         self.can_write.acquire()</font>
<font color="black">  68. </font>
<font color="green">  69.     def writer_leaves(self):</font>
<font color="red">  70.         with self.mutex:</font>
<font color="red">  71.             self.active_writers -= 1</font>
<font color="red">  72.             if self.waiting_writers != 0:</font>
<font color="red">  73.                 self.active_writers += 1</font>
<font color="red">  74.                 self.waiting_writers -= 1</font>
<font color="red">  75.                 self.can_write.release()</font>
<font color="red">  76.             elif self.waiting_readers != 0:</font>
<font color="red">  77.                 t = self.waiting_readers</font>
<font color="red">  78.                 self.waiting_readers = 0</font>
<font color="red">  79.                 self.active_readers += t</font>
<font color="red">  80.                 while t &gt; 0:</font>
<font color="red">  81.                     self.can_read.release()</font>
<font color="red">  82.                     t -= 1</font>
<font color="black">  83. </font>
<font color="green">  84.     @contextlib.contextmanager</font>
<font color="black">  85.     def writer(self):</font>
<font color="red">  86.         self.writer_enters()</font>
<font color="red">  87.         try:</font>
<font color="red">  88.             yield</font>
<font color="black">  89.         finally:</font>
<font color="red">  90.             self.writer_leaves()</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/admin.py</b><br>


file stats: <b>145 lines, 58 executed: 40.0% covered</b>
<pre>
<font color="green">   1. from django.conf import settings</font>
<font color="green">   2. from django.conf.urls import url</font>
<font color="green">   3. from django.contrib import admin, messages</font>
<font color="green">   4. from django.contrib.admin.options import IS_POPUP_VAR</font>
<font color="green">   5. from django.contrib.admin.utils import unquote</font>
<font color="green">   6. from django.contrib.auth import update_session_auth_hash</font>
<font color="green">   7. from django.contrib.auth.forms import (</font>
<font color="black">   8.     AdminPasswordChangeForm, UserChangeForm, UserCreationForm,</font>
<font color="black">   9. )</font>
<font color="green">  10. from django.contrib.auth.models import Group, User</font>
<font color="green">  11. from django.core.exceptions import PermissionDenied</font>
<font color="green">  12. from django.core.urlresolvers import reverse</font>
<font color="green">  13. from django.db import transaction</font>
<font color="green">  14. from django.http import Http404, HttpResponseRedirect</font>
<font color="green">  15. from django.template.response import TemplateResponse</font>
<font color="green">  16. from django.utils.decorators import method_decorator</font>
<font color="green">  17. from django.utils.encoding import force_text</font>
<font color="green">  18. from django.utils.html import escape</font>
<font color="green">  19. from django.utils.translation import ugettext, ugettext_lazy as _</font>
<font color="green">  20. from django.views.decorators.csrf import csrf_protect</font>
<font color="green">  21. from django.views.decorators.debug import sensitive_post_parameters</font>
<font color="black">  22. </font>
<font color="green">  23. csrf_protect_m = method_decorator(csrf_protect)</font>
<font color="green">  24. sensitive_post_parameters_m = method_decorator(sensitive_post_parameters())</font>
<font color="black">  25. </font>
<font color="black">  26. </font>
<font color="green">  27. @admin.register(Group)</font>
<font color="green">  28. class GroupAdmin(admin.ModelAdmin):</font>
<font color="green">  29.     search_fields = ('name',)</font>
<font color="green">  30.     ordering = ('name',)</font>
<font color="green">  31.     filter_horizontal = ('permissions',)</font>
<font color="black">  32. </font>
<font color="green">  33.     def formfield_for_manytomany(self, db_field, request=None, **kwargs):</font>
<font color="red">  34.         if db_field.name == 'permissions':</font>
<font color="red">  35.             qs = kwargs.get('queryset', db_field.remote_field.model.objects)</font>
<font color="black">  36.             # Avoid a major performance hit resolving permission names which</font>
<font color="black">  37.             # triggers a content_type load:</font>
<font color="red">  38.             kwargs['queryset'] = qs.select_related('content_type')</font>
<font color="red">  39.         return super(GroupAdmin, self).formfield_for_manytomany(</font>
<font color="red">  40.             db_field, request=request, **kwargs)</font>
<font color="black">  41. </font>
<font color="black">  42. </font>
<font color="green">  43. @admin.register(User)</font>
<font color="green">  44. class UserAdmin(admin.ModelAdmin):</font>
<font color="green">  45.     add_form_template = 'admin/auth/user/add_form.html'</font>
<font color="green">  46.     change_user_password_template = None</font>
<font color="black">  47.     fieldsets = (</font>
<font color="green">  48.         (None, {'fields': ('username', 'password')}),</font>
<font color="green">  49.         (_('Personal info'), {'fields': ('first_name', 'last_name', 'email')}),</font>
<font color="green">  50.         (_('Permissions'), {'fields': ('is_active', 'is_staff', 'is_superuser',</font>
<font color="green">  51.                                        'groups', 'user_permissions')}),</font>
<font color="green">  52.         (_('Important dates'), {'fields': ('last_login', 'date_joined')}),</font>
<font color="black">  53.     )</font>
<font color="black">  54.     add_fieldsets = (</font>
<font color="green">  55.         (None, {</font>
<font color="green">  56.             'classes': ('wide',),</font>
<font color="green">  57.             'fields': ('username', 'password1', 'password2'),</font>
<font color="black">  58.         }),</font>
<font color="black">  59.     )</font>
<font color="green">  60.     form = UserChangeForm</font>
<font color="green">  61.     add_form = UserCreationForm</font>
<font color="green">  62.     change_password_form = AdminPasswordChangeForm</font>
<font color="green">  63.     list_display = ('username', 'email', 'first_name', 'last_name', 'is_staff')</font>
<font color="green">  64.     list_filter = ('is_staff', 'is_superuser', 'is_active', 'groups')</font>
<font color="green">  65.     search_fields = ('username', 'first_name', 'last_name', 'email')</font>
<font color="green">  66.     ordering = ('username',)</font>
<font color="green">  67.     filter_horizontal = ('groups', 'user_permissions',)</font>
<font color="black">  68. </font>
<font color="green">  69.     def get_fieldsets(self, request, obj=None):</font>
<font color="red">  70.         if not obj:</font>
<font color="red">  71.             return self.add_fieldsets</font>
<font color="red">  72.         return super(UserAdmin, self).get_fieldsets(request, obj)</font>
<font color="black">  73. </font>
<font color="green">  74.     def get_form(self, request, obj=None, **kwargs):</font>
<font color="black">  75.         &quot;&quot;&quot;</font>
<font color="black">  76.         Use special form during user creation</font>
<font color="black">  77.         &quot;&quot;&quot;</font>
<font color="red">  78.         defaults = {}</font>
<font color="red">  79.         if obj is None:</font>
<font color="red">  80.             defaults['form'] = self.add_form</font>
<font color="red">  81.         defaults.update(kwargs)</font>
<font color="red">  82.         return super(UserAdmin, self).get_form(request, obj, **defaults)</font>
<font color="black">  83. </font>
<font color="green">  84.     def get_urls(self):</font>
<font color="black">  85.         return [</font>
<font color="red">  86.             url(</font>
<font color="red">  87.                 r'^(.+)/password/$',</font>
<font color="red">  88.                 self.admin_site.admin_view(self.user_change_password),</font>
<font color="red">  89.                 name='auth_user_password_change',</font>
<font color="black">  90.             ),</font>
<font color="red">  91.         ] + super(UserAdmin, self).get_urls()</font>
<font color="black">  92. </font>
<font color="green">  93.     def lookup_allowed(self, lookup, value):</font>
<font color="black">  94.         # See #20078: we don't want to allow any lookups involving passwords.</font>
<font color="red">  95.         if lookup.startswith('password'):</font>
<font color="red">  96.             return False</font>
<font color="red">  97.         return super(UserAdmin, self).lookup_allowed(lookup, value)</font>
<font color="black">  98. </font>
<font color="green">  99.     @sensitive_post_parameters_m</font>
<font color="green"> 100.     @csrf_protect_m</font>
<font color="green"> 101.     @transaction.atomic</font>
<font color="green"> 102.     def add_view(self, request, form_url='', extra_context=None):</font>
<font color="black"> 103.         # It's an error for a user to have add permission but NOT change</font>
<font color="black"> 104.         # permission for users. If we allowed such users to add users, they</font>
<font color="black"> 105.         # could create superusers, which would mean they would essentially have</font>
<font color="black"> 106.         # the permission to change users. To avoid the problem entirely, we</font>
<font color="black"> 107.         # disallow users from adding users if they don't have change</font>
<font color="black"> 108.         # permission.</font>
<font color="red"> 109.         if not self.has_change_permission(request):</font>
<font color="red"> 110.             if self.has_add_permission(request) and settings.DEBUG:</font>
<font color="black"> 111.                 # Raise Http404 in debug mode so that the user gets a helpful</font>
<font color="black"> 112.                 # error message.</font>
<font color="red"> 113.                 raise Http404(</font>
<font color="red"> 114.                     'Your user does not have the &quot;Change user&quot; permission. In '</font>
<font color="black"> 115.                     'order to add users, Django requires that your user '</font>
<font color="black"> 116.                     'account have both the &quot;Add user&quot; and &quot;Change user&quot; '</font>
<font color="black"> 117.                     'permissions set.')</font>
<font color="red"> 118.             raise PermissionDenied</font>
<font color="red"> 119.         if extra_context is None:</font>
<font color="red"> 120.             extra_context = {}</font>
<font color="red"> 121.         username_field = self.model._meta.get_field(self.model.USERNAME_FIELD)</font>
<font color="red"> 122.         defaults = {</font>
<font color="red"> 123.             'auto_populated_fields': (),</font>
<font color="red"> 124.             'username_help_text': username_field.help_text,</font>
<font color="black"> 125.         }</font>
<font color="red"> 126.         extra_context.update(defaults)</font>
<font color="red"> 127.         return super(UserAdmin, self).add_view(request, form_url,</font>
<font color="red"> 128.                                                extra_context)</font>
<font color="black"> 129. </font>
<font color="green"> 130.     @sensitive_post_parameters_m</font>
<font color="green"> 131.     def user_change_password(self, request, id, form_url=''):</font>
<font color="red"> 132.         if not self.has_change_permission(request):</font>
<font color="red"> 133.             raise PermissionDenied</font>
<font color="red"> 134.         user = self.get_object(request, unquote(id))</font>
<font color="red"> 135.         if user is None:</font>
<font color="red"> 136.             raise Http404(_('%(name)s object with primary key %(key)r does not exist.') % {</font>
<font color="red"> 137.                 'name': force_text(self.model._meta.verbose_name),</font>
<font color="red"> 138.                 'key': escape(id),</font>
<font color="black"> 139.             })</font>
<font color="red"> 140.         if request.method == 'POST':</font>
<font color="red"> 141.             form = self.change_password_form(user, request.POST)</font>
<font color="red"> 142.             if form.is_valid():</font>
<font color="red"> 143.                 form.save()</font>
<font color="red"> 144.                 change_message = self.construct_change_message(request, form, None)</font>
<font color="red"> 145.                 self.log_change(request, user, change_message)</font>
<font color="red"> 146.                 msg = ugettext('Password changed successfully.')</font>
<font color="red"> 147.                 messages.success(request, msg)</font>
<font color="red"> 148.                 update_session_auth_hash(request, form.user)</font>
<font color="red"> 149.                 return HttpResponseRedirect(</font>
<font color="red"> 150.                     reverse(</font>
<font color="red"> 151.                         '%s:%s_%s_change' % (</font>
<font color="red"> 152.                             self.admin_site.name,</font>
<font color="red"> 153.                             user._meta.app_label,</font>
<font color="red"> 154.                             user._meta.model_name,</font>
<font color="black"> 155.                         ),</font>
<font color="red"> 156.                         args=(user.pk,),</font>
<font color="black"> 157.                     )</font>
<font color="black"> 158.                 )</font>
<font color="black"> 159.         else:</font>
<font color="red"> 160.             form = self.change_password_form(user)</font>
<font color="black"> 161. </font>
<font color="red"> 162.         fieldsets = [(None, {'fields': list(form.base_fields)})]</font>
<font color="red"> 163.         adminForm = admin.helpers.AdminForm(form, fieldsets, {})</font>
<font color="black"> 164. </font>
<font color="red"> 165.         context = {</font>
<font color="red"> 166.             'title': _('Change password: %s') % escape(user.get_username()),</font>
<font color="red"> 167.             'adminForm': adminForm,</font>
<font color="red"> 168.             'form_url': form_url,</font>
<font color="red"> 169.             'form': form,</font>
<font color="red"> 170.             'is_popup': (IS_POPUP_VAR in request.POST or</font>
<font color="red"> 171.                          IS_POPUP_VAR in request.GET),</font>
<font color="red"> 172.             'add': True,</font>
<font color="red"> 173.             'change': False,</font>
<font color="red"> 174.             'has_delete_permission': False,</font>
<font color="red"> 175.             'has_change_permission': True,</font>
<font color="red"> 176.             'has_absolute_url': False,</font>
<font color="red"> 177.             'opts': self.model._meta,</font>
<font color="red"> 178.             'original': user,</font>
<font color="red"> 179.             'save_as': False,</font>
<font color="red"> 180.             'show_save': True,</font>
<font color="black"> 181.         }</font>
<font color="red"> 182.         context.update(self.admin_site.each_context(request))</font>
<font color="black"> 183. </font>
<font color="red"> 184.         request.current_app = self.admin_site.name</font>
<font color="black"> 185. </font>
<font color="red"> 186.         return TemplateResponse(request,</font>
<font color="red"> 187.             self.change_user_password_template or</font>
<font color="red"> 188.             'admin/auth/user/change_password.html',</font>
<font color="red"> 189.             context)</font>
<font color="black"> 190. </font>
<font color="green"> 191.     def response_add(self, request, obj, post_url_continue=None):</font>
<font color="black"> 192.         &quot;&quot;&quot;</font>
<font color="black"> 193.         Determines the HttpResponse for the add_view stage. It mostly defers to</font>
<font color="black"> 194.         its superclass implementation but is customized because the User model</font>
<font color="black"> 195.         has a slightly different workflow.</font>
<font color="black"> 196.         &quot;&quot;&quot;</font>
<font color="black"> 197.         # We should allow further modification of the user just added i.e. the</font>
<font color="black"> 198.         # 'Save' button should behave like the 'Save and continue editing'</font>
<font color="black"> 199.         # button except in two scenarios:</font>
<font color="black"> 200.         # * The user has pressed the 'Save and add another' button</font>
<font color="black"> 201.         # * We are adding a user in a popup</font>
<font color="red"> 202.         if '_addanother' not in request.POST and IS_POPUP_VAR not in request.POST:</font>
<font color="red"> 203.             request.POST['_continue'] = 1</font>
<font color="red"> 204.         return super(UserAdmin, self).response_add(request, obj,</font>
<font color="red"> 205.                                                    post_url_continue)</font>
</pre>


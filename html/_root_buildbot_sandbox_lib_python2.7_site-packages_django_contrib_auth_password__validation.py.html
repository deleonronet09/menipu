source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/password_validation.py</b><br>


file stats: <b>123 lines, 72 executed: 58.5% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import gzip</font>
<font color="green">   4. import os</font>
<font color="green">   5. import re</font>
<font color="green">   6. from difflib import SequenceMatcher</font>
<font color="black">   7. </font>
<font color="green">   8. from django.conf import settings</font>
<font color="green">   9. from django.core.exceptions import ImproperlyConfigured, ValidationError</font>
<font color="green">  10. from django.utils import lru_cache</font>
<font color="green">  11. from django.utils._os import upath</font>
<font color="green">  12. from django.utils.encoding import force_text</font>
<font color="green">  13. from django.utils.html import format_html</font>
<font color="green">  14. from django.utils.module_loading import import_string</font>
<font color="green">  15. from django.utils.six import string_types</font>
<font color="green">  16. from django.utils.translation import ugettext as _, ungettext</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="green">  19. @lru_cache.lru_cache(maxsize=None)</font>
<font color="black">  20. def get_default_password_validators():</font>
<font color="green">  21.     return get_password_validators(settings.AUTH_PASSWORD_VALIDATORS)</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. def get_password_validators(validator_config):</font>
<font color="green">  25.     validators = []</font>
<font color="green">  26.     for validator in validator_config:</font>
<font color="green">  27.         try:</font>
<font color="green">  28.             klass = import_string(validator['NAME'])</font>
<font color="red">  29.         except ImportError:</font>
<font color="red">  30.             msg = &quot;The module in NAME could not be imported: %s. Check your AUTH_PASSWORD_VALIDATORS setting.&quot;</font>
<font color="red">  31.             raise ImproperlyConfigured(msg % validator['NAME'])</font>
<font color="green">  32.         validators.append(klass(**validator.get('OPTIONS', {})))</font>
<font color="black">  33. </font>
<font color="green">  34.     return validators</font>
<font color="black">  35. </font>
<font color="black">  36. </font>
<font color="green">  37. def validate_password(password, user=None, password_validators=None):</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="black">  39.     Validate whether the password meets all validator requirements.</font>
<font color="black">  40. </font>
<font color="black">  41.     If the password is valid, return ``None``.</font>
<font color="black">  42.     If the password is invalid, raise ValidationError with all error messages.</font>
<font color="black">  43.     &quot;&quot;&quot;</font>
<font color="red">  44.     errors = []</font>
<font color="red">  45.     if password_validators is None:</font>
<font color="red">  46.         password_validators = get_default_password_validators()</font>
<font color="red">  47.     for validator in password_validators:</font>
<font color="red">  48.         try:</font>
<font color="red">  49.             validator.validate(password, user)</font>
<font color="red">  50.         except ValidationError as error:</font>
<font color="red">  51.             errors.append(error)</font>
<font color="red">  52.     if errors:</font>
<font color="red">  53.         raise ValidationError(errors)</font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="green">  56. def password_changed(password, user=None, password_validators=None):</font>
<font color="black">  57.     &quot;&quot;&quot;</font>
<font color="black">  58.     Inform all validators that have implemented a password_changed() method</font>
<font color="black">  59.     that the password has been changed.</font>
<font color="black">  60.     &quot;&quot;&quot;</font>
<font color="red">  61.     if password_validators is None:</font>
<font color="red">  62.         password_validators = get_default_password_validators()</font>
<font color="red">  63.     for validator in password_validators:</font>
<font color="red">  64.         password_changed = getattr(validator, 'password_changed', lambda *a: None)</font>
<font color="red">  65.         password_changed(password, user)</font>
<font color="black">  66. </font>
<font color="black">  67. </font>
<font color="green">  68. def password_validators_help_texts(password_validators=None):</font>
<font color="black">  69.     &quot;&quot;&quot;</font>
<font color="black">  70.     Return a list of all help texts of all configured validators.</font>
<font color="black">  71.     &quot;&quot;&quot;</font>
<font color="green">  72.     help_texts = []</font>
<font color="green">  73.     if password_validators is None:</font>
<font color="green">  74.         password_validators = get_default_password_validators()</font>
<font color="green">  75.     for validator in password_validators:</font>
<font color="green">  76.         help_texts.append(validator.get_help_text())</font>
<font color="green">  77.     return help_texts</font>
<font color="black">  78. </font>
<font color="black">  79. </font>
<font color="green">  80. def password_validators_help_text_html(password_validators=None):</font>
<font color="black">  81.     &quot;&quot;&quot;</font>
<font color="black">  82.     Return an HTML string with all help texts of all configured validators</font>
<font color="black">  83.     in an &lt;ul&gt;.</font>
<font color="black">  84.     &quot;&quot;&quot;</font>
<font color="green">  85.     help_texts = password_validators_help_texts(password_validators)</font>
<font color="green">  86.     help_items = [format_html('&lt;li&gt;{}&lt;/li&gt;', help_text) for help_text in help_texts]</font>
<font color="green">  87.     return '&lt;ul&gt;%s&lt;/ul&gt;' % ''.join(help_items) if help_items else ''</font>
<font color="black">  88. </font>
<font color="black">  89. </font>
<font color="green">  90. class MinimumLengthValidator(object):</font>
<font color="black">  91.     &quot;&quot;&quot;</font>
<font color="black">  92.     Validate whether the password is of a minimum length.</font>
<font color="green">  93.     &quot;&quot;&quot;</font>
<font color="green">  94.     def __init__(self, min_length=8):</font>
<font color="green">  95.         self.min_length = min_length</font>
<font color="black">  96. </font>
<font color="green">  97.     def validate(self, password, user=None):</font>
<font color="red">  98.         if len(password) &lt; self.min_length:</font>
<font color="red">  99.             raise ValidationError(</font>
<font color="red"> 100.                 ungettext(</font>
<font color="red"> 101.                     &quot;This password is too short. It must contain at least %(min_length)d character.&quot;,</font>
<font color="red"> 102.                     &quot;This password is too short. It must contain at least %(min_length)d characters.&quot;,</font>
<font color="red"> 103.                     self.min_length</font>
<font color="black"> 104.                 ),</font>
<font color="red"> 105.                 code='password_too_short',</font>
<font color="red"> 106.                 params={'min_length': self.min_length},</font>
<font color="black"> 107.             )</font>
<font color="black"> 108. </font>
<font color="green"> 109.     def get_help_text(self):</font>
<font color="green"> 110.         return ungettext(</font>
<font color="green"> 111.             &quot;Your password must contain at least %(min_length)d character.&quot;,</font>
<font color="green"> 112.             &quot;Your password must contain at least %(min_length)d characters.&quot;,</font>
<font color="green"> 113.             self.min_length</font>
<font color="green"> 114.         ) % {'min_length': self.min_length}</font>
<font color="black"> 115. </font>
<font color="black"> 116. </font>
<font color="green"> 117. class UserAttributeSimilarityValidator(object):</font>
<font color="black"> 118.     &quot;&quot;&quot;</font>
<font color="black"> 119.     Validate whether the password is sufficiently different from the user's</font>
<font color="black"> 120.     attributes.</font>
<font color="black"> 121. </font>
<font color="black"> 122.     If no specific attributes are provided, look at a sensible list of</font>
<font color="black"> 123.     defaults. Attributes that don't exist are ignored. Comparison is made to</font>
<font color="black"> 124.     not only the full attribute value, but also its components, so that, for</font>
<font color="black"> 125.     example, a password is validated against either part of an email address,</font>
<font color="black"> 126.     as well as the full address.</font>
<font color="green"> 127.     &quot;&quot;&quot;</font>
<font color="green"> 128.     DEFAULT_USER_ATTRIBUTES = ('username', 'first_name', 'last_name', 'email')</font>
<font color="black"> 129. </font>
<font color="green"> 130.     def __init__(self, user_attributes=DEFAULT_USER_ATTRIBUTES, max_similarity=0.7):</font>
<font color="green"> 131.         self.user_attributes = user_attributes</font>
<font color="green"> 132.         self.max_similarity = max_similarity</font>
<font color="black"> 133. </font>
<font color="green"> 134.     def validate(self, password, user=None):</font>
<font color="red"> 135.         if not user:</font>
<font color="red"> 136.             return</font>
<font color="black"> 137. </font>
<font color="red"> 138.         for attribute_name in self.user_attributes:</font>
<font color="red"> 139.             value = getattr(user, attribute_name, None)</font>
<font color="red"> 140.             if not value or not isinstance(value, string_types):</font>
<font color="red"> 141.                 continue</font>
<font color="red"> 142.             value_parts = re.split('\W+', value) + [value]</font>
<font color="red"> 143.             for value_part in value_parts:</font>
<font color="red"> 144.                 if SequenceMatcher(a=password.lower(), b=value_part.lower()).quick_ratio() &gt; self.max_similarity:</font>
<font color="red"> 145.                     verbose_name = force_text(user._meta.get_field(attribute_name).verbose_name)</font>
<font color="red"> 146.                     raise ValidationError(</font>
<font color="red"> 147.                         _(&quot;The password is too similar to the %(verbose_name)s.&quot;),</font>
<font color="red"> 148.                         code='password_too_similar',</font>
<font color="red"> 149.                         params={'verbose_name': verbose_name},</font>
<font color="black"> 150.                     )</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def get_help_text(self):</font>
<font color="green"> 153.         return _(&quot;Your password can't be too similar to your other personal information.&quot;)</font>
<font color="black"> 154. </font>
<font color="black"> 155. </font>
<font color="green"> 156. class CommonPasswordValidator(object):</font>
<font color="black"> 157.     &quot;&quot;&quot;</font>
<font color="black"> 158.     Validate whether the password is a common password.</font>
<font color="black"> 159. </font>
<font color="black"> 160.     The password is rejected if it occurs in a provided list, which may be gzipped.</font>
<font color="black"> 161.     The list Django ships with contains 1000 common passwords, created by Mark Burnett:</font>
<font color="black"> 162.     https://xato.net/passwords/more-top-worst-passwords/</font>
<font color="green"> 163.     &quot;&quot;&quot;</font>
<font color="green"> 164.     DEFAULT_PASSWORD_LIST_PATH = os.path.join(</font>
<font color="green"> 165.         os.path.dirname(os.path.realpath(upath(__file__))), 'common-passwords.txt.gz'</font>
<font color="black"> 166.     )</font>
<font color="black"> 167. </font>
<font color="green"> 168.     def __init__(self, password_list_path=DEFAULT_PASSWORD_LIST_PATH):</font>
<font color="green"> 169.         try:</font>
<font color="green"> 170.             common_passwords_lines = gzip.open(password_list_path).read().decode('utf-8').splitlines()</font>
<font color="red"> 171.         except IOError:</font>
<font color="red"> 172.             with open(password_list_path) as f:</font>
<font color="red"> 173.                 common_passwords_lines = f.readlines()</font>
<font color="black"> 174. </font>
<font color="green"> 175.         self.passwords = {p.strip() for p in common_passwords_lines}</font>
<font color="black"> 176. </font>
<font color="green"> 177.     def validate(self, password, user=None):</font>
<font color="red"> 178.         if password.lower().strip() in self.passwords:</font>
<font color="red"> 179.             raise ValidationError(</font>
<font color="red"> 180.                 _(&quot;This password is too common.&quot;),</font>
<font color="red"> 181.                 code='password_too_common',</font>
<font color="black"> 182.             )</font>
<font color="black"> 183. </font>
<font color="green"> 184.     def get_help_text(self):</font>
<font color="green"> 185.         return _(&quot;Your password can't be a commonly used password.&quot;)</font>
<font color="black"> 186. </font>
<font color="black"> 187. </font>
<font color="green"> 188. class NumericPasswordValidator(object):</font>
<font color="black"> 189.     &quot;&quot;&quot;</font>
<font color="black"> 190.     Validate whether the password is alphanumeric.</font>
<font color="green"> 191.     &quot;&quot;&quot;</font>
<font color="green"> 192.     def validate(self, password, user=None):</font>
<font color="red"> 193.         if password.isdigit():</font>
<font color="red"> 194.             raise ValidationError(</font>
<font color="red"> 195.                 _(&quot;This password is entirely numeric.&quot;),</font>
<font color="red"> 196.                 code='password_entirely_numeric',</font>
<font color="black"> 197.             )</font>
<font color="black"> 198. </font>
<font color="green"> 199.     def get_help_text(self):</font>
<font color="green"> 200.         return _(&quot;Your password can't be entirely numeric.&quot;)</font>
</pre>


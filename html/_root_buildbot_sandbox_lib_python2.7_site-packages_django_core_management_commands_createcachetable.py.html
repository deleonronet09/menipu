source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/management/commands/createcachetable.py</b><br>


file stats: <b>80 lines, 27 executed: 33.8% covered</b>
<pre>
<font color="green">   1. from django.conf import settings</font>
<font color="green">   2. from django.core.cache import caches</font>
<font color="green">   3. from django.core.cache.backends.db import BaseDatabaseCache</font>
<font color="green">   4. from django.core.management.base import BaseCommand, CommandError</font>
<font color="green">   5. from django.db import (</font>
<font color="black">   6.     DEFAULT_DB_ALIAS, connections, models, router, transaction,</font>
<font color="black">   7. )</font>
<font color="green">   8. from django.db.utils import DatabaseError</font>
<font color="green">   9. from django.utils.encoding import force_text</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. class Command(BaseCommand):</font>
<font color="green">  13.     help = &quot;Creates the tables needed to use the SQL cache backend.&quot;</font>
<font color="black">  14. </font>
<font color="green">  15.     requires_system_checks = False</font>
<font color="black">  16. </font>
<font color="green">  17.     def add_arguments(self, parser):</font>
<font color="green">  18.         parser.add_argument('args', metavar='table_name', nargs='*',</font>
<font color="green">  19.             help='Optional table names. Otherwise, settings.CACHES is used to '</font>
<font color="black">  20.             'find cache tables.')</font>
<font color="green">  21.         parser.add_argument('--database', action='store', dest='database',</font>
<font color="green">  22.             default=DEFAULT_DB_ALIAS,</font>
<font color="green">  23.             help='Nominates a database onto which the cache tables will be '</font>
<font color="black">  24.             'installed. Defaults to the &quot;default&quot; database.')</font>
<font color="green">  25.         parser.add_argument('--dry-run', action='store_true', dest='dry_run',</font>
<font color="green">  26.             help='Does not create the table, just prints the SQL that would '</font>
<font color="black">  27.             'be run.')</font>
<font color="black">  28. </font>
<font color="green">  29.     def handle(self, *tablenames, **options):</font>
<font color="green">  30.         db = options.get('database')</font>
<font color="green">  31.         self.verbosity = int(options.get('verbosity'))</font>
<font color="green">  32.         dry_run = options.get('dry_run')</font>
<font color="green">  33.         if len(tablenames):</font>
<font color="black">  34.             # Legacy behavior, tablename specified as argument</font>
<font color="red">  35.             for tablename in tablenames:</font>
<font color="red">  36.                 self.create_table(db, tablename, dry_run)</font>
<font color="black">  37.         else:</font>
<font color="green">  38.             for cache_alias in settings.CACHES:</font>
<font color="green">  39.                 cache = caches[cache_alias]</font>
<font color="green">  40.                 if isinstance(cache, BaseDatabaseCache):</font>
<font color="red">  41.                     self.create_table(db, cache._table, dry_run)</font>
<font color="black">  42. </font>
<font color="green">  43.     def create_table(self, database, tablename, dry_run):</font>
<font color="red">  44.         cache = BaseDatabaseCache(tablename, {})</font>
<font color="red">  45.         if not router.allow_migrate_model(database, cache.cache_model_class):</font>
<font color="red">  46.             return</font>
<font color="red">  47.         connection = connections[database]</font>
<font color="black">  48. </font>
<font color="red">  49.         if tablename in connection.introspection.table_names():</font>
<font color="red">  50.             if self.verbosity &gt; 0:</font>
<font color="red">  51.                 self.stdout.write(&quot;Cache table '%s' already exists.&quot; % tablename)</font>
<font color="red">  52.             return</font>
<font color="black">  53. </font>
<font color="black">  54.         fields = (</font>
<font color="black">  55.             # &quot;key&quot; is a reserved word in MySQL, so use &quot;cache_key&quot; instead.</font>
<font color="red">  56.             models.CharField(name='cache_key', max_length=255, unique=True, primary_key=True),</font>
<font color="red">  57.             models.TextField(name='value'),</font>
<font color="red">  58.             models.DateTimeField(name='expires', db_index=True),</font>
<font color="black">  59.         )</font>
<font color="red">  60.         table_output = []</font>
<font color="red">  61.         index_output = []</font>
<font color="red">  62.         qn = connection.ops.quote_name</font>
<font color="red">  63.         for f in fields:</font>
<font color="red">  64.             field_output = [qn(f.name), f.db_type(connection=connection)]</font>
<font color="red">  65.             field_output.append(&quot;%sNULL&quot; % (&quot;NOT &quot; if not f.null else &quot;&quot;))</font>
<font color="red">  66.             if f.primary_key:</font>
<font color="red">  67.                 field_output.append(&quot;PRIMARY KEY&quot;)</font>
<font color="red">  68.             elif f.unique:</font>
<font color="red">  69.                 field_output.append(&quot;UNIQUE&quot;)</font>
<font color="red">  70.             if f.db_index:</font>
<font color="red">  71.                 unique = &quot;UNIQUE &quot; if f.unique else &quot;&quot;</font>
<font color="red">  72.                 index_output.append(&quot;CREATE %sINDEX %s ON %s (%s);&quot; %</font>
<font color="red">  73.                     (unique, qn('%s_%s' % (tablename, f.name)), qn(tablename),</font>
<font color="red">  74.                     qn(f.name)))</font>
<font color="red">  75.             table_output.append(&quot; &quot;.join(field_output))</font>
<font color="red">  76.         full_statement = [&quot;CREATE TABLE %s (&quot; % qn(tablename)]</font>
<font color="red">  77.         for i, line in enumerate(table_output):</font>
<font color="red">  78.             full_statement.append('    %s%s' % (line, ',' if i &lt; len(table_output) - 1 else ''))</font>
<font color="red">  79.         full_statement.append(');')</font>
<font color="black">  80. </font>
<font color="red">  81.         full_statement = &quot;\n&quot;.join(full_statement)</font>
<font color="black">  82. </font>
<font color="red">  83.         if dry_run:</font>
<font color="red">  84.             self.stdout.write(full_statement)</font>
<font color="red">  85.             for statement in index_output:</font>
<font color="red">  86.                 self.stdout.write(statement)</font>
<font color="red">  87.             return</font>
<font color="black">  88. </font>
<font color="red">  89.         with transaction.atomic(using=database,</font>
<font color="red">  90.                                 savepoint=connection.features.can_rollback_ddl):</font>
<font color="red">  91.             with connection.cursor() as curs:</font>
<font color="red">  92.                 try:</font>
<font color="red">  93.                     curs.execute(full_statement)</font>
<font color="red">  94.                 except DatabaseError as e:</font>
<font color="red">  95.                     raise CommandError(</font>
<font color="red">  96.                         &quot;Cache table '%s' could not be created.\nThe error was: %s.&quot; %</font>
<font color="red">  97.                         (tablename, force_text(e)))</font>
<font color="red">  98.                 for statement in index_output:</font>
<font color="red">  99.                     curs.execute(statement)</font>
<font color="black"> 100. </font>
<font color="red"> 101.         if self.verbosity &gt; 1:</font>
<font color="red"> 102.             self.stdout.write(&quot;Cache table '%s' created.&quot; % tablename)</font>
</pre>


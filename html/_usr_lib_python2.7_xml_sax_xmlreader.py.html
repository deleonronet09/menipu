source file: <b>/usr/lib/python2.7/xml/sax/xmlreader.py</b><br>


file stats: <b>166 lines, 75 executed: 45.2% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;An XML Reader is the SAX 2 name for an XML parser. XML Parsers</font>
<font color="green">   2. should be based on this code. &quot;&quot;&quot;</font>
<font color="black">   3. </font>
<font color="green">   4. import handler</font>
<font color="black">   5. </font>
<font color="green">   6. from _exceptions import SAXNotSupportedException, SAXNotRecognizedException</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="black">   9. # ===== XMLREADER =====</font>
<font color="black">  10. </font>
<font color="green">  11. class XMLReader:</font>
<font color="black">  12.     &quot;&quot;&quot;Interface for reading an XML document using callbacks.</font>
<font color="black">  13. </font>
<font color="black">  14.     XMLReader is the interface that an XML parser's SAX2 driver must</font>
<font color="black">  15.     implement. This interface allows an application to set and query</font>
<font color="black">  16.     features and properties in the parser, to register event handlers</font>
<font color="black">  17.     for document processing, and to initiate a document parse.</font>
<font color="black">  18. </font>
<font color="black">  19.     All SAX interfaces are assumed to be synchronous: the parse</font>
<font color="black">  20.     methods must not return until parsing is complete, and readers</font>
<font color="black">  21.     must wait for an event-handler callback to return before reporting</font>
<font color="green">  22.     the next event.&quot;&quot;&quot;</font>
<font color="black">  23. </font>
<font color="green">  24.     def __init__(self):</font>
<font color="red">  25.         self._cont_handler = handler.ContentHandler()</font>
<font color="red">  26.         self._dtd_handler = handler.DTDHandler()</font>
<font color="red">  27.         self._ent_handler = handler.EntityResolver()</font>
<font color="red">  28.         self._err_handler = handler.ErrorHandler()</font>
<font color="black">  29. </font>
<font color="green">  30.     def parse(self, source):</font>
<font color="black">  31.         &quot;Parse an XML document from a system identifier or an InputSource.&quot;</font>
<font color="red">  32.         raise NotImplementedError(&quot;This method must be implemented!&quot;)</font>
<font color="black">  33. </font>
<font color="green">  34.     def getContentHandler(self):</font>
<font color="black">  35.         &quot;Returns the current ContentHandler.&quot;</font>
<font color="red">  36.         return self._cont_handler</font>
<font color="black">  37. </font>
<font color="green">  38.     def setContentHandler(self, handler):</font>
<font color="black">  39.         &quot;Registers a new object to receive document content events.&quot;</font>
<font color="red">  40.         self._cont_handler = handler</font>
<font color="black">  41. </font>
<font color="green">  42.     def getDTDHandler(self):</font>
<font color="black">  43.         &quot;Returns the current DTD handler.&quot;</font>
<font color="red">  44.         return self._dtd_handler</font>
<font color="black">  45. </font>
<font color="green">  46.     def setDTDHandler(self, handler):</font>
<font color="black">  47.         &quot;Register an object to receive basic DTD-related events.&quot;</font>
<font color="red">  48.         self._dtd_handler = handler</font>
<font color="black">  49. </font>
<font color="green">  50.     def getEntityResolver(self):</font>
<font color="black">  51.         &quot;Returns the current EntityResolver.&quot;</font>
<font color="red">  52.         return self._ent_handler</font>
<font color="black">  53. </font>
<font color="green">  54.     def setEntityResolver(self, resolver):</font>
<font color="black">  55.         &quot;Register an object to resolve external entities.&quot;</font>
<font color="red">  56.         self._ent_handler = resolver</font>
<font color="black">  57. </font>
<font color="green">  58.     def getErrorHandler(self):</font>
<font color="black">  59.         &quot;Returns the current ErrorHandler.&quot;</font>
<font color="red">  60.         return self._err_handler</font>
<font color="black">  61. </font>
<font color="green">  62.     def setErrorHandler(self, handler):</font>
<font color="black">  63.         &quot;Register an object to receive error-message events.&quot;</font>
<font color="red">  64.         self._err_handler = handler</font>
<font color="black">  65. </font>
<font color="green">  66.     def setLocale(self, locale):</font>
<font color="black">  67.         &quot;&quot;&quot;Allow an application to set the locale for errors and warnings.</font>
<font color="black">  68. </font>
<font color="black">  69.         SAX parsers are not required to provide localization for errors</font>
<font color="black">  70.         and warnings; if they cannot support the requested locale,</font>
<font color="black">  71.         however, they must raise a SAX exception. Applications may</font>
<font color="black">  72.         request a locale change in the middle of a parse.&quot;&quot;&quot;</font>
<font color="red">  73.         raise SAXNotSupportedException(&quot;Locale support not implemented&quot;)</font>
<font color="black">  74. </font>
<font color="green">  75.     def getFeature(self, name):</font>
<font color="black">  76.         &quot;Looks up and returns the state of a SAX2 feature.&quot;</font>
<font color="red">  77.         raise SAXNotRecognizedException(&quot;Feature '%s' not recognized&quot; % name)</font>
<font color="black">  78. </font>
<font color="green">  79.     def setFeature(self, name, state):</font>
<font color="black">  80.         &quot;Sets the state of a SAX2 feature.&quot;</font>
<font color="red">  81.         raise SAXNotRecognizedException(&quot;Feature '%s' not recognized&quot; % name)</font>
<font color="black">  82. </font>
<font color="green">  83.     def getProperty(self, name):</font>
<font color="black">  84.         &quot;Looks up and returns the value of a SAX2 property.&quot;</font>
<font color="red">  85.         raise SAXNotRecognizedException(&quot;Property '%s' not recognized&quot; % name)</font>
<font color="black">  86. </font>
<font color="green">  87.     def setProperty(self, name, value):</font>
<font color="black">  88.         &quot;Sets the value of a SAX2 property.&quot;</font>
<font color="red">  89.         raise SAXNotRecognizedException(&quot;Property '%s' not recognized&quot; % name)</font>
<font color="black">  90. </font>
<font color="green">  91. class IncrementalParser(XMLReader):</font>
<font color="black">  92.     &quot;&quot;&quot;This interface adds three extra methods to the XMLReader</font>
<font color="black">  93.     interface that allow XML parsers to support incremental</font>
<font color="black">  94.     parsing. Support for this interface is optional, since not all</font>
<font color="black">  95.     underlying XML parsers support this functionality.</font>
<font color="black">  96. </font>
<font color="black">  97.     When the parser is instantiated it is ready to begin accepting</font>
<font color="black">  98.     data from the feed method immediately. After parsing has been</font>
<font color="black">  99.     finished with a call to close the reset method must be called to</font>
<font color="black"> 100.     make the parser ready to accept new data, either from feed or</font>
<font color="black"> 101.     using the parse method.</font>
<font color="black"> 102. </font>
<font color="black"> 103.     Note that these methods must _not_ be called during parsing, that</font>
<font color="black"> 104.     is, after parse has been called and before it returns.</font>
<font color="black"> 105. </font>
<font color="black"> 106.     By default, the class also implements the parse method of the XMLReader</font>
<font color="black"> 107.     interface using the feed, close and reset methods of the</font>
<font color="black"> 108.     IncrementalParser interface as a convenience to SAX 2.0 driver</font>
<font color="green"> 109.     writers.&quot;&quot;&quot;</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def __init__(self, bufsize=2**16):</font>
<font color="red"> 112.         self._bufsize = bufsize</font>
<font color="red"> 113.         XMLReader.__init__(self)</font>
<font color="black"> 114. </font>
<font color="green"> 115.     def parse(self, source):</font>
<font color="red"> 116.         import saxutils</font>
<font color="red"> 117.         source = saxutils.prepare_input_source(source)</font>
<font color="black"> 118. </font>
<font color="red"> 119.         self.prepareParser(source)</font>
<font color="red"> 120.         file = source.getByteStream()</font>
<font color="red"> 121.         buffer = file.read(self._bufsize)</font>
<font color="red"> 122.         while buffer != &quot;&quot;:</font>
<font color="red"> 123.             self.feed(buffer)</font>
<font color="red"> 124.             buffer = file.read(self._bufsize)</font>
<font color="red"> 125.         self.close()</font>
<font color="black"> 126. </font>
<font color="green"> 127.     def feed(self, data):</font>
<font color="black"> 128.         &quot;&quot;&quot;This method gives the raw XML data in the data parameter to</font>
<font color="black"> 129.         the parser and makes it parse the data, emitting the</font>
<font color="black"> 130.         corresponding events. It is allowed for XML constructs to be</font>
<font color="black"> 131.         split across several calls to feed.</font>
<font color="black"> 132. </font>
<font color="black"> 133.         feed may raise SAXException.&quot;&quot;&quot;</font>
<font color="red"> 134.         raise NotImplementedError(&quot;This method must be implemented!&quot;)</font>
<font color="black"> 135. </font>
<font color="green"> 136.     def prepareParser(self, source):</font>
<font color="black"> 137.         &quot;&quot;&quot;This method is called by the parse implementation to allow</font>
<font color="black"> 138.         the SAX 2.0 driver to prepare itself for parsing.&quot;&quot;&quot;</font>
<font color="red"> 139.         raise NotImplementedError(&quot;prepareParser must be overridden!&quot;)</font>
<font color="black"> 140. </font>
<font color="green"> 141.     def close(self):</font>
<font color="black"> 142.         &quot;&quot;&quot;This method is called when the entire XML document has been</font>
<font color="black"> 143.         passed to the parser through the feed method, to notify the</font>
<font color="black"> 144.         parser that there are no more data. This allows the parser to</font>
<font color="black"> 145.         do the final checks on the document and empty the internal</font>
<font color="black"> 146.         data buffer.</font>
<font color="black"> 147. </font>
<font color="black"> 148.         The parser will not be ready to parse another document until</font>
<font color="black"> 149.         the reset method has been called.</font>
<font color="black"> 150. </font>
<font color="black"> 151.         close may raise SAXException.&quot;&quot;&quot;</font>
<font color="red"> 152.         raise NotImplementedError(&quot;This method must be implemented!&quot;)</font>
<font color="black"> 153. </font>
<font color="green"> 154.     def reset(self):</font>
<font color="black"> 155.         &quot;&quot;&quot;This method is called after close has been called to reset</font>
<font color="black"> 156.         the parser so that it is ready to parse new documents. The</font>
<font color="black"> 157.         results of calling parse or feed after close without calling</font>
<font color="black"> 158.         reset are undefined.&quot;&quot;&quot;</font>
<font color="red"> 159.         raise NotImplementedError(&quot;This method must be implemented!&quot;)</font>
<font color="black"> 160. </font>
<font color="black"> 161. # ===== LOCATOR =====</font>
<font color="black"> 162. </font>
<font color="green"> 163. class Locator:</font>
<font color="black"> 164.     &quot;&quot;&quot;Interface for associating a SAX event with a document</font>
<font color="black"> 165.     location. A locator object will return valid results only during</font>
<font color="black"> 166.     calls to DocumentHandler methods; at any other time, the</font>
<font color="green"> 167.     results are unpredictable.&quot;&quot;&quot;</font>
<font color="black"> 168. </font>
<font color="green"> 169.     def getColumnNumber(self):</font>
<font color="black"> 170.         &quot;Return the column number where the current event ends.&quot;</font>
<font color="red"> 171.         return -1</font>
<font color="black"> 172. </font>
<font color="green"> 173.     def getLineNumber(self):</font>
<font color="black"> 174.         &quot;Return the line number where the current event ends.&quot;</font>
<font color="red"> 175.         return -1</font>
<font color="black"> 176. </font>
<font color="green"> 177.     def getPublicId(self):</font>
<font color="black"> 178.         &quot;Return the public identifier for the current event.&quot;</font>
<font color="red"> 179.         return None</font>
<font color="black"> 180. </font>
<font color="green"> 181.     def getSystemId(self):</font>
<font color="black"> 182.         &quot;Return the system identifier for the current event.&quot;</font>
<font color="red"> 183.         return None</font>
<font color="black"> 184. </font>
<font color="black"> 185. # ===== INPUTSOURCE =====</font>
<font color="black"> 186. </font>
<font color="green"> 187. class InputSource:</font>
<font color="black"> 188.     &quot;&quot;&quot;Encapsulation of the information needed by the XMLReader to</font>
<font color="black"> 189.     read entities.</font>
<font color="black"> 190. </font>
<font color="black"> 191.     This class may include information about the public identifier,</font>
<font color="black"> 192.     system identifier, byte stream (possibly with character encoding</font>
<font color="black"> 193.     information) and/or the character stream of an entity.</font>
<font color="black"> 194. </font>
<font color="black"> 195.     Applications will create objects of this class for use in the</font>
<font color="black"> 196.     XMLReader.parse method and for returning from</font>
<font color="black"> 197.     EntityResolver.resolveEntity.</font>
<font color="black"> 198. </font>
<font color="black"> 199.     An InputSource belongs to the application, the XMLReader is not</font>
<font color="black"> 200.     allowed to modify InputSource objects passed to it from the</font>
<font color="green"> 201.     application, although it may make copies and modify those.&quot;&quot;&quot;</font>
<font color="black"> 202. </font>
<font color="green"> 203.     def __init__(self, system_id = None):</font>
<font color="red"> 204.         self.__system_id = system_id</font>
<font color="red"> 205.         self.__public_id = None</font>
<font color="red"> 206.         self.__encoding  = None</font>
<font color="red"> 207.         self.__bytefile  = None</font>
<font color="red"> 208.         self.__charfile  = None</font>
<font color="black"> 209. </font>
<font color="green"> 210.     def setPublicId(self, public_id):</font>
<font color="black"> 211.         &quot;Sets the public identifier of this InputSource.&quot;</font>
<font color="red"> 212.         self.__public_id = public_id</font>
<font color="black"> 213. </font>
<font color="green"> 214.     def getPublicId(self):</font>
<font color="black"> 215.         &quot;Returns the public identifier of this InputSource.&quot;</font>
<font color="red"> 216.         return self.__public_id</font>
<font color="black"> 217. </font>
<font color="green"> 218.     def setSystemId(self, system_id):</font>
<font color="black"> 219.         &quot;Sets the system identifier of this InputSource.&quot;</font>
<font color="red"> 220.         self.__system_id = system_id</font>
<font color="black"> 221. </font>
<font color="green"> 222.     def getSystemId(self):</font>
<font color="black"> 223.         &quot;Returns the system identifier of this InputSource.&quot;</font>
<font color="red"> 224.         return self.__system_id</font>
<font color="black"> 225. </font>
<font color="green"> 226.     def setEncoding(self, encoding):</font>
<font color="black"> 227.         &quot;&quot;&quot;Sets the character encoding of this InputSource.</font>
<font color="black"> 228. </font>
<font color="black"> 229.         The encoding must be a string acceptable for an XML encoding</font>
<font color="black"> 230.         declaration (see section 4.3.3 of the XML recommendation).</font>
<font color="black"> 231. </font>
<font color="black"> 232.         The encoding attribute of the InputSource is ignored if the</font>
<font color="black"> 233.         InputSource also contains a character stream.&quot;&quot;&quot;</font>
<font color="red"> 234.         self.__encoding = encoding</font>
<font color="black"> 235. </font>
<font color="green"> 236.     def getEncoding(self):</font>
<font color="black"> 237.         &quot;Get the character encoding of this InputSource.&quot;</font>
<font color="red"> 238.         return self.__encoding</font>
<font color="black"> 239. </font>
<font color="green"> 240.     def setByteStream(self, bytefile):</font>
<font color="black"> 241.         &quot;&quot;&quot;Set the byte stream (a Python file-like object which does</font>
<font color="black"> 242.         not perform byte-to-character conversion) for this input</font>
<font color="black"> 243.         source.</font>
<font color="black"> 244. </font>
<font color="black"> 245.         The SAX parser will ignore this if there is also a character</font>
<font color="black"> 246.         stream specified, but it will use a byte stream in preference</font>
<font color="black"> 247.         to opening a URI connection itself.</font>
<font color="black"> 248. </font>
<font color="black"> 249.         If the application knows the character encoding of the byte</font>
<font color="black"> 250.         stream, it should set it with the setEncoding method.&quot;&quot;&quot;</font>
<font color="red"> 251.         self.__bytefile = bytefile</font>
<font color="black"> 252. </font>
<font color="green"> 253.     def getByteStream(self):</font>
<font color="black"> 254.         &quot;&quot;&quot;Get the byte stream for this input source.</font>
<font color="black"> 255. </font>
<font color="black"> 256.         The getEncoding method will return the character encoding for</font>
<font color="black"> 257.         this byte stream, or None if unknown.&quot;&quot;&quot;</font>
<font color="red"> 258.         return self.__bytefile</font>
<font color="black"> 259. </font>
<font color="green"> 260.     def setCharacterStream(self, charfile):</font>
<font color="black"> 261.         &quot;&quot;&quot;Set the character stream for this input source. (The stream</font>
<font color="black"> 262.         must be a Python 2.0 Unicode-wrapped file-like that performs</font>
<font color="black"> 263.         conversion to Unicode strings.)</font>
<font color="black"> 264. </font>
<font color="black"> 265.         If there is a character stream specified, the SAX parser will</font>
<font color="black"> 266.         ignore any byte stream and will not attempt to open a URI</font>
<font color="black"> 267.         connection to the system identifier.&quot;&quot;&quot;</font>
<font color="red"> 268.         self.__charfile = charfile</font>
<font color="black"> 269. </font>
<font color="green"> 270.     def getCharacterStream(self):</font>
<font color="black"> 271.         &quot;Get the character stream for this input source.&quot;</font>
<font color="red"> 272.         return self.__charfile</font>
<font color="black"> 273. </font>
<font color="black"> 274. # ===== ATTRIBUTESIMPL =====</font>
<font color="black"> 275. </font>
<font color="green"> 276. class AttributesImpl:</font>
<font color="black"> 277. </font>
<font color="green"> 278.     def __init__(self, attrs):</font>
<font color="black"> 279.         &quot;&quot;&quot;Non-NS-aware implementation.</font>
<font color="black"> 280. </font>
<font color="black"> 281.         attrs should be of the form {name : value}.&quot;&quot;&quot;</font>
<font color="red"> 282.         self._attrs = attrs</font>
<font color="black"> 283. </font>
<font color="green"> 284.     def getLength(self):</font>
<font color="red"> 285.         return len(self._attrs)</font>
<font color="black"> 286. </font>
<font color="green"> 287.     def getType(self, name):</font>
<font color="red"> 288.         return &quot;CDATA&quot;</font>
<font color="black"> 289. </font>
<font color="green"> 290.     def getValue(self, name):</font>
<font color="red"> 291.         return self._attrs[name]</font>
<font color="black"> 292. </font>
<font color="green"> 293.     def getValueByQName(self, name):</font>
<font color="red"> 294.         return self._attrs[name]</font>
<font color="black"> 295. </font>
<font color="green"> 296.     def getNameByQName(self, name):</font>
<font color="red"> 297.         if not name in self._attrs:</font>
<font color="red"> 298.             raise KeyError, name</font>
<font color="red"> 299.         return name</font>
<font color="black"> 300. </font>
<font color="green"> 301.     def getQNameByName(self, name):</font>
<font color="red"> 302.         if not name in self._attrs:</font>
<font color="red"> 303.             raise KeyError, name</font>
<font color="red"> 304.         return name</font>
<font color="black"> 305. </font>
<font color="green"> 306.     def getNames(self):</font>
<font color="red"> 307.         return self._attrs.keys()</font>
<font color="black"> 308. </font>
<font color="green"> 309.     def getQNames(self):</font>
<font color="red"> 310.         return self._attrs.keys()</font>
<font color="black"> 311. </font>
<font color="green"> 312.     def __len__(self):</font>
<font color="red"> 313.         return len(self._attrs)</font>
<font color="black"> 314. </font>
<font color="green"> 315.     def __getitem__(self, name):</font>
<font color="red"> 316.         return self._attrs[name]</font>
<font color="black"> 317. </font>
<font color="green"> 318.     def keys(self):</font>
<font color="red"> 319.         return self._attrs.keys()</font>
<font color="black"> 320. </font>
<font color="green"> 321.     def has_key(self, name):</font>
<font color="red"> 322.         return name in self._attrs</font>
<font color="black"> 323. </font>
<font color="green"> 324.     def __contains__(self, name):</font>
<font color="red"> 325.         return name in self._attrs</font>
<font color="black"> 326. </font>
<font color="green"> 327.     def get(self, name, alternative=None):</font>
<font color="red"> 328.         return self._attrs.get(name, alternative)</font>
<font color="black"> 329. </font>
<font color="green"> 330.     def copy(self):</font>
<font color="red"> 331.         return self.__class__(self._attrs)</font>
<font color="black"> 332. </font>
<font color="green"> 333.     def items(self):</font>
<font color="red"> 334.         return self._attrs.items()</font>
<font color="black"> 335. </font>
<font color="green"> 336.     def values(self):</font>
<font color="red"> 337.         return self._attrs.values()</font>
<font color="black"> 338. </font>
<font color="black"> 339. # ===== ATTRIBUTESNSIMPL =====</font>
<font color="black"> 340. </font>
<font color="green"> 341. class AttributesNSImpl(AttributesImpl):</font>
<font color="black"> 342. </font>
<font color="green"> 343.     def __init__(self, attrs, qnames):</font>
<font color="black"> 344.         &quot;&quot;&quot;NS-aware implementation.</font>
<font color="black"> 345. </font>
<font color="black"> 346.         attrs should be of the form {(ns_uri, lname): value, ...}.</font>
<font color="black"> 347.         qnames of the form {(ns_uri, lname): qname, ...}.&quot;&quot;&quot;</font>
<font color="red"> 348.         self._attrs = attrs</font>
<font color="red"> 349.         self._qnames = qnames</font>
<font color="black"> 350. </font>
<font color="green"> 351.     def getValueByQName(self, name):</font>
<font color="red"> 352.         for (nsname, qname) in self._qnames.items():</font>
<font color="red"> 353.             if qname == name:</font>
<font color="red"> 354.                 return self._attrs[nsname]</font>
<font color="black"> 355. </font>
<font color="red"> 356.         raise KeyError, name</font>
<font color="black"> 357. </font>
<font color="green"> 358.     def getNameByQName(self, name):</font>
<font color="red"> 359.         for (nsname, qname) in self._qnames.items():</font>
<font color="red"> 360.             if qname == name:</font>
<font color="red"> 361.                 return nsname</font>
<font color="black"> 362. </font>
<font color="red"> 363.         raise KeyError, name</font>
<font color="black"> 364. </font>
<font color="green"> 365.     def getQNameByName(self, name):</font>
<font color="red"> 366.         return self._qnames[name]</font>
<font color="black"> 367. </font>
<font color="green"> 368.     def getQNames(self):</font>
<font color="red"> 369.         return self._qnames.values()</font>
<font color="black"> 370. </font>
<font color="green"> 371.     def copy(self):</font>
<font color="red"> 372.         return self.__class__(self._attrs, self._qnames)</font>
<font color="black"> 373. </font>
<font color="black"> 374. </font>
<font color="green"> 375. def _test():</font>
<font color="red"> 376.     XMLReader()</font>
<font color="red"> 377.     IncrementalParser()</font>
<font color="red"> 378.     Locator()</font>
<font color="black"> 379. </font>
<font color="green"> 380. if __name__ == &quot;__main__&quot;:</font>
<font color="red"> 381.     _test()</font>
</pre>


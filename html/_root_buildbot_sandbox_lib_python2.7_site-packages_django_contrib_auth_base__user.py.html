source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/base_user.py</b><br>


file stats: <b>68 lines, 35 executed: 51.5% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. This module allows importing AbstractBaseUser even when django.contrib.auth is</font>
<font color="black">   3. not in INSTALLED_APPS.</font>
<font color="green">   4. &quot;&quot;&quot;</font>
<font color="green">   5. from __future__ import unicode_literals</font>
<font color="black">   6. </font>
<font color="green">   7. from django.contrib.auth import password_validation</font>
<font color="green">   8. from django.contrib.auth.hashers import (</font>
<font color="black">   9.     check_password, is_password_usable, make_password,</font>
<font color="black">  10. )</font>
<font color="green">  11. from django.db import models</font>
<font color="green">  12. from django.utils.crypto import get_random_string, salted_hmac</font>
<font color="green">  13. from django.utils.encoding import python_2_unicode_compatible</font>
<font color="green">  14. from django.utils.translation import ugettext_lazy as _</font>
<font color="black">  15. </font>
<font color="black">  16. </font>
<font color="green">  17. class BaseUserManager(models.Manager):</font>
<font color="black">  18. </font>
<font color="green">  19.     @classmethod</font>
<font color="black">  20.     def normalize_email(cls, email):</font>
<font color="black">  21.         &quot;&quot;&quot;</font>
<font color="black">  22.         Normalize the email address by lowercasing the domain part of the it.</font>
<font color="black">  23.         &quot;&quot;&quot;</font>
<font color="red">  24.         email = email or ''</font>
<font color="red">  25.         try:</font>
<font color="red">  26.             email_name, domain_part = email.strip().rsplit('@', 1)</font>
<font color="red">  27.         except ValueError:</font>
<font color="red">  28.             pass</font>
<font color="black">  29.         else:</font>
<font color="red">  30.             email = '@'.join([email_name, domain_part.lower()])</font>
<font color="red">  31.         return email</font>
<font color="black">  32. </font>
<font color="green">  33.     def make_random_password(self, length=10,</font>
<font color="green">  34.                              allowed_chars='abcdefghjkmnpqrstuvwxyz'</font>
<font color="black">  35.                                            'ABCDEFGHJKLMNPQRSTUVWXYZ'</font>
<font color="black">  36.                                            '23456789'):</font>
<font color="black">  37.         &quot;&quot;&quot;</font>
<font color="black">  38.         Generate a random password with the given length and given</font>
<font color="black">  39.         allowed_chars. The default value of allowed_chars does not have &quot;I&quot; or</font>
<font color="black">  40.         &quot;O&quot; or letters and digits that look similar -- just to avoid confusion.</font>
<font color="black">  41.         &quot;&quot;&quot;</font>
<font color="red">  42.         return get_random_string(length, allowed_chars)</font>
<font color="black">  43. </font>
<font color="green">  44.     def get_by_natural_key(self, username):</font>
<font color="red">  45.         return self.get(**{self.model.USERNAME_FIELD: username})</font>
<font color="black">  46. </font>
<font color="black">  47. </font>
<font color="green">  48. @python_2_unicode_compatible</font>
<font color="green">  49. class AbstractBaseUser(models.Model):</font>
<font color="green">  50.     password = models.CharField(_('password'), max_length=128)</font>
<font color="green">  51.     last_login = models.DateTimeField(_('last login'), blank=True, null=True)</font>
<font color="black">  52. </font>
<font color="green">  53.     is_active = True</font>
<font color="black">  54. </font>
<font color="green">  55.     REQUIRED_FIELDS = []</font>
<font color="black">  56. </font>
<font color="green">  57.     class Meta:</font>
<font color="green">  58.         abstract = True</font>
<font color="black">  59. </font>
<font color="green">  60.     def get_username(self):</font>
<font color="black">  61.         &quot;Return the identifying username for this User&quot;</font>
<font color="red">  62.         return getattr(self, self.USERNAME_FIELD)</font>
<font color="black">  63. </font>
<font color="green">  64.     def __init__(self, *args, **kwargs):</font>
<font color="red">  65.         super(AbstractBaseUser, self).__init__(*args, **kwargs)</font>
<font color="black">  66.         # Stores the raw password if set_password() is called so that it can</font>
<font color="black">  67.         # be passed to password_changed() after the model is saved.</font>
<font color="red">  68.         self._password = None</font>
<font color="black">  69. </font>
<font color="green">  70.     def __str__(self):</font>
<font color="red">  71.         return self.get_username()</font>
<font color="black">  72. </font>
<font color="green">  73.     def save(self, *args, **kwargs):</font>
<font color="red">  74.         super(AbstractBaseUser, self).save(*args, **kwargs)</font>
<font color="red">  75.         if self._password is not None:</font>
<font color="red">  76.             password_validation.password_changed(self._password, self)</font>
<font color="red">  77.             self._password = None</font>
<font color="black">  78. </font>
<font color="green">  79.     def natural_key(self):</font>
<font color="red">  80.         return (self.get_username(),)</font>
<font color="black">  81. </font>
<font color="green">  82.     def is_anonymous(self):</font>
<font color="black">  83.         &quot;&quot;&quot;</font>
<font color="black">  84.         Always return False. This is a way of comparing User objects to</font>
<font color="black">  85.         anonymous users.</font>
<font color="black">  86.         &quot;&quot;&quot;</font>
<font color="red">  87.         return False</font>
<font color="black">  88. </font>
<font color="green">  89.     def is_authenticated(self):</font>
<font color="black">  90.         &quot;&quot;&quot;</font>
<font color="black">  91.         Always return True. This is a way to tell if the user has been</font>
<font color="black">  92.         authenticated in templates.</font>
<font color="black">  93.         &quot;&quot;&quot;</font>
<font color="red">  94.         return True</font>
<font color="black">  95. </font>
<font color="green">  96.     def set_password(self, raw_password):</font>
<font color="red">  97.         self.password = make_password(raw_password)</font>
<font color="red">  98.         self._password = raw_password</font>
<font color="black">  99. </font>
<font color="green"> 100.     def check_password(self, raw_password):</font>
<font color="black"> 101.         &quot;&quot;&quot;</font>
<font color="black"> 102.         Return a boolean of whether the raw_password was correct. Handles</font>
<font color="black"> 103.         hashing formats behind the scenes.</font>
<font color="black"> 104.         &quot;&quot;&quot;</font>
<font color="red"> 105.         def setter(raw_password):</font>
<font color="red"> 106.             self.set_password(raw_password)</font>
<font color="black"> 107.             # Password hash upgrades shouldn't be considered password changes.</font>
<font color="red"> 108.             self._password = None</font>
<font color="red"> 109.             self.save(update_fields=[&quot;password&quot;])</font>
<font color="red"> 110.         return check_password(raw_password, self.password, setter)</font>
<font color="black"> 111. </font>
<font color="green"> 112.     def set_unusable_password(self):</font>
<font color="black"> 113.         # Set a value that will never be a valid hash</font>
<font color="red"> 114.         self.password = make_password(None)</font>
<font color="black"> 115. </font>
<font color="green"> 116.     def has_usable_password(self):</font>
<font color="red"> 117.         return is_password_usable(self.password)</font>
<font color="black"> 118. </font>
<font color="green"> 119.     def get_full_name(self):</font>
<font color="red"> 120.         raise NotImplementedError('subclasses of AbstractBaseUser must provide a get_full_name() method')</font>
<font color="black"> 121. </font>
<font color="green"> 122.     def get_short_name(self):</font>
<font color="red"> 123.         raise NotImplementedError('subclasses of AbstractBaseUser must provide a get_short_name() method.')</font>
<font color="black"> 124. </font>
<font color="green"> 125.     def get_session_auth_hash(self):</font>
<font color="black"> 126.         &quot;&quot;&quot;</font>
<font color="black"> 127.         Return an HMAC of the password field.</font>
<font color="black"> 128.         &quot;&quot;&quot;</font>
<font color="red"> 129.         key_salt = &quot;django.contrib.auth.models.AbstractBaseUser.get_session_auth_hash&quot;</font>
<font color="red"> 130.         return salted_hmac(key_salt, self.password).hexdigest()</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/template/engine.py</b><br>


file stats: <b>176 lines, 67 executed: 38.1% covered</b>
<pre>
<font color="green">   1. import warnings</font>
<font color="black">   2. </font>
<font color="green">   3. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   4. from django.utils import lru_cache, six</font>
<font color="green">   5. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">   6. from django.utils.functional import cached_property</font>
<font color="green">   7. from django.utils.module_loading import import_string</font>
<font color="black">   8. </font>
<font color="green">   9. from .base import Context, Template</font>
<font color="green">  10. from .context import _builtin_context_processors</font>
<font color="green">  11. from .exceptions import TemplateDoesNotExist</font>
<font color="green">  12. from .library import import_library</font>
<font color="black">  13. </font>
<font color="green">  14. _context_instance_undefined = object()</font>
<font color="green">  15. _dictionary_undefined = object()</font>
<font color="green">  16. _dirs_undefined = object()</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="green">  19. class Engine(object):</font>
<font color="black">  20.     default_builtins = [</font>
<font color="green">  21.         'django.template.defaulttags',</font>
<font color="green">  22.         'django.template.defaultfilters',</font>
<font color="green">  23.         'django.template.loader_tags',</font>
<font color="black">  24.     ]</font>
<font color="black">  25. </font>
<font color="green">  26.     def __init__(self, dirs=None, app_dirs=False,</font>
<font color="green">  27.                  allowed_include_roots=None, context_processors=None,</font>
<font color="green">  28.                  debug=False, loaders=None, string_if_invalid='',</font>
<font color="green">  29.                  file_charset='utf-8', libraries=None, builtins=None):</font>
<font color="green">  30.         if dirs is None:</font>
<font color="green">  31.             dirs = []</font>
<font color="green">  32.         if allowed_include_roots is None:</font>
<font color="green">  33.             allowed_include_roots = []</font>
<font color="green">  34.         if context_processors is None:</font>
<font color="green">  35.             context_processors = []</font>
<font color="green">  36.         if loaders is None:</font>
<font color="green">  37.             loaders = ['django.template.loaders.filesystem.Loader']</font>
<font color="green">  38.             if app_dirs:</font>
<font color="red">  39.                 loaders += ['django.template.loaders.app_directories.Loader']</font>
<font color="black">  40.         else:</font>
<font color="red">  41.             if app_dirs:</font>
<font color="red">  42.                 raise ImproperlyConfigured(</font>
<font color="red">  43.                     &quot;app_dirs must not be set when loaders is defined.&quot;)</font>
<font color="green">  44.         if libraries is None:</font>
<font color="green">  45.             libraries = {}</font>
<font color="green">  46.         if builtins is None:</font>
<font color="green">  47.             builtins = []</font>
<font color="black">  48. </font>
<font color="green">  49.         if isinstance(allowed_include_roots, six.string_types):</font>
<font color="red">  50.             raise ImproperlyConfigured(</font>
<font color="red">  51.                 &quot;allowed_include_roots must be a tuple, not a string.&quot;)</font>
<font color="black">  52. </font>
<font color="green">  53.         self.dirs = dirs</font>
<font color="green">  54.         self.app_dirs = app_dirs</font>
<font color="green">  55.         self.allowed_include_roots = allowed_include_roots</font>
<font color="green">  56.         self.context_processors = context_processors</font>
<font color="green">  57.         self.debug = debug</font>
<font color="green">  58.         self.loaders = loaders</font>
<font color="green">  59.         self.string_if_invalid = string_if_invalid</font>
<font color="green">  60.         self.file_charset = file_charset</font>
<font color="green">  61.         self.libraries = libraries</font>
<font color="green">  62.         self.template_libraries = self.get_template_libraries(libraries)</font>
<font color="green">  63.         self.builtins = self.default_builtins + builtins</font>
<font color="green">  64.         self.template_builtins = self.get_template_builtins(self.builtins)</font>
<font color="black">  65. </font>
<font color="green">  66.     @staticmethod</font>
<font color="green">  67.     @lru_cache.lru_cache()</font>
<font color="black">  68.     def get_default():</font>
<font color="black">  69.         &quot;&quot;&quot;</font>
<font color="black">  70.         When only one DjangoTemplates backend is configured, returns it.</font>
<font color="black">  71. </font>
<font color="black">  72.         Raises ImproperlyConfigured otherwise.</font>
<font color="black">  73. </font>
<font color="black">  74.         This is required for preserving historical APIs that rely on a</font>
<font color="black">  75.         globally available, implicitly configured engine such as:</font>
<font color="black">  76. </font>
<font color="black">  77.         &gt;&gt;&gt; from django.template import Context, Template</font>
<font color="black">  78.         &gt;&gt;&gt; template = Template(&quot;Hello {{ name }}!&quot;)</font>
<font color="black">  79.         &gt;&gt;&gt; context = Context({'name': &quot;world&quot;})</font>
<font color="black">  80.         &gt;&gt;&gt; template.render(context)</font>
<font color="black">  81.         'Hello world!'</font>
<font color="black">  82.         &quot;&quot;&quot;</font>
<font color="black">  83.         # Since Engine is imported in django.template and since</font>
<font color="black">  84.         # DjangoTemplates is a wrapper around this Engine class,</font>
<font color="black">  85.         # local imports are required to avoid import loops.</font>
<font color="red">  86.         from django.template import engines</font>
<font color="red">  87.         from django.template.backends.django import DjangoTemplates</font>
<font color="red">  88.         django_engines = [engine for engine in engines.all()</font>
<font color="red">  89.                           if isinstance(engine, DjangoTemplates)]</font>
<font color="red">  90.         if len(django_engines) == 1:</font>
<font color="black">  91.             # Unwrap the Engine instance inside DjangoTemplates</font>
<font color="red">  92.             return django_engines[0].engine</font>
<font color="red">  93.         elif len(django_engines) == 0:</font>
<font color="red">  94.             raise ImproperlyConfigured(</font>
<font color="red">  95.                 &quot;No DjangoTemplates backend is configured.&quot;)</font>
<font color="black">  96.         else:</font>
<font color="red">  97.             raise ImproperlyConfigured(</font>
<font color="red">  98.                 &quot;Several DjangoTemplates backends are configured. &quot;</font>
<font color="black">  99.                 &quot;You must select one explicitly.&quot;)</font>
<font color="black"> 100. </font>
<font color="green"> 101.     @cached_property</font>
<font color="black"> 102.     def template_context_processors(self):</font>
<font color="red"> 103.         context_processors = _builtin_context_processors</font>
<font color="red"> 104.         context_processors += tuple(self.context_processors)</font>
<font color="red"> 105.         return tuple(import_string(path) for path in context_processors)</font>
<font color="black"> 106. </font>
<font color="green"> 107.     def get_template_builtins(self, builtins):</font>
<font color="green"> 108.         return [import_library(x) for x in builtins]</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def get_template_libraries(self, libraries):</font>
<font color="green"> 111.         loaded = {}</font>
<font color="green"> 112.         for name, path in libraries.items():</font>
<font color="red"> 113.             loaded[name] = import_library(path)</font>
<font color="green"> 114.         return loaded</font>
<font color="black"> 115. </font>
<font color="green"> 116.     @cached_property</font>
<font color="black"> 117.     def template_loaders(self):</font>
<font color="red"> 118.         return self.get_template_loaders(self.loaders)</font>
<font color="black"> 119. </font>
<font color="green"> 120.     def get_template_loaders(self, template_loaders):</font>
<font color="red"> 121.         loaders = []</font>
<font color="red"> 122.         for template_loader in template_loaders:</font>
<font color="red"> 123.             loader = self.find_template_loader(template_loader)</font>
<font color="red"> 124.             if loader is not None:</font>
<font color="red"> 125.                 loaders.append(loader)</font>
<font color="red"> 126.         return loaders</font>
<font color="black"> 127. </font>
<font color="green"> 128.     def find_template_loader(self, loader):</font>
<font color="red"> 129.         if isinstance(loader, (tuple, list)):</font>
<font color="red"> 130.             args = list(loader[1:])</font>
<font color="red"> 131.             loader = loader[0]</font>
<font color="black"> 132.         else:</font>
<font color="red"> 133.             args = []</font>
<font color="black"> 134. </font>
<font color="red"> 135.         if isinstance(loader, six.string_types):</font>
<font color="red"> 136.             loader_class = import_string(loader)</font>
<font color="black"> 137. </font>
<font color="red"> 138.             if getattr(loader_class, '_accepts_engine_in_init', False):</font>
<font color="red"> 139.                 args.insert(0, self)</font>
<font color="black"> 140.             else:</font>
<font color="red"> 141.                 warnings.warn(</font>
<font color="red"> 142.                     &quot;%s inherits from django.template.loader.BaseLoader &quot;</font>
<font color="black"> 143.                     &quot;instead of django.template.loaders.base.Loader. &quot; %</font>
<font color="red"> 144.                     loader, RemovedInDjango110Warning, stacklevel=2)</font>
<font color="black"> 145. </font>
<font color="red"> 146.             return loader_class(*args)</font>
<font color="black"> 147.         else:</font>
<font color="red"> 148.             raise ImproperlyConfigured(</font>
<font color="red"> 149.                 &quot;Invalid value in template loaders configuration: %r&quot; % loader)</font>
<font color="black"> 150. </font>
<font color="green"> 151.     def find_template(self, name, dirs=None, skip=None):</font>
<font color="red"> 152.         tried = []</font>
<font color="red"> 153.         for loader in self.template_loaders:</font>
<font color="red"> 154.             if loader.supports_recursion:</font>
<font color="red"> 155.                 try:</font>
<font color="red"> 156.                     template = loader.get_template(</font>
<font color="red"> 157.                         name, template_dirs=dirs, skip=skip,</font>
<font color="black"> 158.                     )</font>
<font color="red"> 159.                     return template, template.origin</font>
<font color="red"> 160.                 except TemplateDoesNotExist as e:</font>
<font color="red"> 161.                     tried.extend(e.tried)</font>
<font color="black"> 162.             else:</font>
<font color="black"> 163.                 # RemovedInDjango20Warning: Use old api for non-recursive</font>
<font color="black"> 164.                 # loaders.</font>
<font color="red"> 165.                 try:</font>
<font color="red"> 166.                     return loader(name, dirs)</font>
<font color="red"> 167.                 except TemplateDoesNotExist:</font>
<font color="red"> 168.                     pass</font>
<font color="red"> 169.         raise TemplateDoesNotExist(name, tried=tried)</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def from_string(self, template_code):</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="black"> 173.         Returns a compiled Template object for the given template code,</font>
<font color="black"> 174.         handling template inheritance recursively.</font>
<font color="black"> 175.         &quot;&quot;&quot;</font>
<font color="red"> 176.         return Template(template_code, engine=self)</font>
<font color="black"> 177. </font>
<font color="green"> 178.     def get_template(self, template_name, dirs=_dirs_undefined):</font>
<font color="black"> 179.         &quot;&quot;&quot;</font>
<font color="black"> 180.         Returns a compiled Template object for the given template name,</font>
<font color="black"> 181.         handling template inheritance recursively.</font>
<font color="black"> 182.         &quot;&quot;&quot;</font>
<font color="red"> 183.         if dirs is _dirs_undefined:</font>
<font color="red"> 184.             dirs = None</font>
<font color="black"> 185.         else:</font>
<font color="red"> 186.             warnings.warn(</font>
<font color="red"> 187.                 &quot;The dirs argument of get_template is deprecated.&quot;,</font>
<font color="red"> 188.                 RemovedInDjango110Warning, stacklevel=2)</font>
<font color="black"> 189. </font>
<font color="red"> 190.         template, origin = self.find_template(template_name, dirs)</font>
<font color="red"> 191.         if not hasattr(template, 'render'):</font>
<font color="black"> 192.             # template needs to be compiled</font>
<font color="red"> 193.             template = Template(template, origin, template_name, engine=self)</font>
<font color="red"> 194.         return template</font>
<font color="black"> 195. </font>
<font color="black"> 196.     # This method was originally a function defined in django.template.loader.</font>
<font color="black"> 197.     # It was moved here in Django 1.8 when encapsulating the Django template</font>
<font color="black"> 198.     # engine in this Engine class. It's still called by deprecated code but it</font>
<font color="black"> 199.     # will be removed in Django 1.10. It's superseded by a new render_to_string</font>
<font color="black"> 200.     # function in django.template.loader.</font>
<font color="black"> 201. </font>
<font color="green"> 202.     def render_to_string(self, template_name, context=None,</font>
<font color="green"> 203.                          context_instance=_context_instance_undefined,</font>
<font color="green"> 204.                          dirs=_dirs_undefined,</font>
<font color="green"> 205.                          dictionary=_dictionary_undefined):</font>
<font color="red"> 206.         if context_instance is _context_instance_undefined:</font>
<font color="red"> 207.             context_instance = None</font>
<font color="black"> 208.         else:</font>
<font color="red"> 209.             warnings.warn(</font>
<font color="red"> 210.                 &quot;The context_instance argument of render_to_string is &quot;</font>
<font color="red"> 211.                 &quot;deprecated.&quot;, RemovedInDjango110Warning, stacklevel=3)</font>
<font color="red"> 212.         if dirs is _dirs_undefined:</font>
<font color="black"> 213.             # Do not set dirs to None here to avoid triggering the deprecation</font>
<font color="black"> 214.             # warning in select_template or get_template.</font>
<font color="red"> 215.             pass</font>
<font color="black"> 216.         else:</font>
<font color="red"> 217.             warnings.warn(</font>
<font color="red"> 218.                 &quot;The dirs argument of render_to_string is deprecated.&quot;,</font>
<font color="red"> 219.                 RemovedInDjango110Warning, stacklevel=3)</font>
<font color="red"> 220.         if dictionary is _dictionary_undefined:</font>
<font color="red"> 221.             dictionary = None</font>
<font color="black"> 222.         else:</font>
<font color="red"> 223.             warnings.warn(</font>
<font color="red"> 224.                 &quot;The dictionary argument of render_to_string was renamed to &quot;</font>
<font color="red"> 225.                 &quot;context.&quot;, RemovedInDjango110Warning, stacklevel=3)</font>
<font color="red"> 226.             context = dictionary</font>
<font color="black"> 227. </font>
<font color="red"> 228.         if isinstance(template_name, (list, tuple)):</font>
<font color="red"> 229.             t = self.select_template(template_name, dirs)</font>
<font color="black"> 230.         else:</font>
<font color="red"> 231.             t = self.get_template(template_name, dirs)</font>
<font color="red"> 232.         if not context_instance:</font>
<font color="black"> 233.             # Django &lt; 1.8 accepted a Context in `context` even though that's</font>
<font color="black"> 234.             # unintended. Preserve this ability but don't rewrap `context`.</font>
<font color="red"> 235.             if isinstance(context, Context):</font>
<font color="red"> 236.                 return t.render(context)</font>
<font color="black"> 237.             else:</font>
<font color="red"> 238.                 return t.render(Context(context))</font>
<font color="red"> 239.         if not context:</font>
<font color="red"> 240.             return t.render(context_instance)</font>
<font color="black"> 241.         # Add the context to the context stack, ensuring it gets removed again</font>
<font color="black"> 242.         # to keep the context_instance in the same state it started in.</font>
<font color="red"> 243.         with context_instance.push(context):</font>
<font color="red"> 244.             return t.render(context_instance)</font>
<font color="black"> 245. </font>
<font color="green"> 246.     def select_template(self, template_name_list, dirs=_dirs_undefined):</font>
<font color="black"> 247.         &quot;&quot;&quot;</font>
<font color="black"> 248.         Given a list of template names, returns the first that can be loaded.</font>
<font color="black"> 249.         &quot;&quot;&quot;</font>
<font color="red"> 250.         if dirs is _dirs_undefined:</font>
<font color="black"> 251.             # Do not set dirs to None here to avoid triggering the deprecation</font>
<font color="black"> 252.             # warning in get_template.</font>
<font color="red"> 253.             pass</font>
<font color="black"> 254.         else:</font>
<font color="red"> 255.             warnings.warn(</font>
<font color="red"> 256.                 &quot;The dirs argument of select_template is deprecated.&quot;,</font>
<font color="red"> 257.                 RemovedInDjango110Warning, stacklevel=3)</font>
<font color="black"> 258. </font>
<font color="red"> 259.         if not template_name_list:</font>
<font color="red"> 260.             raise TemplateDoesNotExist(&quot;No template names provided&quot;)</font>
<font color="red"> 261.         not_found = []</font>
<font color="red"> 262.         for template_name in template_name_list:</font>
<font color="red"> 263.             try:</font>
<font color="red"> 264.                 return self.get_template(template_name, dirs)</font>
<font color="red"> 265.             except TemplateDoesNotExist as exc:</font>
<font color="red"> 266.                 if exc.args[0] not in not_found:</font>
<font color="red"> 267.                     not_found.append(exc.args[0])</font>
<font color="red"> 268.                 continue</font>
<font color="black"> 269.         # If we get here, none of the templates could be loaded</font>
<font color="red"> 270.         raise TemplateDoesNotExist(', '.join(not_found))</font>
</pre>


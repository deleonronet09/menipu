source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/backends/sqlite3/creation.py</b><br>


file stats: <b>78 lines, 28 executed: 35.9% covered</b>
<pre>
<font color="green">   1. import os</font>
<font color="green">   2. import shutil</font>
<font color="green">   3. import sys</font>
<font color="black">   4. </font>
<font color="green">   5. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   6. from django.db.backends.base.creation import BaseDatabaseCreation</font>
<font color="green">   7. from django.utils.six.moves import input</font>
<font color="black">   8. </font>
<font color="black">   9. </font>
<font color="green">  10. class DatabaseCreation(BaseDatabaseCreation):</font>
<font color="black">  11. </font>
<font color="green">  12.     def _get_test_db_name(self):</font>
<font color="green">  13.         test_database_name = self.connection.settings_dict['TEST']['NAME']</font>
<font color="green">  14.         can_share_in_memory_db = self.connection.features.can_share_in_memory_db</font>
<font color="green">  15.         if test_database_name and test_database_name != ':memory:':</font>
<font color="red">  16.             if 'mode=memory' in test_database_name and not can_share_in_memory_db:</font>
<font color="red">  17.                 raise ImproperlyConfigured(</font>
<font color="red">  18.                     &quot;Using a shared memory database with `mode=memory` in the &quot;</font>
<font color="black">  19.                     &quot;database name is not supported in your environment, &quot;</font>
<font color="black">  20.                     &quot;use `:memory:` instead.&quot;</font>
<font color="black">  21.                 )</font>
<font color="red">  22.             return test_database_name</font>
<font color="green">  23.         if can_share_in_memory_db:</font>
<font color="red">  24.             return 'file:memorydb_%s?mode=memory&amp;cache=shared' % self.connection.alias</font>
<font color="green">  25.         return ':memory:'</font>
<font color="black">  26. </font>
<font color="green">  27.     def _create_test_db(self, verbosity, autoclobber, keepdb=False):</font>
<font color="green">  28.         test_database_name = self._get_test_db_name()</font>
<font color="black">  29. </font>
<font color="green">  30.         if keepdb:</font>
<font color="red">  31.             return test_database_name</font>
<font color="green">  32.         if not self.connection.is_in_memory_db(test_database_name):</font>
<font color="black">  33.             # Erase the old test database</font>
<font color="red">  34.             if verbosity &gt;= 1:</font>
<font color="red">  35.                 print(&quot;Destroying old test database for alias %s...&quot; % (</font>
<font color="red">  36.                     self._get_database_display_str(verbosity, test_database_name),</font>
<font color="black">  37.                 ))</font>
<font color="red">  38.             if os.access(test_database_name, os.F_OK):</font>
<font color="red">  39.                 if not autoclobber:</font>
<font color="red">  40.                     confirm = input(</font>
<font color="red">  41.                         &quot;Type 'yes' if you would like to try deleting the test &quot;</font>
<font color="red">  42.                         &quot;database '%s', or 'no' to cancel: &quot; % test_database_name</font>
<font color="black">  43.                     )</font>
<font color="red">  44.                 if autoclobber or confirm == 'yes':</font>
<font color="red">  45.                     try:</font>
<font color="red">  46.                         os.remove(test_database_name)</font>
<font color="red">  47.                     except Exception as e:</font>
<font color="red">  48.                         sys.stderr.write(&quot;Got an error deleting the old test database: %s\n&quot; % e)</font>
<font color="red">  49.                         sys.exit(2)</font>
<font color="black">  50.                 else:</font>
<font color="red">  51.                     print(&quot;Tests cancelled.&quot;)</font>
<font color="red">  52.                     sys.exit(1)</font>
<font color="green">  53.         return test_database_name</font>
<font color="black">  54. </font>
<font color="green">  55.     def get_test_db_clone_settings(self, number):</font>
<font color="red">  56.         orig_settings_dict = self.connection.settings_dict</font>
<font color="red">  57.         source_database_name = orig_settings_dict['NAME']</font>
<font color="red">  58.         if self.connection.is_in_memory_db(source_database_name):</font>
<font color="red">  59.             return orig_settings_dict</font>
<font color="black">  60.         else:</font>
<font color="red">  61.             new_settings_dict = orig_settings_dict.copy()</font>
<font color="red">  62.             root, ext = os.path.splitext(orig_settings_dict['NAME'])</font>
<font color="red">  63.             new_settings_dict['NAME'] = '{}_{}.{}'.format(root, number, ext)</font>
<font color="red">  64.             return new_settings_dict</font>
<font color="black">  65. </font>
<font color="green">  66.     def _clone_test_db(self, number, verbosity, keepdb=False):</font>
<font color="red">  67.         source_database_name = self.connection.settings_dict['NAME']</font>
<font color="red">  68.         target_database_name = self.get_test_db_clone_settings(number)['NAME']</font>
<font color="black">  69.         # Forking automatically makes a copy of an in-memory database.</font>
<font color="red">  70.         if not self.connection.is_in_memory_db(source_database_name):</font>
<font color="black">  71.             # Erase the old test database</font>
<font color="red">  72.             if os.access(target_database_name, os.F_OK):</font>
<font color="red">  73.                 if keepdb:</font>
<font color="red">  74.                     return</font>
<font color="red">  75.                 if verbosity &gt;= 1:</font>
<font color="red">  76.                     print(&quot;Destroying old test database for alias %s...&quot; % (</font>
<font color="red">  77.                         self._get_database_display_str(verbosity, target_database_name),</font>
<font color="black">  78.                     ))</font>
<font color="red">  79.                 try:</font>
<font color="red">  80.                     os.remove(target_database_name)</font>
<font color="red">  81.                 except Exception as e:</font>
<font color="red">  82.                     sys.stderr.write(&quot;Got an error deleting the old test database: %s\n&quot; % e)</font>
<font color="red">  83.                     sys.exit(2)</font>
<font color="red">  84.             try:</font>
<font color="red">  85.                 shutil.copy(source_database_name, target_database_name)</font>
<font color="red">  86.             except Exception as e:</font>
<font color="red">  87.                 sys.stderr.write(&quot;Got an error cloning the test database: %s\n&quot; % e)</font>
<font color="red">  88.                 sys.exit(2)</font>
<font color="black">  89. </font>
<font color="green">  90.     def _destroy_test_db(self, test_database_name, verbosity):</font>
<font color="green">  91.         if test_database_name and not self.connection.is_in_memory_db(test_database_name):</font>
<font color="black">  92.             # Remove the SQLite database file</font>
<font color="red">  93.             os.remove(test_database_name)</font>
<font color="black">  94. </font>
<font color="green">  95.     def test_db_signature(self):</font>
<font color="black">  96.         &quot;&quot;&quot;</font>
<font color="black">  97.         Returns a tuple that uniquely identifies a test database.</font>
<font color="black">  98. </font>
<font color="black">  99.         This takes into account the special cases of &quot;:memory:&quot; and &quot;&quot; for</font>
<font color="black"> 100.         SQLite since the databases will be distinct despite having the same</font>
<font color="black"> 101.         TEST NAME. See http://www.sqlite.org/inmemorydb.html</font>
<font color="black"> 102.         &quot;&quot;&quot;</font>
<font color="green"> 103.         test_database_name = self._get_test_db_name()</font>
<font color="green"> 104.         sig = [self.connection.settings_dict['NAME']]</font>
<font color="green"> 105.         if self.connection.is_in_memory_db(test_database_name):</font>
<font color="green"> 106.             sig.append(self.connection.alias)</font>
<font color="green"> 107.         return tuple(sig)</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/log.py</b><br>


file stats: <b>95 lines, 61 executed: 64.2% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import logging</font>
<font color="green">   4. import logging.config  # needed when logging_config doesn't start with logging.config</font>
<font color="green">   5. import sys</font>
<font color="green">   6. import warnings</font>
<font color="green">   7. from copy import copy</font>
<font color="black">   8. </font>
<font color="green">   9. from django.conf import settings</font>
<font color="green">  10. from django.core import mail</font>
<font color="green">  11. from django.core.mail import get_connection</font>
<font color="green">  12. from django.utils.deprecation import RemovedInNextVersionWarning</font>
<font color="green">  13. from django.utils.module_loading import import_string</font>
<font color="green">  14. from django.views.debug import ExceptionReporter</font>
<font color="black">  15. </font>
<font color="black">  16. # Default logging for Django. This sends an email to the site admins on every</font>
<font color="black">  17. # HTTP 500 error. Depending on DEBUG, all other log records are either sent to</font>
<font color="black">  18. # the console (DEBUG=True) or discarded (DEBUG=False) by means of the</font>
<font color="black">  19. # require_debug_true filter.</font>
<font color="green">  20. DEFAULT_LOGGING = {</font>
<font color="green">  21.     'version': 1,</font>
<font color="green">  22.     'disable_existing_loggers': False,</font>
<font color="green">  23.     'filters': {</font>
<font color="green">  24.         'require_debug_false': {</font>
<font color="green">  25.             '()': 'django.utils.log.RequireDebugFalse',</font>
<font color="black">  26.         },</font>
<font color="green">  27.         'require_debug_true': {</font>
<font color="green">  28.             '()': 'django.utils.log.RequireDebugTrue',</font>
<font color="black">  29.         },</font>
<font color="black">  30.     },</font>
<font color="green">  31.     'handlers': {</font>
<font color="green">  32.         'console': {</font>
<font color="green">  33.             'level': 'INFO',</font>
<font color="green">  34.             'filters': ['require_debug_true'],</font>
<font color="green">  35.             'class': 'logging.StreamHandler',</font>
<font color="black">  36.         },</font>
<font color="green">  37.         'mail_admins': {</font>
<font color="green">  38.             'level': 'ERROR',</font>
<font color="green">  39.             'filters': ['require_debug_false'],</font>
<font color="green">  40.             'class': 'django.utils.log.AdminEmailHandler'</font>
<font color="black">  41.         }</font>
<font color="black">  42.     },</font>
<font color="green">  43.     'loggers': {</font>
<font color="green">  44.         'django': {</font>
<font color="green">  45.             'handlers': ['console', 'mail_admins'],</font>
<font color="green">  46.             'level': 'INFO',</font>
<font color="black">  47.         },</font>
<font color="green">  48.         'py.warnings': {</font>
<font color="green">  49.             'handlers': ['console'],</font>
<font color="black">  50.         },</font>
<font color="black">  51.     }</font>
<font color="black">  52. }</font>
<font color="black">  53. </font>
<font color="black">  54. </font>
<font color="green">  55. def configure_logging(logging_config, logging_settings):</font>
<font color="green">  56.     if not sys.warnoptions:</font>
<font color="black">  57.         # Route warnings through python logging</font>
<font color="green">  58.         logging.captureWarnings(True)</font>
<font color="black">  59.         # RemovedInNextVersionWarning is a subclass of DeprecationWarning which</font>
<font color="black">  60.         # is hidden by default, hence we force the &quot;default&quot; behavior</font>
<font color="green">  61.         warnings.simplefilter(&quot;default&quot;, RemovedInNextVersionWarning)</font>
<font color="black">  62. </font>
<font color="green">  63.     if logging_config:</font>
<font color="black">  64.         # First find the logging configuration function ...</font>
<font color="green">  65.         logging_config_func = import_string(logging_config)</font>
<font color="black">  66. </font>
<font color="green">  67.         logging.config.dictConfig(DEFAULT_LOGGING)</font>
<font color="black">  68. </font>
<font color="black">  69.         # ... then invoke it with the logging settings</font>
<font color="green">  70.         if logging_settings:</font>
<font color="red">  71.             logging_config_func(logging_settings)</font>
<font color="black">  72. </font>
<font color="black">  73. </font>
<font color="green">  74. class AdminEmailHandler(logging.Handler):</font>
<font color="black">  75.     &quot;&quot;&quot;An exception log handler that emails log entries to site admins.</font>
<font color="black">  76. </font>
<font color="black">  77.     If the request is passed as the first argument to the log record,</font>
<font color="black">  78.     request data will be provided in the email report.</font>
<font color="green">  79.     &quot;&quot;&quot;</font>
<font color="black">  80. </font>
<font color="green">  81.     def __init__(self, include_html=False, email_backend=None):</font>
<font color="green">  82.         logging.Handler.__init__(self)</font>
<font color="green">  83.         self.include_html = include_html</font>
<font color="green">  84.         self.email_backend = email_backend</font>
<font color="black">  85. </font>
<font color="green">  86.     def emit(self, record):</font>
<font color="red">  87.         try:</font>
<font color="red">  88.             request = record.request</font>
<font color="red">  89.             subject = '%s (%s IP): %s' % (</font>
<font color="red">  90.                 record.levelname,</font>
<font color="red">  91.                 ('internal' if request.META.get('REMOTE_ADDR') in settings.INTERNAL_IPS</font>
<font color="red">  92.                  else 'EXTERNAL'),</font>
<font color="red">  93.                 record.getMessage()</font>
<font color="black">  94.             )</font>
<font color="red">  95.         except Exception:</font>
<font color="red">  96.             subject = '%s: %s' % (</font>
<font color="red">  97.                 record.levelname,</font>
<font color="red">  98.                 record.getMessage()</font>
<font color="black">  99.             )</font>
<font color="red"> 100.             request = None</font>
<font color="red"> 101.         subject = self.format_subject(subject)</font>
<font color="black"> 102. </font>
<font color="black"> 103.         # Since we add a nicely formatted traceback on our own, create a copy</font>
<font color="black"> 104.         # of the log record without the exception data.</font>
<font color="red"> 105.         no_exc_record = copy(record)</font>
<font color="red"> 106.         no_exc_record.exc_info = None</font>
<font color="red"> 107.         no_exc_record.exc_text = None</font>
<font color="black"> 108. </font>
<font color="red"> 109.         if record.exc_info:</font>
<font color="red"> 110.             exc_info = record.exc_info</font>
<font color="black"> 111.         else:</font>
<font color="red"> 112.             exc_info = (None, record.getMessage(), None)</font>
<font color="black"> 113. </font>
<font color="red"> 114.         reporter = ExceptionReporter(request, is_email=True, *exc_info)</font>
<font color="red"> 115.         message = &quot;%s\n\n%s&quot; % (self.format(no_exc_record), reporter.get_traceback_text())</font>
<font color="red"> 116.         html_message = reporter.get_traceback_html() if self.include_html else None</font>
<font color="red"> 117.         self.send_mail(subject, message, fail_silently=True, html_message=html_message)</font>
<font color="black"> 118. </font>
<font color="green"> 119.     def send_mail(self, subject, message, *args, **kwargs):</font>
<font color="red"> 120.         mail.mail_admins(subject, message, *args, connection=self.connection(), **kwargs)</font>
<font color="black"> 121. </font>
<font color="green"> 122.     def connection(self):</font>
<font color="red"> 123.         return get_connection(backend=self.email_backend, fail_silently=True)</font>
<font color="black"> 124. </font>
<font color="green"> 125.     def format_subject(self, subject):</font>
<font color="black"> 126.         &quot;&quot;&quot;</font>
<font color="black"> 127.         Escape CR and LF characters, and limit length.</font>
<font color="black"> 128.         RFC 2822's hard limit is 998 characters per line. So, minus &quot;Subject: &quot;</font>
<font color="black"> 129.         the actual subject must be no longer than 989 characters.</font>
<font color="black"> 130.         &quot;&quot;&quot;</font>
<font color="red"> 131.         formatted_subject = subject.replace('\n', '\\n').replace('\r', '\\r')</font>
<font color="red"> 132.         return formatted_subject[:989]</font>
<font color="black"> 133. </font>
<font color="black"> 134. </font>
<font color="green"> 135. class CallbackFilter(logging.Filter):</font>
<font color="black"> 136.     &quot;&quot;&quot;</font>
<font color="black"> 137.     A logging filter that checks the return value of a given callable (which</font>
<font color="black"> 138.     takes the record-to-be-logged as its only parameter) to decide whether to</font>
<font color="black"> 139.     log a record.</font>
<font color="green"> 140.     &quot;&quot;&quot;</font>
<font color="green"> 141.     def __init__(self, callback):</font>
<font color="red"> 142.         self.callback = callback</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def filter(self, record):</font>
<font color="red"> 145.         if self.callback(record):</font>
<font color="red"> 146.             return 1</font>
<font color="red"> 147.         return 0</font>
<font color="black"> 148. </font>
<font color="black"> 149. </font>
<font color="green"> 150. class RequireDebugFalse(logging.Filter):</font>
<font color="green"> 151.     def filter(self, record):</font>
<font color="red"> 152.         return not settings.DEBUG</font>
<font color="black"> 153. </font>
<font color="black"> 154. </font>
<font color="green"> 155. class RequireDebugTrue(logging.Filter):</font>
<font color="green"> 156.     def filter(self, record):</font>
<font color="red"> 157.         return settings.DEBUG</font>
</pre>


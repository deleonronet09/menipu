source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/serializers/__init__.py</b><br>


file stats: <b>118 lines, 91 executed: 77.1% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Interfaces for serializing Django objects.</font>
<font color="black">   3. </font>
<font color="black">   4. Usage::</font>
<font color="black">   5. </font>
<font color="black">   6.     from django.core import serializers</font>
<font color="black">   7.     json = serializers.serialize(&quot;json&quot;, some_queryset)</font>
<font color="black">   8.     objects = list(serializers.deserialize(&quot;json&quot;, json))</font>
<font color="black">   9. </font>
<font color="black">  10. To add your own serializers, use the SERIALIZATION_MODULES setting::</font>
<font color="black">  11. </font>
<font color="black">  12.     SERIALIZATION_MODULES = {</font>
<font color="black">  13.         &quot;csv&quot;: &quot;path.to.csv.serializer&quot;,</font>
<font color="black">  14.         &quot;txt&quot;: &quot;path.to.txt.serializer&quot;,</font>
<font color="black">  15.     }</font>
<font color="black">  16. </font>
<font color="green">  17. &quot;&quot;&quot;</font>
<font color="black">  18. </font>
<font color="green">  19. import importlib</font>
<font color="black">  20. </font>
<font color="green">  21. from django.apps import apps</font>
<font color="green">  22. from django.conf import settings</font>
<font color="green">  23. from django.core.serializers.base import SerializerDoesNotExist</font>
<font color="green">  24. from django.utils import six</font>
<font color="black">  25. </font>
<font color="black">  26. # Built-in serializers</font>
<font color="green">  27. BUILTIN_SERIALIZERS = {</font>
<font color="green">  28.     &quot;xml&quot;: &quot;django.core.serializers.xml_serializer&quot;,</font>
<font color="green">  29.     &quot;python&quot;: &quot;django.core.serializers.python&quot;,</font>
<font color="green">  30.     &quot;json&quot;: &quot;django.core.serializers.json&quot;,</font>
<font color="green">  31.     &quot;yaml&quot;: &quot;django.core.serializers.pyyaml&quot;,</font>
<font color="black">  32. }</font>
<font color="black">  33. </font>
<font color="green">  34. _serializers = {}</font>
<font color="black">  35. </font>
<font color="black">  36. </font>
<font color="green">  37. class BadSerializer(object):</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="black">  39.     Stub serializer to hold exception raised during registration</font>
<font color="black">  40. </font>
<font color="black">  41.     This allows the serializer registration to cache serializers and if there</font>
<font color="black">  42.     is an error raised in the process of creating a serializer it will be</font>
<font color="black">  43.     raised and passed along to the caller when the serializer is used.</font>
<font color="green">  44.     &quot;&quot;&quot;</font>
<font color="green">  45.     internal_use_only = False</font>
<font color="black">  46. </font>
<font color="green">  47.     def __init__(self, exception):</font>
<font color="green">  48.         self.exception = exception</font>
<font color="black">  49. </font>
<font color="green">  50.     def __call__(self, *args, **kwargs):</font>
<font color="red">  51.         raise self.exception</font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="green">  54. def register_serializer(format, serializer_module, serializers=None):</font>
<font color="black">  55.     &quot;&quot;&quot;Register a new serializer.</font>
<font color="black">  56. </font>
<font color="black">  57.     ``serializer_module`` should be the fully qualified module name</font>
<font color="black">  58.     for the serializer.</font>
<font color="black">  59. </font>
<font color="black">  60.     If ``serializers`` is provided, the registration will be added</font>
<font color="black">  61.     to the provided dictionary.</font>
<font color="black">  62. </font>
<font color="black">  63.     If ``serializers`` is not provided, the registration will be made</font>
<font color="black">  64.     directly into the global register of serializers. Adding serializers</font>
<font color="black">  65.     directly is not a thread-safe operation.</font>
<font color="black">  66.     &quot;&quot;&quot;</font>
<font color="green">  67.     if serializers is None and not _serializers:</font>
<font color="red">  68.         _load_serializers()</font>
<font color="black">  69. </font>
<font color="green">  70.     try:</font>
<font color="green">  71.         module = importlib.import_module(serializer_module)</font>
<font color="green">  72.     except ImportError as exc:</font>
<font color="green">  73.         bad_serializer = BadSerializer(exc)</font>
<font color="black">  74. </font>
<font color="green">  75.         module = type('BadSerializerModule', (object,), {</font>
<font color="green">  76.             'Deserializer': bad_serializer,</font>
<font color="green">  77.             'Serializer': bad_serializer,</font>
<font color="black">  78.         })</font>
<font color="black">  79. </font>
<font color="green">  80.     if serializers is None:</font>
<font color="red">  81.         _serializers[format] = module</font>
<font color="black">  82.     else:</font>
<font color="green">  83.         serializers[format] = module</font>
<font color="black">  84. </font>
<font color="black">  85. </font>
<font color="green">  86. def unregister_serializer(format):</font>
<font color="black">  87.     &quot;Unregister a given serializer. This is not a thread-safe operation.&quot;</font>
<font color="red">  88.     if not _serializers:</font>
<font color="red">  89.         _load_serializers()</font>
<font color="red">  90.     if format not in _serializers:</font>
<font color="red">  91.         raise SerializerDoesNotExist(format)</font>
<font color="red">  92.     del _serializers[format]</font>
<font color="black">  93. </font>
<font color="black">  94. </font>
<font color="green">  95. def get_serializer(format):</font>
<font color="green">  96.     if not _serializers:</font>
<font color="green">  97.         _load_serializers()</font>
<font color="green">  98.     if format not in _serializers:</font>
<font color="red">  99.         raise SerializerDoesNotExist(format)</font>
<font color="green"> 100.     return _serializers[format].Serializer</font>
<font color="black"> 101. </font>
<font color="black"> 102. </font>
<font color="green"> 103. def get_serializer_formats():</font>
<font color="red"> 104.     if not _serializers:</font>
<font color="red"> 105.         _load_serializers()</font>
<font color="red"> 106.     return list(_serializers)</font>
<font color="black"> 107. </font>
<font color="black"> 108. </font>
<font color="green"> 109. def get_public_serializer_formats():</font>
<font color="red"> 110.     if not _serializers:</font>
<font color="red"> 111.         _load_serializers()</font>
<font color="red"> 112.     return [k for k, v in six.iteritems(_serializers) if not v.Serializer.internal_use_only]</font>
<font color="black"> 113. </font>
<font color="black"> 114. </font>
<font color="green"> 115. def get_deserializer(format):</font>
<font color="red"> 116.     if not _serializers:</font>
<font color="red"> 117.         _load_serializers()</font>
<font color="red"> 118.     if format not in _serializers:</font>
<font color="red"> 119.         raise SerializerDoesNotExist(format)</font>
<font color="red"> 120.     return _serializers[format].Deserializer</font>
<font color="black"> 121. </font>
<font color="black"> 122. </font>
<font color="green"> 123. def serialize(format, queryset, **options):</font>
<font color="black"> 124.     &quot;&quot;&quot;</font>
<font color="black"> 125.     Serialize a queryset (or any iterator that returns database objects) using</font>
<font color="black"> 126.     a certain serializer.</font>
<font color="black"> 127.     &quot;&quot;&quot;</font>
<font color="green"> 128.     s = get_serializer(format)()</font>
<font color="green"> 129.     s.serialize(queryset, **options)</font>
<font color="green"> 130.     return s.getvalue()</font>
<font color="black"> 131. </font>
<font color="black"> 132. </font>
<font color="green"> 133. def deserialize(format, stream_or_string, **options):</font>
<font color="black"> 134.     &quot;&quot;&quot;</font>
<font color="black"> 135.     Deserialize a stream or a string. Returns an iterator that yields ``(obj,</font>
<font color="black"> 136.     m2m_relation_dict)``, where ``obj`` is an instantiated -- but *unsaved* --</font>
<font color="black"> 137.     object, and ``m2m_relation_dict`` is a dictionary of ``{m2m_field_name :</font>
<font color="black"> 138.     list_of_related_objects}``.</font>
<font color="black"> 139.     &quot;&quot;&quot;</font>
<font color="red"> 140.     d = get_deserializer(format)</font>
<font color="red"> 141.     return d(stream_or_string, **options)</font>
<font color="black"> 142. </font>
<font color="black"> 143. </font>
<font color="green"> 144. def _load_serializers():</font>
<font color="black"> 145.     &quot;&quot;&quot;</font>
<font color="black"> 146.     Register built-in and settings-defined serializers. This is done lazily so</font>
<font color="black"> 147.     that user code has a chance to (e.g.) set up custom settings without</font>
<font color="black"> 148.     needing to be careful of import order.</font>
<font color="black"> 149.     &quot;&quot;&quot;</font>
<font color="black"> 150.     global _serializers</font>
<font color="green"> 151.     serializers = {}</font>
<font color="green"> 152.     for format in BUILTIN_SERIALIZERS:</font>
<font color="green"> 153.         register_serializer(format, BUILTIN_SERIALIZERS[format], serializers)</font>
<font color="green"> 154.     if hasattr(settings, &quot;SERIALIZATION_MODULES&quot;):</font>
<font color="red"> 155.         for format in settings.SERIALIZATION_MODULES:</font>
<font color="red"> 156.             register_serializer(format, settings.SERIALIZATION_MODULES[format], serializers)</font>
<font color="green"> 157.     _serializers = serializers</font>
<font color="black"> 158. </font>
<font color="black"> 159. </font>
<font color="green"> 160. def sort_dependencies(app_list):</font>
<font color="black"> 161.     &quot;&quot;&quot;Sort a list of (app_config, models) pairs into a single list of models.</font>
<font color="black"> 162. </font>
<font color="black"> 163.     The single list of models is sorted so that any model with a natural key</font>
<font color="black"> 164.     is serialized before a normal model, and any model with a natural key</font>
<font color="black"> 165.     dependency has it's dependencies serialized first.</font>
<font color="black"> 166.     &quot;&quot;&quot;</font>
<font color="black"> 167.     # Process the list of models, and get the list of dependencies</font>
<font color="green"> 168.     model_dependencies = []</font>
<font color="green"> 169.     models = set()</font>
<font color="green"> 170.     for app_config, model_list in app_list:</font>
<font color="green"> 171.         if model_list is None:</font>
<font color="green"> 172.             model_list = app_config.get_models()</font>
<font color="black"> 173. </font>
<font color="green"> 174.         for model in model_list:</font>
<font color="green"> 175.             models.add(model)</font>
<font color="black"> 176.             # Add any explicitly defined dependencies</font>
<font color="green"> 177.             if hasattr(model, 'natural_key'):</font>
<font color="green"> 178.                 deps = getattr(model.natural_key, 'dependencies', [])</font>
<font color="green"> 179.                 if deps:</font>
<font color="green"> 180.                     deps = [apps.get_model(dep) for dep in deps]</font>
<font color="black"> 181.             else:</font>
<font color="green"> 182.                 deps = []</font>
<font color="black"> 183. </font>
<font color="black"> 184.             # Now add a dependency for any FK relation with a model that</font>
<font color="black"> 185.             # defines a natural key</font>
<font color="green"> 186.             for field in model._meta.fields:</font>
<font color="green"> 187.                 if field.remote_field:</font>
<font color="green"> 188.                     rel_model = field.remote_field.model</font>
<font color="green"> 189.                     if hasattr(rel_model, 'natural_key') and rel_model != model:</font>
<font color="green"> 190.                         deps.append(rel_model)</font>
<font color="black"> 191.             # Also add a dependency for any simple M2M relation with a model</font>
<font color="black"> 192.             # that defines a natural key.  M2M relations with explicit through</font>
<font color="black"> 193.             # models don't count as dependencies.</font>
<font color="green"> 194.             for field in model._meta.many_to_many:</font>
<font color="green"> 195.                 if field.remote_field.through._meta.auto_created:</font>
<font color="green"> 196.                     rel_model = field.remote_field.model</font>
<font color="green"> 197.                     if hasattr(rel_model, 'natural_key') and rel_model != model:</font>
<font color="green"> 198.                         deps.append(rel_model)</font>
<font color="green"> 199.             model_dependencies.append((model, deps))</font>
<font color="black"> 200. </font>
<font color="green"> 201.     model_dependencies.reverse()</font>
<font color="black"> 202.     # Now sort the models to ensure that dependencies are met. This</font>
<font color="black"> 203.     # is done by repeatedly iterating over the input list of models.</font>
<font color="black"> 204.     # If all the dependencies of a given model are in the final list,</font>
<font color="black"> 205.     # that model is promoted to the end of the final list. This process</font>
<font color="black"> 206.     # continues until the input list is empty, or we do a full iteration</font>
<font color="black"> 207.     # over the input models without promoting a model to the final list.</font>
<font color="black"> 208.     # If we do a full iteration without a promotion, that means there are</font>
<font color="black"> 209.     # circular dependencies in the list.</font>
<font color="green"> 210.     model_list = []</font>
<font color="green"> 211.     while model_dependencies:</font>
<font color="green"> 212.         skipped = []</font>
<font color="green"> 213.         changed = False</font>
<font color="green"> 214.         while model_dependencies:</font>
<font color="green"> 215.             model, deps = model_dependencies.pop()</font>
<font color="black"> 216. </font>
<font color="black"> 217.             # If all of the models in the dependency list are either already</font>
<font color="black"> 218.             # on the final model list, or not on the original serialization list,</font>
<font color="black"> 219.             # then we've found another model with all it's dependencies satisfied.</font>
<font color="green"> 220.             found = True</font>
<font color="green"> 221.             for candidate in ((d not in models or d in model_list) for d in deps):</font>
<font color="green"> 222.                 if not candidate:</font>
<font color="green"> 223.                     found = False</font>
<font color="green"> 224.             if found:</font>
<font color="green"> 225.                 model_list.append(model)</font>
<font color="green"> 226.                 changed = True</font>
<font color="black"> 227.             else:</font>
<font color="green"> 228.                 skipped.append((model, deps))</font>
<font color="green"> 229.         if not changed:</font>
<font color="red"> 230.             raise RuntimeError(&quot;Can't resolve dependencies for %s in serialized app list.&quot; %</font>
<font color="red"> 231.                 ', '.join('%s.%s' % (model._meta.app_label, model._meta.object_name)</font>
<font color="red"> 232.                 for model, deps in sorted(skipped, key=lambda obj: obj[0].__name__))</font>
<font color="black"> 233.             )</font>
<font color="green"> 234.         model_dependencies = skipped</font>
<font color="black"> 235. </font>
<font color="green"> 236.     return model_list</font>
</pre>


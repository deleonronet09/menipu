source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/contenttypes/fields.py</b><br>


file stats: <b>405 lines, 71 executed: 17.5% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from collections import defaultdict</font>
<font color="black">   4. </font>
<font color="green">   5. from django.contrib.contenttypes.models import ContentType</font>
<font color="green">   6. from django.core import checks</font>
<font color="green">   7. from django.core.exceptions import FieldDoesNotExist, ObjectDoesNotExist</font>
<font color="green">   8. from django.db import DEFAULT_DB_ALIAS, models, router, transaction</font>
<font color="green">   9. from django.db.models import DO_NOTHING, signals</font>
<font color="green">  10. from django.db.models.base import ModelBase, make_foreign_order_accessors</font>
<font color="green">  11. from django.db.models.fields.related import (</font>
<font color="black">  12.     ForeignObject, ForeignObjectRel, ReverseManyToOneDescriptor,</font>
<font color="black">  13.     lazy_related_operation,</font>
<font color="black">  14. )</font>
<font color="green">  15. from django.db.models.query_utils import PathInfo</font>
<font color="green">  16. from django.utils.encoding import python_2_unicode_compatible, smart_text</font>
<font color="green">  17. from django.utils.functional import cached_property</font>
<font color="black">  18. </font>
<font color="black">  19. </font>
<font color="green">  20. @python_2_unicode_compatible</font>
<font color="green">  21. class GenericForeignKey(object):</font>
<font color="black">  22.     &quot;&quot;&quot;</font>
<font color="black">  23.     Provide a generic many-to-one relation through the ``content_type`` and</font>
<font color="black">  24.     ``object_id`` fields.</font>
<font color="black">  25. </font>
<font color="black">  26.     This class also doubles as an accessor to the related object (similar to</font>
<font color="black">  27.     ForwardManyToOneDescriptor) by adding itself as a model attribute.</font>
<font color="green">  28.     &quot;&quot;&quot;</font>
<font color="black">  29. </font>
<font color="black">  30.     # Field flags</font>
<font color="green">  31.     auto_created = False</font>
<font color="green">  32.     concrete = False</font>
<font color="green">  33.     editable = False</font>
<font color="green">  34.     hidden = False</font>
<font color="black">  35. </font>
<font color="green">  36.     is_relation = True</font>
<font color="green">  37.     many_to_many = False</font>
<font color="green">  38.     many_to_one = True</font>
<font color="green">  39.     one_to_many = False</font>
<font color="green">  40.     one_to_one = False</font>
<font color="green">  41.     related_model = None</font>
<font color="green">  42.     remote_field = None</font>
<font color="black">  43. </font>
<font color="green">  44.     def __init__(self, ct_field='content_type', fk_field='object_id', for_concrete_model=True):</font>
<font color="red">  45.         self.ct_field = ct_field</font>
<font color="red">  46.         self.fk_field = fk_field</font>
<font color="red">  47.         self.for_concrete_model = for_concrete_model</font>
<font color="red">  48.         self.editable = False</font>
<font color="red">  49.         self.rel = None</font>
<font color="red">  50.         self.column = None</font>
<font color="black">  51. </font>
<font color="green">  52.     def contribute_to_class(self, cls, name, **kwargs):</font>
<font color="red">  53.         self.name = name</font>
<font color="red">  54.         self.model = cls</font>
<font color="red">  55.         self.cache_attr = &quot;_%s_cache&quot; % name</font>
<font color="red">  56.         cls._meta.add_field(self, virtual=True)</font>
<font color="black">  57. </font>
<font color="black">  58.         # Only run pre-initialization field assignment on non-abstract models</font>
<font color="red">  59.         if not cls._meta.abstract:</font>
<font color="red">  60.             signals.pre_init.connect(self.instance_pre_init, sender=cls)</font>
<font color="black">  61. </font>
<font color="red">  62.         setattr(cls, name, self)</font>
<font color="black">  63. </font>
<font color="green">  64.     def get_filter_kwargs_for_object(self, obj):</font>
<font color="black">  65.         &quot;&quot;&quot;See corresponding method on Field&quot;&quot;&quot;</font>
<font color="red">  66.         return {</font>
<font color="red">  67.             self.fk_field: getattr(obj, self.fk_field),</font>
<font color="red">  68.             self.ct_field: getattr(obj, self.ct_field),</font>
<font color="black">  69.         }</font>
<font color="black">  70. </font>
<font color="green">  71.     def get_forward_related_filter(self, obj):</font>
<font color="black">  72.         &quot;&quot;&quot;See corresponding method on RelatedField&quot;&quot;&quot;</font>
<font color="red">  73.         return {</font>
<font color="red">  74.             self.fk_field: obj.pk,</font>
<font color="red">  75.             self.ct_field: ContentType.objects.get_for_model(obj).pk,</font>
<font color="black">  76.         }</font>
<font color="black">  77. </font>
<font color="green">  78.     def __str__(self):</font>
<font color="red">  79.         model = self.model</font>
<font color="red">  80.         app = model._meta.app_label</font>
<font color="red">  81.         return '%s.%s.%s' % (app, model._meta.object_name, self.name)</font>
<font color="black">  82. </font>
<font color="green">  83.     def check(self, **kwargs):</font>
<font color="red">  84.         errors = []</font>
<font color="red">  85.         errors.extend(self._check_field_name())</font>
<font color="red">  86.         errors.extend(self._check_object_id_field())</font>
<font color="red">  87.         errors.extend(self._check_content_type_field())</font>
<font color="red">  88.         return errors</font>
<font color="black">  89. </font>
<font color="green">  90.     def _check_field_name(self):</font>
<font color="red">  91.         if self.name.endswith(&quot;_&quot;):</font>
<font color="black">  92.             return [</font>
<font color="red">  93.                 checks.Error(</font>
<font color="red">  94.                     'Field names must not end with an underscore.',</font>
<font color="red">  95.                     hint=None,</font>
<font color="red">  96.                     obj=self,</font>
<font color="red">  97.                     id='fields.E001',</font>
<font color="black">  98.                 )</font>
<font color="black">  99.             ]</font>
<font color="black"> 100.         else:</font>
<font color="red"> 101.             return []</font>
<font color="black"> 102. </font>
<font color="green"> 103.     def _check_object_id_field(self):</font>
<font color="red"> 104.         try:</font>
<font color="red"> 105.             self.model._meta.get_field(self.fk_field)</font>
<font color="red"> 106.         except FieldDoesNotExist:</font>
<font color="black"> 107.             return [</font>
<font color="red"> 108.                 checks.Error(</font>
<font color="red"> 109.                     &quot;The GenericForeignKey object ID references the non-existent field '%s'.&quot; % self.fk_field,</font>
<font color="red"> 110.                     hint=None,</font>
<font color="red"> 111.                     obj=self,</font>
<font color="red"> 112.                     id='contenttypes.E001',</font>
<font color="black"> 113.                 )</font>
<font color="black"> 114.             ]</font>
<font color="black"> 115.         else:</font>
<font color="red"> 116.             return []</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def _check_content_type_field(self):</font>
<font color="black"> 119.         &quot;&quot;&quot;</font>
<font color="black"> 120.         Check if field named `field_name` in model `model` exists and is a</font>
<font color="black"> 121.         valid content_type field (is a ForeignKey to ContentType).</font>
<font color="black"> 122.         &quot;&quot;&quot;</font>
<font color="red"> 123.         try:</font>
<font color="red"> 124.             field = self.model._meta.get_field(self.ct_field)</font>
<font color="red"> 125.         except FieldDoesNotExist:</font>
<font color="black"> 126.             return [</font>
<font color="red"> 127.                 checks.Error(</font>
<font color="red"> 128.                     &quot;The GenericForeignKey content type references the non-existent field '%s.%s'.&quot; % (</font>
<font color="red"> 129.                         self.model._meta.object_name, self.ct_field</font>
<font color="black"> 130.                     ),</font>
<font color="red"> 131.                     hint=None,</font>
<font color="red"> 132.                     obj=self,</font>
<font color="red"> 133.                     id='contenttypes.E002',</font>
<font color="black"> 134.                 )</font>
<font color="black"> 135.             ]</font>
<font color="black"> 136.         else:</font>
<font color="red"> 137.             if not isinstance(field, models.ForeignKey):</font>
<font color="black"> 138.                 return [</font>
<font color="red"> 139.                     checks.Error(</font>
<font color="red"> 140.                         &quot;'%s.%s' is not a ForeignKey.&quot; % (</font>
<font color="red"> 141.                             self.model._meta.object_name, self.ct_field</font>
<font color="black"> 142.                         ),</font>
<font color="black"> 143.                         hint=(</font>
<font color="red"> 144.                             &quot;GenericForeignKeys must use a ForeignKey to &quot;</font>
<font color="black"> 145.                             &quot;'contenttypes.ContentType' as the 'content_type' field.&quot;</font>
<font color="black"> 146.                         ),</font>
<font color="red"> 147.                         obj=self,</font>
<font color="red"> 148.                         id='contenttypes.E003',</font>
<font color="black"> 149.                     )</font>
<font color="black"> 150.                 ]</font>
<font color="red"> 151.             elif field.remote_field.model != ContentType:</font>
<font color="black"> 152.                 return [</font>
<font color="red"> 153.                     checks.Error(</font>
<font color="red"> 154.                         &quot;'%s.%s' is not a ForeignKey to 'contenttypes.ContentType'.&quot; % (</font>
<font color="red"> 155.                             self.model._meta.object_name, self.ct_field</font>
<font color="black"> 156.                         ),</font>
<font color="black"> 157.                         hint=(</font>
<font color="red"> 158.                             &quot;GenericForeignKeys must use a ForeignKey to &quot;</font>
<font color="black"> 159.                             &quot;'contenttypes.ContentType' as the 'content_type' field.&quot;</font>
<font color="black"> 160.                         ),</font>
<font color="red"> 161.                         obj=self,</font>
<font color="red"> 162.                         id='contenttypes.E004',</font>
<font color="black"> 163.                     )</font>
<font color="black"> 164.                 ]</font>
<font color="black"> 165.             else:</font>
<font color="red"> 166.                 return []</font>
<font color="black"> 167. </font>
<font color="green"> 168.     def instance_pre_init(self, signal, sender, args, kwargs, **_kwargs):</font>
<font color="black"> 169.         &quot;&quot;&quot;</font>
<font color="black"> 170.         Handle initializing an object with the generic FK instead of</font>
<font color="black"> 171.         content_type and object_id fields.</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="red"> 173.         if self.name in kwargs:</font>
<font color="red"> 174.             value = kwargs.pop(self.name)</font>
<font color="red"> 175.             if value is not None:</font>
<font color="red"> 176.                 kwargs[self.ct_field] = self.get_content_type(obj=value)</font>
<font color="red"> 177.                 kwargs[self.fk_field] = value._get_pk_val()</font>
<font color="black"> 178.             else:</font>
<font color="red"> 179.                 kwargs[self.ct_field] = None</font>
<font color="red"> 180.                 kwargs[self.fk_field] = None</font>
<font color="black"> 181. </font>
<font color="green"> 182.     def get_content_type(self, obj=None, id=None, using=None):</font>
<font color="red"> 183.         if obj is not None:</font>
<font color="red"> 184.             return ContentType.objects.db_manager(obj._state.db).get_for_model(</font>
<font color="red"> 185.                 obj, for_concrete_model=self.for_concrete_model)</font>
<font color="red"> 186.         elif id is not None:</font>
<font color="red"> 187.             return ContentType.objects.db_manager(using).get_for_id(id)</font>
<font color="black"> 188.         else:</font>
<font color="black"> 189.             # This should never happen. I love comments like this, don't you?</font>
<font color="red"> 190.             raise Exception(&quot;Impossible arguments to GFK.get_content_type!&quot;)</font>
<font color="black"> 191. </font>
<font color="green"> 192.     def get_prefetch_queryset(self, instances, queryset=None):</font>
<font color="red"> 193.         if queryset is not None:</font>
<font color="red"> 194.             raise ValueError(&quot;Custom queryset can't be used for this lookup.&quot;)</font>
<font color="black"> 195. </font>
<font color="black"> 196.         # For efficiency, group the instances by content type and then do one</font>
<font color="black"> 197.         # query per model</font>
<font color="red"> 198.         fk_dict = defaultdict(set)</font>
<font color="black"> 199.         # We need one instance for each group in order to get the right db:</font>
<font color="red"> 200.         instance_dict = {}</font>
<font color="red"> 201.         ct_attname = self.model._meta.get_field(self.ct_field).get_attname()</font>
<font color="red"> 202.         for instance in instances:</font>
<font color="black"> 203.             # We avoid looking for values if either ct_id or fkey value is None</font>
<font color="red"> 204.             ct_id = getattr(instance, ct_attname)</font>
<font color="red"> 205.             if ct_id is not None:</font>
<font color="red"> 206.                 fk_val = getattr(instance, self.fk_field)</font>
<font color="red"> 207.                 if fk_val is not None:</font>
<font color="red"> 208.                     fk_dict[ct_id].add(fk_val)</font>
<font color="red"> 209.                     instance_dict[ct_id] = instance</font>
<font color="black"> 210. </font>
<font color="red"> 211.         ret_val = []</font>
<font color="red"> 212.         for ct_id, fkeys in fk_dict.items():</font>
<font color="red"> 213.             instance = instance_dict[ct_id]</font>
<font color="red"> 214.             ct = self.get_content_type(id=ct_id, using=instance._state.db)</font>
<font color="red"> 215.             ret_val.extend(ct.get_all_objects_for_this_type(pk__in=fkeys))</font>
<font color="black"> 216. </font>
<font color="black"> 217.         # For doing the join in Python, we have to match both the FK val and the</font>
<font color="black"> 218.         # content type, so we use a callable that returns a (fk, class) pair.</font>
<font color="red"> 219.         def gfk_key(obj):</font>
<font color="red"> 220.             ct_id = getattr(obj, ct_attname)</font>
<font color="red"> 221.             if ct_id is None:</font>
<font color="red"> 222.                 return None</font>
<font color="black"> 223.             else:</font>
<font color="red"> 224.                 model = self.get_content_type(id=ct_id,</font>
<font color="red"> 225.                                               using=obj._state.db).model_class()</font>
<font color="red"> 226.                 return (model._meta.pk.get_prep_value(getattr(obj, self.fk_field)),</font>
<font color="red"> 227.                         model)</font>
<font color="black"> 228. </font>
<font color="red"> 229.         return (ret_val,</font>
<font color="red"> 230.                 lambda obj: (obj._get_pk_val(), obj.__class__),</font>
<font color="red"> 231.                 gfk_key,</font>
<font color="red"> 232.                 True,</font>
<font color="red"> 233.                 self.cache_attr)</font>
<font color="black"> 234. </font>
<font color="green"> 235.     def is_cached(self, instance):</font>
<font color="red"> 236.         return hasattr(instance, self.cache_attr)</font>
<font color="black"> 237. </font>
<font color="green"> 238.     def __get__(self, instance, instance_type=None):</font>
<font color="red"> 239.         if instance is None:</font>
<font color="red"> 240.             return self</font>
<font color="black"> 241. </font>
<font color="red"> 242.         try:</font>
<font color="red"> 243.             return getattr(instance, self.cache_attr)</font>
<font color="red"> 244.         except AttributeError:</font>
<font color="red"> 245.             rel_obj = None</font>
<font color="black"> 246. </font>
<font color="black"> 247.             # Make sure to use ContentType.objects.get_for_id() to ensure that</font>
<font color="black"> 248.             # lookups are cached (see ticket #5570). This takes more code than</font>
<font color="black"> 249.             # the naive ``getattr(instance, self.ct_field)``, but has better</font>
<font color="black"> 250.             # performance when dealing with GFKs in loops and such.</font>
<font color="red"> 251.             f = self.model._meta.get_field(self.ct_field)</font>
<font color="red"> 252.             ct_id = getattr(instance, f.get_attname(), None)</font>
<font color="red"> 253.             if ct_id is not None:</font>
<font color="red"> 254.                 ct = self.get_content_type(id=ct_id, using=instance._state.db)</font>
<font color="red"> 255.                 try:</font>
<font color="red"> 256.                     rel_obj = ct.get_object_for_this_type(pk=getattr(instance, self.fk_field))</font>
<font color="red"> 257.                 except ObjectDoesNotExist:</font>
<font color="red"> 258.                     pass</font>
<font color="red"> 259.             setattr(instance, self.cache_attr, rel_obj)</font>
<font color="red"> 260.             return rel_obj</font>
<font color="black"> 261. </font>
<font color="green"> 262.     def __set__(self, instance, value):</font>
<font color="red"> 263.         ct = None</font>
<font color="red"> 264.         fk = None</font>
<font color="red"> 265.         if value is not None:</font>
<font color="red"> 266.             ct = self.get_content_type(obj=value)</font>
<font color="red"> 267.             fk = value._get_pk_val()</font>
<font color="black"> 268. </font>
<font color="red"> 269.         setattr(instance, self.ct_field, ct)</font>
<font color="red"> 270.         setattr(instance, self.fk_field, fk)</font>
<font color="red"> 271.         setattr(instance, self.cache_attr, value)</font>
<font color="black"> 272. </font>
<font color="black"> 273. </font>
<font color="green"> 274. class GenericRel(ForeignObjectRel):</font>
<font color="black"> 275.     &quot;&quot;&quot;</font>
<font color="black"> 276.     Used by GenericRelation to store information about the relation.</font>
<font color="green"> 277.     &quot;&quot;&quot;</font>
<font color="black"> 278. </font>
<font color="green"> 279.     def __init__(self, field, to, related_name=None, related_query_name=None, limit_choices_to=None):</font>
<font color="red"> 280.         super(GenericRel, self).__init__(</font>
<font color="red"> 281.             field, to,</font>
<font color="red"> 282.             related_name=related_query_name or '+',</font>
<font color="red"> 283.             related_query_name=related_query_name,</font>
<font color="red"> 284.             limit_choices_to=limit_choices_to,</font>
<font color="red"> 285.             on_delete=DO_NOTHING,</font>
<font color="black"> 286.         )</font>
<font color="black"> 287. </font>
<font color="black"> 288. </font>
<font color="green"> 289. class GenericRelation(ForeignObject):</font>
<font color="black"> 290.     &quot;&quot;&quot;</font>
<font color="black"> 291.     Provide a reverse to a relation created by a GenericForeignKey.</font>
<font color="green"> 292.     &quot;&quot;&quot;</font>
<font color="black"> 293. </font>
<font color="black"> 294.     # Field flags</font>
<font color="green"> 295.     auto_created = False</font>
<font color="black"> 296. </font>
<font color="green"> 297.     many_to_many = False</font>
<font color="green"> 298.     many_to_one = False</font>
<font color="green"> 299.     one_to_many = True</font>
<font color="green"> 300.     one_to_one = False</font>
<font color="black"> 301. </font>
<font color="green"> 302.     rel_class = GenericRel</font>
<font color="black"> 303. </font>
<font color="green"> 304.     def __init__(self, to, object_id_field='object_id', content_type_field='content_type',</font>
<font color="green"> 305.             for_concrete_model=True, related_query_name=None, limit_choices_to=None, **kwargs):</font>
<font color="red"> 306.         kwargs['rel'] = self.rel_class(</font>
<font color="red"> 307.             self, to,</font>
<font color="red"> 308.             related_query_name=related_query_name,</font>
<font color="red"> 309.             limit_choices_to=limit_choices_to,</font>
<font color="black"> 310.         )</font>
<font color="black"> 311. </font>
<font color="red"> 312.         kwargs['blank'] = True</font>
<font color="red"> 313.         kwargs['on_delete'] = models.CASCADE</font>
<font color="red"> 314.         kwargs['editable'] = False</font>
<font color="red"> 315.         kwargs['serialize'] = False</font>
<font color="black"> 316. </font>
<font color="black"> 317.         # This construct is somewhat of an abuse of ForeignObject. This field</font>
<font color="black"> 318.         # represents a relation from pk to object_id field. But, this relation</font>
<font color="black"> 319.         # isn't direct, the join is generated reverse along foreign key. So,</font>
<font color="black"> 320.         # the from_field is object_id field, to_field is pk because of the</font>
<font color="black"> 321.         # reverse join.</font>
<font color="red"> 322.         super(GenericRelation, self).__init__(</font>
<font color="red"> 323.             to, from_fields=[object_id_field], to_fields=[], **kwargs)</font>
<font color="black"> 324. </font>
<font color="red"> 325.         self.object_id_field_name = object_id_field</font>
<font color="red"> 326.         self.content_type_field_name = content_type_field</font>
<font color="red"> 327.         self.for_concrete_model = for_concrete_model</font>
<font color="black"> 328. </font>
<font color="green"> 329.     def check(self, **kwargs):</font>
<font color="red"> 330.         errors = super(GenericRelation, self).check(**kwargs)</font>
<font color="red"> 331.         errors.extend(self._check_generic_foreign_key_existence())</font>
<font color="red"> 332.         return errors</font>
<font color="black"> 333. </font>
<font color="green"> 334.     def _check_generic_foreign_key_existence(self):</font>
<font color="red"> 335.         target = self.remote_field.model</font>
<font color="red"> 336.         if isinstance(target, ModelBase):</font>
<font color="red"> 337.             fields = target._meta.virtual_fields</font>
<font color="red"> 338.             if any(isinstance(field, GenericForeignKey) and</font>
<font color="black"> 339.                     field.ct_field == self.content_type_field_name and</font>
<font color="black"> 340.                     field.fk_field == self.object_id_field_name</font>
<font color="red"> 341.                     for field in fields):</font>
<font color="red"> 342.                 return []</font>
<font color="black"> 343.             else:</font>
<font color="black"> 344.                 return [</font>
<font color="red"> 345.                     checks.Error(</font>
<font color="red"> 346.                         (&quot;The GenericRelation defines a relation with the model &quot;</font>
<font color="black"> 347.                          &quot;'%s.%s', but that model does not have a GenericForeignKey.&quot;) % (</font>
<font color="red"> 348.                             target._meta.app_label, target._meta.object_name</font>
<font color="black"> 349.                         ),</font>
<font color="red"> 350.                         hint=None,</font>
<font color="red"> 351.                         obj=self,</font>
<font color="red"> 352.                         id='contenttypes.E004',</font>
<font color="black"> 353.                     )</font>
<font color="black"> 354.                 ]</font>
<font color="black"> 355.         else:</font>
<font color="red"> 356.             return []</font>
<font color="black"> 357. </font>
<font color="green"> 358.     def resolve_related_fields(self):</font>
<font color="red"> 359.         self.to_fields = [self.model._meta.pk.name]</font>
<font color="red"> 360.         return [(self.remote_field.model._meta.get_field(self.object_id_field_name), self.model._meta.pk)]</font>
<font color="black"> 361. </font>
<font color="green"> 362.     def get_path_info(self):</font>
<font color="red"> 363.         opts = self.remote_field.model._meta</font>
<font color="red"> 364.         target = opts.pk</font>
<font color="red"> 365.         return [PathInfo(self.model._meta, opts, (target,), self.remote_field, True, False)]</font>
<font color="black"> 366. </font>
<font color="green"> 367.     def get_reverse_path_info(self):</font>
<font color="red"> 368.         opts = self.model._meta</font>
<font color="red"> 369.         from_opts = self.remote_field.model._meta</font>
<font color="red"> 370.         return [PathInfo(from_opts, opts, (opts.pk,), self, not self.unique, False)]</font>
<font color="black"> 371. </font>
<font color="green"> 372.     def get_choices_default(self):</font>
<font color="red"> 373.         return super(GenericRelation, self).get_choices(include_blank=False)</font>
<font color="black"> 374. </font>
<font color="green"> 375.     def value_to_string(self, obj):</font>
<font color="red"> 376.         qs = getattr(obj, self.name).all()</font>
<font color="red"> 377.         return smart_text([instance._get_pk_val() for instance in qs])</font>
<font color="black"> 378. </font>
<font color="green"> 379.     def contribute_to_class(self, cls, name, **kwargs):</font>
<font color="red"> 380.         kwargs['virtual_only'] = True</font>
<font color="red"> 381.         super(GenericRelation, self).contribute_to_class(cls, name, **kwargs)</font>
<font color="red"> 382.         self.model = cls</font>
<font color="red"> 383.         setattr(cls, self.name, ReverseGenericManyToOneDescriptor(self.remote_field))</font>
<font color="black"> 384. </font>
<font color="black"> 385.         # Add get_RELATED_order() and set_RELATED_order() methods if the model</font>
<font color="black"> 386.         # on the other end of this relation is ordered with respect to this.</font>
<font color="red"> 387.         def matching_gfk(field):</font>
<font color="black"> 388.             return (</font>
<font color="red"> 389.                 isinstance(field, GenericForeignKey) and</font>
<font color="red"> 390.                 self.content_type_field_name == field.ct_field and</font>
<font color="red"> 391.                 self.object_id_field_name == field.fk_field</font>
<font color="black"> 392.             )</font>
<font color="black"> 393. </font>
<font color="red"> 394.         def make_generic_foreign_order_accessors(related_model, model):</font>
<font color="red"> 395.             if matching_gfk(model._meta.order_with_respect_to):</font>
<font color="red"> 396.                 make_foreign_order_accessors(model, related_model)</font>
<font color="black"> 397. </font>
<font color="red"> 398.         lazy_related_operation(make_generic_foreign_order_accessors, self.model, self.remote_field.model)</font>
<font color="black"> 399. </font>
<font color="green"> 400.     def set_attributes_from_rel(self):</font>
<font color="red"> 401.         pass</font>
<font color="black"> 402. </font>
<font color="green"> 403.     def get_internal_type(self):</font>
<font color="red"> 404.         return &quot;ManyToManyField&quot;</font>
<font color="black"> 405. </font>
<font color="green"> 406.     def get_content_type(self):</font>
<font color="black"> 407.         &quot;&quot;&quot;</font>
<font color="black"> 408.         Return the content type associated with this field's model.</font>
<font color="black"> 409.         &quot;&quot;&quot;</font>
<font color="red"> 410.         return ContentType.objects.get_for_model(self.model,</font>
<font color="red"> 411.                                                  for_concrete_model=self.for_concrete_model)</font>
<font color="black"> 412. </font>
<font color="green"> 413.     def get_extra_restriction(self, where_class, alias, remote_alias):</font>
<font color="red"> 414.         field = self.remote_field.model._meta.get_field(self.content_type_field_name)</font>
<font color="red"> 415.         contenttype_pk = self.get_content_type().pk</font>
<font color="red"> 416.         cond = where_class()</font>
<font color="red"> 417.         lookup = field.get_lookup('exact')(field.get_col(remote_alias), contenttype_pk)</font>
<font color="red"> 418.         cond.add(lookup, 'AND')</font>
<font color="red"> 419.         return cond</font>
<font color="black"> 420. </font>
<font color="green"> 421.     def bulk_related_objects(self, objs, using=DEFAULT_DB_ALIAS):</font>
<font color="black"> 422.         &quot;&quot;&quot;</font>
<font color="black"> 423.         Return all objects related to ``objs`` via this ``GenericRelation``.</font>
<font color="black"> 424.         &quot;&quot;&quot;</font>
<font color="red"> 425.         return self.remote_field.model._base_manager.db_manager(using).filter(**{</font>
<font color="red"> 426.             &quot;%s__pk&quot; % self.content_type_field_name: ContentType.objects.db_manager(using).get_for_model(</font>
<font color="red"> 427.                 self.model, for_concrete_model=self.for_concrete_model).pk,</font>
<font color="red"> 428.             &quot;%s__in&quot; % self.object_id_field_name: [obj.pk for obj in objs]</font>
<font color="black"> 429.         })</font>
<font color="black"> 430. </font>
<font color="black"> 431. </font>
<font color="green"> 432. class ReverseGenericManyToOneDescriptor(ReverseManyToOneDescriptor):</font>
<font color="black"> 433.     &quot;&quot;&quot;</font>
<font color="black"> 434.     Accessor to the related objects manager on the one-to-many relation created</font>
<font color="black"> 435.     by GenericRelation.</font>
<font color="black"> 436. </font>
<font color="black"> 437.     In the example::</font>
<font color="black"> 438. </font>
<font color="black"> 439.         class Post(Model):</font>
<font color="black"> 440.             comments = GenericRelation(Comment)</font>
<font color="black"> 441. </font>
<font color="black"> 442.     ``post.comments`` is a ReverseGenericManyToOneDescriptor instance.</font>
<font color="green"> 443.     &quot;&quot;&quot;</font>
<font color="black"> 444. </font>
<font color="green"> 445.     @cached_property</font>
<font color="black"> 446.     def related_manager_cls(self):</font>
<font color="red"> 447.         return create_generic_related_manager(</font>
<font color="red"> 448.             self.rel.model._default_manager.__class__,</font>
<font color="red"> 449.             self.rel,</font>
<font color="black"> 450.         )</font>
<font color="black"> 451. </font>
<font color="black"> 452. </font>
<font color="green"> 453. def create_generic_related_manager(superclass, rel):</font>
<font color="black"> 454.     &quot;&quot;&quot;</font>
<font color="black"> 455.     Factory function to create a manager that subclasses another manager</font>
<font color="black"> 456.     (generally the default manager of a given model) and adds behaviors</font>
<font color="black"> 457.     specific to generic relations.</font>
<font color="black"> 458.     &quot;&quot;&quot;</font>
<font color="black"> 459. </font>
<font color="red"> 460.     class GenericRelatedObjectManager(superclass):</font>
<font color="red"> 461.         def __init__(self, instance=None):</font>
<font color="red"> 462.             super(GenericRelatedObjectManager, self).__init__()</font>
<font color="black"> 463. </font>
<font color="red"> 464.             self.instance = instance</font>
<font color="black"> 465. </font>
<font color="red"> 466.             self.model = rel.model</font>
<font color="black"> 467. </font>
<font color="red"> 468.             content_type = ContentType.objects.db_manager(instance._state.db).get_for_model(</font>
<font color="red"> 469.                 instance, for_concrete_model=rel.field.for_concrete_model)</font>
<font color="red"> 470.             self.content_type = content_type</font>
<font color="red"> 471.             self.content_type_field_name = rel.field.content_type_field_name</font>
<font color="red"> 472.             self.object_id_field_name = rel.field.object_id_field_name</font>
<font color="red"> 473.             self.prefetch_cache_name = rel.field.attname</font>
<font color="red"> 474.             self.pk_val = instance._get_pk_val()</font>
<font color="black"> 475. </font>
<font color="red"> 476.             self.core_filters = {</font>
<font color="red"> 477.                 '%s__pk' % self.content_type_field_name: content_type.id,</font>
<font color="red"> 478.                 self.object_id_field_name: self.pk_val,</font>
<font color="black"> 479.             }</font>
<font color="black"> 480. </font>
<font color="red"> 481.         def __call__(self, **kwargs):</font>
<font color="black"> 482.             # We use **kwargs rather than a kwarg argument to enforce the</font>
<font color="black"> 483.             # `manager='manager_name'` syntax.</font>
<font color="red"> 484.             manager = getattr(self.model, kwargs.pop('manager'))</font>
<font color="red"> 485.             manager_class = create_generic_related_manager(manager.__class__, rel)</font>
<font color="red"> 486.             return manager_class(instance=self.instance)</font>
<font color="red"> 487.         do_not_call_in_templates = True</font>
<font color="black"> 488. </font>
<font color="red"> 489.         def __str__(self):</font>
<font color="red"> 490.             return repr(self)</font>
<font color="black"> 491. </font>
<font color="red"> 492.         def get_queryset(self):</font>
<font color="red"> 493.             try:</font>
<font color="red"> 494.                 return self.instance._prefetched_objects_cache[self.prefetch_cache_name]</font>
<font color="red"> 495.             except (AttributeError, KeyError):</font>
<font color="red"> 496.                 db = self._db or router.db_for_read(self.model, instance=self.instance)</font>
<font color="red"> 497.                 return super(GenericRelatedObjectManager, self).get_queryset().using(db).filter(**self.core_filters)</font>
<font color="black"> 498. </font>
<font color="red"> 499.         def get_prefetch_queryset(self, instances, queryset=None):</font>
<font color="red"> 500.             if queryset is None:</font>
<font color="red"> 501.                 queryset = super(GenericRelatedObjectManager, self).get_queryset()</font>
<font color="black"> 502. </font>
<font color="red"> 503.             queryset._add_hints(instance=instances[0])</font>
<font color="red"> 504.             queryset = queryset.using(queryset._db or self._db)</font>
<font color="black"> 505. </font>
<font color="red"> 506.             query = {</font>
<font color="red"> 507.                 '%s__pk' % self.content_type_field_name: self.content_type.id,</font>
<font color="red"> 508.                 '%s__in' % self.object_id_field_name: set(obj._get_pk_val() for obj in instances)</font>
<font color="black"> 509.             }</font>
<font color="black"> 510. </font>
<font color="black"> 511.             # We (possibly) need to convert object IDs to the type of the</font>
<font color="black"> 512.             # instances' PK in order to match up instances:</font>
<font color="red"> 513.             object_id_converter = instances[0]._meta.pk.to_python</font>
<font color="red"> 514.             return (queryset.filter(**query),</font>
<font color="red"> 515.                     lambda relobj: object_id_converter(getattr(relobj, self.object_id_field_name)),</font>
<font color="red"> 516.                     lambda obj: obj._get_pk_val(),</font>
<font color="red"> 517.                     False,</font>
<font color="red"> 518.                     self.prefetch_cache_name)</font>
<font color="black"> 519. </font>
<font color="red"> 520.         def add(self, *objs, **kwargs):</font>
<font color="red"> 521.             bulk = kwargs.pop('bulk', True)</font>
<font color="red"> 522.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="black"> 523. </font>
<font color="red"> 524.             def check_and_update_obj(obj):</font>
<font color="red"> 525.                 if not isinstance(obj, self.model):</font>
<font color="red"> 526.                     raise TypeError(&quot;'%s' instance expected, got %r&quot; % (</font>
<font color="red"> 527.                         self.model._meta.object_name, obj</font>
<font color="black"> 528.                     ))</font>
<font color="red"> 529.                 setattr(obj, self.content_type_field_name, self.content_type)</font>
<font color="red"> 530.                 setattr(obj, self.object_id_field_name, self.pk_val)</font>
<font color="black"> 531. </font>
<font color="red"> 532.             if bulk:</font>
<font color="red"> 533.                 pks = []</font>
<font color="red"> 534.                 for obj in objs:</font>
<font color="red"> 535.                     if obj._state.adding or obj._state.db != db:</font>
<font color="red"> 536.                         raise ValueError(</font>
<font color="red"> 537.                             &quot;%r instance isn't saved. Use bulk=False or save &quot;</font>
<font color="red"> 538.                             &quot;the object first. but must be.&quot; % obj</font>
<font color="black"> 539.                         )</font>
<font color="red"> 540.                     check_and_update_obj(obj)</font>
<font color="red"> 541.                     pks.append(obj.pk)</font>
<font color="black"> 542. </font>
<font color="red"> 543.                 self.model._base_manager.using(db).filter(pk__in=pks).update(**{</font>
<font color="red"> 544.                     self.content_type_field_name: self.content_type,</font>
<font color="red"> 545.                     self.object_id_field_name: self.pk_val,</font>
<font color="black"> 546.                 })</font>
<font color="black"> 547.             else:</font>
<font color="red"> 548.                 with transaction.atomic(using=db, savepoint=False):</font>
<font color="red"> 549.                     for obj in objs:</font>
<font color="red"> 550.                         check_and_update_obj(obj)</font>
<font color="red"> 551.                         obj.save()</font>
<font color="red"> 552.         add.alters_data = True</font>
<font color="black"> 553. </font>
<font color="red"> 554.         def remove(self, *objs, **kwargs):</font>
<font color="red"> 555.             if not objs:</font>
<font color="red"> 556.                 return</font>
<font color="red"> 557.             bulk = kwargs.pop('bulk', True)</font>
<font color="red"> 558.             self._clear(self.filter(pk__in=[o.pk for o in objs]), bulk)</font>
<font color="red"> 559.         remove.alters_data = True</font>
<font color="black"> 560. </font>
<font color="red"> 561.         def clear(self, **kwargs):</font>
<font color="red"> 562.             bulk = kwargs.pop('bulk', True)</font>
<font color="red"> 563.             self._clear(self, bulk)</font>
<font color="red"> 564.         clear.alters_data = True</font>
<font color="black"> 565. </font>
<font color="red"> 566.         def _clear(self, queryset, bulk):</font>
<font color="red"> 567.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="red"> 568.             queryset = queryset.using(db)</font>
<font color="red"> 569.             if bulk:</font>
<font color="black"> 570.                 # `QuerySet.delete()` creates its own atomic block which</font>
<font color="black"> 571.                 # contains the `pre_delete` and `post_delete` signal handlers.</font>
<font color="red"> 572.                 queryset.delete()</font>
<font color="black"> 573.             else:</font>
<font color="red"> 574.                 with transaction.atomic(using=db, savepoint=False):</font>
<font color="red"> 575.                     for obj in queryset:</font>
<font color="red"> 576.                         obj.delete()</font>
<font color="red"> 577.         _clear.alters_data = True</font>
<font color="black"> 578. </font>
<font color="red"> 579.         def set(self, objs, **kwargs):</font>
<font color="black"> 580.             # Force evaluation of `objs` in case it's a queryset whose value</font>
<font color="black"> 581.             # could be affected by `manager.clear()`. Refs #19816.</font>
<font color="red"> 582.             objs = tuple(objs)</font>
<font color="black"> 583. </font>
<font color="red"> 584.             bulk = kwargs.pop('bulk', True)</font>
<font color="red"> 585.             clear = kwargs.pop('clear', False)</font>
<font color="black"> 586. </font>
<font color="red"> 587.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="red"> 588.             with transaction.atomic(using=db, savepoint=False):</font>
<font color="red"> 589.                 if clear:</font>
<font color="red"> 590.                     self.clear()</font>
<font color="red"> 591.                     self.add(*objs, bulk=bulk)</font>
<font color="black"> 592.                 else:</font>
<font color="red"> 593.                     old_objs = set(self.using(db).all())</font>
<font color="red"> 594.                     new_objs = []</font>
<font color="red"> 595.                     for obj in objs:</font>
<font color="red"> 596.                         if obj in old_objs:</font>
<font color="red"> 597.                             old_objs.remove(obj)</font>
<font color="black"> 598.                         else:</font>
<font color="red"> 599.                             new_objs.append(obj)</font>
<font color="black"> 600. </font>
<font color="red"> 601.                     self.remove(*old_objs)</font>
<font color="red"> 602.                     self.add(*new_objs, bulk=bulk)</font>
<font color="red"> 603.         set.alters_data = True</font>
<font color="black"> 604. </font>
<font color="red"> 605.         def create(self, **kwargs):</font>
<font color="red"> 606.             kwargs[self.content_type_field_name] = self.content_type</font>
<font color="red"> 607.             kwargs[self.object_id_field_name] = self.pk_val</font>
<font color="red"> 608.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="red"> 609.             return super(GenericRelatedObjectManager, self).using(db).create(**kwargs)</font>
<font color="red"> 610.         create.alters_data = True</font>
<font color="black"> 611. </font>
<font color="red"> 612.         def get_or_create(self, **kwargs):</font>
<font color="red"> 613.             kwargs[self.content_type_field_name] = self.content_type</font>
<font color="red"> 614.             kwargs[self.object_id_field_name] = self.pk_val</font>
<font color="red"> 615.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="red"> 616.             return super(GenericRelatedObjectManager, self).using(db).get_or_create(**kwargs)</font>
<font color="red"> 617.         get_or_create.alters_data = True</font>
<font color="black"> 618. </font>
<font color="red"> 619.         def update_or_create(self, **kwargs):</font>
<font color="red"> 620.             kwargs[self.content_type_field_name] = self.content_type</font>
<font color="red"> 621.             kwargs[self.object_id_field_name] = self.pk_val</font>
<font color="red"> 622.             db = router.db_for_write(self.model, instance=self.instance)</font>
<font color="red"> 623.             return super(GenericRelatedObjectManager, self).using(db).update_or_create(**kwargs)</font>
<font color="red"> 624.         update_or_create.alters_data = True</font>
<font color="black"> 625. </font>
<font color="red"> 626.     return GenericRelatedObjectManager</font>
</pre>


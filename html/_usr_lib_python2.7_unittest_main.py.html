source file: <b>/usr/lib/python2.7/unittest/main.py</b><br>


file stats: <b>152 lines, 26 executed: 17.1% covered</b>
<pre>
<font color="green">   1. &quot;&quot;&quot;Unittest main program&quot;&quot;&quot;</font>
<font color="black">   2. </font>
<font color="green">   3. import sys</font>
<font color="green">   4. import os</font>
<font color="green">   5. import types</font>
<font color="black">   6. </font>
<font color="green">   7. from . import loader, runner</font>
<font color="green">   8. from .signals import installHandler</font>
<font color="black">   9. </font>
<font color="green">  10. __unittest = True</font>
<font color="black">  11. </font>
<font color="green">  12. FAILFAST     = &quot;  -f, --failfast   Stop on first failure\n&quot;</font>
<font color="green">  13. CATCHBREAK   = &quot;  -c, --catch      Catch control-C and display results\n&quot;</font>
<font color="green">  14. BUFFEROUTPUT = &quot;  -b, --buffer     Buffer stdout and stderr during test runs\n&quot;</font>
<font color="black">  15. </font>
<font color="black">  16. USAGE_AS_MAIN = &quot;&quot;&quot;\</font>
<font color="black">  17. Usage: %(progName)s [options] [tests]</font>
<font color="black">  18. </font>
<font color="black">  19. Options:</font>
<font color="black">  20.   -h, --help       Show this message</font>
<font color="black">  21.   -v, --verbose    Verbose output</font>
<font color="black">  22.   -q, --quiet      Minimal output</font>
<font color="black">  23. %(failfast)s%(catchbreak)s%(buffer)s</font>
<font color="black">  24. Examples:</font>
<font color="black">  25.   %(progName)s test_module               - run tests from test_module</font>
<font color="black">  26.   %(progName)s module.TestClass          - run tests from module.TestClass</font>
<font color="black">  27.   %(progName)s module.Class.test_method  - run specified test method</font>
<font color="black">  28. </font>
<font color="black">  29. [tests] can be a list of any number of test modules, classes and test</font>
<font color="black">  30. methods.</font>
<font color="black">  31. </font>
<font color="black">  32. Alternative Usage: %(progName)s discover [options]</font>
<font color="black">  33. </font>
<font color="black">  34. Options:</font>
<font color="black">  35.   -v, --verbose    Verbose output</font>
<font color="black">  36. %(failfast)s%(catchbreak)s%(buffer)s  -s directory     Directory to start discovery ('.' default)</font>
<font color="black">  37.   -p pattern       Pattern to match test files ('test*.py' default)</font>
<font color="black">  38.   -t directory     Top level directory of project (default to</font>
<font color="black">  39.                    start directory)</font>
<font color="black">  40. </font>
<font color="black">  41. For test discovery all test modules must be importable from the top</font>
<font color="black">  42. level directory of the project.</font>
<font color="green">  43. &quot;&quot;&quot;</font>
<font color="black">  44. </font>
<font color="black">  45. USAGE_FROM_MODULE = &quot;&quot;&quot;\</font>
<font color="black">  46. Usage: %(progName)s [options] [test] [...]</font>
<font color="black">  47. </font>
<font color="black">  48. Options:</font>
<font color="black">  49.   -h, --help       Show this message</font>
<font color="black">  50.   -v, --verbose    Verbose output</font>
<font color="black">  51.   -q, --quiet      Minimal output</font>
<font color="black">  52. %(failfast)s%(catchbreak)s%(buffer)s</font>
<font color="black">  53. Examples:</font>
<font color="black">  54.   %(progName)s                               - run default set of tests</font>
<font color="black">  55.   %(progName)s MyTestSuite                   - run suite 'MyTestSuite'</font>
<font color="black">  56.   %(progName)s MyTestCase.testSomething      - run MyTestCase.testSomething</font>
<font color="black">  57.   %(progName)s MyTestCase                    - run all 'test*' test methods</font>
<font color="black">  58.                                                in MyTestCase</font>
<font color="green">  59. &quot;&quot;&quot;</font>
<font color="black">  60. </font>
<font color="black">  61. </font>
<font color="black">  62. </font>
<font color="green">  63. class TestProgram(object):</font>
<font color="black">  64.     &quot;&quot;&quot;A command-line program that runs a set of tests; this is primarily</font>
<font color="black">  65.        for making test modules conveniently executable.</font>
<font color="green">  66.     &quot;&quot;&quot;</font>
<font color="green">  67.     USAGE = USAGE_FROM_MODULE</font>
<font color="black">  68. </font>
<font color="black">  69.     # defaults for testing</font>
<font color="green">  70.     failfast = catchbreak = buffer = progName = None</font>
<font color="black">  71. </font>
<font color="green">  72.     def __init__(self, module='__main__', defaultTest=None, argv=None,</font>
<font color="green">  73.                     testRunner=None, testLoader=loader.defaultTestLoader,</font>
<font color="green">  74.                     exit=True, verbosity=1, failfast=None, catchbreak=None,</font>
<font color="green">  75.                     buffer=None):</font>
<font color="red">  76.         if isinstance(module, basestring):</font>
<font color="red">  77.             self.module = __import__(module)</font>
<font color="red">  78.             for part in module.split('.')[1:]:</font>
<font color="red">  79.                 self.module = getattr(self.module, part)</font>
<font color="black">  80.         else:</font>
<font color="red">  81.             self.module = module</font>
<font color="red">  82.         if argv is None:</font>
<font color="red">  83.             argv = sys.argv</font>
<font color="black">  84. </font>
<font color="red">  85.         self.exit = exit</font>
<font color="red">  86.         self.failfast = failfast</font>
<font color="red">  87.         self.catchbreak = catchbreak</font>
<font color="red">  88.         self.verbosity = verbosity</font>
<font color="red">  89.         self.buffer = buffer</font>
<font color="red">  90.         self.defaultTest = defaultTest</font>
<font color="red">  91.         self.testRunner = testRunner</font>
<font color="red">  92.         self.testLoader = testLoader</font>
<font color="red">  93.         self.progName = os.path.basename(argv[0])</font>
<font color="red">  94.         self.parseArgs(argv)</font>
<font color="red">  95.         self.runTests()</font>
<font color="black">  96. </font>
<font color="green">  97.     def usageExit(self, msg=None):</font>
<font color="red">  98.         if msg:</font>
<font color="red">  99.             print msg</font>
<font color="red"> 100.         usage = {'progName': self.progName, 'catchbreak': '', 'failfast': '',</font>
<font color="red"> 101.                  'buffer': ''}</font>
<font color="red"> 102.         if self.failfast != False:</font>
<font color="red"> 103.             usage['failfast'] = FAILFAST</font>
<font color="red"> 104.         if self.catchbreak != False:</font>
<font color="red"> 105.             usage['catchbreak'] = CATCHBREAK</font>
<font color="red"> 106.         if self.buffer != False:</font>
<font color="red"> 107.             usage['buffer'] = BUFFEROUTPUT</font>
<font color="red"> 108.         print self.USAGE % usage</font>
<font color="red"> 109.         sys.exit(2)</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def parseArgs(self, argv):</font>
<font color="red"> 112.         if len(argv) &gt; 1 and argv[1].lower() == 'discover':</font>
<font color="red"> 113.             self._do_discovery(argv[2:])</font>
<font color="red"> 114.             return</font>
<font color="black"> 115. </font>
<font color="red"> 116.         import getopt</font>
<font color="red"> 117.         long_opts = ['help', 'verbose', 'quiet', 'failfast', 'catch', 'buffer']</font>
<font color="red"> 118.         try:</font>
<font color="red"> 119.             options, args = getopt.getopt(argv[1:], 'hHvqfcb', long_opts)</font>
<font color="red"> 120.             for opt, value in options:</font>
<font color="red"> 121.                 if opt in ('-h','-H','--help'):</font>
<font color="red"> 122.                     self.usageExit()</font>
<font color="red"> 123.                 if opt in ('-q','--quiet'):</font>
<font color="red"> 124.                     self.verbosity = 0</font>
<font color="red"> 125.                 if opt in ('-v','--verbose'):</font>
<font color="red"> 126.                     self.verbosity = 2</font>
<font color="red"> 127.                 if opt in ('-f','--failfast'):</font>
<font color="red"> 128.                     if self.failfast is None:</font>
<font color="red"> 129.                         self.failfast = True</font>
<font color="black"> 130.                     # Should this raise an exception if -f is not valid?</font>
<font color="red"> 131.                 if opt in ('-c','--catch'):</font>
<font color="red"> 132.                     if self.catchbreak is None:</font>
<font color="red"> 133.                         self.catchbreak = True</font>
<font color="black"> 134.                     # Should this raise an exception if -c is not valid?</font>
<font color="red"> 135.                 if opt in ('-b','--buffer'):</font>
<font color="red"> 136.                     if self.buffer is None:</font>
<font color="red"> 137.                         self.buffer = True</font>
<font color="black"> 138.                     # Should this raise an exception if -b is not valid?</font>
<font color="red"> 139.             if len(args) == 0 and self.defaultTest is None:</font>
<font color="black"> 140.                 # createTests will load tests from self.module</font>
<font color="red"> 141.                 self.testNames = None</font>
<font color="red"> 142.             elif len(args) &gt; 0:</font>
<font color="red"> 143.                 self.testNames = args</font>
<font color="red"> 144.                 if __name__ == '__main__':</font>
<font color="black"> 145.                     # to support python -m unittest ...</font>
<font color="red"> 146.                     self.module = None</font>
<font color="black"> 147.             else:</font>
<font color="red"> 148.                 self.testNames = (self.defaultTest,)</font>
<font color="red"> 149.             self.createTests()</font>
<font color="red"> 150.         except getopt.error, msg:</font>
<font color="red"> 151.             self.usageExit(msg)</font>
<font color="black"> 152. </font>
<font color="green"> 153.     def createTests(self):</font>
<font color="red"> 154.         if self.testNames is None:</font>
<font color="red"> 155.             self.test = self.testLoader.loadTestsFromModule(self.module)</font>
<font color="black"> 156.         else:</font>
<font color="red"> 157.             self.test = self.testLoader.loadTestsFromNames(self.testNames,</font>
<font color="red"> 158.                                                            self.module)</font>
<font color="black"> 159. </font>
<font color="green"> 160.     def _do_discovery(self, argv, Loader=None):</font>
<font color="red"> 161.         if Loader is None:</font>
<font color="red"> 162.             Loader = lambda: self.testLoader</font>
<font color="black"> 163. </font>
<font color="black"> 164.         # handle command line args for test discovery</font>
<font color="red"> 165.         self.progName = '%s discover' % self.progName</font>
<font color="red"> 166.         import optparse</font>
<font color="red"> 167.         parser = optparse.OptionParser()</font>
<font color="red"> 168.         parser.prog = self.progName</font>
<font color="red"> 169.         parser.add_option('-v', '--verbose', dest='verbose', default=False,</font>
<font color="red"> 170.                           help='Verbose output', action='store_true')</font>
<font color="red"> 171.         if self.failfast != False:</font>
<font color="red"> 172.             parser.add_option('-f', '--failfast', dest='failfast', default=False,</font>
<font color="red"> 173.                               help='Stop on first fail or error',</font>
<font color="red"> 174.                               action='store_true')</font>
<font color="red"> 175.         if self.catchbreak != False:</font>
<font color="red"> 176.             parser.add_option('-c', '--catch', dest='catchbreak', default=False,</font>
<font color="red"> 177.                               help='Catch ctrl-C and display results so far',</font>
<font color="red"> 178.                               action='store_true')</font>
<font color="red"> 179.         if self.buffer != False:</font>
<font color="red"> 180.             parser.add_option('-b', '--buffer', dest='buffer', default=False,</font>
<font color="red"> 181.                               help='Buffer stdout and stderr during tests',</font>
<font color="red"> 182.                               action='store_true')</font>
<font color="red"> 183.         parser.add_option('-s', '--start-directory', dest='start', default='.',</font>
<font color="red"> 184.                           help=&quot;Directory to start discovery ('.' default)&quot;)</font>
<font color="red"> 185.         parser.add_option('-p', '--pattern', dest='pattern', default='test*.py',</font>
<font color="red"> 186.                           help=&quot;Pattern to match tests ('test*.py' default)&quot;)</font>
<font color="red"> 187.         parser.add_option('-t', '--top-level-directory', dest='top', default=None,</font>
<font color="red"> 188.                           help='Top level directory of project (defaults to start directory)')</font>
<font color="black"> 189. </font>
<font color="red"> 190.         options, args = parser.parse_args(argv)</font>
<font color="red"> 191.         if len(args) &gt; 3:</font>
<font color="red"> 192.             self.usageExit()</font>
<font color="black"> 193. </font>
<font color="red"> 194.         for name, value in zip(('start', 'pattern', 'top'), args):</font>
<font color="red"> 195.             setattr(options, name, value)</font>
<font color="black"> 196. </font>
<font color="black"> 197.         # only set options from the parsing here</font>
<font color="black"> 198.         # if they weren't set explicitly in the constructor</font>
<font color="red"> 199.         if self.failfast is None:</font>
<font color="red"> 200.             self.failfast = options.failfast</font>
<font color="red"> 201.         if self.catchbreak is None:</font>
<font color="red"> 202.             self.catchbreak = options.catchbreak</font>
<font color="red"> 203.         if self.buffer is None:</font>
<font color="red"> 204.             self.buffer = options.buffer</font>
<font color="black"> 205. </font>
<font color="red"> 206.         if options.verbose:</font>
<font color="red"> 207.             self.verbosity = 2</font>
<font color="black"> 208. </font>
<font color="red"> 209.         start_dir = options.start</font>
<font color="red"> 210.         pattern = options.pattern</font>
<font color="red"> 211.         top_level_dir = options.top</font>
<font color="black"> 212. </font>
<font color="red"> 213.         loader = Loader()</font>
<font color="red"> 214.         self.test = loader.discover(start_dir, pattern, top_level_dir)</font>
<font color="black"> 215. </font>
<font color="green"> 216.     def runTests(self):</font>
<font color="red"> 217.         if self.catchbreak:</font>
<font color="red"> 218.             installHandler()</font>
<font color="red"> 219.         if self.testRunner is None:</font>
<font color="red"> 220.             self.testRunner = runner.TextTestRunner</font>
<font color="red"> 221.         if isinstance(self.testRunner, (type, types.ClassType)):</font>
<font color="red"> 222.             try:</font>
<font color="red"> 223.                 testRunner = self.testRunner(verbosity=self.verbosity,</font>
<font color="red"> 224.                                              failfast=self.failfast,</font>
<font color="red"> 225.                                              buffer=self.buffer)</font>
<font color="red"> 226.             except TypeError:</font>
<font color="black"> 227.                 # didn't accept the verbosity, buffer or failfast arguments</font>
<font color="red"> 228.                 testRunner = self.testRunner()</font>
<font color="black"> 229.         else:</font>
<font color="black"> 230.             # it is assumed to be a TestRunner instance</font>
<font color="red"> 231.             testRunner = self.testRunner</font>
<font color="red"> 232.         self.result = testRunner.run(self.test)</font>
<font color="red"> 233.         if self.exit:</font>
<font color="red"> 234.             sys.exit(not self.result.wasSuccessful())</font>
<font color="black"> 235. </font>
<font color="green"> 236. main = TestProgram</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/tokens.py</b><br>


file stats: <b>39 lines, 15 executed: 38.5% covered</b>
<pre>
<font color="green">   1. from datetime import date</font>
<font color="black">   2. </font>
<font color="green">   3. from django.conf import settings</font>
<font color="green">   4. from django.utils import six</font>
<font color="green">   5. from django.utils.crypto import constant_time_compare, salted_hmac</font>
<font color="green">   6. from django.utils.http import base36_to_int, int_to_base36</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="green">   9. class PasswordResetTokenGenerator(object):</font>
<font color="black">  10.     &quot;&quot;&quot;</font>
<font color="black">  11.     Strategy object used to generate and check tokens for the password</font>
<font color="black">  12.     reset mechanism.</font>
<font color="green">  13.     &quot;&quot;&quot;</font>
<font color="green">  14.     key_salt = &quot;django.contrib.auth.tokens.PasswordResetTokenGenerator&quot;</font>
<font color="black">  15. </font>
<font color="green">  16.     def make_token(self, user):</font>
<font color="black">  17.         &quot;&quot;&quot;</font>
<font color="black">  18.         Returns a token that can be used once to do a password reset</font>
<font color="black">  19.         for the given user.</font>
<font color="black">  20.         &quot;&quot;&quot;</font>
<font color="red">  21.         return self._make_token_with_timestamp(user, self._num_days(self._today()))</font>
<font color="black">  22. </font>
<font color="green">  23.     def check_token(self, user, token):</font>
<font color="black">  24.         &quot;&quot;&quot;</font>
<font color="black">  25.         Check that a password reset token is correct for a given user.</font>
<font color="black">  26.         &quot;&quot;&quot;</font>
<font color="black">  27.         # Parse the token</font>
<font color="red">  28.         try:</font>
<font color="red">  29.             ts_b36, hash = token.split(&quot;-&quot;)</font>
<font color="red">  30.         except ValueError:</font>
<font color="red">  31.             return False</font>
<font color="black">  32. </font>
<font color="red">  33.         try:</font>
<font color="red">  34.             ts = base36_to_int(ts_b36)</font>
<font color="red">  35.         except ValueError:</font>
<font color="red">  36.             return False</font>
<font color="black">  37. </font>
<font color="black">  38.         # Check that the timestamp/uid has not been tampered with</font>
<font color="red">  39.         if not constant_time_compare(self._make_token_with_timestamp(user, ts), token):</font>
<font color="red">  40.             return False</font>
<font color="black">  41. </font>
<font color="black">  42.         # Check the timestamp is within limit</font>
<font color="red">  43.         if (self._num_days(self._today()) - ts) &gt; settings.PASSWORD_RESET_TIMEOUT_DAYS:</font>
<font color="red">  44.             return False</font>
<font color="black">  45. </font>
<font color="red">  46.         return True</font>
<font color="black">  47. </font>
<font color="green">  48.     def _make_token_with_timestamp(self, user, timestamp):</font>
<font color="black">  49.         # timestamp is number of days since 2001-1-1.  Converted to</font>
<font color="black">  50.         # base 36, this gives us a 3 digit string until about 2121</font>
<font color="red">  51.         ts_b36 = int_to_base36(timestamp)</font>
<font color="black">  52. </font>
<font color="black">  53.         # By hashing on the internal state of the user and using state</font>
<font color="black">  54.         # that is sure to change (the password salt will change as soon as</font>
<font color="black">  55.         # the password is set, at least for current Django auth, and</font>
<font color="black">  56.         # last_login will also change), we produce a hash that will be</font>
<font color="black">  57.         # invalid as soon as it is used.</font>
<font color="black">  58.         # We limit the hash to 20 chars to keep URL short</font>
<font color="black">  59. </font>
<font color="red">  60.         hash = salted_hmac(</font>
<font color="red">  61.             self.key_salt,</font>
<font color="red">  62.             self._make_hash_value(user, timestamp),</font>
<font color="red">  63.         ).hexdigest()[::2]</font>
<font color="red">  64.         return &quot;%s-%s&quot; % (ts_b36, hash)</font>
<font color="black">  65. </font>
<font color="green">  66.     def _make_hash_value(self, user, timestamp):</font>
<font color="black">  67.         # Ensure results are consistent across DB backends</font>
<font color="red">  68.         login_timestamp = '' if user.last_login is None else user.last_login.replace(microsecond=0, tzinfo=None)</font>
<font color="black">  69.         return (</font>
<font color="black">  70.             six.text_type(user.pk) + user.password +</font>
<font color="red">  71.             six.text_type(login_timestamp) + six.text_type(timestamp)</font>
<font color="black">  72.         )</font>
<font color="black">  73. </font>
<font color="green">  74.     def _num_days(self, dt):</font>
<font color="red">  75.         return (dt - date(2001, 1, 1)).days</font>
<font color="black">  76. </font>
<font color="green">  77.     def _today(self):</font>
<font color="black">  78.         # Used for mocking in tests</font>
<font color="red">  79.         return date.today()</font>
<font color="black">  80. </font>
<font color="green">  81. default_token_generator = PasswordResetTokenGenerator()</font>
</pre>


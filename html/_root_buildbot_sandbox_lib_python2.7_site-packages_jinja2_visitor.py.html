source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/jinja2/visitor.py</b><br>


file stats: <b>42 lines, 11 executed: 26.2% covered</b>
<pre>
<font color="black">   1. # -*- coding: utf-8 -*-</font>
<font color="black">   2. &quot;&quot;&quot;</font>
<font color="black">   3.     jinja2.visitor</font>
<font color="black">   4.     ~~~~~~~~~~~~~~</font>
<font color="black">   5. </font>
<font color="black">   6.     This module implements a visitor for the nodes.</font>
<font color="black">   7. </font>
<font color="black">   8.     :copyright: (c) 2010 by the Jinja Team.</font>
<font color="black">   9.     :license: BSD.</font>
<font color="green">  10. &quot;&quot;&quot;</font>
<font color="green">  11. from jinja2.nodes import Node</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. class NodeVisitor(object):</font>
<font color="black">  15.     &quot;&quot;&quot;Walks the abstract syntax tree and call visitor functions for every</font>
<font color="black">  16.     node found.  The visitor functions may return values which will be</font>
<font color="black">  17.     forwarded by the `visit` method.</font>
<font color="black">  18. </font>
<font color="black">  19.     Per default the visitor functions for the nodes are ``'visit_'`` +</font>
<font color="black">  20.     class name of the node.  So a `TryFinally` node visit function would</font>
<font color="black">  21.     be `visit_TryFinally`.  This behavior can be changed by overriding</font>
<font color="black">  22.     the `get_visitor` function.  If no visitor function exists for a node</font>
<font color="black">  23.     (return value `None`) the `generic_visit` visitor is used instead.</font>
<font color="green">  24.     &quot;&quot;&quot;</font>
<font color="black">  25. </font>
<font color="green">  26.     def get_visitor(self, node):</font>
<font color="black">  27.         &quot;&quot;&quot;Return the visitor function for this node or `None` if no visitor</font>
<font color="black">  28.         exists for this node.  In that case the generic visit function is</font>
<font color="black">  29.         used instead.</font>
<font color="black">  30.         &quot;&quot;&quot;</font>
<font color="red">  31.         method = 'visit_' + node.__class__.__name__</font>
<font color="red">  32.         return getattr(self, method, None)</font>
<font color="black">  33. </font>
<font color="green">  34.     def visit(self, node, *args, **kwargs):</font>
<font color="black">  35.         &quot;&quot;&quot;Visit a node.&quot;&quot;&quot;</font>
<font color="red">  36.         f = self.get_visitor(node)</font>
<font color="red">  37.         if f is not None:</font>
<font color="red">  38.             return f(node, *args, **kwargs)</font>
<font color="red">  39.         return self.generic_visit(node, *args, **kwargs)</font>
<font color="black">  40. </font>
<font color="green">  41.     def generic_visit(self, node, *args, **kwargs):</font>
<font color="black">  42.         &quot;&quot;&quot;Called if no explicit visitor function exists for a node.&quot;&quot;&quot;</font>
<font color="red">  43.         for node in node.iter_child_nodes():</font>
<font color="red">  44.             self.visit(node, *args, **kwargs)</font>
<font color="black">  45. </font>
<font color="black">  46. </font>
<font color="green">  47. class NodeTransformer(NodeVisitor):</font>
<font color="black">  48.     &quot;&quot;&quot;Walks the abstract syntax tree and allows modifications of nodes.</font>
<font color="black">  49. </font>
<font color="black">  50.     The `NodeTransformer` will walk the AST and use the return value of the</font>
<font color="black">  51.     visitor functions to replace or remove the old node.  If the return</font>
<font color="black">  52.     value of the visitor function is `None` the node will be removed</font>
<font color="black">  53.     from the previous location otherwise it's replaced with the return</font>
<font color="black">  54.     value.  The return value may be the original node in which case no</font>
<font color="black">  55.     replacement takes place.</font>
<font color="green">  56.     &quot;&quot;&quot;</font>
<font color="black">  57. </font>
<font color="green">  58.     def generic_visit(self, node, *args, **kwargs):</font>
<font color="red">  59.         for field, old_value in node.iter_fields():</font>
<font color="red">  60.             if isinstance(old_value, list):</font>
<font color="red">  61.                 new_values = []</font>
<font color="red">  62.                 for value in old_value:</font>
<font color="red">  63.                     if isinstance(value, Node):</font>
<font color="red">  64.                         value = self.visit(value, *args, **kwargs)</font>
<font color="red">  65.                         if value is None:</font>
<font color="red">  66.                             continue</font>
<font color="red">  67.                         elif not isinstance(value, Node):</font>
<font color="red">  68.                             new_values.extend(value)</font>
<font color="red">  69.                             continue</font>
<font color="red">  70.                     new_values.append(value)</font>
<font color="red">  71.                 old_value[:] = new_values</font>
<font color="red">  72.             elif isinstance(old_value, Node):</font>
<font color="red">  73.                 new_node = self.visit(old_value, *args, **kwargs)</font>
<font color="red">  74.                 if new_node is None:</font>
<font color="red">  75.                     delattr(node, field)</font>
<font color="black">  76.                 else:</font>
<font color="red">  77.                     setattr(node, field, new_node)</font>
<font color="red">  78.         return node</font>
<font color="black">  79. </font>
<font color="green">  80.     def visit_list(self, node, *args, **kwargs):</font>
<font color="black">  81.         &quot;&quot;&quot;As transformers may return lists in some places this method</font>
<font color="black">  82.         can be used to enforce a list as return value.</font>
<font color="black">  83.         &quot;&quot;&quot;</font>
<font color="red">  84.         rv = self.visit(node, *args, **kwargs)</font>
<font color="red">  85.         if not isinstance(rv, list):</font>
<font color="red">  86.             rv = [rv]</font>
<font color="red">  87.         return rv</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/timezone.py</b><br>


file stats: <b>165 lines, 73 executed: 44.2% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Timezone-related classes and functions.</font>
<font color="black">   3. </font>
<font color="black">   4. This module uses pytz when it's available and fallbacks when it isn't.</font>
<font color="green">   5. &quot;&quot;&quot;</font>
<font color="black">   6. </font>
<font color="green">   7. import sys</font>
<font color="green">   8. import time as _time</font>
<font color="green">   9. from datetime import datetime, timedelta, tzinfo</font>
<font color="green">  10. from threading import local</font>
<font color="black">  11. </font>
<font color="green">  12. from django.conf import settings</font>
<font color="green">  13. from django.utils import lru_cache, six</font>
<font color="green">  14. from django.utils.decorators import ContextDecorator</font>
<font color="black">  15. </font>
<font color="green">  16. try:</font>
<font color="green">  17.     import pytz</font>
<font color="green">  18. except ImportError:</font>
<font color="green">  19.     pytz = None</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="black">  22. __all__ = [</font>
<font color="green">  23.     'utc', 'get_fixed_timezone',</font>
<font color="green">  24.     'get_default_timezone', 'get_default_timezone_name',</font>
<font color="green">  25.     'get_current_timezone', 'get_current_timezone_name',</font>
<font color="green">  26.     'activate', 'deactivate', 'override',</font>
<font color="green">  27.     'localtime', 'now',</font>
<font color="green">  28.     'is_aware', 'is_naive', 'make_aware', 'make_naive',</font>
<font color="black">  29. ]</font>
<font color="black">  30. </font>
<font color="black">  31. </font>
<font color="black">  32. # UTC and local time zones</font>
<font color="black">  33. </font>
<font color="green">  34. ZERO = timedelta(0)</font>
<font color="black">  35. </font>
<font color="black">  36. </font>
<font color="green">  37. class UTC(tzinfo):</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="black">  39.     UTC implementation taken from Python's docs.</font>
<font color="black">  40. </font>
<font color="black">  41.     Used only when pytz isn't available.</font>
<font color="green">  42.     &quot;&quot;&quot;</font>
<font color="black">  43. </font>
<font color="green">  44.     def __repr__(self):</font>
<font color="red">  45.         return &quot;&lt;UTC&gt;&quot;</font>
<font color="black">  46. </font>
<font color="green">  47.     def utcoffset(self, dt):</font>
<font color="green">  48.         return ZERO</font>
<font color="black">  49. </font>
<font color="green">  50.     def tzname(self, dt):</font>
<font color="red">  51.         return &quot;UTC&quot;</font>
<font color="black">  52. </font>
<font color="green">  53.     def dst(self, dt):</font>
<font color="red">  54.         return ZERO</font>
<font color="black">  55. </font>
<font color="black">  56. </font>
<font color="green">  57. class FixedOffset(tzinfo):</font>
<font color="black">  58.     &quot;&quot;&quot;</font>
<font color="black">  59.     Fixed offset in minutes east from UTC. Taken from Python's docs.</font>
<font color="black">  60. </font>
<font color="black">  61.     Kept as close as possible to the reference version. __init__ was changed</font>
<font color="black">  62.     to make its arguments optional, according to Python's requirement that</font>
<font color="black">  63.     tzinfo subclasses can be instantiated without arguments.</font>
<font color="green">  64.     &quot;&quot;&quot;</font>
<font color="black">  65. </font>
<font color="green">  66.     def __init__(self, offset=None, name=None):</font>
<font color="red">  67.         if offset is not None:</font>
<font color="red">  68.             self.__offset = timedelta(minutes=offset)</font>
<font color="red">  69.         if name is not None:</font>
<font color="red">  70.             self.__name = name</font>
<font color="black">  71. </font>
<font color="green">  72.     def utcoffset(self, dt):</font>
<font color="red">  73.         return self.__offset</font>
<font color="black">  74. </font>
<font color="green">  75.     def tzname(self, dt):</font>
<font color="red">  76.         return self.__name</font>
<font color="black">  77. </font>
<font color="green">  78.     def dst(self, dt):</font>
<font color="red">  79.         return ZERO</font>
<font color="black">  80. </font>
<font color="black">  81. </font>
<font color="green">  82. class ReferenceLocalTimezone(tzinfo):</font>
<font color="black">  83.     &quot;&quot;&quot;</font>
<font color="black">  84.     Local time. Taken from Python's docs.</font>
<font color="black">  85. </font>
<font color="black">  86.     Used only when pytz isn't available, and most likely inaccurate. If you're</font>
<font color="black">  87.     having trouble with this class, don't waste your time, just install pytz.</font>
<font color="black">  88. </font>
<font color="black">  89.     Kept as close as possible to the reference version. __init__ was added to</font>
<font color="black">  90.     delay the computation of STDOFFSET, DSTOFFSET and DSTDIFF which is</font>
<font color="black">  91.     performed at import time in the example.</font>
<font color="black">  92. </font>
<font color="black">  93.     Subclasses contain further improvements.</font>
<font color="green">  94.     &quot;&quot;&quot;</font>
<font color="black">  95. </font>
<font color="green">  96.     def __init__(self):</font>
<font color="red">  97.         self.STDOFFSET = timedelta(seconds=-_time.timezone)</font>
<font color="red">  98.         if _time.daylight:</font>
<font color="red">  99.             self.DSTOFFSET = timedelta(seconds=-_time.altzone)</font>
<font color="black"> 100.         else:</font>
<font color="red"> 101.             self.DSTOFFSET = self.STDOFFSET</font>
<font color="red"> 102.         self.DSTDIFF = self.DSTOFFSET - self.STDOFFSET</font>
<font color="red"> 103.         tzinfo.__init__(self)</font>
<font color="black"> 104. </font>
<font color="green"> 105.     def utcoffset(self, dt):</font>
<font color="red"> 106.         if self._isdst(dt):</font>
<font color="red"> 107.             return self.DSTOFFSET</font>
<font color="black"> 108.         else:</font>
<font color="red"> 109.             return self.STDOFFSET</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def dst(self, dt):</font>
<font color="red"> 112.         if self._isdst(dt):</font>
<font color="red"> 113.             return self.DSTDIFF</font>
<font color="black"> 114.         else:</font>
<font color="red"> 115.             return ZERO</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def tzname(self, dt):</font>
<font color="red"> 118.         return _time.tzname[self._isdst(dt)]</font>
<font color="black"> 119. </font>
<font color="green"> 120.     def _isdst(self, dt):</font>
<font color="red"> 121.         tt = (dt.year, dt.month, dt.day,</font>
<font color="red"> 122.               dt.hour, dt.minute, dt.second,</font>
<font color="red"> 123.               dt.weekday(), 0, 0)</font>
<font color="red"> 124.         stamp = _time.mktime(tt)</font>
<font color="red"> 125.         tt = _time.localtime(stamp)</font>
<font color="red"> 126.         return tt.tm_isdst &gt; 0</font>
<font color="black"> 127. </font>
<font color="black"> 128. </font>
<font color="green"> 129. class LocalTimezone(ReferenceLocalTimezone):</font>
<font color="black"> 130.     &quot;&quot;&quot;</font>
<font color="black"> 131.     Slightly improved local time implementation focusing on correctness.</font>
<font color="black"> 132. </font>
<font color="black"> 133.     It still crashes on dates before 1970 or after 2038, but at least the</font>
<font color="black"> 134.     error message is helpful.</font>
<font color="green"> 135.     &quot;&quot;&quot;</font>
<font color="black"> 136. </font>
<font color="green"> 137.     def tzname(self, dt):</font>
<font color="red"> 138.         is_dst = False if dt is None else self._isdst(dt)</font>
<font color="red"> 139.         return _time.tzname[is_dst]</font>
<font color="black"> 140. </font>
<font color="green"> 141.     def _isdst(self, dt):</font>
<font color="red"> 142.         try:</font>
<font color="red"> 143.             return super(LocalTimezone, self)._isdst(dt)</font>
<font color="red"> 144.         except (OverflowError, ValueError) as exc:</font>
<font color="red"> 145.             exc_type = type(exc)</font>
<font color="red"> 146.             exc_value = exc_type(</font>
<font color="red"> 147.                 &quot;Unsupported value: %r. You should install pytz.&quot; % dt)</font>
<font color="red"> 148.             exc_value.__cause__ = exc</font>
<font color="red"> 149.             six.reraise(exc_type, exc_value, sys.exc_info()[2])</font>
<font color="black"> 150. </font>
<font color="green"> 151. utc = pytz.utc if pytz else UTC()</font>
<font color="black"> 152. &quot;&quot;&quot;UTC time zone as a tzinfo instance.&quot;&quot;&quot;</font>
<font color="black"> 153. </font>
<font color="black"> 154. </font>
<font color="green"> 155. def get_fixed_timezone(offset):</font>
<font color="black"> 156.     &quot;&quot;&quot;</font>
<font color="black"> 157.     Returns a tzinfo instance with a fixed offset from UTC.</font>
<font color="black"> 158.     &quot;&quot;&quot;</font>
<font color="red"> 159.     if isinstance(offset, timedelta):</font>
<font color="red"> 160.         offset = offset.seconds // 60</font>
<font color="red"> 161.     sign = '-' if offset &lt; 0 else '+'</font>
<font color="red"> 162.     hhmm = '%02d%02d' % divmod(abs(offset), 60)</font>
<font color="red"> 163.     name = sign + hhmm</font>
<font color="red"> 164.     return FixedOffset(offset, name)</font>
<font color="black"> 165. </font>
<font color="black"> 166. </font>
<font color="black"> 167. # In order to avoid accessing settings at compile time,</font>
<font color="black"> 168. # wrap the logic in a function and cache the result.</font>
<font color="green"> 169. @lru_cache.lru_cache()</font>
<font color="black"> 170. def get_default_timezone():</font>
<font color="black"> 171.     &quot;&quot;&quot;</font>
<font color="black"> 172.     Returns the default time zone as a tzinfo instance.</font>
<font color="black"> 173. </font>
<font color="black"> 174.     This is the time zone defined by settings.TIME_ZONE.</font>
<font color="black"> 175.     &quot;&quot;&quot;</font>
<font color="red"> 176.     if isinstance(settings.TIME_ZONE, six.string_types) and pytz is not None:</font>
<font color="red"> 177.         return pytz.timezone(settings.TIME_ZONE)</font>
<font color="black"> 178.     else:</font>
<font color="black"> 179.         # This relies on os.environ['TZ'] being set to settings.TIME_ZONE.</font>
<font color="red"> 180.         return LocalTimezone()</font>
<font color="black"> 181. </font>
<font color="black"> 182. </font>
<font color="black"> 183. # This function exists for consistency with get_current_timezone_name</font>
<font color="green"> 184. def get_default_timezone_name():</font>
<font color="black"> 185.     &quot;&quot;&quot;</font>
<font color="black"> 186.     Returns the name of the default time zone.</font>
<font color="black"> 187.     &quot;&quot;&quot;</font>
<font color="red"> 188.     return _get_timezone_name(get_default_timezone())</font>
<font color="black"> 189. </font>
<font color="green"> 190. _active = local()</font>
<font color="black"> 191. </font>
<font color="black"> 192. </font>
<font color="green"> 193. def get_current_timezone():</font>
<font color="black"> 194.     &quot;&quot;&quot;</font>
<font color="black"> 195.     Returns the currently active time zone as a tzinfo instance.</font>
<font color="black"> 196.     &quot;&quot;&quot;</font>
<font color="red"> 197.     return getattr(_active, &quot;value&quot;, get_default_timezone())</font>
<font color="black"> 198. </font>
<font color="black"> 199. </font>
<font color="green"> 200. def get_current_timezone_name():</font>
<font color="black"> 201.     &quot;&quot;&quot;</font>
<font color="black"> 202.     Returns the name of the currently active time zone.</font>
<font color="black"> 203.     &quot;&quot;&quot;</font>
<font color="red"> 204.     return _get_timezone_name(get_current_timezone())</font>
<font color="black"> 205. </font>
<font color="black"> 206. </font>
<font color="green"> 207. def _get_timezone_name(timezone):</font>
<font color="black"> 208.     &quot;&quot;&quot;</font>
<font color="black"> 209.     Returns the name of ``timezone``.</font>
<font color="black"> 210.     &quot;&quot;&quot;</font>
<font color="red"> 211.     try:</font>
<font color="black"> 212.         # for pytz timezones</font>
<font color="red"> 213.         return timezone.zone</font>
<font color="red"> 214.     except AttributeError:</font>
<font color="black"> 215.         # for regular tzinfo objects</font>
<font color="red"> 216.         return timezone.tzname(None)</font>
<font color="black"> 217. </font>
<font color="black"> 218. # Timezone selection functions.</font>
<font color="black"> 219. </font>
<font color="black"> 220. # These functions don't change os.environ['TZ'] and call time.tzset()</font>
<font color="black"> 221. # because it isn't thread safe.</font>
<font color="black"> 222. </font>
<font color="black"> 223. </font>
<font color="green"> 224. def activate(timezone):</font>
<font color="black"> 225.     &quot;&quot;&quot;</font>
<font color="black"> 226.     Sets the time zone for the current thread.</font>
<font color="black"> 227. </font>
<font color="black"> 228.     The ``timezone`` argument must be an instance of a tzinfo subclass or a</font>
<font color="black"> 229.     time zone name. If it is a time zone name, pytz is required.</font>
<font color="black"> 230.     &quot;&quot;&quot;</font>
<font color="red"> 231.     if isinstance(timezone, tzinfo):</font>
<font color="red"> 232.         _active.value = timezone</font>
<font color="red"> 233.     elif isinstance(timezone, six.string_types) and pytz is not None:</font>
<font color="red"> 234.         _active.value = pytz.timezone(timezone)</font>
<font color="black"> 235.     else:</font>
<font color="red"> 236.         raise ValueError(&quot;Invalid timezone: %r&quot; % timezone)</font>
<font color="black"> 237. </font>
<font color="black"> 238. </font>
<font color="green"> 239. def deactivate():</font>
<font color="black"> 240.     &quot;&quot;&quot;</font>
<font color="black"> 241.     Unsets the time zone for the current thread.</font>
<font color="black"> 242. </font>
<font color="black"> 243.     Django will then use the time zone defined by settings.TIME_ZONE.</font>
<font color="black"> 244.     &quot;&quot;&quot;</font>
<font color="red"> 245.     if hasattr(_active, &quot;value&quot;):</font>
<font color="red"> 246.         del _active.value</font>
<font color="black"> 247. </font>
<font color="black"> 248. </font>
<font color="green"> 249. class override(ContextDecorator):</font>
<font color="black"> 250.     &quot;&quot;&quot;</font>
<font color="black"> 251.     Temporarily set the time zone for the current thread.</font>
<font color="black"> 252. </font>
<font color="black"> 253.     This is a context manager that uses ``~django.utils.timezone.activate()``</font>
<font color="black"> 254.     to set the timezone on entry, and restores the previously active timezone</font>
<font color="black"> 255.     on exit.</font>
<font color="black"> 256. </font>
<font color="black"> 257.     The ``timezone`` argument must be an instance of a ``tzinfo`` subclass, a</font>
<font color="black"> 258.     time zone name, or ``None``. If is it a time zone name, pytz is required.</font>
<font color="black"> 259.     If it is ``None``, Django enables the default time zone.</font>
<font color="green"> 260.     &quot;&quot;&quot;</font>
<font color="green"> 261.     def __init__(self, timezone):</font>
<font color="red"> 262.         self.timezone = timezone</font>
<font color="black"> 263. </font>
<font color="green"> 264.     def __enter__(self):</font>
<font color="red"> 265.         self.old_timezone = getattr(_active, 'value', None)</font>
<font color="red"> 266.         if self.timezone is None:</font>
<font color="red"> 267.             deactivate()</font>
<font color="black"> 268.         else:</font>
<font color="red"> 269.             activate(self.timezone)</font>
<font color="black"> 270. </font>
<font color="green"> 271.     def __exit__(self, exc_type, exc_value, traceback):</font>
<font color="red"> 272.         if self.old_timezone is None:</font>
<font color="red"> 273.             deactivate()</font>
<font color="black"> 274.         else:</font>
<font color="red"> 275.             _active.value = self.old_timezone</font>
<font color="black"> 276. </font>
<font color="black"> 277. </font>
<font color="black"> 278. # Templates</font>
<font color="black"> 279. </font>
<font color="green"> 280. def template_localtime(value, use_tz=None):</font>
<font color="black"> 281.     &quot;&quot;&quot;</font>
<font color="black"> 282.     Checks if value is a datetime and converts it to local time if necessary.</font>
<font color="black"> 283. </font>
<font color="black"> 284.     If use_tz is provided and is not None, that will force the value to</font>
<font color="black"> 285.     be converted (or not), overriding the value of settings.USE_TZ.</font>
<font color="black"> 286. </font>
<font color="black"> 287.     This function is designed for use by the template engine.</font>
<font color="black"> 288.     &quot;&quot;&quot;</font>
<font color="red"> 289.     should_convert = (isinstance(value, datetime)</font>
<font color="red"> 290.         and (settings.USE_TZ if use_tz is None else use_tz)</font>
<font color="red"> 291.         and not is_naive(value)</font>
<font color="red"> 292.         and getattr(value, 'convert_to_local_time', True))</font>
<font color="red"> 293.     return localtime(value) if should_convert else value</font>
<font color="black"> 294. </font>
<font color="black"> 295. </font>
<font color="black"> 296. # Utilities</font>
<font color="black"> 297. </font>
<font color="green"> 298. def localtime(value, timezone=None):</font>
<font color="black"> 299.     &quot;&quot;&quot;</font>
<font color="black"> 300.     Converts an aware datetime.datetime to local time.</font>
<font color="black"> 301. </font>
<font color="black"> 302.     Local time is defined by the current time zone, unless another time zone</font>
<font color="black"> 303.     is specified.</font>
<font color="black"> 304.     &quot;&quot;&quot;</font>
<font color="red"> 305.     if timezone is None:</font>
<font color="red"> 306.         timezone = get_current_timezone()</font>
<font color="black"> 307.     # If `value` is naive, astimezone() will raise a ValueError,</font>
<font color="black"> 308.     # so we don't need to perform a redundant check.</font>
<font color="red"> 309.     value = value.astimezone(timezone)</font>
<font color="red"> 310.     if hasattr(timezone, 'normalize'):</font>
<font color="black"> 311.         # This method is available for pytz time zones.</font>
<font color="red"> 312.         value = timezone.normalize(value)</font>
<font color="red"> 313.     return value</font>
<font color="black"> 314. </font>
<font color="black"> 315. </font>
<font color="green"> 316. def now():</font>
<font color="black"> 317.     &quot;&quot;&quot;</font>
<font color="black"> 318.     Returns an aware or naive datetime.datetime, depending on settings.USE_TZ.</font>
<font color="black"> 319.     &quot;&quot;&quot;</font>
<font color="green"> 320.     if settings.USE_TZ:</font>
<font color="black"> 321.         # timeit shows that datetime.now(tz=utc) is 24% slower</font>
<font color="green"> 322.         return datetime.utcnow().replace(tzinfo=utc)</font>
<font color="black"> 323.     else:</font>
<font color="red"> 324.         return datetime.now()</font>
<font color="black"> 325. </font>
<font color="black"> 326. </font>
<font color="black"> 327. # By design, these four functions don't perform any checks on their arguments.</font>
<font color="black"> 328. # The caller should ensure that they don't receive an invalid value like None.</font>
<font color="black"> 329. </font>
<font color="green"> 330. def is_aware(value):</font>
<font color="black"> 331.     &quot;&quot;&quot;</font>
<font color="black"> 332.     Determines if a given datetime.datetime is aware.</font>
<font color="black"> 333. </font>
<font color="black"> 334.     The concept is defined in Python's docs:</font>
<font color="black"> 335.     http://docs.python.org/library/datetime.html#datetime.tzinfo</font>
<font color="black"> 336. </font>
<font color="black"> 337.     Assuming value.tzinfo is either None or a proper datetime.tzinfo,</font>
<font color="black"> 338.     value.utcoffset() implements the appropriate logic.</font>
<font color="black"> 339.     &quot;&quot;&quot;</font>
<font color="green"> 340.     return value.utcoffset() is not None</font>
<font color="black"> 341. </font>
<font color="black"> 342. </font>
<font color="green"> 343. def is_naive(value):</font>
<font color="black"> 344.     &quot;&quot;&quot;</font>
<font color="black"> 345.     Determines if a given datetime.datetime is naive.</font>
<font color="black"> 346. </font>
<font color="black"> 347.     The concept is defined in Python's docs:</font>
<font color="black"> 348.     http://docs.python.org/library/datetime.html#datetime.tzinfo</font>
<font color="black"> 349. </font>
<font color="black"> 350.     Assuming value.tzinfo is either None or a proper datetime.tzinfo,</font>
<font color="black"> 351.     value.utcoffset() implements the appropriate logic.</font>
<font color="black"> 352.     &quot;&quot;&quot;</font>
<font color="green"> 353.     return value.utcoffset() is None</font>
<font color="black"> 354. </font>
<font color="black"> 355. </font>
<font color="green"> 356. def make_aware(value, timezone=None, is_dst=None):</font>
<font color="black"> 357.     &quot;&quot;&quot;</font>
<font color="black"> 358.     Makes a naive datetime.datetime in a given time zone aware.</font>
<font color="black"> 359.     &quot;&quot;&quot;</font>
<font color="red"> 360.     if timezone is None:</font>
<font color="red"> 361.         timezone = get_current_timezone()</font>
<font color="red"> 362.     if hasattr(timezone, 'localize'):</font>
<font color="black"> 363.         # This method is available for pytz time zones.</font>
<font color="red"> 364.         return timezone.localize(value, is_dst=is_dst)</font>
<font color="black"> 365.     else:</font>
<font color="black"> 366.         # Check that we won't overwrite the timezone of an aware datetime.</font>
<font color="red"> 367.         if is_aware(value):</font>
<font color="red"> 368.             raise ValueError(</font>
<font color="red"> 369.                 &quot;make_aware expects a naive datetime, got %s&quot; % value)</font>
<font color="black"> 370.         # This may be wrong around DST changes!</font>
<font color="red"> 371.         return value.replace(tzinfo=timezone)</font>
<font color="black"> 372. </font>
<font color="black"> 373. </font>
<font color="green"> 374. def make_naive(value, timezone=None):</font>
<font color="black"> 375.     &quot;&quot;&quot;</font>
<font color="black"> 376.     Makes an aware datetime.datetime naive in a given time zone.</font>
<font color="black"> 377.     &quot;&quot;&quot;</font>
<font color="green"> 378.     if timezone is None:</font>
<font color="red"> 379.         timezone = get_current_timezone()</font>
<font color="black"> 380.     # If `value` is naive, astimezone() will raise a ValueError,</font>
<font color="black"> 381.     # so we don't need to perform a redundant check.</font>
<font color="green"> 382.     value = value.astimezone(timezone)</font>
<font color="green"> 383.     if hasattr(timezone, 'normalize'):</font>
<font color="black"> 384.         # This method is available for pytz time zones.</font>
<font color="red"> 385.         value = timezone.normalize(value)</font>
<font color="green"> 386.     return value.replace(tzinfo=None)</font>
</pre>


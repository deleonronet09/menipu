source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/views/generic/detail.py</b><br>


file stats: <b>98 lines, 29 executed: 29.6% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   4. from django.db import models</font>
<font color="green">   5. from django.http import Http404</font>
<font color="green">   6. from django.utils.translation import ugettext as _</font>
<font color="green">   7. from django.views.generic.base import ContextMixin, TemplateResponseMixin, View</font>
<font color="black">   8. </font>
<font color="black">   9. </font>
<font color="green">  10. class SingleObjectMixin(ContextMixin):</font>
<font color="black">  11.     &quot;&quot;&quot;</font>
<font color="black">  12.     Provides the ability to retrieve a single object for further manipulation.</font>
<font color="green">  13.     &quot;&quot;&quot;</font>
<font color="green">  14.     model = None</font>
<font color="green">  15.     queryset = None</font>
<font color="green">  16.     slug_field = 'slug'</font>
<font color="green">  17.     context_object_name = None</font>
<font color="green">  18.     slug_url_kwarg = 'slug'</font>
<font color="green">  19.     pk_url_kwarg = 'pk'</font>
<font color="green">  20.     query_pk_and_slug = False</font>
<font color="black">  21. </font>
<font color="green">  22.     def get_object(self, queryset=None):</font>
<font color="black">  23.         &quot;&quot;&quot;</font>
<font color="black">  24.         Returns the object the view is displaying.</font>
<font color="black">  25. </font>
<font color="black">  26.         By default this requires `self.queryset` and a `pk` or `slug` argument</font>
<font color="black">  27.         in the URLconf, but subclasses can override this to return any object.</font>
<font color="black">  28.         &quot;&quot;&quot;</font>
<font color="black">  29.         # Use a custom queryset if provided; this is required for subclasses</font>
<font color="black">  30.         # like DateDetailView</font>
<font color="red">  31.         if queryset is None:</font>
<font color="red">  32.             queryset = self.get_queryset()</font>
<font color="black">  33. </font>
<font color="black">  34.         # Next, try looking up by primary key.</font>
<font color="red">  35.         pk = self.kwargs.get(self.pk_url_kwarg)</font>
<font color="red">  36.         slug = self.kwargs.get(self.slug_url_kwarg)</font>
<font color="red">  37.         if pk is not None:</font>
<font color="red">  38.             queryset = queryset.filter(pk=pk)</font>
<font color="black">  39. </font>
<font color="black">  40.         # Next, try looking up by slug.</font>
<font color="red">  41.         if slug is not None and (pk is None or self.query_pk_and_slug):</font>
<font color="red">  42.             slug_field = self.get_slug_field()</font>
<font color="red">  43.             queryset = queryset.filter(**{slug_field: slug})</font>
<font color="black">  44. </font>
<font color="black">  45.         # If none of those are defined, it's an error.</font>
<font color="red">  46.         if pk is None and slug is None:</font>
<font color="red">  47.             raise AttributeError(&quot;Generic detail view %s must be called with &quot;</font>
<font color="black">  48.                                  &quot;either an object pk or a slug.&quot;</font>
<font color="red">  49.                                  % self.__class__.__name__)</font>
<font color="black">  50. </font>
<font color="red">  51.         try:</font>
<font color="black">  52.             # Get the single item from the filtered queryset</font>
<font color="red">  53.             obj = queryset.get()</font>
<font color="red">  54.         except queryset.model.DoesNotExist:</font>
<font color="red">  55.             raise Http404(_(&quot;No %(verbose_name)s found matching the query&quot;) %</font>
<font color="red">  56.                           {'verbose_name': queryset.model._meta.verbose_name})</font>
<font color="red">  57.         return obj</font>
<font color="black">  58. </font>
<font color="green">  59.     def get_queryset(self):</font>
<font color="black">  60.         &quot;&quot;&quot;</font>
<font color="black">  61.         Return the `QuerySet` that will be used to look up the object.</font>
<font color="black">  62. </font>
<font color="black">  63.         Note that this method is called by the default implementation of</font>
<font color="black">  64.         `get_object` and may not be called if `get_object` is overridden.</font>
<font color="black">  65.         &quot;&quot;&quot;</font>
<font color="red">  66.         if self.queryset is None:</font>
<font color="red">  67.             if self.model:</font>
<font color="red">  68.                 return self.model._default_manager.all()</font>
<font color="black">  69.             else:</font>
<font color="red">  70.                 raise ImproperlyConfigured(</font>
<font color="red">  71.                     &quot;%(cls)s is missing a QuerySet. Define &quot;</font>
<font color="black">  72.                     &quot;%(cls)s.model, %(cls)s.queryset, or override &quot;</font>
<font color="red">  73.                     &quot;%(cls)s.get_queryset().&quot; % {</font>
<font color="red">  74.                         'cls': self.__class__.__name__</font>
<font color="black">  75.                     }</font>
<font color="black">  76.                 )</font>
<font color="red">  77.         return self.queryset.all()</font>
<font color="black">  78. </font>
<font color="green">  79.     def get_slug_field(self):</font>
<font color="black">  80.         &quot;&quot;&quot;</font>
<font color="black">  81.         Get the name of a slug field to be used to look up by slug.</font>
<font color="black">  82.         &quot;&quot;&quot;</font>
<font color="red">  83.         return self.slug_field</font>
<font color="black">  84. </font>
<font color="green">  85.     def get_context_object_name(self, obj):</font>
<font color="black">  86.         &quot;&quot;&quot;</font>
<font color="black">  87.         Get the name to use for the object.</font>
<font color="black">  88.         &quot;&quot;&quot;</font>
<font color="red">  89.         if self.context_object_name:</font>
<font color="red">  90.             return self.context_object_name</font>
<font color="red">  91.         elif isinstance(obj, models.Model):</font>
<font color="red">  92.             if self.object._deferred:</font>
<font color="red">  93.                 obj = obj._meta.proxy_for_model</font>
<font color="red">  94.             return obj._meta.model_name</font>
<font color="black">  95.         else:</font>
<font color="red">  96.             return None</font>
<font color="black">  97. </font>
<font color="green">  98.     def get_context_data(self, **kwargs):</font>
<font color="black">  99.         &quot;&quot;&quot;</font>
<font color="black"> 100.         Insert the single object into the context dict.</font>
<font color="black"> 101.         &quot;&quot;&quot;</font>
<font color="red"> 102.         context = {}</font>
<font color="red"> 103.         if self.object:</font>
<font color="red"> 104.             context['object'] = self.object</font>
<font color="red"> 105.             context_object_name = self.get_context_object_name(self.object)</font>
<font color="red"> 106.             if context_object_name:</font>
<font color="red"> 107.                 context[context_object_name] = self.object</font>
<font color="red"> 108.         context.update(kwargs)</font>
<font color="red"> 109.         return super(SingleObjectMixin, self).get_context_data(**context)</font>
<font color="black"> 110. </font>
<font color="black"> 111. </font>
<font color="green"> 112. class BaseDetailView(SingleObjectMixin, View):</font>
<font color="black"> 113.     &quot;&quot;&quot;</font>
<font color="black"> 114.     A base view for displaying a single object</font>
<font color="green"> 115.     &quot;&quot;&quot;</font>
<font color="green"> 116.     def get(self, request, *args, **kwargs):</font>
<font color="red"> 117.         self.object = self.get_object()</font>
<font color="red"> 118.         context = self.get_context_data(object=self.object)</font>
<font color="red"> 119.         return self.render_to_response(context)</font>
<font color="black"> 120. </font>
<font color="black"> 121. </font>
<font color="green"> 122. class SingleObjectTemplateResponseMixin(TemplateResponseMixin):</font>
<font color="green"> 123.     template_name_field = None</font>
<font color="green"> 124.     template_name_suffix = '_detail'</font>
<font color="black"> 125. </font>
<font color="green"> 126.     def get_template_names(self):</font>
<font color="black"> 127.         &quot;&quot;&quot;</font>
<font color="black"> 128.         Return a list of template names to be used for the request. May not be</font>
<font color="black"> 129.         called if render_to_response is overridden. Returns the following list:</font>
<font color="black"> 130. </font>
<font color="black"> 131.         * the value of ``template_name`` on the view (if provided)</font>
<font color="black"> 132.         * the contents of the ``template_name_field`` field on the</font>
<font color="black"> 133.           object instance that the view is operating upon (if available)</font>
<font color="black"> 134.         * ``&lt;app_label&gt;/&lt;model_name&gt;&lt;template_name_suffix&gt;.html``</font>
<font color="black"> 135.         &quot;&quot;&quot;</font>
<font color="red"> 136.         try:</font>
<font color="red"> 137.             names = super(SingleObjectTemplateResponseMixin, self).get_template_names()</font>
<font color="red"> 138.         except ImproperlyConfigured:</font>
<font color="black"> 139.             # If template_name isn't specified, it's not a problem --</font>
<font color="black"> 140.             # we just start with an empty list.</font>
<font color="red"> 141.             names = []</font>
<font color="black"> 142. </font>
<font color="black"> 143.             # If self.template_name_field is set, grab the value of the field</font>
<font color="black"> 144.             # of that name from the object; this is the most specific template</font>
<font color="black"> 145.             # name, if given.</font>
<font color="red"> 146.             if self.object and self.template_name_field:</font>
<font color="red"> 147.                 name = getattr(self.object, self.template_name_field, None)</font>
<font color="red"> 148.                 if name:</font>
<font color="red"> 149.                     names.insert(0, name)</font>
<font color="black"> 150. </font>
<font color="black"> 151.             # The least-specific option is the default &lt;app&gt;/&lt;model&gt;_detail.html;</font>
<font color="black"> 152.             # only use this if the object in question is a model.</font>
<font color="red"> 153.             if isinstance(self.object, models.Model):</font>
<font color="red"> 154.                 object_meta = self.object._meta</font>
<font color="red"> 155.                 if self.object._deferred:</font>
<font color="red"> 156.                     object_meta = self.object._meta.proxy_for_model._meta</font>
<font color="red"> 157.                 names.append(&quot;%s/%s%s.html&quot; % (</font>
<font color="red"> 158.                     object_meta.app_label,</font>
<font color="red"> 159.                     object_meta.model_name,</font>
<font color="red"> 160.                     self.template_name_suffix</font>
<font color="black"> 161.                 ))</font>
<font color="red"> 162.             elif hasattr(self, 'model') and self.model is not None and issubclass(self.model, models.Model):</font>
<font color="red"> 163.                 names.append(&quot;%s/%s%s.html&quot; % (</font>
<font color="red"> 164.                     self.model._meta.app_label,</font>
<font color="red"> 165.                     self.model._meta.model_name,</font>
<font color="red"> 166.                     self.template_name_suffix</font>
<font color="black"> 167.                 ))</font>
<font color="black"> 168. </font>
<font color="black"> 169.             # If we still haven't managed to find any template names, we should</font>
<font color="black"> 170.             # re-raise the ImproperlyConfigured to alert the user.</font>
<font color="red"> 171.             if not names:</font>
<font color="red"> 172.                 raise</font>
<font color="black"> 173. </font>
<font color="red"> 174.         return names</font>
<font color="black"> 175. </font>
<font color="black"> 176. </font>
<font color="green"> 177. class DetailView(SingleObjectTemplateResponseMixin, BaseDetailView):</font>
<font color="black"> 178.     &quot;&quot;&quot;</font>
<font color="black"> 179.     Render a &quot;detail&quot; view of an object.</font>
<font color="black"> 180. </font>
<font color="black"> 181.     By default this is a model instance looked up from `self.queryset`, but the</font>
<font color="black"> 182.     view will support display of *any* object by overriding `self.get_object()`.</font>
<font color="green"> 183.     &quot;&quot;&quot;</font>
</pre>


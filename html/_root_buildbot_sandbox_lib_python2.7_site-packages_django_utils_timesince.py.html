source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/timesince.py</b><br>


file stats: <b>37 lines, 14 executed: 37.8% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import calendar</font>
<font color="green">   4. import datetime</font>
<font color="black">   5. </font>
<font color="green">   6. from django.utils.html import avoid_wrapping</font>
<font color="green">   7. from django.utils.timezone import is_aware, utc</font>
<font color="green">   8. from django.utils.translation import ugettext, ungettext_lazy</font>
<font color="black">   9. </font>
<font color="black">  10. TIMESINCE_CHUNKS = (</font>
<font color="green">  11.     (60 * 60 * 24 * 365, ungettext_lazy('%d year', '%d years')),</font>
<font color="green">  12.     (60 * 60 * 24 * 30, ungettext_lazy('%d month', '%d months')),</font>
<font color="green">  13.     (60 * 60 * 24 * 7, ungettext_lazy('%d week', '%d weeks')),</font>
<font color="green">  14.     (60 * 60 * 24, ungettext_lazy('%d day', '%d days')),</font>
<font color="green">  15.     (60 * 60, ungettext_lazy('%d hour', '%d hours')),</font>
<font color="green">  16.     (60, ungettext_lazy('%d minute', '%d minutes'))</font>
<font color="black">  17. )</font>
<font color="black">  18. </font>
<font color="black">  19. </font>
<font color="green">  20. def timesince(d, now=None, reversed=False):</font>
<font color="black">  21.     &quot;&quot;&quot;</font>
<font color="black">  22.     Takes two datetime objects and returns the time between d and now</font>
<font color="black">  23.     as a nicely formatted string, e.g. &quot;10 minutes&quot;.  If d occurs after now,</font>
<font color="black">  24.     then &quot;0 minutes&quot; is returned.</font>
<font color="black">  25. </font>
<font color="black">  26.     Units used are years, months, weeks, days, hours, and minutes.</font>
<font color="black">  27.     Seconds and microseconds are ignored.  Up to two adjacent units will be</font>
<font color="black">  28.     displayed.  For example, &quot;2 weeks, 3 days&quot; and &quot;1 year, 3 months&quot; are</font>
<font color="black">  29.     possible outputs, but &quot;2 weeks, 3 hours&quot; and &quot;1 year, 5 days&quot; are not.</font>
<font color="black">  30. </font>
<font color="black">  31.     Adapted from</font>
<font color="black">  32.     http://web.archive.org/web/20060617175230/http://blog.natbat.co.uk/archive/2003/Jun/14/time_since</font>
<font color="black">  33.     &quot;&quot;&quot;</font>
<font color="black">  34.     # Convert datetime.date to datetime.datetime for comparison.</font>
<font color="red">  35.     if not isinstance(d, datetime.datetime):</font>
<font color="red">  36.         d = datetime.datetime(d.year, d.month, d.day)</font>
<font color="red">  37.     if now and not isinstance(now, datetime.datetime):</font>
<font color="red">  38.         now = datetime.datetime(now.year, now.month, now.day)</font>
<font color="black">  39. </font>
<font color="red">  40.     if not now:</font>
<font color="red">  41.         now = datetime.datetime.now(utc if is_aware(d) else None)</font>
<font color="black">  42. </font>
<font color="red">  43.     delta = (d - now) if reversed else (now - d)</font>
<font color="black">  44. </font>
<font color="black">  45.     # Deal with leapyears by subtracing the number of leapdays</font>
<font color="red">  46.     delta -= datetime.timedelta(calendar.leapdays(d.year, now.year))</font>
<font color="black">  47. </font>
<font color="black">  48.     # ignore microseconds</font>
<font color="red">  49.     since = delta.days * 24 * 60 * 60 + delta.seconds</font>
<font color="red">  50.     if since &lt;= 0:</font>
<font color="black">  51.         # d is in the future compared to now, stop processing.</font>
<font color="red">  52.         return avoid_wrapping(ugettext('0 minutes'))</font>
<font color="red">  53.     for i, (seconds, name) in enumerate(TIMESINCE_CHUNKS):</font>
<font color="red">  54.         count = since // seconds</font>
<font color="red">  55.         if count != 0:</font>
<font color="red">  56.             break</font>
<font color="red">  57.     result = avoid_wrapping(name % count)</font>
<font color="red">  58.     if i + 1 &lt; len(TIMESINCE_CHUNKS):</font>
<font color="black">  59.         # Now get the second item</font>
<font color="red">  60.         seconds2, name2 = TIMESINCE_CHUNKS[i + 1]</font>
<font color="red">  61.         count2 = (since - (seconds * count)) // seconds2</font>
<font color="red">  62.         if count2 != 0:</font>
<font color="red">  63.             result += ugettext(', ') + avoid_wrapping(name2 % count2)</font>
<font color="red">  64.     return result</font>
<font color="black">  65. </font>
<font color="black">  66. </font>
<font color="green">  67. def timeuntil(d, now=None):</font>
<font color="black">  68.     &quot;&quot;&quot;</font>
<font color="black">  69.     Like timesince, but returns a string measuring the time until</font>
<font color="black">  70.     the given time.</font>
<font color="black">  71.     &quot;&quot;&quot;</font>
<font color="red">  72.     return timesince(d, now, reversed=True)</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/test/signals.py</b><br>


file stats: <b>120 lines, 25 executed: 20.8% covered</b>
<pre>
<font color="green">   1. import os</font>
<font color="green">   2. import threading</font>
<font color="green">   3. import time</font>
<font color="green">   4. import warnings</font>
<font color="black">   5. </font>
<font color="green">   6. from django.core.signals import setting_changed</font>
<font color="green">   7. from django.db import connections, router</font>
<font color="green">   8. from django.db.utils import ConnectionRouter</font>
<font color="green">   9. from django.dispatch import Signal, receiver</font>
<font color="green">  10. from django.utils import timezone</font>
<font color="green">  11. from django.utils.functional import empty</font>
<font color="black">  12. </font>
<font color="green">  13. template_rendered = Signal(providing_args=[&quot;template&quot;, &quot;context&quot;])</font>
<font color="black">  14. </font>
<font color="black">  15. # Most setting_changed receivers are supposed to be added below,</font>
<font color="black">  16. # except for cases where the receiver is related to a contrib app.</font>
<font color="black">  17. </font>
<font color="black">  18. # Settings that may not work well when using 'override_settings' (#19031)</font>
<font color="green">  19. COMPLEX_OVERRIDE_SETTINGS = {'DATABASES'}</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. @receiver(setting_changed)</font>
<font color="black">  23. def clear_cache_handlers(**kwargs):</font>
<font color="red">  24.     if kwargs['setting'] == 'CACHES':</font>
<font color="red">  25.         from django.core.cache import caches</font>
<font color="red">  26.         caches._caches = threading.local()</font>
<font color="black">  27. </font>
<font color="black">  28. </font>
<font color="green">  29. @receiver(setting_changed)</font>
<font color="black">  30. def update_installed_apps(**kwargs):</font>
<font color="red">  31.     if kwargs['setting'] == 'INSTALLED_APPS':</font>
<font color="black">  32.         # Rebuild any AppDirectoriesFinder instance.</font>
<font color="red">  33.         from django.contrib.staticfiles.finders import get_finder</font>
<font color="red">  34.         get_finder.cache_clear()</font>
<font color="black">  35.         # Rebuild management commands cache</font>
<font color="red">  36.         from django.core.management import get_commands</font>
<font color="red">  37.         get_commands.cache_clear()</font>
<font color="black">  38.         # Rebuild get_app_template_dirs cache.</font>
<font color="red">  39.         from django.template.utils import get_app_template_dirs</font>
<font color="red">  40.         get_app_template_dirs.cache_clear()</font>
<font color="black">  41.         # Rebuild translations cache.</font>
<font color="red">  42.         from django.utils.translation import trans_real</font>
<font color="red">  43.         trans_real._translations = {}</font>
<font color="black">  44. </font>
<font color="black">  45. </font>
<font color="green">  46. @receiver(setting_changed)</font>
<font color="black">  47. def update_connections_time_zone(**kwargs):</font>
<font color="red">  48.     if kwargs['setting'] == 'TIME_ZONE':</font>
<font color="black">  49.         # Reset process time zone</font>
<font color="red">  50.         if hasattr(time, 'tzset'):</font>
<font color="red">  51.             if kwargs['value']:</font>
<font color="red">  52.                 os.environ['TZ'] = kwargs['value']</font>
<font color="black">  53.             else:</font>
<font color="red">  54.                 os.environ.pop('TZ', None)</font>
<font color="red">  55.             time.tzset()</font>
<font color="black">  56. </font>
<font color="black">  57.         # Reset local time zone cache</font>
<font color="red">  58.         timezone.get_default_timezone.cache_clear()</font>
<font color="black">  59. </font>
<font color="black">  60.     # Reset the database connections' time zone</font>
<font color="red">  61.     if kwargs['setting'] in {'TIME_ZONE', 'USE_TZ'}:</font>
<font color="red">  62.         for conn in connections.all():</font>
<font color="red">  63.             try:</font>
<font color="red">  64.                 del conn.timezone</font>
<font color="red">  65.             except AttributeError:</font>
<font color="red">  66.                 pass</font>
<font color="red">  67.             try:</font>
<font color="red">  68.                 del conn.timezone_name</font>
<font color="red">  69.             except AttributeError:</font>
<font color="red">  70.                 pass</font>
<font color="red">  71.             tz_sql = conn.ops.set_time_zone_sql()</font>
<font color="red">  72.             if tz_sql:</font>
<font color="red">  73.                 with conn.cursor() as cursor:</font>
<font color="red">  74.                     cursor.execute(tz_sql, [conn.timezone_name])</font>
<font color="black">  75. </font>
<font color="black">  76. </font>
<font color="green">  77. @receiver(setting_changed)</font>
<font color="black">  78. def clear_routers_cache(**kwargs):</font>
<font color="red">  79.     if kwargs['setting'] == 'DATABASE_ROUTERS':</font>
<font color="red">  80.         router.routers = ConnectionRouter().routers</font>
<font color="black">  81. </font>
<font color="black">  82. </font>
<font color="green">  83. @receiver(setting_changed)</font>
<font color="black">  84. def reset_template_engines(**kwargs):</font>
<font color="red">  85.     if kwargs['setting'] in {</font>
<font color="red">  86.         'TEMPLATES',</font>
<font color="red">  87.         'TEMPLATE_DIRS',</font>
<font color="red">  88.         'ALLOWED_INCLUDE_ROOTS',</font>
<font color="red">  89.         'TEMPLATE_CONTEXT_PROCESSORS',</font>
<font color="red">  90.         'TEMPLATE_DEBUG',</font>
<font color="red">  91.         'TEMPLATE_LOADERS',</font>
<font color="red">  92.         'TEMPLATE_STRING_IF_INVALID',</font>
<font color="red">  93.         'DEBUG',</font>
<font color="red">  94.         'FILE_CHARSET',</font>
<font color="red">  95.         'INSTALLED_APPS',</font>
<font color="black">  96.     }:</font>
<font color="red">  97.         from django.template import engines</font>
<font color="red">  98.         try:</font>
<font color="red">  99.             del engines.templates</font>
<font color="red"> 100.         except AttributeError:</font>
<font color="red"> 101.             pass</font>
<font color="red"> 102.         engines._templates = None</font>
<font color="red"> 103.         engines._engines = {}</font>
<font color="red"> 104.         from django.template.engine import Engine</font>
<font color="red"> 105.         Engine.get_default.cache_clear()</font>
<font color="black"> 106. </font>
<font color="black"> 107. </font>
<font color="green"> 108. @receiver(setting_changed)</font>
<font color="black"> 109. def clear_serializers_cache(**kwargs):</font>
<font color="red"> 110.     if kwargs['setting'] == 'SERIALIZATION_MODULES':</font>
<font color="red"> 111.         from django.core import serializers</font>
<font color="red"> 112.         serializers._serializers = {}</font>
<font color="black"> 113. </font>
<font color="black"> 114. </font>
<font color="green"> 115. @receiver(setting_changed)</font>
<font color="black"> 116. def language_changed(**kwargs):</font>
<font color="red"> 117.     if kwargs['setting'] in {'LANGUAGES', 'LANGUAGE_CODE', 'LOCALE_PATHS'}:</font>
<font color="red"> 118.         from django.utils.translation import trans_real</font>
<font color="red"> 119.         trans_real._default = None</font>
<font color="red"> 120.         trans_real._active = threading.local()</font>
<font color="red"> 121.     if kwargs['setting'] in {'LANGUAGES', 'LOCALE_PATHS'}:</font>
<font color="red"> 122.         from django.utils.translation import trans_real</font>
<font color="red"> 123.         trans_real._translations = {}</font>
<font color="red"> 124.         trans_real.check_for_language.cache_clear()</font>
<font color="black"> 125. </font>
<font color="black"> 126. </font>
<font color="green"> 127. @receiver(setting_changed)</font>
<font color="black"> 128. def file_storage_changed(**kwargs):</font>
<font color="black"> 129.     file_storage_settings = {</font>
<font color="red"> 130.         'DEFAULT_FILE_STORAGE',</font>
<font color="red"> 131.         'FILE_UPLOAD_DIRECTORY_PERMISSIONS',</font>
<font color="red"> 132.         'FILE_UPLOAD_PERMISSIONS',</font>
<font color="red"> 133.         'MEDIA_ROOT',</font>
<font color="red"> 134.         'MEDIA_URL',</font>
<font color="black"> 135.     }</font>
<font color="black"> 136. </font>
<font color="red"> 137.     if kwargs['setting'] in file_storage_settings:</font>
<font color="red"> 138.         from django.core.files.storage import default_storage</font>
<font color="red"> 139.         default_storage._wrapped = empty</font>
<font color="black"> 140. </font>
<font color="black"> 141. </font>
<font color="green"> 142. @receiver(setting_changed)</font>
<font color="black"> 143. def complex_setting_changed(**kwargs):</font>
<font color="red"> 144.     if kwargs['enter'] and kwargs['setting'] in COMPLEX_OVERRIDE_SETTINGS:</font>
<font color="black"> 145.         # Considering the current implementation of the signals framework,</font>
<font color="black"> 146.         # stacklevel=5 shows the line containing the override_settings call.</font>
<font color="red"> 147.         warnings.warn(&quot;Overriding setting %s can lead to unexpected behavior.&quot;</font>
<font color="red"> 148.                       % kwargs['setting'], stacklevel=5)</font>
<font color="black"> 149. </font>
<font color="black"> 150. </font>
<font color="green"> 151. @receiver(setting_changed)</font>
<font color="black"> 152. def root_urlconf_changed(**kwargs):</font>
<font color="red"> 153.     if kwargs['setting'] == 'ROOT_URLCONF':</font>
<font color="red"> 154.         from django.core.urlresolvers import clear_url_caches, set_urlconf</font>
<font color="red"> 155.         clear_url_caches()</font>
<font color="red"> 156.         set_urlconf(None)</font>
<font color="black"> 157. </font>
<font color="black"> 158. </font>
<font color="green"> 159. @receiver(setting_changed)</font>
<font color="black"> 160. def static_storage_changed(**kwargs):</font>
<font color="red"> 161.     if kwargs['setting'] in {</font>
<font color="red"> 162.         'STATICFILES_STORAGE',</font>
<font color="red"> 163.         'STATIC_ROOT',</font>
<font color="red"> 164.         'STATIC_URL',</font>
<font color="black"> 165.     }:</font>
<font color="red"> 166.         from django.contrib.staticfiles.storage import staticfiles_storage</font>
<font color="red"> 167.         staticfiles_storage._wrapped = empty</font>
<font color="black"> 168. </font>
<font color="black"> 169. </font>
<font color="green"> 170. @receiver(setting_changed)</font>
<font color="black"> 171. def static_finders_changed(**kwargs):</font>
<font color="red"> 172.     if kwargs['setting'] in {</font>
<font color="red"> 173.         'STATICFILES_DIRS',</font>
<font color="red"> 174.         'STATIC_ROOT',</font>
<font color="black"> 175.     }:</font>
<font color="red"> 176.         from django.contrib.staticfiles.finders import get_finder</font>
<font color="red"> 177.         get_finder.cache_clear()</font>
<font color="black"> 178. </font>
<font color="black"> 179. </font>
<font color="green"> 180. @receiver(setting_changed)</font>
<font color="black"> 181. def auth_password_validators_changed(**kwargs):</font>
<font color="red"> 182.     if kwargs['setting'] == 'AUTH_PASSWORD_VALIDATORS':</font>
<font color="red"> 183.         from django.contrib.auth.password_validation import get_default_password_validators</font>
<font color="red"> 184.         get_default_password_validators.cache_clear()</font>
</pre>


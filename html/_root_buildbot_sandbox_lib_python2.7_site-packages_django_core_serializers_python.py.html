source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/serializers/python.py</b><br>


file stats: <b>121 lines, 37 executed: 30.6% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. A Python &quot;serializer&quot;. Doesn't do much serializing per se -- just converts to</font>
<font color="black">   3. and from basic Python data types (lists, dicts, strings, etc.). Useful as a basis for</font>
<font color="black">   4. other serializers.</font>
<font color="green">   5. &quot;&quot;&quot;</font>
<font color="green">   6. from __future__ import unicode_literals</font>
<font color="black">   7. </font>
<font color="green">   8. from collections import OrderedDict</font>
<font color="black">   9. </font>
<font color="green">  10. from django.apps import apps</font>
<font color="green">  11. from django.conf import settings</font>
<font color="green">  12. from django.core.serializers import base</font>
<font color="green">  13. from django.db import DEFAULT_DB_ALIAS, models</font>
<font color="green">  14. from django.utils import six</font>
<font color="green">  15. from django.utils.encoding import force_text, is_protected_type</font>
<font color="black">  16. </font>
<font color="black">  17. </font>
<font color="green">  18. class Serializer(base.Serializer):</font>
<font color="black">  19.     &quot;&quot;&quot;</font>
<font color="black">  20.     Serializes a QuerySet to basic Python objects.</font>
<font color="green">  21.     &quot;&quot;&quot;</font>
<font color="black">  22. </font>
<font color="green">  23.     internal_use_only = True</font>
<font color="black">  24. </font>
<font color="green">  25.     def start_serialization(self):</font>
<font color="red">  26.         self._current = None</font>
<font color="red">  27.         self.objects = []</font>
<font color="black">  28. </font>
<font color="green">  29.     def end_serialization(self):</font>
<font color="red">  30.         pass</font>
<font color="black">  31. </font>
<font color="green">  32.     def start_object(self, obj):</font>
<font color="green">  33.         self._current = OrderedDict()</font>
<font color="black">  34. </font>
<font color="green">  35.     def end_object(self, obj):</font>
<font color="red">  36.         self.objects.append(self.get_dump_object(obj))</font>
<font color="red">  37.         self._current = None</font>
<font color="black">  38. </font>
<font color="green">  39.     def get_dump_object(self, obj):</font>
<font color="green">  40.         model = obj._meta.proxy_for_model if obj._deferred else obj.__class__</font>
<font color="green">  41.         data = OrderedDict([('model', force_text(model._meta))])</font>
<font color="green">  42.         if not self.use_natural_primary_keys or not hasattr(obj, 'natural_key'):</font>
<font color="green">  43.             data[&quot;pk&quot;] = force_text(obj._get_pk_val(), strings_only=True)</font>
<font color="green">  44.         data['fields'] = self._current</font>
<font color="green">  45.         return data</font>
<font color="black">  46. </font>
<font color="green">  47.     def handle_field(self, obj, field):</font>
<font color="green">  48.         value = field.value_from_object(obj)</font>
<font color="black">  49.         # Protected types (i.e., primitives like None, numbers, dates,</font>
<font color="black">  50.         # and Decimals) are passed through as is. All other values are</font>
<font color="black">  51.         # converted to string first.</font>
<font color="green">  52.         if is_protected_type(value):</font>
<font color="red">  53.             self._current[field.name] = value</font>
<font color="black">  54.         else:</font>
<font color="green">  55.             self._current[field.name] = field.value_to_string(obj)</font>
<font color="black">  56. </font>
<font color="green">  57.     def handle_fk_field(self, obj, field):</font>
<font color="green">  58.         if self.use_natural_foreign_keys and hasattr(field.remote_field.model, 'natural_key'):</font>
<font color="red">  59.             related = getattr(obj, field.name)</font>
<font color="red">  60.             if related:</font>
<font color="red">  61.                 value = related.natural_key()</font>
<font color="black">  62.             else:</font>
<font color="red">  63.                 value = None</font>
<font color="black">  64.         else:</font>
<font color="green">  65.             value = getattr(obj, field.get_attname())</font>
<font color="green">  66.             if not is_protected_type(value):</font>
<font color="red">  67.                 value = field.value_to_string(obj)</font>
<font color="green">  68.         self._current[field.name] = value</font>
<font color="black">  69. </font>
<font color="green">  70.     def handle_m2m_field(self, obj, field):</font>
<font color="red">  71.         if field.remote_field.through._meta.auto_created:</font>
<font color="red">  72.             if self.use_natural_foreign_keys and hasattr(field.remote_field.model, 'natural_key'):</font>
<font color="red">  73.                 m2m_value = lambda value: value.natural_key()</font>
<font color="black">  74.             else:</font>
<font color="red">  75.                 m2m_value = lambda value: force_text(value._get_pk_val(), strings_only=True)</font>
<font color="red">  76.             self._current[field.name] = [m2m_value(related)</font>
<font color="red">  77.                                for related in getattr(obj, field.name).iterator()]</font>
<font color="black">  78. </font>
<font color="green">  79.     def getvalue(self):</font>
<font color="red">  80.         return self.objects</font>
<font color="black">  81. </font>
<font color="black">  82. </font>
<font color="green">  83. def Deserializer(object_list, **options):</font>
<font color="black">  84.     &quot;&quot;&quot;</font>
<font color="black">  85.     Deserialize simple Python objects back into Django ORM instances.</font>
<font color="black">  86. </font>
<font color="black">  87.     It's expected that you pass the Python objects themselves (instead of a</font>
<font color="black">  88.     stream or a string) to the constructor</font>
<font color="black">  89.     &quot;&quot;&quot;</font>
<font color="red">  90.     db = options.pop('using', DEFAULT_DB_ALIAS)</font>
<font color="red">  91.     ignore = options.pop('ignorenonexistent', False)</font>
<font color="black">  92. </font>
<font color="red">  93.     for d in object_list:</font>
<font color="black">  94.         # Look up the model and starting build a dict of data for it.</font>
<font color="red">  95.         try:</font>
<font color="red">  96.             Model = _get_model(d[&quot;model&quot;])</font>
<font color="red">  97.         except base.DeserializationError:</font>
<font color="red">  98.             if ignore:</font>
<font color="red">  99.                 continue</font>
<font color="black"> 100.             else:</font>
<font color="red"> 101.                 raise</font>
<font color="red"> 102.         data = {}</font>
<font color="red"> 103.         if 'pk' in d:</font>
<font color="red"> 104.             try:</font>
<font color="red"> 105.                 data[Model._meta.pk.attname] = Model._meta.pk.to_python(d.get('pk'))</font>
<font color="red"> 106.             except Exception as e:</font>
<font color="red"> 107.                 raise base.DeserializationError.WithData(e, d['model'], d.get('pk'), None)</font>
<font color="red"> 108.         m2m_data = {}</font>
<font color="red"> 109.         field_names = {f.name for f in Model._meta.get_fields()}</font>
<font color="black"> 110. </font>
<font color="black"> 111.         # Handle each field</font>
<font color="red"> 112.         for (field_name, field_value) in six.iteritems(d[&quot;fields&quot;]):</font>
<font color="black"> 113. </font>
<font color="red"> 114.             if ignore and field_name not in field_names:</font>
<font color="black"> 115.                 # skip fields no longer on model</font>
<font color="red"> 116.                 continue</font>
<font color="black"> 117. </font>
<font color="red"> 118.             if isinstance(field_value, str):</font>
<font color="red"> 119.                 field_value = force_text(</font>
<font color="red"> 120.                     field_value, options.get(&quot;encoding&quot;, settings.DEFAULT_CHARSET), strings_only=True</font>
<font color="black"> 121.                 )</font>
<font color="black"> 122. </font>
<font color="red"> 123.             field = Model._meta.get_field(field_name)</font>
<font color="black"> 124. </font>
<font color="black"> 125.             # Handle M2M relations</font>
<font color="red"> 126.             if field.remote_field and isinstance(field.remote_field, models.ManyToManyRel):</font>
<font color="red"> 127.                 model = field.remote_field.model</font>
<font color="red"> 128.                 if hasattr(model._default_manager, 'get_by_natural_key'):</font>
<font color="red"> 129.                     def m2m_convert(value):</font>
<font color="red"> 130.                         if hasattr(value, '__iter__') and not isinstance(value, six.text_type):</font>
<font color="red"> 131.                             return model._default_manager.db_manager(db).get_by_natural_key(*value).pk</font>
<font color="black"> 132.                         else:</font>
<font color="red"> 133.                             return force_text(model._meta.pk.to_python(value), strings_only=True)</font>
<font color="black"> 134.                 else:</font>
<font color="red"> 135.                     m2m_convert = lambda v: force_text(model._meta.pk.to_python(v), strings_only=True)</font>
<font color="black"> 136. </font>
<font color="red"> 137.                 try:</font>
<font color="red"> 138.                     m2m_data[field.name] = []</font>
<font color="red"> 139.                     for pk in field_value:</font>
<font color="red"> 140.                         m2m_data[field.name].append(m2m_convert(pk))</font>
<font color="red"> 141.                 except Exception as e:</font>
<font color="red"> 142.                     raise base.DeserializationError.WithData(e, d['model'], d.get('pk'), pk)</font>
<font color="black"> 143. </font>
<font color="black"> 144.             # Handle FK fields</font>
<font color="red"> 145.             elif field.remote_field and isinstance(field.remote_field, models.ManyToOneRel):</font>
<font color="red"> 146.                 model = field.remote_field.model</font>
<font color="red"> 147.                 if field_value is not None:</font>
<font color="red"> 148.                     try:</font>
<font color="red"> 149.                         default_manager = model._default_manager</font>
<font color="red"> 150.                         field_name = field.remote_field.field_name</font>
<font color="red"> 151.                         if hasattr(default_manager, 'get_by_natural_key'):</font>
<font color="red"> 152.                             if hasattr(field_value, '__iter__') and not isinstance(field_value, six.text_type):</font>
<font color="red"> 153.                                 obj = default_manager.db_manager(db).get_by_natural_key(*field_value)</font>
<font color="red"> 154.                                 value = getattr(obj, field.remote_field.field_name)</font>
<font color="black"> 155.                                 # If this is a natural foreign key to an object that</font>
<font color="black"> 156.                                 # has a FK/O2O as the foreign key, use the FK value</font>
<font color="red"> 157.                                 if model._meta.pk.remote_field:</font>
<font color="red"> 158.                                     value = value.pk</font>
<font color="black"> 159.                             else:</font>
<font color="red"> 160.                                 value = model._meta.get_field(field_name).to_python(field_value)</font>
<font color="red"> 161.                             data[field.attname] = value</font>
<font color="black"> 162.                         else:</font>
<font color="red"> 163.                             data[field.attname] = model._meta.get_field(field_name).to_python(field_value)</font>
<font color="red"> 164.                     except Exception as e:</font>
<font color="red"> 165.                         raise base.DeserializationError.WithData(e, d['model'], d.get('pk'), field_value)</font>
<font color="black"> 166.                 else:</font>
<font color="red"> 167.                     data[field.attname] = None</font>
<font color="black"> 168. </font>
<font color="black"> 169.             # Handle all other fields</font>
<font color="black"> 170.             else:</font>
<font color="red"> 171.                 try:</font>
<font color="red"> 172.                     data[field.name] = field.to_python(field_value)</font>
<font color="red"> 173.                 except Exception as e:</font>
<font color="red"> 174.                     raise base.DeserializationError.WithData(e, d['model'], d.get('pk'), field_value)</font>
<font color="black"> 175. </font>
<font color="red"> 176.         obj = base.build_instance(Model, data, db)</font>
<font color="red"> 177.         yield base.DeserializedObject(obj, m2m_data)</font>
<font color="black"> 178. </font>
<font color="black"> 179. </font>
<font color="green"> 180. def _get_model(model_identifier):</font>
<font color="black"> 181.     &quot;&quot;&quot;</font>
<font color="black"> 182.     Helper to look up a model from an &quot;app_label.model_name&quot; string.</font>
<font color="black"> 183.     &quot;&quot;&quot;</font>
<font color="red"> 184.     try:</font>
<font color="red"> 185.         return apps.get_model(model_identifier)</font>
<font color="red"> 186.     except (LookupError, TypeError):</font>
<font color="red"> 187.         raise base.DeserializationError(&quot;Invalid model identifier: '%s'&quot; % model_identifier)</font>
</pre>


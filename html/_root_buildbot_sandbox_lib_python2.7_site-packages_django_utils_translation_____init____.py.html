source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/translation/__init__.py</b><br>


file stats: <b>137 lines, 84 executed: 61.3% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Internationalization support.</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="green">   4. from __future__ import unicode_literals</font>
<font color="black">   5. </font>
<font color="green">   6. import re</font>
<font color="black">   7. </font>
<font color="green">   8. from django.utils import six</font>
<font color="green">   9. from django.utils.decorators import ContextDecorator</font>
<font color="green">  10. from django.utils.encoding import force_text</font>
<font color="green">  11. from django.utils.functional import lazy</font>
<font color="black">  12. </font>
<font color="black">  13. __all__ = [</font>
<font color="green">  14.     'activate', 'deactivate', 'override', 'deactivate_all',</font>
<font color="green">  15.     'get_language', 'get_language_from_request',</font>
<font color="green">  16.     'get_language_info', 'get_language_bidi',</font>
<font color="green">  17.     'check_for_language', 'to_locale', 'templatize', 'string_concat',</font>
<font color="green">  18.     'gettext', 'gettext_lazy', 'gettext_noop',</font>
<font color="green">  19.     'ugettext', 'ugettext_lazy', 'ugettext_noop',</font>
<font color="green">  20.     'ngettext', 'ngettext_lazy',</font>
<font color="green">  21.     'ungettext', 'ungettext_lazy',</font>
<font color="green">  22.     'pgettext', 'pgettext_lazy',</font>
<font color="green">  23.     'npgettext', 'npgettext_lazy',</font>
<font color="green">  24.     'LANGUAGE_SESSION_KEY',</font>
<font color="black">  25. ]</font>
<font color="black">  26. </font>
<font color="green">  27. LANGUAGE_SESSION_KEY = '_language'</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. class TranslatorCommentWarning(SyntaxWarning):</font>
<font color="green">  31.     pass</font>
<font color="black">  32. </font>
<font color="black">  33. </font>
<font color="black">  34. # Here be dragons, so a short explanation of the logic won't hurt:</font>
<font color="black">  35. # We are trying to solve two problems: (1) access settings, in particular</font>
<font color="black">  36. # settings.USE_I18N, as late as possible, so that modules can be imported</font>
<font color="black">  37. # without having to first configure Django, and (2) if some other code creates</font>
<font color="black">  38. # a reference to one of these functions, don't break that reference when we</font>
<font color="black">  39. # replace the functions with their real counterparts (once we do access the</font>
<font color="black">  40. # settings).</font>
<font color="black">  41. </font>
<font color="green">  42. class Trans(object):</font>
<font color="black">  43.     &quot;&quot;&quot;</font>
<font color="black">  44.     The purpose of this class is to store the actual translation function upon</font>
<font color="black">  45.     receiving the first call to that function. After this is done, changes to</font>
<font color="black">  46.     USE_I18N will have no effect to which function is served upon request. If</font>
<font color="black">  47.     your tests rely on changing USE_I18N, you can delete all the functions</font>
<font color="black">  48.     from _trans.__dict__.</font>
<font color="black">  49. </font>
<font color="black">  50.     Note that storing the function with setattr will have a noticeable</font>
<font color="black">  51.     performance effect, as access to the function goes the normal path,</font>
<font color="black">  52.     instead of using __getattr__.</font>
<font color="green">  53.     &quot;&quot;&quot;</font>
<font color="black">  54. </font>
<font color="green">  55.     def __getattr__(self, real_name):</font>
<font color="green">  56.         from django.conf import settings</font>
<font color="green">  57.         if settings.USE_I18N:</font>
<font color="green">  58.             from django.utils.translation import trans_real as trans</font>
<font color="black">  59.         else:</font>
<font color="red">  60.             from django.utils.translation import trans_null as trans</font>
<font color="green">  61.         setattr(self, real_name, getattr(trans, real_name))</font>
<font color="green">  62.         return getattr(trans, real_name)</font>
<font color="black">  63. </font>
<font color="green">  64. _trans = Trans()</font>
<font color="black">  65. </font>
<font color="black">  66. # The Trans class is no more needed, so remove it from the namespace.</font>
<font color="green">  67. del Trans</font>
<font color="black">  68. </font>
<font color="black">  69. </font>
<font color="green">  70. def gettext_noop(message):</font>
<font color="red">  71.     return _trans.gettext_noop(message)</font>
<font color="black">  72. </font>
<font color="green">  73. ugettext_noop = gettext_noop</font>
<font color="black">  74. </font>
<font color="black">  75. </font>
<font color="green">  76. def gettext(message):</font>
<font color="red">  77.     return _trans.gettext(message)</font>
<font color="black">  78. </font>
<font color="black">  79. </font>
<font color="green">  80. def ngettext(singular, plural, number):</font>
<font color="red">  81.     return _trans.ngettext(singular, plural, number)</font>
<font color="black">  82. </font>
<font color="black">  83. </font>
<font color="green">  84. def ugettext(message):</font>
<font color="green">  85.     return _trans.ugettext(message)</font>
<font color="black">  86. </font>
<font color="black">  87. </font>
<font color="green">  88. def ungettext(singular, plural, number):</font>
<font color="green">  89.     return _trans.ungettext(singular, plural, number)</font>
<font color="black">  90. </font>
<font color="black">  91. </font>
<font color="green">  92. def pgettext(context, message):</font>
<font color="red">  93.     return _trans.pgettext(context, message)</font>
<font color="black">  94. </font>
<font color="black">  95. </font>
<font color="green">  96. def npgettext(context, singular, plural, number):</font>
<font color="red">  97.     return _trans.npgettext(context, singular, plural, number)</font>
<font color="black">  98. </font>
<font color="green">  99. gettext_lazy = lazy(gettext, str)</font>
<font color="green"> 100. ugettext_lazy = lazy(ugettext, six.text_type)</font>
<font color="green"> 101. pgettext_lazy = lazy(pgettext, six.text_type)</font>
<font color="black"> 102. </font>
<font color="black"> 103. </font>
<font color="green"> 104. def lazy_number(func, resultclass, number=None, **kwargs):</font>
<font color="green"> 105.     if isinstance(number, six.integer_types):</font>
<font color="red"> 106.         kwargs['number'] = number</font>
<font color="red"> 107.         proxy = lazy(func, resultclass)(**kwargs)</font>
<font color="black"> 108.     else:</font>
<font color="green"> 109.         class NumberAwareString(resultclass):</font>
<font color="green"> 110.             def __mod__(self, rhs):</font>
<font color="red"> 111.                 if isinstance(rhs, dict) and number:</font>
<font color="red"> 112.                     try:</font>
<font color="red"> 113.                         number_value = rhs[number]</font>
<font color="red"> 114.                     except KeyError:</font>
<font color="red"> 115.                         raise KeyError('Your dictionary lacks key \'%s\'. '</font>
<font color="black"> 116.                             'Please provide it, because it is required to '</font>
<font color="black"> 117.                             'determine whether string is singular or plural.'</font>
<font color="red"> 118.                             % number)</font>
<font color="black"> 119.                 else:</font>
<font color="red"> 120.                     number_value = rhs</font>
<font color="red"> 121.                 kwargs['number'] = number_value</font>
<font color="red"> 122.                 translated = func(**kwargs)</font>
<font color="red"> 123.                 try:</font>
<font color="red"> 124.                     translated = translated % rhs</font>
<font color="red"> 125.                 except TypeError:</font>
<font color="black"> 126.                     # String doesn't contain a placeholder for the number</font>
<font color="red"> 127.                     pass</font>
<font color="red"> 128.                 return translated</font>
<font color="black"> 129. </font>
<font color="green"> 130.         proxy = lazy(lambda **kwargs: NumberAwareString(), NumberAwareString)(**kwargs)</font>
<font color="green"> 131.     return proxy</font>
<font color="black"> 132. </font>
<font color="black"> 133. </font>
<font color="green"> 134. def ngettext_lazy(singular, plural, number=None):</font>
<font color="red"> 135.     return lazy_number(ngettext, str, singular=singular, plural=plural, number=number)</font>
<font color="black"> 136. </font>
<font color="black"> 137. </font>
<font color="green"> 138. def ungettext_lazy(singular, plural, number=None):</font>
<font color="green"> 139.     return lazy_number(ungettext, six.text_type, singular=singular, plural=plural, number=number)</font>
<font color="black"> 140. </font>
<font color="black"> 141. </font>
<font color="green"> 142. def npgettext_lazy(context, singular, plural, number=None):</font>
<font color="red"> 143.     return lazy_number(npgettext, six.text_type, context=context, singular=singular, plural=plural, number=number)</font>
<font color="black"> 144. </font>
<font color="black"> 145. </font>
<font color="green"> 146. def activate(language):</font>
<font color="green"> 147.     return _trans.activate(language)</font>
<font color="black"> 148. </font>
<font color="black"> 149. </font>
<font color="green"> 150. def deactivate():</font>
<font color="green"> 151.     return _trans.deactivate()</font>
<font color="black"> 152. </font>
<font color="black"> 153. </font>
<font color="green"> 154. class override(ContextDecorator):</font>
<font color="green"> 155.     def __init__(self, language, deactivate=False):</font>
<font color="green"> 156.         self.language = language</font>
<font color="green"> 157.         self.deactivate = deactivate</font>
<font color="black"> 158. </font>
<font color="green"> 159.     def __enter__(self):</font>
<font color="green"> 160.         self.old_language = get_language()</font>
<font color="green"> 161.         if self.language is not None:</font>
<font color="red"> 162.             activate(self.language)</font>
<font color="black"> 163.         else:</font>
<font color="green"> 164.             deactivate_all()</font>
<font color="black"> 165. </font>
<font color="green"> 166.     def __exit__(self, exc_type, exc_value, traceback):</font>
<font color="green"> 167.         if self.old_language is None:</font>
<font color="green"> 168.             deactivate_all()</font>
<font color="red"> 169.         elif self.deactivate:</font>
<font color="red"> 170.             deactivate()</font>
<font color="black"> 171.         else:</font>
<font color="red"> 172.             activate(self.old_language)</font>
<font color="black"> 173. </font>
<font color="black"> 174. </font>
<font color="green"> 175. def get_language():</font>
<font color="green"> 176.     return _trans.get_language()</font>
<font color="black"> 177. </font>
<font color="black"> 178. </font>
<font color="green"> 179. def get_language_bidi():</font>
<font color="red"> 180.     return _trans.get_language_bidi()</font>
<font color="black"> 181. </font>
<font color="black"> 182. </font>
<font color="green"> 183. def check_for_language(lang_code):</font>
<font color="red"> 184.     return _trans.check_for_language(lang_code)</font>
<font color="black"> 185. </font>
<font color="black"> 186. </font>
<font color="green"> 187. def to_locale(language):</font>
<font color="red"> 188.     return _trans.to_locale(language)</font>
<font color="black"> 189. </font>
<font color="black"> 190. </font>
<font color="green"> 191. def get_language_from_request(request, check_path=False):</font>
<font color="red"> 192.     return _trans.get_language_from_request(request, check_path)</font>
<font color="black"> 193. </font>
<font color="black"> 194. </font>
<font color="green"> 195. def get_language_from_path(path):</font>
<font color="red"> 196.     return _trans.get_language_from_path(path)</font>
<font color="black"> 197. </font>
<font color="black"> 198. </font>
<font color="green"> 199. def templatize(src, origin=None):</font>
<font color="red"> 200.     return _trans.templatize(src, origin)</font>
<font color="black"> 201. </font>
<font color="black"> 202. </font>
<font color="green"> 203. def deactivate_all():</font>
<font color="green"> 204.     return _trans.deactivate_all()</font>
<font color="black"> 205. </font>
<font color="black"> 206. </font>
<font color="green"> 207. def _string_concat(*strings):</font>
<font color="black"> 208.     &quot;&quot;&quot;</font>
<font color="black"> 209.     Lazy variant of string concatenation, needed for translations that are</font>
<font color="black"> 210.     constructed from multiple parts.</font>
<font color="black"> 211.     &quot;&quot;&quot;</font>
<font color="red"> 212.     return ''.join(force_text(s) for s in strings)</font>
<font color="green"> 213. string_concat = lazy(_string_concat, six.text_type)</font>
<font color="black"> 214. </font>
<font color="black"> 215. </font>
<font color="green"> 216. def get_language_info(lang_code):</font>
<font color="red"> 217.     from django.conf.locale import LANG_INFO</font>
<font color="red"> 218.     try:</font>
<font color="red"> 219.         lang_info = LANG_INFO[lang_code]</font>
<font color="red"> 220.         if 'fallback' in lang_info and 'name' not in lang_info:</font>
<font color="red"> 221.             info = get_language_info(lang_info['fallback'][0])</font>
<font color="black"> 222.         else:</font>
<font color="red"> 223.             info = lang_info</font>
<font color="red"> 224.     except KeyError:</font>
<font color="red"> 225.         if '-' not in lang_code:</font>
<font color="red"> 226.             raise KeyError(&quot;Unknown language code %s.&quot; % lang_code)</font>
<font color="red"> 227.         generic_lang_code = lang_code.split('-')[0]</font>
<font color="red"> 228.         try:</font>
<font color="red"> 229.             info = LANG_INFO[generic_lang_code]</font>
<font color="red"> 230.         except KeyError:</font>
<font color="red"> 231.             raise KeyError(&quot;Unknown language code %s and %s.&quot; % (lang_code, generic_lang_code))</font>
<font color="black"> 232. </font>
<font color="red"> 233.     if info:</font>
<font color="red"> 234.         info['name_translated'] = ugettext_lazy(info['name'])</font>
<font color="red"> 235.     return info</font>
<font color="black"> 236. </font>
<font color="green"> 237. trim_whitespace_re = re.compile('\s*\n\s*')</font>
<font color="black"> 238. </font>
<font color="black"> 239. </font>
<font color="green"> 240. def trim_whitespace(s):</font>
<font color="red"> 241.     return trim_whitespace_re.sub(' ', s.strip())</font>
</pre>


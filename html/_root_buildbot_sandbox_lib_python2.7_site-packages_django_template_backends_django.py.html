source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/template/backends/django.py</b><br>


file stats: <b>89 lines, 27 executed: 30.3% covered</b>
<pre>
<font color="black">   1. # Since this package contains a &quot;django&quot; module, this is required on Python 2.</font>
<font color="green">   2. from __future__ import absolute_import</font>
<font color="black">   3. </font>
<font color="green">   4. import sys</font>
<font color="green">   5. import warnings</font>
<font color="green">   6. from importlib import import_module</font>
<font color="green">   7. from pkgutil import walk_packages</font>
<font color="black">   8. </font>
<font color="green">   9. from django.apps import apps</font>
<font color="green">  10. from django.conf import settings</font>
<font color="green">  11. from django.template import TemplateDoesNotExist</font>
<font color="green">  12. from django.template.context import Context, RequestContext, make_context</font>
<font color="green">  13. from django.template.engine import Engine, _dirs_undefined</font>
<font color="green">  14. from django.template.library import InvalidTemplateLibrary</font>
<font color="green">  15. from django.utils import six</font>
<font color="green">  16. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="black">  17. </font>
<font color="green">  18. from .base import BaseEngine</font>
<font color="black">  19. </font>
<font color="black">  20. </font>
<font color="green">  21. class DjangoTemplates(BaseEngine):</font>
<font color="black">  22. </font>
<font color="green">  23.     app_dirname = 'templates'</font>
<font color="black">  24. </font>
<font color="green">  25.     def __init__(self, params):</font>
<font color="red">  26.         params = params.copy()</font>
<font color="red">  27.         options = params.pop('OPTIONS').copy()</font>
<font color="red">  28.         options.setdefault('debug', settings.DEBUG)</font>
<font color="red">  29.         options.setdefault('file_charset', settings.FILE_CHARSET)</font>
<font color="red">  30.         libraries = options.get('libraries', {})</font>
<font color="red">  31.         options['libraries'] = self.get_templatetag_libraries(libraries)</font>
<font color="red">  32.         super(DjangoTemplates, self).__init__(params)</font>
<font color="red">  33.         self.engine = Engine(self.dirs, self.app_dirs, **options)</font>
<font color="black">  34. </font>
<font color="green">  35.     def from_string(self, template_code):</font>
<font color="red">  36.         return Template(self.engine.from_string(template_code), self)</font>
<font color="black">  37. </font>
<font color="green">  38.     def get_template(self, template_name, dirs=_dirs_undefined):</font>
<font color="red">  39.         try:</font>
<font color="red">  40.             return Template(self.engine.get_template(template_name, dirs), self)</font>
<font color="red">  41.         except TemplateDoesNotExist as exc:</font>
<font color="red">  42.             reraise(exc, self)</font>
<font color="black">  43. </font>
<font color="green">  44.     def get_templatetag_libraries(self, custom_libraries):</font>
<font color="black">  45.         &quot;&quot;&quot;</font>
<font color="black">  46.         Return a collation of template tag libraries from installed</font>
<font color="black">  47.         applications and the supplied custom_libraries argument.</font>
<font color="black">  48.         &quot;&quot;&quot;</font>
<font color="red">  49.         libraries = get_installed_libraries()</font>
<font color="red">  50.         libraries.update(custom_libraries)</font>
<font color="red">  51.         return libraries</font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="green">  54. class Template(object):</font>
<font color="black">  55. </font>
<font color="green">  56.     def __init__(self, template, backend):</font>
<font color="red">  57.         self.template = template</font>
<font color="red">  58.         self.backend = backend</font>
<font color="black">  59. </font>
<font color="green">  60.     @property</font>
<font color="black">  61.     def origin(self):</font>
<font color="red">  62.         return self.template.origin</font>
<font color="black">  63. </font>
<font color="green">  64.     def render(self, context=None, request=None):</font>
<font color="black">  65.         # A deprecation path is required here to cover the following usage:</font>
<font color="black">  66.         # &gt;&gt;&gt; from django.template import Context</font>
<font color="black">  67.         # &gt;&gt;&gt; from django.template.loader import get_template</font>
<font color="black">  68.         # &gt;&gt;&gt; template = get_template('hello.html')</font>
<font color="black">  69.         # &gt;&gt;&gt; template.render(Context({'name': 'world'}))</font>
<font color="black">  70.         # In Django 1.7 get_template() returned a django.template.Template.</font>
<font color="black">  71.         # In Django 1.8 it returns a django.template.backends.django.Template.</font>
<font color="black">  72.         # In Django 1.10 the isinstance checks should be removed. If passing a</font>
<font color="black">  73.         # Context or a RequestContext works by accident, it won't be an issue</font>
<font color="black">  74.         # per se, but it won't be officially supported either.</font>
<font color="red">  75.         if isinstance(context, RequestContext):</font>
<font color="red">  76.             if request is not None and request is not context.request:</font>
<font color="red">  77.                 raise ValueError(</font>
<font color="red">  78.                     &quot;render() was called with a RequestContext and a request &quot;</font>
<font color="black">  79.                     &quot;argument which refer to different requests. Make sure &quot;</font>
<font color="black">  80.                     &quot;that the context argument is a dict or at least that &quot;</font>
<font color="black">  81.                     &quot;the two arguments refer to the same request.&quot;)</font>
<font color="red">  82.             warnings.warn(</font>
<font color="red">  83.                 &quot;render() must be called with a dict, not a RequestContext.&quot;,</font>
<font color="red">  84.                 RemovedInDjango110Warning, stacklevel=2)</font>
<font color="black">  85. </font>
<font color="red">  86.         elif isinstance(context, Context):</font>
<font color="red">  87.             warnings.warn(</font>
<font color="red">  88.                 &quot;render() must be called with a dict, not a Context.&quot;,</font>
<font color="red">  89.                 RemovedInDjango110Warning, stacklevel=2)</font>
<font color="black">  90. </font>
<font color="black">  91.         else:</font>
<font color="red">  92.             context = make_context(context, request)</font>
<font color="black">  93. </font>
<font color="red">  94.         try:</font>
<font color="red">  95.             return self.template.render(context)</font>
<font color="red">  96.         except TemplateDoesNotExist as exc:</font>
<font color="red">  97.             reraise(exc, self.backend)</font>
<font color="black">  98. </font>
<font color="black">  99. </font>
<font color="green"> 100. def reraise(exc, backend):</font>
<font color="black"> 101.     &quot;&quot;&quot;</font>
<font color="black"> 102.     Reraise TemplateDoesNotExist while maintaining template debug information.</font>
<font color="black"> 103.     &quot;&quot;&quot;</font>
<font color="red"> 104.     new = exc.__class__(*exc.args, tried=exc.tried, backend=backend)</font>
<font color="red"> 105.     if hasattr(exc, 'template_debug'):</font>
<font color="red"> 106.         new.template_debug = exc.template_debug</font>
<font color="red"> 107.     six.reraise(exc.__class__, new, sys.exc_info()[2])</font>
<font color="black"> 108. </font>
<font color="black"> 109. </font>
<font color="green"> 110. def get_installed_libraries():</font>
<font color="black"> 111.     &quot;&quot;&quot;</font>
<font color="black"> 112.     Return the built-in template tag libraries and those from installed</font>
<font color="black"> 113.     applications. Libraries are stored in a dictionary where keys are the</font>
<font color="black"> 114.     individual module names, not the full module paths. Example:</font>
<font color="black"> 115.     django.templatetags.i18n is stored as i18n.</font>
<font color="black"> 116.     &quot;&quot;&quot;</font>
<font color="red"> 117.     libraries = {}</font>
<font color="red"> 118.     candidates = ['django.templatetags']</font>
<font color="red"> 119.     candidates.extend(</font>
<font color="red"> 120.         '%s.templatetags' % app_config.name</font>
<font color="red"> 121.         for app_config in apps.get_app_configs())</font>
<font color="black"> 122. </font>
<font color="red"> 123.     for candidate in candidates:</font>
<font color="red"> 124.         try:</font>
<font color="red"> 125.             pkg = import_module(candidate)</font>
<font color="red"> 126.         except ImportError:</font>
<font color="black"> 127.             # No templatetags package defined. This is safe to ignore.</font>
<font color="red"> 128.             continue</font>
<font color="black"> 129. </font>
<font color="red"> 130.         if hasattr(pkg, '__path__'):</font>
<font color="red"> 131.             for name in get_package_libraries(pkg):</font>
<font color="red"> 132.                 libraries[name[len(candidate) + 1:]] = name</font>
<font color="black"> 133. </font>
<font color="red"> 134.     return libraries</font>
<font color="black"> 135. </font>
<font color="black"> 136. </font>
<font color="green"> 137. def get_package_libraries(pkg):</font>
<font color="black"> 138.     &quot;&quot;&quot;</font>
<font color="black"> 139.     Recursively yield template tag libraries defined in submodules of a</font>
<font color="black"> 140.     package.</font>
<font color="black"> 141.     &quot;&quot;&quot;</font>
<font color="red"> 142.     for entry in walk_packages(pkg.__path__, pkg.__name__ + '.'):</font>
<font color="red"> 143.         try:</font>
<font color="red"> 144.             module = import_module(entry[1])</font>
<font color="red"> 145.         except ImportError as e:</font>
<font color="red"> 146.             raise InvalidTemplateLibrary(</font>
<font color="red"> 147.                 &quot;Invalid template library specified. ImportError raised when &quot;</font>
<font color="red"> 148.                 &quot;trying to load '%s': %s&quot; % (entry[1], e)</font>
<font color="black"> 149.             )</font>
<font color="black"> 150. </font>
<font color="red"> 151.         if hasattr(module, 'register'):</font>
<font color="red"> 152.             yield entry[1]</font>
</pre>


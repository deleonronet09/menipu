source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/forms/formsets.py</b><br>


file stats: <b>259 lines, 69 executed: 26.6% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.core.exceptions import ValidationError</font>
<font color="green">   4. from django.forms import Form</font>
<font color="green">   5. from django.forms.fields import BooleanField, IntegerField</font>
<font color="green">   6. from django.forms.utils import ErrorList</font>
<font color="green">   7. from django.forms.widgets import HiddenInput</font>
<font color="green">   8. from django.utils import six</font>
<font color="green">   9. from django.utils.encoding import python_2_unicode_compatible</font>
<font color="green">  10. from django.utils.functional import cached_property</font>
<font color="green">  11. from django.utils.html import html_safe</font>
<font color="green">  12. from django.utils.safestring import mark_safe</font>
<font color="green">  13. from django.utils.six.moves import range</font>
<font color="green">  14. from django.utils.translation import ugettext as _, ungettext</font>
<font color="black">  15. </font>
<font color="green">  16. __all__ = ('BaseFormSet', 'formset_factory', 'all_valid')</font>
<font color="black">  17. </font>
<font color="black">  18. # special field names</font>
<font color="green">  19. TOTAL_FORM_COUNT = 'TOTAL_FORMS'</font>
<font color="green">  20. INITIAL_FORM_COUNT = 'INITIAL_FORMS'</font>
<font color="green">  21. MIN_NUM_FORM_COUNT = 'MIN_NUM_FORMS'</font>
<font color="green">  22. MAX_NUM_FORM_COUNT = 'MAX_NUM_FORMS'</font>
<font color="green">  23. ORDERING_FIELD_NAME = 'ORDER'</font>
<font color="green">  24. DELETION_FIELD_NAME = 'DELETE'</font>
<font color="black">  25. </font>
<font color="black">  26. # default minimum number of forms in a formset</font>
<font color="green">  27. DEFAULT_MIN_NUM = 0</font>
<font color="black">  28. </font>
<font color="black">  29. # default maximum number of forms in a formset, to prevent memory exhaustion</font>
<font color="green">  30. DEFAULT_MAX_NUM = 1000</font>
<font color="black">  31. </font>
<font color="black">  32. </font>
<font color="green">  33. class ManagementForm(Form):</font>
<font color="black">  34.     &quot;&quot;&quot;</font>
<font color="black">  35.     ``ManagementForm`` is used to keep track of how many form instances</font>
<font color="black">  36.     are displayed on the page. If adding new forms via javascript, you should</font>
<font color="black">  37.     increment the count field of this form as well.</font>
<font color="green">  38.     &quot;&quot;&quot;</font>
<font color="green">  39.     def __init__(self, *args, **kwargs):</font>
<font color="red">  40.         self.base_fields[TOTAL_FORM_COUNT] = IntegerField(widget=HiddenInput)</font>
<font color="red">  41.         self.base_fields[INITIAL_FORM_COUNT] = IntegerField(widget=HiddenInput)</font>
<font color="black">  42.         # MIN_NUM_FORM_COUNT and MAX_NUM_FORM_COUNT are output with the rest of</font>
<font color="black">  43.         # the management form, but only for the convenience of client-side</font>
<font color="black">  44.         # code. The POST value of them returned from the client is not checked.</font>
<font color="red">  45.         self.base_fields[MIN_NUM_FORM_COUNT] = IntegerField(required=False, widget=HiddenInput)</font>
<font color="red">  46.         self.base_fields[MAX_NUM_FORM_COUNT] = IntegerField(required=False, widget=HiddenInput)</font>
<font color="red">  47.         super(ManagementForm, self).__init__(*args, **kwargs)</font>
<font color="black">  48. </font>
<font color="black">  49. </font>
<font color="green">  50. @html_safe</font>
<font color="green">  51. @python_2_unicode_compatible</font>
<font color="green">  52. class BaseFormSet(object):</font>
<font color="black">  53.     &quot;&quot;&quot;</font>
<font color="black">  54.     A collection of instances of the same Form class.</font>
<font color="green">  55.     &quot;&quot;&quot;</font>
<font color="green">  56.     def __init__(self, data=None, files=None, auto_id='id_%s', prefix=None,</font>
<font color="green">  57.                  initial=None, error_class=ErrorList, form_kwargs=None):</font>
<font color="red">  58.         self.is_bound = data is not None or files is not None</font>
<font color="red">  59.         self.prefix = prefix or self.get_default_prefix()</font>
<font color="red">  60.         self.auto_id = auto_id</font>
<font color="red">  61.         self.data = data or {}</font>
<font color="red">  62.         self.files = files or {}</font>
<font color="red">  63.         self.initial = initial</font>
<font color="red">  64.         self.form_kwargs = form_kwargs or {}</font>
<font color="red">  65.         self.error_class = error_class</font>
<font color="red">  66.         self._errors = None</font>
<font color="red">  67.         self._non_form_errors = None</font>
<font color="black">  68. </font>
<font color="green">  69.     def __str__(self):</font>
<font color="red">  70.         return self.as_table()</font>
<font color="black">  71. </font>
<font color="green">  72.     def __iter__(self):</font>
<font color="black">  73.         &quot;&quot;&quot;Yields the forms in the order they should be rendered&quot;&quot;&quot;</font>
<font color="red">  74.         return iter(self.forms)</font>
<font color="black">  75. </font>
<font color="green">  76.     def __getitem__(self, index):</font>
<font color="black">  77.         &quot;&quot;&quot;Returns the form at the given index, based on the rendering order&quot;&quot;&quot;</font>
<font color="red">  78.         return self.forms[index]</font>
<font color="black">  79. </font>
<font color="green">  80.     def __len__(self):</font>
<font color="red">  81.         return len(self.forms)</font>
<font color="black">  82. </font>
<font color="green">  83.     def __bool__(self):</font>
<font color="black">  84.         &quot;&quot;&quot;All formsets have a management form which is not included in the length&quot;&quot;&quot;</font>
<font color="red">  85.         return True</font>
<font color="black">  86. </font>
<font color="green">  87.     def __nonzero__(self):      # Python 2 compatibility</font>
<font color="red">  88.         return type(self).__bool__(self)</font>
<font color="black">  89. </font>
<font color="green">  90.     @property</font>
<font color="black">  91.     def management_form(self):</font>
<font color="black">  92.         &quot;&quot;&quot;Returns the ManagementForm instance for this FormSet.&quot;&quot;&quot;</font>
<font color="red">  93.         if self.is_bound:</font>
<font color="red">  94.             form = ManagementForm(self.data, auto_id=self.auto_id, prefix=self.prefix)</font>
<font color="red">  95.             if not form.is_valid():</font>
<font color="red">  96.                 raise ValidationError(</font>
<font color="red">  97.                     _('ManagementForm data is missing or has been tampered with'),</font>
<font color="red">  98.                     code='missing_management_form',</font>
<font color="black">  99.                 )</font>
<font color="black"> 100.         else:</font>
<font color="red"> 101.             form = ManagementForm(auto_id=self.auto_id, prefix=self.prefix, initial={</font>
<font color="red"> 102.                 TOTAL_FORM_COUNT: self.total_form_count(),</font>
<font color="red"> 103.                 INITIAL_FORM_COUNT: self.initial_form_count(),</font>
<font color="red"> 104.                 MIN_NUM_FORM_COUNT: self.min_num,</font>
<font color="red"> 105.                 MAX_NUM_FORM_COUNT: self.max_num</font>
<font color="black"> 106.             })</font>
<font color="red"> 107.         return form</font>
<font color="black"> 108. </font>
<font color="green"> 109.     def total_form_count(self):</font>
<font color="black"> 110.         &quot;&quot;&quot;Returns the total number of forms in this FormSet.&quot;&quot;&quot;</font>
<font color="red"> 111.         if self.is_bound:</font>
<font color="black"> 112.             # return absolute_max if it is lower than the actual total form</font>
<font color="black"> 113.             # count in the data; this is DoS protection to prevent clients</font>
<font color="black"> 114.             # from forcing the server to instantiate arbitrary numbers of</font>
<font color="black"> 115.             # forms</font>
<font color="red"> 116.             return min(self.management_form.cleaned_data[TOTAL_FORM_COUNT], self.absolute_max)</font>
<font color="black"> 117.         else:</font>
<font color="red"> 118.             initial_forms = self.initial_form_count()</font>
<font color="red"> 119.             total_forms = max(initial_forms, self.min_num) + self.extra</font>
<font color="black"> 120.             # Allow all existing related objects/inlines to be displayed,</font>
<font color="black"> 121.             # but don't allow extra beyond max_num.</font>
<font color="red"> 122.             if initial_forms &gt; self.max_num &gt;= 0:</font>
<font color="red"> 123.                 total_forms = initial_forms</font>
<font color="red"> 124.             elif total_forms &gt; self.max_num &gt;= 0:</font>
<font color="red"> 125.                 total_forms = self.max_num</font>
<font color="red"> 126.         return total_forms</font>
<font color="black"> 127. </font>
<font color="green"> 128.     def initial_form_count(self):</font>
<font color="black"> 129.         &quot;&quot;&quot;Returns the number of forms that are required in this FormSet.&quot;&quot;&quot;</font>
<font color="red"> 130.         if self.is_bound:</font>
<font color="red"> 131.             return self.management_form.cleaned_data[INITIAL_FORM_COUNT]</font>
<font color="black"> 132.         else:</font>
<font color="black"> 133.             # Use the length of the initial data if it's there, 0 otherwise.</font>
<font color="red"> 134.             initial_forms = len(self.initial) if self.initial else 0</font>
<font color="red"> 135.         return initial_forms</font>
<font color="black"> 136. </font>
<font color="green"> 137.     @cached_property</font>
<font color="black"> 138.     def forms(self):</font>
<font color="black"> 139.         &quot;&quot;&quot;</font>
<font color="black"> 140.         Instantiate forms at first property access.</font>
<font color="black"> 141.         &quot;&quot;&quot;</font>
<font color="black"> 142.         # DoS protection is included in total_form_count()</font>
<font color="red"> 143.         forms = [self._construct_form(i, **self.get_form_kwargs(i))</font>
<font color="red"> 144.                  for i in range(self.total_form_count())]</font>
<font color="red"> 145.         return forms</font>
<font color="black"> 146. </font>
<font color="green"> 147.     def get_form_kwargs(self, index):</font>
<font color="black"> 148.         &quot;&quot;&quot;</font>
<font color="black"> 149.         Return additional keyword arguments for each individual formset form.</font>
<font color="black"> 150. </font>
<font color="black"> 151.         index will be None if the form being constructed is a new empty</font>
<font color="black"> 152.         form.</font>
<font color="black"> 153.         &quot;&quot;&quot;</font>
<font color="red"> 154.         return self.form_kwargs.copy()</font>
<font color="black"> 155. </font>
<font color="green"> 156.     def _construct_form(self, i, **kwargs):</font>
<font color="black"> 157.         &quot;&quot;&quot;</font>
<font color="black"> 158.         Instantiates and returns the i-th form instance in a formset.</font>
<font color="black"> 159.         &quot;&quot;&quot;</font>
<font color="red"> 160.         defaults = {</font>
<font color="red"> 161.             'auto_id': self.auto_id,</font>
<font color="red"> 162.             'prefix': self.add_prefix(i),</font>
<font color="red"> 163.             'error_class': self.error_class,</font>
<font color="black"> 164.         }</font>
<font color="red"> 165.         if self.is_bound:</font>
<font color="red"> 166.             defaults['data'] = self.data</font>
<font color="red"> 167.             defaults['files'] = self.files</font>
<font color="red"> 168.         if self.initial and 'initial' not in kwargs:</font>
<font color="red"> 169.             try:</font>
<font color="red"> 170.                 defaults['initial'] = self.initial[i]</font>
<font color="red"> 171.             except IndexError:</font>
<font color="red"> 172.                 pass</font>
<font color="black"> 173.         # Allow extra forms to be empty, unless they're part of</font>
<font color="black"> 174.         # the minimum forms.</font>
<font color="red"> 175.         if i &gt;= self.initial_form_count() and i &gt;= self.min_num:</font>
<font color="red"> 176.             defaults['empty_permitted'] = True</font>
<font color="red"> 177.         defaults.update(kwargs)</font>
<font color="red"> 178.         form = self.form(**defaults)</font>
<font color="red"> 179.         self.add_fields(form, i)</font>
<font color="red"> 180.         return form</font>
<font color="black"> 181. </font>
<font color="green"> 182.     @property</font>
<font color="black"> 183.     def initial_forms(self):</font>
<font color="black"> 184.         &quot;&quot;&quot;Return a list of all the initial forms in this formset.&quot;&quot;&quot;</font>
<font color="red"> 185.         return self.forms[:self.initial_form_count()]</font>
<font color="black"> 186. </font>
<font color="green"> 187.     @property</font>
<font color="black"> 188.     def extra_forms(self):</font>
<font color="black"> 189.         &quot;&quot;&quot;Return a list of all the extra forms in this formset.&quot;&quot;&quot;</font>
<font color="red"> 190.         return self.forms[self.initial_form_count():]</font>
<font color="black"> 191. </font>
<font color="green"> 192.     @property</font>
<font color="black"> 193.     def empty_form(self):</font>
<font color="red"> 194.         form = self.form(</font>
<font color="red"> 195.             auto_id=self.auto_id,</font>
<font color="red"> 196.             prefix=self.add_prefix('__prefix__'),</font>
<font color="red"> 197.             empty_permitted=True,</font>
<font color="red"> 198.             **self.get_form_kwargs(None)</font>
<font color="black"> 199.         )</font>
<font color="red"> 200.         self.add_fields(form, None)</font>
<font color="red"> 201.         return form</font>
<font color="black"> 202. </font>
<font color="green"> 203.     @property</font>
<font color="black"> 204.     def cleaned_data(self):</font>
<font color="black"> 205.         &quot;&quot;&quot;</font>
<font color="black"> 206.         Returns a list of form.cleaned_data dicts for every form in self.forms.</font>
<font color="black"> 207.         &quot;&quot;&quot;</font>
<font color="red"> 208.         if not self.is_valid():</font>
<font color="red"> 209.             raise AttributeError(&quot;'%s' object has no attribute 'cleaned_data'&quot; % self.__class__.__name__)</font>
<font color="red"> 210.         return [form.cleaned_data for form in self.forms]</font>
<font color="black"> 211. </font>
<font color="green"> 212.     @property</font>
<font color="black"> 213.     def deleted_forms(self):</font>
<font color="black"> 214.         &quot;&quot;&quot;</font>
<font color="black"> 215.         Returns a list of forms that have been marked for deletion.</font>
<font color="black"> 216.         &quot;&quot;&quot;</font>
<font color="red"> 217.         if not self.is_valid() or not self.can_delete:</font>
<font color="red"> 218.             return []</font>
<font color="black"> 219.         # construct _deleted_form_indexes which is just a list of form indexes</font>
<font color="black"> 220.         # that have had their deletion widget set to True</font>
<font color="red"> 221.         if not hasattr(self, '_deleted_form_indexes'):</font>
<font color="red"> 222.             self._deleted_form_indexes = []</font>
<font color="red"> 223.             for i in range(0, self.total_form_count()):</font>
<font color="red"> 224.                 form = self.forms[i]</font>
<font color="black"> 225.                 # if this is an extra form and hasn't changed, don't consider it</font>
<font color="red"> 226.                 if i &gt;= self.initial_form_count() and not form.has_changed():</font>
<font color="red"> 227.                     continue</font>
<font color="red"> 228.                 if self._should_delete_form(form):</font>
<font color="red"> 229.                     self._deleted_form_indexes.append(i)</font>
<font color="red"> 230.         return [self.forms[i] for i in self._deleted_form_indexes]</font>
<font color="black"> 231. </font>
<font color="green"> 232.     @property</font>
<font color="black"> 233.     def ordered_forms(self):</font>
<font color="black"> 234.         &quot;&quot;&quot;</font>
<font color="black"> 235.         Returns a list of form in the order specified by the incoming data.</font>
<font color="black"> 236.         Raises an AttributeError if ordering is not allowed.</font>
<font color="black"> 237.         &quot;&quot;&quot;</font>
<font color="red"> 238.         if not self.is_valid() or not self.can_order:</font>
<font color="red"> 239.             raise AttributeError(&quot;'%s' object has no attribute 'ordered_forms'&quot; % self.__class__.__name__)</font>
<font color="black"> 240.         # Construct _ordering, which is a list of (form_index, order_field_value)</font>
<font color="black"> 241.         # tuples. After constructing this list, we'll sort it by order_field_value</font>
<font color="black"> 242.         # so we have a way to get to the form indexes in the order specified</font>
<font color="black"> 243.         # by the form data.</font>
<font color="red"> 244.         if not hasattr(self, '_ordering'):</font>
<font color="red"> 245.             self._ordering = []</font>
<font color="red"> 246.             for i in range(0, self.total_form_count()):</font>
<font color="red"> 247.                 form = self.forms[i]</font>
<font color="black"> 248.                 # if this is an extra form and hasn't changed, don't consider it</font>
<font color="red"> 249.                 if i &gt;= self.initial_form_count() and not form.has_changed():</font>
<font color="red"> 250.                     continue</font>
<font color="black"> 251.                 # don't add data marked for deletion to self.ordered_data</font>
<font color="red"> 252.                 if self.can_delete and self._should_delete_form(form):</font>
<font color="red"> 253.                     continue</font>
<font color="red"> 254.                 self._ordering.append((i, form.cleaned_data[ORDERING_FIELD_NAME]))</font>
<font color="black"> 255.             # After we're done populating self._ordering, sort it.</font>
<font color="black"> 256.             # A sort function to order things numerically ascending, but</font>
<font color="black"> 257.             # None should be sorted below anything else. Allowing None as</font>
<font color="black"> 258.             # a comparison value makes it so we can leave ordering fields</font>
<font color="black"> 259.             # blank.</font>
<font color="black"> 260. </font>
<font color="red"> 261.             def compare_ordering_key(k):</font>
<font color="red"> 262.                 if k[1] is None:</font>
<font color="red"> 263.                     return (1, 0)  # +infinity, larger than any number</font>
<font color="red"> 264.                 return (0, k[1])</font>
<font color="red"> 265.             self._ordering.sort(key=compare_ordering_key)</font>
<font color="black"> 266.         # Return a list of form.cleaned_data dicts in the order specified by</font>
<font color="black"> 267.         # the form data.</font>
<font color="red"> 268.         return [self.forms[i[0]] for i in self._ordering]</font>
<font color="black"> 269. </font>
<font color="green"> 270.     @classmethod</font>
<font color="black"> 271.     def get_default_prefix(cls):</font>
<font color="red"> 272.         return 'form'</font>
<font color="black"> 273. </font>
<font color="green"> 274.     def non_form_errors(self):</font>
<font color="black"> 275.         &quot;&quot;&quot;</font>
<font color="black"> 276.         Returns an ErrorList of errors that aren't associated with a particular</font>
<font color="black"> 277.         form -- i.e., from formset.clean(). Returns an empty ErrorList if there</font>
<font color="black"> 278.         are none.</font>
<font color="black"> 279.         &quot;&quot;&quot;</font>
<font color="red"> 280.         if self._non_form_errors is None:</font>
<font color="red"> 281.             self.full_clean()</font>
<font color="red"> 282.         return self._non_form_errors</font>
<font color="black"> 283. </font>
<font color="green"> 284.     @property</font>
<font color="black"> 285.     def errors(self):</font>
<font color="black"> 286.         &quot;&quot;&quot;</font>
<font color="black"> 287.         Returns a list of form.errors for every form in self.forms.</font>
<font color="black"> 288.         &quot;&quot;&quot;</font>
<font color="red"> 289.         if self._errors is None:</font>
<font color="red"> 290.             self.full_clean()</font>
<font color="red"> 291.         return self._errors</font>
<font color="black"> 292. </font>
<font color="green"> 293.     def total_error_count(self):</font>
<font color="black"> 294.         &quot;&quot;&quot;</font>
<font color="black"> 295.         Returns the number of errors across all forms in the formset.</font>
<font color="black"> 296.         &quot;&quot;&quot;</font>
<font color="red"> 297.         return len(self.non_form_errors()) +\</font>
<font color="red"> 298.             sum(len(form_errors) for form_errors in self.errors)</font>
<font color="black"> 299. </font>
<font color="green"> 300.     def _should_delete_form(self, form):</font>
<font color="black"> 301.         &quot;&quot;&quot;</font>
<font color="black"> 302.         Returns whether or not the form was marked for deletion.</font>
<font color="black"> 303.         &quot;&quot;&quot;</font>
<font color="red"> 304.         return form.cleaned_data.get(DELETION_FIELD_NAME, False)</font>
<font color="black"> 305. </font>
<font color="green"> 306.     def is_valid(self):</font>
<font color="black"> 307.         &quot;&quot;&quot;</font>
<font color="black"> 308.         Returns True if every form in self.forms is valid.</font>
<font color="black"> 309.         &quot;&quot;&quot;</font>
<font color="red"> 310.         if not self.is_bound:</font>
<font color="red"> 311.             return False</font>
<font color="black"> 312.         # We loop over every form.errors here rather than short circuiting on the</font>
<font color="black"> 313.         # first failure to make sure validation gets triggered for every form.</font>
<font color="red"> 314.         forms_valid = True</font>
<font color="black"> 315.         # This triggers a full clean.</font>
<font color="red"> 316.         self.errors</font>
<font color="red"> 317.         for i in range(0, self.total_form_count()):</font>
<font color="red"> 318.             form = self.forms[i]</font>
<font color="red"> 319.             if self.can_delete:</font>
<font color="red"> 320.                 if self._should_delete_form(form):</font>
<font color="black"> 321.                     # This form is going to be deleted so any of its errors</font>
<font color="black"> 322.                     # should not cause the entire formset to be invalid.</font>
<font color="red"> 323.                     continue</font>
<font color="red"> 324.             forms_valid &amp;= form.is_valid()</font>
<font color="red"> 325.         return forms_valid and not self.non_form_errors()</font>
<font color="black"> 326. </font>
<font color="green"> 327.     def full_clean(self):</font>
<font color="black"> 328.         &quot;&quot;&quot;</font>
<font color="black"> 329.         Cleans all of self.data and populates self._errors and</font>
<font color="black"> 330.         self._non_form_errors.</font>
<font color="black"> 331.         &quot;&quot;&quot;</font>
<font color="red"> 332.         self._errors = []</font>
<font color="red"> 333.         self._non_form_errors = self.error_class()</font>
<font color="black"> 334. </font>
<font color="red"> 335.         if not self.is_bound:  # Stop further processing.</font>
<font color="red"> 336.             return</font>
<font color="red"> 337.         for i in range(0, self.total_form_count()):</font>
<font color="red"> 338.             form = self.forms[i]</font>
<font color="red"> 339.             self._errors.append(form.errors)</font>
<font color="red"> 340.         try:</font>
<font color="red"> 341.             if (self.validate_max and</font>
<font color="red"> 342.                     self.total_form_count() - len(self.deleted_forms) &gt; self.max_num) or \</font>
<font color="red"> 343.                     self.management_form.cleaned_data[TOTAL_FORM_COUNT] &gt; self.absolute_max:</font>
<font color="red"> 344.                 raise ValidationError(ungettext(</font>
<font color="red"> 345.                     &quot;Please submit %d or fewer forms.&quot;,</font>
<font color="red"> 346.                     &quot;Please submit %d or fewer forms.&quot;, self.max_num) % self.max_num,</font>
<font color="red"> 347.                     code='too_many_forms',</font>
<font color="black"> 348.                 )</font>
<font color="red"> 349.             if (self.validate_min and</font>
<font color="red"> 350.                     self.total_form_count() - len(self.deleted_forms) &lt; self.min_num):</font>
<font color="red"> 351.                 raise ValidationError(ungettext(</font>
<font color="red"> 352.                     &quot;Please submit %d or more forms.&quot;,</font>
<font color="red"> 353.                     &quot;Please submit %d or more forms.&quot;, self.min_num) % self.min_num,</font>
<font color="red"> 354.                     code='too_few_forms')</font>
<font color="black"> 355.             # Give self.clean() a chance to do cross-form validation.</font>
<font color="red"> 356.             self.clean()</font>
<font color="red"> 357.         except ValidationError as e:</font>
<font color="red"> 358.             self._non_form_errors = self.error_class(e.error_list)</font>
<font color="black"> 359. </font>
<font color="green"> 360.     def clean(self):</font>
<font color="black"> 361.         &quot;&quot;&quot;</font>
<font color="black"> 362.         Hook for doing any extra formset-wide cleaning after Form.clean() has</font>
<font color="black"> 363.         been called on every form. Any ValidationError raised by this method</font>
<font color="black"> 364.         will not be associated with a particular form; it will be accessible</font>
<font color="black"> 365.         via formset.non_form_errors()</font>
<font color="black"> 366.         &quot;&quot;&quot;</font>
<font color="red"> 367.         pass</font>
<font color="black"> 368. </font>
<font color="green"> 369.     def has_changed(self):</font>
<font color="black"> 370.         &quot;&quot;&quot;</font>
<font color="black"> 371.         Returns true if data in any form differs from initial.</font>
<font color="black"> 372.         &quot;&quot;&quot;</font>
<font color="red"> 373.         return any(form.has_changed() for form in self)</font>
<font color="black"> 374. </font>
<font color="green"> 375.     def add_fields(self, form, index):</font>
<font color="black"> 376.         &quot;&quot;&quot;A hook for adding extra fields on to each form instance.&quot;&quot;&quot;</font>
<font color="red"> 377.         if self.can_order:</font>
<font color="black"> 378.             # Only pre-fill the ordering field for initial forms.</font>
<font color="red"> 379.             if index is not None and index &lt; self.initial_form_count():</font>
<font color="red"> 380.                 form.fields[ORDERING_FIELD_NAME] = IntegerField(label=_('Order'), initial=index + 1, required=False)</font>
<font color="black"> 381.             else:</font>
<font color="red"> 382.                 form.fields[ORDERING_FIELD_NAME] = IntegerField(label=_('Order'), required=False)</font>
<font color="red"> 383.         if self.can_delete:</font>
<font color="red"> 384.             form.fields[DELETION_FIELD_NAME] = BooleanField(label=_('Delete'), required=False)</font>
<font color="black"> 385. </font>
<font color="green"> 386.     def add_prefix(self, index):</font>
<font color="red"> 387.         return '%s-%s' % (self.prefix, index)</font>
<font color="black"> 388. </font>
<font color="green"> 389.     def is_multipart(self):</font>
<font color="black"> 390.         &quot;&quot;&quot;</font>
<font color="black"> 391.         Returns True if the formset needs to be multipart, i.e. it</font>
<font color="black"> 392.         has FileInput. Otherwise, False.</font>
<font color="black"> 393.         &quot;&quot;&quot;</font>
<font color="red"> 394.         if self.forms:</font>
<font color="red"> 395.             return self.forms[0].is_multipart()</font>
<font color="black"> 396.         else:</font>
<font color="red"> 397.             return self.empty_form.is_multipart()</font>
<font color="black"> 398. </font>
<font color="green"> 399.     @property</font>
<font color="black"> 400.     def media(self):</font>
<font color="black"> 401.         # All the forms on a FormSet are the same, so you only need to</font>
<font color="black"> 402.         # interrogate the first form for media.</font>
<font color="red"> 403.         if self.forms:</font>
<font color="red"> 404.             return self.forms[0].media</font>
<font color="black"> 405.         else:</font>
<font color="red"> 406.             return self.empty_form.media</font>
<font color="black"> 407. </font>
<font color="green"> 408.     def as_table(self):</font>
<font color="black"> 409.         &quot;Returns this formset rendered as HTML &lt;tr&gt;s -- excluding the &lt;table&gt;&lt;/table&gt;.&quot;</font>
<font color="black"> 410.         # XXX: there is no semantic division between forms here, there</font>
<font color="black"> 411.         # probably should be. It might make sense to render each form as a</font>
<font color="black"> 412.         # table row with each field as a td.</font>
<font color="red"> 413.         forms = ' '.join(form.as_table() for form in self)</font>
<font color="red"> 414.         return mark_safe('\n'.join([six.text_type(self.management_form), forms]))</font>
<font color="black"> 415. </font>
<font color="green"> 416.     def as_p(self):</font>
<font color="black"> 417.         &quot;Returns this formset rendered as HTML &lt;p&gt;s.&quot;</font>
<font color="red"> 418.         forms = ' '.join(form.as_p() for form in self)</font>
<font color="red"> 419.         return mark_safe('\n'.join([six.text_type(self.management_form), forms]))</font>
<font color="black"> 420. </font>
<font color="green"> 421.     def as_ul(self):</font>
<font color="black"> 422.         &quot;Returns this formset rendered as HTML &lt;li&gt;s.&quot;</font>
<font color="red"> 423.         forms = ' '.join(form.as_ul() for form in self)</font>
<font color="red"> 424.         return mark_safe('\n'.join([six.text_type(self.management_form), forms]))</font>
<font color="black"> 425. </font>
<font color="black"> 426. </font>
<font color="green"> 427. def formset_factory(form, formset=BaseFormSet, extra=1, can_order=False,</font>
<font color="green"> 428.                     can_delete=False, max_num=None, validate_max=False,</font>
<font color="green"> 429.                     min_num=None, validate_min=False):</font>
<font color="black"> 430.     &quot;&quot;&quot;Return a FormSet for the given form class.&quot;&quot;&quot;</font>
<font color="red"> 431.     if min_num is None:</font>
<font color="red"> 432.         min_num = DEFAULT_MIN_NUM</font>
<font color="red"> 433.     if max_num is None:</font>
<font color="red"> 434.         max_num = DEFAULT_MAX_NUM</font>
<font color="black"> 435.     # hard limit on forms instantiated, to prevent memory-exhaustion attacks</font>
<font color="black"> 436.     # limit is simply max_num + DEFAULT_MAX_NUM (which is 2*DEFAULT_MAX_NUM</font>
<font color="black"> 437.     # if max_num is None in the first place)</font>
<font color="red"> 438.     absolute_max = max_num + DEFAULT_MAX_NUM</font>
<font color="red"> 439.     attrs = {'form': form, 'extra': extra,</font>
<font color="red"> 440.              'can_order': can_order, 'can_delete': can_delete,</font>
<font color="red"> 441.              'min_num': min_num, 'max_num': max_num,</font>
<font color="red"> 442.              'absolute_max': absolute_max, 'validate_min': validate_min,</font>
<font color="red"> 443.              'validate_max': validate_max}</font>
<font color="red"> 444.     return type(form.__name__ + str('FormSet'), (formset,), attrs)</font>
<font color="black"> 445. </font>
<font color="black"> 446. </font>
<font color="green"> 447. def all_valid(formsets):</font>
<font color="black"> 448.     &quot;&quot;&quot;Returns true if every formset in formsets is valid.&quot;&quot;&quot;</font>
<font color="red"> 449.     valid = True</font>
<font color="red"> 450.     for formset in formsets:</font>
<font color="red"> 451.         if not formset.is_valid():</font>
<font color="red"> 452.             valid = False</font>
<font color="red"> 453.     return valid</font>
</pre>


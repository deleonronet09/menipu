source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/version.py</b><br>


file stats: <b>43 lines, 24 executed: 55.8% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import datetime</font>
<font color="green">   4. import os</font>
<font color="green">   5. import subprocess</font>
<font color="black">   6. </font>
<font color="green">   7. from django.utils.lru_cache import lru_cache</font>
<font color="black">   8. </font>
<font color="black">   9. </font>
<font color="green">  10. def get_version(version=None):</font>
<font color="black">  11.     &quot;Returns a PEP 386-compliant version number from VERSION.&quot;</font>
<font color="green">  12.     version = get_complete_version(version)</font>
<font color="black">  13. </font>
<font color="black">  14.     # Now build the two parts of the version number:</font>
<font color="black">  15.     # main = X.Y[.Z]</font>
<font color="black">  16.     # sub = .devN - for pre-alpha releases</font>
<font color="black">  17.     #     | {a|b|c}N - for alpha, beta and rc releases</font>
<font color="black">  18. </font>
<font color="green">  19.     main = get_main_version(version)</font>
<font color="black">  20. </font>
<font color="green">  21.     sub = ''</font>
<font color="green">  22.     if version[3] == 'alpha' and version[4] == 0:</font>
<font color="red">  23.         git_changeset = get_git_changeset()</font>
<font color="red">  24.         if git_changeset:</font>
<font color="red">  25.             sub = '.dev%s' % git_changeset</font>
<font color="black">  26. </font>
<font color="green">  27.     elif version[3] != 'final':</font>
<font color="red">  28.         mapping = {'alpha': 'a', 'beta': 'b', 'rc': 'c'}</font>
<font color="red">  29.         sub = mapping[version[3]] + str(version[4])</font>
<font color="black">  30. </font>
<font color="green">  31.     return str(main + sub)</font>
<font color="black">  32. </font>
<font color="black">  33. </font>
<font color="green">  34. def get_main_version(version=None):</font>
<font color="black">  35.     &quot;Returns main version (X.Y[.Z]) from VERSION.&quot;</font>
<font color="green">  36.     version = get_complete_version(version)</font>
<font color="green">  37.     parts = 2 if version[2] == 0 else 3</font>
<font color="green">  38.     return '.'.join(str(x) for x in version[:parts])</font>
<font color="black">  39. </font>
<font color="black">  40. </font>
<font color="green">  41. def get_complete_version(version=None):</font>
<font color="black">  42.     &quot;&quot;&quot;Returns a tuple of the django version. If version argument is non-empty,</font>
<font color="black">  43.     then checks for correctness of the tuple provided.</font>
<font color="black">  44.     &quot;&quot;&quot;</font>
<font color="green">  45.     if version is None:</font>
<font color="green">  46.         from django import VERSION as version</font>
<font color="black">  47.     else:</font>
<font color="green">  48.         assert len(version) == 5</font>
<font color="green">  49.         assert version[3] in ('alpha', 'beta', 'rc', 'final')</font>
<font color="black">  50. </font>
<font color="green">  51.     return version</font>
<font color="black">  52. </font>
<font color="black">  53. </font>
<font color="green">  54. def get_docs_version(version=None):</font>
<font color="red">  55.     version = get_complete_version(version)</font>
<font color="red">  56.     if version[3] != 'final':</font>
<font color="red">  57.         return 'dev'</font>
<font color="black">  58.     else:</font>
<font color="red">  59.         return '%d.%d' % version[:2]</font>
<font color="black">  60. </font>
<font color="black">  61. </font>
<font color="green">  62. @lru_cache()</font>
<font color="black">  63. def get_git_changeset():</font>
<font color="black">  64.     &quot;&quot;&quot;Returns a numeric identifier of the latest git changeset.</font>
<font color="black">  65. </font>
<font color="black">  66.     The result is the UTC timestamp of the changeset in YYYYMMDDHHMMSS format.</font>
<font color="black">  67.     This value isn't guaranteed to be unique, but collisions are very unlikely,</font>
<font color="black">  68.     so it's sufficient for generating the development version numbers.</font>
<font color="black">  69.     &quot;&quot;&quot;</font>
<font color="red">  70.     repo_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</font>
<font color="red">  71.     git_log = subprocess.Popen('git log --pretty=format:%ct --quiet -1 HEAD',</font>
<font color="red">  72.             stdout=subprocess.PIPE, stderr=subprocess.PIPE,</font>
<font color="red">  73.             shell=True, cwd=repo_dir, universal_newlines=True)</font>
<font color="red">  74.     timestamp = git_log.communicate()[0]</font>
<font color="red">  75.     try:</font>
<font color="red">  76.         timestamp = datetime.datetime.utcfromtimestamp(int(timestamp))</font>
<font color="red">  77.     except ValueError:</font>
<font color="red">  78.         return None</font>
<font color="red">  79.     return timestamp.strftime('%Y%m%d%H%M%S')</font>
</pre>


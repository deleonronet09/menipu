source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/__init__.py</b><br>


file stats: <b>118 lines, 28 executed: 23.7% covered</b>
<pre>
<font color="green">   1. import inspect</font>
<font color="green">   2. import re</font>
<font color="black">   3. </font>
<font color="green">   4. from django.apps import apps as django_apps</font>
<font color="green">   5. from django.conf import settings</font>
<font color="green">   6. from django.core.exceptions import ImproperlyConfigured, PermissionDenied</font>
<font color="green">   7. from django.middleware.csrf import rotate_token</font>
<font color="green">   8. from django.utils.crypto import constant_time_compare</font>
<font color="green">   9. from django.utils.module_loading import import_string</font>
<font color="green">  10. from django.utils.translation import LANGUAGE_SESSION_KEY</font>
<font color="black">  11. </font>
<font color="green">  12. from .signals import user_logged_in, user_logged_out, user_login_failed</font>
<font color="black">  13. </font>
<font color="green">  14. SESSION_KEY = '_auth_user_id'</font>
<font color="green">  15. BACKEND_SESSION_KEY = '_auth_user_backend'</font>
<font color="green">  16. HASH_SESSION_KEY = '_auth_user_hash'</font>
<font color="green">  17. REDIRECT_FIELD_NAME = 'next'</font>
<font color="black">  18. </font>
<font color="black">  19. </font>
<font color="green">  20. def load_backend(path):</font>
<font color="red">  21.     return import_string(path)()</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. def _get_backends(return_tuples=False):</font>
<font color="red">  25.     backends = []</font>
<font color="red">  26.     for backend_path in settings.AUTHENTICATION_BACKENDS:</font>
<font color="red">  27.         backend = load_backend(backend_path)</font>
<font color="red">  28.         backends.append((backend, backend_path) if return_tuples else backend)</font>
<font color="red">  29.     if not backends:</font>
<font color="red">  30.         raise ImproperlyConfigured(</font>
<font color="red">  31.             'No authentication backends have been defined. Does '</font>
<font color="black">  32.             'AUTHENTICATION_BACKENDS contain anything?'</font>
<font color="black">  33.         )</font>
<font color="red">  34.     return backends</font>
<font color="black">  35. </font>
<font color="black">  36. </font>
<font color="green">  37. def get_backends():</font>
<font color="red">  38.     return _get_backends(return_tuples=False)</font>
<font color="black">  39. </font>
<font color="black">  40. </font>
<font color="green">  41. def _clean_credentials(credentials):</font>
<font color="black">  42.     &quot;&quot;&quot;</font>
<font color="black">  43.     Cleans a dictionary of credentials of potentially sensitive info before</font>
<font color="black">  44.     sending to less secure functions.</font>
<font color="black">  45. </font>
<font color="black">  46.     Not comprehensive - intended for user_login_failed signal</font>
<font color="black">  47.     &quot;&quot;&quot;</font>
<font color="red">  48.     SENSITIVE_CREDENTIALS = re.compile('api|token|key|secret|password|signature', re.I)</font>
<font color="red">  49.     CLEANSED_SUBSTITUTE = '********************'</font>
<font color="red">  50.     for key in credentials:</font>
<font color="red">  51.         if SENSITIVE_CREDENTIALS.search(key):</font>
<font color="red">  52.             credentials[key] = CLEANSED_SUBSTITUTE</font>
<font color="red">  53.     return credentials</font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="green">  56. def _get_user_session_key(request):</font>
<font color="black">  57.     # This value in the session is always serialized to a string, so we need</font>
<font color="black">  58.     # to convert it back to Python whenever we access it.</font>
<font color="red">  59.     return get_user_model()._meta.pk.to_python(request.session[SESSION_KEY])</font>
<font color="black">  60. </font>
<font color="black">  61. </font>
<font color="green">  62. def authenticate(**credentials):</font>
<font color="black">  63.     &quot;&quot;&quot;</font>
<font color="black">  64.     If the given credentials are valid, return a User object.</font>
<font color="black">  65.     &quot;&quot;&quot;</font>
<font color="red">  66.     for backend, backend_path in _get_backends(return_tuples=True):</font>
<font color="red">  67.         try:</font>
<font color="red">  68.             inspect.getcallargs(backend.authenticate, **credentials)</font>
<font color="red">  69.         except TypeError:</font>
<font color="black">  70.             # This backend doesn't accept these credentials as arguments. Try the next one.</font>
<font color="red">  71.             continue</font>
<font color="black">  72. </font>
<font color="red">  73.         try:</font>
<font color="red">  74.             user = backend.authenticate(**credentials)</font>
<font color="red">  75.         except PermissionDenied:</font>
<font color="black">  76.             # This backend says to stop in our tracks - this user should not be allowed in at all.</font>
<font color="red">  77.             return None</font>
<font color="red">  78.         if user is None:</font>
<font color="red">  79.             continue</font>
<font color="black">  80.         # Annotate the user object with the path of the backend.</font>
<font color="red">  81.         user.backend = backend_path</font>
<font color="red">  82.         return user</font>
<font color="black">  83. </font>
<font color="black">  84.     # The credentials supplied are invalid to all backends, fire signal</font>
<font color="red">  85.     user_login_failed.send(sender=__name__,</font>
<font color="red">  86.             credentials=_clean_credentials(credentials))</font>
<font color="black">  87. </font>
<font color="black">  88. </font>
<font color="green">  89. def login(request, user):</font>
<font color="black">  90.     &quot;&quot;&quot;</font>
<font color="black">  91.     Persist a user id and a backend in the request. This way a user doesn't</font>
<font color="black">  92.     have to reauthenticate on every request. Note that data set during</font>
<font color="black">  93.     the anonymous session is retained when the user logs in.</font>
<font color="black">  94.     &quot;&quot;&quot;</font>
<font color="red">  95.     session_auth_hash = ''</font>
<font color="red">  96.     if user is None:</font>
<font color="red">  97.         user = request.user</font>
<font color="red">  98.     if hasattr(user, 'get_session_auth_hash'):</font>
<font color="red">  99.         session_auth_hash = user.get_session_auth_hash()</font>
<font color="black"> 100. </font>
<font color="red"> 101.     if SESSION_KEY in request.session:</font>
<font color="red"> 102.         if _get_user_session_key(request) != user.pk or (</font>
<font color="red"> 103.                 session_auth_hash and</font>
<font color="red"> 104.                 request.session.get(HASH_SESSION_KEY) != session_auth_hash):</font>
<font color="black"> 105.             # To avoid reusing another user's session, create a new, empty</font>
<font color="black"> 106.             # session if the existing session corresponds to a different</font>
<font color="black"> 107.             # authenticated user.</font>
<font color="red"> 108.             request.session.flush()</font>
<font color="black"> 109.     else:</font>
<font color="red"> 110.         request.session.cycle_key()</font>
<font color="red"> 111.     request.session[SESSION_KEY] = user._meta.pk.value_to_string(user)</font>
<font color="red"> 112.     request.session[BACKEND_SESSION_KEY] = user.backend</font>
<font color="red"> 113.     request.session[HASH_SESSION_KEY] = session_auth_hash</font>
<font color="red"> 114.     if hasattr(request, 'user'):</font>
<font color="red"> 115.         request.user = user</font>
<font color="red"> 116.     rotate_token(request)</font>
<font color="red"> 117.     user_logged_in.send(sender=user.__class__, request=request, user=user)</font>
<font color="black"> 118. </font>
<font color="black"> 119. </font>
<font color="green"> 120. def logout(request):</font>
<font color="black"> 121.     &quot;&quot;&quot;</font>
<font color="black"> 122.     Removes the authenticated user's ID from the request and flushes their</font>
<font color="black"> 123.     session data.</font>
<font color="black"> 124.     &quot;&quot;&quot;</font>
<font color="black"> 125.     # Dispatch the signal before the user is logged out so the receivers have a</font>
<font color="black"> 126.     # chance to find out *who* logged out.</font>
<font color="red"> 127.     user = getattr(request, 'user', None)</font>
<font color="red"> 128.     if hasattr(user, 'is_authenticated') and not user.is_authenticated():</font>
<font color="red"> 129.         user = None</font>
<font color="red"> 130.     user_logged_out.send(sender=user.__class__, request=request, user=user)</font>
<font color="black"> 131. </font>
<font color="black"> 132.     # remember language choice saved to session</font>
<font color="red"> 133.     language = request.session.get(LANGUAGE_SESSION_KEY)</font>
<font color="black"> 134. </font>
<font color="red"> 135.     request.session.flush()</font>
<font color="black"> 136. </font>
<font color="red"> 137.     if language is not None:</font>
<font color="red"> 138.         request.session[LANGUAGE_SESSION_KEY] = language</font>
<font color="black"> 139. </font>
<font color="red"> 140.     if hasattr(request, 'user'):</font>
<font color="red"> 141.         from django.contrib.auth.models import AnonymousUser</font>
<font color="red"> 142.         request.user = AnonymousUser()</font>
<font color="black"> 143. </font>
<font color="black"> 144. </font>
<font color="green"> 145. def get_user_model():</font>
<font color="black"> 146.     &quot;&quot;&quot;</font>
<font color="black"> 147.     Returns the User model that is active in this project.</font>
<font color="black"> 148.     &quot;&quot;&quot;</font>
<font color="red"> 149.     try:</font>
<font color="red"> 150.         return django_apps.get_model(settings.AUTH_USER_MODEL)</font>
<font color="red"> 151.     except ValueError:</font>
<font color="red"> 152.         raise ImproperlyConfigured(&quot;AUTH_USER_MODEL must be of the form 'app_label.model_name'&quot;)</font>
<font color="red"> 153.     except LookupError:</font>
<font color="red"> 154.         raise ImproperlyConfigured(</font>
<font color="red"> 155.             &quot;AUTH_USER_MODEL refers to model '%s' that has not been installed&quot; % settings.AUTH_USER_MODEL</font>
<font color="black"> 156.         )</font>
<font color="black"> 157. </font>
<font color="black"> 158. </font>
<font color="green"> 159. def get_user(request):</font>
<font color="black"> 160.     &quot;&quot;&quot;</font>
<font color="black"> 161.     Returns the user model instance associated with the given request session.</font>
<font color="black"> 162.     If no user is retrieved an instance of `AnonymousUser` is returned.</font>
<font color="black"> 163.     &quot;&quot;&quot;</font>
<font color="red"> 164.     from .models import AnonymousUser</font>
<font color="red"> 165.     user = None</font>
<font color="red"> 166.     try:</font>
<font color="red"> 167.         user_id = _get_user_session_key(request)</font>
<font color="red"> 168.         backend_path = request.session[BACKEND_SESSION_KEY]</font>
<font color="red"> 169.     except KeyError:</font>
<font color="red"> 170.         pass</font>
<font color="black"> 171.     else:</font>
<font color="red"> 172.         if backend_path in settings.AUTHENTICATION_BACKENDS:</font>
<font color="red"> 173.             backend = load_backend(backend_path)</font>
<font color="red"> 174.             user = backend.get_user(user_id)</font>
<font color="black"> 175.             # Verify the session</font>
<font color="red"> 176.             if ('django.contrib.auth.middleware.SessionAuthenticationMiddleware'</font>
<font color="red"> 177.                     in settings.MIDDLEWARE_CLASSES and hasattr(user, 'get_session_auth_hash')):</font>
<font color="red"> 178.                 session_hash = request.session.get(HASH_SESSION_KEY)</font>
<font color="red"> 179.                 session_hash_verified = session_hash and constant_time_compare(</font>
<font color="red"> 180.                     session_hash,</font>
<font color="red"> 181.                     user.get_session_auth_hash()</font>
<font color="black"> 182.                 )</font>
<font color="red"> 183.                 if not session_hash_verified:</font>
<font color="red"> 184.                     request.session.flush()</font>
<font color="red"> 185.                     user = None</font>
<font color="black"> 186. </font>
<font color="red"> 187.     return user or AnonymousUser()</font>
<font color="black"> 188. </font>
<font color="black"> 189. </font>
<font color="green"> 190. def get_permission_codename(action, opts):</font>
<font color="black"> 191.     &quot;&quot;&quot;</font>
<font color="black"> 192.     Returns the codename of the permission for the specified action.</font>
<font color="black"> 193.     &quot;&quot;&quot;</font>
<font color="green"> 194.     return '%s_%s' % (action, opts.model_name)</font>
<font color="black"> 195. </font>
<font color="black"> 196. </font>
<font color="green"> 197. def update_session_auth_hash(request, user):</font>
<font color="black"> 198.     &quot;&quot;&quot;</font>
<font color="black"> 199.     Updating a user's password logs out all sessions for the user if</font>
<font color="black"> 200.     django.contrib.auth.middleware.SessionAuthenticationMiddleware is enabled.</font>
<font color="black"> 201. </font>
<font color="black"> 202.     This function takes the current request and the updated user object from</font>
<font color="black"> 203.     which the new session hash will be derived and updates the session hash</font>
<font color="black"> 204.     appropriately to prevent a password change from logging out the session</font>
<font color="black"> 205.     from which the password was changed.</font>
<font color="black"> 206.     &quot;&quot;&quot;</font>
<font color="red"> 207.     if hasattr(user, 'get_session_auth_hash') and request.user == user:</font>
<font color="red"> 208.         request.session[HASH_SESSION_KEY] = user.get_session_auth_hash()</font>
<font color="black"> 209. </font>
<font color="green"> 210. default_app_config = 'django.contrib.auth.apps.AuthConfig'</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/cache/__init__.py</b><br>


file stats: <b>69 lines, 45 executed: 65.2% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Caching framework.</font>
<font color="black">   3. </font>
<font color="black">   4. This package defines set of cache backends that all conform to a simple API.</font>
<font color="black">   5. In a nutshell, a cache is a set of values -- which can be any object that</font>
<font color="black">   6. may be pickled -- identified by string keys.  For the complete API, see</font>
<font color="black">   7. the abstract BaseCache class in django.core.cache.backends.base.</font>
<font color="black">   8. </font>
<font color="black">   9. Client code should use the `cache` variable defined here to access the default</font>
<font color="black">  10. cache backend and look up non-default cache backends in the `caches` dict-like</font>
<font color="black">  11. object.</font>
<font color="black">  12. </font>
<font color="black">  13. See docs/topics/cache.txt for information on the public API.</font>
<font color="green">  14. &quot;&quot;&quot;</font>
<font color="green">  15. from threading import local</font>
<font color="black">  16. </font>
<font color="green">  17. from django.conf import settings</font>
<font color="green">  18. from django.core import signals</font>
<font color="green">  19. from django.core.cache.backends.base import (</font>
<font color="black">  20.     BaseCache, CacheKeyWarning, InvalidCacheBackendError,</font>
<font color="black">  21. )</font>
<font color="green">  22. from django.utils.module_loading import import_string</font>
<font color="black">  23. </font>
<font color="black">  24. __all__ = [</font>
<font color="green">  25.     'cache', 'DEFAULT_CACHE_ALIAS', 'InvalidCacheBackendError',</font>
<font color="green">  26.     'CacheKeyWarning', 'BaseCache',</font>
<font color="black">  27. ]</font>
<font color="black">  28. </font>
<font color="green">  29. DEFAULT_CACHE_ALIAS = 'default'</font>
<font color="black">  30. </font>
<font color="black">  31. </font>
<font color="green">  32. def _create_cache(backend, **kwargs):</font>
<font color="green">  33.     try:</font>
<font color="black">  34.         # Try to get the CACHES entry for the given backend name first</font>
<font color="green">  35.         try:</font>
<font color="green">  36.             conf = settings.CACHES[backend]</font>
<font color="red">  37.         except KeyError:</font>
<font color="red">  38.             try:</font>
<font color="black">  39.                 # Trying to import the given backend, in case it's a dotted path</font>
<font color="red">  40.                 import_string(backend)</font>
<font color="red">  41.             except ImportError as e:</font>
<font color="red">  42.                 raise InvalidCacheBackendError(&quot;Could not find backend '%s': %s&quot; % (</font>
<font color="red">  43.                     backend, e))</font>
<font color="red">  44.             location = kwargs.pop('LOCATION', '')</font>
<font color="red">  45.             params = kwargs</font>
<font color="black">  46.         else:</font>
<font color="green">  47.             params = conf.copy()</font>
<font color="green">  48.             params.update(kwargs)</font>
<font color="green">  49.             backend = params.pop('BACKEND')</font>
<font color="green">  50.             location = params.pop('LOCATION', '')</font>
<font color="green">  51.         backend_cls = import_string(backend)</font>
<font color="red">  52.     except ImportError as e:</font>
<font color="red">  53.         raise InvalidCacheBackendError(</font>
<font color="red">  54.             &quot;Could not find backend '%s': %s&quot; % (backend, e))</font>
<font color="green">  55.     return backend_cls(location, params)</font>
<font color="black">  56. </font>
<font color="black">  57. </font>
<font color="green">  58. class CacheHandler(object):</font>
<font color="black">  59.     &quot;&quot;&quot;</font>
<font color="black">  60.     A Cache Handler to manage access to Cache instances.</font>
<font color="black">  61. </font>
<font color="black">  62.     Ensures only one instance of each alias exists per thread.</font>
<font color="green">  63.     &quot;&quot;&quot;</font>
<font color="green">  64.     def __init__(self):</font>
<font color="green">  65.         self._caches = local()</font>
<font color="black">  66. </font>
<font color="green">  67.     def __getitem__(self, alias):</font>
<font color="green">  68.         try:</font>
<font color="green">  69.             return self._caches.caches[alias]</font>
<font color="green">  70.         except AttributeError:</font>
<font color="green">  71.             self._caches.caches = {}</font>
<font color="red">  72.         except KeyError:</font>
<font color="red">  73.             pass</font>
<font color="black">  74. </font>
<font color="green">  75.         if alias not in settings.CACHES:</font>
<font color="red">  76.             raise InvalidCacheBackendError(</font>
<font color="red">  77.                 &quot;Could not find config for '%s' in settings.CACHES&quot; % alias</font>
<font color="black">  78.             )</font>
<font color="black">  79. </font>
<font color="green">  80.         cache = _create_cache(alias)</font>
<font color="green">  81.         self._caches.caches[alias] = cache</font>
<font color="green">  82.         return cache</font>
<font color="black">  83. </font>
<font color="green">  84.     def all(self):</font>
<font color="red">  85.         return getattr(self._caches, 'caches', {}).values()</font>
<font color="black">  86. </font>
<font color="green">  87. caches = CacheHandler()</font>
<font color="black">  88. </font>
<font color="black">  89. </font>
<font color="green">  90. class DefaultCacheProxy(object):</font>
<font color="black">  91.     &quot;&quot;&quot;</font>
<font color="black">  92.     Proxy access to the default Cache object's attributes.</font>
<font color="black">  93. </font>
<font color="black">  94.     This allows the legacy `cache` object to be thread-safe using the new</font>
<font color="black">  95.     ``caches`` API.</font>
<font color="green">  96.     &quot;&quot;&quot;</font>
<font color="green">  97.     def __getattr__(self, name):</font>
<font color="red">  98.         return getattr(caches[DEFAULT_CACHE_ALIAS], name)</font>
<font color="black">  99. </font>
<font color="green"> 100.     def __setattr__(self, name, value):</font>
<font color="red"> 101.         return setattr(caches[DEFAULT_CACHE_ALIAS], name, value)</font>
<font color="black"> 102. </font>
<font color="green"> 103.     def __delattr__(self, name):</font>
<font color="red"> 104.         return delattr(caches[DEFAULT_CACHE_ALIAS], name)</font>
<font color="black"> 105. </font>
<font color="green"> 106.     def __contains__(self, key):</font>
<font color="red"> 107.         return key in caches[DEFAULT_CACHE_ALIAS]</font>
<font color="black"> 108. </font>
<font color="green"> 109.     def __eq__(self, other):</font>
<font color="red"> 110.         return caches[DEFAULT_CACHE_ALIAS] == other</font>
<font color="black"> 111. </font>
<font color="green"> 112.     def __ne__(self, other):</font>
<font color="red"> 113.         return caches[DEFAULT_CACHE_ALIAS] != other</font>
<font color="black"> 114. </font>
<font color="green"> 115. cache = DefaultCacheProxy()</font>
<font color="black"> 116. </font>
<font color="black"> 117. </font>
<font color="green"> 118. def close_caches(**kwargs):</font>
<font color="black"> 119.     # Some caches -- python-memcached in particular -- need to do a cleanup at the</font>
<font color="black"> 120.     # end of a request cycle. If not implemented in a particular backend</font>
<font color="black"> 121.     # cache.close is a no-op</font>
<font color="red"> 122.     for cache in caches.all():</font>
<font color="red"> 123.         cache.close()</font>
<font color="green"> 124. signals.request_finished.connect(close_caches)</font>
</pre>


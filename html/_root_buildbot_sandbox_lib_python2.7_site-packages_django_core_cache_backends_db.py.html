source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/cache/backends/db.py</b><br>


file stats: <b>157 lines, 24 executed: 15.3% covered</b>
<pre>
<font color="green">   1. &quot;Database cache backend.&quot;</font>
<font color="green">   2. import base64</font>
<font color="green">   3. from datetime import datetime</font>
<font color="black">   4. </font>
<font color="green">   5. from django.conf import settings</font>
<font color="green">   6. from django.core.cache.backends.base import DEFAULT_TIMEOUT, BaseCache</font>
<font color="green">   7. from django.db import DatabaseError, connections, models, router, transaction</font>
<font color="green">   8. from django.utils import six, timezone</font>
<font color="green">   9. from django.utils.encoding import force_bytes</font>
<font color="black">  10. </font>
<font color="green">  11. try:</font>
<font color="green">  12.     from django.utils.six.moves import cPickle as pickle</font>
<font color="red">  13. except ImportError:</font>
<font color="red">  14.     import pickle</font>
<font color="black">  15. </font>
<font color="black">  16. </font>
<font color="green">  17. class Options(object):</font>
<font color="black">  18.     &quot;&quot;&quot;A class that will quack like a Django model _meta class.</font>
<font color="black">  19. </font>
<font color="black">  20.     This allows cache operations to be controlled by the router</font>
<font color="green">  21.     &quot;&quot;&quot;</font>
<font color="green">  22.     def __init__(self, table):</font>
<font color="red">  23.         self.db_table = table</font>
<font color="red">  24.         self.app_label = 'django_cache'</font>
<font color="red">  25.         self.model_name = 'cacheentry'</font>
<font color="red">  26.         self.verbose_name = 'cache entry'</font>
<font color="red">  27.         self.verbose_name_plural = 'cache entries'</font>
<font color="red">  28.         self.object_name = 'CacheEntry'</font>
<font color="red">  29.         self.abstract = False</font>
<font color="red">  30.         self.managed = True</font>
<font color="red">  31.         self.proxy = False</font>
<font color="red">  32.         self.swapped = False</font>
<font color="black">  33. </font>
<font color="black">  34. </font>
<font color="green">  35. class BaseDatabaseCache(BaseCache):</font>
<font color="green">  36.     def __init__(self, table, params):</font>
<font color="red">  37.         BaseCache.__init__(self, params)</font>
<font color="red">  38.         self._table = table</font>
<font color="black">  39. </font>
<font color="red">  40.         class CacheEntry(object):</font>
<font color="red">  41.             _meta = Options(table)</font>
<font color="red">  42.         self.cache_model_class = CacheEntry</font>
<font color="black">  43. </font>
<font color="black">  44. </font>
<font color="green">  45. class DatabaseCache(BaseDatabaseCache):</font>
<font color="black">  46. </font>
<font color="black">  47.     # This class uses cursors provided by the database connection. This means</font>
<font color="black">  48.     # it reads expiration values as aware or naive datetimes, depending on the</font>
<font color="black">  49.     # value of USE_TZ and whether the database supports time zones. The ORM's</font>
<font color="black">  50.     # conversion and adaptation infrastructure is then used to avoid comparing</font>
<font color="black">  51.     # aware and naive datetimes accidentally.</font>
<font color="black">  52. </font>
<font color="green">  53.     def get(self, key, default=None, version=None):</font>
<font color="red">  54.         key = self.make_key(key, version=version)</font>
<font color="red">  55.         self.validate_key(key)</font>
<font color="red">  56.         db = router.db_for_read(self.cache_model_class)</font>
<font color="red">  57.         connection = connections[db]</font>
<font color="red">  58.         table = connection.ops.quote_name(self._table)</font>
<font color="black">  59. </font>
<font color="red">  60.         with connection.cursor() as cursor:</font>
<font color="red">  61.             cursor.execute(&quot;SELECT cache_key, value, expires FROM %s &quot;</font>
<font color="red">  62.                            &quot;WHERE cache_key = %%s&quot; % table, [key])</font>
<font color="red">  63.             row = cursor.fetchone()</font>
<font color="red">  64.         if row is None:</font>
<font color="red">  65.             return default</font>
<font color="black">  66. </font>
<font color="red">  67.         expires = row[2]</font>
<font color="red">  68.         expression = models.Expression(output_field=models.DateTimeField())</font>
<font color="red">  69.         for converter in (connection.ops.get_db_converters(expression) +</font>
<font color="red">  70.                           expression.get_db_converters(connection)):</font>
<font color="red">  71.             expires = converter(expires, expression, connection, {})</font>
<font color="black">  72. </font>
<font color="red">  73.         if expires &lt; timezone.now():</font>
<font color="red">  74.             db = router.db_for_write(self.cache_model_class)</font>
<font color="red">  75.             connection = connections[db]</font>
<font color="red">  76.             with connection.cursor() as cursor:</font>
<font color="red">  77.                 cursor.execute(&quot;DELETE FROM %s &quot;</font>
<font color="red">  78.                                &quot;WHERE cache_key = %%s&quot; % table, [key])</font>
<font color="red">  79.             return default</font>
<font color="black">  80. </font>
<font color="red">  81.         value = connection.ops.process_clob(row[1])</font>
<font color="red">  82.         return pickle.loads(base64.b64decode(force_bytes(value)))</font>
<font color="black">  83. </font>
<font color="green">  84.     def set(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="red">  85.         key = self.make_key(key, version=version)</font>
<font color="red">  86.         self.validate_key(key)</font>
<font color="red">  87.         self._base_set('set', key, value, timeout)</font>
<font color="black">  88. </font>
<font color="green">  89.     def add(self, key, value, timeout=DEFAULT_TIMEOUT, version=None):</font>
<font color="red">  90.         key = self.make_key(key, version=version)</font>
<font color="red">  91.         self.validate_key(key)</font>
<font color="red">  92.         return self._base_set('add', key, value, timeout)</font>
<font color="black">  93. </font>
<font color="green">  94.     def _base_set(self, mode, key, value, timeout=DEFAULT_TIMEOUT):</font>
<font color="red">  95.         timeout = self.get_backend_timeout(timeout)</font>
<font color="red">  96.         db = router.db_for_write(self.cache_model_class)</font>
<font color="red">  97.         connection = connections[db]</font>
<font color="red">  98.         table = connection.ops.quote_name(self._table)</font>
<font color="black">  99. </font>
<font color="red"> 100.         with connection.cursor() as cursor:</font>
<font color="red"> 101.             cursor.execute(&quot;SELECT COUNT(*) FROM %s&quot; % table)</font>
<font color="red"> 102.             num = cursor.fetchone()[0]</font>
<font color="red"> 103.             now = timezone.now()</font>
<font color="red"> 104.             now = now.replace(microsecond=0)</font>
<font color="red"> 105.             if timeout is None:</font>
<font color="red"> 106.                 exp = datetime.max</font>
<font color="red"> 107.             elif settings.USE_TZ:</font>
<font color="red"> 108.                 exp = datetime.utcfromtimestamp(timeout)</font>
<font color="black"> 109.             else:</font>
<font color="red"> 110.                 exp = datetime.fromtimestamp(timeout)</font>
<font color="red"> 111.             exp = exp.replace(microsecond=0)</font>
<font color="red"> 112.             if num &gt; self._max_entries:</font>
<font color="red"> 113.                 self._cull(db, cursor, now)</font>
<font color="red"> 114.             pickled = pickle.dumps(value, pickle.HIGHEST_PROTOCOL)</font>
<font color="red"> 115.             b64encoded = base64.b64encode(pickled)</font>
<font color="black"> 116.             # The DB column is expecting a string, so make sure the value is a</font>
<font color="black"> 117.             # string, not bytes. Refs #19274.</font>
<font color="red"> 118.             if six.PY3:</font>
<font color="red"> 119.                 b64encoded = b64encoded.decode('latin1')</font>
<font color="red"> 120.             try:</font>
<font color="black"> 121.                 # Note: typecasting for datetimes is needed by some 3rd party</font>
<font color="black"> 122.                 # database backends. All core backends work without typecasting,</font>
<font color="black"> 123.                 # so be careful about changes here - test suite will NOT pick</font>
<font color="black"> 124.                 # regressions.</font>
<font color="red"> 125.                 with transaction.atomic(using=db):</font>
<font color="red"> 126.                     cursor.execute(&quot;SELECT cache_key, expires FROM %s &quot;</font>
<font color="red"> 127.                                    &quot;WHERE cache_key = %%s&quot; % table, [key])</font>
<font color="red"> 128.                     result = cursor.fetchone()</font>
<font color="black"> 129. </font>
<font color="red"> 130.                     if result:</font>
<font color="red"> 131.                         current_expires = result[1]</font>
<font color="red"> 132.                         expression = models.Expression(output_field=models.DateTimeField())</font>
<font color="red"> 133.                         for converter in (connection.ops.get_db_converters(expression) +</font>
<font color="red"> 134.                                           expression.get_db_converters(connection)):</font>
<font color="red"> 135.                             current_expires = converter(current_expires, expression, connection, {})</font>
<font color="black"> 136. </font>
<font color="red"> 137.                     exp = connection.ops.adapt_datetimefield_value(exp)</font>
<font color="red"> 138.                     if result and (mode == 'set' or (mode == 'add' and current_expires &lt; now)):</font>
<font color="red"> 139.                         cursor.execute(&quot;UPDATE %s SET value = %%s, expires = %%s &quot;</font>
<font color="red"> 140.                                        &quot;WHERE cache_key = %%s&quot; % table,</font>
<font color="red"> 141.                                        [b64encoded, exp, key])</font>
<font color="black"> 142.                     else:</font>
<font color="red"> 143.                         cursor.execute(&quot;INSERT INTO %s (cache_key, value, expires) &quot;</font>
<font color="red"> 144.                                        &quot;VALUES (%%s, %%s, %%s)&quot; % table,</font>
<font color="red"> 145.                                        [key, b64encoded, exp])</font>
<font color="red"> 146.             except DatabaseError:</font>
<font color="black"> 147.                 # To be threadsafe, updates/inserts are allowed to fail silently</font>
<font color="red"> 148.                 return False</font>
<font color="black"> 149.             else:</font>
<font color="red"> 150.                 return True</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def delete(self, key, version=None):</font>
<font color="red"> 153.         key = self.make_key(key, version=version)</font>
<font color="red"> 154.         self.validate_key(key)</font>
<font color="black"> 155. </font>
<font color="red"> 156.         db = router.db_for_write(self.cache_model_class)</font>
<font color="red"> 157.         connection = connections[db]</font>
<font color="red"> 158.         table = connection.ops.quote_name(self._table)</font>
<font color="black"> 159. </font>
<font color="red"> 160.         with connection.cursor() as cursor:</font>
<font color="red"> 161.             cursor.execute(&quot;DELETE FROM %s WHERE cache_key = %%s&quot; % table, [key])</font>
<font color="black"> 162. </font>
<font color="green"> 163.     def has_key(self, key, version=None):</font>
<font color="red"> 164.         key = self.make_key(key, version=version)</font>
<font color="red"> 165.         self.validate_key(key)</font>
<font color="black"> 166. </font>
<font color="red"> 167.         db = router.db_for_read(self.cache_model_class)</font>
<font color="red"> 168.         connection = connections[db]</font>
<font color="red"> 169.         table = connection.ops.quote_name(self._table)</font>
<font color="black"> 170. </font>
<font color="red"> 171.         if settings.USE_TZ:</font>
<font color="red"> 172.             now = datetime.utcnow()</font>
<font color="black"> 173.         else:</font>
<font color="red"> 174.             now = datetime.now()</font>
<font color="red"> 175.         now = now.replace(microsecond=0)</font>
<font color="black"> 176. </font>
<font color="red"> 177.         with connection.cursor() as cursor:</font>
<font color="red"> 178.             cursor.execute(&quot;SELECT cache_key FROM %s &quot;</font>
<font color="red"> 179.                            &quot;WHERE cache_key = %%s and expires &gt; %%s&quot; % table,</font>
<font color="red"> 180.                            [key, connection.ops.adapt_datetimefield_value(now)])</font>
<font color="red"> 181.             return cursor.fetchone() is not None</font>
<font color="black"> 182. </font>
<font color="green"> 183.     def _cull(self, db, cursor, now):</font>
<font color="red"> 184.         if self._cull_frequency == 0:</font>
<font color="red"> 185.             self.clear()</font>
<font color="black"> 186.         else:</font>
<font color="red"> 187.             connection = connections[db]</font>
<font color="red"> 188.             table = connection.ops.quote_name(self._table)</font>
<font color="red"> 189.             cursor.execute(&quot;DELETE FROM %s WHERE expires &lt; %%s&quot; % table,</font>
<font color="red"> 190.                            [connection.ops.adapt_datetimefield_value(now)])</font>
<font color="red"> 191.             cursor.execute(&quot;SELECT COUNT(*) FROM %s&quot; % table)</font>
<font color="red"> 192.             num = cursor.fetchone()[0]</font>
<font color="red"> 193.             if num &gt; self._max_entries:</font>
<font color="red"> 194.                 cull_num = num // self._cull_frequency</font>
<font color="red"> 195.                 cursor.execute(</font>
<font color="red"> 196.                     connection.ops.cache_key_culling_sql() % table,</font>
<font color="red"> 197.                     [cull_num])</font>
<font color="red"> 198.                 cursor.execute(&quot;DELETE FROM %s &quot;</font>
<font color="red"> 199.                                &quot;WHERE cache_key &lt; %%s&quot; % table,</font>
<font color="red"> 200.                                [cursor.fetchone()[0]])</font>
<font color="black"> 201. </font>
<font color="green"> 202.     def clear(self):</font>
<font color="red"> 203.         db = router.db_for_write(self.cache_model_class)</font>
<font color="red"> 204.         connection = connections[db]</font>
<font color="red"> 205.         table = connection.ops.quote_name(self._table)</font>
<font color="red"> 206.         with connection.cursor() as cursor:</font>
<font color="red"> 207.             cursor.execute('DELETE FROM %s' % table)</font>
</pre>


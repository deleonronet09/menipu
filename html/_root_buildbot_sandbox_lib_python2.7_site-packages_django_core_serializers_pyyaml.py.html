source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/serializers/pyyaml.py</b><br>


file stats: <b>46 lines, 6 executed: 13.0% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. YAML serializer.</font>
<font color="black">   3. </font>
<font color="black">   4. Requires PyYaml (http://pyyaml.org/), but that's checked for in __init__.</font>
<font color="green">   5. &quot;&quot;&quot;</font>
<font color="black">   6. </font>
<font color="green">   7. import collections</font>
<font color="green">   8. import decimal</font>
<font color="green">   9. import sys</font>
<font color="green">  10. from io import StringIO</font>
<font color="black">  11. </font>
<font color="green">  12. import yaml</font>
<font color="black">  13. </font>
<font color="red">  14. from django.core.serializers.base import DeserializationError</font>
<font color="red">  15. from django.core.serializers.python import (</font>
<font color="black">  16.     Deserializer as PythonDeserializer, Serializer as PythonSerializer,</font>
<font color="black">  17. )</font>
<font color="red">  18. from django.db import models</font>
<font color="red">  19. from django.utils import six</font>
<font color="black">  20. </font>
<font color="black">  21. # Use the C (faster) implementation if possible</font>
<font color="red">  22. try:</font>
<font color="red">  23.     from yaml import CSafeLoader as SafeLoader</font>
<font color="red">  24.     from yaml import CSafeDumper as SafeDumper</font>
<font color="red">  25. except ImportError:</font>
<font color="red">  26.     from yaml import SafeLoader, SafeDumper</font>
<font color="black">  27. </font>
<font color="black">  28. </font>
<font color="red">  29. class DjangoSafeDumper(SafeDumper):</font>
<font color="red">  30.     def represent_decimal(self, data):</font>
<font color="red">  31.         return self.represent_scalar('tag:yaml.org,2002:str', str(data))</font>
<font color="black">  32. </font>
<font color="red">  33.     def represent_ordered_dict(self, data):</font>
<font color="red">  34.         return self.represent_mapping('tag:yaml.org,2002:map', data.items())</font>
<font color="black">  35. </font>
<font color="red">  36. DjangoSafeDumper.add_representer(decimal.Decimal, DjangoSafeDumper.represent_decimal)</font>
<font color="red">  37. DjangoSafeDumper.add_representer(collections.OrderedDict, DjangoSafeDumper.represent_ordered_dict)</font>
<font color="black">  38. </font>
<font color="black">  39. </font>
<font color="red">  40. class Serializer(PythonSerializer):</font>
<font color="black">  41.     &quot;&quot;&quot;</font>
<font color="black">  42.     Convert a queryset to YAML.</font>
<font color="red">  43.     &quot;&quot;&quot;</font>
<font color="black">  44. </font>
<font color="red">  45.     internal_use_only = False</font>
<font color="black">  46. </font>
<font color="red">  47.     def handle_field(self, obj, field):</font>
<font color="black">  48.         # A nasty special case: base YAML doesn't support serialization of time</font>
<font color="black">  49.         # types (as opposed to dates or datetimes, which it does support). Since</font>
<font color="black">  50.         # we want to use the &quot;safe&quot; serializer for better interoperability, we</font>
<font color="black">  51.         # need to do something with those pesky times. Converting 'em to strings</font>
<font color="black">  52.         # isn't perfect, but it's better than a &quot;!!python/time&quot; type which would</font>
<font color="black">  53.         # halt deserialization under any other language.</font>
<font color="red">  54.         if isinstance(field, models.TimeField) and getattr(obj, field.name) is not None:</font>
<font color="red">  55.             self._current[field.name] = str(getattr(obj, field.name))</font>
<font color="black">  56.         else:</font>
<font color="red">  57.             super(Serializer, self).handle_field(obj, field)</font>
<font color="black">  58. </font>
<font color="red">  59.     def end_serialization(self):</font>
<font color="red">  60.         yaml.dump(self.objects, self.stream, Dumper=DjangoSafeDumper, **self.options)</font>
<font color="black">  61. </font>
<font color="red">  62.     def getvalue(self):</font>
<font color="black">  63.         # Grand-parent super</font>
<font color="red">  64.         return super(PythonSerializer, self).getvalue()</font>
<font color="black">  65. </font>
<font color="black">  66. </font>
<font color="red">  67. def Deserializer(stream_or_string, **options):</font>
<font color="black">  68.     &quot;&quot;&quot;</font>
<font color="black">  69.     Deserialize a stream or string of YAML data.</font>
<font color="black">  70.     &quot;&quot;&quot;</font>
<font color="red">  71.     if isinstance(stream_or_string, bytes):</font>
<font color="red">  72.         stream_or_string = stream_or_string.decode('utf-8')</font>
<font color="red">  73.     if isinstance(stream_or_string, six.string_types):</font>
<font color="red">  74.         stream = StringIO(stream_or_string)</font>
<font color="black">  75.     else:</font>
<font color="red">  76.         stream = stream_or_string</font>
<font color="red">  77.     try:</font>
<font color="red">  78.         for obj in PythonDeserializer(yaml.load(stream, Loader=SafeLoader), **options):</font>
<font color="red">  79.             yield obj</font>
<font color="red">  80.     except GeneratorExit:</font>
<font color="red">  81.         raise</font>
<font color="red">  82.     except Exception as e:</font>
<font color="black">  83.         # Map to deserializer error</font>
<font color="red">  84.         six.reraise(DeserializationError, DeserializationError(e), sys.exc_info()[2])</font>
</pre>


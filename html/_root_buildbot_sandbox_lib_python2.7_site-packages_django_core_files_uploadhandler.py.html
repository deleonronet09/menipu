source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/files/uploadhandler.py</b><br>


file stats: <b>95 lines, 46 executed: 48.4% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Base file upload handler classes, and the built-in concrete subclasses</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="black">   4. </font>
<font color="green">   5. from __future__ import unicode_literals</font>
<font color="black">   6. </font>
<font color="green">   7. from io import BytesIO</font>
<font color="black">   8. </font>
<font color="green">   9. from django.conf import settings</font>
<font color="green">  10. from django.core.files.uploadedfile import (</font>
<font color="black">  11.     InMemoryUploadedFile, TemporaryUploadedFile,</font>
<font color="black">  12. )</font>
<font color="green">  13. from django.utils.encoding import python_2_unicode_compatible</font>
<font color="green">  14. from django.utils.module_loading import import_string</font>
<font color="black">  15. </font>
<font color="black">  16. __all__ = [</font>
<font color="green">  17.     'UploadFileException', 'StopUpload', 'SkipFile', 'FileUploadHandler',</font>
<font color="green">  18.     'TemporaryFileUploadHandler', 'MemoryFileUploadHandler', 'load_handler',</font>
<font color="green">  19.     'StopFutureHandlers'</font>
<font color="black">  20. ]</font>
<font color="black">  21. </font>
<font color="black">  22. </font>
<font color="green">  23. class UploadFileException(Exception):</font>
<font color="black">  24.     &quot;&quot;&quot;</font>
<font color="black">  25.     Any error having to do with uploading files.</font>
<font color="green">  26.     &quot;&quot;&quot;</font>
<font color="green">  27.     pass</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. @python_2_unicode_compatible</font>
<font color="green">  31. class StopUpload(UploadFileException):</font>
<font color="black">  32.     &quot;&quot;&quot;</font>
<font color="black">  33.     This exception is raised when an upload must abort.</font>
<font color="green">  34.     &quot;&quot;&quot;</font>
<font color="green">  35.     def __init__(self, connection_reset=False):</font>
<font color="black">  36.         &quot;&quot;&quot;</font>
<font color="black">  37.         If ``connection_reset`` is ``True``, Django knows will halt the upload</font>
<font color="black">  38.         without consuming the rest of the upload. This will cause the browser to</font>
<font color="black">  39.         show a &quot;connection reset&quot; error.</font>
<font color="black">  40.         &quot;&quot;&quot;</font>
<font color="red">  41.         self.connection_reset = connection_reset</font>
<font color="black">  42. </font>
<font color="green">  43.     def __str__(self):</font>
<font color="red">  44.         if self.connection_reset:</font>
<font color="red">  45.             return 'StopUpload: Halt current upload.'</font>
<font color="black">  46.         else:</font>
<font color="red">  47.             return 'StopUpload: Consume request data, then halt.'</font>
<font color="black">  48. </font>
<font color="black">  49. </font>
<font color="green">  50. class SkipFile(UploadFileException):</font>
<font color="black">  51.     &quot;&quot;&quot;</font>
<font color="black">  52.     This exception is raised by an upload handler that wants to skip a given file.</font>
<font color="green">  53.     &quot;&quot;&quot;</font>
<font color="green">  54.     pass</font>
<font color="black">  55. </font>
<font color="black">  56. </font>
<font color="green">  57. class StopFutureHandlers(UploadFileException):</font>
<font color="black">  58.     &quot;&quot;&quot;</font>
<font color="black">  59.     Upload handers that have handled a file and do not want future handlers to</font>
<font color="black">  60.     run should raise this exception instead of returning None.</font>
<font color="green">  61.     &quot;&quot;&quot;</font>
<font color="green">  62.     pass</font>
<font color="black">  63. </font>
<font color="black">  64. </font>
<font color="green">  65. class FileUploadHandler(object):</font>
<font color="black">  66.     &quot;&quot;&quot;</font>
<font color="black">  67.     Base class for streaming upload handlers.</font>
<font color="green">  68.     &quot;&quot;&quot;</font>
<font color="green">  69.     chunk_size = 64 * 2 ** 10  # : The default chunk size is 64 KB.</font>
<font color="black">  70. </font>
<font color="green">  71.     def __init__(self, request=None):</font>
<font color="red">  72.         self.file_name = None</font>
<font color="red">  73.         self.content_type = None</font>
<font color="red">  74.         self.content_length = None</font>
<font color="red">  75.         self.charset = None</font>
<font color="red">  76.         self.content_type_extra = None</font>
<font color="red">  77.         self.request = request</font>
<font color="black">  78. </font>
<font color="green">  79.     def handle_raw_input(self, input_data, META, content_length, boundary, encoding=None):</font>
<font color="black">  80.         &quot;&quot;&quot;</font>
<font color="black">  81.         Handle the raw input from the client.</font>
<font color="black">  82. </font>
<font color="black">  83.         Parameters:</font>
<font color="black">  84. </font>
<font color="black">  85.             :input_data:</font>
<font color="black">  86.                 An object that supports reading via .read().</font>
<font color="black">  87.             :META:</font>
<font color="black">  88.                 ``request.META``.</font>
<font color="black">  89.             :content_length:</font>
<font color="black">  90.                 The (integer) value of the Content-Length header from the</font>
<font color="black">  91.                 client.</font>
<font color="black">  92.             :boundary: The boundary from the Content-Type header. Be sure to</font>
<font color="black">  93.                 prepend two '--'.</font>
<font color="black">  94.         &quot;&quot;&quot;</font>
<font color="red">  95.         pass</font>
<font color="black">  96. </font>
<font color="green">  97.     def new_file(self, field_name, file_name, content_type, content_length, charset=None, content_type_extra=None):</font>
<font color="black">  98.         &quot;&quot;&quot;</font>
<font color="black">  99.         Signal that a new file has been started.</font>
<font color="black"> 100. </font>
<font color="black"> 101.         Warning: As with any data from the client, you should not trust</font>
<font color="black"> 102.         content_length (and sometimes won't even get it).</font>
<font color="black"> 103.         &quot;&quot;&quot;</font>
<font color="red"> 104.         self.field_name = field_name</font>
<font color="red"> 105.         self.file_name = file_name</font>
<font color="red"> 106.         self.content_type = content_type</font>
<font color="red"> 107.         self.content_length = content_length</font>
<font color="red"> 108.         self.charset = charset</font>
<font color="red"> 109.         self.content_type_extra = content_type_extra</font>
<font color="black"> 110. </font>
<font color="green"> 111.     def receive_data_chunk(self, raw_data, start):</font>
<font color="black"> 112.         &quot;&quot;&quot;</font>
<font color="black"> 113.         Receive data from the streamed upload parser. ``start`` is the position</font>
<font color="black"> 114.         in the file of the chunk.</font>
<font color="black"> 115.         &quot;&quot;&quot;</font>
<font color="red"> 116.         raise NotImplementedError('subclasses of FileUploadHandler must provide a receive_data_chunk() method')</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def file_complete(self, file_size):</font>
<font color="black"> 119.         &quot;&quot;&quot;</font>
<font color="black"> 120.         Signal that a file has completed. File size corresponds to the actual</font>
<font color="black"> 121.         size accumulated by all the chunks.</font>
<font color="black"> 122. </font>
<font color="black"> 123.         Subclasses should return a valid ``UploadedFile`` object.</font>
<font color="black"> 124.         &quot;&quot;&quot;</font>
<font color="red"> 125.         raise NotImplementedError('subclasses of FileUploadHandler must provide a file_complete() method')</font>
<font color="black"> 126. </font>
<font color="green"> 127.     def upload_complete(self):</font>
<font color="black"> 128.         &quot;&quot;&quot;</font>
<font color="black"> 129.         Signal that the upload is complete. Subclasses should perform cleanup</font>
<font color="black"> 130.         that is necessary for this handler.</font>
<font color="black"> 131.         &quot;&quot;&quot;</font>
<font color="red"> 132.         pass</font>
<font color="black"> 133. </font>
<font color="black"> 134. </font>
<font color="green"> 135. class TemporaryFileUploadHandler(FileUploadHandler):</font>
<font color="black"> 136.     &quot;&quot;&quot;</font>
<font color="black"> 137.     Upload handler that streams data into a temporary file.</font>
<font color="green"> 138.     &quot;&quot;&quot;</font>
<font color="green"> 139.     def __init__(self, *args, **kwargs):</font>
<font color="red"> 140.         super(TemporaryFileUploadHandler, self).__init__(*args, **kwargs)</font>
<font color="black"> 141. </font>
<font color="green"> 142.     def new_file(self, *args, **kwargs):</font>
<font color="black"> 143.         &quot;&quot;&quot;</font>
<font color="black"> 144.         Create the file object to append to as data is coming in.</font>
<font color="black"> 145.         &quot;&quot;&quot;</font>
<font color="red"> 146.         super(TemporaryFileUploadHandler, self).new_file(*args, **kwargs)</font>
<font color="red"> 147.         self.file = TemporaryUploadedFile(self.file_name, self.content_type, 0, self.charset, self.content_type_extra)</font>
<font color="black"> 148. </font>
<font color="green"> 149.     def receive_data_chunk(self, raw_data, start):</font>
<font color="red"> 150.         self.file.write(raw_data)</font>
<font color="black"> 151. </font>
<font color="green"> 152.     def file_complete(self, file_size):</font>
<font color="red"> 153.         self.file.seek(0)</font>
<font color="red"> 154.         self.file.size = file_size</font>
<font color="red"> 155.         return self.file</font>
<font color="black"> 156. </font>
<font color="black"> 157. </font>
<font color="green"> 158. class MemoryFileUploadHandler(FileUploadHandler):</font>
<font color="black"> 159.     &quot;&quot;&quot;</font>
<font color="black"> 160.     File upload handler to stream uploads into memory (used for small files).</font>
<font color="green"> 161.     &quot;&quot;&quot;</font>
<font color="black"> 162. </font>
<font color="green"> 163.     def handle_raw_input(self, input_data, META, content_length, boundary, encoding=None):</font>
<font color="black"> 164.         &quot;&quot;&quot;</font>
<font color="black"> 165.         Use the content_length to signal whether or not this handler should be in use.</font>
<font color="black"> 166.         &quot;&quot;&quot;</font>
<font color="black"> 167.         # Check the content-length header to see if we should</font>
<font color="black"> 168.         # If the post is too large, we cannot use the Memory handler.</font>
<font color="red"> 169.         if content_length &gt; settings.FILE_UPLOAD_MAX_MEMORY_SIZE:</font>
<font color="red"> 170.             self.activated = False</font>
<font color="black"> 171.         else:</font>
<font color="red"> 172.             self.activated = True</font>
<font color="black"> 173. </font>
<font color="green"> 174.     def new_file(self, *args, **kwargs):</font>
<font color="red"> 175.         super(MemoryFileUploadHandler, self).new_file(*args, **kwargs)</font>
<font color="red"> 176.         if self.activated:</font>
<font color="red"> 177.             self.file = BytesIO()</font>
<font color="red"> 178.             raise StopFutureHandlers()</font>
<font color="black"> 179. </font>
<font color="green"> 180.     def receive_data_chunk(self, raw_data, start):</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="black"> 182.         Add the data to the BytesIO file.</font>
<font color="black"> 183.         &quot;&quot;&quot;</font>
<font color="red"> 184.         if self.activated:</font>
<font color="red"> 185.             self.file.write(raw_data)</font>
<font color="black"> 186.         else:</font>
<font color="red"> 187.             return raw_data</font>
<font color="black"> 188. </font>
<font color="green"> 189.     def file_complete(self, file_size):</font>
<font color="black"> 190.         &quot;&quot;&quot;</font>
<font color="black"> 191.         Return a file object if we're activated.</font>
<font color="black"> 192.         &quot;&quot;&quot;</font>
<font color="red"> 193.         if not self.activated:</font>
<font color="red"> 194.             return</font>
<font color="black"> 195. </font>
<font color="red"> 196.         self.file.seek(0)</font>
<font color="red"> 197.         return InMemoryUploadedFile(</font>
<font color="red"> 198.             file=self.file,</font>
<font color="red"> 199.             field_name=self.field_name,</font>
<font color="red"> 200.             name=self.file_name,</font>
<font color="red"> 201.             content_type=self.content_type,</font>
<font color="red"> 202.             size=file_size,</font>
<font color="red"> 203.             charset=self.charset,</font>
<font color="red"> 204.             content_type_extra=self.content_type_extra</font>
<font color="black"> 205.         )</font>
<font color="black"> 206. </font>
<font color="black"> 207. </font>
<font color="green"> 208. def load_handler(path, *args, **kwargs):</font>
<font color="black"> 209.     &quot;&quot;&quot;</font>
<font color="black"> 210.     Given a path to a handler, return an instance of that handler.</font>
<font color="black"> 211. </font>
<font color="black"> 212.     E.g.::</font>
<font color="black"> 213.         &gt;&gt;&gt; from django.http import HttpRequest</font>
<font color="black"> 214.         &gt;&gt;&gt; request = HttpRequest()</font>
<font color="black"> 215.         &gt;&gt;&gt; load_handler('django.core.files.uploadhandler.TemporaryFileUploadHandler', request)</font>
<font color="black"> 216.         &lt;TemporaryFileUploadHandler object at 0x...&gt;</font>
<font color="black"> 217.     &quot;&quot;&quot;</font>
<font color="red"> 218.     return import_string(path)(*args, **kwargs)</font>
</pre>


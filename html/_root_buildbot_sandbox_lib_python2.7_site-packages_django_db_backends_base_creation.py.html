source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/backends/base/creation.py</b><br>


file stats: <b>155 lines, 86 executed: 55.5% covered</b>
<pre>
<font color="green">   1. import sys</font>
<font color="green">   2. import time</font>
<font color="black">   3. </font>
<font color="green">   4. from django.apps import apps</font>
<font color="green">   5. from django.conf import settings</font>
<font color="green">   6. from django.core import serializers</font>
<font color="green">   7. from django.db import router</font>
<font color="green">   8. from django.utils.six import StringIO</font>
<font color="green">   9. from django.utils.six.moves import input</font>
<font color="black">  10. </font>
<font color="black">  11. # The prefix to put on the default database name when creating</font>
<font color="black">  12. # the test database.</font>
<font color="green">  13. TEST_DATABASE_PREFIX = 'test_'</font>
<font color="black">  14. </font>
<font color="black">  15. </font>
<font color="green">  16. class BaseDatabaseCreation(object):</font>
<font color="black">  17.     &quot;&quot;&quot;</font>
<font color="black">  18.     This class encapsulates all backend-specific differences that pertain to</font>
<font color="black">  19.     creation and destruction of the test database.</font>
<font color="green">  20.     &quot;&quot;&quot;</font>
<font color="green">  21.     def __init__(self, connection):</font>
<font color="green">  22.         self.connection = connection</font>
<font color="black">  23. </font>
<font color="green">  24.     @property</font>
<font color="black">  25.     def _nodb_connection(self):</font>
<font color="black">  26.         &quot;&quot;&quot;</font>
<font color="black">  27.         Used to be defined here, now moved to DatabaseWrapper.</font>
<font color="black">  28.         &quot;&quot;&quot;</font>
<font color="red">  29.         return self.connection._nodb_connection</font>
<font color="black">  30. </font>
<font color="green">  31.     def create_test_db(self, verbosity=1, autoclobber=False, serialize=True, keepdb=False):</font>
<font color="black">  32.         &quot;&quot;&quot;</font>
<font color="black">  33.         Creates a test database, prompting the user for confirmation if the</font>
<font color="black">  34.         database already exists. Returns the name of the test database created.</font>
<font color="black">  35.         &quot;&quot;&quot;</font>
<font color="black">  36.         # Don't import django.core.management if it isn't needed.</font>
<font color="green">  37.         from django.core.management import call_command</font>
<font color="black">  38. </font>
<font color="green">  39.         test_database_name = self._get_test_db_name()</font>
<font color="black">  40. </font>
<font color="green">  41.         if verbosity &gt;= 1:</font>
<font color="green">  42.             action = 'Creating'</font>
<font color="green">  43.             if keepdb:</font>
<font color="red">  44.                 action = &quot;Using existing&quot;</font>
<font color="black">  45. </font>
<font color="green">  46.             print(&quot;%s test database for alias %s...&quot; % (</font>
<font color="green">  47.                 action,</font>
<font color="green">  48.                 self._get_database_display_str(verbosity, test_database_name),</font>
<font color="black">  49.             ))</font>
<font color="black">  50. </font>
<font color="black">  51.         # We could skip this call if keepdb is True, but we instead</font>
<font color="black">  52.         # give it the keepdb param. This is to handle the case</font>
<font color="black">  53.         # where the test DB doesn't exist, in which case we need to</font>
<font color="black">  54.         # create it, then just not destroy it. If we instead skip</font>
<font color="black">  55.         # this, we will get an exception.</font>
<font color="green">  56.         self._create_test_db(verbosity, autoclobber, keepdb)</font>
<font color="black">  57. </font>
<font color="green">  58.         self.connection.close()</font>
<font color="green">  59.         settings.DATABASES[self.connection.alias][&quot;NAME&quot;] = test_database_name</font>
<font color="green">  60.         self.connection.settings_dict[&quot;NAME&quot;] = test_database_name</font>
<font color="black">  61. </font>
<font color="black">  62.         # We report migrate messages at one level lower than that requested.</font>
<font color="black">  63.         # This ensures we don't get flooded with messages during testing</font>
<font color="black">  64.         # (unless you really ask to be flooded).</font>
<font color="green">  65.         call_command(</font>
<font color="green">  66.             'migrate',</font>
<font color="green">  67.             verbosity=max(verbosity - 1, 0),</font>
<font color="green">  68.             interactive=False,</font>
<font color="green">  69.             database=self.connection.alias,</font>
<font color="green">  70.             run_syncdb=True,</font>
<font color="black">  71.         )</font>
<font color="black">  72. </font>
<font color="black">  73.         # We then serialize the current state of the database into a string</font>
<font color="black">  74.         # and store it on the connection. This slightly horrific process is so people</font>
<font color="black">  75.         # who are testing on databases without transactions or who are using</font>
<font color="black">  76.         # a TransactionTestCase still get a clean database on every test run.</font>
<font color="green">  77.         if serialize:</font>
<font color="green">  78.             self.connection._test_serialized_contents = self.serialize_db_to_string()</font>
<font color="black">  79. </font>
<font color="green">  80.         call_command('createcachetable', database=self.connection.alias)</font>
<font color="black">  81. </font>
<font color="black">  82.         # Ensure a connection for the side effect of initializing the test database.</font>
<font color="green">  83.         self.connection.ensure_connection()</font>
<font color="black">  84. </font>
<font color="green">  85.         return test_database_name</font>
<font color="black">  86. </font>
<font color="green">  87.     def set_as_test_mirror(self, primary_settings_dict):</font>
<font color="black">  88.         &quot;&quot;&quot;</font>
<font color="black">  89.         Set this database up to be used in testing as a mirror of a primary database</font>
<font color="black">  90.         whose settings are given</font>
<font color="black">  91.         &quot;&quot;&quot;</font>
<font color="red">  92.         self.connection.settings_dict['NAME'] = primary_settings_dict['NAME']</font>
<font color="black">  93. </font>
<font color="green">  94.     def serialize_db_to_string(self):</font>
<font color="black">  95.         &quot;&quot;&quot;</font>
<font color="black">  96.         Serializes all data in the database into a JSON string.</font>
<font color="black">  97.         Designed only for test runner usage; will not handle large</font>
<font color="black">  98.         amounts of data.</font>
<font color="black">  99.         &quot;&quot;&quot;</font>
<font color="black"> 100.         # Build list of all apps to serialize</font>
<font color="green"> 101.         from django.db.migrations.loader import MigrationLoader</font>
<font color="green"> 102.         loader = MigrationLoader(self.connection)</font>
<font color="green"> 103.         app_list = []</font>
<font color="green"> 104.         for app_config in apps.get_app_configs():</font>
<font color="black"> 105.             if (</font>
<font color="green"> 106.                 app_config.models_module is not None and</font>
<font color="green"> 107.                 app_config.label in loader.migrated_apps and</font>
<font color="green"> 108.                 app_config.name not in settings.TEST_NON_SERIALIZED_APPS</font>
<font color="black"> 109.             ):</font>
<font color="green"> 110.                 app_list.append((app_config, None))</font>
<font color="black"> 111. </font>
<font color="black"> 112.         # Make a function to iteratively return every object</font>
<font color="green"> 113.         def get_objects():</font>
<font color="green"> 114.             for model in serializers.sort_dependencies(app_list):</font>
<font color="green"> 115.                 if (model._meta.can_migrate(self.connection) and</font>
<font color="green"> 116.                         router.allow_migrate_model(self.connection.alias, model)):</font>
<font color="green"> 117.                     queryset = model._default_manager.using(self.connection.alias).order_by(model._meta.pk.name)</font>
<font color="green"> 118.                     for obj in queryset.iterator():</font>
<font color="green"> 119.                         yield obj</font>
<font color="black"> 120.         # Serialize to a string</font>
<font color="green"> 121.         out = StringIO()</font>
<font color="green"> 122.         serializers.serialize(&quot;json&quot;, get_objects(), indent=None, stream=out)</font>
<font color="green"> 123.         return out.getvalue()</font>
<font color="black"> 124. </font>
<font color="green"> 125.     def deserialize_db_from_string(self, data):</font>
<font color="black"> 126.         &quot;&quot;&quot;</font>
<font color="black"> 127.         Reloads the database with data from a string generated by</font>
<font color="black"> 128.         the serialize_db_to_string method.</font>
<font color="black"> 129.         &quot;&quot;&quot;</font>
<font color="red"> 130.         data = StringIO(data)</font>
<font color="red"> 131.         for obj in serializers.deserialize(&quot;json&quot;, data, using=self.connection.alias):</font>
<font color="red"> 132.             obj.save()</font>
<font color="black"> 133. </font>
<font color="green"> 134.     def _get_database_display_str(self, verbosity, database_name):</font>
<font color="black"> 135.         &quot;&quot;&quot;</font>
<font color="black"> 136.         Return display string for a database for use in various actions.</font>
<font color="black"> 137.         &quot;&quot;&quot;</font>
<font color="green"> 138.         return &quot;'%s'%s&quot; % (</font>
<font color="green"> 139.             self.connection.alias,</font>
<font color="green"> 140.             (&quot; ('%s')&quot; % database_name) if verbosity &gt;= 2 else '',</font>
<font color="black"> 141.         )</font>
<font color="black"> 142. </font>
<font color="green"> 143.     def _get_test_db_name(self):</font>
<font color="black"> 144.         &quot;&quot;&quot;</font>
<font color="black"> 145.         Internal implementation - returns the name of the test DB that will be</font>
<font color="black"> 146.         created. Only useful when called from create_test_db() and</font>
<font color="black"> 147.         _create_test_db() and when no external munging is done with the 'NAME'</font>
<font color="black"> 148.         settings.</font>
<font color="black"> 149.         &quot;&quot;&quot;</font>
<font color="red"> 150.         if self.connection.settings_dict['TEST']['NAME']:</font>
<font color="red"> 151.             return self.connection.settings_dict['TEST']['NAME']</font>
<font color="red"> 152.         return TEST_DATABASE_PREFIX + self.connection.settings_dict['NAME']</font>
<font color="black"> 153. </font>
<font color="green"> 154.     def _create_test_db(self, verbosity, autoclobber, keepdb=False):</font>
<font color="black"> 155.         &quot;&quot;&quot;</font>
<font color="black"> 156.         Internal implementation - creates the test db tables.</font>
<font color="black"> 157.         &quot;&quot;&quot;</font>
<font color="red"> 158.         suffix = self.sql_table_creation_suffix()</font>
<font color="black"> 159. </font>
<font color="red"> 160.         test_database_name = self._get_test_db_name()</font>
<font color="black"> 161. </font>
<font color="red"> 162.         qn = self.connection.ops.quote_name</font>
<font color="black"> 163. </font>
<font color="black"> 164.         # Create the test database and connect to it.</font>
<font color="red"> 165.         with self._nodb_connection.cursor() as cursor:</font>
<font color="red"> 166.             try:</font>
<font color="red"> 167.                 cursor.execute(</font>
<font color="red"> 168.                     &quot;CREATE DATABASE %s %s&quot; % (qn(test_database_name), suffix))</font>
<font color="red"> 169.             except Exception as e:</font>
<font color="black"> 170.                 # if we want to keep the db, then no need to do any of the below,</font>
<font color="black"> 171.                 # just return and skip it all.</font>
<font color="red"> 172.                 if keepdb:</font>
<font color="red"> 173.                     return test_database_name</font>
<font color="black"> 174. </font>
<font color="red"> 175.                 sys.stderr.write(</font>
<font color="red"> 176.                     &quot;Got an error creating the test database: %s\n&quot; % e)</font>
<font color="red"> 177.                 if not autoclobber:</font>
<font color="red"> 178.                     confirm = input(</font>
<font color="red"> 179.                         &quot;Type 'yes' if you would like to try deleting the test &quot;</font>
<font color="red"> 180.                         &quot;database '%s', or 'no' to cancel: &quot; % test_database_name)</font>
<font color="red"> 181.                 if autoclobber or confirm == 'yes':</font>
<font color="red"> 182.                     try:</font>
<font color="red"> 183.                         if verbosity &gt;= 1:</font>
<font color="red"> 184.                             print(&quot;Destroying old test database for alias %s...&quot; % (</font>
<font color="red"> 185.                                 self._get_database_display_str(verbosity, test_database_name),</font>
<font color="black"> 186.                             ))</font>
<font color="red"> 187.                         cursor.execute(</font>
<font color="red"> 188.                             &quot;DROP DATABASE %s&quot; % qn(test_database_name))</font>
<font color="red"> 189.                         cursor.execute(</font>
<font color="red"> 190.                             &quot;CREATE DATABASE %s %s&quot; % (qn(test_database_name),</font>
<font color="red"> 191.                                                        suffix))</font>
<font color="red"> 192.                     except Exception as e:</font>
<font color="red"> 193.                         sys.stderr.write(</font>
<font color="red"> 194.                             &quot;Got an error recreating the test database: %s\n&quot; % e)</font>
<font color="red"> 195.                         sys.exit(2)</font>
<font color="black"> 196.                 else:</font>
<font color="red"> 197.                     print(&quot;Tests cancelled.&quot;)</font>
<font color="red"> 198.                     sys.exit(1)</font>
<font color="black"> 199. </font>
<font color="red"> 200.         return test_database_name</font>
<font color="black"> 201. </font>
<font color="green"> 202.     def clone_test_db(self, number, verbosity=1, autoclobber=False, keepdb=False):</font>
<font color="black"> 203.         &quot;&quot;&quot;</font>
<font color="black"> 204.         Clone a test database.</font>
<font color="black"> 205.         &quot;&quot;&quot;</font>
<font color="red"> 206.         source_database_name = self.connection.settings_dict['NAME']</font>
<font color="black"> 207. </font>
<font color="red"> 208.         if verbosity &gt;= 1:</font>
<font color="red"> 209.             action = 'Cloning test database'</font>
<font color="red"> 210.             if keepdb:</font>
<font color="red"> 211.                 action = 'Using existing clone'</font>
<font color="red"> 212.             print(&quot;%s for alias %s...&quot; % (</font>
<font color="red"> 213.                 action,</font>
<font color="red"> 214.                 self._get_database_display_str(verbosity, source_database_name),</font>
<font color="black"> 215.             ))</font>
<font color="black"> 216. </font>
<font color="black"> 217.         # We could skip this call if keepdb is True, but we instead</font>
<font color="black"> 218.         # give it the keepdb param. See create_test_db for details.</font>
<font color="red"> 219.         self._clone_test_db(number, verbosity, keepdb)</font>
<font color="black"> 220. </font>
<font color="green"> 221.     def get_test_db_clone_settings(self, number):</font>
<font color="black"> 222.         &quot;&quot;&quot;</font>
<font color="black"> 223.         Return a modified connection settings dict for the n-th clone of a DB.</font>
<font color="black"> 224.         &quot;&quot;&quot;</font>
<font color="black"> 225.         # When this function is called, the test database has been created</font>
<font color="black"> 226.         # already and its name has been copied to settings_dict['NAME'] so</font>
<font color="black"> 227.         # we don't need to call _get_test_db_name.</font>
<font color="red"> 228.         orig_settings_dict = self.connection.settings_dict</font>
<font color="red"> 229.         new_settings_dict = orig_settings_dict.copy()</font>
<font color="red"> 230.         new_settings_dict['NAME'] = '{}_{}'.format(orig_settings_dict['NAME'], number)</font>
<font color="red"> 231.         return new_settings_dict</font>
<font color="black"> 232. </font>
<font color="green"> 233.     def _clone_test_db(self, number, verbosity, keepdb=False):</font>
<font color="black"> 234.         &quot;&quot;&quot;</font>
<font color="black"> 235.         Internal implementation - duplicate the test db tables.</font>
<font color="black"> 236.         &quot;&quot;&quot;</font>
<font color="red"> 237.         raise NotImplementedError(</font>
<font color="red"> 238.             &quot;The database backend doesn't support cloning databases. &quot;</font>
<font color="black"> 239.             &quot;Disable the option to run tests in parallel processes.&quot;)</font>
<font color="black"> 240. </font>
<font color="green"> 241.     def destroy_test_db(self, old_database_name=None, verbosity=1, keepdb=False, number=None):</font>
<font color="black"> 242.         &quot;&quot;&quot;</font>
<font color="black"> 243.         Destroy a test database, prompting the user for confirmation if the</font>
<font color="black"> 244.         database already exists.</font>
<font color="black"> 245.         &quot;&quot;&quot;</font>
<font color="green"> 246.         self.connection.close()</font>
<font color="green"> 247.         if number is None:</font>
<font color="green"> 248.             test_database_name = self.connection.settings_dict['NAME']</font>
<font color="black"> 249.         else:</font>
<font color="red"> 250.             test_database_name = self.get_test_db_clone_settings(number)['NAME']</font>
<font color="black"> 251. </font>
<font color="green"> 252.         if verbosity &gt;= 1:</font>
<font color="green"> 253.             action = 'Destroying'</font>
<font color="green"> 254.             if keepdb:</font>
<font color="red"> 255.                 action = 'Preserving'</font>
<font color="green"> 256.             print(&quot;%s test database for alias %s...&quot; % (</font>
<font color="green"> 257.                 action,</font>
<font color="green"> 258.                 self._get_database_display_str(verbosity, test_database_name),</font>
<font color="black"> 259.             ))</font>
<font color="black"> 260. </font>
<font color="black"> 261.         # if we want to preserve the database</font>
<font color="black"> 262.         # skip the actual destroying piece.</font>
<font color="green"> 263.         if not keepdb:</font>
<font color="green"> 264.             self._destroy_test_db(test_database_name, verbosity)</font>
<font color="black"> 265. </font>
<font color="black"> 266.         # Restore the original database name</font>
<font color="green"> 267.         if old_database_name is not None:</font>
<font color="green"> 268.             settings.DATABASES[self.connection.alias][&quot;NAME&quot;] = old_database_name</font>
<font color="green"> 269.             self.connection.settings_dict[&quot;NAME&quot;] = old_database_name</font>
<font color="black"> 270. </font>
<font color="green"> 271.     def _destroy_test_db(self, test_database_name, verbosity):</font>
<font color="black"> 272.         &quot;&quot;&quot;</font>
<font color="black"> 273.         Internal implementation - remove the test db tables.</font>
<font color="black"> 274.         &quot;&quot;&quot;</font>
<font color="black"> 275.         # Remove the test database to clean up after</font>
<font color="black"> 276.         # ourselves. Connect to the previous database (not the test database)</font>
<font color="black"> 277.         # to do so, because it's not allowed to delete a database while being</font>
<font color="black"> 278.         # connected to it.</font>
<font color="red"> 279.         with self.connection._nodb_connection.cursor() as cursor:</font>
<font color="black"> 280.             # Wait to avoid &quot;database is being accessed by other users&quot; errors.</font>
<font color="red"> 281.             time.sleep(1)</font>
<font color="red"> 282.             cursor.execute(&quot;DROP DATABASE %s&quot;</font>
<font color="red"> 283.                            % self.connection.ops.quote_name(test_database_name))</font>
<font color="black"> 284. </font>
<font color="green"> 285.     def sql_table_creation_suffix(self):</font>
<font color="black"> 286.         &quot;&quot;&quot;</font>
<font color="black"> 287.         SQL to append to the end of the test table creation statements.</font>
<font color="black"> 288.         &quot;&quot;&quot;</font>
<font color="red"> 289.         return ''</font>
<font color="black"> 290. </font>
<font color="green"> 291.     def test_db_signature(self):</font>
<font color="black"> 292.         &quot;&quot;&quot;</font>
<font color="black"> 293.         Returns a tuple with elements of self.connection.settings_dict (a</font>
<font color="black"> 294.         DATABASES setting value) that uniquely identify a database</font>
<font color="black"> 295.         accordingly to the RDBMS particularities.</font>
<font color="black"> 296.         &quot;&quot;&quot;</font>
<font color="red"> 297.         settings_dict = self.connection.settings_dict</font>
<font color="black"> 298.         return (</font>
<font color="red"> 299.             settings_dict['HOST'],</font>
<font color="red"> 300.             settings_dict['PORT'],</font>
<font color="red"> 301.             settings_dict['ENGINE'],</font>
<font color="red"> 302.             settings_dict['NAME']</font>
<font color="black"> 303.         )</font>
</pre>


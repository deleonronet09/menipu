source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/operations/base.py</b><br>


file stats: <b>37 lines, 23 executed: 62.2% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.db import router</font>
<font color="black">   4. </font>
<font color="black">   5. </font>
<font color="green">   6. class Operation(object):</font>
<font color="black">   7.     &quot;&quot;&quot;</font>
<font color="black">   8.     Base class for migration operations.</font>
<font color="black">   9. </font>
<font color="black">  10.     It's responsible for both mutating the in-memory model state</font>
<font color="black">  11.     (see db/migrations/state.py) to represent what it performs, as well</font>
<font color="black">  12.     as actually performing it against a live database.</font>
<font color="black">  13. </font>
<font color="black">  14.     Note that some operations won't modify memory state at all (e.g. data</font>
<font color="black">  15.     copying operations), and some will need their modifications to be</font>
<font color="black">  16.     optionally specified by the user (e.g. custom Python code snippets)</font>
<font color="black">  17. </font>
<font color="black">  18.     Due to the way this class deals with deconstruction, it should be</font>
<font color="black">  19.     considered immutable.</font>
<font color="green">  20.     &quot;&quot;&quot;</font>
<font color="black">  21. </font>
<font color="black">  22.     # If this migration can be run in reverse.</font>
<font color="black">  23.     # Some operations are impossible to reverse, like deleting data.</font>
<font color="green">  24.     reversible = True</font>
<font color="black">  25. </font>
<font color="black">  26.     # Can this migration be represented as SQL? (things like RunPython cannot)</font>
<font color="green">  27.     reduces_to_sql = True</font>
<font color="black">  28. </font>
<font color="black">  29.     # Should this operation be forced as atomic even on backends with no</font>
<font color="black">  30.     # DDL transaction support (i.e., does it have no DDL, like RunPython)</font>
<font color="green">  31.     atomic = False</font>
<font color="black">  32. </font>
<font color="green">  33.     serialization_expand_args = []</font>
<font color="black">  34. </font>
<font color="green">  35.     def __new__(cls, *args, **kwargs):</font>
<font color="black">  36.         # We capture the arguments to make returning them trivial</font>
<font color="green">  37.         self = object.__new__(cls)</font>
<font color="green">  38.         self._constructor_args = (args, kwargs)</font>
<font color="green">  39.         return self</font>
<font color="black">  40. </font>
<font color="green">  41.     def deconstruct(self):</font>
<font color="black">  42.         &quot;&quot;&quot;</font>
<font color="black">  43.         Returns a 3-tuple of class import path (or just name if it lives</font>
<font color="black">  44.         under django.db.migrations), positional arguments, and keyword</font>
<font color="black">  45.         arguments.</font>
<font color="black">  46.         &quot;&quot;&quot;</font>
<font color="black">  47.         return (</font>
<font color="red">  48.             self.__class__.__name__,</font>
<font color="red">  49.             self._constructor_args[0],</font>
<font color="red">  50.             self._constructor_args[1],</font>
<font color="black">  51.         )</font>
<font color="black">  52. </font>
<font color="green">  53.     def state_forwards(self, app_label, state):</font>
<font color="black">  54.         &quot;&quot;&quot;</font>
<font color="black">  55.         Takes the state from the previous migration, and mutates it</font>
<font color="black">  56.         so that it matches what this migration would perform.</font>
<font color="black">  57.         &quot;&quot;&quot;</font>
<font color="red">  58.         raise NotImplementedError('subclasses of Operation must provide a state_forwards() method')</font>
<font color="black">  59. </font>
<font color="green">  60.     def database_forwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="black">  61.         &quot;&quot;&quot;</font>
<font color="black">  62.         Performs the mutation on the database schema in the normal</font>
<font color="black">  63.         (forwards) direction.</font>
<font color="black">  64.         &quot;&quot;&quot;</font>
<font color="red">  65.         raise NotImplementedError('subclasses of Operation must provide a database_forwards() method')</font>
<font color="black">  66. </font>
<font color="green">  67.     def database_backwards(self, app_label, schema_editor, from_state, to_state):</font>
<font color="black">  68.         &quot;&quot;&quot;</font>
<font color="black">  69.         Performs the mutation on the database schema in the reverse</font>
<font color="black">  70.         direction - e.g. if this were CreateModel, it would in fact</font>
<font color="black">  71.         drop the model's table.</font>
<font color="black">  72.         &quot;&quot;&quot;</font>
<font color="red">  73.         raise NotImplementedError('subclasses of Operation must provide a database_backwards() method')</font>
<font color="black">  74. </font>
<font color="green">  75.     def describe(self):</font>
<font color="black">  76.         &quot;&quot;&quot;</font>
<font color="black">  77.         Outputs a brief summary of what the action does.</font>
<font color="black">  78.         &quot;&quot;&quot;</font>
<font color="red">  79.         return &quot;%s: %s&quot; % (self.__class__.__name__, self._constructor_args)</font>
<font color="black">  80. </font>
<font color="green">  81.     def references_model(self, name, app_label=None):</font>
<font color="black">  82.         &quot;&quot;&quot;</font>
<font color="black">  83.         Returns True if there is a chance this operation references the given</font>
<font color="black">  84.         model name (as a string), with an optional app label for accuracy.</font>
<font color="black">  85. </font>
<font color="black">  86.         Used for optimization. If in doubt, return True;</font>
<font color="black">  87.         returning a false positive will merely make the optimizer a little</font>
<font color="black">  88.         less efficient, while returning a false negative may result in an</font>
<font color="black">  89.         unusable optimized migration.</font>
<font color="black">  90.         &quot;&quot;&quot;</font>
<font color="red">  91.         return True</font>
<font color="black">  92. </font>
<font color="green">  93.     def references_field(self, model_name, name, app_label=None):</font>
<font color="black">  94.         &quot;&quot;&quot;</font>
<font color="black">  95.         Returns True if there is a chance this operation references the given</font>
<font color="black">  96.         field name, with an optional app label for accuracy.</font>
<font color="black">  97. </font>
<font color="black">  98.         Used for optimization. If in doubt, return True.</font>
<font color="black">  99.         &quot;&quot;&quot;</font>
<font color="red"> 100.         return self.references_model(model_name, app_label)</font>
<font color="black"> 101. </font>
<font color="green"> 102.     def allow_migrate_model(self, connection_alias, model):</font>
<font color="black"> 103.         &quot;&quot;&quot;</font>
<font color="black"> 104.         Returns if we're allowed to migrate the model.</font>
<font color="black"> 105. </font>
<font color="black"> 106.         This is a thin wrapper around router.allow_migrate_model() that</font>
<font color="black"> 107.         preemptively rejects any proxy, swapped out, or unmanaged model.</font>
<font color="black"> 108.         &quot;&quot;&quot;</font>
<font color="green"> 109.         if not model._meta.can_migrate(connection_alias):</font>
<font color="red"> 110.             return False</font>
<font color="black"> 111. </font>
<font color="green"> 112.         return router.allow_migrate_model(connection_alias, model)</font>
<font color="black"> 113. </font>
<font color="green"> 114.     def __repr__(self):</font>
<font color="red"> 115.         return &quot;&lt;%s %s%s&gt;&quot; % (</font>
<font color="red"> 116.             self.__class__.__name__,</font>
<font color="red"> 117.             &quot;, &quot;.join(map(repr, self._constructor_args[0])),</font>
<font color="red"> 118.             &quot;,&quot;.join(&quot; %s=%r&quot; % x for x in self._constructor_args[1].items()),</font>
<font color="black"> 119.         )</font>
</pre>


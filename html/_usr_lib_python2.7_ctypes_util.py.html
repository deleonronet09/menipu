source file: <b>/usr/lib/python2.7/ctypes/util.py</b><br>


file stats: <b>200 lines, 39 executed: 19.5% covered</b>
<pre>
<font color="black">   1. ######################################################################</font>
<font color="black">   2. #  This file should be kept compatible with Python 2.3, see PEP 291. #</font>
<font color="black">   3. ######################################################################</font>
<font color="green">   4. import sys, os</font>
<font color="black">   5. </font>
<font color="black">   6. # find_library(name) returns the pathname of a library, or None.</font>
<font color="green">   7. if os.name == &quot;nt&quot;:</font>
<font color="black">   8. </font>
<font color="red">   9.     def _get_build_version():</font>
<font color="black">  10.         &quot;&quot;&quot;Return the version of MSVC that was used to build Python.</font>
<font color="black">  11. </font>
<font color="black">  12.         For Python 2.3 and up, the version number is included in</font>
<font color="black">  13.         sys.version.  For earlier versions, assume the compiler is MSVC 6.</font>
<font color="black">  14.         &quot;&quot;&quot;</font>
<font color="black">  15.         # This function was copied from Lib/distutils/msvccompiler.py</font>
<font color="red">  16.         prefix = &quot;MSC v.&quot;</font>
<font color="red">  17.         i = sys.version.find(prefix)</font>
<font color="red">  18.         if i == -1:</font>
<font color="red">  19.             return 6</font>
<font color="red">  20.         i = i + len(prefix)</font>
<font color="red">  21.         s, rest = sys.version[i:].split(&quot; &quot;, 1)</font>
<font color="red">  22.         majorVersion = int(s[:-2]) - 6</font>
<font color="red">  23.         minorVersion = int(s[2:3]) / 10.0</font>
<font color="black">  24.         # I don't think paths are affected by minor version in version 6</font>
<font color="red">  25.         if majorVersion == 6:</font>
<font color="red">  26.             minorVersion = 0</font>
<font color="red">  27.         if majorVersion &gt;= 6:</font>
<font color="red">  28.             return majorVersion + minorVersion</font>
<font color="black">  29.         # else we don't know what version of the compiler this is</font>
<font color="red">  30.         return None</font>
<font color="black">  31. </font>
<font color="red">  32.     def find_msvcrt():</font>
<font color="black">  33.         &quot;&quot;&quot;Return the name of the VC runtime dll&quot;&quot;&quot;</font>
<font color="red">  34.         version = _get_build_version()</font>
<font color="red">  35.         if version is None:</font>
<font color="black">  36.             # better be safe than sorry</font>
<font color="red">  37.             return None</font>
<font color="red">  38.         if version &lt;= 6:</font>
<font color="red">  39.             clibname = 'msvcrt'</font>
<font color="black">  40.         else:</font>
<font color="red">  41.             clibname = 'msvcr%d' % (version * 10)</font>
<font color="black">  42. </font>
<font color="black">  43.         # If python was built with in debug mode</font>
<font color="red">  44.         import imp</font>
<font color="red">  45.         if imp.get_suffixes()[0][0] == '_d.pyd':</font>
<font color="red">  46.             clibname += 'd'</font>
<font color="red">  47.         return clibname+'.dll'</font>
<font color="black">  48. </font>
<font color="red">  49.     def find_library(name):</font>
<font color="red">  50.         if name in ('c', 'm'):</font>
<font color="red">  51.             return find_msvcrt()</font>
<font color="black">  52.         # See MSDN for the REAL search order.</font>
<font color="red">  53.         for directory in os.environ['PATH'].split(os.pathsep):</font>
<font color="red">  54.             fname = os.path.join(directory, name)</font>
<font color="red">  55.             if os.path.isfile(fname):</font>
<font color="red">  56.                 return fname</font>
<font color="red">  57.             if fname.lower().endswith(&quot;.dll&quot;):</font>
<font color="red">  58.                 continue</font>
<font color="red">  59.             fname = fname + &quot;.dll&quot;</font>
<font color="red">  60.             if os.path.isfile(fname):</font>
<font color="red">  61.                 return fname</font>
<font color="red">  62.         return None</font>
<font color="black">  63. </font>
<font color="green">  64. if os.name == &quot;ce&quot;:</font>
<font color="black">  65.     # search path according to MSDN:</font>
<font color="black">  66.     # - absolute path specified by filename</font>
<font color="black">  67.     # - The .exe launch directory</font>
<font color="black">  68.     # - the Windows directory</font>
<font color="black">  69.     # - ROM dll files (where are they?)</font>
<font color="black">  70.     # - OEM specified search path: HKLM\Loader\SystemPath</font>
<font color="red">  71.     def find_library(name):</font>
<font color="red">  72.         return name</font>
<font color="black">  73. </font>
<font color="green">  74. if os.name == &quot;posix&quot; and sys.platform == &quot;darwin&quot;:</font>
<font color="red">  75.     from ctypes.macholib.dyld import dyld_find as _dyld_find</font>
<font color="red">  76.     def find_library(name):</font>
<font color="red">  77.         possible = ['lib%s.dylib' % name,</font>
<font color="red">  78.                     '%s.dylib' % name,</font>
<font color="red">  79.                     '%s.framework/%s' % (name, name)]</font>
<font color="red">  80.         for name in possible:</font>
<font color="red">  81.             try:</font>
<font color="red">  82.                 return _dyld_find(name)</font>
<font color="red">  83.             except ValueError:</font>
<font color="red">  84.                 continue</font>
<font color="red">  85.         return None</font>
<font color="black">  86. </font>
<font color="green">  87. elif os.name == &quot;posix&quot;:</font>
<font color="black">  88.     # Andreas Degert's find functions, using gcc, /sbin/ldconfig, objdump</font>
<font color="green">  89.     import re, tempfile, errno</font>
<font color="black">  90. </font>
<font color="green">  91.     def _findLib_gcc(name):</font>
<font color="red">  92.         expr = r'[^\(\)\s]*lib%s\.[^\(\)\s]*' % re.escape(name)</font>
<font color="red">  93.         fdout, ccout = tempfile.mkstemp()</font>
<font color="red">  94.         os.close(fdout)</font>
<font color="black">  95.         cmd = 'if type gcc &gt;/dev/null 2&gt;&amp;1; then CC=gcc; elif type cc &gt;/dev/null 2&gt;&amp;1; then CC=cc;else exit 10; fi;' \</font>
<font color="red">  96.               'LANG=C LC_ALL=C $CC -Wl,-t -o ' + ccout + ' 2&gt;&amp;1 -l' + name</font>
<font color="red">  97.         try:</font>
<font color="red">  98.             f = os.popen(cmd)</font>
<font color="red">  99.             try:</font>
<font color="red"> 100.                 trace = f.read()</font>
<font color="black"> 101.             finally:</font>
<font color="red"> 102.                 rv = f.close()</font>
<font color="black"> 103.         finally:</font>
<font color="red"> 104.             try:</font>
<font color="red"> 105.                 os.unlink(ccout)</font>
<font color="red"> 106.             except OSError, e:</font>
<font color="red"> 107.                 if e.errno != errno.ENOENT:</font>
<font color="red"> 108.                     raise</font>
<font color="red"> 109.         if rv == 10:</font>
<font color="red"> 110.             raise OSError, 'gcc or cc command not found'</font>
<font color="red"> 111.         res = re.search(expr, trace)</font>
<font color="red"> 112.         if not res:</font>
<font color="red"> 113.             return None</font>
<font color="red"> 114.         return res.group(0)</font>
<font color="black"> 115. </font>
<font color="black"> 116. </font>
<font color="green"> 117.     if sys.platform == &quot;sunos5&quot;:</font>
<font color="black"> 118.         # use /usr/ccs/bin/dump on solaris</font>
<font color="red"> 119.         def _get_soname(f):</font>
<font color="red"> 120.             if not f:</font>
<font color="red"> 121.                 return None</font>
<font color="red"> 122.             cmd = &quot;/usr/ccs/bin/dump -Lpv 2&gt;/dev/null &quot; + f</font>
<font color="red"> 123.             f = os.popen(cmd)</font>
<font color="red"> 124.             try:</font>
<font color="red"> 125.                 data = f.read()</font>
<font color="black"> 126.             finally:</font>
<font color="red"> 127.                 f.close()</font>
<font color="red"> 128.             res = re.search(r'\[.*\]\sSONAME\s+([^\s]+)', data)</font>
<font color="red"> 129.             if not res:</font>
<font color="red"> 130.                 return None</font>
<font color="red"> 131.             return res.group(1)</font>
<font color="black"> 132.     else:</font>
<font color="green"> 133.         def _get_soname(f):</font>
<font color="black"> 134.             # assuming GNU binutils / ELF</font>
<font color="red"> 135.             if not f:</font>
<font color="red"> 136.                 return None</font>
<font color="red"> 137.             cmd = 'if ! type objdump &gt;/dev/null 2&gt;&amp;1; then exit 10; fi;' \</font>
<font color="red"> 138.                   &quot;objdump -p -j .dynamic 2&gt;/dev/null &quot; + f</font>
<font color="red"> 139.             f = os.popen(cmd)</font>
<font color="red"> 140.             dump = f.read()</font>
<font color="red"> 141.             rv = f.close()</font>
<font color="red"> 142.             if rv == 10:</font>
<font color="red"> 143.                 raise OSError, 'objdump command not found'</font>
<font color="red"> 144.             f = os.popen(cmd)</font>
<font color="red"> 145.             try:</font>
<font color="red"> 146.                 data = f.read()</font>
<font color="black"> 147.             finally:</font>
<font color="red"> 148.                 f.close()</font>
<font color="red"> 149.             res = re.search(r'\sSONAME\s+([^\s]+)', data)</font>
<font color="red"> 150.             if not res:</font>
<font color="red"> 151.                 return None</font>
<font color="red"> 152.             return res.group(1)</font>
<font color="black"> 153. </font>
<font color="green"> 154.     if (sys.platform.startswith(&quot;freebsd&quot;)</font>
<font color="green"> 155.         or sys.platform.startswith(&quot;openbsd&quot;)</font>
<font color="green"> 156.         or sys.platform.startswith(&quot;dragonfly&quot;)):</font>
<font color="black"> 157. </font>
<font color="red"> 158.         def _num_version(libname):</font>
<font color="black"> 159.             # &quot;libxyz.so.MAJOR.MINOR&quot; =&gt; [ MAJOR, MINOR ]</font>
<font color="red"> 160.             parts = libname.split(&quot;.&quot;)</font>
<font color="red"> 161.             nums = []</font>
<font color="red"> 162.             try:</font>
<font color="red"> 163.                 while parts:</font>
<font color="red"> 164.                     nums.insert(0, int(parts.pop()))</font>
<font color="red"> 165.             except ValueError:</font>
<font color="red"> 166.                 pass</font>
<font color="red"> 167.             return nums or [ sys.maxint ]</font>
<font color="black"> 168. </font>
<font color="red"> 169.         def find_library(name):</font>
<font color="red"> 170.             ename = re.escape(name)</font>
<font color="red"> 171.             expr = r':-l%s\.\S+ =&gt; \S*/(lib%s\.\S+)' % (ename, ename)</font>
<font color="red"> 172.             f = os.popen('/sbin/ldconfig -r 2&gt;/dev/null')</font>
<font color="red"> 173.             try:</font>
<font color="red"> 174.                 data = f.read()</font>
<font color="black"> 175.             finally:</font>
<font color="red"> 176.                 f.close()</font>
<font color="red"> 177.             res = re.findall(expr, data)</font>
<font color="red"> 178.             if not res:</font>
<font color="red"> 179.                 return _get_soname(_findLib_gcc(name))</font>
<font color="red"> 180.             res.sort(cmp= lambda x,y: cmp(_num_version(x), _num_version(y)))</font>
<font color="red"> 181.             return res[-1]</font>
<font color="black"> 182. </font>
<font color="green"> 183.     elif sys.platform == &quot;sunos5&quot;:</font>
<font color="black"> 184. </font>
<font color="red"> 185.         def _findLib_crle(name, is64):</font>
<font color="red"> 186.             if not os.path.exists('/usr/bin/crle'):</font>
<font color="red"> 187.                 return None</font>
<font color="black"> 188. </font>
<font color="red"> 189.             if is64:</font>
<font color="red"> 190.                 cmd = 'env LC_ALL=C /usr/bin/crle -64 2&gt;/dev/null'</font>
<font color="black"> 191.             else:</font>
<font color="red"> 192.                 cmd = 'env LC_ALL=C /usr/bin/crle 2&gt;/dev/null'</font>
<font color="black"> 193. </font>
<font color="red"> 194.             for line in os.popen(cmd).readlines():</font>
<font color="red"> 195.                 line = line.strip()</font>
<font color="red"> 196.                 if line.startswith('Default Library Path (ELF):'):</font>
<font color="red"> 197.                     paths = line.split()[4]</font>
<font color="black"> 198. </font>
<font color="red"> 199.             if not paths:</font>
<font color="red"> 200.                 return None</font>
<font color="black"> 201. </font>
<font color="red"> 202.             for dir in paths.split(&quot;:&quot;):</font>
<font color="red"> 203.                 libfile = os.path.join(dir, &quot;lib%s.so&quot; % name)</font>
<font color="red"> 204.                 if os.path.exists(libfile):</font>
<font color="red"> 205.                     return libfile</font>
<font color="black"> 206. </font>
<font color="red"> 207.             return None</font>
<font color="black"> 208. </font>
<font color="red"> 209.         def find_library(name, is64 = False):</font>
<font color="red"> 210.             return _get_soname(_findLib_crle(name, is64) or _findLib_gcc(name))</font>
<font color="black"> 211. </font>
<font color="black"> 212.     else:</font>
<font color="black"> 213. </font>
<font color="green"> 214.         def _findSoname_ldconfig(name):</font>
<font color="green"> 215.             import struct</font>
<font color="black"> 216.             # XXX this code assumes that we know all unames and that a single</font>
<font color="black"> 217.             # ABI is supported per uname; instead we should find what the</font>
<font color="black"> 218.             # ABI is (e.g. check ABI of current process) or simply ask libc</font>
<font color="black"> 219.             # to load the library for us</font>
<font color="green"> 220.             uname = os.uname()[4]</font>
<font color="black"> 221.             # ARM has a variety of unames, e.g. armv7l</font>
<font color="green"> 222.             if uname.startswith(&quot;arm&quot;):</font>
<font color="red"> 223.                 uname = &quot;arm&quot;</font>
<font color="green"> 224.             if struct.calcsize('l') == 4:</font>
<font color="red"> 225.                 machine = uname + '-32'</font>
<font color="black"> 226.             else:</font>
<font color="green"> 227.                 machine = uname + '-64'</font>
<font color="green"> 228.             mach_map = {</font>
<font color="green"> 229.                 'x86_64-64': 'libc6,x86-64',</font>
<font color="green"> 230.                 'ppc64-64': 'libc6,64bit',</font>
<font color="green"> 231.                 'sparc64-64': 'libc6,64bit',</font>
<font color="green"> 232.                 's390x-64': 'libc6,64bit',</font>
<font color="green"> 233.                 'ia64-64': 'libc6,IA-64',</font>
<font color="black"> 234.                 # this actually breaks on biarch or multiarch as the first</font>
<font color="black"> 235.                 # library wins; uname doesn't tell us which ABI we're using</font>
<font color="green"> 236.                 'arm-32': 'libc6(,hard-float)?',</font>
<font color="black"> 237.                 }</font>
<font color="green"> 238.             abi_type = mach_map.get(machine, 'libc6')</font>
<font color="black"> 239. </font>
<font color="black"> 240.             # XXX assuming GLIBC's ldconfig (with option -p)</font>
<font color="green"> 241.             expr = r'\s+(lib%s\.[^\s]+)\s+\(%s' % (re.escape(name), abi_type)</font>
<font color="green"> 242.             f = os.popen('/sbin/ldconfig -p 2&gt;/dev/null')</font>
<font color="green"> 243.             try:</font>
<font color="green"> 244.                 data = f.read()</font>
<font color="black"> 245.             finally:</font>
<font color="green"> 246.                 f.close()</font>
<font color="green"> 247.             res = re.search(expr, data)</font>
<font color="green"> 248.             if not res:</font>
<font color="red"> 249.                 return None</font>
<font color="green"> 250.             return res.group(1)</font>
<font color="black"> 251. </font>
<font color="green"> 252.         def find_library(name):</font>
<font color="green"> 253.             return _findSoname_ldconfig(name) or _get_soname(_findLib_gcc(name))</font>
<font color="black"> 254. </font>
<font color="black"> 255. ################################################################</font>
<font color="black"> 256. # test code</font>
<font color="black"> 257. </font>
<font color="green"> 258. def test():</font>
<font color="red"> 259.     from ctypes import cdll</font>
<font color="red"> 260.     if os.name == &quot;nt&quot;:</font>
<font color="red"> 261.         print cdll.msvcrt</font>
<font color="red"> 262.         print cdll.load(&quot;msvcrt&quot;)</font>
<font color="red"> 263.         print find_library(&quot;msvcrt&quot;)</font>
<font color="black"> 264. </font>
<font color="red"> 265.     if os.name == &quot;posix&quot;:</font>
<font color="black"> 266.         # find and load_version</font>
<font color="red"> 267.         print find_library(&quot;m&quot;)</font>
<font color="red"> 268.         print find_library(&quot;c&quot;)</font>
<font color="red"> 269.         print find_library(&quot;bz2&quot;)</font>
<font color="black"> 270. </font>
<font color="black"> 271.         # getattr</font>
<font color="black"> 272. ##        print cdll.m</font>
<font color="black"> 273. ##        print cdll.bz2</font>
<font color="black"> 274. </font>
<font color="black"> 275.         # load</font>
<font color="red"> 276.         if sys.platform == &quot;darwin&quot;:</font>
<font color="red"> 277.             print cdll.LoadLibrary(&quot;libm.dylib&quot;)</font>
<font color="red"> 278.             print cdll.LoadLibrary(&quot;libcrypto.dylib&quot;)</font>
<font color="red"> 279.             print cdll.LoadLibrary(&quot;libSystem.dylib&quot;)</font>
<font color="red"> 280.             print cdll.LoadLibrary(&quot;System.framework/System&quot;)</font>
<font color="black"> 281.         else:</font>
<font color="red"> 282.             print cdll.LoadLibrary(&quot;libm.so&quot;)</font>
<font color="red"> 283.             print cdll.LoadLibrary(&quot;libcrypt.so&quot;)</font>
<font color="red"> 284.             print find_library(&quot;crypt&quot;)</font>
<font color="black"> 285. </font>
<font color="green"> 286. if __name__ == &quot;__main__&quot;:</font>
<font color="red"> 287.     test()</font>
</pre>


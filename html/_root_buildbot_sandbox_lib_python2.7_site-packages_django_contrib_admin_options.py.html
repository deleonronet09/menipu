source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/admin/options.py</b><br>


file stats: <b>1206 lines, 223 executed: 18.5% covered</b>
<pre>
<font color="green">   1. import copy</font>
<font color="green">   2. import operator</font>
<font color="green">   3. from collections import OrderedDict</font>
<font color="green">   4. from functools import partial, reduce, update_wrapper</font>
<font color="black">   5. </font>
<font color="green">   6. from django import forms</font>
<font color="green">   7. from django.conf import settings</font>
<font color="green">   8. from django.contrib import messages</font>
<font color="green">   9. from django.contrib.admin import helpers, widgets</font>
<font color="green">  10. from django.contrib.admin.checks import (</font>
<font color="black">  11.     BaseModelAdminChecks, InlineModelAdminChecks, ModelAdminChecks,</font>
<font color="black">  12. )</font>
<font color="green">  13. from django.contrib.admin.exceptions import DisallowedModelAdminToField</font>
<font color="green">  14. from django.contrib.admin.templatetags.admin_static import static</font>
<font color="green">  15. from django.contrib.admin.templatetags.admin_urls import add_preserved_filters</font>
<font color="green">  16. from django.contrib.admin.utils import (</font>
<font color="black">  17.     NestedObjects, flatten_fieldsets, get_deleted_objects,</font>
<font color="black">  18.     lookup_needs_distinct, model_format_dict, quote, unquote,</font>
<font color="black">  19. )</font>
<font color="green">  20. from django.contrib.auth import get_permission_codename</font>
<font color="green">  21. from django.core.exceptions import (</font>
<font color="black">  22.     FieldDoesNotExist, FieldError, PermissionDenied, ValidationError,</font>
<font color="black">  23. )</font>
<font color="green">  24. from django.core.paginator import Paginator</font>
<font color="green">  25. from django.core.urlresolvers import reverse</font>
<font color="green">  26. from django.db import models, router, transaction</font>
<font color="green">  27. from django.db.models.constants import LOOKUP_SEP</font>
<font color="green">  28. from django.db.models.fields import BLANK_CHOICE_DASH</font>
<font color="green">  29. from django.forms.formsets import DELETION_FIELD_NAME, all_valid</font>
<font color="green">  30. from django.forms.models import (</font>
<font color="black">  31.     BaseInlineFormSet, inlineformset_factory, modelform_defines_fields,</font>
<font color="black">  32.     modelform_factory, modelformset_factory,</font>
<font color="black">  33. )</font>
<font color="green">  34. from django.forms.widgets import CheckboxSelectMultiple, SelectMultiple</font>
<font color="green">  35. from django.http import Http404, HttpResponseRedirect</font>
<font color="green">  36. from django.http.response import HttpResponseBase</font>
<font color="green">  37. from django.template.response import SimpleTemplateResponse, TemplateResponse</font>
<font color="green">  38. from django.utils import six</font>
<font color="green">  39. from django.utils.decorators import method_decorator</font>
<font color="green">  40. from django.utils.encoding import force_text, python_2_unicode_compatible</font>
<font color="green">  41. from django.utils.html import escape, escapejs</font>
<font color="green">  42. from django.utils.http import urlencode</font>
<font color="green">  43. from django.utils.safestring import mark_safe</font>
<font color="green">  44. from django.utils.text import capfirst, get_text_list</font>
<font color="green">  45. from django.utils.translation import string_concat, ugettext as _, ungettext</font>
<font color="green">  46. from django.views.decorators.csrf import csrf_protect</font>
<font color="green">  47. from django.views.generic import RedirectView</font>
<font color="black">  48. </font>
<font color="green">  49. IS_POPUP_VAR = '_popup'</font>
<font color="green">  50. TO_FIELD_VAR = '_to_field'</font>
<font color="black">  51. </font>
<font color="black">  52. </font>
<font color="green">  53. HORIZONTAL, VERTICAL = 1, 2</font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="green">  56. def get_content_type_for_model(obj):</font>
<font color="black">  57.     # Since this module gets imported in the application's root package,</font>
<font color="black">  58.     # it cannot import models from other applications at the module level.</font>
<font color="red">  59.     from django.contrib.contenttypes.models import ContentType</font>
<font color="red">  60.     return ContentType.objects.get_for_model(obj, for_concrete_model=False)</font>
<font color="black">  61. </font>
<font color="black">  62. </font>
<font color="green">  63. def get_ul_class(radio_style):</font>
<font color="red">  64.     return 'radiolist' if radio_style == VERTICAL else 'radiolist inline'</font>
<font color="black">  65. </font>
<font color="black">  66. </font>
<font color="green">  67. class IncorrectLookupParameters(Exception):</font>
<font color="green">  68.     pass</font>
<font color="black">  69. </font>
<font color="black">  70. # Defaults for formfield_overrides. ModelAdmin subclasses can change this</font>
<font color="black">  71. # by adding to ModelAdmin.formfield_overrides.</font>
<font color="black">  72. </font>
<font color="green">  73. FORMFIELD_FOR_DBFIELD_DEFAULTS = {</font>
<font color="green">  74.     models.DateTimeField: {</font>
<font color="green">  75.         'form_class': forms.SplitDateTimeField,</font>
<font color="green">  76.         'widget': widgets.AdminSplitDateTime</font>
<font color="black">  77.     },</font>
<font color="green">  78.     models.DateField: {'widget': widgets.AdminDateWidget},</font>
<font color="green">  79.     models.TimeField: {'widget': widgets.AdminTimeWidget},</font>
<font color="green">  80.     models.TextField: {'widget': widgets.AdminTextareaWidget},</font>
<font color="green">  81.     models.URLField: {'widget': widgets.AdminURLFieldWidget},</font>
<font color="green">  82.     models.IntegerField: {'widget': widgets.AdminIntegerFieldWidget},</font>
<font color="green">  83.     models.BigIntegerField: {'widget': widgets.AdminBigIntegerFieldWidget},</font>
<font color="green">  84.     models.CharField: {'widget': widgets.AdminTextInputWidget},</font>
<font color="green">  85.     models.ImageField: {'widget': widgets.AdminFileWidget},</font>
<font color="green">  86.     models.FileField: {'widget': widgets.AdminFileWidget},</font>
<font color="green">  87.     models.EmailField: {'widget': widgets.AdminEmailInputWidget},</font>
<font color="black">  88. }</font>
<font color="black">  89. </font>
<font color="green">  90. csrf_protect_m = method_decorator(csrf_protect)</font>
<font color="black">  91. </font>
<font color="black">  92. </font>
<font color="green">  93. class BaseModelAdmin(six.with_metaclass(forms.MediaDefiningClass)):</font>
<font color="green">  94.     &quot;&quot;&quot;Functionality common to both ModelAdmin and InlineAdmin.&quot;&quot;&quot;</font>
<font color="black">  95. </font>
<font color="green">  96.     raw_id_fields = ()</font>
<font color="green">  97.     fields = None</font>
<font color="green">  98.     exclude = None</font>
<font color="green">  99.     fieldsets = None</font>
<font color="green"> 100.     form = forms.ModelForm</font>
<font color="green"> 101.     filter_vertical = ()</font>
<font color="green"> 102.     filter_horizontal = ()</font>
<font color="green"> 103.     radio_fields = {}</font>
<font color="green"> 104.     prepopulated_fields = {}</font>
<font color="green"> 105.     formfield_overrides = {}</font>
<font color="green"> 106.     readonly_fields = ()</font>
<font color="green"> 107.     ordering = None</font>
<font color="green"> 108.     view_on_site = True</font>
<font color="green"> 109.     show_full_result_count = True</font>
<font color="green"> 110.     checks_class = BaseModelAdminChecks</font>
<font color="black"> 111. </font>
<font color="green"> 112.     def check(self, **kwargs):</font>
<font color="green"> 113.         return self.checks_class().check(self, **kwargs)</font>
<font color="black"> 114. </font>
<font color="green"> 115.     def __init__(self):</font>
<font color="green"> 116.         overrides = FORMFIELD_FOR_DBFIELD_DEFAULTS.copy()</font>
<font color="green"> 117.         overrides.update(self.formfield_overrides)</font>
<font color="green"> 118.         self.formfield_overrides = overrides</font>
<font color="black"> 119. </font>
<font color="green"> 120.     def formfield_for_dbfield(self, db_field, **kwargs):</font>
<font color="black"> 121.         &quot;&quot;&quot;</font>
<font color="black"> 122.         Hook for specifying the form Field instance for a given database Field</font>
<font color="black"> 123.         instance.</font>
<font color="black"> 124. </font>
<font color="black"> 125.         If kwargs are given, they're passed to the form Field's constructor.</font>
<font color="black"> 126.         &quot;&quot;&quot;</font>
<font color="red"> 127.         request = kwargs.pop(&quot;request&quot;, None)</font>
<font color="black"> 128. </font>
<font color="black"> 129.         # If the field specifies choices, we don't need to look for special</font>
<font color="black"> 130.         # admin widgets - we just need to use a select widget of some kind.</font>
<font color="red"> 131.         if db_field.choices:</font>
<font color="red"> 132.             return self.formfield_for_choice_field(db_field, request, **kwargs)</font>
<font color="black"> 133. </font>
<font color="black"> 134.         # ForeignKey or ManyToManyFields</font>
<font color="red"> 135.         if isinstance(db_field, (models.ForeignKey, models.ManyToManyField)):</font>
<font color="black"> 136.             # Combine the field kwargs with any options for formfield_overrides.</font>
<font color="black"> 137.             # Make sure the passed in **kwargs override anything in</font>
<font color="black"> 138.             # formfield_overrides because **kwargs is more specific, and should</font>
<font color="black"> 139.             # always win.</font>
<font color="red"> 140.             if db_field.__class__ in self.formfield_overrides:</font>
<font color="red"> 141.                 kwargs = dict(self.formfield_overrides[db_field.__class__], **kwargs)</font>
<font color="black"> 142. </font>
<font color="black"> 143.             # Get the correct formfield.</font>
<font color="red"> 144.             if isinstance(db_field, models.ForeignKey):</font>
<font color="red"> 145.                 formfield = self.formfield_for_foreignkey(db_field, request, **kwargs)</font>
<font color="red"> 146.             elif isinstance(db_field, models.ManyToManyField):</font>
<font color="red"> 147.                 formfield = self.formfield_for_manytomany(db_field, request, **kwargs)</font>
<font color="black"> 148. </font>
<font color="black"> 149.             # For non-raw_id fields, wrap the widget with a wrapper that adds</font>
<font color="black"> 150.             # extra HTML -- the &quot;add other&quot; interface -- to the end of the</font>
<font color="black"> 151.             # rendered output. formfield can be None if it came from a</font>
<font color="black"> 152.             # OneToOneField with parent_link=True or a M2M intermediary.</font>
<font color="red"> 153.             if formfield and db_field.name not in self.raw_id_fields:</font>
<font color="red"> 154.                 related_modeladmin = self.admin_site._registry.get(db_field.remote_field.model)</font>
<font color="red"> 155.                 wrapper_kwargs = {}</font>
<font color="red"> 156.                 if related_modeladmin:</font>
<font color="red"> 157.                     wrapper_kwargs.update(</font>
<font color="red"> 158.                         can_add_related=related_modeladmin.has_add_permission(request),</font>
<font color="red"> 159.                         can_change_related=related_modeladmin.has_change_permission(request),</font>
<font color="red"> 160.                         can_delete_related=related_modeladmin.has_delete_permission(request),</font>
<font color="black"> 161.                     )</font>
<font color="red"> 162.                 formfield.widget = widgets.RelatedFieldWidgetWrapper(</font>
<font color="red"> 163.                     formfield.widget, db_field.remote_field, self.admin_site, **wrapper_kwargs</font>
<font color="black"> 164.                 )</font>
<font color="black"> 165. </font>
<font color="red"> 166.             return formfield</font>
<font color="black"> 167. </font>
<font color="black"> 168.         # If we've got overrides for the formfield defined, use 'em. **kwargs</font>
<font color="black"> 169.         # passed to formfield_for_dbfield override the defaults.</font>
<font color="red"> 170.         for klass in db_field.__class__.mro():</font>
<font color="red"> 171.             if klass in self.formfield_overrides:</font>
<font color="red"> 172.                 kwargs = dict(copy.deepcopy(self.formfield_overrides[klass]), **kwargs)</font>
<font color="red"> 173.                 return db_field.formfield(**kwargs)</font>
<font color="black"> 174. </font>
<font color="black"> 175.         # For any other type of field, just call its formfield() method.</font>
<font color="red"> 176.         return db_field.formfield(**kwargs)</font>
<font color="black"> 177. </font>
<font color="green"> 178.     def formfield_for_choice_field(self, db_field, request=None, **kwargs):</font>
<font color="black"> 179.         &quot;&quot;&quot;</font>
<font color="black"> 180.         Get a form Field for a database Field that has declared choices.</font>
<font color="black"> 181.         &quot;&quot;&quot;</font>
<font color="black"> 182.         # If the field is named as a radio_field, use a RadioSelect</font>
<font color="red"> 183.         if db_field.name in self.radio_fields:</font>
<font color="black"> 184.             # Avoid stomping on custom widget/choices arguments.</font>
<font color="red"> 185.             if 'widget' not in kwargs:</font>
<font color="red"> 186.                 kwargs['widget'] = widgets.AdminRadioSelect(attrs={</font>
<font color="red"> 187.                     'class': get_ul_class(self.radio_fields[db_field.name]),</font>
<font color="black"> 188.                 })</font>
<font color="red"> 189.             if 'choices' not in kwargs:</font>
<font color="red"> 190.                 kwargs['choices'] = db_field.get_choices(</font>
<font color="red"> 191.                     include_blank=db_field.blank,</font>
<font color="red"> 192.                     blank_choice=[('', _('None'))]</font>
<font color="black"> 193.                 )</font>
<font color="red"> 194.         return db_field.formfield(**kwargs)</font>
<font color="black"> 195. </font>
<font color="green"> 196.     def get_field_queryset(self, db, db_field, request):</font>
<font color="black"> 197.         &quot;&quot;&quot;</font>
<font color="black"> 198.         If the ModelAdmin specifies ordering, the queryset should respect that</font>
<font color="black"> 199.         ordering.  Otherwise don't specify the queryset, let the field decide</font>
<font color="black"> 200.         (returns None in that case).</font>
<font color="black"> 201.         &quot;&quot;&quot;</font>
<font color="red"> 202.         related_admin = self.admin_site._registry.get(db_field.remote_field.model)</font>
<font color="red"> 203.         if related_admin is not None:</font>
<font color="red"> 204.             ordering = related_admin.get_ordering(request)</font>
<font color="red"> 205.             if ordering is not None and ordering != ():</font>
<font color="red"> 206.                 return db_field.remote_field.model._default_manager.using(db).order_by(*ordering)</font>
<font color="red"> 207.         return None</font>
<font color="black"> 208. </font>
<font color="green"> 209.     def formfield_for_foreignkey(self, db_field, request=None, **kwargs):</font>
<font color="black"> 210.         &quot;&quot;&quot;</font>
<font color="black"> 211.         Get a form Field for a ForeignKey.</font>
<font color="black"> 212.         &quot;&quot;&quot;</font>
<font color="red"> 213.         db = kwargs.get('using')</font>
<font color="red"> 214.         if db_field.name in self.raw_id_fields:</font>
<font color="red"> 215.             kwargs['widget'] = widgets.ForeignKeyRawIdWidget(db_field.remote_field,</font>
<font color="red"> 216.                                     self.admin_site, using=db)</font>
<font color="red"> 217.         elif db_field.name in self.radio_fields:</font>
<font color="red"> 218.             kwargs['widget'] = widgets.AdminRadioSelect(attrs={</font>
<font color="red"> 219.                 'class': get_ul_class(self.radio_fields[db_field.name]),</font>
<font color="black"> 220.             })</font>
<font color="red"> 221.             kwargs['empty_label'] = _('None') if db_field.blank else None</font>
<font color="black"> 222. </font>
<font color="red"> 223.         if 'queryset' not in kwargs:</font>
<font color="red"> 224.             queryset = self.get_field_queryset(db, db_field, request)</font>
<font color="red"> 225.             if queryset is not None:</font>
<font color="red"> 226.                 kwargs['queryset'] = queryset</font>
<font color="black"> 227. </font>
<font color="red"> 228.         return db_field.formfield(**kwargs)</font>
<font color="black"> 229. </font>
<font color="green"> 230.     def formfield_for_manytomany(self, db_field, request=None, **kwargs):</font>
<font color="black"> 231.         &quot;&quot;&quot;</font>
<font color="black"> 232.         Get a form Field for a ManyToManyField.</font>
<font color="black"> 233.         &quot;&quot;&quot;</font>
<font color="black"> 234.         # If it uses an intermediary model that isn't auto created, don't show</font>
<font color="black"> 235.         # a field in admin.</font>
<font color="red"> 236.         if not db_field.remote_field.through._meta.auto_created:</font>
<font color="red"> 237.             return None</font>
<font color="red"> 238.         db = kwargs.get('using')</font>
<font color="black"> 239. </font>
<font color="red"> 240.         if db_field.name in self.raw_id_fields:</font>
<font color="red"> 241.             kwargs['widget'] = widgets.ManyToManyRawIdWidget(db_field.remote_field,</font>
<font color="red"> 242.                                     self.admin_site, using=db)</font>
<font color="red"> 243.             kwargs['help_text'] = ''</font>
<font color="red"> 244.         elif db_field.name in (list(self.filter_vertical) + list(self.filter_horizontal)):</font>
<font color="red"> 245.             kwargs['widget'] = widgets.FilteredSelectMultiple(</font>
<font color="red"> 246.                 db_field.verbose_name,</font>
<font color="red"> 247.                 db_field.name in self.filter_vertical</font>
<font color="black"> 248.             )</font>
<font color="black"> 249. </font>
<font color="red"> 250.         if 'queryset' not in kwargs:</font>
<font color="red"> 251.             queryset = self.get_field_queryset(db, db_field, request)</font>
<font color="red"> 252.             if queryset is not None:</font>
<font color="red"> 253.                 kwargs['queryset'] = queryset</font>
<font color="black"> 254. </font>
<font color="red"> 255.         form_field = db_field.formfield(**kwargs)</font>
<font color="red"> 256.         if isinstance(form_field.widget, SelectMultiple) and not isinstance(form_field.widget, CheckboxSelectMultiple):</font>
<font color="red"> 257.             msg = _('Hold down &quot;Control&quot;, or &quot;Command&quot; on a Mac, to select more than one.')</font>
<font color="red"> 258.             help_text = form_field.help_text</font>
<font color="red"> 259.             form_field.help_text = string_concat(help_text, ' ', msg) if help_text else msg</font>
<font color="red"> 260.         return form_field</font>
<font color="black"> 261. </font>
<font color="green"> 262.     def get_view_on_site_url(self, obj=None):</font>
<font color="red"> 263.         if obj is None or not self.view_on_site:</font>
<font color="red"> 264.             return None</font>
<font color="black"> 265. </font>
<font color="red"> 266.         if callable(self.view_on_site):</font>
<font color="red"> 267.             return self.view_on_site(obj)</font>
<font color="red"> 268.         elif self.view_on_site and hasattr(obj, 'get_absolute_url'):</font>
<font color="black"> 269.             # use the ContentType lookup if view_on_site is True</font>
<font color="red"> 270.             return reverse('admin:view_on_site', kwargs={</font>
<font color="red"> 271.                 'content_type_id': get_content_type_for_model(obj).pk,</font>
<font color="red"> 272.                 'object_id': obj.pk</font>
<font color="black"> 273.             })</font>
<font color="black"> 274. </font>
<font color="green"> 275.     def get_empty_value_display(self):</font>
<font color="black"> 276.         &quot;&quot;&quot;</font>
<font color="black"> 277.         Return the empty_value_display set on ModelAdmin or AdminSite.</font>
<font color="black"> 278.         &quot;&quot;&quot;</font>
<font color="red"> 279.         try:</font>
<font color="red"> 280.             return mark_safe(self.empty_value_display)</font>
<font color="red"> 281.         except AttributeError:</font>
<font color="red"> 282.             return mark_safe(self.admin_site.empty_value_display)</font>
<font color="black"> 283. </font>
<font color="green"> 284.     def get_fields(self, request, obj=None):</font>
<font color="black"> 285.         &quot;&quot;&quot;</font>
<font color="black"> 286.         Hook for specifying fields.</font>
<font color="black"> 287.         &quot;&quot;&quot;</font>
<font color="red"> 288.         return self.fields</font>
<font color="black"> 289. </font>
<font color="green"> 290.     def get_fieldsets(self, request, obj=None):</font>
<font color="black"> 291.         &quot;&quot;&quot;</font>
<font color="black"> 292.         Hook for specifying fieldsets.</font>
<font color="black"> 293.         &quot;&quot;&quot;</font>
<font color="red"> 294.         if self.fieldsets:</font>
<font color="red"> 295.             return self.fieldsets</font>
<font color="red"> 296.         return [(None, {'fields': self.get_fields(request, obj)})]</font>
<font color="black"> 297. </font>
<font color="green"> 298.     def get_ordering(self, request):</font>
<font color="black"> 299.         &quot;&quot;&quot;</font>
<font color="black"> 300.         Hook for specifying field ordering.</font>
<font color="black"> 301.         &quot;&quot;&quot;</font>
<font color="red"> 302.         return self.ordering or ()  # otherwise we might try to *None, which is bad ;)</font>
<font color="black"> 303. </font>
<font color="green"> 304.     def get_readonly_fields(self, request, obj=None):</font>
<font color="black"> 305.         &quot;&quot;&quot;</font>
<font color="black"> 306.         Hook for specifying custom readonly fields.</font>
<font color="black"> 307.         &quot;&quot;&quot;</font>
<font color="red"> 308.         return self.readonly_fields</font>
<font color="black"> 309. </font>
<font color="green"> 310.     def get_prepopulated_fields(self, request, obj=None):</font>
<font color="black"> 311.         &quot;&quot;&quot;</font>
<font color="black"> 312.         Hook for specifying custom prepopulated fields.</font>
<font color="black"> 313.         &quot;&quot;&quot;</font>
<font color="red"> 314.         return self.prepopulated_fields</font>
<font color="black"> 315. </font>
<font color="green"> 316.     def get_queryset(self, request):</font>
<font color="black"> 317.         &quot;&quot;&quot;</font>
<font color="black"> 318.         Returns a QuerySet of all model instances that can be edited by the</font>
<font color="black"> 319.         admin site. This is used by changelist_view.</font>
<font color="black"> 320.         &quot;&quot;&quot;</font>
<font color="red"> 321.         qs = self.model._default_manager.get_queryset()</font>
<font color="black"> 322.         # TODO: this should be handled by some parameter to the ChangeList.</font>
<font color="red"> 323.         ordering = self.get_ordering(request)</font>
<font color="red"> 324.         if ordering:</font>
<font color="red"> 325.             qs = qs.order_by(*ordering)</font>
<font color="red"> 326.         return qs</font>
<font color="black"> 327. </font>
<font color="green"> 328.     def lookup_allowed(self, lookup, value):</font>
<font color="red"> 329.         from django.contrib.admin.filters import SimpleListFilter</font>
<font color="black"> 330. </font>
<font color="red"> 331.         model = self.model</font>
<font color="black"> 332.         # Check FKey lookups that are allowed, so that popups produced by</font>
<font color="black"> 333.         # ForeignKeyRawIdWidget, on the basis of ForeignKey.limit_choices_to,</font>
<font color="black"> 334.         # are allowed to work.</font>
<font color="red"> 335.         for l in model._meta.related_fkey_lookups:</font>
<font color="black"> 336.             # As ``limit_choices_to`` can be a callable, invoke it here.</font>
<font color="red"> 337.             if callable(l):</font>
<font color="red"> 338.                 l = l()</font>
<font color="red"> 339.             for k, v in widgets.url_params_from_lookup_dict(l).items():</font>
<font color="red"> 340.                 if k == lookup and v == value:</font>
<font color="red"> 341.                     return True</font>
<font color="black"> 342. </font>
<font color="red"> 343.         relation_parts = []</font>
<font color="red"> 344.         prev_field = None</font>
<font color="red"> 345.         for part in lookup.split(LOOKUP_SEP):</font>
<font color="red"> 346.             try:</font>
<font color="red"> 347.                 field = model._meta.get_field(part)</font>
<font color="red"> 348.             except FieldDoesNotExist:</font>
<font color="black"> 349.                 # Lookups on non-existent fields are ok, since they're ignored</font>
<font color="black"> 350.                 # later.</font>
<font color="red"> 351.                 break</font>
<font color="black"> 352.             # It is allowed to filter on values that would be found from local</font>
<font color="black"> 353.             # model anyways. For example, if you filter on employee__department__id,</font>
<font color="black"> 354.             # then the id value would be found already from employee__department_id.</font>
<font color="red"> 355.             if not prev_field or (prev_field.concrete and</font>
<font color="red"> 356.                                   field not in prev_field.get_path_info()[-1].target_fields):</font>
<font color="red"> 357.                 relation_parts.append(part)</font>
<font color="red"> 358.             if not getattr(field, 'get_path_info', None):</font>
<font color="black"> 359.                 # This is not a relational field, so further parts</font>
<font color="black"> 360.                 # must be transforms.</font>
<font color="red"> 361.                 break</font>
<font color="red"> 362.             prev_field = field</font>
<font color="red"> 363.             model = field.get_path_info()[-1].to_opts.model</font>
<font color="black"> 364. </font>
<font color="red"> 365.         if len(relation_parts) &lt;= 1:</font>
<font color="black"> 366.             # Either a local field filter, or no fields at all.</font>
<font color="red"> 367.             return True</font>
<font color="red"> 368.         clean_lookup = LOOKUP_SEP.join(relation_parts)</font>
<font color="red"> 369.         valid_lookups = [self.date_hierarchy]</font>
<font color="red"> 370.         for filter_item in self.list_filter:</font>
<font color="red"> 371.             if isinstance(filter_item, type) and issubclass(filter_item, SimpleListFilter):</font>
<font color="red"> 372.                 valid_lookups.append(filter_item.parameter_name)</font>
<font color="red"> 373.             elif isinstance(filter_item, (list, tuple)):</font>
<font color="red"> 374.                 valid_lookups.append(filter_item[0])</font>
<font color="black"> 375.             else:</font>
<font color="red"> 376.                 valid_lookups.append(filter_item)</font>
<font color="red"> 377.         return clean_lookup in valid_lookups</font>
<font color="black"> 378. </font>
<font color="green"> 379.     def to_field_allowed(self, request, to_field):</font>
<font color="black"> 380.         &quot;&quot;&quot;</font>
<font color="black"> 381.         Returns True if the model associated with this admin should be</font>
<font color="black"> 382.         allowed to be referenced by the specified field.</font>
<font color="black"> 383.         &quot;&quot;&quot;</font>
<font color="red"> 384.         opts = self.model._meta</font>
<font color="black"> 385. </font>
<font color="red"> 386.         try:</font>
<font color="red"> 387.             field = opts.get_field(to_field)</font>
<font color="red"> 388.         except FieldDoesNotExist:</font>
<font color="red"> 389.             return False</font>
<font color="black"> 390. </font>
<font color="black"> 391.         # Always allow referencing the primary key since it's already possible</font>
<font color="black"> 392.         # to get this information from the change view URL.</font>
<font color="red"> 393.         if field.primary_key:</font>
<font color="red"> 394.             return True</font>
<font color="black"> 395. </font>
<font color="black"> 396.         # Allow reverse relationships to models defining m2m fields if they</font>
<font color="black"> 397.         # target the specified field.</font>
<font color="red"> 398.         for many_to_many in opts.many_to_many:</font>
<font color="red"> 399.             if many_to_many.m2m_target_field_name() == to_field:</font>
<font color="red"> 400.                 return True</font>
<font color="black"> 401. </font>
<font color="black"> 402.         # Make sure at least one of the models registered for this site</font>
<font color="black"> 403.         # references this field through a FK or a M2M relationship.</font>
<font color="red"> 404.         registered_models = set()</font>
<font color="red"> 405.         for model, admin in self.admin_site._registry.items():</font>
<font color="red"> 406.             registered_models.add(model)</font>
<font color="red"> 407.             for inline in admin.inlines:</font>
<font color="red"> 408.                 registered_models.add(inline.model)</font>
<font color="black"> 409. </font>
<font color="black"> 410.         related_objects = (</font>
<font color="red"> 411.             f for f in opts.get_fields(include_hidden=True)</font>
<font color="red"> 412.             if (f.auto_created and not f.concrete)</font>
<font color="black"> 413.         )</font>
<font color="red"> 414.         for related_object in related_objects:</font>
<font color="red"> 415.             related_model = related_object.related_model</font>
<font color="red"> 416.             remote_field = related_object.field.remote_field</font>
<font color="red"> 417.             if (any(issubclass(model, related_model) for model in registered_models) and</font>
<font color="red"> 418.                     hasattr(remote_field, 'get_related_field') and</font>
<font color="red"> 419.                     remote_field.get_related_field() == field):</font>
<font color="red"> 420.                 return True</font>
<font color="black"> 421. </font>
<font color="red"> 422.         return False</font>
<font color="black"> 423. </font>
<font color="green"> 424.     def has_add_permission(self, request):</font>
<font color="black"> 425.         &quot;&quot;&quot;</font>
<font color="black"> 426.         Returns True if the given request has permission to add an object.</font>
<font color="black"> 427.         Can be overridden by the user in subclasses.</font>
<font color="black"> 428.         &quot;&quot;&quot;</font>
<font color="red"> 429.         opts = self.opts</font>
<font color="red"> 430.         codename = get_permission_codename('add', opts)</font>
<font color="red"> 431.         return request.user.has_perm(&quot;%s.%s&quot; % (opts.app_label, codename))</font>
<font color="black"> 432. </font>
<font color="green"> 433.     def has_change_permission(self, request, obj=None):</font>
<font color="black"> 434.         &quot;&quot;&quot;</font>
<font color="black"> 435.         Returns True if the given request has permission to change the given</font>
<font color="black"> 436.         Django model instance, the default implementation doesn't examine the</font>
<font color="black"> 437.         `obj` parameter.</font>
<font color="black"> 438. </font>
<font color="black"> 439.         Can be overridden by the user in subclasses. In such case it should</font>
<font color="black"> 440.         return True if the given request has permission to change the `obj`</font>
<font color="black"> 441.         model instance. If `obj` is None, this should return True if the given</font>
<font color="black"> 442.         request has permission to change *any* object of the given type.</font>
<font color="black"> 443.         &quot;&quot;&quot;</font>
<font color="red"> 444.         opts = self.opts</font>
<font color="red"> 445.         codename = get_permission_codename('change', opts)</font>
<font color="red"> 446.         return request.user.has_perm(&quot;%s.%s&quot; % (opts.app_label, codename))</font>
<font color="black"> 447. </font>
<font color="green"> 448.     def has_delete_permission(self, request, obj=None):</font>
<font color="black"> 449.         &quot;&quot;&quot;</font>
<font color="black"> 450.         Returns True if the given request has permission to change the given</font>
<font color="black"> 451.         Django model instance, the default implementation doesn't examine the</font>
<font color="black"> 452.         `obj` parameter.</font>
<font color="black"> 453. </font>
<font color="black"> 454.         Can be overridden by the user in subclasses. In such case it should</font>
<font color="black"> 455.         return True if the given request has permission to delete the `obj`</font>
<font color="black"> 456.         model instance. If `obj` is None, this should return True if the given</font>
<font color="black"> 457.         request has permission to delete *any* object of the given type.</font>
<font color="black"> 458.         &quot;&quot;&quot;</font>
<font color="red"> 459.         opts = self.opts</font>
<font color="red"> 460.         codename = get_permission_codename('delete', opts)</font>
<font color="red"> 461.         return request.user.has_perm(&quot;%s.%s&quot; % (opts.app_label, codename))</font>
<font color="black"> 462. </font>
<font color="green"> 463.     def has_module_permission(self, request):</font>
<font color="black"> 464.         &quot;&quot;&quot;</font>
<font color="black"> 465.         Returns True if the given request has any permission in the given</font>
<font color="black"> 466.         app label.</font>
<font color="black"> 467. </font>
<font color="black"> 468.         Can be overridden by the user in subclasses. In such case it should</font>
<font color="black"> 469.         return True if the given request has permission to view the module on</font>
<font color="black"> 470.         the admin index page and access the module's index page. Overriding it</font>
<font color="black"> 471.         does not restrict access to the add, change or delete views. Use</font>
<font color="black"> 472.         `ModelAdmin.has_(add|change|delete)_permission` for that.</font>
<font color="black"> 473.         &quot;&quot;&quot;</font>
<font color="red"> 474.         return request.user.has_module_perms(self.opts.app_label)</font>
<font color="black"> 475. </font>
<font color="black"> 476. </font>
<font color="green"> 477. @python_2_unicode_compatible</font>
<font color="green"> 478. class ModelAdmin(BaseModelAdmin):</font>
<font color="green"> 479.     &quot;Encapsulates all admin options and functionality for a given model.&quot;</font>
<font color="black"> 480. </font>
<font color="green"> 481.     list_display = ('__str__',)</font>
<font color="green"> 482.     list_display_links = ()</font>
<font color="green"> 483.     list_filter = ()</font>
<font color="green"> 484.     list_select_related = False</font>
<font color="green"> 485.     list_per_page = 100</font>
<font color="green"> 486.     list_max_show_all = 200</font>
<font color="green"> 487.     list_editable = ()</font>
<font color="green"> 488.     search_fields = ()</font>
<font color="green"> 489.     date_hierarchy = None</font>
<font color="green"> 490.     save_as = False</font>
<font color="green"> 491.     save_on_top = False</font>
<font color="green"> 492.     paginator = Paginator</font>
<font color="green"> 493.     preserve_filters = True</font>
<font color="green"> 494.     inlines = []</font>
<font color="black"> 495. </font>
<font color="black"> 496.     # Custom templates (designed to be over-ridden in subclasses)</font>
<font color="green"> 497.     add_form_template = None</font>
<font color="green"> 498.     change_form_template = None</font>
<font color="green"> 499.     change_list_template = None</font>
<font color="green"> 500.     delete_confirmation_template = None</font>
<font color="green"> 501.     delete_selected_confirmation_template = None</font>
<font color="green"> 502.     object_history_template = None</font>
<font color="black"> 503. </font>
<font color="black"> 504.     # Actions</font>
<font color="green"> 505.     actions = []</font>
<font color="green"> 506.     action_form = helpers.ActionForm</font>
<font color="green"> 507.     actions_on_top = True</font>
<font color="green"> 508.     actions_on_bottom = False</font>
<font color="green"> 509.     actions_selection_counter = True</font>
<font color="green"> 510.     checks_class = ModelAdminChecks</font>
<font color="black"> 511. </font>
<font color="green"> 512.     def __init__(self, model, admin_site):</font>
<font color="green"> 513.         self.model = model</font>
<font color="green"> 514.         self.opts = model._meta</font>
<font color="green"> 515.         self.admin_site = admin_site</font>
<font color="green"> 516.         super(ModelAdmin, self).__init__()</font>
<font color="black"> 517. </font>
<font color="green"> 518.     def __str__(self):</font>
<font color="red"> 519.         return &quot;%s.%s&quot; % (self.model._meta.app_label, self.__class__.__name__)</font>
<font color="black"> 520. </font>
<font color="green"> 521.     def get_inline_instances(self, request, obj=None):</font>
<font color="red"> 522.         inline_instances = []</font>
<font color="red"> 523.         for inline_class in self.inlines:</font>
<font color="red"> 524.             inline = inline_class(self.model, self.admin_site)</font>
<font color="red"> 525.             if request:</font>
<font color="red"> 526.                 if not (inline.has_add_permission(request) or</font>
<font color="red"> 527.                         inline.has_change_permission(request, obj) or</font>
<font color="red"> 528.                         inline.has_delete_permission(request, obj)):</font>
<font color="red"> 529.                     continue</font>
<font color="red"> 530.                 if not inline.has_add_permission(request):</font>
<font color="red"> 531.                     inline.max_num = 0</font>
<font color="red"> 532.             inline_instances.append(inline)</font>
<font color="black"> 533. </font>
<font color="red"> 534.         return inline_instances</font>
<font color="black"> 535. </font>
<font color="green"> 536.     def get_urls(self):</font>
<font color="red"> 537.         from django.conf.urls import url</font>
<font color="black"> 538. </font>
<font color="red"> 539.         def wrap(view):</font>
<font color="red"> 540.             def wrapper(*args, **kwargs):</font>
<font color="red"> 541.                 return self.admin_site.admin_view(view)(*args, **kwargs)</font>
<font color="red"> 542.             wrapper.model_admin = self</font>
<font color="red"> 543.             return update_wrapper(wrapper, view)</font>
<font color="black"> 544. </font>
<font color="red"> 545.         info = self.model._meta.app_label, self.model._meta.model_name</font>
<font color="black"> 546. </font>
<font color="black"> 547.         urlpatterns = [</font>
<font color="red"> 548.             url(r'^$', wrap(self.changelist_view), name='%s_%s_changelist' % info),</font>
<font color="red"> 549.             url(r'^add/$', wrap(self.add_view), name='%s_%s_add' % info),</font>
<font color="red"> 550.             url(r'^(.+)/history/$', wrap(self.history_view), name='%s_%s_history' % info),</font>
<font color="red"> 551.             url(r'^(.+)/delete/$', wrap(self.delete_view), name='%s_%s_delete' % info),</font>
<font color="red"> 552.             url(r'^(.+)/change/$', wrap(self.change_view), name='%s_%s_change' % info),</font>
<font color="black"> 553.             # For backwards compatibility (was the change url before 1.9)</font>
<font color="red"> 554.             url(r'^(.+)/$', wrap(RedirectView.as_view(</font>
<font color="red"> 555.                 pattern_name='%s:%s_%s_change' % ((self.admin_site.name,) + info)</font>
<font color="black"> 556.             ))),</font>
<font color="black"> 557.         ]</font>
<font color="red"> 558.         return urlpatterns</font>
<font color="black"> 559. </font>
<font color="green"> 560.     def urls(self):</font>
<font color="red"> 561.         return self.get_urls()</font>
<font color="green"> 562.     urls = property(urls)</font>
<font color="black"> 563. </font>
<font color="green"> 564.     @property</font>
<font color="black"> 565.     def media(self):</font>
<font color="red"> 566.         extra = '' if settings.DEBUG else '.min'</font>
<font color="black"> 567.         js = [</font>
<font color="red"> 568.             'core.js',</font>
<font color="red"> 569.             'admin/RelatedObjectLookups.js',</font>
<font color="red"> 570.             'vendor/jquery/jquery%s.js' % extra,</font>
<font color="red"> 571.             'jquery.init.js',</font>
<font color="red"> 572.             'actions%s.js' % extra,</font>
<font color="red"> 573.             'urlify.js',</font>
<font color="red"> 574.             'prepopulate%s.js' % extra,</font>
<font color="red"> 575.             'vendor/xregexp/xregexp.min.js',</font>
<font color="black"> 576.         ]</font>
<font color="red"> 577.         return forms.Media(js=[static('admin/js/%s' % url) for url in js])</font>
<font color="black"> 578. </font>
<font color="green"> 579.     def get_model_perms(self, request):</font>
<font color="black"> 580.         &quot;&quot;&quot;</font>
<font color="black"> 581.         Returns a dict of all perms for this model. This dict has the keys</font>
<font color="black"> 582.         ``add``, ``change``, and ``delete`` mapping to the True/False for each</font>
<font color="black"> 583.         of those actions.</font>
<font color="black"> 584.         &quot;&quot;&quot;</font>
<font color="red"> 585.         return {</font>
<font color="red"> 586.             'add': self.has_add_permission(request),</font>
<font color="red"> 587.             'change': self.has_change_permission(request),</font>
<font color="red"> 588.             'delete': self.has_delete_permission(request),</font>
<font color="black"> 589.         }</font>
<font color="black"> 590. </font>
<font color="green"> 591.     def get_fields(self, request, obj=None):</font>
<font color="red"> 592.         if self.fields:</font>
<font color="red"> 593.             return self.fields</font>
<font color="red"> 594.         form = self.get_form(request, obj, fields=None)</font>
<font color="red"> 595.         return list(form.base_fields) + list(self.get_readonly_fields(request, obj))</font>
<font color="black"> 596. </font>
<font color="green"> 597.     def get_form(self, request, obj=None, **kwargs):</font>
<font color="black"> 598.         &quot;&quot;&quot;</font>
<font color="black"> 599.         Returns a Form class for use in the admin add view. This is used by</font>
<font color="black"> 600.         add_view and change_view.</font>
<font color="black"> 601.         &quot;&quot;&quot;</font>
<font color="red"> 602.         if 'fields' in kwargs:</font>
<font color="red"> 603.             fields = kwargs.pop('fields')</font>
<font color="black"> 604.         else:</font>
<font color="red"> 605.             fields = flatten_fieldsets(self.get_fieldsets(request, obj))</font>
<font color="red"> 606.         if self.exclude is None:</font>
<font color="red"> 607.             exclude = []</font>
<font color="black"> 608.         else:</font>
<font color="red"> 609.             exclude = list(self.exclude)</font>
<font color="red"> 610.         readonly_fields = self.get_readonly_fields(request, obj)</font>
<font color="red"> 611.         exclude.extend(readonly_fields)</font>
<font color="red"> 612.         if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:</font>
<font color="black"> 613.             # Take the custom ModelForm's Meta.exclude into account only if the</font>
<font color="black"> 614.             # ModelAdmin doesn't define its own.</font>
<font color="red"> 615.             exclude.extend(self.form._meta.exclude)</font>
<font color="black"> 616.         # if exclude is an empty list we pass None to be consistent with the</font>
<font color="black"> 617.         # default on modelform_factory</font>
<font color="red"> 618.         exclude = exclude or None</font>
<font color="black"> 619. </font>
<font color="black"> 620.         # Remove declared form fields which are in readonly_fields.</font>
<font color="red"> 621.         new_attrs = OrderedDict(</font>
<font color="red"> 622.             (f, None) for f in readonly_fields</font>
<font color="red"> 623.             if f in self.form.declared_fields</font>
<font color="black"> 624.         )</font>
<font color="red"> 625.         form = type(self.form.__name__, (self.form,), new_attrs)</font>
<font color="black"> 626. </font>
<font color="red"> 627.         defaults = {</font>
<font color="red"> 628.             &quot;form&quot;: form,</font>
<font color="red"> 629.             &quot;fields&quot;: fields,</font>
<font color="red"> 630.             &quot;exclude&quot;: exclude,</font>
<font color="red"> 631.             &quot;formfield_callback&quot;: partial(self.formfield_for_dbfield, request=request),</font>
<font color="black"> 632.         }</font>
<font color="red"> 633.         defaults.update(kwargs)</font>
<font color="black"> 634. </font>
<font color="red"> 635.         if defaults['fields'] is None and not modelform_defines_fields(defaults['form']):</font>
<font color="red"> 636.             defaults['fields'] = forms.ALL_FIELDS</font>
<font color="black"> 637. </font>
<font color="red"> 638.         try:</font>
<font color="red"> 639.             return modelform_factory(self.model, **defaults)</font>
<font color="red"> 640.         except FieldError as e:</font>
<font color="red"> 641.             raise FieldError('%s. Check fields/fieldsets/exclude attributes of class %s.'</font>
<font color="red"> 642.                              % (e, self.__class__.__name__))</font>
<font color="black"> 643. </font>
<font color="green"> 644.     def get_changelist(self, request, **kwargs):</font>
<font color="black"> 645.         &quot;&quot;&quot;</font>
<font color="black"> 646.         Returns the ChangeList class for use on the changelist page.</font>
<font color="black"> 647.         &quot;&quot;&quot;</font>
<font color="red"> 648.         from django.contrib.admin.views.main import ChangeList</font>
<font color="red"> 649.         return ChangeList</font>
<font color="black"> 650. </font>
<font color="green"> 651.     def get_object(self, request, object_id, from_field=None):</font>
<font color="black"> 652.         &quot;&quot;&quot;</font>
<font color="black"> 653.         Returns an instance matching the field and value provided, the primary</font>
<font color="black"> 654.         key is used if no field is provided. Returns ``None`` if no match is</font>
<font color="black"> 655.         found or the object_id fails validation.</font>
<font color="black"> 656.         &quot;&quot;&quot;</font>
<font color="red"> 657.         queryset = self.get_queryset(request)</font>
<font color="red"> 658.         model = queryset.model</font>
<font color="red"> 659.         field = model._meta.pk if from_field is None else model._meta.get_field(from_field)</font>
<font color="red"> 660.         try:</font>
<font color="red"> 661.             object_id = field.to_python(object_id)</font>
<font color="red"> 662.             return queryset.get(**{field.name: object_id})</font>
<font color="red"> 663.         except (model.DoesNotExist, ValidationError, ValueError):</font>
<font color="red"> 664.             return None</font>
<font color="black"> 665. </font>
<font color="green"> 666.     def get_changelist_form(self, request, **kwargs):</font>
<font color="black"> 667.         &quot;&quot;&quot;</font>
<font color="black"> 668.         Returns a Form class for use in the Formset on the changelist page.</font>
<font color="black"> 669.         &quot;&quot;&quot;</font>
<font color="red"> 670.         defaults = {</font>
<font color="red"> 671.             &quot;formfield_callback&quot;: partial(self.formfield_for_dbfield, request=request),</font>
<font color="black"> 672.         }</font>
<font color="red"> 673.         defaults.update(kwargs)</font>
<font color="red"> 674.         if (defaults.get('fields') is None</font>
<font color="red"> 675.                 and not modelform_defines_fields(defaults.get('form'))):</font>
<font color="red"> 676.             defaults['fields'] = forms.ALL_FIELDS</font>
<font color="black"> 677. </font>
<font color="red"> 678.         return modelform_factory(self.model, **defaults)</font>
<font color="black"> 679. </font>
<font color="green"> 680.     def get_changelist_formset(self, request, **kwargs):</font>
<font color="black"> 681.         &quot;&quot;&quot;</font>
<font color="black"> 682.         Returns a FormSet class for use on the changelist page if list_editable</font>
<font color="black"> 683.         is used.</font>
<font color="black"> 684.         &quot;&quot;&quot;</font>
<font color="red"> 685.         defaults = {</font>
<font color="red"> 686.             &quot;formfield_callback&quot;: partial(self.formfield_for_dbfield, request=request),</font>
<font color="black"> 687.         }</font>
<font color="red"> 688.         defaults.update(kwargs)</font>
<font color="red"> 689.         return modelformset_factory(self.model,</font>
<font color="red"> 690.             self.get_changelist_form(request), extra=0,</font>
<font color="red"> 691.             fields=self.list_editable, **defaults)</font>
<font color="black"> 692. </font>
<font color="green"> 693.     def get_formsets_with_inlines(self, request, obj=None):</font>
<font color="black"> 694.         &quot;&quot;&quot;</font>
<font color="black"> 695.         Yields formsets and the corresponding inlines.</font>
<font color="black"> 696.         &quot;&quot;&quot;</font>
<font color="red"> 697.         for inline in self.get_inline_instances(request, obj):</font>
<font color="red"> 698.             yield inline.get_formset(request, obj), inline</font>
<font color="black"> 699. </font>
<font color="green"> 700.     def get_paginator(self, request, queryset, per_page, orphans=0, allow_empty_first_page=True):</font>
<font color="red"> 701.         return self.paginator(queryset, per_page, orphans, allow_empty_first_page)</font>
<font color="black"> 702. </font>
<font color="green"> 703.     def log_addition(self, request, object, message):</font>
<font color="black"> 704.         &quot;&quot;&quot;</font>
<font color="black"> 705.         Log that an object has been successfully added.</font>
<font color="black"> 706. </font>
<font color="black"> 707.         The default implementation creates an admin LogEntry object.</font>
<font color="black"> 708.         &quot;&quot;&quot;</font>
<font color="red"> 709.         from django.contrib.admin.models import LogEntry, ADDITION</font>
<font color="red"> 710.         LogEntry.objects.log_action(</font>
<font color="red"> 711.             user_id=request.user.pk,</font>
<font color="red"> 712.             content_type_id=get_content_type_for_model(object).pk,</font>
<font color="red"> 713.             object_id=object.pk,</font>
<font color="red"> 714.             object_repr=force_text(object),</font>
<font color="red"> 715.             action_flag=ADDITION,</font>
<font color="red"> 716.             change_message=message,</font>
<font color="black"> 717.         )</font>
<font color="black"> 718. </font>
<font color="green"> 719.     def log_change(self, request, object, message):</font>
<font color="black"> 720.         &quot;&quot;&quot;</font>
<font color="black"> 721.         Log that an object has been successfully changed.</font>
<font color="black"> 722. </font>
<font color="black"> 723.         The default implementation creates an admin LogEntry object.</font>
<font color="black"> 724.         &quot;&quot;&quot;</font>
<font color="red"> 725.         from django.contrib.admin.models import LogEntry, CHANGE</font>
<font color="red"> 726.         LogEntry.objects.log_action(</font>
<font color="red"> 727.             user_id=request.user.pk,</font>
<font color="red"> 728.             content_type_id=get_content_type_for_model(object).pk,</font>
<font color="red"> 729.             object_id=object.pk,</font>
<font color="red"> 730.             object_repr=force_text(object),</font>
<font color="red"> 731.             action_flag=CHANGE,</font>
<font color="red"> 732.             change_message=message,</font>
<font color="black"> 733.         )</font>
<font color="black"> 734. </font>
<font color="green"> 735.     def log_deletion(self, request, object, object_repr):</font>
<font color="black"> 736.         &quot;&quot;&quot;</font>
<font color="black"> 737.         Log that an object will be deleted. Note that this method must be</font>
<font color="black"> 738.         called before the deletion.</font>
<font color="black"> 739. </font>
<font color="black"> 740.         The default implementation creates an admin LogEntry object.</font>
<font color="black"> 741.         &quot;&quot;&quot;</font>
<font color="red"> 742.         from django.contrib.admin.models import LogEntry, DELETION</font>
<font color="red"> 743.         LogEntry.objects.log_action(</font>
<font color="red"> 744.             user_id=request.user.pk,</font>
<font color="red"> 745.             content_type_id=get_content_type_for_model(object).pk,</font>
<font color="red"> 746.             object_id=object.pk,</font>
<font color="red"> 747.             object_repr=object_repr,</font>
<font color="red"> 748.             action_flag=DELETION,</font>
<font color="black"> 749.         )</font>
<font color="black"> 750. </font>
<font color="green"> 751.     def action_checkbox(self, obj):</font>
<font color="black"> 752.         &quot;&quot;&quot;</font>
<font color="black"> 753.         A list_display column containing a checkbox widget.</font>
<font color="black"> 754.         &quot;&quot;&quot;</font>
<font color="red"> 755.         return helpers.checkbox.render(helpers.ACTION_CHECKBOX_NAME, force_text(obj.pk))</font>
<font color="green"> 756.     action_checkbox.short_description = mark_safe('&lt;input type=&quot;checkbox&quot; id=&quot;action-toggle&quot; /&gt;')</font>
<font color="black"> 757. </font>
<font color="green"> 758.     def get_actions(self, request):</font>
<font color="black"> 759.         &quot;&quot;&quot;</font>
<font color="black"> 760.         Return a dictionary mapping the names of all actions for this</font>
<font color="black"> 761.         ModelAdmin to a tuple of (callable, name, description) for each action.</font>
<font color="black"> 762.         &quot;&quot;&quot;</font>
<font color="black"> 763.         # If self.actions is explicitly set to None that means that we don't</font>
<font color="black"> 764.         # want *any* actions enabled on this page.</font>
<font color="red"> 765.         if self.actions is None or IS_POPUP_VAR in request.GET:</font>
<font color="red"> 766.             return OrderedDict()</font>
<font color="black"> 767. </font>
<font color="red"> 768.         actions = []</font>
<font color="black"> 769. </font>
<font color="black"> 770.         # Gather actions from the admin site first</font>
<font color="red"> 771.         for (name, func) in self.admin_site.actions:</font>
<font color="red"> 772.             description = getattr(func, 'short_description', name.replace('_', ' '))</font>
<font color="red"> 773.             actions.append((func, name, description))</font>
<font color="black"> 774. </font>
<font color="black"> 775.         # Then gather them from the model admin and all parent classes,</font>
<font color="black"> 776.         # starting with self and working back up.</font>
<font color="red"> 777.         for klass in self.__class__.mro()[::-1]:</font>
<font color="red"> 778.             class_actions = getattr(klass, 'actions', [])</font>
<font color="black"> 779.             # Avoid trying to iterate over None</font>
<font color="red"> 780.             if not class_actions:</font>
<font color="red"> 781.                 continue</font>
<font color="red"> 782.             actions.extend(self.get_action(action) for action in class_actions)</font>
<font color="black"> 783. </font>
<font color="black"> 784.         # get_action might have returned None, so filter any of those out.</font>
<font color="red"> 785.         actions = filter(None, actions)</font>
<font color="black"> 786. </font>
<font color="black"> 787.         # Convert the actions into an OrderedDict keyed by name.</font>
<font color="red"> 788.         actions = OrderedDict(</font>
<font color="red"> 789.             (name, (func, name, desc))</font>
<font color="red"> 790.             for func, name, desc in actions</font>
<font color="black"> 791.         )</font>
<font color="black"> 792. </font>
<font color="red"> 793.         return actions</font>
<font color="black"> 794. </font>
<font color="green"> 795.     def get_action_choices(self, request, default_choices=BLANK_CHOICE_DASH):</font>
<font color="black"> 796.         &quot;&quot;&quot;</font>
<font color="black"> 797.         Return a list of choices for use in a form object.  Each choice is a</font>
<font color="black"> 798.         tuple (name, description).</font>
<font color="black"> 799.         &quot;&quot;&quot;</font>
<font color="red"> 800.         choices = [] + default_choices</font>
<font color="red"> 801.         for func, name, description in six.itervalues(self.get_actions(request)):</font>
<font color="red"> 802.             choice = (name, description % model_format_dict(self.opts))</font>
<font color="red"> 803.             choices.append(choice)</font>
<font color="red"> 804.         return choices</font>
<font color="black"> 805. </font>
<font color="green"> 806.     def get_action(self, action):</font>
<font color="black"> 807.         &quot;&quot;&quot;</font>
<font color="black"> 808.         Return a given action from a parameter, which can either be a callable,</font>
<font color="black"> 809.         or the name of a method on the ModelAdmin.  Return is a tuple of</font>
<font color="black"> 810.         (callable, name, description).</font>
<font color="black"> 811.         &quot;&quot;&quot;</font>
<font color="black"> 812.         # If the action is a callable, just use it.</font>
<font color="red"> 813.         if callable(action):</font>
<font color="red"> 814.             func = action</font>
<font color="red"> 815.             action = action.__name__</font>
<font color="black"> 816. </font>
<font color="black"> 817.         # Next, look for a method. Grab it off self.__class__ to get an unbound</font>
<font color="black"> 818.         # method instead of a bound one; this ensures that the calling</font>
<font color="black"> 819.         # conventions are the same for functions and methods.</font>
<font color="red"> 820.         elif hasattr(self.__class__, action):</font>
<font color="red"> 821.             func = getattr(self.__class__, action)</font>
<font color="black"> 822. </font>
<font color="black"> 823.         # Finally, look for a named method on the admin site</font>
<font color="black"> 824.         else:</font>
<font color="red"> 825.             try:</font>
<font color="red"> 826.                 func = self.admin_site.get_action(action)</font>
<font color="red"> 827.             except KeyError:</font>
<font color="red"> 828.                 return None</font>
<font color="black"> 829. </font>
<font color="red"> 830.         if hasattr(func, 'short_description'):</font>
<font color="red"> 831.             description = func.short_description</font>
<font color="black"> 832.         else:</font>
<font color="red"> 833.             description = capfirst(action.replace('_', ' '))</font>
<font color="red"> 834.         return func, action, description</font>
<font color="black"> 835. </font>
<font color="green"> 836.     def get_list_display(self, request):</font>
<font color="black"> 837.         &quot;&quot;&quot;</font>
<font color="black"> 838.         Return a sequence containing the fields to be displayed on the</font>
<font color="black"> 839.         changelist.</font>
<font color="black"> 840.         &quot;&quot;&quot;</font>
<font color="red"> 841.         return self.list_display</font>
<font color="black"> 842. </font>
<font color="green"> 843.     def get_list_display_links(self, request, list_display):</font>
<font color="black"> 844.         &quot;&quot;&quot;</font>
<font color="black"> 845.         Return a sequence containing the fields to be displayed as links</font>
<font color="black"> 846.         on the changelist. The list_display parameter is the list of fields</font>
<font color="black"> 847.         returned by get_list_display().</font>
<font color="black"> 848.         &quot;&quot;&quot;</font>
<font color="red"> 849.         if self.list_display_links or self.list_display_links is None or not list_display:</font>
<font color="red"> 850.             return self.list_display_links</font>
<font color="black"> 851.         else:</font>
<font color="black"> 852.             # Use only the first item in list_display as link</font>
<font color="red"> 853.             return list(list_display)[:1]</font>
<font color="black"> 854. </font>
<font color="green"> 855.     def get_list_filter(self, request):</font>
<font color="black"> 856.         &quot;&quot;&quot;</font>
<font color="black"> 857.         Returns a sequence containing the fields to be displayed as filters in</font>
<font color="black"> 858.         the right sidebar of the changelist page.</font>
<font color="black"> 859.         &quot;&quot;&quot;</font>
<font color="red"> 860.         return self.list_filter</font>
<font color="black"> 861. </font>
<font color="green"> 862.     def get_list_select_related(self, request):</font>
<font color="black"> 863.         &quot;&quot;&quot;</font>
<font color="black"> 864.         Returns a list of fields to add to the select_related() part of the</font>
<font color="black"> 865.         changelist items query.</font>
<font color="black"> 866.         &quot;&quot;&quot;</font>
<font color="red"> 867.         return self.list_select_related</font>
<font color="black"> 868. </font>
<font color="green"> 869.     def get_search_fields(self, request):</font>
<font color="black"> 870.         &quot;&quot;&quot;</font>
<font color="black"> 871.         Returns a sequence containing the fields to be searched whenever</font>
<font color="black"> 872.         somebody submits a search query.</font>
<font color="black"> 873.         &quot;&quot;&quot;</font>
<font color="red"> 874.         return self.search_fields</font>
<font color="black"> 875. </font>
<font color="green"> 876.     def get_search_results(self, request, queryset, search_term):</font>
<font color="black"> 877.         &quot;&quot;&quot;</font>
<font color="black"> 878.         Returns a tuple containing a queryset to implement the search,</font>
<font color="black"> 879.         and a boolean indicating if the results may contain duplicates.</font>
<font color="black"> 880.         &quot;&quot;&quot;</font>
<font color="black"> 881.         # Apply keyword searches.</font>
<font color="red"> 882.         def construct_search(field_name):</font>
<font color="red"> 883.             if field_name.startswith('^'):</font>
<font color="red"> 884.                 return &quot;%s__istartswith&quot; % field_name[1:]</font>
<font color="red"> 885.             elif field_name.startswith('='):</font>
<font color="red"> 886.                 return &quot;%s__iexact&quot; % field_name[1:]</font>
<font color="red"> 887.             elif field_name.startswith('@'):</font>
<font color="red"> 888.                 return &quot;%s__search&quot; % field_name[1:]</font>
<font color="black"> 889.             else:</font>
<font color="red"> 890.                 return &quot;%s__icontains&quot; % field_name</font>
<font color="black"> 891. </font>
<font color="red"> 892.         use_distinct = False</font>
<font color="red"> 893.         search_fields = self.get_search_fields(request)</font>
<font color="red"> 894.         if search_fields and search_term:</font>
<font color="red"> 895.             orm_lookups = [construct_search(str(search_field))</font>
<font color="red"> 896.                            for search_field in search_fields]</font>
<font color="red"> 897.             for bit in search_term.split():</font>
<font color="red"> 898.                 or_queries = [models.Q(**{orm_lookup: bit})</font>
<font color="red"> 899.                               for orm_lookup in orm_lookups]</font>
<font color="red"> 900.                 queryset = queryset.filter(reduce(operator.or_, or_queries))</font>
<font color="red"> 901.             if not use_distinct:</font>
<font color="red"> 902.                 for search_spec in orm_lookups:</font>
<font color="red"> 903.                     if lookup_needs_distinct(self.opts, search_spec):</font>
<font color="red"> 904.                         use_distinct = True</font>
<font color="red"> 905.                         break</font>
<font color="black"> 906. </font>
<font color="red"> 907.         return queryset, use_distinct</font>
<font color="black"> 908. </font>
<font color="green"> 909.     def get_preserved_filters(self, request):</font>
<font color="black"> 910.         &quot;&quot;&quot;</font>
<font color="black"> 911.         Returns the preserved filters querystring.</font>
<font color="black"> 912.         &quot;&quot;&quot;</font>
<font color="red"> 913.         match = request.resolver_match</font>
<font color="red"> 914.         if self.preserve_filters and match:</font>
<font color="red"> 915.             opts = self.model._meta</font>
<font color="red"> 916.             current_url = '%s:%s' % (match.app_name, match.url_name)</font>
<font color="red"> 917.             changelist_url = 'admin:%s_%s_changelist' % (opts.app_label, opts.model_name)</font>
<font color="red"> 918.             if current_url == changelist_url:</font>
<font color="red"> 919.                 preserved_filters = request.GET.urlencode()</font>
<font color="black"> 920.             else:</font>
<font color="red"> 921.                 preserved_filters = request.GET.get('_changelist_filters')</font>
<font color="black"> 922. </font>
<font color="red"> 923.             if preserved_filters:</font>
<font color="red"> 924.                 return urlencode({'_changelist_filters': preserved_filters})</font>
<font color="red"> 925.         return ''</font>
<font color="black"> 926. </font>
<font color="green"> 927.     def construct_change_message(self, request, form, formsets, add=False):</font>
<font color="black"> 928.         &quot;&quot;&quot;</font>
<font color="black"> 929.         Construct a change message from a changed object.</font>
<font color="black"> 930.         &quot;&quot;&quot;</font>
<font color="red"> 931.         change_message = []</font>
<font color="red"> 932.         if add:</font>
<font color="red"> 933.             change_message.append(_('Added.'))</font>
<font color="red"> 934.         elif form.changed_data:</font>
<font color="red"> 935.             change_message.append(_('Changed %s.') % get_text_list(form.changed_data, _('and')))</font>
<font color="black"> 936. </font>
<font color="red"> 937.         if formsets:</font>
<font color="red"> 938.             for formset in formsets:</font>
<font color="red"> 939.                 for added_object in formset.new_objects:</font>
<font color="red"> 940.                     change_message.append(_('Added %(name)s &quot;%(object)s&quot;.')</font>
<font color="red"> 941.                                           % {'name': force_text(added_object._meta.verbose_name),</font>
<font color="red"> 942.                                              'object': force_text(added_object)})</font>
<font color="red"> 943.                 for changed_object, changed_fields in formset.changed_objects:</font>
<font color="red"> 944.                     change_message.append(_('Changed %(list)s for %(name)s &quot;%(object)s&quot;.')</font>
<font color="red"> 945.                                           % {'list': get_text_list(changed_fields, _('and')),</font>
<font color="red"> 946.                                              'name': force_text(changed_object._meta.verbose_name),</font>
<font color="red"> 947.                                              'object': force_text(changed_object)})</font>
<font color="red"> 948.                 for deleted_object in formset.deleted_objects:</font>
<font color="red"> 949.                     change_message.append(_('Deleted %(name)s &quot;%(object)s&quot;.')</font>
<font color="red"> 950.                                           % {'name': force_text(deleted_object._meta.verbose_name),</font>
<font color="red"> 951.                                              'object': force_text(deleted_object)})</font>
<font color="red"> 952.         change_message = ' '.join(change_message)</font>
<font color="red"> 953.         return change_message or _('No fields changed.')</font>
<font color="black"> 954. </font>
<font color="green"> 955.     def message_user(self, request, message, level=messages.INFO, extra_tags='',</font>
<font color="green"> 956.                      fail_silently=False):</font>
<font color="black"> 957.         &quot;&quot;&quot;</font>
<font color="black"> 958.         Send a message to the user. The default implementation</font>
<font color="black"> 959.         posts a message using the django.contrib.messages backend.</font>
<font color="black"> 960. </font>
<font color="black"> 961.         Exposes almost the same API as messages.add_message(), but accepts the</font>
<font color="black"> 962.         positional arguments in a different order to maintain backwards</font>
<font color="black"> 963.         compatibility. For convenience, it accepts the `level` argument as</font>
<font color="black"> 964.         a string rather than the usual level number.</font>
<font color="black"> 965.         &quot;&quot;&quot;</font>
<font color="black"> 966. </font>
<font color="red"> 967.         if not isinstance(level, int):</font>
<font color="black"> 968.             # attempt to get the level if passed a string</font>
<font color="red"> 969.             try:</font>
<font color="red"> 970.                 level = getattr(messages.constants, level.upper())</font>
<font color="red"> 971.             except AttributeError:</font>
<font color="red"> 972.                 levels = messages.constants.DEFAULT_TAGS.values()</font>
<font color="red"> 973.                 levels_repr = ', '.join('`%s`' % l for l in levels)</font>
<font color="red"> 974.                 raise ValueError('Bad message level string: `%s`. '</font>
<font color="red"> 975.                         'Possible values are: %s' % (level, levels_repr))</font>
<font color="black"> 976. </font>
<font color="red"> 977.         messages.add_message(request, level, message, extra_tags=extra_tags,</font>
<font color="red"> 978.                 fail_silently=fail_silently)</font>
<font color="black"> 979. </font>
<font color="green"> 980.     def save_form(self, request, form, change):</font>
<font color="black"> 981.         &quot;&quot;&quot;</font>
<font color="black"> 982.         Given a ModelForm return an unsaved instance. ``change`` is True if</font>
<font color="black"> 983.         the object is being changed, and False if it's being added.</font>
<font color="black"> 984.         &quot;&quot;&quot;</font>
<font color="red"> 985.         return form.save(commit=False)</font>
<font color="black"> 986. </font>
<font color="green"> 987.     def save_model(self, request, obj, form, change):</font>
<font color="black"> 988.         &quot;&quot;&quot;</font>
<font color="black"> 989.         Given a model instance save it to the database.</font>
<font color="black"> 990.         &quot;&quot;&quot;</font>
<font color="red"> 991.         obj.save()</font>
<font color="black"> 992. </font>
<font color="green"> 993.     def delete_model(self, request, obj):</font>
<font color="black"> 994.         &quot;&quot;&quot;</font>
<font color="black"> 995.         Given a model instance delete it from the database.</font>
<font color="black"> 996.         &quot;&quot;&quot;</font>
<font color="red"> 997.         obj.delete()</font>
<font color="black"> 998. </font>
<font color="green"> 999.     def save_formset(self, request, form, formset, change):</font>
<font color="black">1000.         &quot;&quot;&quot;</font>
<font color="black">1001.         Given an inline formset save it to the database.</font>
<font color="black">1002.         &quot;&quot;&quot;</font>
<font color="red">1003.         formset.save()</font>
<font color="black">1004. </font>
<font color="green">1005.     def save_related(self, request, form, formsets, change):</font>
<font color="black">1006.         &quot;&quot;&quot;</font>
<font color="black">1007.         Given the ``HttpRequest``, the parent ``ModelForm`` instance, the</font>
<font color="black">1008.         list of inline formsets and a boolean value based on whether the</font>
<font color="black">1009.         parent is being added or changed, save the related objects to the</font>
<font color="black">1010.         database. Note that at this point save_form() and save_model() have</font>
<font color="black">1011.         already been called.</font>
<font color="black">1012.         &quot;&quot;&quot;</font>
<font color="red">1013.         form.save_m2m()</font>
<font color="red">1014.         for formset in formsets:</font>
<font color="red">1015.             self.save_formset(request, form, formset, change=change)</font>
<font color="black">1016. </font>
<font color="green">1017.     def render_change_form(self, request, context, add=False, change=False, form_url='', obj=None):</font>
<font color="red">1018.         opts = self.model._meta</font>
<font color="red">1019.         app_label = opts.app_label</font>
<font color="red">1020.         preserved_filters = self.get_preserved_filters(request)</font>
<font color="red">1021.         form_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, form_url)</font>
<font color="red">1022.         view_on_site_url = self.get_view_on_site_url(obj)</font>
<font color="red">1023.         context.update({</font>
<font color="red">1024.             'add': add,</font>
<font color="red">1025.             'change': change,</font>
<font color="red">1026.             'has_add_permission': self.has_add_permission(request),</font>
<font color="red">1027.             'has_change_permission': self.has_change_permission(request, obj),</font>
<font color="red">1028.             'has_delete_permission': self.has_delete_permission(request, obj),</font>
<font color="red">1029.             'has_file_field': True,  # FIXME - this should check if form or formsets have a FileField,</font>
<font color="red">1030.             'has_absolute_url': view_on_site_url is not None,</font>
<font color="red">1031.             'absolute_url': view_on_site_url,</font>
<font color="red">1032.             'form_url': form_url,</font>
<font color="red">1033.             'opts': opts,</font>
<font color="red">1034.             'content_type_id': get_content_type_for_model(self.model).pk,</font>
<font color="red">1035.             'save_as': self.save_as,</font>
<font color="red">1036.             'save_on_top': self.save_on_top,</font>
<font color="red">1037.             'to_field_var': TO_FIELD_VAR,</font>
<font color="red">1038.             'is_popup_var': IS_POPUP_VAR,</font>
<font color="red">1039.             'app_label': app_label,</font>
<font color="black">1040.         })</font>
<font color="red">1041.         if add and self.add_form_template is not None:</font>
<font color="red">1042.             form_template = self.add_form_template</font>
<font color="black">1043.         else:</font>
<font color="red">1044.             form_template = self.change_form_template</font>
<font color="black">1045. </font>
<font color="red">1046.         request.current_app = self.admin_site.name</font>
<font color="black">1047. </font>
<font color="red">1048.         return TemplateResponse(request, form_template or [</font>
<font color="red">1049.             &quot;admin/%s/%s/change_form.html&quot; % (app_label, opts.model_name),</font>
<font color="red">1050.             &quot;admin/%s/change_form.html&quot; % app_label,</font>
<font color="red">1051.             &quot;admin/change_form.html&quot;</font>
<font color="red">1052.         ], context)</font>
<font color="black">1053. </font>
<font color="green">1054.     def response_add(self, request, obj, post_url_continue=None):</font>
<font color="black">1055.         &quot;&quot;&quot;</font>
<font color="black">1056.         Determines the HttpResponse for the add_view stage.</font>
<font color="black">1057.         &quot;&quot;&quot;</font>
<font color="red">1058.         opts = obj._meta</font>
<font color="red">1059.         pk_value = obj._get_pk_val()</font>
<font color="red">1060.         preserved_filters = self.get_preserved_filters(request)</font>
<font color="red">1061.         msg_dict = {'name': force_text(opts.verbose_name), 'obj': force_text(obj)}</font>
<font color="black">1062.         # Here, we distinguish between different save types by checking for</font>
<font color="black">1063.         # the presence of keys in request.POST.</font>
<font color="black">1064. </font>
<font color="red">1065.         if IS_POPUP_VAR in request.POST:</font>
<font color="red">1066.             to_field = request.POST.get(TO_FIELD_VAR)</font>
<font color="red">1067.             if to_field:</font>
<font color="red">1068.                 attr = str(to_field)</font>
<font color="black">1069.             else:</font>
<font color="red">1070.                 attr = obj._meta.pk.attname</font>
<font color="red">1071.             value = obj.serializable_value(attr)</font>
<font color="red">1072.             return SimpleTemplateResponse('admin/popup_response.html', {</font>
<font color="red">1073.                 'value': value,</font>
<font color="red">1074.                 'obj': obj,</font>
<font color="black">1075.             })</font>
<font color="black">1076. </font>
<font color="red">1077.         elif &quot;_continue&quot; in request.POST:</font>
<font color="red">1078.             msg = _('The %(name)s &quot;%(obj)s&quot; was added successfully. You may edit it again below.') % msg_dict</font>
<font color="red">1079.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1080.             if post_url_continue is None:</font>
<font color="red">1081.                 post_url_continue = reverse('admin:%s_%s_change' %</font>
<font color="red">1082.                                             (opts.app_label, opts.model_name),</font>
<font color="red">1083.                                             args=(quote(pk_value),),</font>
<font color="red">1084.                                             current_app=self.admin_site.name)</font>
<font color="red">1085.             post_url_continue = add_preserved_filters(</font>
<font color="red">1086.                 {'preserved_filters': preserved_filters, 'opts': opts},</font>
<font color="red">1087.                 post_url_continue</font>
<font color="black">1088.             )</font>
<font color="red">1089.             return HttpResponseRedirect(post_url_continue)</font>
<font color="black">1090. </font>
<font color="red">1091.         elif &quot;_addanother&quot; in request.POST:</font>
<font color="red">1092.             msg = _('The %(name)s &quot;%(obj)s&quot; was added successfully. You may add another %(name)s below.') % msg_dict</font>
<font color="red">1093.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1094.             redirect_url = request.path</font>
<font color="red">1095.             redirect_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, redirect_url)</font>
<font color="red">1096.             return HttpResponseRedirect(redirect_url)</font>
<font color="black">1097. </font>
<font color="black">1098.         else:</font>
<font color="red">1099.             msg = _('The %(name)s &quot;%(obj)s&quot; was added successfully.') % msg_dict</font>
<font color="red">1100.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1101.             return self.response_post_save_add(request, obj)</font>
<font color="black">1102. </font>
<font color="green">1103.     def response_change(self, request, obj):</font>
<font color="black">1104.         &quot;&quot;&quot;</font>
<font color="black">1105.         Determines the HttpResponse for the change_view stage.</font>
<font color="black">1106.         &quot;&quot;&quot;</font>
<font color="black">1107. </font>
<font color="red">1108.         if IS_POPUP_VAR in request.POST:</font>
<font color="red">1109.             to_field = request.POST.get(TO_FIELD_VAR)</font>
<font color="red">1110.             attr = str(to_field) if to_field else obj._meta.pk.attname</font>
<font color="black">1111.             # Retrieve the `object_id` from the resolved pattern arguments.</font>
<font color="red">1112.             value = request.resolver_match.args[0]</font>
<font color="red">1113.             new_value = obj.serializable_value(attr)</font>
<font color="red">1114.             return SimpleTemplateResponse('admin/popup_response.html', {</font>
<font color="red">1115.                 'action': 'change',</font>
<font color="red">1116.                 'value': escape(value),</font>
<font color="red">1117.                 'obj': escapejs(obj),</font>
<font color="red">1118.                 'new_value': escape(new_value),</font>
<font color="black">1119.             })</font>
<font color="black">1120. </font>
<font color="red">1121.         opts = self.model._meta</font>
<font color="red">1122.         pk_value = obj._get_pk_val()</font>
<font color="red">1123.         preserved_filters = self.get_preserved_filters(request)</font>
<font color="black">1124. </font>
<font color="red">1125.         msg_dict = {'name': force_text(opts.verbose_name), 'obj': force_text(obj)}</font>
<font color="red">1126.         if &quot;_continue&quot; in request.POST:</font>
<font color="red">1127.             msg = _('The %(name)s &quot;%(obj)s&quot; was changed successfully. You may edit it again below.') % msg_dict</font>
<font color="red">1128.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1129.             redirect_url = request.path</font>
<font color="red">1130.             redirect_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, redirect_url)</font>
<font color="red">1131.             return HttpResponseRedirect(redirect_url)</font>
<font color="black">1132. </font>
<font color="red">1133.         elif &quot;_saveasnew&quot; in request.POST:</font>
<font color="red">1134.             msg = _('The %(name)s &quot;%(obj)s&quot; was added successfully. You may edit it again below.') % msg_dict</font>
<font color="red">1135.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1136.             redirect_url = reverse('admin:%s_%s_change' %</font>
<font color="red">1137.                                    (opts.app_label, opts.model_name),</font>
<font color="red">1138.                                    args=(pk_value,),</font>
<font color="red">1139.                                    current_app=self.admin_site.name)</font>
<font color="red">1140.             redirect_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, redirect_url)</font>
<font color="red">1141.             return HttpResponseRedirect(redirect_url)</font>
<font color="black">1142. </font>
<font color="red">1143.         elif &quot;_addanother&quot; in request.POST:</font>
<font color="red">1144.             msg = _('The %(name)s &quot;%(obj)s&quot; was changed successfully. You may add another %(name)s below.') % msg_dict</font>
<font color="red">1145.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1146.             redirect_url = reverse('admin:%s_%s_add' %</font>
<font color="red">1147.                                    (opts.app_label, opts.model_name),</font>
<font color="red">1148.                                    current_app=self.admin_site.name)</font>
<font color="red">1149.             redirect_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, redirect_url)</font>
<font color="red">1150.             return HttpResponseRedirect(redirect_url)</font>
<font color="black">1151. </font>
<font color="black">1152.         else:</font>
<font color="red">1153.             msg = _('The %(name)s &quot;%(obj)s&quot; was changed successfully.') % msg_dict</font>
<font color="red">1154.             self.message_user(request, msg, messages.SUCCESS)</font>
<font color="red">1155.             return self.response_post_save_change(request, obj)</font>
<font color="black">1156. </font>
<font color="green">1157.     def response_post_save_add(self, request, obj):</font>
<font color="black">1158.         &quot;&quot;&quot;</font>
<font color="black">1159.         Figure out where to redirect after the 'Save' button has been pressed</font>
<font color="black">1160.         when adding a new object.</font>
<font color="black">1161.         &quot;&quot;&quot;</font>
<font color="red">1162.         opts = self.model._meta</font>
<font color="red">1163.         if self.has_change_permission(request, None):</font>
<font color="red">1164.             post_url = reverse('admin:%s_%s_changelist' %</font>
<font color="red">1165.                                (opts.app_label, opts.model_name),</font>
<font color="red">1166.                                current_app=self.admin_site.name)</font>
<font color="red">1167.             preserved_filters = self.get_preserved_filters(request)</font>
<font color="red">1168.             post_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, post_url)</font>
<font color="black">1169.         else:</font>
<font color="red">1170.             post_url = reverse('admin:index',</font>
<font color="red">1171.                                current_app=self.admin_site.name)</font>
<font color="red">1172.         return HttpResponseRedirect(post_url)</font>
<font color="black">1173. </font>
<font color="green">1174.     def response_post_save_change(self, request, obj):</font>
<font color="black">1175.         &quot;&quot;&quot;</font>
<font color="black">1176.         Figure out where to redirect after the 'Save' button has been pressed</font>
<font color="black">1177.         when editing an existing object.</font>
<font color="black">1178.         &quot;&quot;&quot;</font>
<font color="red">1179.         opts = self.model._meta</font>
<font color="black">1180. </font>
<font color="red">1181.         if self.has_change_permission(request, None):</font>
<font color="red">1182.             post_url = reverse('admin:%s_%s_changelist' %</font>
<font color="red">1183.                                (opts.app_label, opts.model_name),</font>
<font color="red">1184.                                current_app=self.admin_site.name)</font>
<font color="red">1185.             preserved_filters = self.get_preserved_filters(request)</font>
<font color="red">1186.             post_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, post_url)</font>
<font color="black">1187.         else:</font>
<font color="red">1188.             post_url = reverse('admin:index',</font>
<font color="red">1189.                                current_app=self.admin_site.name)</font>
<font color="red">1190.         return HttpResponseRedirect(post_url)</font>
<font color="black">1191. </font>
<font color="green">1192.     def response_action(self, request, queryset):</font>
<font color="black">1193.         &quot;&quot;&quot;</font>
<font color="black">1194.         Handle an admin action. This is called if a request is POSTed to the</font>
<font color="black">1195.         changelist; it returns an HttpResponse if the action was handled, and</font>
<font color="black">1196.         None otherwise.</font>
<font color="black">1197.         &quot;&quot;&quot;</font>
<font color="black">1198. </font>
<font color="black">1199.         # There can be multiple action forms on the page (at the top</font>
<font color="black">1200.         # and bottom of the change list, for example). Get the action</font>
<font color="black">1201.         # whose button was pushed.</font>
<font color="red">1202.         try:</font>
<font color="red">1203.             action_index = int(request.POST.get('index', 0))</font>
<font color="red">1204.         except ValueError:</font>
<font color="red">1205.             action_index = 0</font>
<font color="black">1206. </font>
<font color="black">1207.         # Construct the action form.</font>
<font color="red">1208.         data = request.POST.copy()</font>
<font color="red">1209.         data.pop(helpers.ACTION_CHECKBOX_NAME, None)</font>
<font color="red">1210.         data.pop(&quot;index&quot;, None)</font>
<font color="black">1211. </font>
<font color="black">1212.         # Use the action whose button was pushed</font>
<font color="red">1213.         try:</font>
<font color="red">1214.             data.update({'action': data.getlist('action')[action_index]})</font>
<font color="red">1215.         except IndexError:</font>
<font color="black">1216.             # If we didn't get an action from the chosen form that's invalid</font>
<font color="black">1217.             # POST data, so by deleting action it'll fail the validation check</font>
<font color="black">1218.             # below. So no need to do anything here</font>
<font color="red">1219.             pass</font>
<font color="black">1220. </font>
<font color="red">1221.         action_form = self.action_form(data, auto_id=None)</font>
<font color="red">1222.         action_form.fields['action'].choices = self.get_action_choices(request)</font>
<font color="black">1223. </font>
<font color="black">1224.         # If the form's valid we can handle the action.</font>
<font color="red">1225.         if action_form.is_valid():</font>
<font color="red">1226.             action = action_form.cleaned_data['action']</font>
<font color="red">1227.             select_across = action_form.cleaned_data['select_across']</font>
<font color="red">1228.             func = self.get_actions(request)[action][0]</font>
<font color="black">1229. </font>
<font color="black">1230.             # Get the list of selected PKs. If nothing's selected, we can't</font>
<font color="black">1231.             # perform an action on it, so bail. Except we want to perform</font>
<font color="black">1232.             # the action explicitly on all objects.</font>
<font color="red">1233.             selected = request.POST.getlist(helpers.ACTION_CHECKBOX_NAME)</font>
<font color="red">1234.             if not selected and not select_across:</font>
<font color="black">1235.                 # Reminder that something needs to be selected or nothing will happen</font>
<font color="red">1236.                 msg = _(&quot;Items must be selected in order to perform &quot;</font>
<font color="black">1237.                         &quot;actions on them. No items have been changed.&quot;)</font>
<font color="red">1238.                 self.message_user(request, msg, messages.WARNING)</font>
<font color="red">1239.                 return None</font>
<font color="black">1240. </font>
<font color="red">1241.             if not select_across:</font>
<font color="black">1242.                 # Perform the action only on the selected objects</font>
<font color="red">1243.                 queryset = queryset.filter(pk__in=selected)</font>
<font color="black">1244. </font>
<font color="red">1245.             response = func(self, request, queryset)</font>
<font color="black">1246. </font>
<font color="black">1247.             # Actions may return an HttpResponse-like object, which will be</font>
<font color="black">1248.             # used as the response from the POST. If not, we'll be a good</font>
<font color="black">1249.             # little HTTP citizen and redirect back to the changelist page.</font>
<font color="red">1250.             if isinstance(response, HttpResponseBase):</font>
<font color="red">1251.                 return response</font>
<font color="black">1252.             else:</font>
<font color="red">1253.                 return HttpResponseRedirect(request.get_full_path())</font>
<font color="black">1254.         else:</font>
<font color="red">1255.             msg = _(&quot;No action selected.&quot;)</font>
<font color="red">1256.             self.message_user(request, msg, messages.WARNING)</font>
<font color="red">1257.             return None</font>
<font color="black">1258. </font>
<font color="green">1259.     def response_delete(self, request, obj_display, obj_id):</font>
<font color="black">1260.         &quot;&quot;&quot;</font>
<font color="black">1261.         Determines the HttpResponse for the delete_view stage.</font>
<font color="black">1262.         &quot;&quot;&quot;</font>
<font color="black">1263. </font>
<font color="red">1264.         opts = self.model._meta</font>
<font color="black">1265. </font>
<font color="red">1266.         if IS_POPUP_VAR in request.POST:</font>
<font color="red">1267.             return SimpleTemplateResponse('admin/popup_response.html', {</font>
<font color="red">1268.                 'action': 'delete',</font>
<font color="red">1269.                 'value': escape(obj_id),</font>
<font color="black">1270.             })</font>
<font color="black">1271. </font>
<font color="red">1272.         self.message_user(request,</font>
<font color="red">1273.             _('The %(name)s &quot;%(obj)s&quot; was deleted successfully.') % {</font>
<font color="red">1274.                 'name': force_text(opts.verbose_name),</font>
<font color="red">1275.                 'obj': force_text(obj_display),</font>
<font color="red">1276.             }, messages.SUCCESS)</font>
<font color="black">1277. </font>
<font color="red">1278.         if self.has_change_permission(request, None):</font>
<font color="red">1279.             post_url = reverse('admin:%s_%s_changelist' %</font>
<font color="red">1280.                                (opts.app_label, opts.model_name),</font>
<font color="red">1281.                                current_app=self.admin_site.name)</font>
<font color="red">1282.             preserved_filters = self.get_preserved_filters(request)</font>
<font color="red">1283.             post_url = add_preserved_filters(</font>
<font color="red">1284.                 {'preserved_filters': preserved_filters, 'opts': opts}, post_url</font>
<font color="black">1285.             )</font>
<font color="black">1286.         else:</font>
<font color="red">1287.             post_url = reverse('admin:index',</font>
<font color="red">1288.                                current_app=self.admin_site.name)</font>
<font color="red">1289.         return HttpResponseRedirect(post_url)</font>
<font color="black">1290. </font>
<font color="green">1291.     def render_delete_form(self, request, context):</font>
<font color="red">1292.         opts = self.model._meta</font>
<font color="red">1293.         app_label = opts.app_label</font>
<font color="black">1294. </font>
<font color="red">1295.         request.current_app = self.admin_site.name</font>
<font color="red">1296.         context.update(</font>
<font color="red">1297.             to_field_var=TO_FIELD_VAR,</font>
<font color="red">1298.             is_popup_var=IS_POPUP_VAR,</font>
<font color="black">1299.         )</font>
<font color="black">1300. </font>
<font color="red">1301.         return TemplateResponse(request,</font>
<font color="red">1302.             self.delete_confirmation_template or [</font>
<font color="red">1303.                 &quot;admin/{}/{}/delete_confirmation.html&quot;.format(app_label, opts.model_name),</font>
<font color="red">1304.                 &quot;admin/{}/delete_confirmation.html&quot;.format(app_label),</font>
<font color="red">1305.                 &quot;admin/delete_confirmation.html&quot;</font>
<font color="red">1306.             ], context)</font>
<font color="black">1307. </font>
<font color="black">1308.     def get_inline_formsets(self, request, formsets, inline_instances,</font>
<font color="green">1309.                             obj=None):</font>
<font color="red">1310.         inline_admin_formsets = []</font>
<font color="red">1311.         for inline, formset in zip(inline_instances, formsets):</font>
<font color="red">1312.             fieldsets = list(inline.get_fieldsets(request, obj))</font>
<font color="red">1313.             readonly = list(inline.get_readonly_fields(request, obj))</font>
<font color="red">1314.             prepopulated = dict(inline.get_prepopulated_fields(request, obj))</font>
<font color="red">1315.             inline_admin_formset = helpers.InlineAdminFormSet(inline, formset,</font>
<font color="red">1316.                 fieldsets, prepopulated, readonly, model_admin=self)</font>
<font color="red">1317.             inline_admin_formsets.append(inline_admin_formset)</font>
<font color="red">1318.         return inline_admin_formsets</font>
<font color="black">1319. </font>
<font color="green">1320.     def get_changeform_initial_data(self, request):</font>
<font color="black">1321.         &quot;&quot;&quot;</font>
<font color="black">1322.         Get the initial form data.</font>
<font color="black">1323.         Unless overridden, this populates from the GET params.</font>
<font color="black">1324.         &quot;&quot;&quot;</font>
<font color="red">1325.         initial = dict(request.GET.items())</font>
<font color="red">1326.         for k in initial:</font>
<font color="red">1327.             try:</font>
<font color="red">1328.                 f = self.model._meta.get_field(k)</font>
<font color="red">1329.             except FieldDoesNotExist:</font>
<font color="red">1330.                 continue</font>
<font color="black">1331.             # We have to special-case M2Ms as a list of comma-separated PKs.</font>
<font color="red">1332.             if isinstance(f, models.ManyToManyField):</font>
<font color="red">1333.                 initial[k] = initial[k].split(&quot;,&quot;)</font>
<font color="red">1334.         return initial</font>
<font color="black">1335. </font>
<font color="green">1336.     @csrf_protect_m</font>
<font color="green">1337.     @transaction.atomic</font>
<font color="green">1338.     def changeform_view(self, request, object_id=None, form_url='', extra_context=None):</font>
<font color="black">1339. </font>
<font color="red">1340.         to_field = request.POST.get(TO_FIELD_VAR, request.GET.get(TO_FIELD_VAR))</font>
<font color="red">1341.         if to_field and not self.to_field_allowed(request, to_field):</font>
<font color="red">1342.             raise DisallowedModelAdminToField(&quot;The field %s cannot be referenced.&quot; % to_field)</font>
<font color="black">1343. </font>
<font color="red">1344.         model = self.model</font>
<font color="red">1345.         opts = model._meta</font>
<font color="red">1346.         add = object_id is None</font>
<font color="black">1347. </font>
<font color="red">1348.         if add:</font>
<font color="red">1349.             if not self.has_add_permission(request):</font>
<font color="red">1350.                 raise PermissionDenied</font>
<font color="red">1351.             obj = None</font>
<font color="black">1352. </font>
<font color="black">1353.         else:</font>
<font color="red">1354.             obj = self.get_object(request, unquote(object_id), to_field)</font>
<font color="black">1355. </font>
<font color="red">1356.             if not self.has_change_permission(request, obj):</font>
<font color="red">1357.                 raise PermissionDenied</font>
<font color="black">1358. </font>
<font color="red">1359.             if obj is None:</font>
<font color="red">1360.                 raise Http404(_('%(name)s object with primary key %(key)r does not exist.') % {</font>
<font color="red">1361.                     'name': force_text(opts.verbose_name), 'key': escape(object_id)})</font>
<font color="black">1362. </font>
<font color="red">1363.             if request.method == 'POST' and &quot;_saveasnew&quot; in request.POST:</font>
<font color="red">1364.                 object_id = None</font>
<font color="red">1365.                 obj = None</font>
<font color="black">1366. </font>
<font color="red">1367.         ModelForm = self.get_form(request, obj)</font>
<font color="red">1368.         if request.method == 'POST':</font>
<font color="red">1369.             form = ModelForm(request.POST, request.FILES, instance=obj)</font>
<font color="red">1370.             if form.is_valid():</font>
<font color="red">1371.                 form_validated = True</font>
<font color="red">1372.                 new_object = self.save_form(request, form, change=not add)</font>
<font color="black">1373.             else:</font>
<font color="red">1374.                 form_validated = False</font>
<font color="red">1375.                 new_object = form.instance</font>
<font color="red">1376.             formsets, inline_instances = self._create_formsets(request, new_object, change=not add)</font>
<font color="red">1377.             if all_valid(formsets) and form_validated:</font>
<font color="red">1378.                 self.save_model(request, new_object, form, not add)</font>
<font color="red">1379.                 self.save_related(request, form, formsets, not add)</font>
<font color="red">1380.                 change_message = self.construct_change_message(request, form, formsets, add)</font>
<font color="red">1381.                 if add:</font>
<font color="red">1382.                     self.log_addition(request, new_object, change_message)</font>
<font color="red">1383.                     return self.response_add(request, new_object)</font>
<font color="black">1384.                 else:</font>
<font color="red">1385.                     self.log_change(request, new_object, change_message)</font>
<font color="red">1386.                     return self.response_change(request, new_object)</font>
<font color="black">1387.             else:</font>
<font color="red">1388.                 form_validated = False</font>
<font color="black">1389.         else:</font>
<font color="red">1390.             if add:</font>
<font color="red">1391.                 initial = self.get_changeform_initial_data(request)</font>
<font color="red">1392.                 form = ModelForm(initial=initial)</font>
<font color="red">1393.                 formsets, inline_instances = self._create_formsets(request, form.instance, change=False)</font>
<font color="black">1394.             else:</font>
<font color="red">1395.                 form = ModelForm(instance=obj)</font>
<font color="red">1396.                 formsets, inline_instances = self._create_formsets(request, obj, change=True)</font>
<font color="black">1397. </font>
<font color="red">1398.         adminForm = helpers.AdminForm(</font>
<font color="red">1399.             form,</font>
<font color="red">1400.             list(self.get_fieldsets(request, obj)),</font>
<font color="red">1401.             self.get_prepopulated_fields(request, obj),</font>
<font color="red">1402.             self.get_readonly_fields(request, obj),</font>
<font color="red">1403.             model_admin=self)</font>
<font color="red">1404.         media = self.media + adminForm.media</font>
<font color="black">1405. </font>
<font color="red">1406.         inline_formsets = self.get_inline_formsets(request, formsets, inline_instances, obj)</font>
<font color="red">1407.         for inline_formset in inline_formsets:</font>
<font color="red">1408.             media = media + inline_formset.media</font>
<font color="black">1409. </font>
<font color="red">1410.         context = dict(self.admin_site.each_context(request),</font>
<font color="red">1411.             title=(_('Add %s') if add else _('Change %s')) % force_text(opts.verbose_name),</font>
<font color="red">1412.             adminform=adminForm,</font>
<font color="red">1413.             object_id=object_id,</font>
<font color="red">1414.             original=obj,</font>
<font color="red">1415.             is_popup=(IS_POPUP_VAR in request.POST or</font>
<font color="red">1416.                       IS_POPUP_VAR in request.GET),</font>
<font color="red">1417.             to_field=to_field,</font>
<font color="red">1418.             media=media,</font>
<font color="red">1419.             inline_admin_formsets=inline_formsets,</font>
<font color="red">1420.             errors=helpers.AdminErrorList(form, formsets),</font>
<font color="red">1421.             preserved_filters=self.get_preserved_filters(request),</font>
<font color="black">1422.         )</font>
<font color="black">1423. </font>
<font color="black">1424.         # Hide the &quot;Save&quot; and &quot;Save and continue&quot; buttons if &quot;Save as New&quot; was</font>
<font color="black">1425.         # previously chosen to prevent the interface from getting confusing.</font>
<font color="red">1426.         if request.method == 'POST' and not form_validated and &quot;_saveasnew&quot; in request.POST:</font>
<font color="red">1427.             context['show_save'] = False</font>
<font color="red">1428.             context['show_save_and_continue'] = False</font>
<font color="black">1429. </font>
<font color="red">1430.         context.update(extra_context or {})</font>
<font color="black">1431. </font>
<font color="red">1432.         return self.render_change_form(request, context, add=add, change=not add, obj=obj, form_url=form_url)</font>
<font color="black">1433. </font>
<font color="green">1434.     def add_view(self, request, form_url='', extra_context=None):</font>
<font color="red">1435.         return self.changeform_view(request, None, form_url, extra_context)</font>
<font color="black">1436. </font>
<font color="green">1437.     def change_view(self, request, object_id, form_url='', extra_context=None):</font>
<font color="red">1438.         return self.changeform_view(request, object_id, form_url, extra_context)</font>
<font color="black">1439. </font>
<font color="green">1440.     @csrf_protect_m</font>
<font color="green">1441.     def changelist_view(self, request, extra_context=None):</font>
<font color="black">1442.         &quot;&quot;&quot;</font>
<font color="black">1443.         The 'change list' admin view for this model.</font>
<font color="black">1444.         &quot;&quot;&quot;</font>
<font color="red">1445.         from django.contrib.admin.views.main import ERROR_FLAG</font>
<font color="red">1446.         opts = self.model._meta</font>
<font color="red">1447.         app_label = opts.app_label</font>
<font color="red">1448.         if not self.has_change_permission(request, None):</font>
<font color="red">1449.             raise PermissionDenied</font>
<font color="black">1450. </font>
<font color="red">1451.         list_display = self.get_list_display(request)</font>
<font color="red">1452.         list_display_links = self.get_list_display_links(request, list_display)</font>
<font color="red">1453.         list_filter = self.get_list_filter(request)</font>
<font color="red">1454.         search_fields = self.get_search_fields(request)</font>
<font color="red">1455.         list_select_related = self.get_list_select_related(request)</font>
<font color="black">1456. </font>
<font color="black">1457.         # Check actions to see if any are available on this changelist</font>
<font color="red">1458.         actions = self.get_actions(request)</font>
<font color="red">1459.         if actions:</font>
<font color="black">1460.             # Add the action checkboxes if there are any actions available.</font>
<font color="red">1461.             list_display = ['action_checkbox'] + list(list_display)</font>
<font color="black">1462. </font>
<font color="red">1463.         ChangeList = self.get_changelist(request)</font>
<font color="red">1464.         try:</font>
<font color="red">1465.             cl = ChangeList(request, self.model, list_display,</font>
<font color="red">1466.                 list_display_links, list_filter, self.date_hierarchy,</font>
<font color="red">1467.                 search_fields, list_select_related, self.list_per_page,</font>
<font color="red">1468.                 self.list_max_show_all, self.list_editable, self)</font>
<font color="black">1469. </font>
<font color="red">1470.         except IncorrectLookupParameters:</font>
<font color="black">1471.             # Wacky lookup parameters were given, so redirect to the main</font>
<font color="black">1472.             # changelist page, without parameters, and pass an 'invalid=1'</font>
<font color="black">1473.             # parameter via the query string. If wacky parameters were given</font>
<font color="black">1474.             # and the 'invalid=1' parameter was already in the query string,</font>
<font color="black">1475.             # something is screwed up with the database, so display an error</font>
<font color="black">1476.             # page.</font>
<font color="red">1477.             if ERROR_FLAG in request.GET.keys():</font>
<font color="red">1478.                 return SimpleTemplateResponse('admin/invalid_setup.html', {</font>
<font color="red">1479.                     'title': _('Database error'),</font>
<font color="black">1480.                 })</font>
<font color="red">1481.             return HttpResponseRedirect(request.path + '?' + ERROR_FLAG + '=1')</font>
<font color="black">1482. </font>
<font color="black">1483.         # If the request was POSTed, this might be a bulk action or a bulk</font>
<font color="black">1484.         # edit. Try to look up an action or confirmation first, but if this</font>
<font color="black">1485.         # isn't an action the POST will fall through to the bulk edit check,</font>
<font color="black">1486.         # below.</font>
<font color="red">1487.         action_failed = False</font>
<font color="red">1488.         selected = request.POST.getlist(helpers.ACTION_CHECKBOX_NAME)</font>
<font color="black">1489. </font>
<font color="black">1490.         # Actions with no confirmation</font>
<font color="red">1491.         if (actions and request.method == 'POST' and</font>
<font color="red">1492.                 'index' in request.POST and '_save' not in request.POST):</font>
<font color="red">1493.             if selected:</font>
<font color="red">1494.                 response = self.response_action(request, queryset=cl.get_queryset(request))</font>
<font color="red">1495.                 if response:</font>
<font color="red">1496.                     return response</font>
<font color="black">1497.                 else:</font>
<font color="red">1498.                     action_failed = True</font>
<font color="black">1499.             else:</font>
<font color="red">1500.                 msg = _(&quot;Items must be selected in order to perform &quot;</font>
<font color="black">1501.                         &quot;actions on them. No items have been changed.&quot;)</font>
<font color="red">1502.                 self.message_user(request, msg, messages.WARNING)</font>
<font color="red">1503.                 action_failed = True</font>
<font color="black">1504. </font>
<font color="black">1505.         # Actions with confirmation</font>
<font color="red">1506.         if (actions and request.method == 'POST' and</font>
<font color="red">1507.                 helpers.ACTION_CHECKBOX_NAME in request.POST and</font>
<font color="red">1508.                 'index' not in request.POST and '_save' not in request.POST):</font>
<font color="red">1509.             if selected:</font>
<font color="red">1510.                 response = self.response_action(request, queryset=cl.get_queryset(request))</font>
<font color="red">1511.                 if response:</font>
<font color="red">1512.                     return response</font>
<font color="black">1513.                 else:</font>
<font color="red">1514.                     action_failed = True</font>
<font color="black">1515. </font>
<font color="black">1516.         # If we're allowing changelist editing, we need to construct a formset</font>
<font color="black">1517.         # for the changelist given all the fields to be edited. Then we'll</font>
<font color="black">1518.         # use the formset to validate/process POSTed data.</font>
<font color="red">1519.         formset = cl.formset = None</font>
<font color="black">1520. </font>
<font color="black">1521.         # Handle POSTed bulk-edit data.</font>
<font color="red">1522.         if (request.method == &quot;POST&quot; and cl.list_editable and</font>
<font color="red">1523.                 '_save' in request.POST and not action_failed):</font>
<font color="red">1524.             FormSet = self.get_changelist_formset(request)</font>
<font color="red">1525.             formset = cl.formset = FormSet(request.POST, request.FILES, queryset=cl.result_list)</font>
<font color="red">1526.             if formset.is_valid():</font>
<font color="red">1527.                 changecount = 0</font>
<font color="red">1528.                 for form in formset.forms:</font>
<font color="red">1529.                     if form.has_changed():</font>
<font color="red">1530.                         obj = self.save_form(request, form, change=True)</font>
<font color="red">1531.                         self.save_model(request, obj, form, change=True)</font>
<font color="red">1532.                         self.save_related(request, form, formsets=[], change=True)</font>
<font color="red">1533.                         change_msg = self.construct_change_message(request, form, None)</font>
<font color="red">1534.                         self.log_change(request, obj, change_msg)</font>
<font color="red">1535.                         changecount += 1</font>
<font color="black">1536. </font>
<font color="red">1537.                 if changecount:</font>
<font color="red">1538.                     if changecount == 1:</font>
<font color="red">1539.                         name = force_text(opts.verbose_name)</font>
<font color="black">1540.                     else:</font>
<font color="red">1541.                         name = force_text(opts.verbose_name_plural)</font>
<font color="red">1542.                     msg = ungettext(&quot;%(count)s %(name)s was changed successfully.&quot;,</font>
<font color="red">1543.                                     &quot;%(count)s %(name)s were changed successfully.&quot;,</font>
<font color="red">1544.                                     changecount) % {'count': changecount,</font>
<font color="red">1545.                                                     'name': name,</font>
<font color="red">1546.                                                     'obj': force_text(obj)}</font>
<font color="red">1547.                     self.message_user(request, msg, messages.SUCCESS)</font>
<font color="black">1548. </font>
<font color="red">1549.                 return HttpResponseRedirect(request.get_full_path())</font>
<font color="black">1550. </font>
<font color="black">1551.         # Handle GET -- construct a formset for display.</font>
<font color="red">1552.         elif cl.list_editable:</font>
<font color="red">1553.             FormSet = self.get_changelist_formset(request)</font>
<font color="red">1554.             formset = cl.formset = FormSet(queryset=cl.result_list)</font>
<font color="black">1555. </font>
<font color="black">1556.         # Build the list of media to be used by the formset.</font>
<font color="red">1557.         if formset:</font>
<font color="red">1558.             media = self.media + formset.media</font>
<font color="black">1559.         else:</font>
<font color="red">1560.             media = self.media</font>
<font color="black">1561. </font>
<font color="black">1562.         # Build the action form and populate it with available actions.</font>
<font color="red">1563.         if actions:</font>
<font color="red">1564.             action_form = self.action_form(auto_id=None)</font>
<font color="red">1565.             action_form.fields['action'].choices = self.get_action_choices(request)</font>
<font color="black">1566.         else:</font>
<font color="red">1567.             action_form = None</font>
<font color="black">1568. </font>
<font color="red">1569.         selection_note_all = ungettext('%(total_count)s selected',</font>
<font color="red">1570.             'All %(total_count)s selected', cl.result_count)</font>
<font color="black">1571. </font>
<font color="red">1572.         context = dict(</font>
<font color="red">1573.             self.admin_site.each_context(request),</font>
<font color="red">1574.             module_name=force_text(opts.verbose_name_plural),</font>
<font color="red">1575.             selection_note=_('0 of %(cnt)s selected') % {'cnt': len(cl.result_list)},</font>
<font color="red">1576.             selection_note_all=selection_note_all % {'total_count': cl.result_count},</font>
<font color="red">1577.             title=cl.title,</font>
<font color="red">1578.             is_popup=cl.is_popup,</font>
<font color="red">1579.             to_field=cl.to_field,</font>
<font color="red">1580.             cl=cl,</font>
<font color="red">1581.             media=media,</font>
<font color="red">1582.             has_add_permission=self.has_add_permission(request),</font>
<font color="red">1583.             opts=cl.opts,</font>
<font color="red">1584.             action_form=action_form,</font>
<font color="red">1585.             actions_on_top=self.actions_on_top,</font>
<font color="red">1586.             actions_on_bottom=self.actions_on_bottom,</font>
<font color="red">1587.             actions_selection_counter=self.actions_selection_counter,</font>
<font color="red">1588.             preserved_filters=self.get_preserved_filters(request),</font>
<font color="black">1589.         )</font>
<font color="red">1590.         context.update(extra_context or {})</font>
<font color="black">1591. </font>
<font color="red">1592.         request.current_app = self.admin_site.name</font>
<font color="black">1593. </font>
<font color="red">1594.         return TemplateResponse(request, self.change_list_template or [</font>
<font color="red">1595.             'admin/%s/%s/change_list.html' % (app_label, opts.model_name),</font>
<font color="red">1596.             'admin/%s/change_list.html' % app_label,</font>
<font color="red">1597.             'admin/change_list.html'</font>
<font color="red">1598.         ], context)</font>
<font color="black">1599. </font>
<font color="green">1600.     @csrf_protect_m</font>
<font color="green">1601.     @transaction.atomic</font>
<font color="green">1602.     def delete_view(self, request, object_id, extra_context=None):</font>
<font color="black">1603.         &quot;The 'delete' admin view for this model.&quot;</font>
<font color="red">1604.         opts = self.model._meta</font>
<font color="red">1605.         app_label = opts.app_label</font>
<font color="black">1606. </font>
<font color="red">1607.         to_field = request.POST.get(TO_FIELD_VAR, request.GET.get(TO_FIELD_VAR))</font>
<font color="red">1608.         if to_field and not self.to_field_allowed(request, to_field):</font>
<font color="red">1609.             raise DisallowedModelAdminToField(&quot;The field %s cannot be referenced.&quot; % to_field)</font>
<font color="black">1610. </font>
<font color="red">1611.         obj = self.get_object(request, unquote(object_id), to_field)</font>
<font color="black">1612. </font>
<font color="red">1613.         if not self.has_delete_permission(request, obj):</font>
<font color="red">1614.             raise PermissionDenied</font>
<font color="black">1615. </font>
<font color="red">1616.         if obj is None:</font>
<font color="red">1617.             raise Http404(</font>
<font color="red">1618.                 _('%(name)s object with primary key %(key)r does not exist.') %</font>
<font color="red">1619.                 {'name': force_text(opts.verbose_name), 'key': escape(object_id)}</font>
<font color="black">1620.             )</font>
<font color="black">1621. </font>
<font color="red">1622.         using = router.db_for_write(self.model)</font>
<font color="black">1623. </font>
<font color="black">1624.         # Populate deleted_objects, a data structure of all related objects that</font>
<font color="black">1625.         # will also be deleted.</font>
<font color="red">1626.         (deleted_objects, model_count, perms_needed, protected) = get_deleted_objects(</font>
<font color="red">1627.             [obj], opts, request.user, self.admin_site, using)</font>
<font color="black">1628. </font>
<font color="red">1629.         if request.POST:  # The user has already confirmed the deletion.</font>
<font color="red">1630.             if perms_needed:</font>
<font color="red">1631.                 raise PermissionDenied</font>
<font color="red">1632.             obj_display = force_text(obj)</font>
<font color="red">1633.             attr = str(to_field) if to_field else opts.pk.attname</font>
<font color="red">1634.             obj_id = obj.serializable_value(attr)</font>
<font color="red">1635.             self.log_deletion(request, obj, obj_display)</font>
<font color="red">1636.             self.delete_model(request, obj)</font>
<font color="black">1637. </font>
<font color="red">1638.             return self.response_delete(request, obj_display, obj_id)</font>
<font color="black">1639. </font>
<font color="red">1640.         object_name = force_text(opts.verbose_name)</font>
<font color="black">1641. </font>
<font color="red">1642.         if perms_needed or protected:</font>
<font color="red">1643.             title = _(&quot;Cannot delete %(name)s&quot;) % {&quot;name&quot;: object_name}</font>
<font color="black">1644.         else:</font>
<font color="red">1645.             title = _(&quot;Are you sure?&quot;)</font>
<font color="black">1646. </font>
<font color="red">1647.         context = dict(</font>
<font color="red">1648.             self.admin_site.each_context(request),</font>
<font color="red">1649.             title=title,</font>
<font color="red">1650.             object_name=object_name,</font>
<font color="red">1651.             object=obj,</font>
<font color="red">1652.             deleted_objects=deleted_objects,</font>
<font color="red">1653.             model_count=dict(model_count).items(),</font>
<font color="red">1654.             perms_lacking=perms_needed,</font>
<font color="red">1655.             protected=protected,</font>
<font color="red">1656.             opts=opts,</font>
<font color="red">1657.             app_label=app_label,</font>
<font color="red">1658.             preserved_filters=self.get_preserved_filters(request),</font>
<font color="red">1659.             is_popup=(IS_POPUP_VAR in request.POST or</font>
<font color="red">1660.                       IS_POPUP_VAR in request.GET),</font>
<font color="red">1661.             to_field=to_field,</font>
<font color="black">1662.         )</font>
<font color="red">1663.         context.update(extra_context or {})</font>
<font color="black">1664. </font>
<font color="red">1665.         return self.render_delete_form(request, context)</font>
<font color="black">1666. </font>
<font color="green">1667.     def history_view(self, request, object_id, extra_context=None):</font>
<font color="black">1668.         &quot;The 'history' admin view for this model.&quot;</font>
<font color="red">1669.         from django.contrib.admin.models import LogEntry</font>
<font color="black">1670.         # First check if the user can see this history.</font>
<font color="red">1671.         model = self.model</font>
<font color="red">1672.         obj = self.get_object(request, unquote(object_id))</font>
<font color="red">1673.         if obj is None:</font>
<font color="red">1674.             raise Http404(_('%(name)s object with primary key %(key)r does not exist.') % {</font>
<font color="red">1675.                 'name': force_text(model._meta.verbose_name),</font>
<font color="red">1676.                 'key': escape(object_id),</font>
<font color="black">1677.             })</font>
<font color="black">1678. </font>
<font color="red">1679.         if not self.has_change_permission(request, obj):</font>
<font color="red">1680.             raise PermissionDenied</font>
<font color="black">1681. </font>
<font color="black">1682.         # Then get the history for this object.</font>
<font color="red">1683.         opts = model._meta</font>
<font color="red">1684.         app_label = opts.app_label</font>
<font color="red">1685.         action_list = LogEntry.objects.filter(</font>
<font color="red">1686.             object_id=unquote(object_id),</font>
<font color="red">1687.             content_type=get_content_type_for_model(model)</font>
<font color="red">1688.         ).select_related().order_by('action_time')</font>
<font color="black">1689. </font>
<font color="red">1690.         context = dict(self.admin_site.each_context(request),</font>
<font color="red">1691.             title=_('Change history: %s') % force_text(obj),</font>
<font color="red">1692.             action_list=action_list,</font>
<font color="red">1693.             module_name=capfirst(force_text(opts.verbose_name_plural)),</font>
<font color="red">1694.             object=obj,</font>
<font color="red">1695.             opts=opts,</font>
<font color="red">1696.             preserved_filters=self.get_preserved_filters(request),</font>
<font color="black">1697.         )</font>
<font color="red">1698.         context.update(extra_context or {})</font>
<font color="black">1699. </font>
<font color="red">1700.         request.current_app = self.admin_site.name</font>
<font color="black">1701. </font>
<font color="red">1702.         return TemplateResponse(request, self.object_history_template or [</font>
<font color="red">1703.             &quot;admin/%s/%s/object_history.html&quot; % (app_label, opts.model_name),</font>
<font color="red">1704.             &quot;admin/%s/object_history.html&quot; % app_label,</font>
<font color="red">1705.             &quot;admin/object_history.html&quot;</font>
<font color="red">1706.         ], context)</font>
<font color="black">1707. </font>
<font color="green">1708.     def _create_formsets(self, request, obj, change):</font>
<font color="black">1709.         &quot;Helper function to generate formsets for add/change_view.&quot;</font>
<font color="red">1710.         formsets = []</font>
<font color="red">1711.         inline_instances = []</font>
<font color="red">1712.         prefixes = {}</font>
<font color="red">1713.         get_formsets_args = [request]</font>
<font color="red">1714.         if change:</font>
<font color="red">1715.             get_formsets_args.append(obj)</font>
<font color="red">1716.         for FormSet, inline in self.get_formsets_with_inlines(*get_formsets_args):</font>
<font color="red">1717.             prefix = FormSet.get_default_prefix()</font>
<font color="red">1718.             prefixes[prefix] = prefixes.get(prefix, 0) + 1</font>
<font color="red">1719.             if prefixes[prefix] != 1 or not prefix:</font>
<font color="red">1720.                 prefix = &quot;%s-%s&quot; % (prefix, prefixes[prefix])</font>
<font color="red">1721.             formset_params = {</font>
<font color="red">1722.                 'instance': obj,</font>
<font color="red">1723.                 'prefix': prefix,</font>
<font color="red">1724.                 'queryset': inline.get_queryset(request),</font>
<font color="black">1725.             }</font>
<font color="red">1726.             if request.method == 'POST':</font>
<font color="red">1727.                 formset_params.update({</font>
<font color="red">1728.                     'data': request.POST,</font>
<font color="red">1729.                     'files': request.FILES,</font>
<font color="red">1730.                     'save_as_new': '_saveasnew' in request.POST</font>
<font color="black">1731.                 })</font>
<font color="red">1732.             formsets.append(FormSet(**formset_params))</font>
<font color="red">1733.             inline_instances.append(inline)</font>
<font color="red">1734.         return formsets, inline_instances</font>
<font color="black">1735. </font>
<font color="black">1736. </font>
<font color="green">1737. class InlineModelAdmin(BaseModelAdmin):</font>
<font color="black">1738.     &quot;&quot;&quot;</font>
<font color="black">1739.     Options for inline editing of ``model`` instances.</font>
<font color="black">1740. </font>
<font color="black">1741.     Provide ``fk_name`` to specify the attribute name of the ``ForeignKey``</font>
<font color="black">1742.     from ``model`` to its parent. This is required if ``model`` has more than</font>
<font color="black">1743.     one ``ForeignKey`` to its parent.</font>
<font color="green">1744.     &quot;&quot;&quot;</font>
<font color="green">1745.     model = None</font>
<font color="green">1746.     fk_name = None</font>
<font color="green">1747.     formset = BaseInlineFormSet</font>
<font color="green">1748.     extra = 3</font>
<font color="green">1749.     min_num = None</font>
<font color="green">1750.     max_num = None</font>
<font color="green">1751.     template = None</font>
<font color="green">1752.     verbose_name = None</font>
<font color="green">1753.     verbose_name_plural = None</font>
<font color="green">1754.     can_delete = True</font>
<font color="green">1755.     show_change_link = False</font>
<font color="green">1756.     checks_class = InlineModelAdminChecks</font>
<font color="black">1757. </font>
<font color="green">1758.     def __init__(self, parent_model, admin_site):</font>
<font color="red">1759.         self.admin_site = admin_site</font>
<font color="red">1760.         self.parent_model = parent_model</font>
<font color="red">1761.         self.opts = self.model._meta</font>
<font color="red">1762.         self.has_registered_model = admin_site.is_registered(self.model)</font>
<font color="red">1763.         super(InlineModelAdmin, self).__init__()</font>
<font color="red">1764.         if self.verbose_name is None:</font>
<font color="red">1765.             self.verbose_name = self.model._meta.verbose_name</font>
<font color="red">1766.         if self.verbose_name_plural is None:</font>
<font color="red">1767.             self.verbose_name_plural = self.model._meta.verbose_name_plural</font>
<font color="black">1768. </font>
<font color="green">1769.     @property</font>
<font color="black">1770.     def media(self):</font>
<font color="red">1771.         extra = '' if settings.DEBUG else '.min'</font>
<font color="red">1772.         js = ['vendor/jquery/jquery%s.js' % extra, 'jquery.init.js',</font>
<font color="red">1773.               'inlines%s.js' % extra]</font>
<font color="red">1774.         if self.filter_vertical or self.filter_horizontal:</font>
<font color="red">1775.             js.extend(['SelectBox.js', 'SelectFilter2.js'])</font>
<font color="red">1776.         return forms.Media(js=[static('admin/js/%s' % url) for url in js])</font>
<font color="black">1777. </font>
<font color="green">1778.     def get_extra(self, request, obj=None, **kwargs):</font>
<font color="black">1779.         &quot;&quot;&quot;Hook for customizing the number of extra inline forms.&quot;&quot;&quot;</font>
<font color="red">1780.         return self.extra</font>
<font color="black">1781. </font>
<font color="green">1782.     def get_min_num(self, request, obj=None, **kwargs):</font>
<font color="black">1783.         &quot;&quot;&quot;Hook for customizing the min number of inline forms.&quot;&quot;&quot;</font>
<font color="red">1784.         return self.min_num</font>
<font color="black">1785. </font>
<font color="green">1786.     def get_max_num(self, request, obj=None, **kwargs):</font>
<font color="black">1787.         &quot;&quot;&quot;Hook for customizing the max number of extra inline forms.&quot;&quot;&quot;</font>
<font color="red">1788.         return self.max_num</font>
<font color="black">1789. </font>
<font color="green">1790.     def get_formset(self, request, obj=None, **kwargs):</font>
<font color="black">1791.         &quot;&quot;&quot;Returns a BaseInlineFormSet class for use in admin add/change views.&quot;&quot;&quot;</font>
<font color="red">1792.         if 'fields' in kwargs:</font>
<font color="red">1793.             fields = kwargs.pop('fields')</font>
<font color="black">1794.         else:</font>
<font color="red">1795.             fields = flatten_fieldsets(self.get_fieldsets(request, obj))</font>
<font color="red">1796.         if self.exclude is None:</font>
<font color="red">1797.             exclude = []</font>
<font color="black">1798.         else:</font>
<font color="red">1799.             exclude = list(self.exclude)</font>
<font color="red">1800.         exclude.extend(self.get_readonly_fields(request, obj))</font>
<font color="red">1801.         if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:</font>
<font color="black">1802.             # Take the custom ModelForm's Meta.exclude into account only if the</font>
<font color="black">1803.             # InlineModelAdmin doesn't define its own.</font>
<font color="red">1804.             exclude.extend(self.form._meta.exclude)</font>
<font color="black">1805.         # If exclude is an empty list we use None, since that's the actual</font>
<font color="black">1806.         # default.</font>
<font color="red">1807.         exclude = exclude or None</font>
<font color="red">1808.         can_delete = self.can_delete and self.has_delete_permission(request, obj)</font>
<font color="red">1809.         defaults = {</font>
<font color="red">1810.             &quot;form&quot;: self.form,</font>
<font color="red">1811.             &quot;formset&quot;: self.formset,</font>
<font color="red">1812.             &quot;fk_name&quot;: self.fk_name,</font>
<font color="red">1813.             &quot;fields&quot;: fields,</font>
<font color="red">1814.             &quot;exclude&quot;: exclude,</font>
<font color="red">1815.             &quot;formfield_callback&quot;: partial(self.formfield_for_dbfield, request=request),</font>
<font color="red">1816.             &quot;extra&quot;: self.get_extra(request, obj, **kwargs),</font>
<font color="red">1817.             &quot;min_num&quot;: self.get_min_num(request, obj, **kwargs),</font>
<font color="red">1818.             &quot;max_num&quot;: self.get_max_num(request, obj, **kwargs),</font>
<font color="red">1819.             &quot;can_delete&quot;: can_delete,</font>
<font color="black">1820.         }</font>
<font color="black">1821. </font>
<font color="red">1822.         defaults.update(kwargs)</font>
<font color="red">1823.         base_model_form = defaults['form']</font>
<font color="black">1824. </font>
<font color="red">1825.         class DeleteProtectedModelForm(base_model_form):</font>
<font color="red">1826.             def hand_clean_DELETE(self):</font>
<font color="black">1827.                 &quot;&quot;&quot;</font>
<font color="black">1828.                 We don't validate the 'DELETE' field itself because on</font>
<font color="black">1829.                 templates it's not rendered using the field information, but</font>
<font color="black">1830.                 just using a generic &quot;deletion_field&quot; of the InlineModelAdmin.</font>
<font color="black">1831.                 &quot;&quot;&quot;</font>
<font color="red">1832.                 if self.cleaned_data.get(DELETION_FIELD_NAME, False):</font>
<font color="red">1833.                     using = router.db_for_write(self._meta.model)</font>
<font color="red">1834.                     collector = NestedObjects(using=using)</font>
<font color="red">1835.                     if self.instance.pk is None:</font>
<font color="red">1836.                         return</font>
<font color="red">1837.                     collector.collect([self.instance])</font>
<font color="red">1838.                     if collector.protected:</font>
<font color="red">1839.                         objs = []</font>
<font color="red">1840.                         for p in collector.protected:</font>
<font color="red">1841.                             objs.append(</font>
<font color="black">1842.                                 # Translators: Model verbose name and instance representation,</font>
<font color="black">1843.                                 # suitable to be an item in a list.</font>
<font color="red">1844.                                 _('%(class_name)s %(instance)s') % {</font>
<font color="red">1845.                                     'class_name': p._meta.verbose_name,</font>
<font color="red">1846.                                     'instance': p}</font>
<font color="black">1847.                             )</font>
<font color="red">1848.                         params = {'class_name': self._meta.model._meta.verbose_name,</font>
<font color="red">1849.                                   'instance': self.instance,</font>
<font color="red">1850.                                   'related_objects': get_text_list(objs, _('and'))}</font>
<font color="red">1851.                         msg = _(&quot;Deleting %(class_name)s %(instance)s would require &quot;</font>
<font color="black">1852.                                 &quot;deleting the following protected related objects: &quot;</font>
<font color="black">1853.                                 &quot;%(related_objects)s&quot;)</font>
<font color="red">1854.                         raise ValidationError(msg, code='deleting_protected', params=params)</font>
<font color="black">1855. </font>
<font color="red">1856.             def is_valid(self):</font>
<font color="red">1857.                 result = super(DeleteProtectedModelForm, self).is_valid()</font>
<font color="red">1858.                 self.hand_clean_DELETE()</font>
<font color="red">1859.                 return result</font>
<font color="black">1860. </font>
<font color="red">1861.         defaults['form'] = DeleteProtectedModelForm</font>
<font color="black">1862. </font>
<font color="red">1863.         if defaults['fields'] is None and not modelform_defines_fields(defaults['form']):</font>
<font color="red">1864.             defaults['fields'] = forms.ALL_FIELDS</font>
<font color="black">1865. </font>
<font color="red">1866.         return inlineformset_factory(self.parent_model, self.model, **defaults)</font>
<font color="black">1867. </font>
<font color="green">1868.     def get_fields(self, request, obj=None):</font>
<font color="red">1869.         if self.fields:</font>
<font color="red">1870.             return self.fields</font>
<font color="red">1871.         form = self.get_formset(request, obj, fields=None).form</font>
<font color="red">1872.         return list(form.base_fields) + list(self.get_readonly_fields(request, obj))</font>
<font color="black">1873. </font>
<font color="green">1874.     def get_queryset(self, request):</font>
<font color="red">1875.         queryset = super(InlineModelAdmin, self).get_queryset(request)</font>
<font color="red">1876.         if not self.has_change_permission(request):</font>
<font color="red">1877.             queryset = queryset.none()</font>
<font color="red">1878.         return queryset</font>
<font color="black">1879. </font>
<font color="green">1880.     def has_add_permission(self, request):</font>
<font color="red">1881.         if self.opts.auto_created:</font>
<font color="black">1882.             # We're checking the rights to an auto-created intermediate model,</font>
<font color="black">1883.             # which doesn't have its own individual permissions. The user needs</font>
<font color="black">1884.             # to have the change permission for the related model in order to</font>
<font color="black">1885.             # be able to do anything with the intermediate model.</font>
<font color="red">1886.             return self.has_change_permission(request)</font>
<font color="red">1887.         return super(InlineModelAdmin, self).has_add_permission(request)</font>
<font color="black">1888. </font>
<font color="green">1889.     def has_change_permission(self, request, obj=None):</font>
<font color="red">1890.         opts = self.opts</font>
<font color="red">1891.         if opts.auto_created:</font>
<font color="black">1892.             # The model was auto-created as intermediary for a</font>
<font color="black">1893.             # ManyToMany-relationship, find the target model</font>
<font color="red">1894.             for field in opts.fields:</font>
<font color="red">1895.                 if field.remote_field and field.remote_field.model != self.parent_model:</font>
<font color="red">1896.                     opts = field.remote_field.model._meta</font>
<font color="red">1897.                     break</font>
<font color="red">1898.         codename = get_permission_codename('change', opts)</font>
<font color="red">1899.         return request.user.has_perm(&quot;%s.%s&quot; % (opts.app_label, codename))</font>
<font color="black">1900. </font>
<font color="green">1901.     def has_delete_permission(self, request, obj=None):</font>
<font color="red">1902.         if self.opts.auto_created:</font>
<font color="black">1903.             # We're checking the rights to an auto-created intermediate model,</font>
<font color="black">1904.             # which doesn't have its own individual permissions. The user needs</font>
<font color="black">1905.             # to have the change permission for the related model in order to</font>
<font color="black">1906.             # be able to do anything with the intermediate model.</font>
<font color="red">1907.             return self.has_change_permission(request, obj)</font>
<font color="red">1908.         return super(InlineModelAdmin, self).has_delete_permission(request, obj)</font>
<font color="black">1909. </font>
<font color="black">1910. </font>
<font color="green">1911. class StackedInline(InlineModelAdmin):</font>
<font color="green">1912.     template = 'admin/edit_inline/stacked.html'</font>
<font color="black">1913. </font>
<font color="black">1914. </font>
<font color="green">1915. class TabularInline(InlineModelAdmin):</font>
<font color="green">1916.     template = 'admin/edit_inline/tabular.html'</font>
</pre>


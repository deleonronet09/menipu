source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/utils/autoreload.py</b><br>


file stats: <b>209 lines, 42 executed: 20.1% covered</b>
<pre>
<font color="black">   1. # Autoreloading launcher.</font>
<font color="black">   2. # Borrowed from Peter Hunt and the CherryPy project (http://www.cherrypy.org).</font>
<font color="black">   3. # Some taken from Ian Bicking's Paste (http://pythonpaste.org/).</font>
<font color="black">   4. #</font>
<font color="black">   5. # Portions copyright (c) 2004, CherryPy Team (team@cherrypy.org)</font>
<font color="black">   6. # All rights reserved.</font>
<font color="black">   7. #</font>
<font color="black">   8. # Redistribution and use in source and binary forms, with or without modification,</font>
<font color="black">   9. # are permitted provided that the following conditions are met:</font>
<font color="black">  10. #</font>
<font color="black">  11. #     * Redistributions of source code must retain the above copyright notice,</font>
<font color="black">  12. #       this list of conditions and the following disclaimer.</font>
<font color="black">  13. #     * Redistributions in binary form must reproduce the above copyright notice,</font>
<font color="black">  14. #       this list of conditions and the following disclaimer in the documentation</font>
<font color="black">  15. #       and/or other materials provided with the distribution.</font>
<font color="black">  16. #     * Neither the name of the CherryPy Team nor the names of its contributors</font>
<font color="black">  17. #       may be used to endorse or promote products derived from this software</font>
<font color="black">  18. #       without specific prior written permission.</font>
<font color="black">  19. #</font>
<font color="black">  20. # THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</font>
<font color="black">  21. # ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</font>
<font color="black">  22. # WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</font>
<font color="black">  23. # DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE</font>
<font color="black">  24. # FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</font>
<font color="black">  25. # DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</font>
<font color="black">  26. # SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</font>
<font color="black">  27. # CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</font>
<font color="black">  28. # OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</font>
<font color="black">  29. # OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</font>
<font color="black">  30. </font>
<font color="green">  31. import os</font>
<font color="green">  32. import signal</font>
<font color="green">  33. import sys</font>
<font color="green">  34. import time</font>
<font color="green">  35. import traceback</font>
<font color="black">  36. </font>
<font color="green">  37. from django.apps import apps</font>
<font color="green">  38. from django.conf import settings</font>
<font color="green">  39. from django.core.signals import request_finished</font>
<font color="green">  40. from django.utils import six</font>
<font color="green">  41. from django.utils._os import npath</font>
<font color="green">  42. from django.utils.six.moves import _thread as thread</font>
<font color="black">  43. </font>
<font color="black">  44. # This import does nothing, but it's necessary to avoid some race conditions</font>
<font color="black">  45. # in the threading module. See http://code.djangoproject.com/ticket/2330 .</font>
<font color="green">  46. try:</font>
<font color="green">  47.     import threading  # NOQA</font>
<font color="red">  48. except ImportError:</font>
<font color="red">  49.     pass</font>
<font color="black">  50. </font>
<font color="green">  51. try:</font>
<font color="green">  52.     import termios</font>
<font color="red">  53. except ImportError:</font>
<font color="red">  54.     termios = None</font>
<font color="black">  55. </font>
<font color="green">  56. USE_INOTIFY = False</font>
<font color="green">  57. try:</font>
<font color="black">  58.     # Test whether inotify is enabled and likely to work</font>
<font color="green">  59.     import pyinotify</font>
<font color="black">  60. </font>
<font color="red">  61.     fd = pyinotify.INotifyWrapper.create().inotify_init()</font>
<font color="red">  62.     if fd &gt;= 0:</font>
<font color="red">  63.         USE_INOTIFY = True</font>
<font color="red">  64.         os.close(fd)</font>
<font color="green">  65. except ImportError:</font>
<font color="green">  66.     pass</font>
<font color="black">  67. </font>
<font color="green">  68. RUN_RELOADER = True</font>
<font color="black">  69. </font>
<font color="green">  70. FILE_MODIFIED = 1</font>
<font color="green">  71. I18N_MODIFIED = 2</font>
<font color="black">  72. </font>
<font color="green">  73. _mtimes = {}</font>
<font color="green">  74. _win = (sys.platform == &quot;win32&quot;)</font>
<font color="black">  75. </font>
<font color="green">  76. _exception = None</font>
<font color="green">  77. _error_files = []</font>
<font color="green">  78. _cached_modules = set()</font>
<font color="green">  79. _cached_filenames = []</font>
<font color="black">  80. </font>
<font color="black">  81. </font>
<font color="green">  82. def gen_filenames(only_new=False):</font>
<font color="black">  83.     &quot;&quot;&quot;</font>
<font color="black">  84.     Returns a list of filenames referenced in sys.modules and translation</font>
<font color="black">  85.     files.</font>
<font color="black">  86.     &quot;&quot;&quot;</font>
<font color="black">  87.     # N.B. ``list(...)`` is needed, because this runs in parallel with</font>
<font color="black">  88.     # application code which might be mutating ``sys.modules``, and this will</font>
<font color="black">  89.     # fail with RuntimeError: cannot mutate dictionary while iterating</font>
<font color="black">  90.     global _cached_modules, _cached_filenames</font>
<font color="red">  91.     module_values = set(sys.modules.values())</font>
<font color="red">  92.     _cached_filenames = clean_files(_cached_filenames)</font>
<font color="red">  93.     if _cached_modules == module_values:</font>
<font color="black">  94.         # No changes in module list, short-circuit the function</font>
<font color="red">  95.         if only_new:</font>
<font color="red">  96.             return []</font>
<font color="black">  97.         else:</font>
<font color="red">  98.             return _cached_filenames + clean_files(_error_files)</font>
<font color="black">  99. </font>
<font color="red"> 100.     new_modules = module_values - _cached_modules</font>
<font color="red"> 101.     new_filenames = clean_files(</font>
<font color="red"> 102.         [filename.__file__ for filename in new_modules</font>
<font color="red"> 103.          if hasattr(filename, '__file__')])</font>
<font color="black"> 104. </font>
<font color="red"> 105.     if not _cached_filenames and settings.USE_I18N:</font>
<font color="black"> 106.         # Add the names of the .mo files that can be generated</font>
<font color="black"> 107.         # by compilemessages management command to the list of files watched.</font>
<font color="red"> 108.         basedirs = [os.path.join(os.path.dirname(os.path.dirname(__file__)),</font>
<font color="red"> 109.                                  'conf', 'locale'),</font>
<font color="red"> 110.                     'locale']</font>
<font color="red"> 111.         for app_config in reversed(list(apps.get_app_configs())):</font>
<font color="red"> 112.             basedirs.append(os.path.join(npath(app_config.path), 'locale'))</font>
<font color="red"> 113.         basedirs.extend(settings.LOCALE_PATHS)</font>
<font color="red"> 114.         basedirs = [os.path.abspath(basedir) for basedir in basedirs</font>
<font color="red"> 115.                     if os.path.isdir(basedir)]</font>
<font color="red"> 116.         for basedir in basedirs:</font>
<font color="red"> 117.             for dirpath, dirnames, locale_filenames in os.walk(basedir):</font>
<font color="red"> 118.                 for filename in locale_filenames:</font>
<font color="red"> 119.                     if filename.endswith('.mo'):</font>
<font color="red"> 120.                         new_filenames.append(os.path.join(dirpath, filename))</font>
<font color="black"> 121. </font>
<font color="red"> 122.     _cached_modules = _cached_modules.union(new_modules)</font>
<font color="red"> 123.     _cached_filenames += new_filenames</font>
<font color="red"> 124.     if only_new:</font>
<font color="red"> 125.         return new_filenames + clean_files(_error_files)</font>
<font color="black"> 126.     else:</font>
<font color="red"> 127.         return _cached_filenames + clean_files(_error_files)</font>
<font color="black"> 128. </font>
<font color="black"> 129. </font>
<font color="green"> 130. def clean_files(filelist):</font>
<font color="red"> 131.     filenames = []</font>
<font color="red"> 132.     for filename in filelist:</font>
<font color="red"> 133.         if not filename:</font>
<font color="red"> 134.             continue</font>
<font color="red"> 135.         if filename.endswith(&quot;.pyc&quot;) or filename.endswith(&quot;.pyo&quot;):</font>
<font color="red"> 136.             filename = filename[:-1]</font>
<font color="red"> 137.         if filename.endswith(&quot;$py.class&quot;):</font>
<font color="red"> 138.             filename = filename[:-9] + &quot;.py&quot;</font>
<font color="red"> 139.         if os.path.exists(filename):</font>
<font color="red"> 140.             filenames.append(filename)</font>
<font color="red"> 141.     return filenames</font>
<font color="black"> 142. </font>
<font color="black"> 143. </font>
<font color="green"> 144. def reset_translations():</font>
<font color="red"> 145.     import gettext</font>
<font color="red"> 146.     from django.utils.translation import trans_real</font>
<font color="red"> 147.     gettext._translations = {}</font>
<font color="red"> 148.     trans_real._translations = {}</font>
<font color="red"> 149.     trans_real._default = None</font>
<font color="red"> 150.     trans_real._active = threading.local()</font>
<font color="black"> 151. </font>
<font color="black"> 152. </font>
<font color="green"> 153. def inotify_code_changed():</font>
<font color="black"> 154.     &quot;&quot;&quot;</font>
<font color="black"> 155.     Checks for changed code using inotify. After being called</font>
<font color="black"> 156.     it blocks until a change event has been fired.</font>
<font color="black"> 157.     &quot;&quot;&quot;</font>
<font color="red"> 158.     class EventHandler(pyinotify.ProcessEvent):</font>
<font color="red"> 159.         modified_code = None</font>
<font color="black"> 160. </font>
<font color="red"> 161.         def process_default(self, event):</font>
<font color="red"> 162.             if event.path.endswith('.mo'):</font>
<font color="red"> 163.                 EventHandler.modified_code = I18N_MODIFIED</font>
<font color="black"> 164.             else:</font>
<font color="red"> 165.                 EventHandler.modified_code = FILE_MODIFIED</font>
<font color="black"> 166. </font>
<font color="red"> 167.     wm = pyinotify.WatchManager()</font>
<font color="red"> 168.     notifier = pyinotify.Notifier(wm, EventHandler())</font>
<font color="black"> 169. </font>
<font color="red"> 170.     def update_watch(sender=None, **kwargs):</font>
<font color="red"> 171.         if sender and getattr(sender, 'handles_files', False):</font>
<font color="black"> 172.             # No need to update watches when request serves files.</font>
<font color="black"> 173.             # (sender is supposed to be a django.core.handlers.BaseHandler subclass)</font>
<font color="red"> 174.             return</font>
<font color="black"> 175.         mask = (</font>
<font color="black"> 176.             pyinotify.IN_MODIFY |</font>
<font color="black"> 177.             pyinotify.IN_DELETE |</font>
<font color="black"> 178.             pyinotify.IN_ATTRIB |</font>
<font color="black"> 179.             pyinotify.IN_MOVED_FROM |</font>
<font color="black"> 180.             pyinotify.IN_MOVED_TO |</font>
<font color="black"> 181.             pyinotify.IN_CREATE |</font>
<font color="red"> 182.             pyinotify.IN_DELETE_SELF |</font>
<font color="red"> 183.             pyinotify.IN_MOVE_SELF</font>
<font color="black"> 184.         )</font>
<font color="red"> 185.         for path in gen_filenames(only_new=True):</font>
<font color="red"> 186.             wm.add_watch(path, mask)</font>
<font color="black"> 187. </font>
<font color="black"> 188.     # New modules may get imported when a request is processed.</font>
<font color="red"> 189.     request_finished.connect(update_watch)</font>
<font color="black"> 190. </font>
<font color="black"> 191.     # Block until an event happens.</font>
<font color="red"> 192.     update_watch()</font>
<font color="red"> 193.     notifier.check_events(timeout=None)</font>
<font color="red"> 194.     notifier.read_events()</font>
<font color="red"> 195.     notifier.process_events()</font>
<font color="red"> 196.     notifier.stop()</font>
<font color="black"> 197. </font>
<font color="black"> 198.     # If we are here the code must have changed.</font>
<font color="red"> 199.     return EventHandler.modified_code</font>
<font color="black"> 200. </font>
<font color="black"> 201. </font>
<font color="green"> 202. def code_changed():</font>
<font color="black"> 203.     global _mtimes, _win</font>
<font color="red"> 204.     for filename in gen_filenames():</font>
<font color="red"> 205.         stat = os.stat(filename)</font>
<font color="red"> 206.         mtime = stat.st_mtime</font>
<font color="red"> 207.         if _win:</font>
<font color="red"> 208.             mtime -= stat.st_ctime</font>
<font color="red"> 209.         if filename not in _mtimes:</font>
<font color="red"> 210.             _mtimes[filename] = mtime</font>
<font color="red"> 211.             continue</font>
<font color="red"> 212.         if mtime != _mtimes[filename]:</font>
<font color="red"> 213.             _mtimes = {}</font>
<font color="red"> 214.             try:</font>
<font color="red"> 215.                 del _error_files[_error_files.index(filename)]</font>
<font color="red"> 216.             except ValueError:</font>
<font color="red"> 217.                 pass</font>
<font color="red"> 218.             return I18N_MODIFIED if filename.endswith('.mo') else FILE_MODIFIED</font>
<font color="red"> 219.     return False</font>
<font color="black"> 220. </font>
<font color="black"> 221. </font>
<font color="green"> 222. def check_errors(fn):</font>
<font color="red"> 223.     def wrapper(*args, **kwargs):</font>
<font color="black"> 224.         global _exception</font>
<font color="red"> 225.         try:</font>
<font color="red"> 226.             fn(*args, **kwargs)</font>
<font color="red"> 227.         except Exception:</font>
<font color="red"> 228.             _exception = sys.exc_info()</font>
<font color="black"> 229. </font>
<font color="red"> 230.             et, ev, tb = _exception</font>
<font color="black"> 231. </font>
<font color="red"> 232.             if getattr(ev, 'filename', None) is None:</font>
<font color="black"> 233.                 # get the filename from the last item in the stack</font>
<font color="red"> 234.                 filename = traceback.extract_tb(tb)[-1][0]</font>
<font color="black"> 235.             else:</font>
<font color="red"> 236.                 filename = ev.filename</font>
<font color="black"> 237. </font>
<font color="red"> 238.             if filename not in _error_files:</font>
<font color="red"> 239.                 _error_files.append(filename)</font>
<font color="black"> 240. </font>
<font color="red"> 241.             raise</font>
<font color="black"> 242. </font>
<font color="red"> 243.     return wrapper</font>
<font color="black"> 244. </font>
<font color="black"> 245. </font>
<font color="green"> 246. def raise_last_exception():</font>
<font color="black"> 247.     global _exception</font>
<font color="red"> 248.     if _exception is not None:</font>
<font color="red"> 249.         six.reraise(*_exception)</font>
<font color="black"> 250. </font>
<font color="black"> 251. </font>
<font color="green"> 252. def ensure_echo_on():</font>
<font color="red"> 253.     if termios:</font>
<font color="red"> 254.         fd = sys.stdin</font>
<font color="red"> 255.         if fd.isatty():</font>
<font color="red"> 256.             attr_list = termios.tcgetattr(fd)</font>
<font color="red"> 257.             if not attr_list[3] &amp; termios.ECHO:</font>
<font color="red"> 258.                 attr_list[3] |= termios.ECHO</font>
<font color="red"> 259.                 if hasattr(signal, 'SIGTTOU'):</font>
<font color="red"> 260.                     old_handler = signal.signal(signal.SIGTTOU, signal.SIG_IGN)</font>
<font color="black"> 261.                 else:</font>
<font color="red"> 262.                     old_handler = None</font>
<font color="red"> 263.                 termios.tcsetattr(fd, termios.TCSANOW, attr_list)</font>
<font color="red"> 264.                 if old_handler is not None:</font>
<font color="red"> 265.                     signal.signal(signal.SIGTTOU, old_handler)</font>
<font color="black"> 266. </font>
<font color="black"> 267. </font>
<font color="green"> 268. def reloader_thread():</font>
<font color="red"> 269.     ensure_echo_on()</font>
<font color="red"> 270.     if USE_INOTIFY:</font>
<font color="red"> 271.         fn = inotify_code_changed</font>
<font color="black"> 272.     else:</font>
<font color="red"> 273.         fn = code_changed</font>
<font color="red"> 274.     while RUN_RELOADER:</font>
<font color="red"> 275.         change = fn()</font>
<font color="red"> 276.         if change == FILE_MODIFIED:</font>
<font color="red"> 277.             sys.exit(3)  # force reload</font>
<font color="red"> 278.         elif change == I18N_MODIFIED:</font>
<font color="red"> 279.             reset_translations()</font>
<font color="red"> 280.         time.sleep(1)</font>
<font color="black"> 281. </font>
<font color="black"> 282. </font>
<font color="green"> 283. def restart_with_reloader():</font>
<font color="red"> 284.     while True:</font>
<font color="red"> 285.         args = [sys.executable] + ['-W%s' % o for o in sys.warnoptions] + sys.argv</font>
<font color="red"> 286.         if sys.platform == &quot;win32&quot;:</font>
<font color="red"> 287.             args = ['&quot;%s&quot;' % arg for arg in args]</font>
<font color="red"> 288.         new_environ = os.environ.copy()</font>
<font color="red"> 289.         new_environ[&quot;RUN_MAIN&quot;] = 'true'</font>
<font color="red"> 290.         exit_code = os.spawnve(os.P_WAIT, sys.executable, args, new_environ)</font>
<font color="red"> 291.         if exit_code != 3:</font>
<font color="red"> 292.             return exit_code</font>
<font color="black"> 293. </font>
<font color="black"> 294. </font>
<font color="green"> 295. def python_reloader(main_func, args, kwargs):</font>
<font color="red"> 296.     if os.environ.get(&quot;RUN_MAIN&quot;) == &quot;true&quot;:</font>
<font color="red"> 297.         thread.start_new_thread(main_func, args, kwargs)</font>
<font color="red"> 298.         try:</font>
<font color="red"> 299.             reloader_thread()</font>
<font color="red"> 300.         except KeyboardInterrupt:</font>
<font color="red"> 301.             pass</font>
<font color="black"> 302.     else:</font>
<font color="red"> 303.         try:</font>
<font color="red"> 304.             exit_code = restart_with_reloader()</font>
<font color="red"> 305.             if exit_code &lt; 0:</font>
<font color="red"> 306.                 os.kill(os.getpid(), -exit_code)</font>
<font color="black"> 307.             else:</font>
<font color="red"> 308.                 sys.exit(exit_code)</font>
<font color="red"> 309.         except KeyboardInterrupt:</font>
<font color="red"> 310.             pass</font>
<font color="black"> 311. </font>
<font color="black"> 312. </font>
<font color="green"> 313. def jython_reloader(main_func, args, kwargs):</font>
<font color="red"> 314.     from _systemrestart import SystemRestart</font>
<font color="red"> 315.     thread.start_new_thread(main_func, args)</font>
<font color="red"> 316.     while True:</font>
<font color="red"> 317.         if code_changed():</font>
<font color="red"> 318.             raise SystemRestart</font>
<font color="red"> 319.         time.sleep(1)</font>
<font color="black"> 320. </font>
<font color="black"> 321. </font>
<font color="green"> 322. def main(main_func, args=None, kwargs=None):</font>
<font color="red"> 323.     if args is None:</font>
<font color="red"> 324.         args = ()</font>
<font color="red"> 325.     if kwargs is None:</font>
<font color="red"> 326.         kwargs = {}</font>
<font color="red"> 327.     if sys.platform.startswith('java'):</font>
<font color="red"> 328.         reloader = jython_reloader</font>
<font color="black"> 329.     else:</font>
<font color="red"> 330.         reloader = python_reloader</font>
<font color="black"> 331. </font>
<font color="red"> 332.     wrapped_main_func = check_errors(main_func)</font>
<font color="red"> 333.     reloader(wrapped_main_func, args, kwargs)</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/migrations/recorder.py</b><br>


file stats: <b>43 lines, 37 executed: 86.0% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. from django.apps.registry import Apps</font>
<font color="green">   4. from django.db import models</font>
<font color="green">   5. from django.db.utils import DatabaseError</font>
<font color="green">   6. from django.utils.encoding import python_2_unicode_compatible</font>
<font color="green">   7. from django.utils.timezone import now</font>
<font color="black">   8. </font>
<font color="green">   9. from .exceptions import MigrationSchemaMissing</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. class MigrationRecorder(object):</font>
<font color="black">  13.     &quot;&quot;&quot;</font>
<font color="black">  14.     Deals with storing migration records in the database.</font>
<font color="black">  15. </font>
<font color="black">  16.     Because this table is actually itself used for dealing with model</font>
<font color="black">  17.     creation, it's the one thing we can't do normally via migrations.</font>
<font color="black">  18.     We manually handle table creation/schema updating (using schema backend)</font>
<font color="black">  19.     and then have a floating model to do queries with.</font>
<font color="black">  20. </font>
<font color="black">  21.     If a migration is unapplied its row is removed from the table. Having</font>
<font color="black">  22.     a row in the table always means a migration is applied.</font>
<font color="green">  23.     &quot;&quot;&quot;</font>
<font color="black">  24. </font>
<font color="green">  25.     @python_2_unicode_compatible</font>
<font color="green">  26.     class Migration(models.Model):</font>
<font color="green">  27.         app = models.CharField(max_length=255)</font>
<font color="green">  28.         name = models.CharField(max_length=255)</font>
<font color="green">  29.         applied = models.DateTimeField(default=now)</font>
<font color="black">  30. </font>
<font color="green">  31.         class Meta:</font>
<font color="green">  32.             apps = Apps()</font>
<font color="green">  33.             app_label = &quot;migrations&quot;</font>
<font color="green">  34.             db_table = &quot;django_migrations&quot;</font>
<font color="black">  35. </font>
<font color="green">  36.         def __str__(self):</font>
<font color="red">  37.             return &quot;Migration %s for %s&quot; % (self.name, self.app)</font>
<font color="black">  38. </font>
<font color="green">  39.     def __init__(self, connection):</font>
<font color="green">  40.         self.connection = connection</font>
<font color="black">  41. </font>
<font color="green">  42.     @property</font>
<font color="black">  43.     def migration_qs(self):</font>
<font color="green">  44.         return self.Migration.objects.using(self.connection.alias)</font>
<font color="black">  45. </font>
<font color="green">  46.     def ensure_schema(self):</font>
<font color="black">  47.         &quot;&quot;&quot;</font>
<font color="black">  48.         Ensures the table exists and has the correct schema.</font>
<font color="black">  49.         &quot;&quot;&quot;</font>
<font color="black">  50.         # If the table's there, that's fine - we've never changed its schema</font>
<font color="black">  51.         # in the codebase.</font>
<font color="green">  52.         if self.Migration._meta.db_table in self.connection.introspection.table_names(self.connection.cursor()):</font>
<font color="green">  53.             return</font>
<font color="black">  54.         # Make the table</font>
<font color="green">  55.         try:</font>
<font color="green">  56.             with self.connection.schema_editor() as editor:</font>
<font color="green">  57.                 editor.create_model(self.Migration)</font>
<font color="red">  58.         except DatabaseError as exc:</font>
<font color="red">  59.             raise MigrationSchemaMissing(&quot;Unable to create the django_migrations table (%s)&quot; % exc)</font>
<font color="black">  60. </font>
<font color="green">  61.     def applied_migrations(self):</font>
<font color="black">  62.         &quot;&quot;&quot;</font>
<font color="black">  63.         Returns a set of (app, name) of applied migrations.</font>
<font color="black">  64.         &quot;&quot;&quot;</font>
<font color="green">  65.         self.ensure_schema()</font>
<font color="green">  66.         return set(tuple(x) for x in self.migration_qs.values_list(&quot;app&quot;, &quot;name&quot;))</font>
<font color="black">  67. </font>
<font color="green">  68.     def record_applied(self, app, name):</font>
<font color="black">  69.         &quot;&quot;&quot;</font>
<font color="black">  70.         Records that a migration was applied.</font>
<font color="black">  71.         &quot;&quot;&quot;</font>
<font color="green">  72.         self.ensure_schema()</font>
<font color="green">  73.         self.migration_qs.create(app=app, name=name)</font>
<font color="black">  74. </font>
<font color="green">  75.     def record_unapplied(self, app, name):</font>
<font color="black">  76.         &quot;&quot;&quot;</font>
<font color="black">  77.         Records that a migration was unapplied.</font>
<font color="black">  78.         &quot;&quot;&quot;</font>
<font color="red">  79.         self.ensure_schema()</font>
<font color="red">  80.         self.migration_qs.filter(app=app, name=name).delete()</font>
<font color="black">  81. </font>
<font color="green">  82.     def flush(self):</font>
<font color="black">  83.         &quot;&quot;&quot;</font>
<font color="black">  84.         Deletes all migration records. Useful if you're testing migrations.</font>
<font color="black">  85.         &quot;&quot;&quot;</font>
<font color="red">  86.         self.migration_qs.all().delete()</font>
</pre>


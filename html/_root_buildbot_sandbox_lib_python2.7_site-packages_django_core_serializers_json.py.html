source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/serializers/json.py</b><br>


file stats: <b>83 lines, 45 executed: 54.2% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Serialize data to/from JSON</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="black">   4. </font>
<font color="black">   5. # Avoid shadowing the standard library json module</font>
<font color="green">   6. from __future__ import absolute_import, unicode_literals</font>
<font color="black">   7. </font>
<font color="green">   8. import datetime</font>
<font color="green">   9. import decimal</font>
<font color="green">  10. import json</font>
<font color="green">  11. import sys</font>
<font color="green">  12. import uuid</font>
<font color="black">  13. </font>
<font color="green">  14. from django.core.serializers.base import DeserializationError</font>
<font color="green">  15. from django.core.serializers.python import (</font>
<font color="black">  16.     Deserializer as PythonDeserializer, Serializer as PythonSerializer,</font>
<font color="black">  17. )</font>
<font color="green">  18. from django.utils import six</font>
<font color="green">  19. from django.utils.timezone import is_aware</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. class Serializer(PythonSerializer):</font>
<font color="black">  23.     &quot;&quot;&quot;</font>
<font color="black">  24.     Convert a queryset to JSON.</font>
<font color="green">  25.     &quot;&quot;&quot;</font>
<font color="green">  26.     internal_use_only = False</font>
<font color="black">  27. </font>
<font color="green">  28.     def _init_options(self):</font>
<font color="green">  29.         if json.__version__.split('.') &gt;= ['2', '1', '3']:</font>
<font color="black">  30.             # Use JS strings to represent Python Decimal instances (ticket #16850)</font>
<font color="red">  31.             self.options.update({'use_decimal': False})</font>
<font color="green">  32.         self._current = None</font>
<font color="green">  33.         self.json_kwargs = self.options.copy()</font>
<font color="green">  34.         self.json_kwargs.pop('stream', None)</font>
<font color="green">  35.         self.json_kwargs.pop('fields', None)</font>
<font color="green">  36.         if self.options.get('indent'):</font>
<font color="black">  37.             # Prevent trailing spaces</font>
<font color="red">  38.             self.json_kwargs['separators'] = (',', ': ')</font>
<font color="black">  39. </font>
<font color="green">  40.     def start_serialization(self):</font>
<font color="green">  41.         self._init_options()</font>
<font color="green">  42.         self.stream.write(&quot;[&quot;)</font>
<font color="black">  43. </font>
<font color="green">  44.     def end_serialization(self):</font>
<font color="green">  45.         if self.options.get(&quot;indent&quot;):</font>
<font color="red">  46.             self.stream.write(&quot;\n&quot;)</font>
<font color="green">  47.         self.stream.write(&quot;]&quot;)</font>
<font color="green">  48.         if self.options.get(&quot;indent&quot;):</font>
<font color="red">  49.             self.stream.write(&quot;\n&quot;)</font>
<font color="black">  50. </font>
<font color="green">  51.     def end_object(self, obj):</font>
<font color="black">  52.         # self._current has the field data</font>
<font color="green">  53.         indent = self.options.get(&quot;indent&quot;)</font>
<font color="green">  54.         if not self.first:</font>
<font color="green">  55.             self.stream.write(&quot;,&quot;)</font>
<font color="green">  56.             if not indent:</font>
<font color="green">  57.                 self.stream.write(&quot; &quot;)</font>
<font color="green">  58.         if indent:</font>
<font color="red">  59.             self.stream.write(&quot;\n&quot;)</font>
<font color="green">  60.         json.dump(self.get_dump_object(obj), self.stream,</font>
<font color="green">  61.                   cls=DjangoJSONEncoder, **self.json_kwargs)</font>
<font color="green">  62.         self._current = None</font>
<font color="black">  63. </font>
<font color="green">  64.     def getvalue(self):</font>
<font color="black">  65.         # Grand-parent super</font>
<font color="green">  66.         return super(PythonSerializer, self).getvalue()</font>
<font color="black">  67. </font>
<font color="black">  68. </font>
<font color="green">  69. def Deserializer(stream_or_string, **options):</font>
<font color="black">  70.     &quot;&quot;&quot;</font>
<font color="black">  71.     Deserialize a stream or string of JSON data.</font>
<font color="black">  72.     &quot;&quot;&quot;</font>
<font color="red">  73.     if not isinstance(stream_or_string, (bytes, six.string_types)):</font>
<font color="red">  74.         stream_or_string = stream_or_string.read()</font>
<font color="red">  75.     if isinstance(stream_or_string, bytes):</font>
<font color="red">  76.         stream_or_string = stream_or_string.decode('utf-8')</font>
<font color="red">  77.     try:</font>
<font color="red">  78.         objects = json.loads(stream_or_string)</font>
<font color="red">  79.         for obj in PythonDeserializer(objects, **options):</font>
<font color="red">  80.             yield obj</font>
<font color="red">  81.     except GeneratorExit:</font>
<font color="red">  82.         raise</font>
<font color="red">  83.     except Exception as e:</font>
<font color="black">  84.         # Map to deserializer error</font>
<font color="red">  85.         six.reraise(DeserializationError, DeserializationError(e), sys.exc_info()[2])</font>
<font color="black">  86. </font>
<font color="black">  87. </font>
<font color="green">  88. class DjangoJSONEncoder(json.JSONEncoder):</font>
<font color="black">  89.     &quot;&quot;&quot;</font>
<font color="black">  90.     JSONEncoder subclass that knows how to encode date/time, decimal types and UUIDs.</font>
<font color="green">  91.     &quot;&quot;&quot;</font>
<font color="green">  92.     def default(self, o):</font>
<font color="black">  93.         # See &quot;Date Time String Format&quot; in the ECMA-262 specification.</font>
<font color="red">  94.         if isinstance(o, datetime.datetime):</font>
<font color="red">  95.             r = o.isoformat()</font>
<font color="red">  96.             if o.microsecond:</font>
<font color="red">  97.                 r = r[:23] + r[26:]</font>
<font color="red">  98.             if r.endswith('+00:00'):</font>
<font color="red">  99.                 r = r[:-6] + 'Z'</font>
<font color="red"> 100.             return r</font>
<font color="red"> 101.         elif isinstance(o, datetime.date):</font>
<font color="red"> 102.             return o.isoformat()</font>
<font color="red"> 103.         elif isinstance(o, datetime.time):</font>
<font color="red"> 104.             if is_aware(o):</font>
<font color="red"> 105.                 raise ValueError(&quot;JSON can't represent timezone-aware times.&quot;)</font>
<font color="red"> 106.             r = o.isoformat()</font>
<font color="red"> 107.             if o.microsecond:</font>
<font color="red"> 108.                 r = r[:12]</font>
<font color="red"> 109.             return r</font>
<font color="red"> 110.         elif isinstance(o, decimal.Decimal):</font>
<font color="red"> 111.             return str(o)</font>
<font color="red"> 112.         elif isinstance(o, uuid.UUID):</font>
<font color="red"> 113.             return str(o)</font>
<font color="black"> 114.         else:</font>
<font color="red"> 115.             return super(DjangoJSONEncoder, self).default(o)</font>
<font color="black"> 116. </font>
<font color="black"> 117. # Older, deprecated class name (for backwards compatibility purposes).</font>
<font color="green"> 118. DateTimeAwareJSONEncoder = DjangoJSONEncoder</font>
</pre>


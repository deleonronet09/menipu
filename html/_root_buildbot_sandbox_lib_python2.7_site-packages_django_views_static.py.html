source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/views/static.py</b><br>


file stats: <b>80 lines, 17 executed: 21.2% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Views and functions for serving static files. These are only to be used</font>
<font color="black">   3. during development, and SHOULD NOT be used in a production setting.</font>
<font color="green">   4. &quot;&quot;&quot;</font>
<font color="green">   5. from __future__ import unicode_literals</font>
<font color="black">   6. </font>
<font color="green">   7. import mimetypes</font>
<font color="green">   8. import os</font>
<font color="green">   9. import posixpath</font>
<font color="green">  10. import re</font>
<font color="green">  11. import stat</font>
<font color="black">  12. </font>
<font color="green">  13. from django.http import (</font>
<font color="black">  14.     FileResponse, Http404, HttpResponse, HttpResponseNotModified,</font>
<font color="black">  15.     HttpResponseRedirect,</font>
<font color="black">  16. )</font>
<font color="green">  17. from django.template import Context, Engine, TemplateDoesNotExist, loader</font>
<font color="green">  18. from django.utils.http import http_date, parse_http_date</font>
<font color="green">  19. from django.utils.six.moves.urllib.parse import unquote</font>
<font color="green">  20. from django.utils.translation import ugettext as _, ugettext_lazy</font>
<font color="black">  21. </font>
<font color="black">  22. </font>
<font color="green">  23. def serve(request, path, document_root=None, show_indexes=False):</font>
<font color="black">  24.     &quot;&quot;&quot;</font>
<font color="black">  25.     Serve static files below a given point in the directory structure.</font>
<font color="black">  26. </font>
<font color="black">  27.     To use, put a URL pattern such as::</font>
<font color="black">  28. </font>
<font color="black">  29.         from django.views.static import serve</font>
<font color="black">  30. </font>
<font color="black">  31.         url(r'^(?P&lt;path&gt;.*)$', serve, {'document_root': '/path/to/my/files/'})</font>
<font color="black">  32. </font>
<font color="black">  33.     in your URLconf. You must provide the ``document_root`` param. You may</font>
<font color="black">  34.     also set ``show_indexes`` to ``True`` if you'd like to serve a basic index</font>
<font color="black">  35.     of the directory.  This index view will use the template hardcoded below,</font>
<font color="black">  36.     but if you'd like to override it, you can create a template called</font>
<font color="black">  37.     ``static/directory_index.html``.</font>
<font color="black">  38.     &quot;&quot;&quot;</font>
<font color="red">  39.     path = posixpath.normpath(unquote(path))</font>
<font color="red">  40.     path = path.lstrip('/')</font>
<font color="red">  41.     newpath = ''</font>
<font color="red">  42.     for part in path.split('/'):</font>
<font color="red">  43.         if not part:</font>
<font color="black">  44.             # Strip empty path components.</font>
<font color="red">  45.             continue</font>
<font color="red">  46.         drive, part = os.path.splitdrive(part)</font>
<font color="red">  47.         head, part = os.path.split(part)</font>
<font color="red">  48.         if part in (os.curdir, os.pardir):</font>
<font color="black">  49.             # Strip '.' and '..' in path.</font>
<font color="red">  50.             continue</font>
<font color="red">  51.         newpath = os.path.join(newpath, part).replace('\\', '/')</font>
<font color="red">  52.     if newpath and path != newpath:</font>
<font color="red">  53.         return HttpResponseRedirect(newpath)</font>
<font color="red">  54.     fullpath = os.path.join(document_root, newpath)</font>
<font color="red">  55.     if os.path.isdir(fullpath):</font>
<font color="red">  56.         if show_indexes:</font>
<font color="red">  57.             return directory_index(newpath, fullpath)</font>
<font color="red">  58.         raise Http404(_(&quot;Directory indexes are not allowed here.&quot;))</font>
<font color="red">  59.     if not os.path.exists(fullpath):</font>
<font color="red">  60.         raise Http404(_('&quot;%(path)s&quot; does not exist') % {'path': fullpath})</font>
<font color="black">  61.     # Respect the If-Modified-Since header.</font>
<font color="red">  62.     statobj = os.stat(fullpath)</font>
<font color="red">  63.     if not was_modified_since(request.META.get('HTTP_IF_MODIFIED_SINCE'),</font>
<font color="red">  64.                               statobj.st_mtime, statobj.st_size):</font>
<font color="red">  65.         return HttpResponseNotModified()</font>
<font color="red">  66.     content_type, encoding = mimetypes.guess_type(fullpath)</font>
<font color="red">  67.     content_type = content_type or 'application/octet-stream'</font>
<font color="red">  68.     response = FileResponse(open(fullpath, 'rb'), content_type=content_type)</font>
<font color="red">  69.     response[&quot;Last-Modified&quot;] = http_date(statobj.st_mtime)</font>
<font color="red">  70.     if stat.S_ISREG(statobj.st_mode):</font>
<font color="red">  71.         response[&quot;Content-Length&quot;] = statobj.st_size</font>
<font color="red">  72.     if encoding:</font>
<font color="red">  73.         response[&quot;Content-Encoding&quot;] = encoding</font>
<font color="red">  74.     return response</font>
<font color="black">  75. </font>
<font color="black">  76. </font>
<font color="black">  77. DEFAULT_DIRECTORY_INDEX_TEMPLATE = &quot;&quot;&quot;</font>
<font color="black">  78. {% load i18n %}</font>
<font color="black">  79. &lt;!DOCTYPE html&gt;</font>
<font color="black">  80. &lt;html lang=&quot;en&quot;&gt;</font>
<font color="black">  81.   &lt;head&gt;</font>
<font color="black">  82.     &lt;meta http-equiv=&quot;Content-type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</font>
<font color="black">  83.     &lt;meta http-equiv=&quot;Content-Language&quot; content=&quot;en-us&quot; /&gt;</font>
<font color="black">  84.     &lt;meta name=&quot;robots&quot; content=&quot;NONE,NOARCHIVE&quot; /&gt;</font>
<font color="black">  85.     &lt;title&gt;{% blocktrans %}Index of {{ directory }}{% endblocktrans %}&lt;/title&gt;</font>
<font color="black">  86.   &lt;/head&gt;</font>
<font color="black">  87.   &lt;body&gt;</font>
<font color="black">  88.     &lt;h1&gt;{% blocktrans %}Index of {{ directory }}{% endblocktrans %}&lt;/h1&gt;</font>
<font color="black">  89.     &lt;ul&gt;</font>
<font color="black">  90.       {% if directory != &quot;/&quot; %}</font>
<font color="black">  91.       &lt;li&gt;&lt;a href=&quot;../&quot;&gt;../&lt;/a&gt;&lt;/li&gt;</font>
<font color="black">  92.       {% endif %}</font>
<font color="black">  93.       {% for f in file_list %}</font>
<font color="black">  94.       &lt;li&gt;&lt;a href=&quot;{{ f|urlencode }}&quot;&gt;{{ f }}&lt;/a&gt;&lt;/li&gt;</font>
<font color="black">  95.       {% endfor %}</font>
<font color="black">  96.     &lt;/ul&gt;</font>
<font color="black">  97.   &lt;/body&gt;</font>
<font color="black">  98. &lt;/html&gt;</font>
<font color="green">  99. &quot;&quot;&quot;</font>
<font color="green"> 100. template_translatable = ugettext_lazy(&quot;Index of %(directory)s&quot;)</font>
<font color="black"> 101. </font>
<font color="black"> 102. </font>
<font color="green"> 103. def directory_index(path, fullpath):</font>
<font color="red"> 104.     try:</font>
<font color="red"> 105.         t = loader.select_template([</font>
<font color="red"> 106.             'static/directory_index.html',</font>
<font color="red"> 107.             'static/directory_index',</font>
<font color="black"> 108.         ])</font>
<font color="red"> 109.     except TemplateDoesNotExist:</font>
<font color="red"> 110.         t = Engine().from_string(DEFAULT_DIRECTORY_INDEX_TEMPLATE)</font>
<font color="red"> 111.     files = []</font>
<font color="red"> 112.     for f in os.listdir(fullpath):</font>
<font color="red"> 113.         if not f.startswith('.'):</font>
<font color="red"> 114.             if os.path.isdir(os.path.join(fullpath, f)):</font>
<font color="red"> 115.                 f += '/'</font>
<font color="red"> 116.             files.append(f)</font>
<font color="red"> 117.     c = Context({</font>
<font color="red"> 118.         'directory': path + '/',</font>
<font color="red"> 119.         'file_list': files,</font>
<font color="black"> 120.     })</font>
<font color="red"> 121.     return HttpResponse(t.render(c))</font>
<font color="black"> 122. </font>
<font color="black"> 123. </font>
<font color="green"> 124. def was_modified_since(header=None, mtime=0, size=0):</font>
<font color="black"> 125.     &quot;&quot;&quot;</font>
<font color="black"> 126.     Was something modified since the user last downloaded it?</font>
<font color="black"> 127. </font>
<font color="black"> 128.     header</font>
<font color="black"> 129.       This is the value of the If-Modified-Since header.  If this is None,</font>
<font color="black"> 130.       I'll just return True.</font>
<font color="black"> 131. </font>
<font color="black"> 132.     mtime</font>
<font color="black"> 133.       This is the modification time of the item we're talking about.</font>
<font color="black"> 134. </font>
<font color="black"> 135.     size</font>
<font color="black"> 136.       This is the size of the item we're talking about.</font>
<font color="black"> 137.     &quot;&quot;&quot;</font>
<font color="red"> 138.     try:</font>
<font color="red"> 139.         if header is None:</font>
<font color="red"> 140.             raise ValueError</font>
<font color="red"> 141.         matches = re.match(r&quot;^([^;]+)(; length=([0-9]+))?$&quot;, header,</font>
<font color="red"> 142.                            re.IGNORECASE)</font>
<font color="red"> 143.         header_mtime = parse_http_date(matches.group(1))</font>
<font color="red"> 144.         header_len = matches.group(3)</font>
<font color="red"> 145.         if header_len and int(header_len) != size:</font>
<font color="red"> 146.             raise ValueError</font>
<font color="red"> 147.         if int(mtime) &gt; header_mtime:</font>
<font color="red"> 148.             raise ValueError</font>
<font color="red"> 149.     except (AttributeError, ValueError, OverflowError):</font>
<font color="red"> 150.         return True</font>
<font color="red"> 151.     return False</font>
</pre>


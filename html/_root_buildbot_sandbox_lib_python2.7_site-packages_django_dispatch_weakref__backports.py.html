source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/dispatch/weakref_backports.py</b><br>


file stats: <b>43 lines, 24 executed: 55.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. weakref_backports is a partial backport of the weakref module for python</font>
<font color="black">   3. versions below 3.4.</font>
<font color="black">   4. </font>
<font color="black">   5. Copyright (C) 2013 Python Software Foundation, see license.python.txt for</font>
<font color="black">   6. details.</font>
<font color="black">   7. </font>
<font color="black">   8. The following changes were made to the original sources during backporting:</font>
<font color="black">   9. </font>
<font color="black">  10.  * Added `self` to `super` calls.</font>
<font color="black">  11.  * Removed `from None` when raising exceptions.</font>
<font color="black">  12. </font>
<font color="green">  13. &quot;&quot;&quot;</font>
<font color="green">  14. from weakref import ref</font>
<font color="black">  15. </font>
<font color="black">  16. </font>
<font color="green">  17. class WeakMethod(ref):</font>
<font color="black">  18.     &quot;&quot;&quot;</font>
<font color="black">  19.     A custom `weakref.ref` subclass which simulates a weak reference to</font>
<font color="black">  20.     a bound method, working around the lifetime problem of bound methods.</font>
<font color="green">  21.     &quot;&quot;&quot;</font>
<font color="black">  22. </font>
<font color="green">  23.     __slots__ = &quot;_func_ref&quot;, &quot;_meth_type&quot;, &quot;_alive&quot;, &quot;__weakref__&quot;</font>
<font color="black">  24. </font>
<font color="green">  25.     def __new__(cls, meth, callback=None):</font>
<font color="green">  26.         try:</font>
<font color="green">  27.             obj = meth.__self__</font>
<font color="green">  28.             func = meth.__func__</font>
<font color="red">  29.         except AttributeError:</font>
<font color="red">  30.             raise TypeError(&quot;argument should be a bound method, not {}&quot;</font>
<font color="red">  31.                             .format(type(meth)))</font>
<font color="green">  32.         def _cb(arg):</font>
<font color="black">  33.             # The self-weakref trick is needed to avoid creating a reference</font>
<font color="black">  34.             # cycle.</font>
<font color="red">  35.             self = self_wr()</font>
<font color="red">  36.             if self._alive:</font>
<font color="red">  37.                 self._alive = False</font>
<font color="red">  38.                 if callback is not None:</font>
<font color="red">  39.                     callback(self)</font>
<font color="green">  40.         self = ref.__new__(cls, obj, _cb)</font>
<font color="green">  41.         self._func_ref = ref(func, _cb)</font>
<font color="green">  42.         self._meth_type = type(meth)</font>
<font color="green">  43.         self._alive = True</font>
<font color="green">  44.         self_wr = ref(self)</font>
<font color="green">  45.         return self</font>
<font color="black">  46. </font>
<font color="green">  47.     def __call__(self):</font>
<font color="green">  48.         obj = super(WeakMethod, self).__call__()</font>
<font color="green">  49.         func = self._func_ref()</font>
<font color="green">  50.         if obj is None or func is None:</font>
<font color="red">  51.             return None</font>
<font color="green">  52.         return self._meth_type(func, obj)</font>
<font color="black">  53. </font>
<font color="green">  54.     def __eq__(self, other):</font>
<font color="red">  55.         if isinstance(other, WeakMethod):</font>
<font color="red">  56.             if not self._alive or not other._alive:</font>
<font color="red">  57.                 return self is other</font>
<font color="red">  58.             return ref.__eq__(self, other) and self._func_ref == other._func_ref</font>
<font color="red">  59.         return False</font>
<font color="black">  60. </font>
<font color="green">  61.     def __ne__(self, other):</font>
<font color="red">  62.         if isinstance(other, WeakMethod):</font>
<font color="red">  63.             if not self._alive or not other._alive:</font>
<font color="red">  64.                 return self is not other</font>
<font color="red">  65.             return ref.__ne__(self, other) or self._func_ref != other._func_ref</font>
<font color="red">  66.         return True</font>
<font color="black">  67. </font>
<font color="green">  68.     __hash__ = ref.__hash__</font>
</pre>


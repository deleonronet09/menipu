source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/admin/helpers.py</b><br>


file stats: <b>272 lines, 70 executed: 25.7% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import warnings</font>
<font color="black">   4. </font>
<font color="green">   5. from django import forms</font>
<font color="green">   6. from django.conf import settings</font>
<font color="green">   7. from django.contrib.admin.templatetags.admin_static import static</font>
<font color="green">   8. from django.contrib.admin.utils import (</font>
<font color="black">   9.     display_for_field, flatten_fieldsets, help_text_for_field, label_for_field,</font>
<font color="black">  10.     lookup_field,</font>
<font color="black">  11. )</font>
<font color="green">  12. from django.core.exceptions import ObjectDoesNotExist</font>
<font color="green">  13. from django.db.models.fields.related import ManyToManyRel</font>
<font color="green">  14. from django.forms.utils import flatatt</font>
<font color="green">  15. from django.template.defaultfilters import capfirst, linebreaksbr</font>
<font color="green">  16. from django.utils import six</font>
<font color="green">  17. from django.utils.deprecation import (</font>
<font color="black">  18.     RemovedInDjango20Warning, RemovedInDjango110Warning,</font>
<font color="black">  19. )</font>
<font color="green">  20. from django.utils.encoding import force_text, smart_text</font>
<font color="green">  21. from django.utils.functional import cached_property</font>
<font color="green">  22. from django.utils.html import conditional_escape, format_html</font>
<font color="green">  23. from django.utils.safestring import mark_safe</font>
<font color="green">  24. from django.utils.translation import ugettext_lazy as _</font>
<font color="black">  25. </font>
<font color="green">  26. ACTION_CHECKBOX_NAME = '_selected_action'</font>
<font color="black">  27. </font>
<font color="black">  28. </font>
<font color="green">  29. class ActionForm(forms.Form):</font>
<font color="green">  30.     action = forms.ChoiceField(label=_('Action:'))</font>
<font color="green">  31.     select_across = forms.BooleanField(label='', required=False, initial=0,</font>
<font color="green">  32.         widget=forms.HiddenInput({'class': 'select-across'}))</font>
<font color="black">  33. </font>
<font color="green">  34. checkbox = forms.CheckboxInput({'class': 'action-select'}, lambda value: False)</font>
<font color="black">  35. </font>
<font color="black">  36. </font>
<font color="green">  37. class AdminForm(object):</font>
<font color="green">  38.     def __init__(self, form, fieldsets, prepopulated_fields, readonly_fields=None, model_admin=None):</font>
<font color="red">  39.         self.form, self.fieldsets = form, fieldsets</font>
<font color="red">  40.         self.prepopulated_fields = [{</font>
<font color="black">  41.             'field': form[field_name],</font>
<font color="black">  42.             'dependencies': [form[f] for f in dependencies]</font>
<font color="red">  43.         } for field_name, dependencies in prepopulated_fields.items()]</font>
<font color="red">  44.         self.model_admin = model_admin</font>
<font color="red">  45.         if readonly_fields is None:</font>
<font color="red">  46.             readonly_fields = ()</font>
<font color="red">  47.         self.readonly_fields = readonly_fields</font>
<font color="black">  48. </font>
<font color="green">  49.     def __iter__(self):</font>
<font color="red">  50.         for name, options in self.fieldsets:</font>
<font color="red">  51.             yield Fieldset(</font>
<font color="red">  52.                 self.form, name,</font>
<font color="red">  53.                 readonly_fields=self.readonly_fields,</font>
<font color="red">  54.                 model_admin=self.model_admin,</font>
<font color="red">  55.                 **options</font>
<font color="black">  56.             )</font>
<font color="black">  57. </font>
<font color="green">  58.     def _media(self):</font>
<font color="red">  59.         media = self.form.media</font>
<font color="red">  60.         for fs in self:</font>
<font color="red">  61.             media = media + fs.media</font>
<font color="red">  62.         return media</font>
<font color="green">  63.     media = property(_media)</font>
<font color="black">  64. </font>
<font color="black">  65. </font>
<font color="green">  66. class Fieldset(object):</font>
<font color="green">  67.     def __init__(self, form, name=None, readonly_fields=(), fields=(), classes=(),</font>
<font color="green">  68.       description=None, model_admin=None):</font>
<font color="red">  69.         self.form = form</font>
<font color="red">  70.         self.name, self.fields = name, fields</font>
<font color="red">  71.         self.classes = ' '.join(classes)</font>
<font color="red">  72.         self.description = description</font>
<font color="red">  73.         self.model_admin = model_admin</font>
<font color="red">  74.         self.readonly_fields = readonly_fields</font>
<font color="black">  75. </font>
<font color="green">  76.     def _media(self):</font>
<font color="red">  77.         if 'collapse' in self.classes:</font>
<font color="red">  78.             extra = '' if settings.DEBUG else '.min'</font>
<font color="red">  79.             js = ['vendor/jquery/jquery%s.js' % extra,</font>
<font color="red">  80.                   'jquery.init.js',</font>
<font color="red">  81.                   'collapse%s.js' % extra]</font>
<font color="red">  82.             return forms.Media(js=[static('admin/js/%s' % url) for url in js])</font>
<font color="red">  83.         return forms.Media()</font>
<font color="green">  84.     media = property(_media)</font>
<font color="black">  85. </font>
<font color="green">  86.     def __iter__(self):</font>
<font color="red">  87.         for field in self.fields:</font>
<font color="red">  88.             yield Fieldline(self.form, field, self.readonly_fields, model_admin=self.model_admin)</font>
<font color="black">  89. </font>
<font color="black">  90. </font>
<font color="green">  91. class Fieldline(object):</font>
<font color="green">  92.     def __init__(self, form, field, readonly_fields=None, model_admin=None):</font>
<font color="red">  93.         self.form = form  # A django.forms.Form instance</font>
<font color="red">  94.         if not hasattr(field, &quot;__iter__&quot;) or isinstance(field, six.text_type):</font>
<font color="red">  95.             self.fields = [field]</font>
<font color="black">  96.         else:</font>
<font color="red">  97.             self.fields = field</font>
<font color="red">  98.         self.has_visible_field = not all(field in self.form.fields and</font>
<font color="black">  99.                                          self.form.fields[field].widget.is_hidden</font>
<font color="red"> 100.                                          for field in self.fields)</font>
<font color="red"> 101.         self.model_admin = model_admin</font>
<font color="red"> 102.         if readonly_fields is None:</font>
<font color="red"> 103.             readonly_fields = ()</font>
<font color="red"> 104.         self.readonly_fields = readonly_fields</font>
<font color="black"> 105. </font>
<font color="green"> 106.     def __iter__(self):</font>
<font color="red"> 107.         for i, field in enumerate(self.fields):</font>
<font color="red"> 108.             if field in self.readonly_fields:</font>
<font color="red"> 109.                 yield AdminReadonlyField(self.form, field, is_first=(i == 0),</font>
<font color="red"> 110.                     model_admin=self.model_admin)</font>
<font color="black"> 111.             else:</font>
<font color="red"> 112.                 yield AdminField(self.form, field, is_first=(i == 0))</font>
<font color="black"> 113. </font>
<font color="green"> 114.     def errors(self):</font>
<font color="red"> 115.         return mark_safe(</font>
<font color="red"> 116.             '\n'.join(self.form[f].errors.as_ul()</font>
<font color="red"> 117.             for f in self.fields if f not in self.readonly_fields).strip('\n')</font>
<font color="black"> 118.         )</font>
<font color="black"> 119. </font>
<font color="black"> 120. </font>
<font color="green"> 121. class AdminField(object):</font>
<font color="green"> 122.     def __init__(self, form, field, is_first):</font>
<font color="red"> 123.         self.field = form[field]  # A django.forms.BoundField instance</font>
<font color="red"> 124.         self.is_first = is_first  # Whether this field is first on the line</font>
<font color="red"> 125.         self.is_checkbox = isinstance(self.field.field.widget, forms.CheckboxInput)</font>
<font color="red"> 126.         self.is_readonly = False</font>
<font color="black"> 127. </font>
<font color="green"> 128.     def label_tag(self):</font>
<font color="red"> 129.         classes = []</font>
<font color="red"> 130.         contents = conditional_escape(force_text(self.field.label))</font>
<font color="red"> 131.         if self.is_checkbox:</font>
<font color="red"> 132.             classes.append('vCheckboxLabel')</font>
<font color="black"> 133. </font>
<font color="red"> 134.         if self.field.field.required:</font>
<font color="red"> 135.             classes.append('required')</font>
<font color="red"> 136.         if not self.is_first:</font>
<font color="red"> 137.             classes.append('inline')</font>
<font color="red"> 138.         attrs = {'class': ' '.join(classes)} if classes else {}</font>
<font color="black"> 139.         # checkboxes should not have a label suffix as the checkbox appears</font>
<font color="black"> 140.         # to the left of the label.</font>
<font color="red"> 141.         return self.field.label_tag(contents=mark_safe(contents), attrs=attrs,</font>
<font color="red"> 142.                                     label_suffix='' if self.is_checkbox else None)</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def errors(self):</font>
<font color="red"> 145.         return mark_safe(self.field.errors.as_ul())</font>
<font color="black"> 146. </font>
<font color="black"> 147. </font>
<font color="green"> 148. class AdminReadonlyField(object):</font>
<font color="green"> 149.     def __init__(self, form, field, is_first, model_admin=None):</font>
<font color="black"> 150.         # Make self.field look a little bit like a field. This means that</font>
<font color="black"> 151.         # {{ field.name }} must be a useful class name to identify the field.</font>
<font color="black"> 152.         # For convenience, store other field-related data here too.</font>
<font color="red"> 153.         if callable(field):</font>
<font color="red"> 154.             class_name = field.__name__ if field.__name__ != '&lt;lambda&gt;' else ''</font>
<font color="black"> 155.         else:</font>
<font color="red"> 156.             class_name = field</font>
<font color="black"> 157. </font>
<font color="red"> 158.         if form._meta.labels and class_name in form._meta.labels:</font>
<font color="red"> 159.             label = form._meta.labels[class_name]</font>
<font color="black"> 160.         else:</font>
<font color="red"> 161.             label = label_for_field(field, form._meta.model, model_admin)</font>
<font color="black"> 162. </font>
<font color="red"> 163.         if form._meta.help_texts and class_name in form._meta.help_texts:</font>
<font color="red"> 164.             help_text = form._meta.help_texts[class_name]</font>
<font color="black"> 165.         else:</font>
<font color="red"> 166.             help_text = help_text_for_field(class_name, form._meta.model)</font>
<font color="black"> 167. </font>
<font color="red"> 168.         self.field = {</font>
<font color="red"> 169.             'name': class_name,</font>
<font color="red"> 170.             'label': label,</font>
<font color="red"> 171.             'help_text': help_text,</font>
<font color="red"> 172.             'field': field,</font>
<font color="black"> 173.         }</font>
<font color="red"> 174.         self.form = form</font>
<font color="red"> 175.         self.model_admin = model_admin</font>
<font color="red"> 176.         self.is_first = is_first</font>
<font color="red"> 177.         self.is_checkbox = False</font>
<font color="red"> 178.         self.is_readonly = True</font>
<font color="red"> 179.         self.empty_value_display = model_admin.get_empty_value_display()</font>
<font color="black"> 180. </font>
<font color="green"> 181.     def label_tag(self):</font>
<font color="red"> 182.         attrs = {}</font>
<font color="red"> 183.         if not self.is_first:</font>
<font color="red"> 184.             attrs[&quot;class&quot;] = &quot;inline&quot;</font>
<font color="red"> 185.         label = self.field['label']</font>
<font color="red"> 186.         return format_html('&lt;label{}&gt;{}:&lt;/label&gt;',</font>
<font color="red"> 187.                            flatatt(attrs),</font>
<font color="red"> 188.                            capfirst(force_text(label)))</font>
<font color="black"> 189. </font>
<font color="green"> 190.     def contents(self):</font>
<font color="red"> 191.         from django.contrib.admin.templatetags.admin_list import _boolean_icon</font>
<font color="red"> 192.         field, obj, model_admin = self.field['field'], self.form.instance, self.model_admin</font>
<font color="red"> 193.         try:</font>
<font color="red"> 194.             f, attr, value = lookup_field(field, obj, model_admin)</font>
<font color="red"> 195.         except (AttributeError, ValueError, ObjectDoesNotExist):</font>
<font color="red"> 196.             result_repr = self.empty_value_display</font>
<font color="black"> 197.         else:</font>
<font color="red"> 198.             if f is None:</font>
<font color="red"> 199.                 boolean = getattr(attr, &quot;boolean&quot;, False)</font>
<font color="red"> 200.                 if boolean:</font>
<font color="red"> 201.                     result_repr = _boolean_icon(value)</font>
<font color="black"> 202.                 else:</font>
<font color="red"> 203.                     if hasattr(value, &quot;__html__&quot;):</font>
<font color="red"> 204.                         result_repr = value</font>
<font color="black"> 205.                     else:</font>
<font color="red"> 206.                         result_repr = smart_text(value)</font>
<font color="red"> 207.                         if getattr(attr, &quot;allow_tags&quot;, False):</font>
<font color="red"> 208.                             warnings.warn(</font>
<font color="red"> 209.                                 &quot;Deprecated allow_tags attribute used on %s. &quot;</font>
<font color="black"> 210.                                 &quot;Use django.utils.safestring.format_html(), &quot;</font>
<font color="red"> 211.                                 &quot;format_html_join(), or mark_safe() instead.&quot; % attr,</font>
<font color="red"> 212.                                 RemovedInDjango20Warning</font>
<font color="black"> 213.                             )</font>
<font color="red"> 214.                             result_repr = mark_safe(value)</font>
<font color="black"> 215.                         else:</font>
<font color="red"> 216.                             result_repr = linebreaksbr(result_repr)</font>
<font color="black"> 217.             else:</font>
<font color="red"> 218.                 if isinstance(f.remote_field, ManyToManyRel) and value is not None:</font>
<font color="red"> 219.                     result_repr = &quot;, &quot;.join(map(six.text_type, value.all()))</font>
<font color="black"> 220.                 else:</font>
<font color="red"> 221.                     result_repr = display_for_field(value, f, self.empty_value_display)</font>
<font color="red"> 222.         return conditional_escape(result_repr)</font>
<font color="black"> 223. </font>
<font color="black"> 224. </font>
<font color="green"> 225. class InlineAdminFormSet(object):</font>
<font color="black"> 226.     &quot;&quot;&quot;</font>
<font color="black"> 227.     A wrapper around an inline formset for use in the admin system.</font>
<font color="green"> 228.     &quot;&quot;&quot;</font>
<font color="green"> 229.     def __init__(self, inline, formset, fieldsets, prepopulated_fields=None,</font>
<font color="green"> 230.             readonly_fields=None, model_admin=None):</font>
<font color="red"> 231.         self.opts = inline</font>
<font color="red"> 232.         self.formset = formset</font>
<font color="red"> 233.         self.fieldsets = fieldsets</font>
<font color="red"> 234.         self.model_admin = model_admin</font>
<font color="red"> 235.         if readonly_fields is None:</font>
<font color="red"> 236.             readonly_fields = ()</font>
<font color="red"> 237.         self.readonly_fields = readonly_fields</font>
<font color="red"> 238.         if prepopulated_fields is None:</font>
<font color="red"> 239.             prepopulated_fields = {}</font>
<font color="red"> 240.         self.prepopulated_fields = prepopulated_fields</font>
<font color="black"> 241. </font>
<font color="green"> 242.     def __iter__(self):</font>
<font color="red"> 243.         for form, original in zip(self.formset.initial_forms, self.formset.get_queryset()):</font>
<font color="red"> 244.             view_on_site_url = self.opts.get_view_on_site_url(original)</font>
<font color="red"> 245.             yield InlineAdminForm(self.formset, form, self.fieldsets,</font>
<font color="red"> 246.                 self.prepopulated_fields, original, self.readonly_fields,</font>
<font color="red"> 247.                 model_admin=self.opts, view_on_site_url=view_on_site_url)</font>
<font color="red"> 248.         for form in self.formset.extra_forms:</font>
<font color="red"> 249.             yield InlineAdminForm(self.formset, form, self.fieldsets,</font>
<font color="red"> 250.                 self.prepopulated_fields, None, self.readonly_fields,</font>
<font color="red"> 251.                 model_admin=self.opts)</font>
<font color="red"> 252.         yield InlineAdminForm(self.formset, self.formset.empty_form,</font>
<font color="red"> 253.             self.fieldsets, self.prepopulated_fields, None,</font>
<font color="red"> 254.             self.readonly_fields, model_admin=self.opts)</font>
<font color="black"> 255. </font>
<font color="green"> 256.     def fields(self):</font>
<font color="red"> 257.         fk = getattr(self.formset, &quot;fk&quot;, None)</font>
<font color="red"> 258.         for i, field_name in enumerate(flatten_fieldsets(self.fieldsets)):</font>
<font color="red"> 259.             if fk and fk.name == field_name:</font>
<font color="red"> 260.                 continue</font>
<font color="red"> 261.             if field_name in self.readonly_fields:</font>
<font color="red"> 262.                 yield {</font>
<font color="red"> 263.                     'label': label_for_field(field_name, self.opts.model, self.opts),</font>
<font color="red"> 264.                     'widget': {</font>
<font color="red"> 265.                         'is_hidden': False</font>
<font color="black"> 266.                     },</font>
<font color="red"> 267.                     'required': False,</font>
<font color="red"> 268.                     'help_text': help_text_for_field(field_name, self.opts.model),</font>
<font color="black"> 269.                 }</font>
<font color="black"> 270.             else:</font>
<font color="red"> 271.                 yield self.formset.form.base_fields[field_name]</font>
<font color="black"> 272. </font>
<font color="green"> 273.     def _media(self):</font>
<font color="red"> 274.         media = self.opts.media + self.formset.media</font>
<font color="red"> 275.         for fs in self:</font>
<font color="red"> 276.             media = media + fs.media</font>
<font color="red"> 277.         return media</font>
<font color="green"> 278.     media = property(_media)</font>
<font color="black"> 279. </font>
<font color="black"> 280. </font>
<font color="green"> 281. class InlineAdminForm(AdminForm):</font>
<font color="black"> 282.     &quot;&quot;&quot;</font>
<font color="black"> 283.     A wrapper around an inline form for use in the admin system.</font>
<font color="green"> 284.     &quot;&quot;&quot;</font>
<font color="black"> 285.     def __init__(self, formset, form, fieldsets, prepopulated_fields, original,</font>
<font color="green"> 286.       readonly_fields=None, model_admin=None, view_on_site_url=None):</font>
<font color="red"> 287.         self.formset = formset</font>
<font color="red"> 288.         self.model_admin = model_admin</font>
<font color="red"> 289.         self.original = original</font>
<font color="red"> 290.         self.show_url = original and view_on_site_url is not None</font>
<font color="red"> 291.         self.absolute_url = view_on_site_url</font>
<font color="red"> 292.         super(InlineAdminForm, self).__init__(form, fieldsets, prepopulated_fields,</font>
<font color="red"> 293.             readonly_fields, model_admin)</font>
<font color="black"> 294. </font>
<font color="green"> 295.     @cached_property</font>
<font color="black"> 296.     def original_content_type_id(self):</font>
<font color="red"> 297.         warnings.warn(</font>
<font color="red"> 298.             'InlineAdminForm.original_content_type_id is deprecated and will be '</font>
<font color="black"> 299.             'removed in Django 1.10. If you were using this attribute to construct '</font>
<font color="black"> 300.             'the &quot;view on site&quot; URL, use the `absolute_url` attribute instead.',</font>
<font color="red"> 301.             RemovedInDjango110Warning, stacklevel=2</font>
<font color="black"> 302.         )</font>
<font color="red"> 303.         if self.original is not None:</font>
<font color="black"> 304.             # Since this module gets imported in the application's root package,</font>
<font color="black"> 305.             # it cannot import models from other applications at the module level.</font>
<font color="red"> 306.             from django.contrib.contenttypes.models import ContentType</font>
<font color="red"> 307.             return ContentType.objects.get_for_model(self.original).pk</font>
<font color="red"> 308.         raise AttributeError</font>
<font color="black"> 309. </font>
<font color="green"> 310.     def __iter__(self):</font>
<font color="red"> 311.         for name, options in self.fieldsets:</font>
<font color="red"> 312.             yield InlineFieldset(self.formset, self.form, name,</font>
<font color="red"> 313.                 self.readonly_fields, model_admin=self.model_admin, **options)</font>
<font color="black"> 314. </font>
<font color="green"> 315.     def needs_explicit_pk_field(self):</font>
<font color="black"> 316.         # Auto fields are editable (oddly), so need to check for auto or non-editable pk</font>
<font color="red"> 317.         if self.form._meta.model._meta.has_auto_field or not self.form._meta.model._meta.pk.editable:</font>
<font color="red"> 318.             return True</font>
<font color="black"> 319.         # Also search any parents for an auto field. (The pk info is propagated to child</font>
<font color="black"> 320.         # models so that does not need to be checked in parents.)</font>
<font color="red"> 321.         for parent in self.form._meta.model._meta.get_parent_list():</font>
<font color="red"> 322.             if parent._meta.has_auto_field:</font>
<font color="red"> 323.                 return True</font>
<font color="red"> 324.         return False</font>
<font color="black"> 325. </font>
<font color="green"> 326.     def pk_field(self):</font>
<font color="red"> 327.         return AdminField(self.form, self.formset._pk_field.name, False)</font>
<font color="black"> 328. </font>
<font color="green"> 329.     def fk_field(self):</font>
<font color="red"> 330.         fk = getattr(self.formset, &quot;fk&quot;, None)</font>
<font color="red"> 331.         if fk:</font>
<font color="red"> 332.             return AdminField(self.form, fk.name, False)</font>
<font color="black"> 333.         else:</font>
<font color="red"> 334.             return &quot;&quot;</font>
<font color="black"> 335. </font>
<font color="green"> 336.     def deletion_field(self):</font>
<font color="red"> 337.         from django.forms.formsets import DELETION_FIELD_NAME</font>
<font color="red"> 338.         return AdminField(self.form, DELETION_FIELD_NAME, False)</font>
<font color="black"> 339. </font>
<font color="green"> 340.     def ordering_field(self):</font>
<font color="red"> 341.         from django.forms.formsets import ORDERING_FIELD_NAME</font>
<font color="red"> 342.         return AdminField(self.form, ORDERING_FIELD_NAME, False)</font>
<font color="black"> 343. </font>
<font color="black"> 344. </font>
<font color="green"> 345. class InlineFieldset(Fieldset):</font>
<font color="green"> 346.     def __init__(self, formset, *args, **kwargs):</font>
<font color="red"> 347.         self.formset = formset</font>
<font color="red"> 348.         super(InlineFieldset, self).__init__(*args, **kwargs)</font>
<font color="black"> 349. </font>
<font color="green"> 350.     def __iter__(self):</font>
<font color="red"> 351.         fk = getattr(self.formset, &quot;fk&quot;, None)</font>
<font color="red"> 352.         for field in self.fields:</font>
<font color="red"> 353.             if fk and fk.name == field:</font>
<font color="red"> 354.                 continue</font>
<font color="red"> 355.             yield Fieldline(self.form, field, self.readonly_fields,</font>
<font color="red"> 356.                 model_admin=self.model_admin)</font>
<font color="black"> 357. </font>
<font color="black"> 358. </font>
<font color="green"> 359. class AdminErrorList(forms.utils.ErrorList):</font>
<font color="black"> 360.     &quot;&quot;&quot;</font>
<font color="black"> 361.     Stores all errors for the form/formsets in an add/change stage view.</font>
<font color="green"> 362.     &quot;&quot;&quot;</font>
<font color="green"> 363.     def __init__(self, form, inline_formsets):</font>
<font color="red"> 364.         super(AdminErrorList, self).__init__()</font>
<font color="black"> 365. </font>
<font color="red"> 366.         if form.is_bound:</font>
<font color="red"> 367.             self.extend(form.errors.values())</font>
<font color="red"> 368.             for inline_formset in inline_formsets:</font>
<font color="red"> 369.                 self.extend(inline_formset.non_form_errors())</font>
<font color="red"> 370.                 for errors_in_inline_form in inline_formset.errors:</font>
<font color="red"> 371.                     self.extend(errors_in_inline_form.values())</font>
</pre>


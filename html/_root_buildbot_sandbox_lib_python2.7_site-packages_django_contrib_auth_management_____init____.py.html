source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/contrib/auth/management/__init__.py</b><br>


file stats: <b>111 lines, 54 executed: 48.6% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Creates permissions for all installed apps that need permissions.</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="green">   4. from __future__ import unicode_literals</font>
<font color="black">   5. </font>
<font color="green">   6. import getpass</font>
<font color="green">   7. import unicodedata</font>
<font color="black">   8. </font>
<font color="green">   9. from django.apps import apps</font>
<font color="green">  10. from django.contrib.auth import get_permission_codename</font>
<font color="green">  11. from django.core import exceptions</font>
<font color="green">  12. from django.core.management.base import CommandError</font>
<font color="green">  13. from django.db import DEFAULT_DB_ALIAS, router</font>
<font color="green">  14. from django.utils import six</font>
<font color="green">  15. from django.utils.encoding import DEFAULT_LOCALE_ENCODING</font>
<font color="black">  16. </font>
<font color="black">  17. </font>
<font color="green">  18. def _get_all_permissions(opts, ctype):</font>
<font color="black">  19.     &quot;&quot;&quot;</font>
<font color="black">  20.     Returns (codename, name) for all permissions in the given opts.</font>
<font color="black">  21.     &quot;&quot;&quot;</font>
<font color="green">  22.     builtin = _get_builtin_permissions(opts)</font>
<font color="green">  23.     custom = list(opts.permissions)</font>
<font color="green">  24.     _check_permission_clashing(custom, builtin, ctype)</font>
<font color="green">  25.     return builtin + custom</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. def _get_builtin_permissions(opts):</font>
<font color="black">  29.     &quot;&quot;&quot;</font>
<font color="black">  30.     Returns (codename, name) for all autogenerated permissions.</font>
<font color="black">  31.     By default, this is ('add', 'change', 'delete')</font>
<font color="black">  32.     &quot;&quot;&quot;</font>
<font color="green">  33.     perms = []</font>
<font color="green">  34.     for action in opts.default_permissions:</font>
<font color="green">  35.         perms.append((get_permission_codename(action, opts),</font>
<font color="green">  36.             'Can %s %s' % (action, opts.verbose_name_raw)))</font>
<font color="green">  37.     return perms</font>
<font color="black">  38. </font>
<font color="black">  39. </font>
<font color="green">  40. def _check_permission_clashing(custom, builtin, ctype):</font>
<font color="black">  41.     &quot;&quot;&quot;</font>
<font color="black">  42.     Check that permissions for a model do not clash. Raises CommandError if</font>
<font color="black">  43.     there are duplicate permissions.</font>
<font color="black">  44.     &quot;&quot;&quot;</font>
<font color="green">  45.     pool = set()</font>
<font color="green">  46.     builtin_codenames = set(p[0] for p in builtin)</font>
<font color="green">  47.     for codename, _name in custom:</font>
<font color="red">  48.         if codename in pool:</font>
<font color="red">  49.             raise CommandError(</font>
<font color="red">  50.                 &quot;The permission codename '%s' is duplicated for model '%s.%s'.&quot; %</font>
<font color="red">  51.                 (codename, ctype.app_label, ctype.model_class().__name__))</font>
<font color="red">  52.         elif codename in builtin_codenames:</font>
<font color="red">  53.             raise CommandError(</font>
<font color="red">  54.                 &quot;The permission codename '%s' clashes with a builtin permission &quot;</font>
<font color="black">  55.                 &quot;for model '%s.%s'.&quot; %</font>
<font color="red">  56.                 (codename, ctype.app_label, ctype.model_class().__name__))</font>
<font color="red">  57.         pool.add(codename)</font>
<font color="black">  58. </font>
<font color="black">  59. </font>
<font color="green">  60. def create_permissions(app_config, verbosity=2, interactive=True, using=DEFAULT_DB_ALIAS, **kwargs):</font>
<font color="green">  61.     if not app_config.models_module:</font>
<font color="red">  62.         return</font>
<font color="black">  63. </font>
<font color="green">  64.     try:</font>
<font color="green">  65.         Permission = apps.get_model('auth', 'Permission')</font>
<font color="red">  66.     except LookupError:</font>
<font color="red">  67.         return</font>
<font color="black">  68. </font>
<font color="green">  69.     if not router.allow_migrate_model(using, Permission):</font>
<font color="red">  70.         return</font>
<font color="black">  71. </font>
<font color="green">  72.     from django.contrib.contenttypes.models import ContentType</font>
<font color="black">  73. </font>
<font color="green">  74.     permission_name_max_length = Permission._meta.get_field('name').max_length</font>
<font color="green">  75.     verbose_name_max_length = permission_name_max_length - 11  # len('Can change ') prefix</font>
<font color="black">  76. </font>
<font color="black">  77.     # This will hold the permissions we're looking for as</font>
<font color="black">  78.     # (content_type, (codename, name))</font>
<font color="green">  79.     searched_perms = list()</font>
<font color="black">  80.     # The codenames and ctypes that should exist.</font>
<font color="green">  81.     ctypes = set()</font>
<font color="green">  82.     for klass in app_config.get_models():</font>
<font color="black">  83.         # Force looking up the content types in the current database</font>
<font color="black">  84.         # before creating foreign keys to them.</font>
<font color="green">  85.         ctype = ContentType.objects.db_manager(using).get_for_model(klass)</font>
<font color="black">  86. </font>
<font color="green">  87.         if len(klass._meta.verbose_name) &gt; verbose_name_max_length:</font>
<font color="red">  88.             raise exceptions.ValidationError(</font>
<font color="red">  89.                 &quot;The verbose_name of %s.%s is longer than %s characters&quot; % (</font>
<font color="red">  90.                     ctype.app_label,</font>
<font color="red">  91.                     ctype.model,</font>
<font color="red">  92.                     verbose_name_max_length,</font>
<font color="black">  93.                 )</font>
<font color="black">  94.             )</font>
<font color="black">  95. </font>
<font color="green">  96.         ctypes.add(ctype)</font>
<font color="green">  97.         for perm in _get_all_permissions(klass._meta, ctype):</font>
<font color="green">  98.             searched_perms.append((ctype, perm))</font>
<font color="black">  99. </font>
<font color="black"> 100.     # Find all the Permissions that have a content_type for a model we're</font>
<font color="black"> 101.     # looking for.  We don't need to check for codenames since we already have</font>
<font color="black"> 102.     # a list of the ones we're going to create.</font>
<font color="green"> 103.     all_perms = set(Permission.objects.using(using).filter(</font>
<font color="green"> 104.         content_type__in=ctypes,</font>
<font color="black"> 105.     ).values_list(</font>
<font color="green"> 106.         &quot;content_type&quot;, &quot;codename&quot;</font>
<font color="black"> 107.     ))</font>
<font color="black"> 108. </font>
<font color="black"> 109.     perms = [</font>
<font color="green"> 110.         Permission(codename=codename, name=name, content_type=ct)</font>
<font color="green"> 111.         for ct, (codename, name) in searched_perms</font>
<font color="green"> 112.         if (ct.pk, codename) not in all_perms</font>
<font color="black"> 113.     ]</font>
<font color="black"> 114.     # Validate the permissions before bulk_creation to avoid cryptic database</font>
<font color="black"> 115.     # error when the name is longer than 255 characters</font>
<font color="green"> 116.     for perm in perms:</font>
<font color="green"> 117.         if len(perm.name) &gt; permission_name_max_length:</font>
<font color="red"> 118.             raise exceptions.ValidationError(</font>
<font color="red"> 119.                 &quot;The permission name %s of %s.%s is longer than %s characters&quot; % (</font>
<font color="red"> 120.                     perm.name,</font>
<font color="red"> 121.                     perm.content_type.app_label,</font>
<font color="red"> 122.                     perm.content_type.model,</font>
<font color="red"> 123.                     permission_name_max_length,</font>
<font color="black"> 124.                 )</font>
<font color="black"> 125.             )</font>
<font color="green"> 126.     Permission.objects.using(using).bulk_create(perms)</font>
<font color="green"> 127.     if verbosity &gt;= 2:</font>
<font color="red"> 128.         for perm in perms:</font>
<font color="red"> 129.             print(&quot;Adding permission '%s'&quot; % perm)</font>
<font color="black"> 130. </font>
<font color="black"> 131. </font>
<font color="green"> 132. def get_system_username():</font>
<font color="black"> 133.     &quot;&quot;&quot;</font>
<font color="black"> 134.     Try to determine the current system user's username.</font>
<font color="black"> 135. </font>
<font color="black"> 136.     :returns: The username as a unicode string, or an empty string if the</font>
<font color="black"> 137.         username could not be determined.</font>
<font color="black"> 138.     &quot;&quot;&quot;</font>
<font color="red"> 139.     try:</font>
<font color="red"> 140.         result = getpass.getuser()</font>
<font color="red"> 141.     except (ImportError, KeyError):</font>
<font color="black"> 142.         # KeyError will be raised by os.getpwuid() (called by getuser())</font>
<font color="black"> 143.         # if there is no corresponding entry in the /etc/passwd file</font>
<font color="black"> 144.         # (a very restricted chroot environment, for example).</font>
<font color="red"> 145.         return ''</font>
<font color="red"> 146.     if six.PY2:</font>
<font color="red"> 147.         try:</font>
<font color="red"> 148.             result = result.decode(DEFAULT_LOCALE_ENCODING)</font>
<font color="red"> 149.         except UnicodeDecodeError:</font>
<font color="black"> 150.             # UnicodeDecodeError - preventive treatment for non-latin Windows.</font>
<font color="red"> 151.             return ''</font>
<font color="red"> 152.     return result</font>
<font color="black"> 153. </font>
<font color="black"> 154. </font>
<font color="green"> 155. def get_default_username(check_db=True):</font>
<font color="black"> 156.     &quot;&quot;&quot;</font>
<font color="black"> 157.     Try to determine the current system user's username to use as a default.</font>
<font color="black"> 158. </font>
<font color="black"> 159.     :param check_db: If ``True``, requires that the username does not match an</font>
<font color="black"> 160.         existing ``auth.User`` (otherwise returns an empty string).</font>
<font color="black"> 161.     :returns: The username, or an empty string if no username can be</font>
<font color="black"> 162.         determined.</font>
<font color="black"> 163.     &quot;&quot;&quot;</font>
<font color="black"> 164.     # This file is used in apps.py, it should not trigger models import.</font>
<font color="red"> 165.     from django.contrib.auth import models as auth_app</font>
<font color="black"> 166. </font>
<font color="black"> 167.     # If the User model has been swapped out, we can't make any assumptions</font>
<font color="black"> 168.     # about the default user name.</font>
<font color="red"> 169.     if auth_app.User._meta.swapped:</font>
<font color="red"> 170.         return ''</font>
<font color="black"> 171. </font>
<font color="red"> 172.     default_username = get_system_username()</font>
<font color="red"> 173.     try:</font>
<font color="red"> 174.         default_username = (unicodedata.normalize('NFKD', default_username)</font>
<font color="red"> 175.                 .encode('ascii', 'ignore').decode('ascii')</font>
<font color="red"> 176.                 .replace(' ', '').lower())</font>
<font color="red"> 177.     except UnicodeDecodeError:</font>
<font color="red"> 178.         return ''</font>
<font color="black"> 179. </font>
<font color="black"> 180.     # Run the username validator</font>
<font color="red"> 181.     try:</font>
<font color="red"> 182.         auth_app.User._meta.get_field('username').run_validators(default_username)</font>
<font color="red"> 183.     except exceptions.ValidationError:</font>
<font color="red"> 184.         return ''</font>
<font color="black"> 185. </font>
<font color="black"> 186.     # Don't return the default username if it is already taken.</font>
<font color="red"> 187.     if check_db and default_username:</font>
<font color="red"> 188.         try:</font>
<font color="red"> 189.             auth_app.User._default_manager.get(username=default_username)</font>
<font color="red"> 190.         except auth_app.User.DoesNotExist:</font>
<font color="red"> 191.             pass</font>
<font color="black"> 192.         else:</font>
<font color="red"> 193.             return ''</font>
<font color="red"> 194.     return default_username</font>
</pre>


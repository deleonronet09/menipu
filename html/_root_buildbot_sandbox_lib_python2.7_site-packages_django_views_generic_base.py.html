source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/views/generic/base.py</b><br>


file stats: <b>127 lines, 47 executed: 37.0% covered</b>
<pre>
<font color="green">   1. from __future__ import unicode_literals</font>
<font color="black">   2. </font>
<font color="green">   3. import logging</font>
<font color="green">   4. from functools import update_wrapper</font>
<font color="black">   5. </font>
<font color="green">   6. from django import http</font>
<font color="green">   7. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   8. from django.core.urlresolvers import NoReverseMatch, reverse</font>
<font color="green">   9. from django.template.response import TemplateResponse</font>
<font color="green">  10. from django.utils import six</font>
<font color="green">  11. from django.utils.decorators import classonlymethod</font>
<font color="black">  12. </font>
<font color="green">  13. logger = logging.getLogger('django.request')</font>
<font color="black">  14. </font>
<font color="black">  15. </font>
<font color="green">  16. class ContextMixin(object):</font>
<font color="black">  17.     &quot;&quot;&quot;</font>
<font color="black">  18.     A default context mixin that passes the keyword arguments received by</font>
<font color="black">  19.     get_context_data as the template context.</font>
<font color="green">  20.     &quot;&quot;&quot;</font>
<font color="black">  21. </font>
<font color="green">  22.     def get_context_data(self, **kwargs):</font>
<font color="red">  23.         if 'view' not in kwargs:</font>
<font color="red">  24.             kwargs['view'] = self</font>
<font color="red">  25.         return kwargs</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. class View(object):</font>
<font color="black">  29.     &quot;&quot;&quot;</font>
<font color="black">  30.     Intentionally simple parent class for all views. Only implements</font>
<font color="black">  31.     dispatch-by-method and simple sanity checking.</font>
<font color="green">  32.     &quot;&quot;&quot;</font>
<font color="black">  33. </font>
<font color="green">  34.     http_method_names = ['get', 'post', 'put', 'patch', 'delete', 'head', 'options', 'trace']</font>
<font color="black">  35. </font>
<font color="green">  36.     def __init__(self, **kwargs):</font>
<font color="black">  37.         &quot;&quot;&quot;</font>
<font color="black">  38.         Constructor. Called in the URLconf; can contain helpful extra</font>
<font color="black">  39.         keyword arguments, and other things.</font>
<font color="black">  40.         &quot;&quot;&quot;</font>
<font color="black">  41.         # Go through keyword arguments, and either save their values to our</font>
<font color="black">  42.         # instance, or raise an error.</font>
<font color="red">  43.         for key, value in six.iteritems(kwargs):</font>
<font color="red">  44.             setattr(self, key, value)</font>
<font color="black">  45. </font>
<font color="green">  46.     @classonlymethod</font>
<font color="black">  47.     def as_view(cls, **initkwargs):</font>
<font color="black">  48.         &quot;&quot;&quot;</font>
<font color="black">  49.         Main entry point for a request-response process.</font>
<font color="black">  50.         &quot;&quot;&quot;</font>
<font color="red">  51.         for key in initkwargs:</font>
<font color="red">  52.             if key in cls.http_method_names:</font>
<font color="red">  53.                 raise TypeError(&quot;You tried to pass in the %s method name as a &quot;</font>
<font color="black">  54.                                 &quot;keyword argument to %s(). Don't do that.&quot;</font>
<font color="red">  55.                                 % (key, cls.__name__))</font>
<font color="red">  56.             if not hasattr(cls, key):</font>
<font color="red">  57.                 raise TypeError(&quot;%s() received an invalid keyword %r. as_view &quot;</font>
<font color="black">  58.                                 &quot;only accepts arguments that are already &quot;</font>
<font color="red">  59.                                 &quot;attributes of the class.&quot; % (cls.__name__, key))</font>
<font color="black">  60. </font>
<font color="red">  61.         def view(request, *args, **kwargs):</font>
<font color="red">  62.             self = cls(**initkwargs)</font>
<font color="red">  63.             if hasattr(self, 'get') and not hasattr(self, 'head'):</font>
<font color="red">  64.                 self.head = self.get</font>
<font color="red">  65.             self.request = request</font>
<font color="red">  66.             self.args = args</font>
<font color="red">  67.             self.kwargs = kwargs</font>
<font color="red">  68.             return self.dispatch(request, *args, **kwargs)</font>
<font color="red">  69.         view.view_class = cls</font>
<font color="red">  70.         view.view_initkwargs = initkwargs</font>
<font color="black">  71. </font>
<font color="black">  72.         # take name and docstring from class</font>
<font color="red">  73.         update_wrapper(view, cls, updated=())</font>
<font color="black">  74. </font>
<font color="black">  75.         # and possible attributes set by decorators</font>
<font color="black">  76.         # like csrf_exempt from dispatch</font>
<font color="red">  77.         update_wrapper(view, cls.dispatch, assigned=())</font>
<font color="red">  78.         return view</font>
<font color="black">  79. </font>
<font color="green">  80.     def dispatch(self, request, *args, **kwargs):</font>
<font color="black">  81.         # Try to dispatch to the right method; if a method doesn't exist,</font>
<font color="black">  82.         # defer to the error handler. Also defer to the error handler if the</font>
<font color="black">  83.         # request method isn't on the approved list.</font>
<font color="red">  84.         if request.method.lower() in self.http_method_names:</font>
<font color="red">  85.             handler = getattr(self, request.method.lower(), self.http_method_not_allowed)</font>
<font color="black">  86.         else:</font>
<font color="red">  87.             handler = self.http_method_not_allowed</font>
<font color="red">  88.         return handler(request, *args, **kwargs)</font>
<font color="black">  89. </font>
<font color="green">  90.     def http_method_not_allowed(self, request, *args, **kwargs):</font>
<font color="red">  91.         logger.warning('Method Not Allowed (%s): %s', request.method, request.path,</font>
<font color="red">  92.             extra={</font>
<font color="red">  93.                 'status_code': 405,</font>
<font color="red">  94.                 'request': request</font>
<font color="black">  95.             }</font>
<font color="black">  96.         )</font>
<font color="red">  97.         return http.HttpResponseNotAllowed(self._allowed_methods())</font>
<font color="black">  98. </font>
<font color="green">  99.     def options(self, request, *args, **kwargs):</font>
<font color="black"> 100.         &quot;&quot;&quot;</font>
<font color="black"> 101.         Handles responding to requests for the OPTIONS HTTP verb.</font>
<font color="black"> 102.         &quot;&quot;&quot;</font>
<font color="red"> 103.         response = http.HttpResponse()</font>
<font color="red"> 104.         response['Allow'] = ', '.join(self._allowed_methods())</font>
<font color="red"> 105.         response['Content-Length'] = '0'</font>
<font color="red"> 106.         return response</font>
<font color="black"> 107. </font>
<font color="green"> 108.     def _allowed_methods(self):</font>
<font color="red"> 109.         return [m.upper() for m in self.http_method_names if hasattr(self, m)]</font>
<font color="black"> 110. </font>
<font color="black"> 111. </font>
<font color="green"> 112. class TemplateResponseMixin(object):</font>
<font color="black"> 113.     &quot;&quot;&quot;</font>
<font color="black"> 114.     A mixin that can be used to render a template.</font>
<font color="green"> 115.     &quot;&quot;&quot;</font>
<font color="green"> 116.     template_name = None</font>
<font color="green"> 117.     template_engine = None</font>
<font color="green"> 118.     response_class = TemplateResponse</font>
<font color="green"> 119.     content_type = None</font>
<font color="black"> 120. </font>
<font color="green"> 121.     def render_to_response(self, context, **response_kwargs):</font>
<font color="black"> 122.         &quot;&quot;&quot;</font>
<font color="black"> 123.         Returns a response, using the `response_class` for this</font>
<font color="black"> 124.         view, with a template rendered with the given context.</font>
<font color="black"> 125. </font>
<font color="black"> 126.         If any keyword arguments are provided, they will be</font>
<font color="black"> 127.         passed to the constructor of the response class.</font>
<font color="black"> 128.         &quot;&quot;&quot;</font>
<font color="red"> 129.         response_kwargs.setdefault('content_type', self.content_type)</font>
<font color="red"> 130.         return self.response_class(</font>
<font color="red"> 131.             request=self.request,</font>
<font color="red"> 132.             template=self.get_template_names(),</font>
<font color="red"> 133.             context=context,</font>
<font color="red"> 134.             using=self.template_engine,</font>
<font color="red"> 135.             **response_kwargs</font>
<font color="black"> 136.         )</font>
<font color="black"> 137. </font>
<font color="green"> 138.     def get_template_names(self):</font>
<font color="black"> 139.         &quot;&quot;&quot;</font>
<font color="black"> 140.         Returns a list of template names to be used for the request. Must return</font>
<font color="black"> 141.         a list. May not be called if render_to_response is overridden.</font>
<font color="black"> 142.         &quot;&quot;&quot;</font>
<font color="red"> 143.         if self.template_name is None:</font>
<font color="red"> 144.             raise ImproperlyConfigured(</font>
<font color="red"> 145.                 &quot;TemplateResponseMixin requires either a definition of &quot;</font>
<font color="black"> 146.                 &quot;'template_name' or an implementation of 'get_template_names()'&quot;)</font>
<font color="black"> 147.         else:</font>
<font color="red"> 148.             return [self.template_name]</font>
<font color="black"> 149. </font>
<font color="black"> 150. </font>
<font color="green"> 151. class TemplateView(TemplateResponseMixin, ContextMixin, View):</font>
<font color="black"> 152.     &quot;&quot;&quot;</font>
<font color="black"> 153.     A view that renders a template.  This view will also pass into the context</font>
<font color="black"> 154.     any keyword arguments passed by the URLconf.</font>
<font color="green"> 155.     &quot;&quot;&quot;</font>
<font color="green"> 156.     def get(self, request, *args, **kwargs):</font>
<font color="red"> 157.         context = self.get_context_data(**kwargs)</font>
<font color="red"> 158.         return self.render_to_response(context)</font>
<font color="black"> 159. </font>
<font color="black"> 160. </font>
<font color="green"> 161. class RedirectView(View):</font>
<font color="black"> 162.     &quot;&quot;&quot;</font>
<font color="black"> 163.     A view that provides a redirect on any GET request.</font>
<font color="green"> 164.     &quot;&quot;&quot;</font>
<font color="green"> 165.     permanent = False</font>
<font color="green"> 166.     url = None</font>
<font color="green"> 167.     pattern_name = None</font>
<font color="green"> 168.     query_string = False</font>
<font color="black"> 169. </font>
<font color="green"> 170.     def get_redirect_url(self, *args, **kwargs):</font>
<font color="black"> 171.         &quot;&quot;&quot;</font>
<font color="black"> 172.         Return the URL redirect to. Keyword arguments from the</font>
<font color="black"> 173.         URL pattern match generating the redirect request</font>
<font color="black"> 174.         are provided as kwargs to this method.</font>
<font color="black"> 175.         &quot;&quot;&quot;</font>
<font color="red"> 176.         if self.url:</font>
<font color="red"> 177.             url = self.url % kwargs</font>
<font color="red"> 178.         elif self.pattern_name:</font>
<font color="red"> 179.             try:</font>
<font color="red"> 180.                 url = reverse(self.pattern_name, args=args, kwargs=kwargs)</font>
<font color="red"> 181.             except NoReverseMatch:</font>
<font color="red"> 182.                 return None</font>
<font color="black"> 183.         else:</font>
<font color="red"> 184.             return None</font>
<font color="black"> 185. </font>
<font color="red"> 186.         args = self.request.META.get('QUERY_STRING', '')</font>
<font color="red"> 187.         if args and self.query_string:</font>
<font color="red"> 188.             url = &quot;%s?%s&quot; % (url, args)</font>
<font color="red"> 189.         return url</font>
<font color="black"> 190. </font>
<font color="green"> 191.     def get(self, request, *args, **kwargs):</font>
<font color="red"> 192.         url = self.get_redirect_url(*args, **kwargs)</font>
<font color="red"> 193.         if url:</font>
<font color="red"> 194.             if self.permanent:</font>
<font color="red"> 195.                 return http.HttpResponsePermanentRedirect(url)</font>
<font color="black"> 196.             else:</font>
<font color="red"> 197.                 return http.HttpResponseRedirect(url)</font>
<font color="black"> 198.         else:</font>
<font color="red"> 199.             logger.warning('Gone: %s', request.path,</font>
<font color="red"> 200.                         extra={</font>
<font color="red"> 201.                             'status_code': 410,</font>
<font color="red"> 202.                             'request': request</font>
<font color="black"> 203.                         })</font>
<font color="red"> 204.             return http.HttpResponseGone()</font>
<font color="black"> 205. </font>
<font color="green"> 206.     def head(self, request, *args, **kwargs):</font>
<font color="red"> 207.         return self.get(request, *args, **kwargs)</font>
<font color="black"> 208. </font>
<font color="green"> 209.     def post(self, request, *args, **kwargs):</font>
<font color="red"> 210.         return self.get(request, *args, **kwargs)</font>
<font color="black"> 211. </font>
<font color="green"> 212.     def options(self, request, *args, **kwargs):</font>
<font color="red"> 213.         return self.get(request, *args, **kwargs)</font>
<font color="black"> 214. </font>
<font color="green"> 215.     def delete(self, request, *args, **kwargs):</font>
<font color="red"> 216.         return self.get(request, *args, **kwargs)</font>
<font color="black"> 217. </font>
<font color="green"> 218.     def put(self, request, *args, **kwargs):</font>
<font color="red"> 219.         return self.get(request, *args, **kwargs)</font>
<font color="black"> 220. </font>
<font color="green"> 221.     def patch(self, request, *args, **kwargs):</font>
<font color="red"> 222.         return self.get(request, *args, **kwargs)</font>
</pre>


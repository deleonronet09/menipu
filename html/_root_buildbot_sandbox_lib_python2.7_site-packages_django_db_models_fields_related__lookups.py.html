source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/models/fields/related_lookups.py</b><br>


file stats: <b>85 lines, 40 executed: 47.1% covered</b>
<pre>
<font color="green">   1. from django.db.models.lookups import (</font>
<font color="black">   2.     Exact, GreaterThan, GreaterThanOrEqual, In, LessThan, LessThanOrEqual,</font>
<font color="black">   3. )</font>
<font color="black">   4. </font>
<font color="black">   5. </font>
<font color="green">   6. class MultiColSource(object):</font>
<font color="green">   7.     contains_aggregate = False</font>
<font color="black">   8. </font>
<font color="green">   9.     def __init__(self, alias, targets, sources, field):</font>
<font color="red">  10.         self.targets, self.sources, self.field, self.alias = targets, sources, field, alias</font>
<font color="red">  11.         self.output_field = self.field</font>
<font color="black">  12. </font>
<font color="green">  13.     def __repr__(self):</font>
<font color="red">  14.         return &quot;{}({}, {})&quot;.format(</font>
<font color="red">  15.             self.__class__.__name__, self.alias, self.field)</font>
<font color="black">  16. </font>
<font color="green">  17.     def relabeled_clone(self, relabels):</font>
<font color="red">  18.         return self.__class__(relabels.get(self.alias, self.alias),</font>
<font color="red">  19.                               self.targets, self.sources, self.field)</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. def get_normalized_value(value, lhs):</font>
<font color="green">  23.     from django.db.models import Model</font>
<font color="green">  24.     if isinstance(value, Model):</font>
<font color="green">  25.         value_list = []</font>
<font color="black">  26.         # A case like Restaurant.objects.filter(place=restaurant_instance),</font>
<font color="black">  27.         # where place is a OneToOneField and the primary key of Restaurant.</font>
<font color="green">  28.         if getattr(lhs.output_field, 'primary_key', False):</font>
<font color="red">  29.             return (value.pk,)</font>
<font color="green">  30.         sources = lhs.output_field.get_path_info()[-1].target_fields</font>
<font color="green">  31.         for source in sources:</font>
<font color="green">  32.             while not isinstance(value, source.model) and source.remote_field:</font>
<font color="red">  33.                 source = source.remote_field.model._meta.get_field(source.remote_field.field_name)</font>
<font color="green">  34.             value_list.append(getattr(value, source.attname))</font>
<font color="green">  35.         return tuple(value_list)</font>
<font color="red">  36.     if not isinstance(value, tuple):</font>
<font color="red">  37.         return (value,)</font>
<font color="red">  38.     return value</font>
<font color="black">  39. </font>
<font color="black">  40. </font>
<font color="green">  41. class RelatedIn(In):</font>
<font color="green">  42.     def get_prep_lookup(self):</font>
<font color="green">  43.         if not isinstance(self.lhs, MultiColSource) and self.rhs_is_direct_value():</font>
<font color="black">  44.             # If we get here, we are dealing with single-column relations.</font>
<font color="green">  45.             self.rhs = [get_normalized_value(val, self.lhs)[0] for val in self.rhs]</font>
<font color="black">  46.             # We need to run the related field's get_prep_lookup(). Consider case</font>
<font color="black">  47.             # ForeignKey to IntegerField given value 'abc'. The ForeignKey itself</font>
<font color="black">  48.             # doesn't have validation for non-integers, so we must run validation</font>
<font color="black">  49.             # using the target field.</font>
<font color="green">  50.             if hasattr(self.lhs.output_field, 'get_path_info'):</font>
<font color="black">  51.                 # Run the target field's get_prep_lookup. We can safely assume there is</font>
<font color="black">  52.                 # only one as we don't get to the direct value branch otherwise.</font>
<font color="green">  53.                 self.rhs = self.lhs.output_field.get_path_info()[-1].target_fields[-1].get_prep_lookup(</font>
<font color="green">  54.                     self.lookup_name, self.rhs)</font>
<font color="green">  55.         return super(RelatedIn, self).get_prep_lookup()</font>
<font color="black">  56. </font>
<font color="green">  57.     def as_sql(self, compiler, connection):</font>
<font color="green">  58.         if isinstance(self.lhs, MultiColSource):</font>
<font color="black">  59.             # For multicolumn lookups we need to build a multicolumn where clause.</font>
<font color="black">  60.             # This clause is either a SubqueryConstraint (for values that need to be compiled to</font>
<font color="black">  61.             # SQL) or a OR-combined list of (col1 = val1 AND col2 = val2 AND ...) clauses.</font>
<font color="red">  62.             from django.db.models.sql.where import WhereNode, SubqueryConstraint, AND, OR</font>
<font color="black">  63. </font>
<font color="red">  64.             root_constraint = WhereNode(connector=OR)</font>
<font color="red">  65.             if self.rhs_is_direct_value():</font>
<font color="red">  66.                 values = [get_normalized_value(value, self.lhs) for value in self.rhs]</font>
<font color="red">  67.                 for value in values:</font>
<font color="red">  68.                     value_constraint = WhereNode()</font>
<font color="red">  69.                     for source, target, val in zip(self.lhs.sources, self.lhs.targets, value):</font>
<font color="red">  70.                         lookup_class = target.get_lookup('exact')</font>
<font color="red">  71.                         lookup = lookup_class(target.get_col(self.lhs.alias, source), val)</font>
<font color="red">  72.                         value_constraint.add(lookup, AND)</font>
<font color="red">  73.                     root_constraint.add(value_constraint, OR)</font>
<font color="black">  74.             else:</font>
<font color="red">  75.                 root_constraint.add(</font>
<font color="red">  76.                     SubqueryConstraint(</font>
<font color="red">  77.                         self.lhs.alias, [target.column for target in self.lhs.targets],</font>
<font color="red">  78.                         [source.name for source in self.lhs.sources], self.rhs),</font>
<font color="red">  79.                     AND)</font>
<font color="red">  80.             return root_constraint.as_sql(compiler, connection)</font>
<font color="black">  81.         else:</font>
<font color="green">  82.             return super(RelatedIn, self).as_sql(compiler, connection)</font>
<font color="black">  83. </font>
<font color="black">  84. </font>
<font color="green">  85. class RelatedLookupMixin(object):</font>
<font color="green">  86.     def get_prep_lookup(self):</font>
<font color="red">  87.         if not isinstance(self.lhs, MultiColSource) and self.rhs_is_direct_value():</font>
<font color="black">  88.             # If we get here, we are dealing with single-column relations.</font>
<font color="red">  89.             self.rhs = get_normalized_value(self.rhs, self.lhs)[0]</font>
<font color="black">  90.             # We need to run the related field's get_prep_lookup(). Consider case</font>
<font color="black">  91.             # ForeignKey to IntegerField given value 'abc'. The ForeignKey itself</font>
<font color="black">  92.             # doesn't have validation for non-integers, so we must run validation</font>
<font color="black">  93.             # using the target field.</font>
<font color="red">  94.             if hasattr(self.lhs.output_field, 'get_path_info'):</font>
<font color="black">  95.                 # Get the target field. We can safely assume there is only one</font>
<font color="black">  96.                 # as we don't get to the direct value branch otherwise.</font>
<font color="red">  97.                 self.rhs = self.lhs.output_field.get_path_info()[-1].target_fields[-1].get_prep_lookup(</font>
<font color="red">  98.                     self.lookup_name, self.rhs)</font>
<font color="black">  99. </font>
<font color="red"> 100.         return super(RelatedLookupMixin, self).get_prep_lookup()</font>
<font color="black"> 101. </font>
<font color="green"> 102.     def as_sql(self, compiler, connection):</font>
<font color="red"> 103.         if isinstance(self.lhs, MultiColSource):</font>
<font color="red"> 104.             assert self.rhs_is_direct_value()</font>
<font color="red"> 105.             self.rhs = get_normalized_value(self.rhs, self.lhs)</font>
<font color="red"> 106.             from django.db.models.sql.where import WhereNode, AND</font>
<font color="red"> 107.             root_constraint = WhereNode()</font>
<font color="red"> 108.             for target, source, val in zip(self.lhs.targets, self.lhs.sources, self.rhs):</font>
<font color="red"> 109.                 lookup_class = target.get_lookup(self.lookup_name)</font>
<font color="red"> 110.                 root_constraint.add(</font>
<font color="red"> 111.                     lookup_class(target.get_col(self.lhs.alias, source), val), AND)</font>
<font color="red"> 112.             return root_constraint.as_sql(compiler, connection)</font>
<font color="red"> 113.         return super(RelatedLookupMixin, self).as_sql(compiler, connection)</font>
<font color="black"> 114. </font>
<font color="black"> 115. </font>
<font color="green"> 116. class RelatedExact(RelatedLookupMixin, Exact):</font>
<font color="green"> 117.     pass</font>
<font color="black"> 118. </font>
<font color="black"> 119. </font>
<font color="green"> 120. class RelatedLessThan(RelatedLookupMixin, LessThan):</font>
<font color="green"> 121.     pass</font>
<font color="black"> 122. </font>
<font color="black"> 123. </font>
<font color="green"> 124. class RelatedGreaterThan(RelatedLookupMixin, GreaterThan):</font>
<font color="green"> 125.     pass</font>
<font color="black"> 126. </font>
<font color="black"> 127. </font>
<font color="green"> 128. class RelatedGreaterThanOrEqual(RelatedLookupMixin, GreaterThanOrEqual):</font>
<font color="green"> 129.     pass</font>
<font color="black"> 130. </font>
<font color="black"> 131. </font>
<font color="green"> 132. class RelatedLessThanOrEqual(RelatedLookupMixin, LessThanOrEqual):</font>
<font color="green"> 133.     pass</font>
</pre>


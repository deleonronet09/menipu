source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/core/signing.py</b><br>


file stats: <b>103 lines, 41 executed: 39.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Functions for creating and restoring url-safe signed JSON objects.</font>
<font color="black">   3. </font>
<font color="black">   4. The format used looks like this:</font>
<font color="black">   5. </font>
<font color="black">   6. &gt;&gt;&gt; signing.dumps(&quot;hello&quot;)</font>
<font color="black">   7. 'ImhlbGxvIg:1QaUZC:YIye-ze3TTx7gtSv422nZA4sgmk'</font>
<font color="black">   8. </font>
<font color="black">   9. There are two components here, separated by a ':'. The first component is a</font>
<font color="black">  10. URLsafe base64 encoded JSON of the object passed to dumps(). The second</font>
<font color="black">  11. component is a base64 encoded hmac/SHA1 hash of &quot;$first_component:$secret&quot;</font>
<font color="black">  12. </font>
<font color="black">  13. signing.loads(s) checks the signature and returns the deserialized object.</font>
<font color="black">  14. If the signature fails, a BadSignature exception is raised.</font>
<font color="black">  15. </font>
<font color="black">  16. &gt;&gt;&gt; signing.loads(&quot;ImhlbGxvIg:1QaUZC:YIye-ze3TTx7gtSv422nZA4sgmk&quot;)</font>
<font color="black">  17. u'hello'</font>
<font color="black">  18. &gt;&gt;&gt; signing.loads(&quot;ImhlbGxvIg:1QaUZC:YIye-ze3TTx7gtSv422nZA4sgmk-modified&quot;)</font>
<font color="black">  19. ...</font>
<font color="black">  20. BadSignature: Signature failed: ImhlbGxvIg:1QaUZC:YIye-ze3TTx7gtSv422nZA4sgmk-modified</font>
<font color="black">  21. </font>
<font color="black">  22. You can optionally compress the JSON prior to base64 encoding it to save</font>
<font color="black">  23. space, using the compress=True argument. This checks if compression actually</font>
<font color="black">  24. helps and only applies compression if the result is a shorter string:</font>
<font color="black">  25. </font>
<font color="black">  26. &gt;&gt;&gt; signing.dumps(range(1, 20), compress=True)</font>
<font color="black">  27. '.eJwFwcERACAIwLCF-rCiILN47r-GyZVJsNgkxaFxoDgxcOHGxMKD_T7vhAml:1QaUaL:BA0thEZrp4FQVXIXuOvYJtLJSrQ'</font>
<font color="black">  28. </font>
<font color="black">  29. The fact that the string is compressed is signalled by the prefixed '.' at the</font>
<font color="black">  30. start of the base64 JSON.</font>
<font color="black">  31. </font>
<font color="black">  32. There are 65 url-safe characters: the 64 used by url-safe base64 and the ':'.</font>
<font color="black">  33. These functions make use of all of them.</font>
<font color="green">  34. &quot;&quot;&quot;</font>
<font color="black">  35. </font>
<font color="green">  36. from __future__ import unicode_literals</font>
<font color="black">  37. </font>
<font color="green">  38. import base64</font>
<font color="green">  39. import datetime</font>
<font color="green">  40. import json</font>
<font color="green">  41. import re</font>
<font color="green">  42. import time</font>
<font color="green">  43. import warnings</font>
<font color="green">  44. import zlib</font>
<font color="black">  45. </font>
<font color="green">  46. from django.conf import settings</font>
<font color="green">  47. from django.utils import baseconv</font>
<font color="green">  48. from django.utils.crypto import constant_time_compare, salted_hmac</font>
<font color="green">  49. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  50. from django.utils.encoding import force_bytes, force_str, force_text</font>
<font color="green">  51. from django.utils.module_loading import import_string</font>
<font color="black">  52. </font>
<font color="green">  53. _SEP_UNSAFE = re.compile(r'^[A-z0-9-_=]*$')</font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="green">  56. class BadSignature(Exception):</font>
<font color="black">  57.     &quot;&quot;&quot;</font>
<font color="black">  58.     Signature does not match</font>
<font color="green">  59.     &quot;&quot;&quot;</font>
<font color="green">  60.     pass</font>
<font color="black">  61. </font>
<font color="black">  62. </font>
<font color="green">  63. class SignatureExpired(BadSignature):</font>
<font color="black">  64.     &quot;&quot;&quot;</font>
<font color="black">  65.     Signature timestamp is older than required max_age</font>
<font color="green">  66.     &quot;&quot;&quot;</font>
<font color="green">  67.     pass</font>
<font color="black">  68. </font>
<font color="black">  69. </font>
<font color="green">  70. def b64_encode(s):</font>
<font color="red">  71.     return base64.urlsafe_b64encode(s).strip(b'=')</font>
<font color="black">  72. </font>
<font color="black">  73. </font>
<font color="green">  74. def b64_decode(s):</font>
<font color="red">  75.     pad = b'=' * (-len(s) % 4)</font>
<font color="red">  76.     return base64.urlsafe_b64decode(s + pad)</font>
<font color="black">  77. </font>
<font color="black">  78. </font>
<font color="green">  79. def base64_hmac(salt, value, key):</font>
<font color="red">  80.     return b64_encode(salted_hmac(salt, value, key).digest())</font>
<font color="black">  81. </font>
<font color="black">  82. </font>
<font color="green">  83. def get_cookie_signer(salt='django.core.signing.get_cookie_signer'):</font>
<font color="red">  84.     Signer = import_string(settings.SIGNING_BACKEND)</font>
<font color="red">  85.     key = force_bytes(settings.SECRET_KEY)</font>
<font color="red">  86.     return Signer(b'django.http.cookies' + key, salt=salt)</font>
<font color="black">  87. </font>
<font color="black">  88. </font>
<font color="green">  89. class JSONSerializer(object):</font>
<font color="black">  90.     &quot;&quot;&quot;</font>
<font color="black">  91.     Simple wrapper around json to be used in signing.dumps and</font>
<font color="black">  92.     signing.loads.</font>
<font color="green">  93.     &quot;&quot;&quot;</font>
<font color="green">  94.     def dumps(self, obj):</font>
<font color="red">  95.         return json.dumps(obj, separators=(',', ':')).encode('latin-1')</font>
<font color="black">  96. </font>
<font color="green">  97.     def loads(self, data):</font>
<font color="red">  98.         return json.loads(data.decode('latin-1'))</font>
<font color="black">  99. </font>
<font color="black"> 100. </font>
<font color="green"> 101. def dumps(obj, key=None, salt='django.core.signing', serializer=JSONSerializer, compress=False):</font>
<font color="black"> 102.     &quot;&quot;&quot;</font>
<font color="black"> 103.     Returns URL-safe, sha1 signed base64 compressed JSON string. If key is</font>
<font color="black"> 104.     None, settings.SECRET_KEY is used instead.</font>
<font color="black"> 105. </font>
<font color="black"> 106.     If compress is True (not the default) checks if compressing using zlib can</font>
<font color="black"> 107.     save some space. Prepends a '.' to signify compression. This is included</font>
<font color="black"> 108.     in the signature, to protect against zip bombs.</font>
<font color="black"> 109. </font>
<font color="black"> 110.     Salt can be used to namespace the hash, so that a signed string is</font>
<font color="black"> 111.     only valid for a given namespace. Leaving this at the default</font>
<font color="black"> 112.     value or re-using a salt value across different parts of your</font>
<font color="black"> 113.     application without good cause is a security risk.</font>
<font color="black"> 114. </font>
<font color="black"> 115.     The serializer is expected to return a bytestring.</font>
<font color="black"> 116.     &quot;&quot;&quot;</font>
<font color="red"> 117.     data = serializer().dumps(obj)</font>
<font color="black"> 118. </font>
<font color="black"> 119.     # Flag for if it's been compressed or not</font>
<font color="red"> 120.     is_compressed = False</font>
<font color="black"> 121. </font>
<font color="red"> 122.     if compress:</font>
<font color="black"> 123.         # Avoid zlib dependency unless compress is being used</font>
<font color="red"> 124.         compressed = zlib.compress(data)</font>
<font color="red"> 125.         if len(compressed) &lt; (len(data) - 1):</font>
<font color="red"> 126.             data = compressed</font>
<font color="red"> 127.             is_compressed = True</font>
<font color="red"> 128.     base64d = b64_encode(data)</font>
<font color="red"> 129.     if is_compressed:</font>
<font color="red"> 130.         base64d = b'.' + base64d</font>
<font color="red"> 131.     return TimestampSigner(key, salt=salt).sign(base64d)</font>
<font color="black"> 132. </font>
<font color="black"> 133. </font>
<font color="green"> 134. def loads(s, key=None, salt='django.core.signing', serializer=JSONSerializer, max_age=None):</font>
<font color="black"> 135.     &quot;&quot;&quot;</font>
<font color="black"> 136.     Reverse of dumps(), raises BadSignature if signature fails.</font>
<font color="black"> 137. </font>
<font color="black"> 138.     The serializer is expected to accept a bytestring.</font>
<font color="black"> 139.     &quot;&quot;&quot;</font>
<font color="black"> 140.     # TimestampSigner.unsign always returns unicode but base64 and zlib</font>
<font color="black"> 141.     # compression operate on bytes.</font>
<font color="red"> 142.     base64d = force_bytes(TimestampSigner(key, salt=salt).unsign(s, max_age=max_age))</font>
<font color="red"> 143.     decompress = False</font>
<font color="red"> 144.     if base64d[:1] == b'.':</font>
<font color="black"> 145.         # It's compressed; uncompress it first</font>
<font color="red"> 146.         base64d = base64d[1:]</font>
<font color="red"> 147.         decompress = True</font>
<font color="red"> 148.     data = b64_decode(base64d)</font>
<font color="red"> 149.     if decompress:</font>
<font color="red"> 150.         data = zlib.decompress(data)</font>
<font color="red"> 151.     return serializer().loads(data)</font>
<font color="black"> 152. </font>
<font color="black"> 153. </font>
<font color="green"> 154. class Signer(object):</font>
<font color="black"> 155. </font>
<font color="green"> 156.     def __init__(self, key=None, sep=':', salt=None):</font>
<font color="black"> 157.         # Use of native strings in all versions of Python</font>
<font color="red"> 158.         self.key = key or settings.SECRET_KEY</font>
<font color="red"> 159.         self.sep = force_str(sep)</font>
<font color="red"> 160.         if _SEP_UNSAFE.match(self.sep):</font>
<font color="red"> 161.             warnings.warn('Unsafe Signer separator: %r (cannot be empty or consist of only A-z0-9-_=)' % sep,</font>
<font color="red"> 162.                           RemovedInDjango110Warning)</font>
<font color="red"> 163.         self.salt = force_str(salt or</font>
<font color="red"> 164.             '%s.%s' % (self.__class__.__module__, self.__class__.__name__))</font>
<font color="black"> 165. </font>
<font color="green"> 166.     def signature(self, value):</font>
<font color="red"> 167.         signature = base64_hmac(self.salt + 'signer', value, self.key)</font>
<font color="black"> 168.         # Convert the signature from bytes to str only on Python 3</font>
<font color="red"> 169.         return force_str(signature)</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def sign(self, value):</font>
<font color="red"> 172.         value = force_str(value)</font>
<font color="red"> 173.         return str('%s%s%s') % (value, self.sep, self.signature(value))</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def unsign(self, signed_value):</font>
<font color="red"> 176.         signed_value = force_str(signed_value)</font>
<font color="red"> 177.         if self.sep not in signed_value:</font>
<font color="red"> 178.             raise BadSignature('No &quot;%s&quot; found in value' % self.sep)</font>
<font color="red"> 179.         value, sig = signed_value.rsplit(self.sep, 1)</font>
<font color="red"> 180.         if constant_time_compare(sig, self.signature(value)):</font>
<font color="red"> 181.             return force_text(value)</font>
<font color="red"> 182.         raise BadSignature('Signature &quot;%s&quot; does not match' % sig)</font>
<font color="black"> 183. </font>
<font color="black"> 184. </font>
<font color="green"> 185. class TimestampSigner(Signer):</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def timestamp(self):</font>
<font color="red"> 188.         return baseconv.base62.encode(int(time.time()))</font>
<font color="black"> 189. </font>
<font color="green"> 190.     def sign(self, value):</font>
<font color="red"> 191.         value = force_str(value)</font>
<font color="red"> 192.         value = str('%s%s%s') % (value, self.sep, self.timestamp())</font>
<font color="red"> 193.         return super(TimestampSigner, self).sign(value)</font>
<font color="black"> 194. </font>
<font color="green"> 195.     def unsign(self, value, max_age=None):</font>
<font color="black"> 196.         &quot;&quot;&quot;</font>
<font color="black"> 197.         Retrieve original value and check it wasn't signed more</font>
<font color="black"> 198.         than max_age seconds ago.</font>
<font color="black"> 199.         &quot;&quot;&quot;</font>
<font color="red"> 200.         result = super(TimestampSigner, self).unsign(value)</font>
<font color="red"> 201.         value, timestamp = result.rsplit(self.sep, 1)</font>
<font color="red"> 202.         timestamp = baseconv.base62.decode(timestamp)</font>
<font color="red"> 203.         if max_age is not None:</font>
<font color="red"> 204.             if isinstance(max_age, datetime.timedelta):</font>
<font color="red"> 205.                 max_age = max_age.total_seconds()</font>
<font color="black"> 206.             # Check timestamp is not older than max_age</font>
<font color="red"> 207.             age = time.time() - timestamp</font>
<font color="red"> 208.             if age &gt; max_age:</font>
<font color="red"> 209.                 raise SignatureExpired(</font>
<font color="red"> 210.                     'Signature age %s &gt; %s seconds' % (age, max_age))</font>
<font color="red"> 211.         return value</font>
</pre>


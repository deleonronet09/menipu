source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/models/lookups.py</b><br>


file stats: <b>373 lines, 218 executed: 58.4% covered</b>
<pre>
<font color="green">   1. from copy import copy</font>
<font color="black">   2. </font>
<font color="green">   3. from django.conf import settings</font>
<font color="green">   4. from django.db.models.expressions import Func, Value</font>
<font color="green">   5. from django.db.models.fields import (</font>
<font color="black">   6.     DateField, DateTimeField, Field, IntegerField, TimeField,</font>
<font color="black">   7. )</font>
<font color="green">   8. from django.db.models.query_utils import RegisterLookupMixin</font>
<font color="green">   9. from django.utils import timezone</font>
<font color="green">  10. from django.utils.functional import cached_property</font>
<font color="green">  11. from django.utils.six.moves import range</font>
<font color="black">  12. </font>
<font color="black">  13. </font>
<font color="green">  14. class Lookup(object):</font>
<font color="green">  15.     lookup_name = None</font>
<font color="black">  16. </font>
<font color="green">  17.     def __init__(self, lhs, rhs):</font>
<font color="green">  18.         self.lhs, self.rhs = lhs, rhs</font>
<font color="green">  19.         self.rhs = self.get_prep_lookup()</font>
<font color="green">  20.         if hasattr(self.lhs, 'get_bilateral_transforms'):</font>
<font color="red">  21.             bilateral_transforms = self.lhs.get_bilateral_transforms()</font>
<font color="black">  22.         else:</font>
<font color="green">  23.             bilateral_transforms = []</font>
<font color="green">  24.         if bilateral_transforms:</font>
<font color="black">  25.             # We should warn the user as soon as possible if he is trying to apply</font>
<font color="black">  26.             # a bilateral transformation on a nested QuerySet: that won't work.</font>
<font color="black">  27.             # We need to import QuerySet here so as to avoid circular</font>
<font color="red">  28.             from django.db.models.query import QuerySet</font>
<font color="red">  29.             if isinstance(rhs, QuerySet):</font>
<font color="red">  30.                 raise NotImplementedError(&quot;Bilateral transformations on nested querysets are not supported.&quot;)</font>
<font color="green">  31.         self.bilateral_transforms = bilateral_transforms</font>
<font color="black">  32. </font>
<font color="green">  33.     def apply_bilateral_transforms(self, value):</font>
<font color="red">  34.         for transform in self.bilateral_transforms:</font>
<font color="red">  35.             value = transform(value)</font>
<font color="red">  36.         return value</font>
<font color="black">  37. </font>
<font color="green">  38.     def batch_process_rhs(self, compiler, connection, rhs=None):</font>
<font color="green">  39.         if rhs is None:</font>
<font color="red">  40.             rhs = self.rhs</font>
<font color="green">  41.         if self.bilateral_transforms:</font>
<font color="red">  42.             sqls, sqls_params = [], []</font>
<font color="red">  43.             for p in rhs:</font>
<font color="red">  44.                 value = Value(p, output_field=self.lhs.output_field)</font>
<font color="red">  45.                 value = self.apply_bilateral_transforms(value)</font>
<font color="red">  46.                 value = value.resolve_expression(compiler.query)</font>
<font color="red">  47.                 sql, sql_params = compiler.compile(value)</font>
<font color="red">  48.                 sqls.append(sql)</font>
<font color="red">  49.                 sqls_params.extend(sql_params)</font>
<font color="black">  50.         else:</font>
<font color="green">  51.             params = self.lhs.output_field.get_db_prep_lookup(</font>
<font color="green">  52.                 self.lookup_name, rhs, connection, prepared=True)</font>
<font color="green">  53.             sqls, sqls_params = ['%s'] * len(params), params</font>
<font color="green">  54.         return sqls, sqls_params</font>
<font color="black">  55. </font>
<font color="green">  56.     def get_prep_lookup(self):</font>
<font color="green">  57.         return self.lhs.output_field.get_prep_lookup(self.lookup_name, self.rhs)</font>
<font color="black">  58. </font>
<font color="green">  59.     def get_db_prep_lookup(self, value, connection):</font>
<font color="black">  60.         return (</font>
<font color="green">  61.             '%s', self.lhs.output_field.get_db_prep_lookup(</font>
<font color="green">  62.                 self.lookup_name, value, connection, prepared=True))</font>
<font color="black">  63. </font>
<font color="green">  64.     def process_lhs(self, compiler, connection, lhs=None):</font>
<font color="green">  65.         lhs = lhs or self.lhs</font>
<font color="green">  66.         return compiler.compile(lhs)</font>
<font color="black">  67. </font>
<font color="green">  68.     def process_rhs(self, compiler, connection):</font>
<font color="green">  69.         value = self.rhs</font>
<font color="green">  70.         if self.bilateral_transforms:</font>
<font color="red">  71.             if self.rhs_is_direct_value():</font>
<font color="black">  72.                 # Do not call get_db_prep_lookup here as the value will be</font>
<font color="black">  73.                 # transformed before being used for lookup</font>
<font color="red">  74.                 value = Value(value, output_field=self.lhs.output_field)</font>
<font color="red">  75.             value = self.apply_bilateral_transforms(value)</font>
<font color="red">  76.             value = value.resolve_expression(compiler.query)</font>
<font color="black">  77.         # Due to historical reasons there are a couple of different</font>
<font color="black">  78.         # ways to produce sql here. get_compiler is likely a Query</font>
<font color="black">  79.         # instance, _as_sql QuerySet and as_sql just something with</font>
<font color="black">  80.         # as_sql. Finally the value can of course be just plain</font>
<font color="black">  81.         # Python value.</font>
<font color="green">  82.         if hasattr(value, 'get_compiler'):</font>
<font color="red">  83.             value = value.get_compiler(connection=connection)</font>
<font color="green">  84.         if hasattr(value, 'as_sql'):</font>
<font color="red">  85.             sql, params = compiler.compile(value)</font>
<font color="red">  86.             return '(' + sql + ')', params</font>
<font color="green">  87.         if hasattr(value, '_as_sql'):</font>
<font color="red">  88.             sql, params = value._as_sql(connection=connection)</font>
<font color="red">  89.             return '(' + sql + ')', params</font>
<font color="black">  90.         else:</font>
<font color="green">  91.             return self.get_db_prep_lookup(value, connection)</font>
<font color="black">  92. </font>
<font color="green">  93.     def rhs_is_direct_value(self):</font>
<font color="black">  94.         return not(</font>
<font color="green">  95.             hasattr(self.rhs, 'as_sql') or</font>
<font color="green">  96.             hasattr(self.rhs, '_as_sql') or</font>
<font color="green">  97.             hasattr(self.rhs, 'get_compiler'))</font>
<font color="black">  98. </font>
<font color="green">  99.     def relabeled_clone(self, relabels):</font>
<font color="red"> 100.         new = copy(self)</font>
<font color="red"> 101.         new.lhs = new.lhs.relabeled_clone(relabels)</font>
<font color="red"> 102.         if hasattr(new.rhs, 'relabeled_clone'):</font>
<font color="red"> 103.             new.rhs = new.rhs.relabeled_clone(relabels)</font>
<font color="red"> 104.         return new</font>
<font color="black"> 105. </font>
<font color="green"> 106.     def get_group_by_cols(self):</font>
<font color="red"> 107.         cols = self.lhs.get_group_by_cols()</font>
<font color="red"> 108.         if hasattr(self.rhs, 'get_group_by_cols'):</font>
<font color="red"> 109.             cols.extend(self.rhs.get_group_by_cols())</font>
<font color="red"> 110.         return cols</font>
<font color="black"> 111. </font>
<font color="green"> 112.     def as_sql(self, compiler, connection):</font>
<font color="red"> 113.         raise NotImplementedError</font>
<font color="black"> 114. </font>
<font color="green"> 115.     @cached_property</font>
<font color="black"> 116.     def contains_aggregate(self):</font>
<font color="green"> 117.         return self.lhs.contains_aggregate or getattr(self.rhs, 'contains_aggregate', False)</font>
<font color="black"> 118. </font>
<font color="black"> 119. </font>
<font color="green"> 120. class Transform(RegisterLookupMixin, Func):</font>
<font color="black"> 121.     &quot;&quot;&quot;</font>
<font color="black"> 122.     RegisterLookupMixin() is first so that get_lookup() and get_transform()</font>
<font color="black"> 123.     first examine self and then check output_field.</font>
<font color="green"> 124.     &quot;&quot;&quot;</font>
<font color="green"> 125.     bilateral = False</font>
<font color="black"> 126. </font>
<font color="green"> 127.     def __init__(self, expression, **extra):</font>
<font color="black"> 128.         # Restrict Transform to allow only a single expression.</font>
<font color="red"> 129.         super(Transform, self).__init__(expression, **extra)</font>
<font color="black"> 130. </font>
<font color="green"> 131.     @property</font>
<font color="black"> 132.     def lhs(self):</font>
<font color="red"> 133.         return self.get_source_expressions()[0]</font>
<font color="black"> 134. </font>
<font color="green"> 135.     def get_bilateral_transforms(self):</font>
<font color="red"> 136.         if hasattr(self.lhs, 'get_bilateral_transforms'):</font>
<font color="red"> 137.             bilateral_transforms = self.lhs.get_bilateral_transforms()</font>
<font color="black"> 138.         else:</font>
<font color="red"> 139.             bilateral_transforms = []</font>
<font color="red"> 140.         if self.bilateral:</font>
<font color="red"> 141.             bilateral_transforms.append(self.__class__)</font>
<font color="red"> 142.         return bilateral_transforms</font>
<font color="black"> 143. </font>
<font color="black"> 144. </font>
<font color="green"> 145. class BuiltinLookup(Lookup):</font>
<font color="green"> 146.     def process_lhs(self, compiler, connection, lhs=None):</font>
<font color="green"> 147.         lhs_sql, params = super(BuiltinLookup, self).process_lhs(</font>
<font color="green"> 148.             compiler, connection, lhs)</font>
<font color="green"> 149.         field_internal_type = self.lhs.output_field.get_internal_type()</font>
<font color="green"> 150.         db_type = self.lhs.output_field.db_type(connection=connection)</font>
<font color="green"> 151.         lhs_sql = connection.ops.field_cast_sql(</font>
<font color="green"> 152.             db_type, field_internal_type) % lhs_sql</font>
<font color="green"> 153.         lhs_sql = connection.ops.lookup_cast(self.lookup_name, field_internal_type) % lhs_sql</font>
<font color="green"> 154.         return lhs_sql, list(params)</font>
<font color="black"> 155. </font>
<font color="green"> 156.     def as_sql(self, compiler, connection):</font>
<font color="green"> 157.         lhs_sql, params = self.process_lhs(compiler, connection)</font>
<font color="green"> 158.         rhs_sql, rhs_params = self.process_rhs(compiler, connection)</font>
<font color="green"> 159.         params.extend(rhs_params)</font>
<font color="green"> 160.         rhs_sql = self.get_rhs_op(connection, rhs_sql)</font>
<font color="green"> 161.         return '%s %s' % (lhs_sql, rhs_sql), params</font>
<font color="black"> 162. </font>
<font color="green"> 163.     def get_rhs_op(self, connection, rhs):</font>
<font color="green"> 164.         return connection.operators[self.lookup_name] % rhs</font>
<font color="black"> 165. </font>
<font color="black"> 166. </font>
<font color="green"> 167. class Exact(BuiltinLookup):</font>
<font color="green"> 168.     lookup_name = 'exact'</font>
<font color="green"> 169. Field.register_lookup(Exact)</font>
<font color="black"> 170. </font>
<font color="black"> 171. </font>
<font color="green"> 172. class IExact(BuiltinLookup):</font>
<font color="green"> 173.     lookup_name = 'iexact'</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def process_rhs(self, qn, connection):</font>
<font color="red"> 176.         rhs, params = super(IExact, self).process_rhs(qn, connection)</font>
<font color="red"> 177.         if params:</font>
<font color="red"> 178.             params[0] = connection.ops.prep_for_iexact_query(params[0])</font>
<font color="red"> 179.         return rhs, params</font>
<font color="black"> 180. </font>
<font color="black"> 181. </font>
<font color="green"> 182. Field.register_lookup(IExact)</font>
<font color="black"> 183. </font>
<font color="black"> 184. </font>
<font color="green"> 185. class GreaterThan(BuiltinLookup):</font>
<font color="green"> 186.     lookup_name = 'gt'</font>
<font color="green"> 187. Field.register_lookup(GreaterThan)</font>
<font color="black"> 188. </font>
<font color="black"> 189. </font>
<font color="green"> 190. class GreaterThanOrEqual(BuiltinLookup):</font>
<font color="green"> 191.     lookup_name = 'gte'</font>
<font color="green"> 192. Field.register_lookup(GreaterThanOrEqual)</font>
<font color="black"> 193. </font>
<font color="black"> 194. </font>
<font color="green"> 195. class LessThan(BuiltinLookup):</font>
<font color="green"> 196.     lookup_name = 'lt'</font>
<font color="green"> 197. Field.register_lookup(LessThan)</font>
<font color="black"> 198. </font>
<font color="black"> 199. </font>
<font color="green"> 200. class LessThanOrEqual(BuiltinLookup):</font>
<font color="green"> 201.     lookup_name = 'lte'</font>
<font color="green"> 202. Field.register_lookup(LessThanOrEqual)</font>
<font color="black"> 203. </font>
<font color="black"> 204. </font>
<font color="green"> 205. class In(BuiltinLookup):</font>
<font color="green"> 206.     lookup_name = 'in'</font>
<font color="black"> 207. </font>
<font color="green"> 208.     def process_rhs(self, compiler, connection):</font>
<font color="green"> 209.         if self.rhs_is_direct_value():</font>
<font color="black"> 210.             # rhs should be an iterable, we use batch_process_rhs</font>
<font color="black"> 211.             # to prepare/transform those values</font>
<font color="green"> 212.             rhs = list(self.rhs)</font>
<font color="green"> 213.             if not rhs:</font>
<font color="red"> 214.                 from django.db.models.sql.datastructures import EmptyResultSet</font>
<font color="red"> 215.                 raise EmptyResultSet</font>
<font color="green"> 216.             sqls, sqls_params = self.batch_process_rhs(compiler, connection, rhs)</font>
<font color="green"> 217.             placeholder = '(' + ', '.join(sqls) + ')'</font>
<font color="green"> 218.             return (placeholder, sqls_params)</font>
<font color="black"> 219.         else:</font>
<font color="red"> 220.             return super(In, self).process_rhs(compiler, connection)</font>
<font color="black"> 221. </font>
<font color="green"> 222.     def get_rhs_op(self, connection, rhs):</font>
<font color="green"> 223.         return 'IN %s' % rhs</font>
<font color="black"> 224. </font>
<font color="green"> 225.     def as_sql(self, compiler, connection):</font>
<font color="green"> 226.         max_in_list_size = connection.ops.max_in_list_size()</font>
<font color="green"> 227.         if self.rhs_is_direct_value() and max_in_list_size and len(self.rhs) &gt; max_in_list_size:</font>
<font color="red"> 228.             return self.split_parameter_list_as_sql(compiler, connection)</font>
<font color="green"> 229.         return super(In, self).as_sql(compiler, connection)</font>
<font color="black"> 230. </font>
<font color="green"> 231.     def split_parameter_list_as_sql(self, compiler, connection):</font>
<font color="black"> 232.         # This is a special case for databases which limit the number of</font>
<font color="black"> 233.         # elements which can appear in an 'IN' clause.</font>
<font color="red"> 234.         max_in_list_size = connection.ops.max_in_list_size()</font>
<font color="red"> 235.         lhs, lhs_params = self.process_lhs(compiler, connection)</font>
<font color="red"> 236.         rhs, rhs_params = self.batch_process_rhs(compiler, connection)</font>
<font color="red"> 237.         in_clause_elements = ['(']</font>
<font color="red"> 238.         params = []</font>
<font color="red"> 239.         for offset in range(0, len(rhs_params), max_in_list_size):</font>
<font color="red"> 240.             if offset &gt; 0:</font>
<font color="red"> 241.                 in_clause_elements.append(' OR ')</font>
<font color="red"> 242.             in_clause_elements.append('%s IN (' % lhs)</font>
<font color="red"> 243.             params.extend(lhs_params)</font>
<font color="red"> 244.             sqls = rhs[offset: offset + max_in_list_size]</font>
<font color="red"> 245.             sqls_params = rhs_params[offset: offset + max_in_list_size]</font>
<font color="red"> 246.             param_group = ', '.join(sqls)</font>
<font color="red"> 247.             in_clause_elements.append(param_group)</font>
<font color="red"> 248.             in_clause_elements.append(')')</font>
<font color="red"> 249.             params.extend(sqls_params)</font>
<font color="red"> 250.         in_clause_elements.append(')')</font>
<font color="red"> 251.         return ''.join(in_clause_elements), params</font>
<font color="green"> 252. Field.register_lookup(In)</font>
<font color="black"> 253. </font>
<font color="black"> 254. </font>
<font color="green"> 255. class PatternLookup(BuiltinLookup):</font>
<font color="black"> 256. </font>
<font color="green"> 257.     def get_rhs_op(self, connection, rhs):</font>
<font color="black"> 258.         # Assume we are in startswith. We need to produce SQL like:</font>
<font color="black"> 259.         #     col LIKE %s, ['thevalue%']</font>
<font color="black"> 260.         # For python values we can (and should) do that directly in Python,</font>
<font color="black"> 261.         # but if the value is for example reference to other column, then</font>
<font color="black"> 262.         # we need to add the % pattern match to the lookup by something like</font>
<font color="black"> 263.         #     col LIKE othercol || '%%'</font>
<font color="black"> 264.         # So, for Python values we don't need any special pattern, but for</font>
<font color="black"> 265.         # SQL reference values or SQL transformations we need the correct</font>
<font color="black"> 266.         # pattern added.</font>
<font color="red"> 267.         if (hasattr(self.rhs, 'get_compiler') or hasattr(self.rhs, 'as_sql')</font>
<font color="red"> 268.                 or hasattr(self.rhs, '_as_sql') or self.bilateral_transforms):</font>
<font color="red"> 269.             pattern = connection.pattern_ops[self.lookup_name].format(connection.pattern_esc)</font>
<font color="red"> 270.             return pattern.format(rhs)</font>
<font color="black"> 271.         else:</font>
<font color="red"> 272.             return super(PatternLookup, self).get_rhs_op(connection, rhs)</font>
<font color="black"> 273. </font>
<font color="black"> 274. </font>
<font color="green"> 275. class Contains(PatternLookup):</font>
<font color="green"> 276.     lookup_name = 'contains'</font>
<font color="black"> 277. </font>
<font color="green"> 278.     def process_rhs(self, qn, connection):</font>
<font color="red"> 279.         rhs, params = super(Contains, self).process_rhs(qn, connection)</font>
<font color="red"> 280.         if params and not self.bilateral_transforms:</font>
<font color="red"> 281.             params[0] = &quot;%%%s%%&quot; % connection.ops.prep_for_like_query(params[0])</font>
<font color="red"> 282.         return rhs, params</font>
<font color="green"> 283. Field.register_lookup(Contains)</font>
<font color="black"> 284. </font>
<font color="black"> 285. </font>
<font color="green"> 286. class IContains(Contains):</font>
<font color="green"> 287.     lookup_name = 'icontains'</font>
<font color="green"> 288. Field.register_lookup(IContains)</font>
<font color="black"> 289. </font>
<font color="black"> 290. </font>
<font color="green"> 291. class StartsWith(PatternLookup):</font>
<font color="green"> 292.     lookup_name = 'startswith'</font>
<font color="black"> 293. </font>
<font color="green"> 294.     def process_rhs(self, qn, connection):</font>
<font color="red"> 295.         rhs, params = super(StartsWith, self).process_rhs(qn, connection)</font>
<font color="red"> 296.         if params and not self.bilateral_transforms:</font>
<font color="red"> 297.             params[0] = &quot;%s%%&quot; % connection.ops.prep_for_like_query(params[0])</font>
<font color="red"> 298.         return rhs, params</font>
<font color="green"> 299. Field.register_lookup(StartsWith)</font>
<font color="black"> 300. </font>
<font color="black"> 301. </font>
<font color="green"> 302. class IStartsWith(PatternLookup):</font>
<font color="green"> 303.     lookup_name = 'istartswith'</font>
<font color="black"> 304. </font>
<font color="green"> 305.     def process_rhs(self, qn, connection):</font>
<font color="red"> 306.         rhs, params = super(IStartsWith, self).process_rhs(qn, connection)</font>
<font color="red"> 307.         if params and not self.bilateral_transforms:</font>
<font color="red"> 308.             params[0] = &quot;%s%%&quot; % connection.ops.prep_for_like_query(params[0])</font>
<font color="red"> 309.         return rhs, params</font>
<font color="green"> 310. Field.register_lookup(IStartsWith)</font>
<font color="black"> 311. </font>
<font color="black"> 312. </font>
<font color="green"> 313. class EndsWith(PatternLookup):</font>
<font color="green"> 314.     lookup_name = 'endswith'</font>
<font color="black"> 315. </font>
<font color="green"> 316.     def process_rhs(self, qn, connection):</font>
<font color="red"> 317.         rhs, params = super(EndsWith, self).process_rhs(qn, connection)</font>
<font color="red"> 318.         if params and not self.bilateral_transforms:</font>
<font color="red"> 319.             params[0] = &quot;%%%s&quot; % connection.ops.prep_for_like_query(params[0])</font>
<font color="red"> 320.         return rhs, params</font>
<font color="green"> 321. Field.register_lookup(EndsWith)</font>
<font color="black"> 322. </font>
<font color="black"> 323. </font>
<font color="green"> 324. class IEndsWith(PatternLookup):</font>
<font color="green"> 325.     lookup_name = 'iendswith'</font>
<font color="black"> 326. </font>
<font color="green"> 327.     def process_rhs(self, qn, connection):</font>
<font color="red"> 328.         rhs, params = super(IEndsWith, self).process_rhs(qn, connection)</font>
<font color="red"> 329.         if params and not self.bilateral_transforms:</font>
<font color="red"> 330.             params[0] = &quot;%%%s&quot; % connection.ops.prep_for_like_query(params[0])</font>
<font color="red"> 331.         return rhs, params</font>
<font color="green"> 332. Field.register_lookup(IEndsWith)</font>
<font color="black"> 333. </font>
<font color="black"> 334. </font>
<font color="green"> 335. class Between(BuiltinLookup):</font>
<font color="green"> 336.     def get_rhs_op(self, connection, rhs):</font>
<font color="red"> 337.         return &quot;BETWEEN %s AND %s&quot; % (rhs, rhs)</font>
<font color="black"> 338. </font>
<font color="black"> 339. </font>
<font color="green"> 340. class Range(BuiltinLookup):</font>
<font color="green"> 341.     lookup_name = 'range'</font>
<font color="black"> 342. </font>
<font color="green"> 343.     def get_rhs_op(self, connection, rhs):</font>
<font color="red"> 344.         return &quot;BETWEEN %s AND %s&quot; % (rhs[0], rhs[1])</font>
<font color="black"> 345. </font>
<font color="green"> 346.     def process_rhs(self, compiler, connection):</font>
<font color="red"> 347.         if self.rhs_is_direct_value():</font>
<font color="black"> 348.             # rhs should be an iterable of 2 values, we use batch_process_rhs</font>
<font color="black"> 349.             # to prepare/transform those values</font>
<font color="red"> 350.             return self.batch_process_rhs(compiler, connection)</font>
<font color="black"> 351.         else:</font>
<font color="red"> 352.             return super(Range, self).process_rhs(compiler, connection)</font>
<font color="green"> 353. Field.register_lookup(Range)</font>
<font color="black"> 354. </font>
<font color="black"> 355. </font>
<font color="green"> 356. class IsNull(BuiltinLookup):</font>
<font color="green"> 357.     lookup_name = 'isnull'</font>
<font color="black"> 358. </font>
<font color="green"> 359.     def as_sql(self, compiler, connection):</font>
<font color="red"> 360.         sql, params = compiler.compile(self.lhs)</font>
<font color="red"> 361.         if self.rhs:</font>
<font color="red"> 362.             return &quot;%s IS NULL&quot; % sql, params</font>
<font color="black"> 363.         else:</font>
<font color="red"> 364.             return &quot;%s IS NOT NULL&quot; % sql, params</font>
<font color="green"> 365. Field.register_lookup(IsNull)</font>
<font color="black"> 366. </font>
<font color="black"> 367. </font>
<font color="green"> 368. class Search(BuiltinLookup):</font>
<font color="green"> 369.     lookup_name = 'search'</font>
<font color="black"> 370. </font>
<font color="green"> 371.     def as_sql(self, compiler, connection):</font>
<font color="red"> 372.         lhs, lhs_params = self.process_lhs(compiler, connection)</font>
<font color="red"> 373.         rhs, rhs_params = self.process_rhs(compiler, connection)</font>
<font color="red"> 374.         sql_template = connection.ops.fulltext_search_sql(field_name=lhs)</font>
<font color="red"> 375.         return sql_template, lhs_params + rhs_params</font>
<font color="green"> 376. Field.register_lookup(Search)</font>
<font color="black"> 377. </font>
<font color="black"> 378. </font>
<font color="green"> 379. class Regex(BuiltinLookup):</font>
<font color="green"> 380.     lookup_name = 'regex'</font>
<font color="black"> 381. </font>
<font color="green"> 382.     def as_sql(self, compiler, connection):</font>
<font color="red"> 383.         if self.lookup_name in connection.operators:</font>
<font color="red"> 384.             return super(Regex, self).as_sql(compiler, connection)</font>
<font color="black"> 385.         else:</font>
<font color="red"> 386.             lhs, lhs_params = self.process_lhs(compiler, connection)</font>
<font color="red"> 387.             rhs, rhs_params = self.process_rhs(compiler, connection)</font>
<font color="red"> 388.             sql_template = connection.ops.regex_lookup(self.lookup_name)</font>
<font color="red"> 389.             return sql_template % (lhs, rhs), lhs_params + rhs_params</font>
<font color="green"> 390. Field.register_lookup(Regex)</font>
<font color="black"> 391. </font>
<font color="black"> 392. </font>
<font color="green"> 393. class IRegex(Regex):</font>
<font color="green"> 394.     lookup_name = 'iregex'</font>
<font color="green"> 395. Field.register_lookup(IRegex)</font>
<font color="black"> 396. </font>
<font color="black"> 397. </font>
<font color="green"> 398. class DateTimeDateTransform(Transform):</font>
<font color="green"> 399.     lookup_name = 'date'</font>
<font color="black"> 400. </font>
<font color="green"> 401.     @cached_property</font>
<font color="black"> 402.     def output_field(self):</font>
<font color="red"> 403.         return DateField()</font>
<font color="black"> 404. </font>
<font color="green"> 405.     def as_sql(self, compiler, connection):</font>
<font color="red"> 406.         lhs, lhs_params = compiler.compile(self.lhs)</font>
<font color="red"> 407.         tzname = timezone.get_current_timezone_name() if settings.USE_TZ else None</font>
<font color="red"> 408.         sql, tz_params = connection.ops.datetime_cast_date_sql(lhs, tzname)</font>
<font color="red"> 409.         lhs_params.extend(tz_params)</font>
<font color="red"> 410.         return sql, lhs_params</font>
<font color="black"> 411. </font>
<font color="black"> 412. </font>
<font color="green"> 413. class DateTransform(Transform):</font>
<font color="green"> 414.     def as_sql(self, compiler, connection):</font>
<font color="red"> 415.         sql, params = compiler.compile(self.lhs)</font>
<font color="red"> 416.         lhs_output_field = self.lhs.output_field</font>
<font color="red"> 417.         if isinstance(lhs_output_field, DateTimeField):</font>
<font color="red"> 418.             tzname = timezone.get_current_timezone_name() if settings.USE_TZ else None</font>
<font color="red"> 419.             sql, tz_params = connection.ops.datetime_extract_sql(self.lookup_name, sql, tzname)</font>
<font color="red"> 420.             params.extend(tz_params)</font>
<font color="red"> 421.         elif isinstance(lhs_output_field, DateField):</font>
<font color="red"> 422.             sql = connection.ops.date_extract_sql(self.lookup_name, sql)</font>
<font color="red"> 423.         elif isinstance(lhs_output_field, TimeField):</font>
<font color="red"> 424.             sql = connection.ops.time_extract_sql(self.lookup_name, sql)</font>
<font color="black"> 425.         else:</font>
<font color="red"> 426.             raise ValueError('DateTransform only valid on Date/Time/DateTimeFields')</font>
<font color="red"> 427.         return sql, params</font>
<font color="black"> 428. </font>
<font color="green"> 429.     @cached_property</font>
<font color="black"> 430.     def output_field(self):</font>
<font color="red"> 431.         return IntegerField()</font>
<font color="black"> 432. </font>
<font color="black"> 433. </font>
<font color="green"> 434. class YearTransform(DateTransform):</font>
<font color="green"> 435.     lookup_name = 'year'</font>
<font color="black"> 436. </font>
<font color="black"> 437. </font>
<font color="green"> 438. class YearLookup(Lookup):</font>
<font color="green"> 439.     def year_lookup_bounds(self, connection, year):</font>
<font color="red"> 440.         output_field = self.lhs.lhs.output_field</font>
<font color="red"> 441.         if isinstance(output_field, DateTimeField):</font>
<font color="red"> 442.             bounds = connection.ops.year_lookup_bounds_for_datetime_field(year)</font>
<font color="black"> 443.         else:</font>
<font color="red"> 444.             bounds = connection.ops.year_lookup_bounds_for_date_field(year)</font>
<font color="red"> 445.         return bounds</font>
<font color="black"> 446. </font>
<font color="black"> 447. </font>
<font color="green"> 448. @YearTransform.register_lookup</font>
<font color="green"> 449. class YearExact(YearLookup):</font>
<font color="green"> 450.     lookup_name = 'exact'</font>
<font color="black"> 451. </font>
<font color="green"> 452.     def as_sql(self, compiler, connection):</font>
<font color="black"> 453.         # We will need to skip the extract part and instead go</font>
<font color="black"> 454.         # directly with the originating field, that is self.lhs.lhs.</font>
<font color="red"> 455.         lhs_sql, params = self.process_lhs(compiler, connection, self.lhs.lhs)</font>
<font color="red"> 456.         rhs_sql, rhs_params = self.process_rhs(compiler, connection)</font>
<font color="red"> 457.         bounds = self.year_lookup_bounds(connection, rhs_params[0])</font>
<font color="red"> 458.         params.extend(bounds)</font>
<font color="red"> 459.         return '%s BETWEEN %%s AND %%s' % lhs_sql, params</font>
<font color="black"> 460. </font>
<font color="black"> 461. </font>
<font color="green"> 462. class YearComparisonLookup(YearLookup):</font>
<font color="green"> 463.     def as_sql(self, compiler, connection):</font>
<font color="black"> 464.         # We will need to skip the extract part and instead go</font>
<font color="black"> 465.         # directly with the originating field, that is self.lhs.lhs.</font>
<font color="red"> 466.         lhs_sql, params = self.process_lhs(compiler, connection, self.lhs.lhs)</font>
<font color="red"> 467.         rhs_sql, rhs_params = self.process_rhs(compiler, connection)</font>
<font color="red"> 468.         rhs_sql = self.get_rhs_op(connection, rhs_sql)</font>
<font color="red"> 469.         start, finish = self.year_lookup_bounds(connection, rhs_params[0])</font>
<font color="red"> 470.         params.append(self.get_bound(start, finish))</font>
<font color="red"> 471.         return '%s %s' % (lhs_sql, rhs_sql), params</font>
<font color="black"> 472. </font>
<font color="green"> 473.     def get_rhs_op(self, connection, rhs):</font>
<font color="red"> 474.         return connection.operators[self.lookup_name] % rhs</font>
<font color="black"> 475. </font>
<font color="green"> 476.     def get_bound(self):</font>
<font color="red"> 477.         raise NotImplementedError(</font>
<font color="red"> 478.             'subclasses of YearComparisonLookup must provide a get_bound() method'</font>
<font color="black"> 479.         )</font>
<font color="black"> 480. </font>
<font color="black"> 481. </font>
<font color="green"> 482. @YearTransform.register_lookup</font>
<font color="green"> 483. class YearGt(YearComparisonLookup):</font>
<font color="green"> 484.     lookup_name = 'gt'</font>
<font color="black"> 485. </font>
<font color="green"> 486.     def get_bound(self, start, finish):</font>
<font color="red"> 487.         return finish</font>
<font color="black"> 488. </font>
<font color="black"> 489. </font>
<font color="green"> 490. @YearTransform.register_lookup</font>
<font color="green"> 491. class YearGte(YearComparisonLookup):</font>
<font color="green"> 492.     lookup_name = 'gte'</font>
<font color="black"> 493. </font>
<font color="green"> 494.     def get_bound(self, start, finish):</font>
<font color="red"> 495.         return start</font>
<font color="black"> 496. </font>
<font color="black"> 497. </font>
<font color="green"> 498. @YearTransform.register_lookup</font>
<font color="green"> 499. class YearLt(YearComparisonLookup):</font>
<font color="green"> 500.     lookup_name = 'lt'</font>
<font color="black"> 501. </font>
<font color="green"> 502.     def get_bound(self, start, finish):</font>
<font color="red"> 503.         return start</font>
<font color="black"> 504. </font>
<font color="black"> 505. </font>
<font color="green"> 506. @YearTransform.register_lookup</font>
<font color="green"> 507. class YearLte(YearComparisonLookup):</font>
<font color="green"> 508.     lookup_name = 'lte'</font>
<font color="black"> 509. </font>
<font color="green"> 510.     def get_bound(self, start, finish):</font>
<font color="red"> 511.         return finish</font>
<font color="black"> 512. </font>
<font color="black"> 513. </font>
<font color="green"> 514. class MonthTransform(DateTransform):</font>
<font color="green"> 515.     lookup_name = 'month'</font>
<font color="black"> 516. </font>
<font color="black"> 517. </font>
<font color="green"> 518. class DayTransform(DateTransform):</font>
<font color="green"> 519.     lookup_name = 'day'</font>
<font color="black"> 520. </font>
<font color="black"> 521. </font>
<font color="green"> 522. class WeekDayTransform(DateTransform):</font>
<font color="green"> 523.     lookup_name = 'week_day'</font>
<font color="black"> 524. </font>
<font color="black"> 525. </font>
<font color="green"> 526. class HourTransform(DateTransform):</font>
<font color="green"> 527.     lookup_name = 'hour'</font>
<font color="black"> 528. </font>
<font color="black"> 529. </font>
<font color="green"> 530. class MinuteTransform(DateTransform):</font>
<font color="green"> 531.     lookup_name = 'minute'</font>
<font color="black"> 532. </font>
<font color="black"> 533. </font>
<font color="green"> 534. class SecondTransform(DateTransform):</font>
<font color="green"> 535.     lookup_name = 'second'</font>
<font color="black"> 536. </font>
<font color="black"> 537. </font>
<font color="green"> 538. DateField.register_lookup(YearTransform)</font>
<font color="green"> 539. DateField.register_lookup(MonthTransform)</font>
<font color="green"> 540. DateField.register_lookup(DayTransform)</font>
<font color="green"> 541. DateField.register_lookup(WeekDayTransform)</font>
<font color="black"> 542. </font>
<font color="green"> 543. TimeField.register_lookup(HourTransform)</font>
<font color="green"> 544. TimeField.register_lookup(MinuteTransform)</font>
<font color="green"> 545. TimeField.register_lookup(SecondTransform)</font>
<font color="black"> 546. </font>
<font color="green"> 547. DateTimeField.register_lookup(DateTimeDateTransform)</font>
<font color="green"> 548. DateTimeField.register_lookup(YearTransform)</font>
<font color="green"> 549. DateTimeField.register_lookup(MonthTransform)</font>
<font color="green"> 550. DateTimeField.register_lookup(DayTransform)</font>
<font color="green"> 551. DateTimeField.register_lookup(WeekDayTransform)</font>
<font color="green"> 552. DateTimeField.register_lookup(HourTransform)</font>
<font color="green"> 553. DateTimeField.register_lookup(MinuteTransform)</font>
<font color="green"> 554. DateTimeField.register_lookup(SecondTransform)</font>
</pre>


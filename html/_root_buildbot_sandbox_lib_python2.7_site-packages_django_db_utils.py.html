source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/utils.py</b><br>


file stats: <b>221 lines, 133 executed: 60.2% covered</b>
<pre>
<font color="green">   1. import inspect</font>
<font color="green">   2. import os</font>
<font color="green">   3. import pkgutil</font>
<font color="green">   4. import warnings</font>
<font color="green">   5. from importlib import import_module</font>
<font color="green">   6. from threading import local</font>
<font color="black">   7. </font>
<font color="green">   8. from django.conf import settings</font>
<font color="green">   9. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">  10. from django.utils import six</font>
<font color="green">  11. from django.utils._os import npath, upath</font>
<font color="green">  12. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  13. from django.utils.functional import cached_property</font>
<font color="green">  14. from django.utils.module_loading import import_string</font>
<font color="black">  15. </font>
<font color="green">  16. DEFAULT_DB_ALIAS = 'default'</font>
<font color="green">  17. DJANGO_VERSION_PICKLE_KEY = '_django_version'</font>
<font color="black">  18. </font>
<font color="black">  19. </font>
<font color="green">  20. class Error(Exception if six.PY3 else StandardError):  # NOQA: StandardError undefined on PY3</font>
<font color="green">  21.     pass</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. class InterfaceError(Error):</font>
<font color="green">  25.     pass</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. class DatabaseError(Error):</font>
<font color="green">  29.     pass</font>
<font color="black">  30. </font>
<font color="black">  31. </font>
<font color="green">  32. class DataError(DatabaseError):</font>
<font color="green">  33.     pass</font>
<font color="black">  34. </font>
<font color="black">  35. </font>
<font color="green">  36. class OperationalError(DatabaseError):</font>
<font color="green">  37.     pass</font>
<font color="black">  38. </font>
<font color="black">  39. </font>
<font color="green">  40. class IntegrityError(DatabaseError):</font>
<font color="green">  41.     pass</font>
<font color="black">  42. </font>
<font color="black">  43. </font>
<font color="green">  44. class InternalError(DatabaseError):</font>
<font color="green">  45.     pass</font>
<font color="black">  46. </font>
<font color="black">  47. </font>
<font color="green">  48. class ProgrammingError(DatabaseError):</font>
<font color="green">  49.     pass</font>
<font color="black">  50. </font>
<font color="black">  51. </font>
<font color="green">  52. class NotSupportedError(DatabaseError):</font>
<font color="green">  53.     pass</font>
<font color="black">  54. </font>
<font color="black">  55. </font>
<font color="green">  56. class DatabaseErrorWrapper(object):</font>
<font color="black">  57.     &quot;&quot;&quot;</font>
<font color="black">  58.     Context manager and decorator that re-throws backend-specific database</font>
<font color="black">  59.     exceptions using Django's common wrappers.</font>
<font color="green">  60.     &quot;&quot;&quot;</font>
<font color="black">  61. </font>
<font color="green">  62.     def __init__(self, wrapper):</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="black">  64.         wrapper is a database wrapper.</font>
<font color="black">  65. </font>
<font color="black">  66.         It must have a Database attribute defining PEP-249 exceptions.</font>
<font color="black">  67.         &quot;&quot;&quot;</font>
<font color="green">  68.         self.wrapper = wrapper</font>
<font color="black">  69. </font>
<font color="green">  70.     def __enter__(self):</font>
<font color="green">  71.         pass</font>
<font color="black">  72. </font>
<font color="green">  73.     def __exit__(self, exc_type, exc_value, traceback):</font>
<font color="green">  74.         if exc_type is None:</font>
<font color="green">  75.             return</font>
<font color="red">  76.         for dj_exc_type in (</font>
<font color="red">  77.                 DataError,</font>
<font color="red">  78.                 OperationalError,</font>
<font color="red">  79.                 IntegrityError,</font>
<font color="red">  80.                 InternalError,</font>
<font color="red">  81.                 ProgrammingError,</font>
<font color="red">  82.                 NotSupportedError,</font>
<font color="red">  83.                 DatabaseError,</font>
<font color="red">  84.                 InterfaceError,</font>
<font color="red">  85.                 Error,</font>
<font color="black">  86.         ):</font>
<font color="red">  87.             db_exc_type = getattr(self.wrapper.Database, dj_exc_type.__name__)</font>
<font color="red">  88.             if issubclass(exc_type, db_exc_type):</font>
<font color="red">  89.                 dj_exc_value = dj_exc_type(*exc_value.args)</font>
<font color="red">  90.                 dj_exc_value.__cause__ = exc_value</font>
<font color="black">  91.                 # Only set the 'errors_occurred' flag for errors that may make</font>
<font color="black">  92.                 # the connection unusable.</font>
<font color="red">  93.                 if dj_exc_type not in (DataError, IntegrityError):</font>
<font color="red">  94.                     self.wrapper.errors_occurred = True</font>
<font color="red">  95.                 six.reraise(dj_exc_type, dj_exc_value, traceback)</font>
<font color="black">  96. </font>
<font color="green">  97.     def __call__(self, func):</font>
<font color="black">  98.         # Note that we are intentionally not using @wraps here for performance</font>
<font color="black">  99.         # reasons. Refs #21109.</font>
<font color="green"> 100.         def inner(*args, **kwargs):</font>
<font color="green"> 101.             with self:</font>
<font color="green"> 102.                 return func(*args, **kwargs)</font>
<font color="green"> 103.         return inner</font>
<font color="black"> 104. </font>
<font color="black"> 105. </font>
<font color="green"> 106. def load_backend(backend_name):</font>
<font color="black"> 107.     &quot;&quot;&quot;</font>
<font color="black"> 108.     Return a database backend's &quot;base&quot; module given a fully qualified database</font>
<font color="black"> 109.     backend name, or raise an error if it doesn't exist.</font>
<font color="black"> 110.     &quot;&quot;&quot;</font>
<font color="black"> 111.     # This backend was renamed in Django 1.9.</font>
<font color="green"> 112.     if backend_name == 'django.db.backends.postgresql_psycopg2':</font>
<font color="red"> 113.         backend_name = 'django.db.backends.postgresql'</font>
<font color="black"> 114. </font>
<font color="green"> 115.     try:</font>
<font color="green"> 116.         return import_module('%s.base' % backend_name)</font>
<font color="red"> 117.     except ImportError as e_user:</font>
<font color="black"> 118.         # The database backend wasn't found. Display a helpful error message</font>
<font color="black"> 119.         # listing all possible (built-in) database backends.</font>
<font color="red"> 120.         backend_dir = os.path.join(os.path.dirname(upath(__file__)), 'backends')</font>
<font color="red"> 121.         try:</font>
<font color="black"> 122.             builtin_backends = [</font>
<font color="red"> 123.                 name for _, name, ispkg in pkgutil.iter_modules([npath(backend_dir)])</font>
<font color="red"> 124.                 if ispkg and name not in {'base', 'dummy', 'postgresql_psycopg2'}</font>
<font color="black"> 125.             ]</font>
<font color="red"> 126.         except EnvironmentError:</font>
<font color="red"> 127.             builtin_backends = []</font>
<font color="red"> 128.         if backend_name not in ['django.db.backends.%s' % b for b in</font>
<font color="red"> 129.                                 builtin_backends]:</font>
<font color="red"> 130.             backend_reprs = map(repr, sorted(builtin_backends))</font>
<font color="red"> 131.             error_msg = (&quot;%r isn't an available database backend.\n&quot;</font>
<font color="black"> 132.                          &quot;Try using 'django.db.backends.XXX', where XXX &quot;</font>
<font color="black"> 133.                          &quot;is one of:\n    %s\nError was: %s&quot; %</font>
<font color="red"> 134.                          (backend_name, &quot;, &quot;.join(backend_reprs), e_user))</font>
<font color="red"> 135.             raise ImproperlyConfigured(error_msg)</font>
<font color="black"> 136.         else:</font>
<font color="black"> 137.             # If there's some other error, this must be an error in Django</font>
<font color="red"> 138.             raise</font>
<font color="black"> 139. </font>
<font color="black"> 140. </font>
<font color="green"> 141. class ConnectionDoesNotExist(Exception):</font>
<font color="green"> 142.     pass</font>
<font color="black"> 143. </font>
<font color="black"> 144. </font>
<font color="green"> 145. class ConnectionHandler(object):</font>
<font color="green"> 146.     def __init__(self, databases=None):</font>
<font color="black"> 147.         &quot;&quot;&quot;</font>
<font color="black"> 148.         databases is an optional dictionary of database definitions (structured</font>
<font color="black"> 149.         like settings.DATABASES).</font>
<font color="black"> 150.         &quot;&quot;&quot;</font>
<font color="green"> 151.         self._databases = databases</font>
<font color="green"> 152.         self._connections = local()</font>
<font color="black"> 153. </font>
<font color="green"> 154.     @cached_property</font>
<font color="black"> 155.     def databases(self):</font>
<font color="green"> 156.         if self._databases is None:</font>
<font color="green"> 157.             self._databases = settings.DATABASES</font>
<font color="green"> 158.         if self._databases == {}:</font>
<font color="red"> 159.             self._databases = {</font>
<font color="red"> 160.                 DEFAULT_DB_ALIAS: {</font>
<font color="red"> 161.                     'ENGINE': 'django.db.backends.dummy',</font>
<font color="black"> 162.                 },</font>
<font color="black"> 163.             }</font>
<font color="green"> 164.         if self._databases[DEFAULT_DB_ALIAS] == {}:</font>
<font color="red"> 165.             self._databases[DEFAULT_DB_ALIAS]['ENGINE'] = 'django.db.backends.dummy'</font>
<font color="black"> 166. </font>
<font color="green"> 167.         if DEFAULT_DB_ALIAS not in self._databases:</font>
<font color="red"> 168.             raise ImproperlyConfigured(&quot;You must define a '%s' database&quot; % DEFAULT_DB_ALIAS)</font>
<font color="green"> 169.         return self._databases</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def ensure_defaults(self, alias):</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="black"> 173.         Puts the defaults into the settings dictionary for a given connection</font>
<font color="black"> 174.         where no settings is provided.</font>
<font color="black"> 175.         &quot;&quot;&quot;</font>
<font color="green"> 176.         try:</font>
<font color="green"> 177.             conn = self.databases[alias]</font>
<font color="red"> 178.         except KeyError:</font>
<font color="red"> 179.             raise ConnectionDoesNotExist(&quot;The connection %s doesn't exist&quot; % alias)</font>
<font color="black"> 180. </font>
<font color="green"> 181.         conn.setdefault('ATOMIC_REQUESTS', False)</font>
<font color="green"> 182.         conn.setdefault('AUTOCOMMIT', True)</font>
<font color="green"> 183.         conn.setdefault('ENGINE', 'django.db.backends.dummy')</font>
<font color="green"> 184.         if conn['ENGINE'] == 'django.db.backends.' or not conn['ENGINE']:</font>
<font color="red"> 185.             conn['ENGINE'] = 'django.db.backends.dummy'</font>
<font color="green"> 186.         conn.setdefault('CONN_MAX_AGE', 0)</font>
<font color="green"> 187.         conn.setdefault('OPTIONS', {})</font>
<font color="green"> 188.         conn.setdefault('TIME_ZONE', None)</font>
<font color="green"> 189.         for setting in ['NAME', 'USER', 'PASSWORD', 'HOST', 'PORT']:</font>
<font color="green"> 190.             conn.setdefault(setting, '')</font>
<font color="black"> 191. </font>
<font color="green"> 192.     def prepare_test_settings(self, alias):</font>
<font color="black"> 193.         &quot;&quot;&quot;</font>
<font color="black"> 194.         Makes sure the test settings are available in the 'TEST' sub-dictionary.</font>
<font color="black"> 195.         &quot;&quot;&quot;</font>
<font color="green"> 196.         try:</font>
<font color="green"> 197.             conn = self.databases[alias]</font>
<font color="red"> 198.         except KeyError:</font>
<font color="red"> 199.             raise ConnectionDoesNotExist(&quot;The connection %s doesn't exist&quot; % alias)</font>
<font color="black"> 200. </font>
<font color="green"> 201.         test_settings = conn.setdefault('TEST', {})</font>
<font color="green"> 202.         for key in ['CHARSET', 'COLLATION', 'NAME', 'MIRROR']:</font>
<font color="green"> 203.             test_settings.setdefault(key, None)</font>
<font color="black"> 204. </font>
<font color="green"> 205.     def __getitem__(self, alias):</font>
<font color="green"> 206.         if hasattr(self._connections, alias):</font>
<font color="green"> 207.             return getattr(self._connections, alias)</font>
<font color="black"> 208. </font>
<font color="green"> 209.         self.ensure_defaults(alias)</font>
<font color="green"> 210.         self.prepare_test_settings(alias)</font>
<font color="green"> 211.         db = self.databases[alias]</font>
<font color="green"> 212.         backend = load_backend(db['ENGINE'])</font>
<font color="green"> 213.         conn = backend.DatabaseWrapper(db, alias)</font>
<font color="green"> 214.         setattr(self._connections, alias, conn)</font>
<font color="green"> 215.         return conn</font>
<font color="black"> 216. </font>
<font color="green"> 217.     def __setitem__(self, key, value):</font>
<font color="red"> 218.         setattr(self._connections, key, value)</font>
<font color="black"> 219. </font>
<font color="green"> 220.     def __delitem__(self, key):</font>
<font color="red"> 221.         delattr(self._connections, key)</font>
<font color="black"> 222. </font>
<font color="green"> 223.     def __iter__(self):</font>
<font color="green"> 224.         return iter(self.databases)</font>
<font color="black"> 225. </font>
<font color="green"> 226.     def all(self):</font>
<font color="green"> 227.         return [self[alias] for alias in self]</font>
<font color="black"> 228. </font>
<font color="green"> 229.     def close_all(self):</font>
<font color="green"> 230.         for alias in self:</font>
<font color="green"> 231.             try:</font>
<font color="green"> 232.                 connection = getattr(self._connections, alias)</font>
<font color="red"> 233.             except AttributeError:</font>
<font color="red"> 234.                 continue</font>
<font color="green"> 235.             connection.close()</font>
<font color="black"> 236. </font>
<font color="black"> 237. </font>
<font color="green"> 238. class ConnectionRouter(object):</font>
<font color="green"> 239.     def __init__(self, routers=None):</font>
<font color="black"> 240.         &quot;&quot;&quot;</font>
<font color="black"> 241.         If routers is not specified, will default to settings.DATABASE_ROUTERS.</font>
<font color="black"> 242.         &quot;&quot;&quot;</font>
<font color="green"> 243.         self._routers = routers</font>
<font color="black"> 244. </font>
<font color="green"> 245.     @cached_property</font>
<font color="black"> 246.     def routers(self):</font>
<font color="green"> 247.         if self._routers is None:</font>
<font color="green"> 248.             self._routers = settings.DATABASE_ROUTERS</font>
<font color="green"> 249.         routers = []</font>
<font color="green"> 250.         for r in self._routers:</font>
<font color="red"> 251.             if isinstance(r, six.string_types):</font>
<font color="red"> 252.                 router = import_string(r)()</font>
<font color="black"> 253.             else:</font>
<font color="red"> 254.                 router = r</font>
<font color="red"> 255.             routers.append(router)</font>
<font color="green"> 256.         return routers</font>
<font color="black"> 257. </font>
<font color="green"> 258.     def _router_func(action):</font>
<font color="green"> 259.         def _route_db(self, model, **hints):</font>
<font color="green"> 260.             chosen_db = None</font>
<font color="green"> 261.             for router in self.routers:</font>
<font color="red"> 262.                 try:</font>
<font color="red"> 263.                     method = getattr(router, action)</font>
<font color="red"> 264.                 except AttributeError:</font>
<font color="black"> 265.                     # If the router doesn't have a method, skip to the next one.</font>
<font color="red"> 266.                     pass</font>
<font color="black"> 267.                 else:</font>
<font color="red"> 268.                     chosen_db = method(model, **hints)</font>
<font color="red"> 269.                     if chosen_db:</font>
<font color="red"> 270.                         return chosen_db</font>
<font color="green"> 271.             instance = hints.get('instance')</font>
<font color="green"> 272.             if instance is not None and instance._state.db:</font>
<font color="green"> 273.                 return instance._state.db</font>
<font color="red"> 274.             return DEFAULT_DB_ALIAS</font>
<font color="green"> 275.         return _route_db</font>
<font color="black"> 276. </font>
<font color="green"> 277.     db_for_read = _router_func('db_for_read')</font>
<font color="green"> 278.     db_for_write = _router_func('db_for_write')</font>
<font color="black"> 279. </font>
<font color="green"> 280.     def allow_relation(self, obj1, obj2, **hints):</font>
<font color="red"> 281.         for router in self.routers:</font>
<font color="red"> 282.             try:</font>
<font color="red"> 283.                 method = router.allow_relation</font>
<font color="red"> 284.             except AttributeError:</font>
<font color="black"> 285.                 # If the router doesn't have a method, skip to the next one.</font>
<font color="red"> 286.                 pass</font>
<font color="black"> 287.             else:</font>
<font color="red"> 288.                 allow = method(obj1, obj2, **hints)</font>
<font color="red"> 289.                 if allow is not None:</font>
<font color="red"> 290.                     return allow</font>
<font color="red"> 291.         return obj1._state.db == obj2._state.db</font>
<font color="black"> 292. </font>
<font color="green"> 293.     def allow_migrate(self, db, app_label, **hints):</font>
<font color="green"> 294.         for router in self.routers:</font>
<font color="red"> 295.             try:</font>
<font color="red"> 296.                 method = router.allow_migrate</font>
<font color="red"> 297.             except AttributeError:</font>
<font color="black"> 298.                 # If the router doesn't have a method, skip to the next one.</font>
<font color="red"> 299.                 continue</font>
<font color="black"> 300. </font>
<font color="red"> 301.             if six.PY3:</font>
<font color="red"> 302.                 sig = inspect.signature(router.allow_migrate)</font>
<font color="red"> 303.                 has_deprecated_signature = not any(</font>
<font color="red"> 304.                     p.kind == inspect.Parameter.VAR_KEYWORD for p in sig.parameters.values()</font>
<font color="black"> 305.                 )</font>
<font color="black"> 306.             else:</font>
<font color="red"> 307.                 argspec = inspect.getargspec(router.allow_migrate)</font>
<font color="red"> 308.                 has_deprecated_signature = len(argspec.args) == 3 and not argspec.keywords</font>
<font color="black"> 309. </font>
<font color="red"> 310.             if has_deprecated_signature:</font>
<font color="red"> 311.                 warnings.warn(</font>
<font color="red"> 312.                     &quot;The signature of allow_migrate has changed from &quot;</font>
<font color="black"> 313.                     &quot;allow_migrate(self, db, model) to &quot;</font>
<font color="black"> 314.                     &quot;allow_migrate(self, db, app_label, model_name=None, **hints). &quot;</font>
<font color="black"> 315.                     &quot;Support for the old signature will be removed in Django 1.10.&quot;,</font>
<font color="red"> 316.                     RemovedInDjango110Warning)</font>
<font color="red"> 317.                 model = hints.get('model')</font>
<font color="red"> 318.                 allow = None if model is None else method(db, model)</font>
<font color="black"> 319.             else:</font>
<font color="red"> 320.                 allow = method(db, app_label, **hints)</font>
<font color="black"> 321. </font>
<font color="red"> 322.             if allow is not None:</font>
<font color="red"> 323.                 return allow</font>
<font color="green"> 324.         return True</font>
<font color="black"> 325. </font>
<font color="green"> 326.     def allow_migrate_model(self, db, model):</font>
<font color="green"> 327.         return self.allow_migrate(</font>
<font color="green"> 328.             db,</font>
<font color="green"> 329.             model._meta.app_label,</font>
<font color="green"> 330.             model_name=model._meta.model_name,</font>
<font color="green"> 331.             model=model,</font>
<font color="black"> 332.         )</font>
<font color="black"> 333. </font>
<font color="green"> 334.     def get_migratable_models(self, app_config, db, include_auto_created=False):</font>
<font color="black"> 335.         &quot;&quot;&quot;</font>
<font color="black"> 336.         Return app models allowed to be synchronized on provided db.</font>
<font color="black"> 337.         &quot;&quot;&quot;</font>
<font color="red"> 338.         models = app_config.get_models(include_auto_created=include_auto_created)</font>
<font color="red"> 339.         return [model for model in models if self.allow_migrate_model(db, model)]</font>
</pre>


source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/template/smartif.py</b><br>


file stats: <b>128 lines, 60 executed: 46.9% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Parser and utilities for the smart 'if' tag</font>
<font color="green">   3. &quot;&quot;&quot;</font>
<font color="green">   4. import warnings</font>
<font color="black">   5. </font>
<font color="green">   6. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="black">   7. </font>
<font color="black">   8. </font>
<font color="black">   9. # Using a simple top down parser, as described here:</font>
<font color="black">  10. #    http://effbot.org/zone/simple-top-down-parsing.htm.</font>
<font color="black">  11. # 'led' = left denotation</font>
<font color="black">  12. # 'nud' = null denotation</font>
<font color="black">  13. # 'bp' = binding power (left = lbp, right = rbp)</font>
<font color="black">  14. </font>
<font color="green">  15. class TokenBase(object):</font>
<font color="black">  16.     &quot;&quot;&quot;</font>
<font color="black">  17.     Base class for operators and literals, mainly for debugging and for throwing</font>
<font color="black">  18.     syntax errors.</font>
<font color="green">  19.     &quot;&quot;&quot;</font>
<font color="green">  20.     id = None  # node/token type name</font>
<font color="green">  21.     value = None  # used by literals</font>
<font color="green">  22.     first = second = None  # used by tree nodes</font>
<font color="black">  23. </font>
<font color="green">  24.     def nud(self, parser):</font>
<font color="black">  25.         # Null denotation - called in prefix context</font>
<font color="red">  26.         raise parser.error_class(</font>
<font color="red">  27.             &quot;Not expecting '%s' in this position in if tag.&quot; % self.id</font>
<font color="black">  28.         )</font>
<font color="black">  29. </font>
<font color="green">  30.     def led(self, left, parser):</font>
<font color="black">  31.         # Left denotation - called in infix context</font>
<font color="red">  32.         raise parser.error_class(</font>
<font color="red">  33.             &quot;Not expecting '%s' as infix operator in if tag.&quot; % self.id</font>
<font color="black">  34.         )</font>
<font color="black">  35. </font>
<font color="green">  36.     def display(self):</font>
<font color="black">  37.         &quot;&quot;&quot;</font>
<font color="black">  38.         Returns what to display in error messages for this node</font>
<font color="black">  39.         &quot;&quot;&quot;</font>
<font color="red">  40.         return self.id</font>
<font color="black">  41. </font>
<font color="green">  42.     def __repr__(self):</font>
<font color="red">  43.         out = [str(x) for x in [self.id, self.first, self.second] if x is not None]</font>
<font color="red">  44.         return &quot;(&quot; + &quot; &quot;.join(out) + &quot;)&quot;</font>
<font color="black">  45. </font>
<font color="black">  46. </font>
<font color="green">  47. def infix(bp, func):</font>
<font color="black">  48.     &quot;&quot;&quot;</font>
<font color="black">  49.     Creates an infix operator, given a binding power and a function that</font>
<font color="black">  50.     evaluates the node</font>
<font color="black">  51.     &quot;&quot;&quot;</font>
<font color="green">  52.     class Operator(TokenBase):</font>
<font color="green">  53.         lbp = bp</font>
<font color="black">  54. </font>
<font color="green">  55.         def led(self, left, parser):</font>
<font color="red">  56.             self.first = left</font>
<font color="red">  57.             self.second = parser.expression(bp)</font>
<font color="red">  58.             return self</font>
<font color="black">  59. </font>
<font color="green">  60.         def eval(self, context):</font>
<font color="red">  61.             try:</font>
<font color="red">  62.                 return func(context, self.first, self.second)</font>
<font color="red">  63.             except Exception:</font>
<font color="black">  64.                 # Templates shouldn't throw exceptions when rendering.  We are</font>
<font color="black">  65.                 # most likely to get exceptions for things like {% if foo in bar</font>
<font color="black">  66.                 # %} where 'bar' does not support 'in', so default to False</font>
<font color="red">  67.                 return False</font>
<font color="black">  68. </font>
<font color="green">  69.     return Operator</font>
<font color="black">  70. </font>
<font color="black">  71. </font>
<font color="green">  72. def prefix(bp, func):</font>
<font color="black">  73.     &quot;&quot;&quot;</font>
<font color="black">  74.     Creates a prefix operator, given a binding power and a function that</font>
<font color="black">  75.     evaluates the node.</font>
<font color="black">  76.     &quot;&quot;&quot;</font>
<font color="green">  77.     class Operator(TokenBase):</font>
<font color="green">  78.         lbp = bp</font>
<font color="black">  79. </font>
<font color="green">  80.         def nud(self, parser):</font>
<font color="red">  81.             self.first = parser.expression(bp)</font>
<font color="red">  82.             self.second = None</font>
<font color="red">  83.             return self</font>
<font color="black">  84. </font>
<font color="green">  85.         def eval(self, context):</font>
<font color="red">  86.             try:</font>
<font color="red">  87.                 return func(context, self.first)</font>
<font color="red">  88.             except Exception:</font>
<font color="red">  89.                 return False</font>
<font color="black">  90. </font>
<font color="green">  91.     return Operator</font>
<font color="black">  92. </font>
<font color="black">  93. </font>
<font color="black">  94. # Operator precedence follows Python.</font>
<font color="black">  95. # NB - we can get slightly more accurate syntax error messages by not using the</font>
<font color="black">  96. # same object for '==' and '='.</font>
<font color="black">  97. # We defer variable evaluation to the lambda to ensure that terms are</font>
<font color="black">  98. # lazily evaluated using Python's boolean parsing logic.</font>
<font color="green">  99. OPERATORS = {</font>
<font color="green"> 100.     'or': infix(6, lambda context, x, y: x.eval(context) or y.eval(context)),</font>
<font color="green"> 101.     'and': infix(7, lambda context, x, y: x.eval(context) and y.eval(context)),</font>
<font color="green"> 102.     'not': prefix(8, lambda context, x: not x.eval(context)),</font>
<font color="green"> 103.     'in': infix(9, lambda context, x, y: x.eval(context) in y.eval(context)),</font>
<font color="green"> 104.     'not in': infix(9, lambda context, x, y: x.eval(context) not in y.eval(context)),</font>
<font color="black"> 105.     # This should be removed in Django 1.10:</font>
<font color="green"> 106.     '=': infix(10, lambda context, x, y: x.eval(context) == y.eval(context)),</font>
<font color="green"> 107.     '==': infix(10, lambda context, x, y: x.eval(context) == y.eval(context)),</font>
<font color="green"> 108.     '!=': infix(10, lambda context, x, y: x.eval(context) != y.eval(context)),</font>
<font color="green"> 109.     '&gt;': infix(10, lambda context, x, y: x.eval(context) &gt; y.eval(context)),</font>
<font color="green"> 110.     '&gt;=': infix(10, lambda context, x, y: x.eval(context) &gt;= y.eval(context)),</font>
<font color="green"> 111.     '&lt;': infix(10, lambda context, x, y: x.eval(context) &lt; y.eval(context)),</font>
<font color="green"> 112.     '&lt;=': infix(10, lambda context, x, y: x.eval(context) &lt;= y.eval(context)),</font>
<font color="black"> 113. }</font>
<font color="black"> 114. </font>
<font color="black"> 115. # Assign 'id' to each:</font>
<font color="green"> 116. for key, op in OPERATORS.items():</font>
<font color="green"> 117.     op.id = key</font>
<font color="black"> 118. </font>
<font color="black"> 119. </font>
<font color="green"> 120. class Literal(TokenBase):</font>
<font color="black"> 121.     &quot;&quot;&quot;</font>
<font color="black"> 122.     A basic self-resolvable object similar to a Django template variable.</font>
<font color="green"> 123.     &quot;&quot;&quot;</font>
<font color="black"> 124.     # IfParser uses Literal in create_var, but TemplateIfParser overrides</font>
<font color="black"> 125.     # create_var so that a proper implementation that actually resolves</font>
<font color="black"> 126.     # variables, filters etc is used.</font>
<font color="green"> 127.     id = &quot;literal&quot;</font>
<font color="green"> 128.     lbp = 0</font>
<font color="black"> 129. </font>
<font color="green"> 130.     def __init__(self, value):</font>
<font color="red"> 131.         self.value = value</font>
<font color="black"> 132. </font>
<font color="green"> 133.     def display(self):</font>
<font color="red"> 134.         return repr(self.value)</font>
<font color="black"> 135. </font>
<font color="green"> 136.     def nud(self, parser):</font>
<font color="red"> 137.         return self</font>
<font color="black"> 138. </font>
<font color="green"> 139.     def eval(self, context):</font>
<font color="red"> 140.         return self.value</font>
<font color="black"> 141. </font>
<font color="green"> 142.     def __repr__(self):</font>
<font color="red"> 143.         return &quot;(%s %r)&quot; % (self.id, self.value)</font>
<font color="black"> 144. </font>
<font color="black"> 145. </font>
<font color="green"> 146. class EndToken(TokenBase):</font>
<font color="green"> 147.     lbp = 0</font>
<font color="black"> 148. </font>
<font color="green"> 149.     def nud(self, parser):</font>
<font color="red"> 150.         raise parser.error_class(&quot;Unexpected end of expression in if tag.&quot;)</font>
<font color="black"> 151. </font>
<font color="green"> 152. EndToken = EndToken()</font>
<font color="black"> 153. </font>
<font color="black"> 154. </font>
<font color="green"> 155. class IfParser(object):</font>
<font color="green"> 156.     error_class = ValueError</font>
<font color="black"> 157. </font>
<font color="green"> 158.     def __init__(self, tokens):</font>
<font color="black"> 159.         # pre-pass necessary to turn  'not','in' into single token</font>
<font color="red"> 160.         l = len(tokens)</font>
<font color="red"> 161.         mapped_tokens = []</font>
<font color="red"> 162.         i = 0</font>
<font color="red"> 163.         while i &lt; l:</font>
<font color="red"> 164.             token = tokens[i]</font>
<font color="red"> 165.             if token == &quot;not&quot; and i + 1 &lt; l and tokens[i + 1] == &quot;in&quot;:</font>
<font color="red"> 166.                 token = &quot;not in&quot;</font>
<font color="red"> 167.                 i += 1  # skip 'in'</font>
<font color="red"> 168.             mapped_tokens.append(self.translate_token(token))</font>
<font color="red"> 169.             i += 1</font>
<font color="black"> 170. </font>
<font color="red"> 171.         self.tokens = mapped_tokens</font>
<font color="red"> 172.         self.pos = 0</font>
<font color="red"> 173.         self.current_token = self.next_token()</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def translate_token(self, token):</font>
<font color="red"> 176.         try:</font>
<font color="red"> 177.             op = OPERATORS[token]</font>
<font color="red"> 178.         except (KeyError, TypeError):</font>
<font color="red"> 179.             return self.create_var(token)</font>
<font color="black"> 180.         else:</font>
<font color="red"> 181.             if token == '=':</font>
<font color="red"> 182.                 warnings.warn(</font>
<font color="red"> 183.                     &quot;Operator '=' is deprecated and will be removed in Django 1.10. Use '==' instead.&quot;,</font>
<font color="red"> 184.                     RemovedInDjango110Warning, stacklevel=2</font>
<font color="black"> 185.                 )</font>
<font color="red"> 186.             return op()</font>
<font color="black"> 187. </font>
<font color="green"> 188.     def next_token(self):</font>
<font color="red"> 189.         if self.pos &gt;= len(self.tokens):</font>
<font color="red"> 190.             return EndToken</font>
<font color="black"> 191.         else:</font>
<font color="red"> 192.             retval = self.tokens[self.pos]</font>
<font color="red"> 193.             self.pos += 1</font>
<font color="red"> 194.             return retval</font>
<font color="black"> 195. </font>
<font color="green"> 196.     def parse(self):</font>
<font color="red"> 197.         retval = self.expression()</font>
<font color="black"> 198.         # Check that we have exhausted all the tokens</font>
<font color="red"> 199.         if self.current_token is not EndToken:</font>
<font color="red"> 200.             raise self.error_class(&quot;Unused '%s' at end of if expression.&quot; %</font>
<font color="red"> 201.                                    self.current_token.display())</font>
<font color="red"> 202.         return retval</font>
<font color="black"> 203. </font>
<font color="green"> 204.     def expression(self, rbp=0):</font>
<font color="red"> 205.         t = self.current_token</font>
<font color="red"> 206.         self.current_token = self.next_token()</font>
<font color="red"> 207.         left = t.nud(self)</font>
<font color="red"> 208.         while rbp &lt; self.current_token.lbp:</font>
<font color="red"> 209.             t = self.current_token</font>
<font color="red"> 210.             self.current_token = self.next_token()</font>
<font color="red"> 211.             left = t.led(left, self)</font>
<font color="red"> 212.         return left</font>
<font color="black"> 213. </font>
<font color="green"> 214.     def create_var(self, value):</font>
<font color="red"> 215.         return Literal(value)</font>
</pre>


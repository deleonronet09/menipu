source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/conf/__init__.py</b><br>


file stats: <b>110 lines, 67 executed: 60.9% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Settings and configuration for Django.</font>
<font color="black">   3. </font>
<font color="black">   4. Values will be read from the module specified by the DJANGO_SETTINGS_MODULE environment</font>
<font color="black">   5. variable, and then from django.conf.global_settings; see the global settings file for</font>
<font color="black">   6. a list of all possible variables.</font>
<font color="green">   7. &quot;&quot;&quot;</font>
<font color="black">   8. </font>
<font color="green">   9. import importlib</font>
<font color="green">  10. import os</font>
<font color="green">  11. import time</font>
<font color="green">  12. import warnings</font>
<font color="black">  13. </font>
<font color="green">  14. from django.conf import global_settings</font>
<font color="green">  15. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">  16. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  17. from django.utils.functional import LazyObject, empty</font>
<font color="black">  18. </font>
<font color="green">  19. ENVIRONMENT_VARIABLE = &quot;DJANGO_SETTINGS_MODULE&quot;</font>
<font color="black">  20. </font>
<font color="black">  21. </font>
<font color="green">  22. class LazySettings(LazyObject):</font>
<font color="black">  23.     &quot;&quot;&quot;</font>
<font color="black">  24.     A lazy proxy for either global Django settings or a custom settings object.</font>
<font color="black">  25.     The user can manually configure settings prior to using them. Otherwise,</font>
<font color="black">  26.     Django uses the settings module pointed to by DJANGO_SETTINGS_MODULE.</font>
<font color="green">  27.     &quot;&quot;&quot;</font>
<font color="green">  28.     def _setup(self, name=None):</font>
<font color="black">  29.         &quot;&quot;&quot;</font>
<font color="black">  30.         Load the settings module pointed to by the environment variable. This</font>
<font color="black">  31.         is used the first time we need any settings at all, if the user has not</font>
<font color="black">  32.         previously configured the settings manually.</font>
<font color="black">  33.         &quot;&quot;&quot;</font>
<font color="green">  34.         settings_module = os.environ.get(ENVIRONMENT_VARIABLE)</font>
<font color="green">  35.         if not settings_module:</font>
<font color="red">  36.             desc = (&quot;setting %s&quot; % name) if name else &quot;settings&quot;</font>
<font color="red">  37.             raise ImproperlyConfigured(</font>
<font color="red">  38.                 &quot;Requested %s, but settings are not configured. &quot;</font>
<font color="black">  39.                 &quot;You must either define the environment variable %s &quot;</font>
<font color="black">  40.                 &quot;or call settings.configure() before accessing settings.&quot;</font>
<font color="red">  41.                 % (desc, ENVIRONMENT_VARIABLE))</font>
<font color="black">  42. </font>
<font color="green">  43.         self._wrapped = Settings(settings_module)</font>
<font color="black">  44. </font>
<font color="green">  45.     def __repr__(self):</font>
<font color="black">  46.         # Hardcode the class name as otherwise it yields 'Settings'.</font>
<font color="red">  47.         if self._wrapped is empty:</font>
<font color="red">  48.             return '&lt;LazySettings [Unevaluated]&gt;'</font>
<font color="red">  49.         return '&lt;LazySettings &quot;%(settings_module)s&quot;&gt;' % {</font>
<font color="red">  50.             'settings_module': self._wrapped.SETTINGS_MODULE,</font>
<font color="black">  51.         }</font>
<font color="black">  52. </font>
<font color="green">  53.     def __getattr__(self, name):</font>
<font color="green">  54.         if self._wrapped is empty:</font>
<font color="green">  55.             self._setup(name)</font>
<font color="green">  56.         return getattr(self._wrapped, name)</font>
<font color="black">  57. </font>
<font color="green">  58.     def configure(self, default_settings=global_settings, **options):</font>
<font color="black">  59.         &quot;&quot;&quot;</font>
<font color="black">  60.         Called to manually configure the settings. The 'default_settings'</font>
<font color="black">  61.         parameter sets where to retrieve any unspecified values from (its</font>
<font color="black">  62.         argument must support attribute access (__getattr__)).</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="red">  64.         if self._wrapped is not empty:</font>
<font color="red">  65.             raise RuntimeError('Settings already configured.')</font>
<font color="red">  66.         holder = UserSettingsHolder(default_settings)</font>
<font color="red">  67.         for name, value in options.items():</font>
<font color="red">  68.             setattr(holder, name, value)</font>
<font color="red">  69.         self._wrapped = holder</font>
<font color="black">  70. </font>
<font color="green">  71.     @property</font>
<font color="black">  72.     def configured(self):</font>
<font color="black">  73.         &quot;&quot;&quot;</font>
<font color="black">  74.         Returns True if the settings have already been configured.</font>
<font color="black">  75.         &quot;&quot;&quot;</font>
<font color="green">  76.         return self._wrapped is not empty</font>
<font color="black">  77. </font>
<font color="black">  78. </font>
<font color="green">  79. class BaseSettings(object):</font>
<font color="black">  80.     &quot;&quot;&quot;</font>
<font color="black">  81.     Common logic for settings whether set by a module or by the user.</font>
<font color="green">  82.     &quot;&quot;&quot;</font>
<font color="green">  83.     def __setattr__(self, name, value):</font>
<font color="green">  84.         if name in (&quot;MEDIA_URL&quot;, &quot;STATIC_URL&quot;) and value and not value.endswith('/'):</font>
<font color="red">  85.             raise ImproperlyConfigured(&quot;If set, %s must end with a slash&quot; % name)</font>
<font color="green">  86.         object.__setattr__(self, name, value)</font>
<font color="black">  87. </font>
<font color="black">  88. </font>
<font color="green">  89. class Settings(BaseSettings):</font>
<font color="green">  90.     def __init__(self, settings_module):</font>
<font color="black">  91.         # update this dict from global settings (but only for ALL_CAPS settings)</font>
<font color="green">  92.         for setting in dir(global_settings):</font>
<font color="green">  93.             if setting.isupper():</font>
<font color="green">  94.                 setattr(self, setting, getattr(global_settings, setting))</font>
<font color="black">  95. </font>
<font color="black">  96.         # store the settings module in case someone later cares</font>
<font color="green">  97.         self.SETTINGS_MODULE = settings_module</font>
<font color="black">  98. </font>
<font color="green">  99.         mod = importlib.import_module(self.SETTINGS_MODULE)</font>
<font color="black"> 100. </font>
<font color="black"> 101.         tuple_settings = (</font>
<font color="black"> 102.             &quot;ALLOWED_INCLUDE_ROOTS&quot;,</font>
<font color="black"> 103.             &quot;INSTALLED_APPS&quot;,</font>
<font color="black"> 104.             &quot;TEMPLATE_DIRS&quot;,</font>
<font color="green"> 105.             &quot;LOCALE_PATHS&quot;,</font>
<font color="black"> 106.         )</font>
<font color="green"> 107.         self._explicit_settings = set()</font>
<font color="green"> 108.         for setting in dir(mod):</font>
<font color="green"> 109.             if setting.isupper():</font>
<font color="green"> 110.                 setting_value = getattr(mod, setting)</font>
<font color="black"> 111. </font>
<font color="green"> 112.                 if (setting in tuple_settings and</font>
<font color="green"> 113.                         not isinstance(setting_value, (list, tuple))):</font>
<font color="red"> 114.                     raise ImproperlyConfigured(&quot;The %s setting must be a list or a tuple. &quot;</font>
<font color="red"> 115.                             &quot;Please fix your settings.&quot; % setting)</font>
<font color="green"> 116.                 setattr(self, setting, setting_value)</font>
<font color="green"> 117.                 self._explicit_settings.add(setting)</font>
<font color="black"> 118. </font>
<font color="green"> 119.         if not self.SECRET_KEY:</font>
<font color="red"> 120.             raise ImproperlyConfigured(&quot;The SECRET_KEY setting must not be empty.&quot;)</font>
<font color="black"> 121. </font>
<font color="green"> 122.         if ('django.contrib.auth.middleware.AuthenticationMiddleware' in self.MIDDLEWARE_CLASSES and</font>
<font color="green"> 123.                 'django.contrib.auth.middleware.SessionAuthenticationMiddleware' not in self.MIDDLEWARE_CLASSES):</font>
<font color="red"> 124.             warnings.warn(</font>
<font color="red"> 125.                 &quot;Session verification will become mandatory in Django 1.10. &quot;</font>
<font color="black"> 126.                 &quot;Please add 'django.contrib.auth.middleware.SessionAuthenticationMiddleware' &quot;</font>
<font color="black"> 127.                 &quot;to your MIDDLEWARE_CLASSES setting when you are ready to opt-in after &quot;</font>
<font color="black"> 128.                 &quot;reading the upgrade considerations in the 1.8 release notes.&quot;,</font>
<font color="red"> 129.                 RemovedInDjango110Warning</font>
<font color="black"> 130.             )</font>
<font color="black"> 131. </font>
<font color="green"> 132.         if hasattr(time, 'tzset') and self.TIME_ZONE:</font>
<font color="black"> 133.             # When we can, attempt to validate the timezone. If we can't find</font>
<font color="black"> 134.             # this file, no check happens and it's harmless.</font>
<font color="green"> 135.             zoneinfo_root = '/usr/share/zoneinfo'</font>
<font color="green"> 136.             if (os.path.exists(zoneinfo_root) and not</font>
<font color="green"> 137.                     os.path.exists(os.path.join(zoneinfo_root, *(self.TIME_ZONE.split('/'))))):</font>
<font color="red"> 138.                 raise ValueError(&quot;Incorrect timezone setting: %s&quot; % self.TIME_ZONE)</font>
<font color="black"> 139.             # Move the time zone info into os.environ. See ticket #2315 for why</font>
<font color="black"> 140.             # we don't do this unconditionally (breaks Windows).</font>
<font color="green"> 141.             os.environ['TZ'] = self.TIME_ZONE</font>
<font color="green"> 142.             time.tzset()</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def is_overridden(self, setting):</font>
<font color="red"> 145.         return setting in self._explicit_settings</font>
<font color="black"> 146. </font>
<font color="green"> 147.     def __repr__(self):</font>
<font color="red"> 148.         return '&lt;%(cls)s &quot;%(settings_module)s&quot;&gt;' % {</font>
<font color="red"> 149.             'cls': self.__class__.__name__,</font>
<font color="red"> 150.             'settings_module': self.SETTINGS_MODULE,</font>
<font color="black"> 151.         }</font>
<font color="black"> 152. </font>
<font color="black"> 153. </font>
<font color="green"> 154. class UserSettingsHolder(BaseSettings):</font>
<font color="black"> 155.     &quot;&quot;&quot;</font>
<font color="black"> 156.     Holder for user configured settings.</font>
<font color="green"> 157.     &quot;&quot;&quot;</font>
<font color="black"> 158.     # SETTINGS_MODULE doesn't make much sense in the manually configured</font>
<font color="black"> 159.     # (standalone) case.</font>
<font color="green"> 160.     SETTINGS_MODULE = None</font>
<font color="black"> 161. </font>
<font color="green"> 162.     def __init__(self, default_settings):</font>
<font color="black"> 163.         &quot;&quot;&quot;</font>
<font color="black"> 164.         Requests for configuration variables not in this class are satisfied</font>
<font color="black"> 165.         from the module specified in default_settings (if possible).</font>
<font color="black"> 166.         &quot;&quot;&quot;</font>
<font color="red"> 167.         self.__dict__['_deleted'] = set()</font>
<font color="red"> 168.         self.default_settings = default_settings</font>
<font color="black"> 169. </font>
<font color="green"> 170.     def __getattr__(self, name):</font>
<font color="red"> 171.         if name in self._deleted:</font>
<font color="red"> 172.             raise AttributeError</font>
<font color="red"> 173.         return getattr(self.default_settings, name)</font>
<font color="black"> 174. </font>
<font color="green"> 175.     def __setattr__(self, name, value):</font>
<font color="red"> 176.         self._deleted.discard(name)</font>
<font color="red"> 177.         super(UserSettingsHolder, self).__setattr__(name, value)</font>
<font color="black"> 178. </font>
<font color="green"> 179.     def __delattr__(self, name):</font>
<font color="red"> 180.         self._deleted.add(name)</font>
<font color="red"> 181.         if hasattr(self, name):</font>
<font color="red"> 182.             super(UserSettingsHolder, self).__delattr__(name)</font>
<font color="black"> 183. </font>
<font color="green"> 184.     def __dir__(self):</font>
<font color="red"> 185.         return list(self.__dict__) + dir(self.default_settings)</font>
<font color="black"> 186. </font>
<font color="green"> 187.     def is_overridden(self, setting):</font>
<font color="red"> 188.         deleted = (setting in self._deleted)</font>
<font color="red"> 189.         set_locally = (setting in self.__dict__)</font>
<font color="red"> 190.         set_on_default = getattr(self.default_settings, 'is_overridden', lambda s: False)(setting)</font>
<font color="red"> 191.         return (deleted or set_locally or set_on_default)</font>
<font color="black"> 192. </font>
<font color="green"> 193.     def __repr__(self):</font>
<font color="red"> 194.         return '&lt;%(cls)s&gt;' % {</font>
<font color="red"> 195.             'cls': self.__class__.__name__,</font>
<font color="black"> 196.         }</font>
<font color="black"> 197. </font>
<font color="green"> 198. settings = LazySettings()</font>
</pre>


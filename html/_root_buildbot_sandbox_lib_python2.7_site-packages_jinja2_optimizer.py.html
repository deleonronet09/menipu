source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/jinja2/optimizer.py</b><br>


file stats: <b>33 lines, 10 executed: 30.3% covered</b>
<pre>
<font color="black">   1. # -*- coding: utf-8 -*-</font>
<font color="black">   2. &quot;&quot;&quot;</font>
<font color="black">   3.     jinja2.optimizer</font>
<font color="black">   4.     ~~~~~~~~~~~~~~~~</font>
<font color="black">   5. </font>
<font color="black">   6.     The jinja optimizer is currently trying to constant fold a few expressions</font>
<font color="black">   7.     and modify the AST in place so that it should be easier to evaluate it.</font>
<font color="black">   8. </font>
<font color="black">   9.     Because the AST does not contain all the scoping information and the</font>
<font color="black">  10.     compiler has to find that out, we cannot do all the optimizations we</font>
<font color="black">  11.     want.  For example loop unrolling doesn't work because unrolled loops would</font>
<font color="black">  12.     have a different scoping.</font>
<font color="black">  13. </font>
<font color="black">  14.     The solution would be a second syntax tree that has the scoping rules stored.</font>
<font color="black">  15. </font>
<font color="black">  16.     :copyright: (c) 2010 by the Jinja Team.</font>
<font color="black">  17.     :license: BSD.</font>
<font color="green">  18. &quot;&quot;&quot;</font>
<font color="green">  19. from jinja2 import nodes</font>
<font color="green">  20. from jinja2.visitor import NodeTransformer</font>
<font color="black">  21. </font>
<font color="black">  22. </font>
<font color="green">  23. def optimize(node, environment):</font>
<font color="black">  24.     &quot;&quot;&quot;The context hint can be used to perform an static optimization</font>
<font color="black">  25.     based on the context given.&quot;&quot;&quot;</font>
<font color="red">  26.     optimizer = Optimizer(environment)</font>
<font color="red">  27.     return optimizer.visit(node)</font>
<font color="black">  28. </font>
<font color="black">  29. </font>
<font color="green">  30. class Optimizer(NodeTransformer):</font>
<font color="black">  31. </font>
<font color="green">  32.     def __init__(self, environment):</font>
<font color="red">  33.         self.environment = environment</font>
<font color="black">  34. </font>
<font color="green">  35.     def visit_If(self, node):</font>
<font color="black">  36.         &quot;&quot;&quot;Eliminate dead code.&quot;&quot;&quot;</font>
<font color="black">  37.         # do not optimize ifs that have a block inside so that it doesn't</font>
<font color="black">  38.         # break super().</font>
<font color="red">  39.         if node.find(nodes.Block) is not None:</font>
<font color="red">  40.             return self.generic_visit(node)</font>
<font color="red">  41.         try:</font>
<font color="red">  42.             val = self.visit(node.test).as_const()</font>
<font color="red">  43.         except nodes.Impossible:</font>
<font color="red">  44.             return self.generic_visit(node)</font>
<font color="red">  45.         if val:</font>
<font color="red">  46.             body = node.body</font>
<font color="black">  47.         else:</font>
<font color="red">  48.             body = node.else_</font>
<font color="red">  49.         result = []</font>
<font color="red">  50.         for node in body:</font>
<font color="red">  51.             result.extend(self.visit_list(node))</font>
<font color="red">  52.         return result</font>
<font color="black">  53. </font>
<font color="green">  54.     def fold(self, node):</font>
<font color="black">  55.         &quot;&quot;&quot;Do constant folding.&quot;&quot;&quot;</font>
<font color="red">  56.         node = self.generic_visit(node)</font>
<font color="red">  57.         try:</font>
<font color="red">  58.             return nodes.Const.from_untrusted(node.as_const(),</font>
<font color="red">  59.                                               lineno=node.lineno,</font>
<font color="red">  60.                                               environment=self.environment)</font>
<font color="red">  61.         except nodes.Impossible:</font>
<font color="red">  62.             return node</font>
<font color="black">  63. </font>
<font color="black">  64.     visit_Add = visit_Sub = visit_Mul = visit_Div = visit_FloorDiv = \</font>
<font color="black">  65.     visit_Pow = visit_Mod = visit_And = visit_Or = visit_Pos = visit_Neg = \</font>
<font color="black">  66.     visit_Not = visit_Compare = visit_Getitem = visit_Getattr = visit_Call = \</font>
<font color="green">  67.     visit_Filter = visit_Test = visit_CondExpr = fold</font>
<font color="green">  68.     del fold</font>
</pre>


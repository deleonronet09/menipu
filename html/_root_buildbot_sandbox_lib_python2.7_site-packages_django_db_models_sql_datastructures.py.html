source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/db/models/sql/datastructures.py</b><br>


file stats: <b>80 lines, 59 executed: 73.8% covered</b>
<pre>
<font color="black">   1. &quot;&quot;&quot;</font>
<font color="black">   2. Useful auxiliary data structures for query construction. Not useful outside</font>
<font color="black">   3. the SQL domain.</font>
<font color="green">   4. &quot;&quot;&quot;</font>
<font color="green">   5. from django.db.models.sql.constants import INNER, LOUTER</font>
<font color="black">   6. </font>
<font color="black">   7. </font>
<font color="green">   8. class EmptyResultSet(Exception):</font>
<font color="green">   9.     pass</font>
<font color="black">  10. </font>
<font color="black">  11. </font>
<font color="green">  12. class MultiJoin(Exception):</font>
<font color="black">  13.     &quot;&quot;&quot;</font>
<font color="black">  14.     Used by join construction code to indicate the point at which a</font>
<font color="black">  15.     multi-valued join was attempted (if the caller wants to treat that</font>
<font color="black">  16.     exceptionally).</font>
<font color="green">  17.     &quot;&quot;&quot;</font>
<font color="green">  18.     def __init__(self, names_pos, path_with_names):</font>
<font color="red">  19.         self.level = names_pos</font>
<font color="black">  20.         # The path travelled, this includes the path to the multijoin.</font>
<font color="red">  21.         self.names_with_path = path_with_names</font>
<font color="black">  22. </font>
<font color="black">  23. </font>
<font color="green">  24. class Empty(object):</font>
<font color="green">  25.     pass</font>
<font color="black">  26. </font>
<font color="black">  27. </font>
<font color="green">  28. class Join(object):</font>
<font color="black">  29.     &quot;&quot;&quot;</font>
<font color="black">  30.     Used by sql.Query and sql.SQLCompiler to generate JOIN clauses into the</font>
<font color="black">  31.     FROM entry. For example, the SQL generated could be</font>
<font color="black">  32.         LEFT OUTER JOIN &quot;sometable&quot; T1 ON (&quot;othertable&quot;.&quot;sometable_id&quot; = &quot;sometable&quot;.&quot;id&quot;)</font>
<font color="black">  33. </font>
<font color="black">  34.     This class is primarily used in Query.alias_map. All entries in alias_map</font>
<font color="black">  35.     must be Join compatible by providing the following attributes and methods:</font>
<font color="black">  36.         - table_name (string)</font>
<font color="black">  37.         - table_alias (possible alias for the table, can be None)</font>
<font color="black">  38.         - join_type (can be None for those entries that aren't joined from</font>
<font color="black">  39.           anything)</font>
<font color="black">  40.         - parent_alias (which table is this join's parent, can be None similarly</font>
<font color="black">  41.           to join_type)</font>
<font color="black">  42.         - as_sql()</font>
<font color="black">  43.         - relabeled_clone()</font>
<font color="green">  44.     &quot;&quot;&quot;</font>
<font color="green">  45.     def __init__(self, table_name, parent_alias, table_alias, join_type,</font>
<font color="black">  46.                  join_field, nullable):</font>
<font color="black">  47.         # Join table</font>
<font color="green">  48.         self.table_name = table_name</font>
<font color="green">  49.         self.parent_alias = parent_alias</font>
<font color="black">  50.         # Note: table_alias is not necessarily known at instantiation time.</font>
<font color="green">  51.         self.table_alias = table_alias</font>
<font color="black">  52.         # LOUTER or INNER</font>
<font color="green">  53.         self.join_type = join_type</font>
<font color="black">  54.         # A list of 2-tuples to use in the ON clause of the JOIN.</font>
<font color="black">  55.         # Each 2-tuple will create one join condition in the ON clause.</font>
<font color="green">  56.         self.join_cols = join_field.get_joining_columns()</font>
<font color="black">  57.         # Along which field (or ForeignObjectRel in the reverse join case)</font>
<font color="green">  58.         self.join_field = join_field</font>
<font color="black">  59.         # Is this join nullabled?</font>
<font color="green">  60.         self.nullable = nullable</font>
<font color="black">  61. </font>
<font color="green">  62.     def as_sql(self, compiler, connection):</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="black">  64.         Generates the full</font>
<font color="black">  65.            LEFT OUTER JOIN sometable ON sometable.somecol = othertable.othercol, params</font>
<font color="black">  66.         clause for this join.</font>
<font color="black">  67.         &quot;&quot;&quot;</font>
<font color="green">  68.         join_conditions = []</font>
<font color="green">  69.         params = []</font>
<font color="green">  70.         qn = compiler.quote_name_unless_alias</font>
<font color="green">  71.         qn2 = connection.ops.quote_name</font>
<font color="black">  72. </font>
<font color="black">  73.         # Add a join condition for each pair of joining columns.</font>
<font color="green">  74.         for index, (lhs_col, rhs_col) in enumerate(self.join_cols):</font>
<font color="green">  75.             join_conditions.append('%s.%s = %s.%s' % (</font>
<font color="green">  76.                 qn(self.parent_alias),</font>
<font color="green">  77.                 qn2(lhs_col),</font>
<font color="green">  78.                 qn(self.table_alias),</font>
<font color="green">  79.                 qn2(rhs_col),</font>
<font color="black">  80.             ))</font>
<font color="black">  81. </font>
<font color="black">  82.         # Add a single condition inside parentheses for whatever</font>
<font color="black">  83.         # get_extra_restriction() returns.</font>
<font color="green">  84.         extra_cond = self.join_field.get_extra_restriction(</font>
<font color="green">  85.             compiler.query.where_class, self.table_alias, self.parent_alias)</font>
<font color="green">  86.         if extra_cond:</font>
<font color="red">  87.             extra_sql, extra_params = compiler.compile(extra_cond)</font>
<font color="red">  88.             join_conditions.append('(%s)' % extra_sql)</font>
<font color="red">  89.             params.extend(extra_params)</font>
<font color="black">  90. </font>
<font color="green">  91.         if not join_conditions:</font>
<font color="black">  92.             # This might be a rel on the other end of an actual declared field.</font>
<font color="red">  93.             declared_field = getattr(self.join_field, 'field', self.join_field)</font>
<font color="red">  94.             raise ValueError(</font>
<font color="red">  95.                 &quot;Join generated an empty ON clause. %s did not yield either &quot;</font>
<font color="red">  96.                 &quot;joining columns or extra restrictions.&quot; % declared_field.__class__</font>
<font color="black">  97.             )</font>
<font color="green">  98.         on_clause_sql = ' AND '.join(join_conditions)</font>
<font color="green">  99.         alias_str = '' if self.table_alias == self.table_name else (' %s' % self.table_alias)</font>
<font color="green"> 100.         sql = '%s %s%s ON (%s)' % (self.join_type, qn(self.table_name), alias_str, on_clause_sql)</font>
<font color="green"> 101.         return sql, params</font>
<font color="black"> 102. </font>
<font color="green"> 103.     def relabeled_clone(self, change_map):</font>
<font color="red"> 104.         new_parent_alias = change_map.get(self.parent_alias, self.parent_alias)</font>
<font color="red"> 105.         new_table_alias = change_map.get(self.table_alias, self.table_alias)</font>
<font color="red"> 106.         return self.__class__(</font>
<font color="red"> 107.             self.table_name, new_parent_alias, new_table_alias, self.join_type,</font>
<font color="red"> 108.             self.join_field, self.nullable)</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def __eq__(self, other):</font>
<font color="green"> 111.         if isinstance(other, self.__class__):</font>
<font color="black"> 112.             return (</font>
<font color="green"> 113.                 self.table_name == other.table_name and</font>
<font color="green"> 114.                 self.parent_alias == other.parent_alias and</font>
<font color="green"> 115.                 self.join_field == other.join_field</font>
<font color="black"> 116.             )</font>
<font color="green"> 117.         return False</font>
<font color="black"> 118. </font>
<font color="green"> 119.     def demote(self):</font>
<font color="red"> 120.         new = self.relabeled_clone({})</font>
<font color="red"> 121.         new.join_type = INNER</font>
<font color="red"> 122.         return new</font>
<font color="black"> 123. </font>
<font color="green"> 124.     def promote(self):</font>
<font color="red"> 125.         new = self.relabeled_clone({})</font>
<font color="red"> 126.         new.join_type = LOUTER</font>
<font color="red"> 127.         return new</font>
<font color="black"> 128. </font>
<font color="black"> 129. </font>
<font color="green"> 130. class BaseTable(object):</font>
<font color="black"> 131.     &quot;&quot;&quot;</font>
<font color="black"> 132.     The BaseTable class is used for base table references in FROM clause. For</font>
<font color="black"> 133.     example, the SQL &quot;foo&quot; in</font>
<font color="black"> 134.         SELECT * FROM &quot;foo&quot; WHERE somecond</font>
<font color="black"> 135.     could be generated by this class.</font>
<font color="green"> 136.     &quot;&quot;&quot;</font>
<font color="green"> 137.     join_type = None</font>
<font color="green"> 138.     parent_alias = None</font>
<font color="black"> 139. </font>
<font color="green"> 140.     def __init__(self, table_name, alias):</font>
<font color="green"> 141.         self.table_name = table_name</font>
<font color="green"> 142.         self.table_alias = alias</font>
<font color="black"> 143. </font>
<font color="green"> 144.     def as_sql(self, compiler, connection):</font>
<font color="green"> 145.         alias_str = '' if self.table_alias == self.table_name else (' %s' % self.table_alias)</font>
<font color="green"> 146.         base_sql = compiler.quote_name_unless_alias(self.table_name)</font>
<font color="green"> 147.         return base_sql + alias_str, []</font>
<font color="black"> 148. </font>
<font color="green"> 149.     def relabeled_clone(self, change_map):</font>
<font color="red"> 150.         return self.__class__(self.table_name, change_map.get(self.table_alias, self.table_alias))</font>
</pre>


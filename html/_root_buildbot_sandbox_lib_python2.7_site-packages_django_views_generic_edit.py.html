source file: <b>/root/buildbot/sandbox/lib/python2.7/site-packages/django/views/generic/edit.py</b><br>


file stats: <b>172 lines, 75 executed: 43.6% covered</b>
<pre>
<font color="green">   1. import inspect</font>
<font color="green">   2. import re</font>
<font color="green">   3. import warnings</font>
<font color="black">   4. </font>
<font color="green">   5. from django.core.exceptions import ImproperlyConfigured</font>
<font color="green">   6. from django.forms import models as model_forms</font>
<font color="green">   7. from django.http import HttpResponseRedirect</font>
<font color="green">   8. from django.utils import six</font>
<font color="green">   9. from django.utils.deprecation import RemovedInDjango110Warning</font>
<font color="green">  10. from django.utils.encoding import force_text</font>
<font color="green">  11. from django.views.generic.base import ContextMixin, TemplateResponseMixin, View</font>
<font color="green">  12. from django.views.generic.detail import (</font>
<font color="black">  13.     BaseDetailView, SingleObjectMixin, SingleObjectTemplateResponseMixin,</font>
<font color="black">  14. )</font>
<font color="black">  15. </font>
<font color="green">  16. PERCENT_PLACEHOLDER_REGEX = re.compile(r'%\([^\)]+\)')  # RemovedInDjango110Warning</font>
<font color="black">  17. </font>
<font color="black">  18. </font>
<font color="green">  19. class FormMixinBase(type):</font>
<font color="green">  20.     def __new__(cls, name, bases, attrs):</font>
<font color="green">  21.         get_form = attrs.get('get_form')</font>
<font color="green">  22.         if get_form and inspect.isfunction(get_form):</font>
<font color="green">  23.             try:</font>
<font color="green">  24.                 inspect.getcallargs(get_form, None)</font>
<font color="red">  25.             except TypeError:</font>
<font color="red">  26.                 warnings.warn(</font>
<font color="red">  27.                     &quot;`%s.%s.get_form` method must define a default value for &quot;</font>
<font color="red">  28.                     &quot;its `form_class` argument.&quot; % (attrs['__module__'], name),</font>
<font color="red">  29.                     RemovedInDjango110Warning, stacklevel=2</font>
<font color="black">  30.                 )</font>
<font color="black">  31. </font>
<font color="red">  32.                 def get_form_with_form_class(self, form_class=None):</font>
<font color="red">  33.                     if form_class is None:</font>
<font color="red">  34.                         form_class = self.get_form_class()</font>
<font color="red">  35.                     return get_form(self, form_class=form_class)</font>
<font color="red">  36.                 attrs['get_form'] = get_form_with_form_class</font>
<font color="green">  37.         return super(FormMixinBase, cls).__new__(cls, name, bases, attrs)</font>
<font color="black">  38. </font>
<font color="black">  39. </font>
<font color="green">  40. class FormMixin(six.with_metaclass(FormMixinBase, ContextMixin)):</font>
<font color="black">  41.     &quot;&quot;&quot;</font>
<font color="black">  42.     A mixin that provides a way to show and handle a form in a request.</font>
<font color="green">  43.     &quot;&quot;&quot;</font>
<font color="black">  44. </font>
<font color="green">  45.     initial = {}</font>
<font color="green">  46.     form_class = None</font>
<font color="green">  47.     success_url = None</font>
<font color="green">  48.     prefix = None</font>
<font color="black">  49. </font>
<font color="green">  50.     def get_initial(self):</font>
<font color="black">  51.         &quot;&quot;&quot;</font>
<font color="black">  52.         Returns the initial data to use for forms on this view.</font>
<font color="black">  53.         &quot;&quot;&quot;</font>
<font color="red">  54.         return self.initial.copy()</font>
<font color="black">  55. </font>
<font color="green">  56.     def get_prefix(self):</font>
<font color="black">  57.         &quot;&quot;&quot;</font>
<font color="black">  58.         Returns the prefix to use for forms on this view</font>
<font color="black">  59.         &quot;&quot;&quot;</font>
<font color="red">  60.         return self.prefix</font>
<font color="black">  61. </font>
<font color="green">  62.     def get_form_class(self):</font>
<font color="black">  63.         &quot;&quot;&quot;</font>
<font color="black">  64.         Returns the form class to use in this view</font>
<font color="black">  65.         &quot;&quot;&quot;</font>
<font color="red">  66.         return self.form_class</font>
<font color="black">  67. </font>
<font color="green">  68.     def get_form(self, form_class=None):</font>
<font color="black">  69.         &quot;&quot;&quot;</font>
<font color="black">  70.         Returns an instance of the form to be used in this view.</font>
<font color="black">  71.         &quot;&quot;&quot;</font>
<font color="red">  72.         if form_class is None:</font>
<font color="red">  73.             form_class = self.get_form_class()</font>
<font color="red">  74.         return form_class(**self.get_form_kwargs())</font>
<font color="black">  75. </font>
<font color="green">  76.     def get_form_kwargs(self):</font>
<font color="black">  77.         &quot;&quot;&quot;</font>
<font color="black">  78.         Returns the keyword arguments for instantiating the form.</font>
<font color="black">  79.         &quot;&quot;&quot;</font>
<font color="red">  80.         kwargs = {</font>
<font color="red">  81.             'initial': self.get_initial(),</font>
<font color="red">  82.             'prefix': self.get_prefix(),</font>
<font color="black">  83.         }</font>
<font color="black">  84. </font>
<font color="red">  85.         if self.request.method in ('POST', 'PUT'):</font>
<font color="red">  86.             kwargs.update({</font>
<font color="red">  87.                 'data': self.request.POST,</font>
<font color="red">  88.                 'files': self.request.FILES,</font>
<font color="black">  89.             })</font>
<font color="red">  90.         return kwargs</font>
<font color="black">  91. </font>
<font color="green">  92.     def get_success_url(self):</font>
<font color="black">  93.         &quot;&quot;&quot;</font>
<font color="black">  94.         Returns the supplied success URL.</font>
<font color="black">  95.         &quot;&quot;&quot;</font>
<font color="red">  96.         if self.success_url:</font>
<font color="black">  97.             # Forcing possible reverse_lazy evaluation</font>
<font color="red">  98.             url = force_text(self.success_url)</font>
<font color="black">  99.         else:</font>
<font color="red"> 100.             raise ImproperlyConfigured(</font>
<font color="red"> 101.                 &quot;No URL to redirect to. Provide a success_url.&quot;)</font>
<font color="red"> 102.         return url</font>
<font color="black"> 103. </font>
<font color="green"> 104.     def form_valid(self, form):</font>
<font color="black"> 105.         &quot;&quot;&quot;</font>
<font color="black"> 106.         If the form is valid, redirect to the supplied URL.</font>
<font color="black"> 107.         &quot;&quot;&quot;</font>
<font color="red"> 108.         return HttpResponseRedirect(self.get_success_url())</font>
<font color="black"> 109. </font>
<font color="green"> 110.     def form_invalid(self, form):</font>
<font color="black"> 111.         &quot;&quot;&quot;</font>
<font color="black"> 112.         If the form is invalid, re-render the context data with the</font>
<font color="black"> 113.         data-filled form and errors.</font>
<font color="black"> 114.         &quot;&quot;&quot;</font>
<font color="red"> 115.         return self.render_to_response(self.get_context_data())</font>
<font color="black"> 116. </font>
<font color="green"> 117.     def get_context_data(self, **kwargs):</font>
<font color="black"> 118.         &quot;&quot;&quot;</font>
<font color="black"> 119.         Insert the form into the context dict.</font>
<font color="black"> 120.         &quot;&quot;&quot;</font>
<font color="red"> 121.         kwargs.setdefault('form', self.get_form())</font>
<font color="red"> 122.         return super(FormMixin, self).get_context_data(**kwargs)</font>
<font color="black"> 123. </font>
<font color="black"> 124. </font>
<font color="green"> 125. class ModelFormMixin(FormMixin, SingleObjectMixin):</font>
<font color="black"> 126.     &quot;&quot;&quot;</font>
<font color="black"> 127.     A mixin that provides a way to show and handle a modelform in a request.</font>
<font color="green"> 128.     &quot;&quot;&quot;</font>
<font color="green"> 129.     fields = None</font>
<font color="black"> 130. </font>
<font color="green"> 131.     def get_form_class(self):</font>
<font color="black"> 132.         &quot;&quot;&quot;</font>
<font color="black"> 133.         Returns the form class to use in this view.</font>
<font color="black"> 134.         &quot;&quot;&quot;</font>
<font color="red"> 135.         if self.fields is not None and self.form_class:</font>
<font color="red"> 136.             raise ImproperlyConfigured(</font>
<font color="red"> 137.                 &quot;Specifying both 'fields' and 'form_class' is not permitted.&quot;</font>
<font color="black"> 138.             )</font>
<font color="red"> 139.         if self.form_class:</font>
<font color="red"> 140.             return self.form_class</font>
<font color="black"> 141.         else:</font>
<font color="red"> 142.             if self.model is not None:</font>
<font color="black"> 143.                 # If a model has been explicitly provided, use it</font>
<font color="red"> 144.                 model = self.model</font>
<font color="red"> 145.             elif hasattr(self, 'object') and self.object is not None:</font>
<font color="black"> 146.                 # If this view is operating on a single object, use</font>
<font color="black"> 147.                 # the class of that object</font>
<font color="red"> 148.                 model = self.object.__class__</font>
<font color="black"> 149.             else:</font>
<font color="black"> 150.                 # Try to get a queryset and extract the model class</font>
<font color="black"> 151.                 # from that</font>
<font color="red"> 152.                 model = self.get_queryset().model</font>
<font color="black"> 153. </font>
<font color="red"> 154.             if self.fields is None:</font>
<font color="red"> 155.                 raise ImproperlyConfigured(</font>
<font color="red"> 156.                     &quot;Using ModelFormMixin (base class of %s) without &quot;</font>
<font color="red"> 157.                     &quot;the 'fields' attribute is prohibited.&quot; % self.__class__.__name__</font>
<font color="black"> 158.                 )</font>
<font color="black"> 159. </font>
<font color="red"> 160.             return model_forms.modelform_factory(model, fields=self.fields)</font>
<font color="black"> 161. </font>
<font color="green"> 162.     def get_form_kwargs(self):</font>
<font color="black"> 163.         &quot;&quot;&quot;</font>
<font color="black"> 164.         Returns the keyword arguments for instantiating the form.</font>
<font color="black"> 165.         &quot;&quot;&quot;</font>
<font color="red"> 166.         kwargs = super(ModelFormMixin, self).get_form_kwargs()</font>
<font color="red"> 167.         if hasattr(self, 'object'):</font>
<font color="red"> 168.             kwargs.update({'instance': self.object})</font>
<font color="red"> 169.         return kwargs</font>
<font color="black"> 170. </font>
<font color="green"> 171.     def get_success_url(self):</font>
<font color="black"> 172.         &quot;&quot;&quot;</font>
<font color="black"> 173.         Returns the supplied URL.</font>
<font color="black"> 174.         &quot;&quot;&quot;</font>
<font color="red"> 175.         if self.success_url:</font>
<font color="black"> 176.             # force_text can be removed with deprecation warning</font>
<font color="red"> 177.             self.success_url = force_text(self.success_url)</font>
<font color="red"> 178.             if PERCENT_PLACEHOLDER_REGEX.search(self.success_url):</font>
<font color="red"> 179.                 warnings.warn(</font>
<font color="red"> 180.                     &quot;%()s placeholder style in success_url is deprecated. &quot;</font>
<font color="black"> 181.                     &quot;Please replace them by the {} Python format syntax.&quot;,</font>
<font color="red"> 182.                     RemovedInDjango110Warning, stacklevel=2</font>
<font color="black"> 183.                 )</font>
<font color="red"> 184.                 url = self.success_url % self.object.__dict__</font>
<font color="black"> 185.             else:</font>
<font color="red"> 186.                 url = self.success_url.format(**self.object.__dict__)</font>
<font color="black"> 187.         else:</font>
<font color="red"> 188.             try:</font>
<font color="red"> 189.                 url = self.object.get_absolute_url()</font>
<font color="red"> 190.             except AttributeError:</font>
<font color="red"> 191.                 raise ImproperlyConfigured(</font>
<font color="red"> 192.                     &quot;No URL to redirect to.  Either provide a url or define&quot;</font>
<font color="black"> 193.                     &quot; a get_absolute_url method on the Model.&quot;)</font>
<font color="red"> 194.         return url</font>
<font color="black"> 195. </font>
<font color="green"> 196.     def form_valid(self, form):</font>
<font color="black"> 197.         &quot;&quot;&quot;</font>
<font color="black"> 198.         If the form is valid, save the associated model.</font>
<font color="black"> 199.         &quot;&quot;&quot;</font>
<font color="red"> 200.         self.object = form.save()</font>
<font color="red"> 201.         return super(ModelFormMixin, self).form_valid(form)</font>
<font color="black"> 202. </font>
<font color="black"> 203. </font>
<font color="green"> 204. class ProcessFormView(View):</font>
<font color="black"> 205.     &quot;&quot;&quot;</font>
<font color="black"> 206.     A mixin that renders a form on GET and processes it on POST.</font>
<font color="green"> 207.     &quot;&quot;&quot;</font>
<font color="green"> 208.     def get(self, request, *args, **kwargs):</font>
<font color="black"> 209.         &quot;&quot;&quot;</font>
<font color="black"> 210.         Handles GET requests and instantiates a blank version of the form.</font>
<font color="black"> 211.         &quot;&quot;&quot;</font>
<font color="red"> 212.         return self.render_to_response(self.get_context_data())</font>
<font color="black"> 213. </font>
<font color="green"> 214.     def post(self, request, *args, **kwargs):</font>
<font color="black"> 215.         &quot;&quot;&quot;</font>
<font color="black"> 216.         Handles POST requests, instantiating a form instance with the passed</font>
<font color="black"> 217.         POST variables and then checked for validity.</font>
<font color="black"> 218.         &quot;&quot;&quot;</font>
<font color="red"> 219.         form = self.get_form()</font>
<font color="red"> 220.         if form.is_valid():</font>
<font color="red"> 221.             return self.form_valid(form)</font>
<font color="black"> 222.         else:</font>
<font color="red"> 223.             return self.form_invalid(form)</font>
<font color="black"> 224. </font>
<font color="black"> 225.     # PUT is a valid HTTP verb for creating (with a known URL) or editing an</font>
<font color="black"> 226.     # object, note that browsers only support POST for now.</font>
<font color="green"> 227.     def put(self, *args, **kwargs):</font>
<font color="red"> 228.         return self.post(*args, **kwargs)</font>
<font color="black"> 229. </font>
<font color="black"> 230. </font>
<font color="green"> 231. class BaseFormView(FormMixin, ProcessFormView):</font>
<font color="black"> 232.     &quot;&quot;&quot;</font>
<font color="black"> 233.     A base view for displaying a form</font>
<font color="green"> 234.     &quot;&quot;&quot;</font>
<font color="black"> 235. </font>
<font color="black"> 236. </font>
<font color="green"> 237. class FormView(TemplateResponseMixin, BaseFormView):</font>
<font color="black"> 238.     &quot;&quot;&quot;</font>
<font color="black"> 239.     A view for displaying a form, and rendering a template response.</font>
<font color="green"> 240.     &quot;&quot;&quot;</font>
<font color="black"> 241. </font>
<font color="black"> 242. </font>
<font color="green"> 243. class BaseCreateView(ModelFormMixin, ProcessFormView):</font>
<font color="black"> 244.     &quot;&quot;&quot;</font>
<font color="black"> 245.     Base view for creating an new object instance.</font>
<font color="black"> 246. </font>
<font color="black"> 247.     Using this base class requires subclassing to provide a response mixin.</font>
<font color="green"> 248.     &quot;&quot;&quot;</font>
<font color="green"> 249.     def get(self, request, *args, **kwargs):</font>
<font color="red"> 250.         self.object = None</font>
<font color="red"> 251.         return super(BaseCreateView, self).get(request, *args, **kwargs)</font>
<font color="black"> 252. </font>
<font color="green"> 253.     def post(self, request, *args, **kwargs):</font>
<font color="red"> 254.         self.object = None</font>
<font color="red"> 255.         return super(BaseCreateView, self).post(request, *args, **kwargs)</font>
<font color="black"> 256. </font>
<font color="black"> 257. </font>
<font color="green"> 258. class CreateView(SingleObjectTemplateResponseMixin, BaseCreateView):</font>
<font color="black"> 259.     &quot;&quot;&quot;</font>
<font color="black"> 260.     View for creating a new object instance,</font>
<font color="black"> 261.     with a response rendered by template.</font>
<font color="green"> 262.     &quot;&quot;&quot;</font>
<font color="green"> 263.     template_name_suffix = '_form'</font>
<font color="black"> 264. </font>
<font color="black"> 265. </font>
<font color="green"> 266. class BaseUpdateView(ModelFormMixin, ProcessFormView):</font>
<font color="black"> 267.     &quot;&quot;&quot;</font>
<font color="black"> 268.     Base view for updating an existing object.</font>
<font color="black"> 269. </font>
<font color="black"> 270.     Using this base class requires subclassing to provide a response mixin.</font>
<font color="green"> 271.     &quot;&quot;&quot;</font>
<font color="green"> 272.     def get(self, request, *args, **kwargs):</font>
<font color="red"> 273.         self.object = self.get_object()</font>
<font color="red"> 274.         return super(BaseUpdateView, self).get(request, *args, **kwargs)</font>
<font color="black"> 275. </font>
<font color="green"> 276.     def post(self, request, *args, **kwargs):</font>
<font color="red"> 277.         self.object = self.get_object()</font>
<font color="red"> 278.         return super(BaseUpdateView, self).post(request, *args, **kwargs)</font>
<font color="black"> 279. </font>
<font color="black"> 280. </font>
<font color="green"> 281. class UpdateView(SingleObjectTemplateResponseMixin, BaseUpdateView):</font>
<font color="black"> 282.     &quot;&quot;&quot;</font>
<font color="black"> 283.     View for updating an object,</font>
<font color="black"> 284.     with a response rendered by template.</font>
<font color="green"> 285.     &quot;&quot;&quot;</font>
<font color="green"> 286.     template_name_suffix = '_form'</font>
<font color="black"> 287. </font>
<font color="black"> 288. </font>
<font color="green"> 289. class DeletionMixin(object):</font>
<font color="black"> 290.     &quot;&quot;&quot;</font>
<font color="black"> 291.     A mixin providing the ability to delete objects</font>
<font color="green"> 292.     &quot;&quot;&quot;</font>
<font color="green"> 293.     success_url = None</font>
<font color="black"> 294. </font>
<font color="green"> 295.     def delete(self, request, *args, **kwargs):</font>
<font color="black"> 296.         &quot;&quot;&quot;</font>
<font color="black"> 297.         Calls the delete() method on the fetched object and then</font>
<font color="black"> 298.         redirects to the success URL.</font>
<font color="black"> 299.         &quot;&quot;&quot;</font>
<font color="red"> 300.         self.object = self.get_object()</font>
<font color="red"> 301.         success_url = self.get_success_url()</font>
<font color="red"> 302.         self.object.delete()</font>
<font color="red"> 303.         return HttpResponseRedirect(success_url)</font>
<font color="black"> 304. </font>
<font color="black"> 305.     # Add support for browsers which only accept GET and POST for now.</font>
<font color="green"> 306.     def post(self, request, *args, **kwargs):</font>
<font color="red"> 307.         return self.delete(request, *args, **kwargs)</font>
<font color="black"> 308. </font>
<font color="green"> 309.     def get_success_url(self):</font>
<font color="red"> 310.         if self.success_url:</font>
<font color="black"> 311.             # force_text can be removed with deprecation warning</font>
<font color="red"> 312.             self.success_url = force_text(self.success_url)</font>
<font color="red"> 313.             if PERCENT_PLACEHOLDER_REGEX.search(self.success_url):</font>
<font color="red"> 314.                 warnings.warn(</font>
<font color="red"> 315.                     &quot;%()s placeholder style in success_url is deprecated. &quot;</font>
<font color="black"> 316.                     &quot;Please replace them by the {} Python format syntax.&quot;,</font>
<font color="red"> 317.                     RemovedInDjango110Warning, stacklevel=2</font>
<font color="black"> 318.                 )</font>
<font color="red"> 319.                 return self.success_url % self.object.__dict__</font>
<font color="black"> 320.             else:</font>
<font color="red"> 321.                 return self.success_url.format(**self.object.__dict__)</font>
<font color="black"> 322.         else:</font>
<font color="red"> 323.             raise ImproperlyConfigured(</font>
<font color="red"> 324.                 &quot;No URL to redirect to. Provide a success_url.&quot;)</font>
<font color="black"> 325. </font>
<font color="black"> 326. </font>
<font color="green"> 327. class BaseDeleteView(DeletionMixin, BaseDetailView):</font>
<font color="black"> 328.     &quot;&quot;&quot;</font>
<font color="black"> 329.     Base view for deleting an object.</font>
<font color="black"> 330. </font>
<font color="black"> 331.     Using this base class requires subclassing to provide a response mixin.</font>
<font color="green"> 332.     &quot;&quot;&quot;</font>
<font color="black"> 333. </font>
<font color="black"> 334. </font>
<font color="green"> 335. class DeleteView(SingleObjectTemplateResponseMixin, BaseDeleteView):</font>
<font color="black"> 336.     &quot;&quot;&quot;</font>
<font color="black"> 337.     View for deleting an object retrieved with `self.get_object()`,</font>
<font color="black"> 338.     with a response rendered by template.</font>
<font color="green"> 339.     &quot;&quot;&quot;</font>
<font color="green"> 340.     template_name_suffix = '_confirm_delete'</font>
</pre>


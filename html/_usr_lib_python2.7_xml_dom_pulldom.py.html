source file: <b>/usr/lib/python2.7/xml/dom/pulldom.py</b><br>


file stats: <b>270 lines, 57 executed: 21.1% covered</b>
<pre>
<font color="green">   1. import xml.sax</font>
<font color="green">   2. import xml.sax.handler</font>
<font color="green">   3. import types</font>
<font color="black">   4. </font>
<font color="green">   5. try:</font>
<font color="green">   6.     _StringTypes = [types.StringType, types.UnicodeType]</font>
<font color="red">   7. except AttributeError:</font>
<font color="red">   8.     _StringTypes = [types.StringType]</font>
<font color="black">   9. </font>
<font color="green">  10. START_ELEMENT = &quot;START_ELEMENT&quot;</font>
<font color="green">  11. END_ELEMENT = &quot;END_ELEMENT&quot;</font>
<font color="green">  12. COMMENT = &quot;COMMENT&quot;</font>
<font color="green">  13. START_DOCUMENT = &quot;START_DOCUMENT&quot;</font>
<font color="green">  14. END_DOCUMENT = &quot;END_DOCUMENT&quot;</font>
<font color="green">  15. PROCESSING_INSTRUCTION = &quot;PROCESSING_INSTRUCTION&quot;</font>
<font color="green">  16. IGNORABLE_WHITESPACE = &quot;IGNORABLE_WHITESPACE&quot;</font>
<font color="green">  17. CHARACTERS = &quot;CHARACTERS&quot;</font>
<font color="black">  18. </font>
<font color="green">  19. class PullDOM(xml.sax.ContentHandler):</font>
<font color="green">  20.     _locator = None</font>
<font color="green">  21.     document = None</font>
<font color="black">  22. </font>
<font color="green">  23.     def __init__(self, documentFactory=None):</font>
<font color="red">  24.         from xml.dom import XML_NAMESPACE</font>
<font color="red">  25.         self.documentFactory = documentFactory</font>
<font color="red">  26.         self.firstEvent = [None, None]</font>
<font color="red">  27.         self.lastEvent = self.firstEvent</font>
<font color="red">  28.         self.elementStack = []</font>
<font color="red">  29.         self.push = self.elementStack.append</font>
<font color="red">  30.         try:</font>
<font color="red">  31.             self.pop = self.elementStack.pop</font>
<font color="red">  32.         except AttributeError:</font>
<font color="black">  33.             # use class' pop instead</font>
<font color="red">  34.             pass</font>
<font color="red">  35.         self._ns_contexts = [{XML_NAMESPACE:'xml'}] # contains uri -&gt; prefix dicts</font>
<font color="red">  36.         self._current_context = self._ns_contexts[-1]</font>
<font color="red">  37.         self.pending_events = []</font>
<font color="black">  38. </font>
<font color="green">  39.     def pop(self):</font>
<font color="red">  40.         result = self.elementStack[-1]</font>
<font color="red">  41.         del self.elementStack[-1]</font>
<font color="red">  42.         return result</font>
<font color="black">  43. </font>
<font color="green">  44.     def setDocumentLocator(self, locator):</font>
<font color="red">  45.         self._locator = locator</font>
<font color="black">  46. </font>
<font color="green">  47.     def startPrefixMapping(self, prefix, uri):</font>
<font color="red">  48.         if not hasattr(self, '_xmlns_attrs'):</font>
<font color="red">  49.             self._xmlns_attrs = []</font>
<font color="red">  50.         self._xmlns_attrs.append((prefix or 'xmlns', uri))</font>
<font color="red">  51.         self._ns_contexts.append(self._current_context.copy())</font>
<font color="red">  52.         self._current_context[uri] = prefix or None</font>
<font color="black">  53. </font>
<font color="green">  54.     def endPrefixMapping(self, prefix):</font>
<font color="red">  55.         self._current_context = self._ns_contexts.pop()</font>
<font color="black">  56. </font>
<font color="green">  57.     def startElementNS(self, name, tagName , attrs):</font>
<font color="black">  58.         # Retrieve xml namespace declaration attributes.</font>
<font color="red">  59.         xmlns_uri = 'http://www.w3.org/2000/xmlns/'</font>
<font color="red">  60.         xmlns_attrs = getattr(self, '_xmlns_attrs', None)</font>
<font color="red">  61.         if xmlns_attrs is not None:</font>
<font color="red">  62.             for aname, value in xmlns_attrs:</font>
<font color="red">  63.                 attrs._attrs[(xmlns_uri, aname)] = value</font>
<font color="red">  64.             self._xmlns_attrs = []</font>
<font color="red">  65.         uri, localname = name</font>
<font color="red">  66.         if uri:</font>
<font color="black">  67.             # When using namespaces, the reader may or may not</font>
<font color="black">  68.             # provide us with the original name. If not, create</font>
<font color="black">  69.             # *a* valid tagName from the current context.</font>
<font color="red">  70.             if tagName is None:</font>
<font color="red">  71.                 prefix = self._current_context[uri]</font>
<font color="red">  72.                 if prefix:</font>
<font color="red">  73.                     tagName = prefix + &quot;:&quot; + localname</font>
<font color="black">  74.                 else:</font>
<font color="red">  75.                     tagName = localname</font>
<font color="red">  76.             if self.document:</font>
<font color="red">  77.                 node = self.document.createElementNS(uri, tagName)</font>
<font color="black">  78.             else:</font>
<font color="red">  79.                 node = self.buildDocument(uri, tagName)</font>
<font color="black">  80.         else:</font>
<font color="black">  81.             # When the tagname is not prefixed, it just appears as</font>
<font color="black">  82.             # localname</font>
<font color="red">  83.             if self.document:</font>
<font color="red">  84.                 node = self.document.createElement(localname)</font>
<font color="black">  85.             else:</font>
<font color="red">  86.                 node = self.buildDocument(None, localname)</font>
<font color="black">  87. </font>
<font color="red">  88.         for aname,value in attrs.items():</font>
<font color="red">  89.             a_uri, a_localname = aname</font>
<font color="red">  90.             if a_uri == xmlns_uri:</font>
<font color="red">  91.                 if a_localname == 'xmlns':</font>
<font color="red">  92.                     qname = a_localname</font>
<font color="black">  93.                 else:</font>
<font color="red">  94.                     qname = 'xmlns:' + a_localname</font>
<font color="red">  95.                 attr = self.document.createAttributeNS(a_uri, qname)</font>
<font color="red">  96.                 node.setAttributeNodeNS(attr)</font>
<font color="red">  97.             elif a_uri:</font>
<font color="red">  98.                 prefix = self._current_context[a_uri]</font>
<font color="red">  99.                 if prefix:</font>
<font color="red"> 100.                     qname = prefix + &quot;:&quot; + a_localname</font>
<font color="black"> 101.                 else:</font>
<font color="red"> 102.                     qname = a_localname</font>
<font color="red"> 103.                 attr = self.document.createAttributeNS(a_uri, qname)</font>
<font color="red"> 104.                 node.setAttributeNodeNS(attr)</font>
<font color="black"> 105.             else:</font>
<font color="red"> 106.                 attr = self.document.createAttribute(a_localname)</font>
<font color="red"> 107.                 node.setAttributeNode(attr)</font>
<font color="red"> 108.             attr.value = value</font>
<font color="black"> 109. </font>
<font color="red"> 110.         self.lastEvent[1] = [(START_ELEMENT, node), None]</font>
<font color="red"> 111.         self.lastEvent = self.lastEvent[1]</font>
<font color="red"> 112.         self.push(node)</font>
<font color="black"> 113. </font>
<font color="green"> 114.     def endElementNS(self, name, tagName):</font>
<font color="red"> 115.         self.lastEvent[1] = [(END_ELEMENT, self.pop()), None]</font>
<font color="red"> 116.         self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 117. </font>
<font color="green"> 118.     def startElement(self, name, attrs):</font>
<font color="red"> 119.         if self.document:</font>
<font color="red"> 120.             node = self.document.createElement(name)</font>
<font color="black"> 121.         else:</font>
<font color="red"> 122.             node = self.buildDocument(None, name)</font>
<font color="black"> 123. </font>
<font color="red"> 124.         for aname,value in attrs.items():</font>
<font color="red"> 125.             attr = self.document.createAttribute(aname)</font>
<font color="red"> 126.             attr.value = value</font>
<font color="red"> 127.             node.setAttributeNode(attr)</font>
<font color="black"> 128. </font>
<font color="red"> 129.         self.lastEvent[1] = [(START_ELEMENT, node), None]</font>
<font color="red"> 130.         self.lastEvent = self.lastEvent[1]</font>
<font color="red"> 131.         self.push(node)</font>
<font color="black"> 132. </font>
<font color="green"> 133.     def endElement(self, name):</font>
<font color="red"> 134.         self.lastEvent[1] = [(END_ELEMENT, self.pop()), None]</font>
<font color="red"> 135.         self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 136. </font>
<font color="green"> 137.     def comment(self, s):</font>
<font color="red"> 138.         if self.document:</font>
<font color="red"> 139.             node = self.document.createComment(s)</font>
<font color="red"> 140.             self.lastEvent[1] = [(COMMENT, node), None]</font>
<font color="red"> 141.             self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 142.         else:</font>
<font color="red"> 143.             event = [(COMMENT, s), None]</font>
<font color="red"> 144.             self.pending_events.append(event)</font>
<font color="black"> 145. </font>
<font color="green"> 146.     def processingInstruction(self, target, data):</font>
<font color="red"> 147.         if self.document:</font>
<font color="red"> 148.             node = self.document.createProcessingInstruction(target, data)</font>
<font color="red"> 149.             self.lastEvent[1] = [(PROCESSING_INSTRUCTION, node), None]</font>
<font color="red"> 150.             self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 151.         else:</font>
<font color="red"> 152.             event = [(PROCESSING_INSTRUCTION, target, data), None]</font>
<font color="red"> 153.             self.pending_events.append(event)</font>
<font color="black"> 154. </font>
<font color="green"> 155.     def ignorableWhitespace(self, chars):</font>
<font color="red"> 156.         node = self.document.createTextNode(chars)</font>
<font color="red"> 157.         self.lastEvent[1] = [(IGNORABLE_WHITESPACE, node), None]</font>
<font color="red"> 158.         self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 159. </font>
<font color="green"> 160.     def characters(self, chars):</font>
<font color="red"> 161.         node = self.document.createTextNode(chars)</font>
<font color="red"> 162.         self.lastEvent[1] = [(CHARACTERS, node), None]</font>
<font color="red"> 163.         self.lastEvent = self.lastEvent[1]</font>
<font color="black"> 164. </font>
<font color="green"> 165.     def startDocument(self):</font>
<font color="red"> 166.         if self.documentFactory is None:</font>
<font color="red"> 167.             import xml.dom.minidom</font>
<font color="red"> 168.             self.documentFactory = xml.dom.minidom.Document.implementation</font>
<font color="black"> 169. </font>
<font color="green"> 170.     def buildDocument(self, uri, tagname):</font>
<font color="black"> 171.         # Can't do that in startDocument, since we need the tagname</font>
<font color="black"> 172.         # XXX: obtain DocumentType</font>
<font color="red"> 173.         node = self.documentFactory.createDocument(uri, tagname, None)</font>
<font color="red"> 174.         self.document = node</font>
<font color="red"> 175.         self.lastEvent[1] = [(START_DOCUMENT, node), None]</font>
<font color="red"> 176.         self.lastEvent = self.lastEvent[1]</font>
<font color="red"> 177.         self.push(node)</font>
<font color="black"> 178.         # Put everything we have seen so far into the document</font>
<font color="red"> 179.         for e in self.pending_events:</font>
<font color="red"> 180.             if e[0][0] == PROCESSING_INSTRUCTION:</font>
<font color="red"> 181.                 _,target,data = e[0]</font>
<font color="red"> 182.                 n = self.document.createProcessingInstruction(target, data)</font>
<font color="red"> 183.                 e[0] = (PROCESSING_INSTRUCTION, n)</font>
<font color="red"> 184.             elif e[0][0] == COMMENT:</font>
<font color="red"> 185.                 n = self.document.createComment(e[0][1])</font>
<font color="red"> 186.                 e[0] = (COMMENT, n)</font>
<font color="black"> 187.             else:</font>
<font color="red"> 188.                 raise AssertionError(&quot;Unknown pending event &quot;,e[0][0])</font>
<font color="red"> 189.             self.lastEvent[1] = e</font>
<font color="red"> 190.             self.lastEvent = e</font>
<font color="red"> 191.         self.pending_events = None</font>
<font color="red"> 192.         return node.firstChild</font>
<font color="black"> 193. </font>
<font color="green"> 194.     def endDocument(self):</font>
<font color="red"> 195.         self.lastEvent[1] = [(END_DOCUMENT, self.document), None]</font>
<font color="red"> 196.         self.pop()</font>
<font color="black"> 197. </font>
<font color="green"> 198.     def clear(self):</font>
<font color="black"> 199.         &quot;clear(): Explicitly release parsing structures&quot;</font>
<font color="red"> 200.         self.document = None</font>
<font color="black"> 201. </font>
<font color="green"> 202. class ErrorHandler:</font>
<font color="green"> 203.     def warning(self, exception):</font>
<font color="red"> 204.         print exception</font>
<font color="green"> 205.     def error(self, exception):</font>
<font color="red"> 206.         raise exception</font>
<font color="green"> 207.     def fatalError(self, exception):</font>
<font color="red"> 208.         raise exception</font>
<font color="black"> 209. </font>
<font color="green"> 210. class DOMEventStream:</font>
<font color="green"> 211.     def __init__(self, stream, parser, bufsize):</font>
<font color="red"> 212.         self.stream = stream</font>
<font color="red"> 213.         self.parser = parser</font>
<font color="red"> 214.         self.bufsize = bufsize</font>
<font color="red"> 215.         if not hasattr(self.parser, 'feed'):</font>
<font color="red"> 216.             self.getEvent = self._slurp</font>
<font color="red"> 217.         self.reset()</font>
<font color="black"> 218. </font>
<font color="green"> 219.     def reset(self):</font>
<font color="red"> 220.         self.pulldom = PullDOM()</font>
<font color="black"> 221.         # This content handler relies on namespace support</font>
<font color="red"> 222.         self.parser.setFeature(xml.sax.handler.feature_namespaces, 1)</font>
<font color="red"> 223.         self.parser.setContentHandler(self.pulldom)</font>
<font color="black"> 224. </font>
<font color="green"> 225.     def __getitem__(self, pos):</font>
<font color="red"> 226.         rc = self.getEvent()</font>
<font color="red"> 227.         if rc:</font>
<font color="red"> 228.             return rc</font>
<font color="red"> 229.         raise IndexError</font>
<font color="black"> 230. </font>
<font color="green"> 231.     def next(self):</font>
<font color="red"> 232.         rc = self.getEvent()</font>
<font color="red"> 233.         if rc:</font>
<font color="red"> 234.             return rc</font>
<font color="red"> 235.         raise StopIteration</font>
<font color="black"> 236. </font>
<font color="green"> 237.     def __iter__(self):</font>
<font color="red"> 238.         return self</font>
<font color="black"> 239. </font>
<font color="green"> 240.     def expandNode(self, node):</font>
<font color="red"> 241.         event = self.getEvent()</font>
<font color="red"> 242.         parents = [node]</font>
<font color="red"> 243.         while event:</font>
<font color="red"> 244.             token, cur_node = event</font>
<font color="red"> 245.             if cur_node is node:</font>
<font color="red"> 246.                 return</font>
<font color="red"> 247.             if token != END_ELEMENT:</font>
<font color="red"> 248.                 parents[-1].appendChild(cur_node)</font>
<font color="red"> 249.             if token == START_ELEMENT:</font>
<font color="red"> 250.                 parents.append(cur_node)</font>
<font color="red"> 251.             elif token == END_ELEMENT:</font>
<font color="red"> 252.                 del parents[-1]</font>
<font color="red"> 253.             event = self.getEvent()</font>
<font color="black"> 254. </font>
<font color="green"> 255.     def getEvent(self):</font>
<font color="black"> 256.         # use IncrementalParser interface, so we get the desired</font>
<font color="black"> 257.         # pull effect</font>
<font color="red"> 258.         if not self.pulldom.firstEvent[1]:</font>
<font color="red"> 259.             self.pulldom.lastEvent = self.pulldom.firstEvent</font>
<font color="red"> 260.         while not self.pulldom.firstEvent[1]:</font>
<font color="red"> 261.             buf = self.stream.read(self.bufsize)</font>
<font color="red"> 262.             if not buf:</font>
<font color="red"> 263.                 self.parser.close()</font>
<font color="red"> 264.                 return None</font>
<font color="red"> 265.             self.parser.feed(buf)</font>
<font color="red"> 266.         rc = self.pulldom.firstEvent[1][0]</font>
<font color="red"> 267.         self.pulldom.firstEvent[1] = self.pulldom.firstEvent[1][1]</font>
<font color="red"> 268.         return rc</font>
<font color="black"> 269. </font>
<font color="green"> 270.     def _slurp(self):</font>
<font color="black"> 271.         &quot;&quot;&quot; Fallback replacement for getEvent() using the</font>
<font color="black"> 272.             standard SAX2 interface, which means we slurp the</font>
<font color="black"> 273.             SAX events into memory (no performance gain, but</font>
<font color="black"> 274.             we are compatible to all SAX parsers).</font>
<font color="black"> 275.         &quot;&quot;&quot;</font>
<font color="red"> 276.         self.parser.parse(self.stream)</font>
<font color="red"> 277.         self.getEvent = self._emit</font>
<font color="red"> 278.         return self._emit()</font>
<font color="black"> 279. </font>
<font color="green"> 280.     def _emit(self):</font>
<font color="black"> 281.         &quot;&quot;&quot; Fallback replacement for getEvent() that emits</font>
<font color="black"> 282.             the events that _slurp() read previously.</font>
<font color="black"> 283.         &quot;&quot;&quot;</font>
<font color="red"> 284.         rc = self.pulldom.firstEvent[1][0]</font>
<font color="red"> 285.         self.pulldom.firstEvent[1] = self.pulldom.firstEvent[1][1]</font>
<font color="red"> 286.         return rc</font>
<font color="black"> 287. </font>
<font color="green"> 288.     def clear(self):</font>
<font color="black"> 289.         &quot;&quot;&quot;clear(): Explicitly release parsing objects&quot;&quot;&quot;</font>
<font color="red"> 290.         self.pulldom.clear()</font>
<font color="red"> 291.         del self.pulldom</font>
<font color="red"> 292.         self.parser = None</font>
<font color="red"> 293.         self.stream = None</font>
<font color="black"> 294. </font>
<font color="green"> 295. class SAX2DOM(PullDOM):</font>
<font color="black"> 296. </font>
<font color="green"> 297.     def startElementNS(self, name, tagName , attrs):</font>
<font color="red"> 298.         PullDOM.startElementNS(self, name, tagName, attrs)</font>
<font color="red"> 299.         curNode = self.elementStack[-1]</font>
<font color="red"> 300.         parentNode = self.elementStack[-2]</font>
<font color="red"> 301.         parentNode.appendChild(curNode)</font>
<font color="black"> 302. </font>
<font color="green"> 303.     def startElement(self, name, attrs):</font>
<font color="red"> 304.         PullDOM.startElement(self, name, attrs)</font>
<font color="red"> 305.         curNode = self.elementStack[-1]</font>
<font color="red"> 306.         parentNode = self.elementStack[-2]</font>
<font color="red"> 307.         parentNode.appendChild(curNode)</font>
<font color="black"> 308. </font>
<font color="green"> 309.     def processingInstruction(self, target, data):</font>
<font color="red"> 310.         PullDOM.processingInstruction(self, target, data)</font>
<font color="red"> 311.         node = self.lastEvent[0][1]</font>
<font color="red"> 312.         parentNode = self.elementStack[-1]</font>
<font color="red"> 313.         parentNode.appendChild(node)</font>
<font color="black"> 314. </font>
<font color="green"> 315.     def ignorableWhitespace(self, chars):</font>
<font color="red"> 316.         PullDOM.ignorableWhitespace(self, chars)</font>
<font color="red"> 317.         node = self.lastEvent[0][1]</font>
<font color="red"> 318.         parentNode = self.elementStack[-1]</font>
<font color="red"> 319.         parentNode.appendChild(node)</font>
<font color="black"> 320. </font>
<font color="green"> 321.     def characters(self, chars):</font>
<font color="red"> 322.         PullDOM.characters(self, chars)</font>
<font color="red"> 323.         node = self.lastEvent[0][1]</font>
<font color="red"> 324.         parentNode = self.elementStack[-1]</font>
<font color="red"> 325.         parentNode.appendChild(node)</font>
<font color="black"> 326. </font>
<font color="black"> 327. </font>
<font color="green"> 328. default_bufsize = (2 ** 14) - 20</font>
<font color="black"> 329. </font>
<font color="green"> 330. def parse(stream_or_string, parser=None, bufsize=None):</font>
<font color="red"> 331.     if bufsize is None:</font>
<font color="red"> 332.         bufsize = default_bufsize</font>
<font color="red"> 333.     if type(stream_or_string) in _StringTypes:</font>
<font color="red"> 334.         stream = open(stream_or_string)</font>
<font color="black"> 335.     else:</font>
<font color="red"> 336.         stream = stream_or_string</font>
<font color="red"> 337.     if not parser:</font>
<font color="red"> 338.         parser = xml.sax.make_parser()</font>
<font color="red"> 339.     return DOMEventStream(stream, parser, bufsize)</font>
<font color="black"> 340. </font>
<font color="green"> 341. def parseString(string, parser=None):</font>
<font color="red"> 342.     try:</font>
<font color="red"> 343.         from cStringIO import StringIO</font>
<font color="red"> 344.     except ImportError:</font>
<font color="red"> 345.         from StringIO import StringIO</font>
<font color="black"> 346. </font>
<font color="red"> 347.     bufsize = len(string)</font>
<font color="red"> 348.     buf = StringIO(string)</font>
<font color="red"> 349.     if not parser:</font>
<font color="red"> 350.         parser = xml.sax.make_parser()</font>
<font color="red"> 351.     return DOMEventStream(buf, parser, bufsize)</font>
</pre>

